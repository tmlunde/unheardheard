(()=>{var s={823:(e,t,i)=>{"use strict";i.r(t);i.d(t,{ARRAY_TYPE:()=>r,EPSILON:()=>s,RANDOM:()=>n,equals:()=>h,setMatrixArrayType:()=>a,toRadian:()=>l});var s=1e-6;var r=typeof Float32Array!=="undefined"?Float32Array:Array;var n=Math.random;function a(e){r=e}var o=Math.PI/180;function l(e){return e*o}function h(e,t){return Math.abs(e-t)<=s*Math.max(1,Math.abs(e),Math.abs(t))}if(!Math.hypot)Math.hypot=function(){var e=0,t=arguments.length;while(t--){e+=arguments[t]*arguments[t]}return Math.sqrt(e)}},522:(e,t,i)=>{"use strict";i.r(t);i.d(t,{LDU:()=>x,add:()=>T,adjoint:()=>f,clone:()=>r,copy:()=>n,create:()=>s,determinant:()=>g,equals:()=>M,exactEquals:()=>S,frob:()=>b,fromRotation:()=>_,fromScaling:()=>v,fromValues:()=>o,identity:()=>a,invert:()=>c,mul:()=>R,multiply:()=>d,multiplyScalar:()=>I,multiplyScalarAndAdd:()=>O,rotate:()=>m,scale:()=>p,set:()=>l,str:()=>E,sub:()=>C,subtract:()=>A,transpose:()=>h});var u=i(823);function s(){var e=new u.ARRAY_TYPE(4);if(u.ARRAY_TYPE!=Float32Array){e[1]=0;e[2]=0}e[0]=1;e[3]=1;return e}function r(e){var t=new u.ARRAY_TYPE(4);t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];return t}function n(e,t){e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];return e}function a(e){e[0]=1;e[1]=0;e[2]=0;e[3]=1;return e}function o(e,t,i,s){var r=new u.ARRAY_TYPE(4);r[0]=e;r[1]=t;r[2]=i;r[3]=s;return r}function l(e,t,i,s,r){e[0]=t;e[1]=i;e[2]=s;e[3]=r;return e}function h(e,t){if(e===t){var i=t[1];e[1]=t[2];e[2]=i}else{e[0]=t[0];e[1]=t[2];e[2]=t[1];e[3]=t[3]}return e}function c(e,t){var i=t[0],s=t[1],r=t[2],n=t[3];var a=i*n-r*s;if(!a){return null}a=1/a;e[0]=n*a;e[1]=-s*a;e[2]=-r*a;e[3]=i*a;return e}function f(e,t){var i=t[0];e[0]=t[3];e[1]=-t[1];e[2]=-t[2];e[3]=i;return e}function g(e){return e[0]*e[3]-e[2]*e[1]}function d(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3];var o=i[0],l=i[1],h=i[2],u=i[3];e[0]=s*o+n*l;e[1]=r*o+a*l;e[2]=s*h+n*u;e[3]=r*h+a*u;return e}function m(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3];var o=Math.sin(i);var l=Math.cos(i);e[0]=s*l+n*o;e[1]=r*l+a*o;e[2]=s*-o+n*l;e[3]=r*-o+a*l;return e}function p(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3];var o=i[0],l=i[1];e[0]=s*o;e[1]=r*o;e[2]=n*l;e[3]=a*l;return e}function _(e,t){var i=Math.sin(t);var s=Math.cos(t);e[0]=s;e[1]=i;e[2]=-i;e[3]=s;return e}function v(e,t){e[0]=t[0];e[1]=0;e[2]=0;e[3]=t[1];return e}function E(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function b(e){return Math.hypot(e[0],e[1],e[2],e[3])}function x(e,t,i,s){e[2]=s[2]/s[0];i[0]=s[0];i[1]=s[1];i[3]=s[3]-e[2]*i[1];return[e,t,i]}function T(e,t,i){e[0]=t[0]+i[0];e[1]=t[1]+i[1];e[2]=t[2]+i[2];e[3]=t[3]+i[3];return e}function A(e,t,i){e[0]=t[0]-i[0];e[1]=t[1]-i[1];e[2]=t[2]-i[2];e[3]=t[3]-i[3];return e}function S(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function M(e,t){var i=e[0],s=e[1],r=e[2],n=e[3];var a=t[0],o=t[1],l=t[2],h=t[3];return Math.abs(i-a)<=u.EPSILON*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-o)<=u.EPSILON*Math.max(1,Math.abs(s),Math.abs(o))&&Math.abs(r-l)<=u.EPSILON*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(n-h)<=u.EPSILON*Math.max(1,Math.abs(n),Math.abs(h))}function I(e,t,i){e[0]=t[0]*i;e[1]=t[1]*i;e[2]=t[2]*i;e[3]=t[3]*i;return e}function O(e,t,i,s){e[0]=t[0]+i[0]*s;e[1]=t[1]+i[1]*s;e[2]=t[2]+i[2]*s;e[3]=t[3]+i[3]*s;return e}var R=d;var C=A},964:(e,t,i)=>{"use strict";i.r(t);i.d(t,{add:()=>x,clone:()=>r,copy:()=>n,create:()=>s,determinant:()=>u,equals:()=>I,exactEquals:()=>M,frob:()=>b,fromRotation:()=>p,fromScaling:()=>_,fromTranslation:()=>v,fromValues:()=>o,identity:()=>a,invert:()=>h,mul:()=>O,multiply:()=>c,multiplyScalar:()=>A,multiplyScalarAndAdd:()=>S,rotate:()=>f,scale:()=>g,set:()=>l,str:()=>E,sub:()=>R,subtract:()=>T,translate:()=>m});var d=i(823);function s(){var e=new d.ARRAY_TYPE(6);if(d.ARRAY_TYPE!=Float32Array){e[1]=0;e[2]=0;e[4]=0;e[5]=0}e[0]=1;e[3]=1;return e}function r(e){var t=new d.ARRAY_TYPE(6);t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];return t}function n(e,t){e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];e[4]=t[4];e[5]=t[5];return e}function a(e){e[0]=1;e[1]=0;e[2]=0;e[3]=1;e[4]=0;e[5]=0;return e}function o(e,t,i,s,r,n){var a=new d.ARRAY_TYPE(6);a[0]=e;a[1]=t;a[2]=i;a[3]=s;a[4]=r;a[5]=n;return a}function l(e,t,i,s,r,n,a){e[0]=t;e[1]=i;e[2]=s;e[3]=r;e[4]=n;e[5]=a;return e}function h(e,t){var i=t[0],s=t[1],r=t[2],n=t[3];var a=t[4],o=t[5];var l=i*n-s*r;if(!l){return null}l=1/l;e[0]=n*l;e[1]=-s*l;e[2]=-r*l;e[3]=i*l;e[4]=(r*o-n*a)*l;e[5]=(s*a-i*o)*l;return e}function u(e){return e[0]*e[3]-e[1]*e[2]}function c(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5];var h=i[0],u=i[1],c=i[2],f=i[3],g=i[4],d=i[5];e[0]=s*h+n*u;e[1]=r*h+a*u;e[2]=s*c+n*f;e[3]=r*c+a*f;e[4]=s*g+n*d+o;e[5]=r*g+a*d+l;return e}function f(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5];var h=Math.sin(i);var u=Math.cos(i);e[0]=s*u+n*h;e[1]=r*u+a*h;e[2]=s*-h+n*u;e[3]=r*-h+a*u;e[4]=o;e[5]=l;return e}function g(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5];var h=i[0],u=i[1];e[0]=s*h;e[1]=r*h;e[2]=n*u;e[3]=a*u;e[4]=o;e[5]=l;return e}function m(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5];var h=i[0],u=i[1];e[0]=s;e[1]=r;e[2]=n;e[3]=a;e[4]=s*h+n*u+o;e[5]=r*h+a*u+l;return e}function p(e,t){var i=Math.sin(t),s=Math.cos(t);e[0]=s;e[1]=i;e[2]=-i;e[3]=s;e[4]=0;e[5]=0;return e}function _(e,t){e[0]=t[0];e[1]=0;e[2]=0;e[3]=t[1];e[4]=0;e[5]=0;return e}function v(e,t){e[0]=1;e[1]=0;e[2]=0;e[3]=1;e[4]=t[0];e[5]=t[1];return e}function E(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"}function b(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],1)}function x(e,t,i){e[0]=t[0]+i[0];e[1]=t[1]+i[1];e[2]=t[2]+i[2];e[3]=t[3]+i[3];e[4]=t[4]+i[4];e[5]=t[5]+i[5];return e}function T(e,t,i){e[0]=t[0]-i[0];e[1]=t[1]-i[1];e[2]=t[2]-i[2];e[3]=t[3]-i[3];e[4]=t[4]-i[4];e[5]=t[5]-i[5];return e}function A(e,t,i){e[0]=t[0]*i;e[1]=t[1]*i;e[2]=t[2]*i;e[3]=t[3]*i;e[4]=t[4]*i;e[5]=t[5]*i;return e}function S(e,t,i,s){e[0]=t[0]+i[0]*s;e[1]=t[1]+i[1]*s;e[2]=t[2]+i[2]*s;e[3]=t[3]+i[3]*s;e[4]=t[4]+i[4]*s;e[5]=t[5]+i[5]*s;return e}function M(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]}function I(e,t){var i=e[0],s=e[1],r=e[2],n=e[3],a=e[4],o=e[5];var l=t[0],h=t[1],u=t[2],c=t[3],f=t[4],g=t[5];return Math.abs(i-l)<=d.EPSILON*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(s-h)<=d.EPSILON*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(r-u)<=d.EPSILON*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(n-c)<=d.EPSILON*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(a-f)<=d.EPSILON*Math.max(1,Math.abs(a),Math.abs(f))&&Math.abs(o-g)<=d.EPSILON*Math.max(1,Math.abs(o),Math.abs(g))}var O=c;var R=T},409:(e,t,i)=>{"use strict";i.r(t);i.d(t,{add:()=>R,adjoint:()=>f,clone:()=>n,copy:()=>a,create:()=>s,determinant:()=>g,equals:()=>L,exactEquals:()=>F,frob:()=>O,fromMat2d:()=>T,fromMat4:()=>r,fromQuat:()=>A,fromRotation:()=>E,fromScaling:()=>x,fromTranslation:()=>v,fromValues:()=>o,identity:()=>h,invert:()=>c,mul:()=>D,multiply:()=>d,multiplyScalar:()=>P,multiplyScalarAndAdd:()=>N,normalFromMat4:()=>S,projection:()=>M,rotate:()=>p,scale:()=>_,set:()=>l,str:()=>I,sub:()=>y,subtract:()=>C,translate:()=>m,transpose:()=>u});var b=i(823);function s(){var e=new b.ARRAY_TYPE(9);if(b.ARRAY_TYPE!=Float32Array){e[1]=0;e[2]=0;e[3]=0;e[5]=0;e[6]=0;e[7]=0}e[0]=1;e[4]=1;e[8]=1;return e}function r(e,t){e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[4];e[4]=t[5];e[5]=t[6];e[6]=t[8];e[7]=t[9];e[8]=t[10];return e}function n(e){var t=new b.ARRAY_TYPE(9);t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];return t}function a(e,t){e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];e[4]=t[4];e[5]=t[5];e[6]=t[6];e[7]=t[7];e[8]=t[8];return e}function o(e,t,i,s,r,n,a,o,l){var h=new b.ARRAY_TYPE(9);h[0]=e;h[1]=t;h[2]=i;h[3]=s;h[4]=r;h[5]=n;h[6]=a;h[7]=o;h[8]=l;return h}function l(e,t,i,s,r,n,a,o,l,h){e[0]=t;e[1]=i;e[2]=s;e[3]=r;e[4]=n;e[5]=a;e[6]=o;e[7]=l;e[8]=h;return e}function h(e){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=1;e[5]=0;e[6]=0;e[7]=0;e[8]=1;return e}function u(e,t){if(e===t){var i=t[1],s=t[2],r=t[5];e[1]=t[3];e[2]=t[6];e[3]=i;e[5]=t[7];e[6]=s;e[7]=r}else{e[0]=t[0];e[1]=t[3];e[2]=t[6];e[3]=t[1];e[4]=t[4];e[5]=t[7];e[6]=t[2];e[7]=t[5];e[8]=t[8]}return e}function c(e,t){var i=t[0],s=t[1],r=t[2];var n=t[3],a=t[4],o=t[5];var l=t[6],h=t[7],u=t[8];var c=u*a-o*h;var f=-u*n+o*l;var g=h*n-a*l;var d=i*c+s*f+r*g;if(!d){return null}d=1/d;e[0]=c*d;e[1]=(-u*s+r*h)*d;e[2]=(o*s-r*a)*d;e[3]=f*d;e[4]=(u*i-r*l)*d;e[5]=(-o*i+r*n)*d;e[6]=g*d;e[7]=(-h*i+s*l)*d;e[8]=(a*i-s*n)*d;return e}function f(e,t){var i=t[0],s=t[1],r=t[2];var n=t[3],a=t[4],o=t[5];var l=t[6],h=t[7],u=t[8];e[0]=a*u-o*h;e[1]=r*h-s*u;e[2]=s*o-r*a;e[3]=o*l-n*u;e[4]=i*u-r*l;e[5]=r*n-i*o;e[6]=n*h-a*l;e[7]=s*l-i*h;e[8]=i*a-s*n;return e}function g(e){var t=e[0],i=e[1],s=e[2];var r=e[3],n=e[4],a=e[5];var o=e[6],l=e[7],h=e[8];return t*(h*n-a*l)+i*(-h*r+a*o)+s*(l*r-n*o)}function d(e,t,i){var s=t[0],r=t[1],n=t[2];var a=t[3],o=t[4],l=t[5];var h=t[6],u=t[7],c=t[8];var f=i[0],g=i[1],d=i[2];var m=i[3],p=i[4],_=i[5];var v=i[6],E=i[7],b=i[8];e[0]=f*s+g*a+d*h;e[1]=f*r+g*o+d*u;e[2]=f*n+g*l+d*c;e[3]=m*s+p*a+_*h;e[4]=m*r+p*o+_*u;e[5]=m*n+p*l+_*c;e[6]=v*s+E*a+b*h;e[7]=v*r+E*o+b*u;e[8]=v*n+E*l+b*c;return e}function m(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=t[8],f=i[0],g=i[1];e[0]=s;e[1]=r;e[2]=n;e[3]=a;e[4]=o;e[5]=l;e[6]=f*s+g*a+h;e[7]=f*r+g*o+u;e[8]=f*n+g*l+c;return e}function p(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=t[8],f=Math.sin(i),g=Math.cos(i);e[0]=g*s+f*a;e[1]=g*r+f*o;e[2]=g*n+f*l;e[3]=g*a-f*s;e[4]=g*o-f*r;e[5]=g*l-f*n;e[6]=h;e[7]=u;e[8]=c;return e}function _(e,t,i){var s=i[0],r=i[1];e[0]=s*t[0];e[1]=s*t[1];e[2]=s*t[2];e[3]=r*t[3];e[4]=r*t[4];e[5]=r*t[5];e[6]=t[6];e[7]=t[7];e[8]=t[8];return e}function v(e,t){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=1;e[5]=0;e[6]=t[0];e[7]=t[1];e[8]=1;return e}function E(e,t){var i=Math.sin(t),s=Math.cos(t);e[0]=s;e[1]=i;e[2]=0;e[3]=-i;e[4]=s;e[5]=0;e[6]=0;e[7]=0;e[8]=1;return e}function x(e,t){e[0]=t[0];e[1]=0;e[2]=0;e[3]=0;e[4]=t[1];e[5]=0;e[6]=0;e[7]=0;e[8]=1;return e}function T(e,t){e[0]=t[0];e[1]=t[1];e[2]=0;e[3]=t[2];e[4]=t[3];e[5]=0;e[6]=t[4];e[7]=t[5];e[8]=1;return e}function A(e,t){var i=t[0],s=t[1],r=t[2],n=t[3];var a=i+i;var o=s+s;var l=r+r;var h=i*a;var u=s*a;var c=s*o;var f=r*a;var g=r*o;var d=r*l;var m=n*a;var p=n*o;var _=n*l;e[0]=1-c-d;e[3]=u-_;e[6]=f+p;e[1]=u+_;e[4]=1-h-d;e[7]=g-m;e[2]=f-p;e[5]=g+m;e[8]=1-h-c;return e}function S(e,t){var i=t[0],s=t[1],r=t[2],n=t[3];var a=t[4],o=t[5],l=t[6],h=t[7];var u=t[8],c=t[9],f=t[10],g=t[11];var d=t[12],m=t[13],p=t[14],_=t[15];var v=i*o-s*a;var E=i*l-r*a;var b=i*h-n*a;var x=s*l-r*o;var T=s*h-n*o;var A=r*h-n*l;var S=u*m-c*d;var M=u*p-f*d;var I=u*_-g*d;var O=c*p-f*m;var R=c*_-g*m;var C=f*_-g*p;var P=v*C-E*R+b*O+x*I-T*M+A*S;if(!P){return null}P=1/P;e[0]=(o*C-l*R+h*O)*P;e[1]=(l*I-a*C-h*M)*P;e[2]=(a*R-o*I+h*S)*P;e[3]=(r*R-s*C-n*O)*P;e[4]=(i*C-r*I+n*M)*P;e[5]=(s*I-i*R-n*S)*P;e[6]=(m*A-p*T+_*x)*P;e[7]=(p*b-d*A-_*E)*P;e[8]=(d*T-m*b+_*v)*P;return e}function M(e,t,i){e[0]=2/t;e[1]=0;e[2]=0;e[3]=0;e[4]=-2/i;e[5]=0;e[6]=-1;e[7]=1;e[8]=1;return e}function I(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}function O(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])}function R(e,t,i){e[0]=t[0]+i[0];e[1]=t[1]+i[1];e[2]=t[2]+i[2];e[3]=t[3]+i[3];e[4]=t[4]+i[4];e[5]=t[5]+i[5];e[6]=t[6]+i[6];e[7]=t[7]+i[7];e[8]=t[8]+i[8];return e}function C(e,t,i){e[0]=t[0]-i[0];e[1]=t[1]-i[1];e[2]=t[2]-i[2];e[3]=t[3]-i[3];e[4]=t[4]-i[4];e[5]=t[5]-i[5];e[6]=t[6]-i[6];e[7]=t[7]-i[7];e[8]=t[8]-i[8];return e}function P(e,t,i){e[0]=t[0]*i;e[1]=t[1]*i;e[2]=t[2]*i;e[3]=t[3]*i;e[4]=t[4]*i;e[5]=t[5]*i;e[6]=t[6]*i;e[7]=t[7]*i;e[8]=t[8]*i;return e}function N(e,t,i,s){e[0]=t[0]+i[0]*s;e[1]=t[1]+i[1]*s;e[2]=t[2]+i[2]*s;e[3]=t[3]+i[3]*s;e[4]=t[4]+i[4]*s;e[5]=t[5]+i[5]*s;e[6]=t[6]+i[6]*s;e[7]=t[7]+i[7]*s;e[8]=t[8]+i[8]*s;return e}function F(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]}function L(e,t){var i=e[0],s=e[1],r=e[2],n=e[3],a=e[4],o=e[5],l=e[6],h=e[7],u=e[8];var c=t[0],f=t[1],g=t[2],d=t[3],m=t[4],p=t[5],_=t[6],v=t[7],E=t[8];return Math.abs(i-c)<=b.EPSILON*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(s-f)<=b.EPSILON*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(r-g)<=b.EPSILON*Math.max(1,Math.abs(r),Math.abs(g))&&Math.abs(n-d)<=b.EPSILON*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(a-m)<=b.EPSILON*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(o-p)<=b.EPSILON*Math.max(1,Math.abs(o),Math.abs(p))&&Math.abs(l-_)<=b.EPSILON*Math.max(1,Math.abs(l),Math.abs(_))&&Math.abs(h-v)<=b.EPSILON*Math.max(1,Math.abs(h),Math.abs(v))&&Math.abs(u-E)<=b.EPSILON*Math.max(1,Math.abs(u),Math.abs(E))}var D=d;var y=C},684:(U,e,t)=>{"use strict";t.r(e);t.d(e,{add:()=>z,adjoint:()=>h,clone:()=>s,copy:()=>r,create:()=>i,determinant:()=>u,equals:()=>q,exactEquals:()=>W,frob:()=>H,fromQuat:()=>F,fromQuat2:()=>I,fromRotation:()=>b,fromRotationTranslation:()=>M,fromRotationTranslationScale:()=>P,fromRotationTranslationScaleOrigin:()=>N,fromScaling:()=>E,fromTranslation:()=>v,fromValues:()=>n,fromXRotation:()=>x,fromYRotation:()=>T,fromZRotation:()=>S,frustum:()=>L,getRotation:()=>C,getScaling:()=>R,getTranslation:()=>O,identity:()=>A,invert:()=>l,lookAt:()=>k,mul:()=>K,multiply:()=>c,multiplyScalar:()=>X,multiplyScalarAndAdd:()=>Y,ortho:()=>V,perspective:()=>w,perspectiveFromFieldOfView:()=>B,rotate:()=>d,rotateX:()=>m,rotateY:()=>p,rotateZ:()=>_,scale:()=>g,set:()=>a,str:()=>j,sub:()=>Z,subtract:()=>y,targetTo:()=>G,translate:()=>f,transpose:()=>o});var D=t(823);function i(){var e=new D.ARRAY_TYPE(16);if(D.ARRAY_TYPE!=Float32Array){e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[11]=0;e[12]=0;e[13]=0;e[14]=0}e[0]=1;e[5]=1;e[10]=1;e[15]=1;return e}function s(e){var t=new D.ARRAY_TYPE(16);t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9];t[10]=e[10];t[11]=e[11];t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15];return t}function r(e,t){e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];e[4]=t[4];e[5]=t[5];e[6]=t[6];e[7]=t[7];e[8]=t[8];e[9]=t[9];e[10]=t[10];e[11]=t[11];e[12]=t[12];e[13]=t[13];e[14]=t[14];e[15]=t[15];return e}function n(e,t,i,s,r,n,a,o,l,h,u,c,f,g,d,m){var p=new D.ARRAY_TYPE(16);p[0]=e;p[1]=t;p[2]=i;p[3]=s;p[4]=r;p[5]=n;p[6]=a;p[7]=o;p[8]=l;p[9]=h;p[10]=u;p[11]=c;p[12]=f;p[13]=g;p[14]=d;p[15]=m;return p}function a(e,t,i,s,r,n,a,o,l,h,u,c,f,g,d,m,p){e[0]=t;e[1]=i;e[2]=s;e[3]=r;e[4]=n;e[5]=a;e[6]=o;e[7]=l;e[8]=h;e[9]=u;e[10]=c;e[11]=f;e[12]=g;e[13]=d;e[14]=m;e[15]=p;return e}function A(e){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e}function o(e,t){if(e===t){var i=t[1],s=t[2],r=t[3];var n=t[6],a=t[7];var o=t[11];e[1]=t[4];e[2]=t[8];e[3]=t[12];e[4]=i;e[6]=t[9];e[7]=t[13];e[8]=s;e[9]=n;e[11]=t[14];e[12]=r;e[13]=a;e[14]=o}else{e[0]=t[0];e[1]=t[4];e[2]=t[8];e[3]=t[12];e[4]=t[1];e[5]=t[5];e[6]=t[9];e[7]=t[13];e[8]=t[2];e[9]=t[6];e[10]=t[10];e[11]=t[14];e[12]=t[3];e[13]=t[7];e[14]=t[11];e[15]=t[15]}return e}function l(e,t){var i=t[0],s=t[1],r=t[2],n=t[3];var a=t[4],o=t[5],l=t[6],h=t[7];var u=t[8],c=t[9],f=t[10],g=t[11];var d=t[12],m=t[13],p=t[14],_=t[15];var v=i*o-s*a;var E=i*l-r*a;var b=i*h-n*a;var x=s*l-r*o;var T=s*h-n*o;var A=r*h-n*l;var S=u*m-c*d;var M=u*p-f*d;var I=u*_-g*d;var O=c*p-f*m;var R=c*_-g*m;var C=f*_-g*p;var P=v*C-E*R+b*O+x*I-T*M+A*S;if(!P){return null}P=1/P;e[0]=(o*C-l*R+h*O)*P;e[1]=(r*R-s*C-n*O)*P;e[2]=(m*A-p*T+_*x)*P;e[3]=(f*T-c*A-g*x)*P;e[4]=(l*I-a*C-h*M)*P;e[5]=(i*C-r*I+n*M)*P;e[6]=(p*b-d*A-_*E)*P;e[7]=(u*A-f*b+g*E)*P;e[8]=(a*R-o*I+h*S)*P;e[9]=(s*I-i*R-n*S)*P;e[10]=(d*T-m*b+_*v)*P;e[11]=(c*b-u*T-g*v)*P;e[12]=(o*M-a*O-l*S)*P;e[13]=(i*O-s*M+r*S)*P;e[14]=(m*E-d*x-p*v)*P;e[15]=(u*x-c*E+f*v)*P;return e}function h(e,t){var i=t[0],s=t[1],r=t[2],n=t[3];var a=t[4],o=t[5],l=t[6],h=t[7];var u=t[8],c=t[9],f=t[10],g=t[11];var d=t[12],m=t[13],p=t[14],_=t[15];e[0]=o*(f*_-g*p)-c*(l*_-h*p)+m*(l*g-h*f);e[1]=-(s*(f*_-g*p)-c*(r*_-n*p)+m*(r*g-n*f));e[2]=s*(l*_-h*p)-o*(r*_-n*p)+m*(r*h-n*l);e[3]=-(s*(l*g-h*f)-o*(r*g-n*f)+c*(r*h-n*l));e[4]=-(a*(f*_-g*p)-u*(l*_-h*p)+d*(l*g-h*f));e[5]=i*(f*_-g*p)-u*(r*_-n*p)+d*(r*g-n*f);e[6]=-(i*(l*_-h*p)-a*(r*_-n*p)+d*(r*h-n*l));e[7]=i*(l*g-h*f)-a*(r*g-n*f)+u*(r*h-n*l);e[8]=a*(c*_-g*m)-u*(o*_-h*m)+d*(o*g-h*c);e[9]=-(i*(c*_-g*m)-u*(s*_-n*m)+d*(s*g-n*c));e[10]=i*(o*_-h*m)-a*(s*_-n*m)+d*(s*h-n*o);e[11]=-(i*(o*g-h*c)-a*(s*g-n*c)+u*(s*h-n*o));e[12]=-(a*(c*p-f*m)-u*(o*p-l*m)+d*(o*f-l*c));e[13]=i*(c*p-f*m)-u*(s*p-r*m)+d*(s*f-r*c);e[14]=-(i*(o*p-l*m)-a*(s*p-r*m)+d*(s*l-r*o));e[15]=i*(o*f-l*c)-a*(s*f-r*c)+u*(s*l-r*o);return e}function u(e){var t=e[0],i=e[1],s=e[2],r=e[3];var n=e[4],a=e[5],o=e[6],l=e[7];var h=e[8],u=e[9],c=e[10],f=e[11];var g=e[12],d=e[13],m=e[14],p=e[15];var _=t*a-i*n;var v=t*o-s*n;var E=t*l-r*n;var b=i*o-s*a;var x=i*l-r*a;var T=s*l-r*o;var A=h*d-u*g;var S=h*m-c*g;var M=h*p-f*g;var I=u*m-c*d;var O=u*p-f*d;var R=c*p-f*m;return _*R-v*O+E*I+b*M-x*S+T*A}function c(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3];var o=t[4],l=t[5],h=t[6],u=t[7];var c=t[8],f=t[9],g=t[10],d=t[11];var m=t[12],p=t[13],_=t[14],v=t[15];var E=i[0],b=i[1],x=i[2],T=i[3];e[0]=E*s+b*o+x*c+T*m;e[1]=E*r+b*l+x*f+T*p;e[2]=E*n+b*h+x*g+T*_;e[3]=E*a+b*u+x*d+T*v;E=i[4];b=i[5];x=i[6];T=i[7];e[4]=E*s+b*o+x*c+T*m;e[5]=E*r+b*l+x*f+T*p;e[6]=E*n+b*h+x*g+T*_;e[7]=E*a+b*u+x*d+T*v;E=i[8];b=i[9];x=i[10];T=i[11];e[8]=E*s+b*o+x*c+T*m;e[9]=E*r+b*l+x*f+T*p;e[10]=E*n+b*h+x*g+T*_;e[11]=E*a+b*u+x*d+T*v;E=i[12];b=i[13];x=i[14];T=i[15];e[12]=E*s+b*o+x*c+T*m;e[13]=E*r+b*l+x*f+T*p;e[14]=E*n+b*h+x*g+T*_;e[15]=E*a+b*u+x*d+T*v;return e}function f(e,t,i){var s=i[0],r=i[1],n=i[2];var a,o,l,h;var u,c,f,g;var d,m,p,_;if(t===e){e[12]=t[0]*s+t[4]*r+t[8]*n+t[12];e[13]=t[1]*s+t[5]*r+t[9]*n+t[13];e[14]=t[2]*s+t[6]*r+t[10]*n+t[14];e[15]=t[3]*s+t[7]*r+t[11]*n+t[15]}else{a=t[0];o=t[1];l=t[2];h=t[3];u=t[4];c=t[5];f=t[6];g=t[7];d=t[8];m=t[9];p=t[10];_=t[11];e[0]=a;e[1]=o;e[2]=l;e[3]=h;e[4]=u;e[5]=c;e[6]=f;e[7]=g;e[8]=d;e[9]=m;e[10]=p;e[11]=_;e[12]=a*s+u*r+d*n+t[12];e[13]=o*s+c*r+m*n+t[13];e[14]=l*s+f*r+p*n+t[14];e[15]=h*s+g*r+_*n+t[15]}return e}function g(e,t,i){var s=i[0],r=i[1],n=i[2];e[0]=t[0]*s;e[1]=t[1]*s;e[2]=t[2]*s;e[3]=t[3]*s;e[4]=t[4]*r;e[5]=t[5]*r;e[6]=t[6]*r;e[7]=t[7]*r;e[8]=t[8]*n;e[9]=t[9]*n;e[10]=t[10]*n;e[11]=t[11]*n;e[12]=t[12];e[13]=t[13];e[14]=t[14];e[15]=t[15];return e}function d(e,t,i,s){var r=s[0],n=s[1],a=s[2];var o=Math.hypot(r,n,a);var l,h,u;var c,f,g,d;var m,p,_,v;var E,b,x,T;var A,S,M;var I,O,R;var C,P,N;if(o<D.EPSILON){return null}o=1/o;r*=o;n*=o;a*=o;l=Math.sin(i);h=Math.cos(i);u=1-h;c=t[0];f=t[1];g=t[2];d=t[3];m=t[4];p=t[5];_=t[6];v=t[7];E=t[8];b=t[9];x=t[10];T=t[11];A=r*r*u+h;S=n*r*u+a*l;M=a*r*u-n*l;I=r*n*u-a*l;O=n*n*u+h;R=a*n*u+r*l;C=r*a*u+n*l;P=n*a*u-r*l;N=a*a*u+h;e[0]=c*A+m*S+E*M;e[1]=f*A+p*S+b*M;e[2]=g*A+_*S+x*M;e[3]=d*A+v*S+T*M;e[4]=c*I+m*O+E*R;e[5]=f*I+p*O+b*R;e[6]=g*I+_*O+x*R;e[7]=d*I+v*O+T*R;e[8]=c*C+m*P+E*N;e[9]=f*C+p*P+b*N;e[10]=g*C+_*P+x*N;e[11]=d*C+v*P+T*N;if(t!==e){e[12]=t[12];e[13]=t[13];e[14]=t[14];e[15]=t[15]}return e}function m(e,t,i){var s=Math.sin(i);var r=Math.cos(i);var n=t[4];var a=t[5];var o=t[6];var l=t[7];var h=t[8];var u=t[9];var c=t[10];var f=t[11];if(t!==e){e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];e[12]=t[12];e[13]=t[13];e[14]=t[14];e[15]=t[15]}e[4]=n*r+h*s;e[5]=a*r+u*s;e[6]=o*r+c*s;e[7]=l*r+f*s;e[8]=h*r-n*s;e[9]=u*r-a*s;e[10]=c*r-o*s;e[11]=f*r-l*s;return e}function p(e,t,i){var s=Math.sin(i);var r=Math.cos(i);var n=t[0];var a=t[1];var o=t[2];var l=t[3];var h=t[8];var u=t[9];var c=t[10];var f=t[11];if(t!==e){e[4]=t[4];e[5]=t[5];e[6]=t[6];e[7]=t[7];e[12]=t[12];e[13]=t[13];e[14]=t[14];e[15]=t[15]}e[0]=n*r-h*s;e[1]=a*r-u*s;e[2]=o*r-c*s;e[3]=l*r-f*s;e[8]=n*s+h*r;e[9]=a*s+u*r;e[10]=o*s+c*r;e[11]=l*s+f*r;return e}function _(e,t,i){var s=Math.sin(i);var r=Math.cos(i);var n=t[0];var a=t[1];var o=t[2];var l=t[3];var h=t[4];var u=t[5];var c=t[6];var f=t[7];if(t!==e){e[8]=t[8];e[9]=t[9];e[10]=t[10];e[11]=t[11];e[12]=t[12];e[13]=t[13];e[14]=t[14];e[15]=t[15]}e[0]=n*r+h*s;e[1]=a*r+u*s;e[2]=o*r+c*s;e[3]=l*r+f*s;e[4]=h*r-n*s;e[5]=u*r-a*s;e[6]=c*r-o*s;e[7]=f*r-l*s;return e}function v(e,t){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=t[0];e[13]=t[1];e[14]=t[2];e[15]=1;return e}function E(e,t){e[0]=t[0];e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=t[1];e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=t[2];e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e}function b(e,t,i){var s=i[0],r=i[1],n=i[2];var a=Math.hypot(s,r,n);var o,l,h;if(a<D.EPSILON){return null}a=1/a;s*=a;r*=a;n*=a;o=Math.sin(t);l=Math.cos(t);h=1-l;e[0]=s*s*h+l;e[1]=r*s*h+n*o;e[2]=n*s*h-r*o;e[3]=0;e[4]=s*r*h-n*o;e[5]=r*r*h+l;e[6]=n*r*h+s*o;e[7]=0;e[8]=s*n*h+r*o;e[9]=r*n*h-s*o;e[10]=n*n*h+l;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e}function x(e,t){var i=Math.sin(t);var s=Math.cos(t);e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=s;e[6]=i;e[7]=0;e[8]=0;e[9]=-i;e[10]=s;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e}function T(e,t){var i=Math.sin(t);var s=Math.cos(t);e[0]=s;e[1]=0;e[2]=-i;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=i;e[9]=0;e[10]=s;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e}function S(e,t){var i=Math.sin(t);var s=Math.cos(t);e[0]=s;e[1]=i;e[2]=0;e[3]=0;e[4]=-i;e[5]=s;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e}function M(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3];var o=s+s;var l=r+r;var h=n+n;var u=s*o;var c=s*l;var f=s*h;var g=r*l;var d=r*h;var m=n*h;var p=a*o;var _=a*l;var v=a*h;e[0]=1-(g+m);e[1]=c+v;e[2]=f-_;e[3]=0;e[4]=c-v;e[5]=1-(u+m);e[6]=d+p;e[7]=0;e[8]=f+_;e[9]=d-p;e[10]=1-(u+g);e[11]=0;e[12]=i[0];e[13]=i[1];e[14]=i[2];e[15]=1;return e}function I(e,t){var i=new D.ARRAY_TYPE(3);var s=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7];var c=s*s+r*r+n*n+a*a;if(c>0){i[0]=(o*a+u*s+l*n-h*r)*2/c;i[1]=(l*a+u*r+h*s-o*n)*2/c;i[2]=(h*a+u*n+o*r-l*s)*2/c}else{i[0]=(o*a+u*s+l*n-h*r)*2;i[1]=(l*a+u*r+h*s-o*n)*2;i[2]=(h*a+u*n+o*r-l*s)*2}M(e,t,i);return e}function O(e,t){e[0]=t[12];e[1]=t[13];e[2]=t[14];return e}function R(e,t){var i=t[0];var s=t[1];var r=t[2];var n=t[4];var a=t[5];var o=t[6];var l=t[8];var h=t[9];var u=t[10];e[0]=Math.hypot(i,s,r);e[1]=Math.hypot(n,a,o);e[2]=Math.hypot(l,h,u);return e}function C(e,t){var i=new D.ARRAY_TYPE(3);R(i,t);var s=1/i[0];var r=1/i[1];var n=1/i[2];var a=t[0]*s;var o=t[1]*r;var l=t[2]*n;var h=t[4]*s;var u=t[5]*r;var c=t[6]*n;var f=t[8]*s;var g=t[9]*r;var d=t[10]*n;var m=a+u+d;var p=0;if(m>0){p=Math.sqrt(m+1)*2;e[3]=.25*p;e[0]=(c-g)/p;e[1]=(f-l)/p;e[2]=(o-h)/p}else if(a>u&&a>d){p=Math.sqrt(1+a-u-d)*2;e[3]=(c-g)/p;e[0]=.25*p;e[1]=(o+h)/p;e[2]=(f+l)/p}else if(u>d){p=Math.sqrt(1+u-a-d)*2;e[3]=(f-l)/p;e[0]=(o+h)/p;e[1]=.25*p;e[2]=(c+g)/p}else{p=Math.sqrt(1+d-a-u)*2;e[3]=(o-h)/p;e[0]=(f+l)/p;e[1]=(c+g)/p;e[2]=.25*p}return e}function P(e,t,i,s){var r=t[0],n=t[1],a=t[2],o=t[3];var l=r+r;var h=n+n;var u=a+a;var c=r*l;var f=r*h;var g=r*u;var d=n*h;var m=n*u;var p=a*u;var _=o*l;var v=o*h;var E=o*u;var b=s[0];var x=s[1];var T=s[2];e[0]=(1-(d+p))*b;e[1]=(f+E)*b;e[2]=(g-v)*b;e[3]=0;e[4]=(f-E)*x;e[5]=(1-(c+p))*x;e[6]=(m+_)*x;e[7]=0;e[8]=(g+v)*T;e[9]=(m-_)*T;e[10]=(1-(c+d))*T;e[11]=0;e[12]=i[0];e[13]=i[1];e[14]=i[2];e[15]=1;return e}function N(e,t,i,s,r){var n=t[0],a=t[1],o=t[2],l=t[3];var h=n+n;var u=a+a;var c=o+o;var f=n*h;var g=n*u;var d=n*c;var m=a*u;var p=a*c;var _=o*c;var v=l*h;var E=l*u;var b=l*c;var x=s[0];var T=s[1];var A=s[2];var S=r[0];var M=r[1];var I=r[2];var O=(1-(m+_))*x;var R=(g+b)*x;var C=(d-E)*x;var P=(g-b)*T;var N=(1-(f+_))*T;var F=(p+v)*T;var L=(d+E)*A;var D=(p-v)*A;var y=(1-(f+m))*A;e[0]=O;e[1]=R;e[2]=C;e[3]=0;e[4]=P;e[5]=N;e[6]=F;e[7]=0;e[8]=L;e[9]=D;e[10]=y;e[11]=0;e[12]=i[0]+S-(O*S+P*M+L*I);e[13]=i[1]+M-(R*S+N*M+D*I);e[14]=i[2]+I-(C*S+F*M+y*I);e[15]=1;return e}function F(e,t){var i=t[0],s=t[1],r=t[2],n=t[3];var a=i+i;var o=s+s;var l=r+r;var h=i*a;var u=s*a;var c=s*o;var f=r*a;var g=r*o;var d=r*l;var m=n*a;var p=n*o;var _=n*l;e[0]=1-c-d;e[1]=u+_;e[2]=f-p;e[3]=0;e[4]=u-_;e[5]=1-h-d;e[6]=g+m;e[7]=0;e[8]=f+p;e[9]=g-m;e[10]=1-h-c;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e}function L(e,t,i,s,r,n,a){var o=1/(i-t);var l=1/(r-s);var h=1/(n-a);e[0]=n*2*o;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=n*2*l;e[6]=0;e[7]=0;e[8]=(i+t)*o;e[9]=(r+s)*l;e[10]=(a+n)*h;e[11]=-1;e[12]=0;e[13]=0;e[14]=a*n*2*h;e[15]=0;return e}function w(e,t,i,s,r){var n=1/Math.tan(t/2),a;e[0]=n/i;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=n;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[11]=-1;e[12]=0;e[13]=0;e[15]=0;if(r!=null&&r!==Infinity){a=1/(s-r);e[10]=(r+s)*a;e[14]=2*r*s*a}else{e[10]=-1;e[14]=-2*s}return e}function B(e,t,i,s){var r=Math.tan(t.upDegrees*Math.PI/180);var n=Math.tan(t.downDegrees*Math.PI/180);var a=Math.tan(t.leftDegrees*Math.PI/180);var o=Math.tan(t.rightDegrees*Math.PI/180);var l=2/(a+o);var h=2/(r+n);e[0]=l;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=h;e[6]=0;e[7]=0;e[8]=-((a-o)*l*.5);e[9]=(r-n)*h*.5;e[10]=s/(i-s);e[11]=-1;e[12]=0;e[13]=0;e[14]=s*i/(i-s);e[15]=0;return e}function V(e,t,i,s,r,n,a){var o=1/(t-i);var l=1/(s-r);var h=1/(n-a);e[0]=-2*o;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=-2*l;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=2*h;e[11]=0;e[12]=(t+i)*o;e[13]=(r+s)*l;e[14]=(a+n)*h;e[15]=1;return e}function k(e,t,i,s){var r,n,a,o,l,h,u,c,f,g;var d=t[0];var m=t[1];var p=t[2];var _=s[0];var v=s[1];var E=s[2];var b=i[0];var x=i[1];var T=i[2];if(Math.abs(d-b)<D.EPSILON&&Math.abs(m-x)<D.EPSILON&&Math.abs(p-T)<D.EPSILON){return A(e)}u=d-b;c=m-x;f=p-T;g=1/Math.hypot(u,c,f);u*=g;c*=g;f*=g;r=v*f-E*c;n=E*u-_*f;a=_*c-v*u;g=Math.hypot(r,n,a);if(!g){r=0;n=0;a=0}else{g=1/g;r*=g;n*=g;a*=g}o=c*a-f*n;l=f*r-u*a;h=u*n-c*r;g=Math.hypot(o,l,h);if(!g){o=0;l=0;h=0}else{g=1/g;o*=g;l*=g;h*=g}e[0]=r;e[1]=o;e[2]=u;e[3]=0;e[4]=n;e[5]=l;e[6]=c;e[7]=0;e[8]=a;e[9]=h;e[10]=f;e[11]=0;e[12]=-(r*d+n*m+a*p);e[13]=-(o*d+l*m+h*p);e[14]=-(u*d+c*m+f*p);e[15]=1;return e}function G(e,t,i,s){var r=t[0],n=t[1],a=t[2],o=s[0],l=s[1],h=s[2];var u=r-i[0],c=n-i[1],f=a-i[2];var g=u*u+c*c+f*f;if(g>0){g=1/Math.sqrt(g);u*=g;c*=g;f*=g}var d=l*f-h*c,m=h*u-o*f,p=o*c-l*u;g=d*d+m*m+p*p;if(g>0){g=1/Math.sqrt(g);d*=g;m*=g;p*=g}e[0]=d;e[1]=m;e[2]=p;e[3]=0;e[4]=c*p-f*m;e[5]=f*d-u*p;e[6]=u*m-c*d;e[7]=0;e[8]=u;e[9]=c;e[10]=f;e[11]=0;e[12]=r;e[13]=n;e[14]=a;e[15]=1;return e}function j(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"}function H(e){return Math.hypot(e[0],e[1],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function z(e,t,i){e[0]=t[0]+i[0];e[1]=t[1]+i[1];e[2]=t[2]+i[2];e[3]=t[3]+i[3];e[4]=t[4]+i[4];e[5]=t[5]+i[5];e[6]=t[6]+i[6];e[7]=t[7]+i[7];e[8]=t[8]+i[8];e[9]=t[9]+i[9];e[10]=t[10]+i[10];e[11]=t[11]+i[11];e[12]=t[12]+i[12];e[13]=t[13]+i[13];e[14]=t[14]+i[14];e[15]=t[15]+i[15];return e}function y(e,t,i){e[0]=t[0]-i[0];e[1]=t[1]-i[1];e[2]=t[2]-i[2];e[3]=t[3]-i[3];e[4]=t[4]-i[4];e[5]=t[5]-i[5];e[6]=t[6]-i[6];e[7]=t[7]-i[7];e[8]=t[8]-i[8];e[9]=t[9]-i[9];e[10]=t[10]-i[10];e[11]=t[11]-i[11];e[12]=t[12]-i[12];e[13]=t[13]-i[13];e[14]=t[14]-i[14];e[15]=t[15]-i[15];return e}function X(e,t,i){e[0]=t[0]*i;e[1]=t[1]*i;e[2]=t[2]*i;e[3]=t[3]*i;e[4]=t[4]*i;e[5]=t[5]*i;e[6]=t[6]*i;e[7]=t[7]*i;e[8]=t[8]*i;e[9]=t[9]*i;e[10]=t[10]*i;e[11]=t[11]*i;e[12]=t[12]*i;e[13]=t[13]*i;e[14]=t[14]*i;e[15]=t[15]*i;return e}function Y(e,t,i,s){e[0]=t[0]+i[0]*s;e[1]=t[1]+i[1]*s;e[2]=t[2]+i[2]*s;e[3]=t[3]+i[3]*s;e[4]=t[4]+i[4]*s;e[5]=t[5]+i[5]*s;e[6]=t[6]+i[6]*s;e[7]=t[7]+i[7]*s;e[8]=t[8]+i[8]*s;e[9]=t[9]+i[9]*s;e[10]=t[10]+i[10]*s;e[11]=t[11]+i[11]*s;e[12]=t[12]+i[12]*s;e[13]=t[13]+i[13]*s;e[14]=t[14]+i[14]*s;e[15]=t[15]+i[15]*s;return e}function W(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]}function q(e,t){var i=e[0],s=e[1],r=e[2],n=e[3];var a=e[4],o=e[5],l=e[6],h=e[7];var u=e[8],c=e[9],f=e[10],g=e[11];var d=e[12],m=e[13],p=e[14],_=e[15];var v=t[0],E=t[1],b=t[2],x=t[3];var T=t[4],A=t[5],S=t[6],M=t[7];var I=t[8],O=t[9],R=t[10],C=t[11];var P=t[12],N=t[13],F=t[14],L=t[15];return Math.abs(i-v)<=D.EPSILON*Math.max(1,Math.abs(i),Math.abs(v))&&Math.abs(s-E)<=D.EPSILON*Math.max(1,Math.abs(s),Math.abs(E))&&Math.abs(r-b)<=D.EPSILON*Math.max(1,Math.abs(r),Math.abs(b))&&Math.abs(n-x)<=D.EPSILON*Math.max(1,Math.abs(n),Math.abs(x))&&Math.abs(a-T)<=D.EPSILON*Math.max(1,Math.abs(a),Math.abs(T))&&Math.abs(o-A)<=D.EPSILON*Math.max(1,Math.abs(o),Math.abs(A))&&Math.abs(l-S)<=D.EPSILON*Math.max(1,Math.abs(l),Math.abs(S))&&Math.abs(h-M)<=D.EPSILON*Math.max(1,Math.abs(h),Math.abs(M))&&Math.abs(u-I)<=D.EPSILON*Math.max(1,Math.abs(u),Math.abs(I))&&Math.abs(c-O)<=D.EPSILON*Math.max(1,Math.abs(c),Math.abs(O))&&Math.abs(f-R)<=D.EPSILON*Math.max(1,Math.abs(f),Math.abs(R))&&Math.abs(g-C)<=D.EPSILON*Math.max(1,Math.abs(g),Math.abs(C))&&Math.abs(d-P)<=D.EPSILON*Math.max(1,Math.abs(d),Math.abs(P))&&Math.abs(m-N)<=D.EPSILON*Math.max(1,Math.abs(m),Math.abs(N))&&Math.abs(p-F)<=D.EPSILON*Math.max(1,Math.abs(p),Math.abs(F))&&Math.abs(_-L)<=D.EPSILON*Math.max(1,Math.abs(_),Math.abs(L))}var K=c;var Z=y},221:(U,e,t)=>{"use strict";t.r(e);t.d(e,{add:()=>P,calculateW:()=>d,clone:()=>I,conjugate:()=>T,copy:()=>R,create:()=>r,dot:()=>F,equals:()=>j,exactEquals:()=>G,exp:()=>m,fromEuler:()=>S,fromMat3:()=>A,fromValues:()=>O,getAngle:()=>h,getAxisAngle:()=>a,identity:()=>n,invert:()=>x,len:()=>V,length:()=>L,lerp:()=>B,ln:()=>p,mul:()=>w,multiply:()=>u,normalize:()=>y,pow:()=>v,random:()=>b,rotateX:()=>c,rotateY:()=>f,rotateZ:()=>g,rotationTo:()=>H,scale:()=>N,set:()=>C,setAxes:()=>X,setAxisAngle:()=>l,slerp:()=>E,sqlerp:()=>z,sqrLen:()=>k,squaredLength:()=>D,str:()=>M});var _=t(823);var i=t(409);var o=t(329);var s=t(796);function r(){var e=new _.ARRAY_TYPE(4);if(_.ARRAY_TYPE!=Float32Array){e[0]=0;e[1]=0;e[2]=0}e[3]=1;return e}function n(e){e[0]=0;e[1]=0;e[2]=0;e[3]=1;return e}function l(e,t,i){i=i*.5;var s=Math.sin(i);e[0]=s*t[0];e[1]=s*t[1];e[2]=s*t[2];e[3]=Math.cos(i);return e}function a(e,t){var i=Math.acos(t[3])*2;var s=Math.sin(i/2);if(s>_.EPSILON){e[0]=t[0]/s;e[1]=t[1]/s;e[2]=t[2]/s}else{e[0]=1;e[1]=0;e[2]=0}return i}function h(e,t){var i=F(e,t);return Math.acos(2*i*i-1)}function u(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3];var o=i[0],l=i[1],h=i[2],u=i[3];e[0]=s*u+a*o+r*h-n*l;e[1]=r*u+a*l+n*o-s*h;e[2]=n*u+a*h+s*l-r*o;e[3]=a*u-s*o-r*l-n*h;return e}function c(e,t,i){i*=.5;var s=t[0],r=t[1],n=t[2],a=t[3];var o=Math.sin(i),l=Math.cos(i);e[0]=s*l+a*o;e[1]=r*l+n*o;e[2]=n*l-r*o;e[3]=a*l-s*o;return e}function f(e,t,i){i*=.5;var s=t[0],r=t[1],n=t[2],a=t[3];var o=Math.sin(i),l=Math.cos(i);e[0]=s*l-n*o;e[1]=r*l+a*o;e[2]=n*l+s*o;e[3]=a*l-r*o;return e}function g(e,t,i){i*=.5;var s=t[0],r=t[1],n=t[2],a=t[3];var o=Math.sin(i),l=Math.cos(i);e[0]=s*l+r*o;e[1]=r*l-s*o;e[2]=n*l+a*o;e[3]=a*l-n*o;return e}function d(e,t){var i=t[0],s=t[1],r=t[2];e[0]=i;e[1]=s;e[2]=r;e[3]=Math.sqrt(Math.abs(1-i*i-s*s-r*r));return e}function m(e,t){var i=t[0],s=t[1],r=t[2],n=t[3];var a=Math.sqrt(i*i+s*s+r*r);var o=Math.exp(n);var l=a>0?o*Math.sin(a)/a:0;e[0]=i*l;e[1]=s*l;e[2]=r*l;e[3]=o*Math.cos(a);return e}function p(e,t){var i=t[0],s=t[1],r=t[2],n=t[3];var a=Math.sqrt(i*i+s*s+r*r);var o=a>0?Math.atan2(a,n)/a:0;e[0]=i*o;e[1]=s*o;e[2]=r*o;e[3]=.5*Math.log(i*i+s*s+r*r+n*n);return e}function v(e,t,i){p(e,t);N(e,e,i);m(e,e);return e}function E(e,t,i,s){var r=t[0],n=t[1],a=t[2],o=t[3];var l=i[0],h=i[1],u=i[2],c=i[3];var f,g,d,m,p;g=r*l+n*h+a*u+o*c;if(g<0){g=-g;l=-l;h=-h;u=-u;c=-c}if(1-g>_.EPSILON){f=Math.acos(g);d=Math.sin(f);m=Math.sin((1-s)*f)/d;p=Math.sin(s*f)/d}else{m=1-s;p=s}e[0]=m*r+p*l;e[1]=m*n+p*h;e[2]=m*a+p*u;e[3]=m*o+p*c;return e}function b(e){var t=_.RANDOM();var i=_.RANDOM();var s=_.RANDOM();var r=Math.sqrt(1-t);var n=Math.sqrt(t);e[0]=r*Math.sin(2*Math.PI*i);e[1]=r*Math.cos(2*Math.PI*i);e[2]=n*Math.sin(2*Math.PI*s);e[3]=n*Math.cos(2*Math.PI*s);return e}function x(e,t){var i=t[0],s=t[1],r=t[2],n=t[3];var a=i*i+s*s+r*r+n*n;var o=a?1/a:0;e[0]=-i*o;e[1]=-s*o;e[2]=-r*o;e[3]=n*o;return e}function T(e,t){e[0]=-t[0];e[1]=-t[1];e[2]=-t[2];e[3]=t[3];return e}function A(e,t){var i=t[0]+t[4]+t[8];var s;if(i>0){s=Math.sqrt(i+1);e[3]=.5*s;s=.5/s;e[0]=(t[5]-t[7])*s;e[1]=(t[6]-t[2])*s;e[2]=(t[1]-t[3])*s}else{var r=0;if(t[4]>t[0])r=1;if(t[8]>t[r*3+r])r=2;var n=(r+1)%3;var a=(r+2)%3;s=Math.sqrt(t[r*3+r]-t[n*3+n]-t[a*3+a]+1);e[r]=.5*s;s=.5/s;e[3]=(t[n*3+a]-t[a*3+n])*s;e[n]=(t[n*3+r]+t[r*3+n])*s;e[a]=(t[a*3+r]+t[r*3+a])*s}return e}function S(e,t,i,s){var r=.5*Math.PI/180;t*=r;i*=r;s*=r;var n=Math.sin(t);var a=Math.cos(t);var o=Math.sin(i);var l=Math.cos(i);var h=Math.sin(s);var u=Math.cos(s);e[0]=n*l*u-a*o*h;e[1]=a*o*u+n*l*h;e[2]=a*l*h-n*o*u;e[3]=a*l*u+n*o*h;return e}function M(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}var I=s.clone;var O=s.fromValues;var R=s.copy;var C=s.set;var P=s.add;var w=u;var N=s.scale;var F=s.dot;var B=s.lerp;var L=s.length;var V=L;var D=s.squaredLength;var k=D;var y=s.normalize;var G=s.exactEquals;var j=s.equals;var H=function(){var r=o.create();var n=o.fromValues(1,0,0);var a=o.fromValues(0,1,0);return function(e,t,i){var s=o.dot(t,i);if(s<-.999999){o.cross(r,n,t);if(o.len(r)<1e-6)o.cross(r,a,t);o.normalize(r,r);l(e,r,Math.PI);return e}else if(s>.999999){e[0]=0;e[1]=0;e[2]=0;e[3]=1;return e}else{o.cross(r,t,i);e[0]=r[0];e[1]=r[1];e[2]=r[2];e[3]=1+s;return y(e,e)}}}();var z=function(){var a=r();var o=r();return function(e,t,i,s,r,n){E(a,t,r,n);E(o,i,s,n);E(e,a,o,2*n*(1-n));return e}}();var X=function(){var r=i.create();return function(e,t,i,s){r[0]=i[0];r[3]=i[1];r[6]=i[2];r[1]=s[0];r[4]=s[1];r[7]=s[2];r[2]=-t[0];r[5]=-t[1];r[8]=-t[2];return y(e,A(e,r))}}()},991:(U,e,t)=>{"use strict";t.r(e);t.d(e,{add:()=>R,clone:()=>s,conjugate:()=>B,copy:()=>E,create:()=>i,dot:()=>F,equals:()=>z,exactEquals:()=>H,fromMat4:()=>u,fromRotation:()=>h,fromRotationTranslation:()=>o,fromRotationTranslationValues:()=>a,fromTranslation:()=>l,fromValues:()=>n,getDual:()=>d,getReal:()=>g,getTranslation:()=>b,identity:()=>c,invert:()=>w,len:()=>V,length:()=>D,lerp:()=>L,mul:()=>P,multiply:()=>C,normalize:()=>G,rotateAroundAxis:()=>O,rotateByQuatAppend:()=>M,rotateByQuatPrepend:()=>I,rotateX:()=>T,rotateY:()=>A,rotateZ:()=>S,scale:()=>N,set:()=>f,setDual:()=>_,setReal:()=>p,sqrLen:()=>k,squaredLength:()=>y,str:()=>j,translate:()=>x});var v=t(823);var m=t(221);var r=t(684);function i(){var e=new v.ARRAY_TYPE(8);if(v.ARRAY_TYPE!=Float32Array){e[0]=0;e[1]=0;e[2]=0;e[4]=0;e[5]=0;e[6]=0;e[7]=0}e[3]=1;return e}function s(e){var t=new v.ARRAY_TYPE(8);t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];return t}function n(e,t,i,s,r,n,a,o){var l=new v.ARRAY_TYPE(8);l[0]=e;l[1]=t;l[2]=i;l[3]=s;l[4]=r;l[5]=n;l[6]=a;l[7]=o;return l}function a(e,t,i,s,r,n,a){var o=new v.ARRAY_TYPE(8);o[0]=e;o[1]=t;o[2]=i;o[3]=s;var l=r*.5,h=n*.5,u=a*.5;o[4]=l*s+h*i-u*t;o[5]=h*s+u*e-l*i;o[6]=u*s+l*t-h*e;o[7]=-l*e-h*t-u*i;return o}function o(e,t,i){var s=i[0]*.5,r=i[1]*.5,n=i[2]*.5,a=t[0],o=t[1],l=t[2],h=t[3];e[0]=a;e[1]=o;e[2]=l;e[3]=h;e[4]=s*h+r*l-n*o;e[5]=r*h+n*a-s*l;e[6]=n*h+s*o-r*a;e[7]=-s*a-r*o-n*l;return e}function l(e,t){e[0]=0;e[1]=0;e[2]=0;e[3]=1;e[4]=t[0]*.5;e[5]=t[1]*.5;e[6]=t[2]*.5;e[7]=0;return e}function h(e,t){e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];e[4]=0;e[5]=0;e[6]=0;e[7]=0;return e}function u(e,t){var i=m.create();r.getRotation(i,t);var s=new v.ARRAY_TYPE(3);r.getTranslation(s,t);o(e,i,s);return e}function E(e,t){e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];e[4]=t[4];e[5]=t[5];e[6]=t[6];e[7]=t[7];return e}function c(e){e[0]=0;e[1]=0;e[2]=0;e[3]=1;e[4]=0;e[5]=0;e[6]=0;e[7]=0;return e}function f(e,t,i,s,r,n,a,o,l){e[0]=t;e[1]=i;e[2]=s;e[3]=r;e[4]=n;e[5]=a;e[6]=o;e[7]=l;return e}var g=m.copy;function d(e,t){e[0]=t[4];e[1]=t[5];e[2]=t[6];e[3]=t[7];return e}var p=m.copy;function _(e,t){e[4]=t[0];e[5]=t[1];e[6]=t[2];e[7]=t[3];return e}function b(e,t){var i=t[4],s=t[5],r=t[6],n=t[7],a=-t[0],o=-t[1],l=-t[2],h=t[3];e[0]=(i*h+n*a+s*l-r*o)*2;e[1]=(s*h+n*o+r*a-i*l)*2;e[2]=(r*h+n*l+i*o-s*a)*2;return e}function x(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3],o=i[0]*.5,l=i[1]*.5,h=i[2]*.5,u=t[4],c=t[5],f=t[6],g=t[7];e[0]=s;e[1]=r;e[2]=n;e[3]=a;e[4]=a*o+r*h-n*l+u;e[5]=a*l+n*o-s*h+c;e[6]=a*h+s*l-r*o+f;e[7]=-s*o-r*l-n*h+g;return e}function T(e,t,i){var s=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=o*a+u*s+l*n-h*r,f=l*a+u*r+h*s-o*n,g=h*a+u*n+o*r-l*s,d=u*a-o*s-l*r-h*n;m.rotateX(e,t,i);s=e[0];r=e[1];n=e[2];a=e[3];e[4]=c*a+d*s+f*n-g*r;e[5]=f*a+d*r+g*s-c*n;e[6]=g*a+d*n+c*r-f*s;e[7]=d*a-c*s-f*r-g*n;return e}function A(e,t,i){var s=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=o*a+u*s+l*n-h*r,f=l*a+u*r+h*s-o*n,g=h*a+u*n+o*r-l*s,d=u*a-o*s-l*r-h*n;m.rotateY(e,t,i);s=e[0];r=e[1];n=e[2];a=e[3];e[4]=c*a+d*s+f*n-g*r;e[5]=f*a+d*r+g*s-c*n;e[6]=g*a+d*n+c*r-f*s;e[7]=d*a-c*s-f*r-g*n;return e}function S(e,t,i){var s=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=o*a+u*s+l*n-h*r,f=l*a+u*r+h*s-o*n,g=h*a+u*n+o*r-l*s,d=u*a-o*s-l*r-h*n;m.rotateZ(e,t,i);s=e[0];r=e[1];n=e[2];a=e[3];e[4]=c*a+d*s+f*n-g*r;e[5]=f*a+d*r+g*s-c*n;e[6]=g*a+d*n+c*r-f*s;e[7]=d*a-c*s-f*r-g*n;return e}function M(e,t,i){var s=i[0],r=i[1],n=i[2],a=i[3],o=t[0],l=t[1],h=t[2],u=t[3];e[0]=o*a+u*s+l*n-h*r;e[1]=l*a+u*r+h*s-o*n;e[2]=h*a+u*n+o*r-l*s;e[3]=u*a-o*s-l*r-h*n;o=t[4];l=t[5];h=t[6];u=t[7];e[4]=o*a+u*s+l*n-h*r;e[5]=l*a+u*r+h*s-o*n;e[6]=h*a+u*n+o*r-l*s;e[7]=u*a-o*s-l*r-h*n;return e}function I(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3],o=i[0],l=i[1],h=i[2],u=i[3];e[0]=s*u+a*o+r*h-n*l;e[1]=r*u+a*l+n*o-s*h;e[2]=n*u+a*h+s*l-r*o;e[3]=a*u-s*o-r*l-n*h;o=i[4];l=i[5];h=i[6];u=i[7];e[4]=s*u+a*o+r*h-n*l;e[5]=r*u+a*l+n*o-s*h;e[6]=n*u+a*h+s*l-r*o;e[7]=a*u-s*o-r*l-n*h;return e}function O(e,t,i,s){if(Math.abs(s)<v.EPSILON){return E(e,t)}var r=Math.hypot(i[0],i[1],i[2]);s=s*.5;var n=Math.sin(s);var a=n*i[0]/r;var o=n*i[1]/r;var l=n*i[2]/r;var h=Math.cos(s);var u=t[0],c=t[1],f=t[2],g=t[3];e[0]=u*h+g*a+c*l-f*o;e[1]=c*h+g*o+f*a-u*l;e[2]=f*h+g*l+u*o-c*a;e[3]=g*h-u*a-c*o-f*l;var d=t[4],m=t[5],p=t[6],_=t[7];e[4]=d*h+_*a+m*l-p*o;e[5]=m*h+_*o+p*a-d*l;e[6]=p*h+_*l+d*o-m*a;e[7]=_*h-d*a-m*o-p*l;return e}function R(e,t,i){e[0]=t[0]+i[0];e[1]=t[1]+i[1];e[2]=t[2]+i[2];e[3]=t[3]+i[3];e[4]=t[4]+i[4];e[5]=t[5]+i[5];e[6]=t[6]+i[6];e[7]=t[7]+i[7];return e}function C(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3],o=i[4],l=i[5],h=i[6],u=i[7],c=t[4],f=t[5],g=t[6],d=t[7],m=i[0],p=i[1],_=i[2],v=i[3];e[0]=s*v+a*m+r*_-n*p;e[1]=r*v+a*p+n*m-s*_;e[2]=n*v+a*_+s*p-r*m;e[3]=a*v-s*m-r*p-n*_;e[4]=s*u+a*o+r*h-n*l+c*v+d*m+f*_-g*p;e[5]=r*u+a*l+n*o-s*h+f*v+d*p+g*m-c*_;e[6]=n*u+a*h+s*l-r*o+g*v+d*_+c*p-f*m;e[7]=a*u-s*o-r*l-n*h+d*v-c*m-f*p-g*_;return e}var P=C;function N(e,t,i){e[0]=t[0]*i;e[1]=t[1]*i;e[2]=t[2]*i;e[3]=t[3]*i;e[4]=t[4]*i;e[5]=t[5]*i;e[6]=t[6]*i;e[7]=t[7]*i;return e}var F=m.dot;function L(e,t,i,s){var r=1-s;if(F(t,i)<0)s=-s;e[0]=t[0]*r+i[0]*s;e[1]=t[1]*r+i[1]*s;e[2]=t[2]*r+i[2]*s;e[3]=t[3]*r+i[3]*s;e[4]=t[4]*r+i[4]*s;e[5]=t[5]*r+i[5]*s;e[6]=t[6]*r+i[6]*s;e[7]=t[7]*r+i[7]*s;return e}function w(e,t){var i=y(t);e[0]=-t[0]/i;e[1]=-t[1]/i;e[2]=-t[2]/i;e[3]=t[3]/i;e[4]=-t[4]/i;e[5]=-t[5]/i;e[6]=-t[6]/i;e[7]=t[7]/i;return e}function B(e,t){e[0]=-t[0];e[1]=-t[1];e[2]=-t[2];e[3]=t[3];e[4]=-t[4];e[5]=-t[5];e[6]=-t[6];e[7]=t[7];return e}var D=m.length;var V=D;var y=m.squaredLength;var k=y;function G(e,t){var i=y(t);if(i>0){i=Math.sqrt(i);var s=t[0]/i;var r=t[1]/i;var n=t[2]/i;var a=t[3]/i;var o=t[4];var l=t[5];var h=t[6];var u=t[7];var c=s*o+r*l+n*h+a*u;e[0]=s;e[1]=r;e[2]=n;e[3]=a;e[4]=(o-s*c)/i;e[5]=(l-r*c)/i;e[6]=(h-n*c)/i;e[7]=(u-a*c)/i}return e}function j(e){return"quat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+")"}function H(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]}function z(e,t){var i=e[0],s=e[1],r=e[2],n=e[3],a=e[4],o=e[5],l=e[6],h=e[7];var u=t[0],c=t[1],f=t[2],g=t[3],d=t[4],m=t[5],p=t[6],_=t[7];return Math.abs(i-u)<=v.EPSILON*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(s-c)<=v.EPSILON*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(r-f)<=v.EPSILON*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(n-g)<=v.EPSILON*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(a-d)<=v.EPSILON*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(o-m)<=v.EPSILON*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(l-p)<=v.EPSILON*Math.max(1,Math.abs(l),Math.abs(p))&&Math.abs(h-_)<=v.EPSILON*Math.max(1,Math.abs(h),Math.abs(_))}},842:(U,e,t)=>{"use strict";t.r(e);t.d(e,{add:()=>l,angle:()=>y,ceil:()=>f,clone:()=>s,copy:()=>n,create:()=>i,cross:()=>O,dist:()=>X,distance:()=>E,div:()=>z,divide:()=>c,dot:()=>I,equals:()=>k,exactEquals:()=>V,floor:()=>g,forEach:()=>q,fromValues:()=>r,inverse:()=>S,len:()=>G,length:()=>x,lerp:()=>R,max:()=>m,min:()=>d,mul:()=>H,multiply:()=>u,negate:()=>A,normalize:()=>M,random:()=>C,rotate:()=>D,round:()=>p,scale:()=>_,scaleAndAdd:()=>v,set:()=>o,sqrDist:()=>Y,sqrLen:()=>W,squaredDistance:()=>b,squaredLength:()=>T,str:()=>B,sub:()=>j,subtract:()=>h,transformMat2:()=>P,transformMat2d:()=>N,transformMat3:()=>F,transformMat4:()=>L,zero:()=>w});var a=t(823);function i(){var e=new a.ARRAY_TYPE(2);if(a.ARRAY_TYPE!=Float32Array){e[0]=0;e[1]=0}return e}function s(e){var t=new a.ARRAY_TYPE(2);t[0]=e[0];t[1]=e[1];return t}function r(e,t){var i=new a.ARRAY_TYPE(2);i[0]=e;i[1]=t;return i}function n(e,t){e[0]=t[0];e[1]=t[1];return e}function o(e,t,i){e[0]=t;e[1]=i;return e}function l(e,t,i){e[0]=t[0]+i[0];e[1]=t[1]+i[1];return e}function h(e,t,i){e[0]=t[0]-i[0];e[1]=t[1]-i[1];return e}function u(e,t,i){e[0]=t[0]*i[0];e[1]=t[1]*i[1];return e}function c(e,t,i){e[0]=t[0]/i[0];e[1]=t[1]/i[1];return e}function f(e,t){e[0]=Math.ceil(t[0]);e[1]=Math.ceil(t[1]);return e}function g(e,t){e[0]=Math.floor(t[0]);e[1]=Math.floor(t[1]);return e}function d(e,t,i){e[0]=Math.min(t[0],i[0]);e[1]=Math.min(t[1],i[1]);return e}function m(e,t,i){e[0]=Math.max(t[0],i[0]);e[1]=Math.max(t[1],i[1]);return e}function p(e,t){e[0]=Math.round(t[0]);e[1]=Math.round(t[1]);return e}function _(e,t,i){e[0]=t[0]*i;e[1]=t[1]*i;return e}function v(e,t,i,s){e[0]=t[0]+i[0]*s;e[1]=t[1]+i[1]*s;return e}function E(e,t){var i=t[0]-e[0],s=t[1]-e[1];return Math.hypot(i,s)}function b(e,t){var i=t[0]-e[0],s=t[1]-e[1];return i*i+s*s}function x(e){var t=e[0],i=e[1];return Math.hypot(t,i)}function T(e){var t=e[0],i=e[1];return t*t+i*i}function A(e,t){e[0]=-t[0];e[1]=-t[1];return e}function S(e,t){e[0]=1/t[0];e[1]=1/t[1];return e}function M(e,t){var i=t[0],s=t[1];var r=i*i+s*s;if(r>0){r=1/Math.sqrt(r)}e[0]=t[0]*r;e[1]=t[1]*r;return e}function I(e,t){return e[0]*t[0]+e[1]*t[1]}function O(e,t,i){var s=t[0]*i[1]-t[1]*i[0];e[0]=e[1]=0;e[2]=s;return e}function R(e,t,i,s){var r=t[0],n=t[1];e[0]=r+s*(i[0]-r);e[1]=n+s*(i[1]-n);return e}function C(e,t){t=t||1;var i=a.RANDOM()*2*Math.PI;e[0]=Math.cos(i)*t;e[1]=Math.sin(i)*t;return e}function P(e,t,i){var s=t[0],r=t[1];e[0]=i[0]*s+i[2]*r;e[1]=i[1]*s+i[3]*r;return e}function N(e,t,i){var s=t[0],r=t[1];e[0]=i[0]*s+i[2]*r+i[4];e[1]=i[1]*s+i[3]*r+i[5];return e}function F(e,t,i){var s=t[0],r=t[1];e[0]=i[0]*s+i[3]*r+i[6];e[1]=i[1]*s+i[4]*r+i[7];return e}function L(e,t,i){var s=t[0];var r=t[1];e[0]=i[0]*s+i[4]*r+i[12];e[1]=i[1]*s+i[5]*r+i[13];return e}function D(e,t,i,s){var r=t[0]-i[0],n=t[1]-i[1],a=Math.sin(s),o=Math.cos(s);e[0]=r*o-n*a+i[0];e[1]=r*a+n*o+i[1];return e}function y(e,t){var i=e[0],s=e[1],r=t[0],n=t[1];var a=i*i+s*s;if(a>0){a=1/Math.sqrt(a)}var o=r*r+n*n;if(o>0){o=1/Math.sqrt(o)}var l=(i*r+s*n)*a*o;if(l>1){return 0}else if(l<-1){return Math.PI}else{return Math.acos(l)}}function w(e){e[0]=0;e[1]=0;return e}function B(e){return"vec2("+e[0]+", "+e[1]+")"}function V(e,t){return e[0]===t[0]&&e[1]===t[1]}function k(e,t){var i=e[0],s=e[1];var r=t[0],n=t[1];return Math.abs(i-r)<=a.EPSILON*Math.max(1,Math.abs(i),Math.abs(r))&&Math.abs(s-n)<=a.EPSILON*Math.max(1,Math.abs(s),Math.abs(n))}var G=x;var j=h;var H=u;var z=c;var X=E;var Y=b;var W=T;var q=function(){var l=i();return function(e,t,i,s,r,n){var a,o;if(!t){t=2}if(!i){i=0}if(s){o=Math.min(s*t+i,e.length)}else{o=e.length}for(a=i;a<o;a+=t){l[0]=e[a];l[1]=e[a+1];r(l,l,n);e[a]=l[0];e[a+1]=l[1]}return e}}()},329:(U,e,t)=>{"use strict";t.r(e);t.d(e,{add:()=>h,angle:()=>V,bezier:()=>P,ceil:()=>g,clone:()=>s,copy:()=>a,create:()=>i,cross:()=>O,dist:()=>W,distance:()=>b,div:()=>Y,divide:()=>f,dot:()=>I,equals:()=>H,exactEquals:()=>j,floor:()=>d,forEach:()=>Q,fromValues:()=>n,hermite:()=>C,inverse:()=>S,len:()=>K,length:()=>r,lerp:()=>R,max:()=>p,min:()=>m,mul:()=>X,multiply:()=>c,negate:()=>A,normalize:()=>M,random:()=>N,rotateX:()=>y,rotateY:()=>w,rotateZ:()=>B,round:()=>_,scale:()=>v,scaleAndAdd:()=>E,set:()=>o,sqrDist:()=>q,sqrLen:()=>Z,squaredDistance:()=>x,squaredLength:()=>T,str:()=>G,sub:()=>z,subtract:()=>u,transformMat3:()=>L,transformMat4:()=>F,transformQuat:()=>D,zero:()=>k});var l=t(823);function i(){var e=new l.ARRAY_TYPE(3);if(l.ARRAY_TYPE!=Float32Array){e[0]=0;e[1]=0;e[2]=0}return e}function s(e){var t=new l.ARRAY_TYPE(3);t[0]=e[0];t[1]=e[1];t[2]=e[2];return t}function r(e){var t=e[0];var i=e[1];var s=e[2];return Math.hypot(t,i,s)}function n(e,t,i){var s=new l.ARRAY_TYPE(3);s[0]=e;s[1]=t;s[2]=i;return s}function a(e,t){e[0]=t[0];e[1]=t[1];e[2]=t[2];return e}function o(e,t,i,s){e[0]=t;e[1]=i;e[2]=s;return e}function h(e,t,i){e[0]=t[0]+i[0];e[1]=t[1]+i[1];e[2]=t[2]+i[2];return e}function u(e,t,i){e[0]=t[0]-i[0];e[1]=t[1]-i[1];e[2]=t[2]-i[2];return e}function c(e,t,i){e[0]=t[0]*i[0];e[1]=t[1]*i[1];e[2]=t[2]*i[2];return e}function f(e,t,i){e[0]=t[0]/i[0];e[1]=t[1]/i[1];e[2]=t[2]/i[2];return e}function g(e,t){e[0]=Math.ceil(t[0]);e[1]=Math.ceil(t[1]);e[2]=Math.ceil(t[2]);return e}function d(e,t){e[0]=Math.floor(t[0]);e[1]=Math.floor(t[1]);e[2]=Math.floor(t[2]);return e}function m(e,t,i){e[0]=Math.min(t[0],i[0]);e[1]=Math.min(t[1],i[1]);e[2]=Math.min(t[2],i[2]);return e}function p(e,t,i){e[0]=Math.max(t[0],i[0]);e[1]=Math.max(t[1],i[1]);e[2]=Math.max(t[2],i[2]);return e}function _(e,t){e[0]=Math.round(t[0]);e[1]=Math.round(t[1]);e[2]=Math.round(t[2]);return e}function v(e,t,i){e[0]=t[0]*i;e[1]=t[1]*i;e[2]=t[2]*i;return e}function E(e,t,i,s){e[0]=t[0]+i[0]*s;e[1]=t[1]+i[1]*s;e[2]=t[2]+i[2]*s;return e}function b(e,t){var i=t[0]-e[0];var s=t[1]-e[1];var r=t[2]-e[2];return Math.hypot(i,s,r)}function x(e,t){var i=t[0]-e[0];var s=t[1]-e[1];var r=t[2]-e[2];return i*i+s*s+r*r}function T(e){var t=e[0];var i=e[1];var s=e[2];return t*t+i*i+s*s}function A(e,t){e[0]=-t[0];e[1]=-t[1];e[2]=-t[2];return e}function S(e,t){e[0]=1/t[0];e[1]=1/t[1];e[2]=1/t[2];return e}function M(e,t){var i=t[0];var s=t[1];var r=t[2];var n=i*i+s*s+r*r;if(n>0){n=1/Math.sqrt(n)}e[0]=t[0]*n;e[1]=t[1]*n;e[2]=t[2]*n;return e}function I(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function O(e,t,i){var s=t[0],r=t[1],n=t[2];var a=i[0],o=i[1],l=i[2];e[0]=r*l-n*o;e[1]=n*a-s*l;e[2]=s*o-r*a;return e}function R(e,t,i,s){var r=t[0];var n=t[1];var a=t[2];e[0]=r+s*(i[0]-r);e[1]=n+s*(i[1]-n);e[2]=a+s*(i[2]-a);return e}function C(e,t,i,s,r,n){var a=n*n;var o=a*(2*n-3)+1;var l=a*(n-2)+n;var h=a*(n-1);var u=a*(3-2*n);e[0]=t[0]*o+i[0]*l+s[0]*h+r[0]*u;e[1]=t[1]*o+i[1]*l+s[1]*h+r[1]*u;e[2]=t[2]*o+i[2]*l+s[2]*h+r[2]*u;return e}function P(e,t,i,s,r,n){var a=1-n;var o=a*a;var l=n*n;var h=o*a;var u=3*n*o;var c=3*l*a;var f=l*n;e[0]=t[0]*h+i[0]*u+s[0]*c+r[0]*f;e[1]=t[1]*h+i[1]*u+s[1]*c+r[1]*f;e[2]=t[2]*h+i[2]*u+s[2]*c+r[2]*f;return e}function N(e,t){t=t||1;var i=l.RANDOM()*2*Math.PI;var s=l.RANDOM()*2-1;var r=Math.sqrt(1-s*s)*t;e[0]=Math.cos(i)*r;e[1]=Math.sin(i)*r;e[2]=s*t;return e}function F(e,t,i){var s=t[0],r=t[1],n=t[2];var a=i[3]*s+i[7]*r+i[11]*n+i[15];a=a||1;e[0]=(i[0]*s+i[4]*r+i[8]*n+i[12])/a;e[1]=(i[1]*s+i[5]*r+i[9]*n+i[13])/a;e[2]=(i[2]*s+i[6]*r+i[10]*n+i[14])/a;return e}function L(e,t,i){var s=t[0],r=t[1],n=t[2];e[0]=s*i[0]+r*i[3]+n*i[6];e[1]=s*i[1]+r*i[4]+n*i[7];e[2]=s*i[2]+r*i[5]+n*i[8];return e}function D(e,t,i){var s=i[0],r=i[1],n=i[2],a=i[3];var o=t[0],l=t[1],h=t[2];var u=r*h-n*l,c=n*o-s*h,f=s*l-r*o;var g=r*f-n*c,d=n*u-s*f,m=s*c-r*u;var p=a*2;u*=p;c*=p;f*=p;g*=2;d*=2;m*=2;e[0]=o+u+g;e[1]=l+c+d;e[2]=h+f+m;return e}function y(e,t,i,s){var r=[],n=[];r[0]=t[0]-i[0];r[1]=t[1]-i[1];r[2]=t[2]-i[2];n[0]=r[0];n[1]=r[1]*Math.cos(s)-r[2]*Math.sin(s);n[2]=r[1]*Math.sin(s)+r[2]*Math.cos(s);e[0]=n[0]+i[0];e[1]=n[1]+i[1];e[2]=n[2]+i[2];return e}function w(e,t,i,s){var r=[],n=[];r[0]=t[0]-i[0];r[1]=t[1]-i[1];r[2]=t[2]-i[2];n[0]=r[2]*Math.sin(s)+r[0]*Math.cos(s);n[1]=r[1];n[2]=r[2]*Math.cos(s)-r[0]*Math.sin(s);e[0]=n[0]+i[0];e[1]=n[1]+i[1];e[2]=n[2]+i[2];return e}function B(e,t,i,s){var r=[],n=[];r[0]=t[0]-i[0];r[1]=t[1]-i[1];r[2]=t[2]-i[2];n[0]=r[0]*Math.cos(s)-r[1]*Math.sin(s);n[1]=r[0]*Math.sin(s)+r[1]*Math.cos(s);n[2]=r[2];e[0]=n[0]+i[0];e[1]=n[1]+i[1];e[2]=n[2]+i[2];return e}function V(e,t){var i=n(e[0],e[1],e[2]);var s=n(t[0],t[1],t[2]);M(i,i);M(s,s);var r=I(i,s);if(r>1){return 0}else if(r<-1){return Math.PI}else{return Math.acos(r)}}function k(e){e[0]=0;e[1]=0;e[2]=0;return e}function G(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"}function j(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function H(e,t){var i=e[0],s=e[1],r=e[2];var n=t[0],a=t[1],o=t[2];return Math.abs(i-n)<=l.EPSILON*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(s-a)<=l.EPSILON*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(r-o)<=l.EPSILON*Math.max(1,Math.abs(r),Math.abs(o))}var z=u;var X=c;var Y=f;var W=b;var q=x;var K=r;var Z=T;var Q=function(){var l=i();return function(e,t,i,s,r,n){var a,o;if(!t){t=3}if(!i){i=0}if(s){o=Math.min(s*t+i,e.length)}else{o=e.length}for(a=i;a<o;a+=t){l[0]=e[a];l[1]=e[a+1];l[2]=e[a+2];r(l,l,n);e[a]=l[0];e[a+1]=l[1];e[a+2]=l[2]}return e}}()},796:(U,e,t)=>{"use strict";t.r(e);t.d(e,{add:()=>o,ceil:()=>f,clone:()=>s,copy:()=>n,create:()=>i,cross:()=>O,dist:()=>k,distance:()=>E,div:()=>V,divide:()=>c,dot:()=>I,equals:()=>y,exactEquals:()=>D,floor:()=>g,forEach:()=>z,fromValues:()=>r,inverse:()=>S,len:()=>j,length:()=>x,lerp:()=>R,max:()=>m,min:()=>d,mul:()=>B,multiply:()=>h,negate:()=>A,normalize:()=>M,random:()=>C,round:()=>p,scale:()=>_,scaleAndAdd:()=>v,set:()=>a,sqrDist:()=>G,sqrLen:()=>H,squaredDistance:()=>b,squaredLength:()=>T,str:()=>L,sub:()=>w,subtract:()=>l,transformMat4:()=>P,transformQuat:()=>N,zero:()=>F});var u=t(823);function i(){var e=new u.ARRAY_TYPE(4);if(u.ARRAY_TYPE!=Float32Array){e[0]=0;e[1]=0;e[2]=0;e[3]=0}return e}function s(e){var t=new u.ARRAY_TYPE(4);t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];return t}function r(e,t,i,s){var r=new u.ARRAY_TYPE(4);r[0]=e;r[1]=t;r[2]=i;r[3]=s;return r}function n(e,t){e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];return e}function a(e,t,i,s,r){e[0]=t;e[1]=i;e[2]=s;e[3]=r;return e}function o(e,t,i){e[0]=t[0]+i[0];e[1]=t[1]+i[1];e[2]=t[2]+i[2];e[3]=t[3]+i[3];return e}function l(e,t,i){e[0]=t[0]-i[0];e[1]=t[1]-i[1];e[2]=t[2]-i[2];e[3]=t[3]-i[3];return e}function h(e,t,i){e[0]=t[0]*i[0];e[1]=t[1]*i[1];e[2]=t[2]*i[2];e[3]=t[3]*i[3];return e}function c(e,t,i){e[0]=t[0]/i[0];e[1]=t[1]/i[1];e[2]=t[2]/i[2];e[3]=t[3]/i[3];return e}function f(e,t){e[0]=Math.ceil(t[0]);e[1]=Math.ceil(t[1]);e[2]=Math.ceil(t[2]);e[3]=Math.ceil(t[3]);return e}function g(e,t){e[0]=Math.floor(t[0]);e[1]=Math.floor(t[1]);e[2]=Math.floor(t[2]);e[3]=Math.floor(t[3]);return e}function d(e,t,i){e[0]=Math.min(t[0],i[0]);e[1]=Math.min(t[1],i[1]);e[2]=Math.min(t[2],i[2]);e[3]=Math.min(t[3],i[3]);return e}function m(e,t,i){e[0]=Math.max(t[0],i[0]);e[1]=Math.max(t[1],i[1]);e[2]=Math.max(t[2],i[2]);e[3]=Math.max(t[3],i[3]);return e}function p(e,t){e[0]=Math.round(t[0]);e[1]=Math.round(t[1]);e[2]=Math.round(t[2]);e[3]=Math.round(t[3]);return e}function _(e,t,i){e[0]=t[0]*i;e[1]=t[1]*i;e[2]=t[2]*i;e[3]=t[3]*i;return e}function v(e,t,i,s){e[0]=t[0]+i[0]*s;e[1]=t[1]+i[1]*s;e[2]=t[2]+i[2]*s;e[3]=t[3]+i[3]*s;return e}function E(e,t){var i=t[0]-e[0];var s=t[1]-e[1];var r=t[2]-e[2];var n=t[3]-e[3];return Math.hypot(i,s,r,n)}function b(e,t){var i=t[0]-e[0];var s=t[1]-e[1];var r=t[2]-e[2];var n=t[3]-e[3];return i*i+s*s+r*r+n*n}function x(e){var t=e[0];var i=e[1];var s=e[2];var r=e[3];return Math.hypot(t,i,s,r)}function T(e){var t=e[0];var i=e[1];var s=e[2];var r=e[3];return t*t+i*i+s*s+r*r}function A(e,t){e[0]=-t[0];e[1]=-t[1];e[2]=-t[2];e[3]=-t[3];return e}function S(e,t){e[0]=1/t[0];e[1]=1/t[1];e[2]=1/t[2];e[3]=1/t[3];return e}function M(e,t){var i=t[0];var s=t[1];var r=t[2];var n=t[3];var a=i*i+s*s+r*r+n*n;if(a>0){a=1/Math.sqrt(a)}e[0]=i*a;e[1]=s*a;e[2]=r*a;e[3]=n*a;return e}function I(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function O(e,t,i,s){var r=i[0]*s[1]-i[1]*s[0],n=i[0]*s[2]-i[2]*s[0],a=i[0]*s[3]-i[3]*s[0],o=i[1]*s[2]-i[2]*s[1],l=i[1]*s[3]-i[3]*s[1],h=i[2]*s[3]-i[3]*s[2];var u=t[0];var c=t[1];var f=t[2];var g=t[3];e[0]=c*h-f*l+g*o;e[1]=-(u*h)+f*a-g*n;e[2]=u*l-c*a+g*r;e[3]=-(u*o)+c*n-f*r;return e}function R(e,t,i,s){var r=t[0];var n=t[1];var a=t[2];var o=t[3];e[0]=r+s*(i[0]-r);e[1]=n+s*(i[1]-n);e[2]=a+s*(i[2]-a);e[3]=o+s*(i[3]-o);return e}function C(e,t){t=t||1;var i,s,r,n;var a,o;do{i=u.RANDOM()*2-1;s=u.RANDOM()*2-1;a=i*i+s*s}while(a>=1);do{r=u.RANDOM()*2-1;n=u.RANDOM()*2-1;o=r*r+n*n}while(o>=1);var l=Math.sqrt((1-a)/o);e[0]=t*i;e[1]=t*s;e[2]=t*r*l;e[3]=t*n*l;return e}function P(e,t,i){var s=t[0],r=t[1],n=t[2],a=t[3];e[0]=i[0]*s+i[4]*r+i[8]*n+i[12]*a;e[1]=i[1]*s+i[5]*r+i[9]*n+i[13]*a;e[2]=i[2]*s+i[6]*r+i[10]*n+i[14]*a;e[3]=i[3]*s+i[7]*r+i[11]*n+i[15]*a;return e}function N(e,t,i){var s=t[0],r=t[1],n=t[2];var a=i[0],o=i[1],l=i[2],h=i[3];var u=h*s+o*n-l*r;var c=h*r+l*s-a*n;var f=h*n+a*r-o*s;var g=-a*s-o*r-l*n;e[0]=u*h+g*-a+c*-l-f*-o;e[1]=c*h+g*-o+f*-a-u*-l;e[2]=f*h+g*-l+u*-o-c*-a;e[3]=t[3];return e}function F(e){e[0]=0;e[1]=0;e[2]=0;e[3]=0;return e}function L(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function D(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function y(e,t){var i=e[0],s=e[1],r=e[2],n=e[3];var a=t[0],o=t[1],l=t[2],h=t[3];return Math.abs(i-a)<=u.EPSILON*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-o)<=u.EPSILON*Math.max(1,Math.abs(s),Math.abs(o))&&Math.abs(r-l)<=u.EPSILON*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(n-h)<=u.EPSILON*Math.max(1,Math.abs(n),Math.abs(h))}var w=l;var B=h;var V=c;var k=E;var G=b;var j=x;var H=T;var z=function(){var l=i();return function(e,t,i,s,r,n){var a,o;if(!t){t=4}if(!i){i=0}if(s){o=Math.min(s*t+i,e.length)}else{o=e.length}for(a=i;a<o;a+=t){l[0]=e[a];l[1]=e[a+1];l[2]=e[a+2];l[3]=e[a+3];r(l,l,n);e[a]=l[0];e[a+1]=l[1];e[a+2]=l[2];e[a+3]=l[3]}return e}}()},344:(e,t,i)=>{"use strict";i.d(t,{k:()=>u});var s=i(125);var r=i(849);var n=i(562);var a=i(963);class u extends s.A{static EVENT_KEY_DELETE="keyDelete";static EVENT_CHANGE="onChange";static EVENT_UIATTRIB_CHANGE="uiattrchange";static LOOP_OFF=0;static LOOP_REPEAT=1;static LOOP_MIRROR=2;static LOOP_OFFSET=3;static EASING_LINEAR=0;static EASING_ABSOLUTE=1;static EASING_SMOOTHSTEP=2;static EASING_SMOOTHERSTEP=3;static EASING_CUBICSPLINE=4;static EASING_CUBIC_IN=5;static EASING_CUBIC_OUT=6;static EASING_CUBIC_INOUT=7;static EASING_EXPO_IN=8;static EASING_EXPO_OUT=9;static EASING_EXPO_INOUT=10;static EASING_SIN_IN=11;static EASING_SIN_OUT=12;static EASING_SIN_INOUT=13;static EASING_BACK_IN=14;static EASING_BACK_OUT=15;static EASING_BACK_INOUT=16;static EASING_ELASTIC_IN=17;static EASING_ELASTIC_OUT=18;static EASING_BOUNCE_IN=19;static EASING_BOUNCE_OUT=21;static EASING_QUART_IN=22;static EASING_QUART_OUT=23;static EASING_QUART_INOUT=24;static EASING_QUINT_IN=25;static EASING_QUINT_OUT=26;static EASING_QUINT_INOUT=27;static EASING_CLIP=28;static EASINGNAMES=["linear","absolute","smoothstep","smootherstep","Cubic In","Cubic Out","Cubic In Out","Expo In","Expo Out","Expo In Out","Sin In","Sin Out","Sin In Out","Quart In","Quart Out","Quart In Out","Quint In","Quint Out","Quint In Out","Back In","Back Out","Back In Out","Elastic In","Elastic Out","Bounce In","Bounce Out","Clip"];#tlActive=true;uiAttribs={};loop=0;onLooped=null;_timesLooped=0;#needsSort=false;_cachedIndex=0;port=null;keys=[];onChange=null;stayInTimeline=false;batchMode=false;constructor(e={}){super();e=e||{};this.id=(0,n.uuid)();this._log=new r.A("Anim");this.name=e.name||null;this.defaultEasing=e.defaultEasing||u.EASING_LINEAR}forceChangeCallback(){if(this.onChange!==null)this.onChange();this.emitEvent(u.EVENT_CHANGE,this)}forceChangeCallbackSoon(){if(this.batchMode)return;if(!this.forcecbto)this.forcecbto=setTimeout(()=>{this.forceChangeCallback();this.forcecbto=null},50)}getLoop(){return this.loop}setLoop(e){if(e===false)e=0;if(e===true)e=1;this.loop=e;this.emitEvent(u.EVENT_CHANGE,this)}hasEnded(e){if(this.#needsSort)this.sortKeys();if(this.keys.length===0)return true;if(this.keys[this.keys.length-1].time<=e)return true;return false}hasStarted(e){if(this.#needsSort)this.sortKeys();if(this.keys.length===0)return false;if(e>=this.keys[0].time)return true;return false}isRising(e){if(this.#needsSort)this.sortKeys();if(this.hasEnded(e))return false;const t=this.getKeyIndex(e);if(this.keys[t].value<this.keys[t+1].value)return true;return false}clearBefore(e){if(this.#needsSort)this.sortKeys();const t=this.getValue(e);const i=this.getKeyIndex(e);this.setValue(e,t);if(i>1){this.keys.splice(0,i);this.#needsSort=true}}clear(e){if(this.#needsSort)this.sortKeys();let t=0;if(e)t=this.getValue(e);for(let e=0;e<this.keys.length;e++)this.emitEvent(u.EVENT_KEY_DELETE,this.keys[e]);this.keys.length=0;if(e)this.setValue(e,t);this.#needsSort=true;if(this.onChange!==null)this.onChange();this.emitEvent(u.EVENT_CHANGE,this)}checkIsSorted(){let t=true;for(let e=0;e<this.keys.length-1;e++)if(this.keys[e].time>this.keys[e+1].time){t=false;break}return t}sortKeys(){if(this.batchMode)return;if(!this.checkIsSorted()){this.keys.sort((e,t)=>{return e.time-t.time});this.#needsSort=false;if(this.keys.length>999&&this.keys.length%1e3==0)console.log(this.name,this.keys.length);this.emitEvent(u.EVENT_CHANGE)}}hasDuplicates(){const t={};let i=0;for(let e=0;e<this.keys.length;e++){t[this.keys[e].time]=1;i++}const e=Object.keys(t);if(e.length!=i){return true}return false}removeDuplicates(){if(this.hasDuplicates()){if(this.#needsSort)this.sortKeys();let t=0;while(this.hasDuplicates()){for(let e=0;e<this.keys.length-1;e++){if(this.keys[e].time==this.keys[e+1].time){const i=this.keys[e];this.keys.splice(e,1);this.emitEvent(u.EVENT_KEY_DELETE,i)}t++}}this.#needsSort=true}}getLengthLoop(){if(this.#needsSort)this.sortKeys();if(this.keys.length<2)return 0;return this.lastKey.time-this.firstKey.time}getLength(){if(this.#needsSort)this.sortKeys();if(this.keys.length===0)return 0;return this.lastKey.time}getKeyIndex(t){if(this.#needsSort)this.sortKeys();let i=0;let s=0;if(this._cachedIndex&&this.keys.length>this._cachedIndex&&t>=this.keys[this._cachedIndex].time)s=this._cachedIndex;for(let e=s;e<this.keys.length;e++){if(t>=this.keys[e].time)i=e;if(this.keys[e].time>t){if(t!=0)this._cachedIndex=i;return i}}return i}setValue(t,i,s=null){if(isNaN(i))CABLES.logStack();if(this.#needsSort)this.sortKeys();let r=null;if(!this.batchMode)if(this.keys.length==0||t<=this.lastKey.time)for(let e=0;e<this.keys.length;e++)if(this.keys[e].time==t){r=this.keys[e];this.keys[e].setValue(i);this.keys[e].cb=s;break}if(!r){r=new a.rA({time:t,value:i,e:this.defaultEasing,cb:s,anim:this});this.keys.push(r)}if(!this.batchMode){if(this.onChange)this.onChange();this.emitEvent(u.EVENT_CHANGE,this);this.#needsSort=true}return r}setKeyEasing(e,t){if(this.keys[e]){this.keys[e].setEasing(t);this.emitEvent(u.EVENT_CHANGE,this)}}deserialize(t,e,i){if(t.loop)this.loop=t.loop;if(t.tlActive)this.#tlActive=t.tlActive;if(t.height)this.uiAttribs.height=t.height;if(e){while(this.keys.length)this.keys[0].delete();this.keys.length=0}for(const s in t.keys){let e=new a.rA(t.keys[s],this);this.keys.push(e);if(i)if(t.keys[s].clipId){i[t.keys[s].clipId]=i[t.keys[s].clipId]||[];if(i)i[t.keys[s].clipId].push(e)}}this.sortKeys()}getSerialized(){const t={};t.keys=[];t.loop=this.loop;if(this.#tlActive)t.tlActive=this.tlActive;if(this.uiAttribs.height)t.height=this.uiAttribs.height;for(let e=0;e<this.keys.length;e++)t.keys.push(this.keys[e].getSerialized());return t}getKey(e){if(this.#needsSort)this.sortKeys();const t=this.getKeyIndex(e);return this.keys[t]}getNextKey(e){if(this.#needsSort)this.sortKeys();let t=this.getKeyIndex(e)+1;if(t>=this.keys.length)return null;return this.keys[t]}getPrevKey(e){if(this.#needsSort)this.sortKeys();let t=this.getKeyIndex(e)-1;if(t<0)return null;return this.keys[t]}isFinished(e){if(this.#needsSort)this.sortKeys();if(this.keys.length<=0)return true;return e>this.lastKey.time}isStarted(e){if(this.#needsSort)this.sortKeys();if(this.keys.length<=0)return false;return e>=this.firstKey.time}remove(t,i){for(let e=0;e<this.keys.length;e++){if(this.keys[e]==t){this.emitEvent(u.EVENT_KEY_DELETE,this.keys[e]);this.keys.splice(e,1);this.#needsSort=true;if(i===undefined){this.emitEvent(u.EVENT_CHANGE,this)}return}}}get lastKey(){if(this.#needsSort)this.sortKeys();return this.keys[this.keys.length-1]}get firstKey(){if(this.#needsSort)this.sortKeys();return this.keys[0]}getLoopIndex(e){if(this.#needsSort)this.sortKeys();if(this.keys.length<2)return 0;return(e-this.firstKey.time)/this.getLengthLoop()}getValue(e){let t=0;if(this.keys.length===0)return 0;if(this.#needsSort)this.sortKeys();if(!this.loop&&e>this.keys[this.keys.length-1].time){if(this.lastKey.cb&&!this.lastKey.cbTriggered)this.lastKey.trigger();return this.lastKey.value}if(e<this.firstKey.time)return this.keys[0].value;if(this.loop&&this.keys.length>1&&e>this.lastKey.time){const o=this.getLoopIndex(e);if(o>this._timesLooped){this._timesLooped++;if(this.onLooped)this.onLooped()}e=(e-this.firstKey.time)%this.getLengthLoop();if(this.loop==u.LOOP_REPEAT){}else if(this.loop==u.LOOP_MIRROR){if(Math.floor(o)%2==1)e=this.getLengthLoop()-e}else if(this.loop==u.LOOP_OFFSET){t=(this.lastKey.value-this.keys[0].value)*Math.floor(o)}e+=this.firstKey.time}const i=this.getKeyIndex(e);if(i>=this.keys.length-1){if(this.lastKey.cb&&!this.lastKey.cbTriggered)this.lastKey.trigger();return this.lastKey.value}const s=i+1;const r=this.keys[i];const n=this.keys[s];if(r.cb&&!r.cbTriggered)r.trigger();if(!n)return-1;const a=(e-r.time)/(n.time-r.time);if(r.getEasing()==u.EASING_CLIP){if(r.clip&&r.clip.getValue){return r.clip.getValue(a*r.clip.getLength())}else{if(this.port){const l=this.port.op.patch;const h=l.getVar(r.clipId)?.getValue();if(h)r.clip=h;if(r.clip)return r.clip.getValue(e)}console.log("no clip found")}}return r.ease(a,n)+t}addKey(e){if(e.time===undefined){this._log.warn("key time undefined, ignoring!")}else{this.keys.push(e);if(this.onChange!==null)this.onChange();this.emitEvent(u.EVENT_CHANGE,this);this.#needsSort=true}}sortSoon(){this.#needsSort=true}easingFromString(e){if(e=="linear")return u.EASING_LINEAR;if(e=="absolute")return u.EASING_ABSOLUTE;if(e=="smoothstep")return u.EASING_SMOOTHSTEP;if(e=="smootherstep")return u.EASING_SMOOTHERSTEP;if(e=="Cubic In")return u.EASING_CUBIC_IN;if(e=="Cubic Out")return u.EASING_CUBIC_OUT;if(e=="Cubic In Out")return u.EASING_CUBIC_INOUT;if(e=="Expo In")return u.EASING_EXPO_IN;if(e=="Expo Out")return u.EASING_EXPO_OUT;if(e=="Expo In Out")return u.EASING_EXPO_INOUT;if(e=="Sin In")return u.EASING_SIN_IN;if(e=="Sin Out")return u.EASING_SIN_OUT;if(e=="Sin In Out")return u.EASING_SIN_INOUT;if(e=="Back In")return u.EASING_BACK_IN;if(e=="Back Out")return u.EASING_BACK_OUT;if(e=="Back In Out")return u.EASING_BACK_INOUT;if(e=="Elastic In")return u.EASING_ELASTIC_IN;if(e=="Elastic Out")return u.EASING_ELASTIC_OUT;if(e=="Bounce In")return u.EASING_BOUNCE_IN;if(e=="Bounce Out")return u.EASING_BOUNCE_OUT;if(e=="Quart Out")return u.EASING_QUART_OUT;if(e=="Quart In")return u.EASING_QUART_IN;if(e=="Quart In Out")return u.EASING_QUART_INOUT;if(e=="Quint Out")return u.EASING_QUINT_OUT;if(e=="Quint In")return u.EASING_QUINT_IN;if(e=="Quint In Out")return u.EASING_QUINT_INOUT;console.log("unknown anim easing?",e)}createPort(e,t,i){const s=e.inDropDown(t,u.EASINGNAMES,"linear");s.set("linear");s.defaultValue=0;s.onChange=()=>{this.defaultEasing=this.easingFromString(s.get());this.emitEvent("onChangeDefaultEasing",this);if(i)i()};return s}get tlActive(){return this.#tlActive}set tlActive(e){if(CABLES.UI){this.#tlActive=e;window.gui.emitEvent("tlActiveChanged",this);this.forceChangeCallbackSoon()}}setUiAttribs(t){for(const e in t){this.uiAttribs[e]=t[e];if(t[e]===null)delete this.uiAttribs[e]}this.emitEvent(u.EVENT_UIATTRIB_CHANGE)}hasKeyframesBetween(t,i){for(let e=0;e<this.keys.length;e++)if(this.keys[e].time>=t&&this.keys[e].time<=i)return true;return false}static initClipsFromVars(i){for(const t in i.missingClipAnims){const s=i.getVar(t);for(let e=0;e<i.missingClipAnims[t].length;e++){i.missingClipAnims[t].clip=s.getValue();delete i.missingClipAnims[t]}}}}},963:(e,t,i)=>{"use strict";i.d(t,{rA:()=>l});var r=i(344);class l{anim=null;id=CABLES.simpleId();time=0;value=0;onChange=null;_easing=0;bezCp1=null;bezCp2=null;bezAn=null;cb=null;cbTriggered=false;temp={};uiAttribs={};clip=null;clipId=null;constructor(e,t){this.anim=e.anim||t||null;this.setEasing(r.k.EASING_LINEAR);this.set(e)}setClip(e,t){this.clipId=e;this.clip=t;if(this.anim)this.anim.emitEvent(r.k.EVENT_CHANGE)}emitChange(){if(this.anim.batchMode)return;if(!this.anim)return;this.bezAn=null;if(this.onChange!==null)this.onChange();this.anim.forceChangeCallbackSoon();for(let e=0;e<this.anim.keys.length;e++)this.anim.keys[e].bezAn=null}delete(){if(this.anim)this.anim.remove(this);else console.log("animkey without anim...")}setUiAttribs(t){for(const e in t){this.uiAttribs[e]=t[e];if(t[e]===null)delete this.uiAttribs[e]}if(this.anim)this.anim.emitEvent(r.k.EVENT_CHANGE)}setEasing(e){let t=false;if(this._easing!=e)t=true;this._easing=e;if(this._easing!=r.k.EASING_CLIP){this.clipId="";this.clip=null}if(this._easing==r.k.EASING_LINEAR)this.ease=this.easeLinear;else if(this._easing==r.k.EASING_ABSOLUTE)this.ease=this.easeAbsolute;else if(this._easing==r.k.EASING_SMOOTHSTEP)this.ease=l.easeSmoothStep;else if(this._easing==r.k.EASING_SMOOTHERSTEP)this.ease=l.easeSmootherStep;else if(this._easing==r.k.EASING_CUBIC_IN)this.ease=l.easeCubicIn;else if(this._easing==r.k.EASING_CUBIC_OUT)this.ease=l.easeCubicOut;else if(this._easing==r.k.EASING_CUBIC_INOUT)this.ease=l.easeCubicInOut;else if(this._easing==r.k.EASING_EXPO_IN)this.ease=l.easeExpoIn;else if(this._easing==r.k.EASING_EXPO_OUT)this.ease=l.easeExpoOut;else if(this._easing==r.k.EASING_EXPO_INOUT)this.ease=l.easeExpoInOut;else if(this._easing==r.k.EASING_SIN_IN)this.ease=l.easeSinIn;else if(this._easing==r.k.EASING_SIN_OUT)this.ease=l.easeSinOut;else if(this._easing==r.k.EASING_SIN_INOUT)this.ease=l.easeSinInOut;else if(this._easing==r.k.EASING_BACK_OUT)this.ease=l.easeOutBack;else if(this._easing==r.k.EASING_BACK_IN)this.ease=l.easeInBack;else if(this._easing==r.k.EASING_BACK_INOUT)this.ease=l.easeInOutBack;else if(this._easing==r.k.EASING_ELASTIC_IN)this.ease=l.easeInElastic;else if(this._easing==r.k.EASING_ELASTIC_OUT)this.ease=l.easeOutElastic;else if(this._easing==r.k.EASING_BOUNCE_IN)this.ease=l.easeInBounce;else if(this._easing==r.k.EASING_BOUNCE_OUT)this.ease=l.easeOutBounce;else if(this._easing==r.k.EASING_QUART_OUT)this.ease=l.easeOutQuart;else if(this._easing==r.k.EASING_QUART_IN)this.ease=l.easeInQuart;else if(this._easing==r.k.EASING_QUART_INOUT)this.ease=l.easeInOutQuart;else if(this._easing==r.k.EASING_QUINT_OUT)this.ease=l.easeOutQuint;else if(this._easing==r.k.EASING_QUINT_IN)this.ease=l.easeInQuint;else if(this._easing==r.k.EASING_QUINT_INOUT)this.ease=l.easeInOutQuint;else if(this._easing==r.k.EASING_CLIP)this.ease=this.easeAbsolute;else if(this._easing==r.k.EASING_CUBICSPLINE){if(this.ease!=this.easeCubicSpline){this.ease=this.easeCubicSpline;this.bezReset()}this.bezAn=null}else{this._easing=r.k.EASING_LINEAR;this.ease=this.easeLinear}if(t)this.emitChange()}bezReset(){let e=.5;const t=this.anim.getPrevKey(this.time);if(t)e=(this.time-t.time)/2;let i=.5;const s=this.anim.getNextKey(this.time);if(s)i=(s.time-this.time)/2;this.bezCp1=[-Math.min(e,i),0];this.bezCp2=[Math.min(e,i),0];this.emitChange()}trigger(){this.cb();this.cbTriggered=true}setValue(e){this.value=e;this.emitChange()}setBezCp1(e,t){this.bezCp1=[e,t];this.emitChange()}setBezCp2(e,t){this.bezCp2=[e,t];this.emitChange()}set(e){if(e){if(e.hasOwnProperty("e"))this.setEasing(e.e);if(e.cb){this.cb=e.cb;this.cbTriggered=false}if(e.hasOwnProperty("cp1")){this.bezCp1=e.cp1;this.bezCp2=e.cp2}if(e.hasOwnProperty("t"))this.time=e.t;if(e.hasOwnProperty("time"))this.time=e.time;if(e.hasOwnProperty("v"))this.value=e.v;else if(e.hasOwnProperty("value"))this.value=e.value;if(e.hasOwnProperty("uiAttribs"))this.setUiAttribs(e.uiAttribs);if(e.clipId)this.clipId=e.clipId}this.emitChange()}getSerialized(){const e={};e.t=this.time;e.v=this.value;e.e=this._easing;e.uiAttribs=this.uiAttribs;if(this.clipId)e.clipId=this.clipId;if(this._easing===r.k.EASING_CUBICSPLINE){e.cp1=this.bezCp1;e.cp2=this.bezCp2}return e}getEasing(){return this._easing}easeCubicSpline(e,t){if(!this.bezAn){const i=30;this.bezAn=new r.k;for(let e=0;e<=i+1;e++){const s=l.cubicSpline(e/i,this,t);this.bezAn.setValue(s[0],s[1])}}return this.bezAn.getValue(this.time+e*(t.time-this.time))}easeLinear(e,t){return l.linear(e,this,t)}easeAbsolute(){return this.value}}l.cubicSpline=function(e,t,i){const s=1-e;const r=s*s;const n=e*e;const a=r*s;const o=3*r*e;const l=3*s*n;const h=n*e;t.bezCp1=t.bezCp1||[-.5,0];t.bezCp2=t.bezCp2||[.5,0];i.bezCp1=i.bezCp1||[-.5,0];i.bezCp2=i.bezCp2||[.5,0];const u=Math.min(i.time,t.bezCp2[0]+t.time);const c=Math.max(t.time,i.bezCp1[0]+i.time);const f=a*t.time+o*u+l*c+h*i.time;const g=a*t.value+o*(t.bezCp2[1]+t.value)+l*(i.bezCp1[1]+i.value)+h*i.value;return[f,g]};l.linear=function(e,t,i){return t.value+(i.value-t.value)*e};const s=function(e){return e=2**(10*(e-1))};l.easeExpoIn=function(e,t){e=s(e);return l.linear(e,this,t)};const n=function(e){e=-(2**(-10*e))+1;return e};l.easeExpoOut=function(e,t){e=n(e);return l.linear(e,this,t)};const a=function(e){e*=2;if(e<1){e=.5*2**(10*(e-1))}else{e--;e=.5*(-(2**(-10*e))+2)}return e};l.easeExpoInOut=function(e,t){e=a(e);return l.linear(e,this,t)};l.easeSinIn=function(e,t){e=-1*Math.cos(e*Math.PI/2)+1;return l.linear(e,this,t)};l.easeSinOut=function(e,t){e=Math.sin(e*Math.PI/2);return l.linear(e,this,t)};l.easeSinInOut=function(e,t){e=-.5*(Math.cos(Math.PI*e)-1);return l.linear(e,this,t)};const o=function(e){e=e*e*e;return e};l.easeCubicIn=function(e,t){e=o(e);return l.linear(e,this,t)};l.easeInQuint=function(e,t){e=e*e*e*e*e;return l.linear(e,this,t)};l.easeOutQuint=function(e,t){e=(e-=1)*e*e*e*e+1;return l.linear(e,this,t)};l.easeInOutQuint=function(e,t){if((e/=.5)<1)e=.5*e*e*e*e*e;else e=.5*((e-=2)*e*e*e*e+2);return l.linear(e,this,t)};l.easeInQuart=function(e,t){e=e*e*e*e;return l.linear(e,this,t)};l.easeOutQuart=function(e,t){e=-1*((e-=1)*e*e*e-1);return l.linear(e,this,t)};l.easeInOutQuart=function(e,t){if((e/=.5)<1)e=.5*e*e*e*e;else e=-.5*((e-=2)*e*e*e-2);return l.linear(e,this,t)};l.bounce=function(e){if((e/=1)<1/2.75)e=7.5625*e*e;else if(e<2/2.75)e=7.5625*(e-=1.5/2.75)*e+.75;else if(e<2.5/2.75)e=7.5625*(e-=2.25/2.75)*e+.9375;else e=7.5625*(e-=2.625/2.75)*e+.984375;return e};l.easeInBounce=function(e,t){return l.linear(l.bounce(e),this,t)};l.easeOutBounce=function(e,t){return l.linear(l.bounce(e),this,t)};l.easeInElastic=function(e,t){let i=1.70158;let s=0;let r=1;const n=0;const a=1;const o=1;if(e===0)e=n;else if((e/=a)==1)e=n+o;else{if(!s)s=a*.3;if(r<Math.abs(o)){r=o;i=s/4}else i=s/(2*Math.PI)*Math.asin(o/r);e=-(r*2**(10*(e-=1))*Math.sin((e*a-i)*(2*Math.PI)/s))+n}return l.linear(e,this,t)};l.easeOutElastic=function(e,t){let i=1.70158;let s=0;let r=1;const n=0;const a=1;const o=1;if(e===0)e=n;else if((e/=a)==1)e=n+o;else{if(!s)s=a*.3;if(r<Math.abs(o)){r=o;i=s/4}else i=s/(2*Math.PI)*Math.asin(o/r);e=r*2**(-10*e)*Math.sin((e*a-i)*(2*Math.PI)/s)+o+n}return l.linear(e,this,t)};l.easeInBack=function(e,t){const i=1.70158;e=e*e*((i+1)*e-i);return l.linear(e,this,t)};l.easeOutBack=function(e,t){const i=1.70158;e=(e=e/1-1)*e*((i+1)*e+i)+1;return l.linear(e,this,t)};l.easeInOutBack=function(e,t){let i=1.70158;const s=1/2;if((e/=1/2)<1)e=s*(e*e*(((i*=1.525)+1)*e-i));else e=s*((e-=2)*e*(((i*=1.525)+1)*e+i)+2);return l.linear(e,this,t)};const h=function(e){e--;e=e*e*e+1;return e};l.easeCubicOut=function(e,t){e=h(e);return l.linear(e,this,t)};const u=function(e){e*=2;if(e<1)e=.5*e*e*e;else{e-=2;e=.5*(e*e*e+2)}return e};l.easeCubicInOut=function(e,t){e=u(e);return l.linear(e,this,t)};l.easeSmoothStep=function(e,t){const i=Math.max(0,Math.min(1,e));e=i*i*(3-2*i);return l.linear(e,this,t)};l.easeSmootherStep=function(e,t){const i=Math.max(0,Math.min(1,(e-0)/(1-0)));e=i*i*i*(i*(i*6-15)+10);return l.linear(e,this,t)}},440:(e,t,i)=>{"use strict";i.d(t,{a:()=>r});var s=i(344);const r={ANIM:{EASINGS:s.k.EASINGNAMES,EASING_LINEAR:0,EASING_ABSOLUTE:1,EASING_SMOOTHSTEP:2,EASING_SMOOTHERSTEP:3,EASING_CUBICSPLINE:4,EASING_CUBIC_IN:5,EASING_CUBIC_OUT:6,EASING_CUBIC_INOUT:7,EASING_EXPO_IN:8,EASING_EXPO_OUT:9,EASING_EXPO_INOUT:10,EASING_SIN_IN:11,EASING_SIN_OUT:12,EASING_SIN_INOUT:13,EASING_BACK_IN:14,EASING_BACK_OUT:15,EASING_BACK_INOUT:16,EASING_ELASTIC_IN:17,EASING_ELASTIC_OUT:18,EASING_BOUNCE_IN:19,EASING_BOUNCE_OUT:21,EASING_QUART_IN:22,EASING_QUART_OUT:23,EASING_QUART_INOUT:24,EASING_QUINT_IN:25,EASING_QUINT_OUT:26,EASING_QUINT_INOUT:27,EASING_CLIP:28},OP:{OP_PORT_TYPE_VALUE:0,OP_PORT_TYPE_NUMBER:0,OP_PORT_TYPE_FUNCTION:1,OP_PORT_TYPE_TRIGGER:1,OP_PORT_TYPE_OBJECT:2,OP_PORT_TYPE_TEXTURE:2,OP_PORT_TYPE_ARRAY:3,OP_PORT_TYPE_DYNAMIC:4,OP_PORT_TYPE_STRING:5,OP_VERSION_PREFIX:"_v"},PORT:{PORT_DIR_IN:0,PORT_DIR_OUT:1},PACO:{PACO_CLEAR:0,PACO_VALUECHANGE:1,PACO_OP_DELETE:2,PACO_UNLINK:3,PACO_LINK:4,PACO_LOAD:5,PACO_OP_CREATE:6,PACO_OP_ENABLE:7,PACO_OP_DISABLE:8,PACO_UIATTRIBS:9,PACO_VARIABLES:10,PACO_TRIGGERS:11,PACO_PORT_SETVARIABLE:12,PACO_PORT_SETANIMATED:13,PACO_PORT_ANIM_UPDATED:14,PACO_DESERIALIZE:15,PACO_OP_RELOAD:16}}},50:(e,t,i)=>{"use strict";i.d(t,{I:()=>l});var s=i(125);var r=i(849);var n=i(440);var a=i(562);var o=i(344);class l extends s.A{static DIR_IN=0;static DIR_OUT=1;static TYPE_VALUE=0;static TYPE_NUMBER=0;static TYPE_FUNCTION=1;static TYPE_TRIGGER=1;static TYPE_OBJECT=2;static TYPE_TEXTURE=2;static TYPE_ARRAY=3;static TYPE_DYNAMIC=4;static TYPE_STRING=5;static EVENT_UIATTRCHANGE="onUiAttrChange";static EVENT_VALUE_CHANGE="change";static EVENT_LINK_CHANGED="onLinkChanged";static EVENT_LINK_REMOVED="onLinkRemoved";#oldAnimVal=-5711;animMuted=false;lastAnimTime=0;#uiActiveState=true;#valueBeforeLink=null;#animated=false;#useVariableName=null;#op=null;constructor(e,t,i,s={}){super();this.data={};this._log=new r.A("core_port");this.direction=l.DIR_IN;this.id=String(CABLES.simpleId());this.#op=e;this.links=[];this.value=0;this.name=t;this.type=i||l.TYPE_VALUE;this.uiAttribs=s||{};this.anim=null;this.defaultValue=null;this.ignoreValueSerialize=false;this.onLinkChanged=null;this.crashed=false;this.onValueChanged=null;this.onTriggered=null;this.changeAlways=false;this.forceRefChange=false;this.activityCounter=0;this.apf=0;this.activityCounterStartFrame=0;this.canLink=null;this.preserveLinks=null;this.indexPort=null}get parent(){this._log.stack("use port.op, not .parent");return this.op}get title(){return this.uiAttribs.title||this.name}get op(){return this.#op}get val(){return this.get()}set val(e){this.setValue(e)}copyLinkedUiAttrib(e,t){if(!CABLES.UI)return;if(!this.isLinked())return;const i={};i[e]=this.links[0].getOtherPort(this).getUiAttrib(e);t.setUiAttribs(i)}getValueForDisplay(){let e=this.value;if(typeof this.value==="string"||this.value instanceof String){if(e.length>1e3){e=e.substring(0,999);e+="..."}if(this.uiAttribs&&this.uiAttribs.display=="boolnum"){e+=" - ";if(!this.value)e+="false";else e+="true"}e=e.replace(/[\u00A0-\u9999<>\&]/g,function(e){return"&#"+e.charCodeAt(0)+";"});if(e.length>100)e=e.substring(0,100)}else{e=String(this.value)}return e}onAnimToggle(){}_onAnimToggle(){this.onAnimToggle()}remove(){this.removeLinks();this.#op.removePort(this)}setUiAttribs(e){let t=false;if(!this.uiAttribs)this.uiAttribs={};for(const i in e){if(e[i]===undefined){delete this.uiAttribs[i];continue}if(this.uiAttribs[i]!=e[i])t=true;this.uiAttribs[i]=e[i];if(i=="group"&&this.indexPort)this.indexPort.setUiAttribs({group:e[i]})}if(e.hasOwnProperty("expose"))this.#op.patch.emitEvent("subpatchExpose",this.#op.uiAttribs.subPatch);if(t)this.emitEvent(l.EVENT_UIATTRCHANGE,e,this)}getUiAttribs(){return this.uiAttribs}getUiAttrib(e){if(!this.uiAttribs||!this.uiAttribs.hasOwnProperty(e))return null;return this.uiAttribs[e]}get(){if(CABLES.UI&&this.#animated&&this.lastAnimTime==this.#op.patch.timer.getTime()&&!CABLES.UI.keyframeAutoCreate){return this.value}if(!this.animMuted&&this.#animated&&this.lastAnimFrame!=this.#op.patch.getFrameNum()){this.lastAnimTime=this.#op.patch.timer.getTime();this.lastAnimFrame=this.#op.patch.getFrameNum();let e=this.anim.getValue(this.#op.patch.timer.getTime());if(this.value!=e){this.value=e;this.#oldAnimVal=this.value;this.forceChange()}}return this.value}setRef(e){this.forceRefChange=true;this.set(e)}set(e){this.setValue(e)}setValue(t){if(t===undefined)t=null;if(CABLES.UI&&CABLES.UI.showDevInfos)if(this.direction==n.a.PORT.PORT_DIR_OUT&&this.type==l.TYPE_OBJECT&&t&&!this.forceRefChange)this._log.warn("object port ["+this.name+"] uses .set ["+this.op.objName+"]");if(this.#op.enabled&&!this.crashed){if(t!==this.value||this.changeAlways||this.type==l.TYPE_TEXTURE||this.type==l.TYPE_ARRAY){if(CABLES.UI&&this.#animated){CABLES.UI.PREVISKEYVAL=null;if(!CABLES.UI.keyframeAutoCreate)CABLES.UI.PREVISKEYVAL=t}if(CABLES.UI&&this.#animated&&CABLES.UI.keyframeAutoCreate){let e=this.#op.patch.timer.getTime();if(CABLES.UI&&CABLES.Patch.getGui().glTimeline)CABLES.Patch.getGui().glTimeline.createKey(this.anim,e,t);else this.anim.setValue(e,t)}else{try{this.value=t;this.forceChange()}catch(e){this.crashed=true;this.setValue=function(e){};this.onTriggered=function(){};this._log.error("exception in ",this.#op);this._log.error(e);this.#op.patch.emitEvent("exception",e,this.#op)}if(this.#op&&this.#op.patch&&this.#op.patch.isEditorMode()&&this.type==l.TYPE_TEXTURE)CABLES.Patch.getGui().texturePreview().updateTexturePort(this)}if(this.direction==n.a.PORT.PORT_DIR_OUT)for(let e=0;e<this.links.length;++e)this.links[e].setValue()}}}updateAnim(){if(!this.#animated||this.animMuted)return;this.value=this.get();if(this.#oldAnimVal!=this.value||this.changeAlways){this.#oldAnimVal=this.value;this.forceChange()}this.#oldAnimVal=this.value}forceChange(){if(this.onValueChanged||this.onChange){}this._activity();this.emitEvent(l.EVENT_VALUE_CHANGE,this.value,this);if(this.onChange)this.onChange(this,this.value);else if(this.onValueChanged)this.onValueChanged(this,this.value)}getTypeString(){if(this.type==l.TYPE_VALUE)return"Number";if(this.type==l.TYPE_FUNCTION)return"Trigger";if(this.type==l.TYPE_OBJECT)return"Object";if(this.type==l.TYPE_DYNAMIC)return"Dynamic";if(this.type==l.TYPE_ARRAY)return"Array";if(this.type==l.TYPE_STRING)return"String";return"Unknown"}deSerializeSettings(e){if(!e)return;if(e.animated)this.setAnimated(e.animated);if(e.useVariable)this.setVariableName(e.useVariable);if(e.title)this.setUiAttribs({title:e.title});if(e.expose)this.setUiAttribs({expose:true});if(e.order)this.setUiAttribs({order:e.order});if(e.multiPortManual)this.setUiAttribs({multiPortManual:e.multiPortManual});if(e.multiPortNum)this.setUiAttribs({multiPortNum:e.multiPortNum});if(e.anim){if(!this.anim)this.anim=new o.k({name:"port "+this.name});this.#op.hasAnimPort=true;this.anim.port=this;this.anim.deserialize(e.anim,true,this.op.patch.clipAnims);this.#op.patch.emitEvent("portAnimUpdated",this.#op,this,this.anim);this.bindAnimListeners();this.anim.sortKeys()}}setInitialValue(e){if(this.op.preservedPortLinks[this.name]){for(let e=0;e<this.op.preservedPortLinks[this.name].length;e++){const t=this.op.preservedPortLinks[this.name][e];this.op.patch._addLink(t.objIn,t.objOut,t.portIn,t.portOut)}}if(this.op.preservedPortValues&&this.op.preservedPortValues.hasOwnProperty(this.name)&&this.op.preservedPortValues[this.name]!==undefined){this.set(this.op.preservedPortValues[this.name])}else if(e!==undefined)this.set(e);if(e!==undefined)this.defaultValue=e}getSerialized(){let t={name:this.getName()};if(!this.ignoreValueSerialize&&this.links.length===0){if(this.type==l.TYPE_OBJECT&&this.value&&this.value.tex){}else t.value=this.value}if(this.#useVariableName)t.useVariable=this.#useVariableName;if(this.#animated)t.animated=true;if(this.anim)t.anim=this.anim.getSerialized();if(this.uiAttribs.multiPortNum)t.multiPortNum=this.uiAttribs.multiPortNum;if(this.uiAttribs.multiPortManual)t.multiPortManual=this.uiAttribs.multiPortManual;if(this.uiAttribs.display=="file")t.display=this.uiAttribs.display;if(this.uiAttribs.expose){t.expose=true;if(this.uiAttribs.hasOwnProperty("order"))t.order=this.uiAttribs.order}if(this.uiAttribs.title)t.title=this.uiAttribs.title;if((this.preserveLinks||this.direction==n.a.PORT.PORT_DIR_OUT)&&this.links.length>0){t.links=[];for(const e in this.links){if(!this.links[e].ignoreInSerialize&&(this.links[e].portIn&&this.links[e].portOut))t.links.push(this.links[e].getSerialized())}}if(this.direction==l.DIR_IN&&this.links.length>0){for(const e in this.links){if(!this.links[e].portIn||!this.links[e].portOut)continue;const i=this.links[e].getOtherPort(this);if(i.op.isInBlueprint2&&this.op.isInBlueprint2){if(i.op.isInBlueprint2()&&!this.op.isInBlueprint2()){t.links=t.links||[];t.links.push(this.links[e].getSerialized())}}}}if(t.links&&t.links.length==0)delete t.links;if(this.type===l.TYPE_FUNCTION)delete t.value;if(this.type===l.TYPE_FUNCTION&&this.links.length==0)t=null;if(t&&Object.keys(t).length==1&&t.name)t=null;(0,a.cleanJson)(t);return t}shouldLink(e,t){return!!(e&&t)}removeLinks(){let e=0;while(this.links.length>0){e++;if(e>5e3){this._log.warn("could not delete links... / infinite loop");this.links.length=0;break}this.links[0].remove()}}removeLink(t){for(let e=0;e<this.links.length;e++)if(this.links[e]==t)this.links.splice(e,1);if(this.direction==l.DIR_IN){if(this.type==l.TYPE_VALUE)this.setValue(this.#valueBeforeLink||0);else this.setValue(this.#valueBeforeLink||null)}if(CABLES.UI&&this.#op.checkLinkTimeWarnings)this.#op.checkLinkTimeWarnings();try{if(this.onLinkChanged)this.onLinkChanged();this.emitEvent(l.EVENT_LINK_CHANGED);this.emitEvent(l.EVENT_LINK_REMOVED);this.#op.emitEvent(l.EVENT_LINK_CHANGED)}catch(e){this._log.error(e)}}getName(){return this.name}getTitle(){if(this.uiAttribs.title)return this.uiAttribs.title;return this.name}addLink(e){this.#valueBeforeLink=this.value;this.links.push(e);if(CABLES.UI&&this.#op.checkLinkTimeWarnings)this.#op.checkLinkTimeWarnings();try{if(this.onLinkChanged)this.onLinkChanged();this.emitEvent(l.EVENT_LINK_CHANGED);this.#op.emitEvent(l.EVENT_LINK_CHANGED)}catch(e){this._log.error(e)}}getLinkTo(t){for(const e in this.links)if(this.links[e].portIn==t||this.links[e].portOut==t)return this.links[e]}removeLinkTo(t){for(const e in this.links){if(this.links[e].portIn==t||this.links[e].portOut==t){this.links[e].remove();if(CABLES.UI&&this.#op.checkLinkTimeWarnings)this.#op.checkLinkTimeWarnings();if(this.onLinkChanged)this.onLinkChanged();this.emitEvent(l.EVENT_LINK_CHANGED);this.emitEvent(l.EVENT_LINK_REMOVED);return}}}isLinkedTo(t){for(const e in this.links)if(this.links[e].portIn==t||this.links[e].portOut==t)return true;return false}_activity(){this.activityCounter++}trigger(){const t=this.links.length;this._activity();if(t===0)return;if(!this.#op.enabled)return;let i=null;try{for(let e=0;e<t;++e){if(this.links[e].portIn){i=this.links[e].portIn;i.op.patch.pushTriggerStack(i);if(!i._onTriggered){console.log(i,i._onTriggered)}i._onTriggered();i.op.patch.popTriggerStack()}if(this.links[e])this.links[e].activity()}}catch(e){i.op.enabled=false;if(this.#op.patch.isEditorMode()){if(i.op.onError)i.op.onError(e)}this._log.error("exception in port: ",i.name,i.op.name,i.op.id);this._log.error(e)}}call(){this._log.warn("call deprecated - use trigger() ");this.trigger()}execute(){}setVariableName(e){this.#useVariableName=e;this.#op.patch.on("variableRename",(e,t)=>{if(e!=this.#useVariableName)return;this.#useVariableName=t})}getVariableName(){return this.#useVariableName}setVariable(e){this.setAnimated(false);const t={useVariable:false};if(this._variableIn&&this._varChangeListenerId){this._variableIn.off(this._varChangeListenerId);this._variableIn=null}if(e){this._variableIn=this.#op.patch.getVar(e);if(!this._variableIn){}else{if(this.type==l.TYPE_OBJECT){this._varChangeListenerId=this._variableIn.on("change",()=>{this.set(null);this.set(this._variableIn.getValue())})}else{this._varChangeListenerId=this._variableIn.on("change",this.set.bind(this))}this.set(this._variableIn.getValue())}this.#useVariableName=e;t.useVariable=true;t.variableName=this.#useVariableName}else{t.variableName=this.#useVariableName=null;t.useVariable=false}this.setUiAttribs(t);this.#op.patch.emitEvent("portSetVariable",this.#op,this,e)}_handleNoTriggerOpAnimUpdates(e){let t=false;if(!t){if(e)this._notriggerAnimUpdate=this.#op.patch.on("onRenderFrame",()=>{this.updateAnim()});else if(this._notriggerAnimUpdate)this._notriggerAnimUpdate=this.#op.patch.off(this._notriggerAnimUpdate)}}bindAnimListeners(){this.anim.on(o.k.EVENT_CHANGE,()=>{this.#op.patch.emitEvent("portAnimUpdated",this.#op,this,this.anim);this.#op.patch.updateAnimMaxTimeSoon()});this.anim.on(o.k.EVENT_KEY_DELETE,()=>{this.#op.patch.updateAnimMaxTimeSoon()})}setAnimated(e){let t=false;if(this.#animated!=e){this.#animated=e;this.#op.hasAnimPort=true;t=true}if(this.#animated&&!this.anim){this.anim=new o.k({name:"port "+this.name});this.bindAnimListeners()}if(this.#animated){let e=0;if(this.#op.patch.gui&&this.#op.patch.gui.glTimeline)e=this.#op.patch.timer.getTime();if(this.anim.keys.length==0)this.anim.setValue(e,this.value)}else{this.anim=null}this._handleNoTriggerOpAnimUpdates(e);this.#op.patch.emitEvent("portAnimToggle",this.#op,this,this.anim);this.setUiAttribs({isAnimated:this.#animated});if(t)this._onAnimToggle()}toggleAnim(){this.setAnimated(!this.#animated);this.setUiAttribs({isAnimated:this.#animated});this.#op.patch.emitEvent("portAnimUpdated",this.#op,this,this.anim);this.#op.patch.emitEvent("portAnimToggle",this.#op,this,this.anim)}getType(){return this.type}isLinked(){return this.links.length>0||this.#animated||this.#useVariableName!=null}isBoundToVar(){const e=this.#useVariableName!=null;this.uiAttribs.boundToVar=e;return e}isAnimated(){return this.#animated}isHidden(){return this.uiAttribs.hidePort}_onTriggered(){this._activity();this.#op.updateAnims();if(this.#op.enabled&&this.onTriggered)this.onTriggered();if(this.#op.enabled)this.emitEvent("trigger")}_onSetProfiling(e){if(this.op.patch.debuggerEnabled){const t=e;this.op.patch.emitEvent("debuggerstep",{opname:this.op.name,opid:this.op.id,portname:this.name,log:this.op.name+" - port "+this.name+": set value to "+e,exec:()=>{this.setValue(t)}});return}this.#op.patch.profiler.add("port",this);this.setValue(e);this.#op.patch.profiler.add("port",null)}_onTriggeredProfiling(){if(this.#op.enabled&&this.onTriggered){if(this.op.patch.debuggerEnabled){console.log();this.op.patch.emitEvent("debuggerstep",{opname:this.op.name,opid:this.op.id,portname:this.name,log:this.op.name+" - triggered "+this.name,exec:()=>{this.onTriggered()}});return}this.#op.patch.profiler.add("port",this);this.onTriggered();this.#op.patch.profiler.add("port",null)}}onValueChange(e){this.onChange=e}hidePort(){}static portTypeNumberToString(e){if(e==l.TYPE_VALUE)return"value";if(e==l.TYPE_FUNCTION)return"function";if(e==l.TYPE_OBJECT)return"object";if(e==l.TYPE_ARRAY)return"array";if(e==l.TYPE_STRING)return"string";if(e==l.TYPE_DYNAMIC)return"dynamic";return"unknown"}}},606:(U,e,t)=>{"use strict";t.r(e);t.d(e,{Anim:()=>m.k,AnimKey:()=>D.rA,CONSTANTS:()=>x.a,EMBED:()=>F,Link:()=>p,LoadingStatus:()=>T,Op:()=>N,Patch:()=>I,PatchVariable:()=>M,Port:()=>E.I,Profiler:()=>S,Timer:()=>A.M4,default:()=>y,now:()=>A.tB,utils:()=>v});var i={};t.r(i);t.d(i,{glMatrix:()=>s,mat2:()=>r,mat2d:()=>n,mat3:()=>a,mat4:()=>o,quat:()=>l,quat2:()=>h,vec2:()=>u,vec3:()=>c,vec4:()=>f});var s=t(823);var r=t(522);var n=t(964);var a=t(409);var o=t(684);var l=t(221);var h=t(991);var u=t(842);var c=t(329);var f=t(796);var g=t(125);var d=t(849);var v=t(562);var m=t(344);var E=t(50);class p extends g.A{constructor(e){super();this.id=CABLES.simpleId();this.portIn=null;this.portOut=null;this._patch=e;this.activityCounter=0;this.ignoreInSerialize=false}setValue(e){if(e===undefined)this._setValue();else this.portIn.set(e)}activity(){this.activityCounter++}_setValue(){if(!this.portOut){this.remove();return}const e=this.portOut.get();if(e==e){if(this.portIn.type!=E.I.TYPE_FUNCTION)this.activity();if(this.portIn.get()!==e){this.portIn.set(e)}else{if(this.portIn.changeAlways)this.portIn.set(e);if(this.portOut.forceRefChange)this.portIn.forceChange()}}}getOtherPort(e){if(e==this.portIn)return this.portOut;return this.portIn}remove(){if(this.portIn)this.portIn.removeLink(this);if(this.portOut)this.portOut.removeLink(this);if(this._patch){this._patch.emitEvent("onUnLink",this.portIn,this.portOut,this)}if(this.portIn&&(this.portIn.type==E.I.TYPE_OBJECT||this.portIn.type==E.I.TYPE_ARRAY)){this.portIn.set(null);if(this.portIn.links.length>0)this.portIn.set(this.portIn.links[0].getOtherPort(this.portIn).get())}if(this.portIn)this.portIn.op._checkLinksNeededToWork();if(this.portOut)this.portOut.op._checkLinksNeededToWork();this.portIn=null;this.portOut=null;this._patch=null}link(e,t){if(!p.canLink(e,t)){console.warn("[core_link] cannot link ports!",e,t);return false}if(e.direction==E.I.DIR_IN){this.portIn=e;this.portOut=t}else{this.portIn=t;this.portOut=e}e.addLink(this);t.addLink(this);this.setValue();e.op._checkLinksNeededToWork();t.op._checkLinksNeededToWork()}getSerialized(){const e={};e.portIn=this.portIn.getName();e.portOut=this.portOut.getName();e.objIn=this.portIn.op.id;e.objOut=this.portOut.op.id;return e}static canLinkText(e,t){if(e.direction==t.direction){let e="(out)";if(t.direction==E.I.DIR_IN)e="(in)";return"can not link: same direction "+e}if(e.op==t.op)return"can not link: same op";if(e.type!=E.I.TYPE_DYNAMIC&&t.type!=E.I.TYPE_DYNAMIC){if(e.type!=t.type)return"can not link: different type"}if(CABLES.UI&&e.type==E.I.TYPE_OBJECT&&t.type==E.I.TYPE_OBJECT){if(e.uiAttribs.objType&&t.uiAttribs.objType)if(e.uiAttribs.objType!=t.uiAttribs.objType)return"incompatible objects"}if(!e)return"can not link: port 1 invalid";if(!t)return"can not link: port 2 invalid";if(e.direction==E.I.DIR_IN&&e.isAnimated())return"can not link: is animated";if(t.direction==E.I.DIR_IN&&t.isAnimated())return"can not link: is animated";if(e.isLinkedTo(t))return"ports already linked";if(e.canLink&&!e.canLink(t)||t.canLink&&!t.canLink(e))return"Incompatible";return"can link"}static canLink(e,t){if(!e)return false;if(!t)return false;if(e.direction==E.I.DIR_IN&&e.isAnimated())return false;if(t.direction==E.I.DIR_IN&&t.isAnimated())return false;if(e.isHidden()||t.isHidden())return false;if(e.isLinkedTo(t))return false;if(e.direction==t.direction)return false;if(CABLES.UI&&e.type==E.I.TYPE_OBJECT&&t.type==E.I.TYPE_OBJECT){if(e.uiAttribs.objType&&t.uiAttribs.objType){if(e.uiAttribs.objType.indexOf("sg_")==0&&t.uiAttribs.objType.indexOf("sg_")==0)return true;if(e.uiAttribs.objType!=t.uiAttribs.objType)return false}}if(e.type!=t.type&&(e.type!=E.I.TYPE_DYNAMIC&&t.type!=E.I.TYPE_DYNAMIC))return false;if(e.type==E.I.TYPE_DYNAMIC||t.type==E.I.TYPE_DYNAMIC)return true;if(e.op==t.op)return false;if(e.canLink&&!e.canLink(t))return false;if(t.canLink&&!t.canLink(e))return false;return true}}var _=t(772);var b=t(308);var x=t(440);class T extends g.A{constructor(e){super();this._log=new d.A("LoadingStatus");this._loadingAssets={};this._cbFinished=[];this._assetTasks=[];this._percent=0;this._count=0;this._countFinished=0;this._order=0;this._startTime=0;this._patch=e;this._wasFinishedPrinted=false;this._loadingAssetTaskCb=false}setOnFinishedLoading(e){this._cbFinished.push(e)}getNumAssets(){return this._countFinished}getProgress(){return this._percent}checkStatus(){this._countFinished=0;this._count=0;for(const e in this._loadingAssets){this._count++;if(!this._loadingAssets[e].finished){this._countFinished++}}this._percent=(this._count-this._countFinished)/this._count;if(this._countFinished===0){for(let e=0;e<this._cbFinished.length;e++){if(this._cbFinished[e]){const t=this._cbFinished[e];setTimeout(()=>{t(this._patch);this.emitEvent("finishedAll")},100)}}if(!this._wasFinishedPrinted){this._wasFinishedPrinted=true;this.print()}this.emitEvent("finishedAll")}}getList(){let t=[];for(const e in this._loadingAssets){t.push(this._loadingAssets[e])}return t}getListJobs(){let t=[];for(const e in this._loadingAssets){if(!this._loadingAssets[e].finished)t.push(this._loadingAssets[e].name)}return t}print(){if(this._patch.config.silent)return;const t=[];for(const e in this._loadingAssets){t.push([this._loadingAssets[e].order,this._loadingAssets[e].type,this._loadingAssets[e].name,(this._loadingAssets[e].timeEnd-this._loadingAssets[e].timeStart)/1e3+"s"])}this._log.groupCollapsed("finished loading "+this._order+" assets in "+(Date.now()-this._startTime)/1e3+"s");this._log.table(t);this._log.groupEnd()}finished(e){const t=this._loadingAssets[e];if(t){if(t.finished)this._log.warn("loading job was already finished",t);if(t.op)t.op.setUiAttribs({loading:false});t.finished=true;t.timeEnd=Date.now()}this.checkStatus();this.emitEvent("finishedTask");return null}_startAssetTasks(){for(let e=0;e<this._assetTasks.length;e++)this._assetTasks[e]();this._assetTasks.length=0}addAssetLoadingTask(e){if(this._patch.isEditorMode()&&!CABLES.UI.loaded){this._assetTasks.push(e);if(!this._loadingAssetTaskCb)window.gui.addEventListener("uiloaded",this._startAssetTasks.bind(this));this._loadingAssetTaskCb=true}else{e()}this.emitEvent("addAssetTask")}existByName(t){for(let e in this._loadingAssets){if(this._loadingAssets[e].name==t&&!this._loadingAssets[e].finished)return true}}start(e,t,i){if(this._startTime==0)this._startTime=Date.now();const s=(0,v.generateUUID)();t=t||"unknown";if(t.length>100)t=t.substring(0,100);if(i)i.setUiAttrib({loading:true});this._loadingAssets[s]={id:s,op:i,type:e,name:t,finished:false,timeStart:Date.now(),order:this._order};this._order++;this.emitEvent("startTask");return s}}var A=t(920);class S{constructor(e){this.startFrame=e.getFrameNum();this.items={};this.currentId=null;this.currentStart=0;this._patch=e}getItems(){return this.items}clear(){this.currentStart=performance.now();if(this.paused)return;this.items={}}togglePause(){this.paused=!this.paused;if(!this.paused){this.items={};this.currentStart=performance.now()}}add(e,t){if(this.paused)return;if(this.currentId!==null){if(!t||t.id!=this.currentId){const i=this.items[this.currentId];if(i){i.timeUsed+=performance.now()-this.currentStart;i._timePsCount++;i._timePsMs+=performance.now()-this.currentStart;if(i._timePsStart==0||performance.now()>i._timePsStart+1e3){i.timePsMs=i._timePsMs;i.timePsMsAvg=i._timePsMs/i._timePsCount;i.timePsCount=i._timePsCount;i._timePsCount=0;i._timePsMs=0;i._timePsStart=performance.now()}if(!i.peakTime||(0,A.tB)()-i.peakTime>5e3){i.peak=0;i.peakTime=(0,A.tB)()}i.peak=Math.max(i.peak,performance.now()-this.currentStart)}}}if(t!==null){if(!this.items[t.id]){this.items[t.id]={numTriggers:0,timeUsed:0,timeUsedFrame:0,timePsMsAvg:0,timePsMs:0,_timePsCount:0,_timePsMs:0,_timePsStart:performance.now()}}if(this.items[t.id].lastFrame!=this._patch.getFrameNum())this.items[t.id].numTriggers=0;this.items[t.id].lastFrame=this._patch.getFrameNum();this.items[t.id].numTriggers++;this.items[t.id].opid=t.op.id;this.items[t.id].title=t.op.name+"."+t.name;this.items[t.id].subPatch=t.op.uiAttribs.subPatch;this.currentId=t.id;this.currentStart=performance.now()}else{this.currentId=null}}print(){console.log("--------");for(const e in this.items){console.log(this.items[e].title+": "+this.items[e].numTriggers+" / "+this.items[e].timeUsed)}}}class M extends g.A{#name;constructor(e,t,i){super();this.#name=e;this.type=i;this.setValue(t)}addListener(e){this.on("change",e,"var")}getValue(){return this._v}get name(){return this.#name}getName(){return this.#name}setValue(e){this._v=e;this.emitEvent("change",e,this)}}class I extends g.A{static EVENT_OP_DELETED="onOpDelete";static EVENT_OP_ADDED="onOpAdd";static EVENT_PAUSE="pause";static EVENT_RESUME="resume";static EVENT_PATCHLOADEND="patchLoadEnd";static EVENT_VARIABLES_CHANGED="variablesChanged";static EVENT_RENDER_FRAME="onRenderFrame";static EVENT_RENDERED_ONE_FRAME="renderedOneFrame";static EVENT_LINK="onLink";static EVENT_VALUESSET="loadedValueSet";static EVENT_ANIM_MAXTIME_CHANGE="animmaxtimechange";#renderOneFrame=false;#initialDeserialize=true;ops=[];settings={};animMaxTime=0;missingClipAnims={};constructor(e){super();this._log=new d.A("core_patch",{onError:e.onError});this.config=e||{glCanvasResizeToWindow:false,prefixAssetPath:"",prefixJsPath:"",silent:true,onError:null,onFinishedLoading:null,onFirstFrameRendered:null,onPatchLoaded:null,fpsLimit:0};this.timer=new A.M4;this.freeTimer=new A.M4;this.animFrameOps=[];this.animFrameCallbacks=[];this.gui=false;CABLES.logSilent=this.silent=true;this.profiler=null;this.aborted=false;this._crashedOps=[];this._animReq=null;this._opIdCache={};this._triggerStack=[];this.storeObjNames=false;this.loading=new T(this);this._volumeListeners=[];this._paused=false;this._frameNum=0;this.onOneFrameRendered=null;this.namedTriggers={};this._origData=null;this._frameNext=0;this._frameInterval=0;this._lastFrameTime=0;this._frameWasdelayed=true;this.tempData=this.frameStore={};this.reqAnimTimeStamp=0;this.cgCanvas=null;if(!function(){return!this}())console.log("not in strict mode: core patch");if(this.config.hasOwnProperty("silent"))this.silent=CABLES.logSilent=this.config.silent;if(!this.config.hasOwnProperty("doRequestAnimation"))this.config.doRequestAnimation=true;if(!this.config.prefixAssetPath)this.config.prefixAssetPath="";if(!this.config.prefixJsPath)this.config.prefixJsPath="";if(!this.config.masterVolume)this.config.masterVolume=1;this._variables={};this.vars={};if(e&&e.vars)this.vars=e.vars;this.cgl=new _.Rq.Context(this);this.cgp=null;this._subpatchOpCache={};this.cgl.setCanvas(this.config.glCanvasId||this.config.glCanvas||"glcanvas");if(this.config.glCanvasResizeToWindow===true)this.cgl.setAutoResize("window");if(this.config.glCanvasResizeToParent===true)this.cgl.setAutoResize("parent");this.loading.setOnFinishedLoading(this.config.onFinishedLoading);if(this.cgl.aborted)this.aborted=true;if(this.cgl.silent)this.silent=true;if(!CABLES.OPS){this.aborted=true;throw new Error("no CABLES.OPS found")}this.freeTimer.play();this.exec();if(!this.aborted){if(this.config.patch){this.deSerialize(this.config.patch)}else if(this.config.patchFile){(0,v.ajax)(this.config.patchFile,(e,t)=>{try{const i=JSON.parse(t);if(e){const s="";this._log.error("err",e);this._log.error("data",i);this._log.error("data",i.msg);return}this.deSerialize(i)}catch(e){this._log.error("could not load/parse patch ",e)}})}this.timer.play()}console.log("made with https://cables.gl");this.cg=undefined}static getGui(){return window.gui}isPlaying(){return!this._paused}renderOneFrame(){this._paused=true;this._renderOneFrame=true;this.exec();this._renderOneFrame=false}isEditorMode(){return this.config.editorMode===true}pause(){cancelAnimationFrame(this._animReq);this.emitEvent(I.EVENT_PAUSE);this._animReq=null;this._paused=true;this.freeTimer.pause()}resume(){if(this._paused){cancelAnimationFrame(this._animReq);this._paused=false;this.freeTimer.play();this.emitEvent(I.EVENT_RESUME);this.exec()}}setVolume(t){this.config.masterVolume=t;for(let e=0;e<this._volumeListeners.length;e++)this._volumeListeners[e].onMasterVolumeChanged(t)}getAssetPath(t=null){if(this.config.hasOwnProperty("assetPath")){return this.config.assetPath}else if(this.isEditorMode()){let e=t||I.getGui().project()._id;return"/assets/"+e+"/"}else if(document.location.href.indexOf("cables.gl")>0||document.location.href.indexOf("cables.local")>0){const i=document.location.pathname.split("/");let e=t||i[i.length-1];return"/assets/"+e+"/"}else{return"assets/"}}getJsPath(){if(this.config.hasOwnProperty("jsPath")){return this.config.jsPath}else{return"js/"}}getFilePath(e){if(!e)return e;e=String(e);if(e.indexOf("https:")===0||e.indexOf("http:")===0)return e;if(e.indexOf("data:")===0)return e;if(e.indexOf("file:")===0)return e;e=e.replace("//","/");if(e.startsWith(this.config.prefixAssetPath))e=e.replace(this.config.prefixAssetPath,"");return this.config.prefixAssetPath+e+(this.config.suffixAssetPath||"")}clear(){this.emitEvent("patchClearStart");this.cgl.TextureEffectMesh=null;this.animFrameOps.length=0;this.timer=new A.M4;while(this.ops.length>0)this.deleteOp(this.ops[0].id);this._opIdCache={};this.emitEvent("patchClearEnd")}createOp(e,t,i=null){let s=null;let r="";try{if(!e){console.error("createop identifier false",e);console.log((new Error).stack);return}if(e.indexOf("Ops.")===-1){const n=e;if(CABLES.OPS[n]){r=CABLES.OPS[n].objName;s=new CABLES.OPS[n].f(this,r,t,n);s.opId=n}else{if(i){e=i;this._log.warn("could not find op by id: "+n)}else{throw new Error("could not find op by id: "+n,{cause:"opId:"+n})}}}if(!s){r=e;const a=e.split(".");const o=I.getOpClass(r);if(!o){this.emitEvent("criticalError",{title:"Unknown op: "+r,text:"Unknown op: "+r});this._log.error("unknown op: "+r);throw new Error("unknown op: "+r)}else{if(a.length==2)s=new window[a[0]][a[1]](this,r,t);else if(a.length==3)s=new window[a[0]][a[1]][a[2]](this,r,t);else if(a.length==4)s=new window[a[0]][a[1]][a[2]][a[3]](this,r,t);else if(a.length==5)s=new window[a[0]][a[1]][a[2]][a[3]][a[4]](this,r,t);else if(a.length==6)s=new window[a[0]][a[1]][a[2]][a[3]][a[4]][a[5]](this,r,t);else if(a.length==7)s=new window[a[0]][a[1]][a[2]][a[3]][a[4]][a[5]][a[6]](this,r,t);else if(a.length==8)s=new window[a[0]][a[1]][a[2]][a[3]][a[4]][a[5]][a[6]][a[7]](this,r,t);else if(a.length==9)s=new window[a[0]][a[1]][a[2]][a[3]][a[4]][a[5]][a[6]][a[7]][a[8]](this,r,t);else if(a.length==10)s=new window[a[0]][a[1]][a[2]][a[3]][a[4]][a[5]][a[6]][a[7]][a[8]][a[9]](this,r,t);else console.log("parts.length",a.length)}if(s){s.opId=null;for(const e in CABLES.OPS){if(CABLES.OPS[e].objName==r)s.opId=e}}}}catch(e){this._crashedOps.push(r);this._log.error("[instancing error] "+r,e);if(!this.isEditorMode()){this._log.error("INSTANCE_ERR","Instancing Error: "+r,e)}else{if(this.#initialDeserialize)I.getGui().patchView.store.opCrashed=true}}if(s){s._objName=r;s.patch=this}else{this._log.log("no op was created!?",e,t)}return s}addOp(e,t,i,s=false,r=null){const n=this.createOp(e,i,r);if(n){t=t||{};if(t.hasOwnProperty("errors"))delete t.errors;if(t.hasOwnProperty("error"))delete t.error;t.subPatch=t.subPatch||0;n.setUiAttribs(t);if(n.onCreate)n.onCreate();if(n.hasOwnProperty("onAnimFrame"))this.addOnAnimFrame(n);if(n.hasOwnProperty("onMasterVolumeChanged"))this._volumeListeners.push(n);if(this._opIdCache[n.id]){this._log.warn("opid with id "+n.id+" already exists in patch!");this.deleteOp(n.id)}this.ops.push(n);this._opIdCache[n.id]=n;if(this._subPatchCacheAdd)this._subPatchCacheAdd(t.subPatch,n);this.emitEvent(I.EVENT_OP_ADDED,n,s);if(n.init)n.init();n.emitEvent(N.EVENT_INIT,s)}else{this._log.error("addop: op could not be created: ",e)}return n}addOnAnimFrame(t){for(let e=0;e<this.animFrameOps.length;e++)if(this.animFrameOps[e]==t){return}this.animFrameOps.push(t)}removeOnAnimFrame(t){for(let e=0;e<this.animFrameOps.length;e++){if(this.animFrameOps[e]==t){this.animFrameOps.splice(e,1);return}}}addOnAnimFrameCallback(e){this.animFrameCallbacks.push(e)}removeOnAnimCallback(t){for(let e=0;e<this.animFrameCallbacks.length;e++){if(this.animFrameCallbacks[e]==t){this.animFrameCallbacks.splice(e,1);return}}}updateAnimMaxTimeSoon(){if(this.toAnimMaxTime)clearTimeout(this.toAnimMaxTime);this.toAnimMaxTime=setTimeout(()=>{this.updateAnimMaxTime()},50)}updateAnimMaxTime(){let i=0;for(let t=0;t<this.ops.length;t++){if(this.ops[t].hasAnimPort){for(let e=0;e<this.ops[t].portsIn.length;e++){if(this.ops[t].portsIn[e].anim){if(this.ops[t].portsIn[e].anim.lastKey&&this.ops[t].portsIn[e].anim.lastKey.time>i){i=this.ops[t].portsIn[e].anim.lastKey.time}}}}}if(i!=this.animMaxTime){this.animMaxTime=i;this.emitEvent(I.EVENT_ANIM_MAXTIME_CHANGE)}}deleteOp(s,r,n){let a=false;for(let i=0;i<this.ops.length;i++){if(this.ops[i].id==s){const o=this.ops[i];let e=null;let t=null;if(o){a=true;if(r){if(o.portsIn.length>0&&o.portsIn[0].isLinked()&&(o.portsOut.length>0&&o.portsOut[0].isLinked())){if(o.portsIn[0].getType()==o.portsOut[0].getType()&&o.portsIn[0].links[0]){e=o.portsIn[0].links[0].getOtherPort(o.portsIn[0]);t=o.portsOut[0].links[0].getOtherPort(o.portsOut[0])}}}const l=this.ops[i];l.removeLinks();this.ops.splice(i,1);l.emitEvent("delete",l);this.emitEvent(I.EVENT_OP_DELETED,l,n);if(this.clearSubPatchCache)this.clearSubPatchCache(l.uiAttribs.subPatch);if(l.onDelete)l.onDelete(n);l.cleanUp();if(e!==null&&t!==null){this.link(e.op,e.getName(),t.op,t.getName())}delete this._opIdCache[s];break}}}if(!a)this._log.warn("core patch deleteop: not found...",s)}getFrameNum(){return this._frameNum}emitOnAnimFrameEvent(t,i){t=t||this.timer.getTime();for(let e=0;e<this.animFrameCallbacks.length;++e)if(this.animFrameCallbacks[e])this.animFrameCallbacks[e](t,this._frameNum,i);for(let e=0;e<this.animFrameOps.length;++e)if(this.animFrameOps[e].onAnimFrame)this.animFrameOps[e].onAnimFrame(t,this._frameNum,i)}renderFrame(e){this.timer.update(this.reqAnimTimeStamp);this.freeTimer.update(this.reqAnimTimeStamp);const t=this.timer.getTime();const i=performance.now();this.cgl.frameStartTime=this.timer.getTime();const s=e-this.reqAnimTimeStamp||e;this.emitOnAnimFrameEvent(null,s);this.cgl.profileData.profileFrameDelta=s;this.reqAnimTimeStamp=e;this.cgl.profileData.profileOnAnimFrameOps=performance.now()-i;this.emitEvent(I.EVENT_RENDER_FRAME,t);this._frameNum++;if(this._frameNum==1){if(this.config.onFirstFrameRendered)this.config.onFirstFrameRendered()}}exec(e){if(!this.#renderOneFrame&&(this._paused||this.aborted))return;this.emitEvent("reqAnimFrame");cancelAnimationFrame(this._animReq);this.config.fpsLimit=this.config.fpsLimit||0;if(this.config.fpsLimit){this._frameInterval=1e3/this.config.fpsLimit}const t=CABLES.now();const i=t-this._frameNext;if(this.isEditorMode()){if(!this.#renderOneFrame){if(t-this._lastFrameTime>=500&&this._lastFrameTime!==0&&!this._frameWasdelayed){this._lastFrameTime=0;setTimeout(this.exec.bind(this),500);this.emitEvent("renderDelayStart");this._frameWasdelayed=true;return}}}if(this.#renderOneFrame||this.config.fpsLimit===0||i>this._frameInterval||this._frameWasdelayed){this.renderFrame(e);if(this._frameInterval)this._frameNext=t-i%this._frameInterval}if(this._frameWasdelayed){this.emitEvent("renderDelayEnd");this._frameWasdelayed=false}if(this.#renderOneFrame){if(this.onOneFrameRendered)this.onOneFrameRendered();this.emitEvent(I.EVENT_RENDERED_ONE_FRAME);this._renderOneFrame=false}if(this.config.doRequestAnimation)this._animReq=this.cgl.canvas.ownerDocument.defaultView.requestAnimationFrame(this.exec.bind(this))}link(e,t,i,s,r=false,n=false){if(!e)return this._log.warn("link: op1 is null ");if(!i)return this._log.warn("link: op2 is null");const a=e.getPort(t,r);const o=i.getPort(s,r);if(!a)return this._log.warn("port1 not found! "+t+" ("+e.objName+")");if(!o)return this._log.warn("port2 not found! "+s+" of "+i.name+"("+i.objName+")",i);if(!a.shouldLink(a,o)||!o.shouldLink(a,o))return false;if(p.canLink(a,o)){const l=new p(this);l.link(a,o);this.emitEvent(I.EVENT_LINK,a,o,l,n);return l}}serialize(e){const t={};e=e||{};t.ops=[];t.settings=this.settings;for(let e=0;e<this.ops.length;e++){const i=this.ops[e];if(i&&i.getSerialized)t.ops.push(i.getSerialized())}(0,v.cleanJson)(t);if(e.asObject)return t;return JSON.stringify(t)}getOpsByRefId(t){const e=I.getGui().uiProfiler.start("[corepatchetend] getOpsByRefId");const i=[];for(let e=0;e<this.ops.length;e++)if(this.ops[e].storage&&this.ops[e].storage.ref==t)i.push(this.ops[e]);e.finish();return i}getOpById(e){return this._opIdCache[e]}getOpsByObjName(t){const i=[];for(let e=0;e<this.ops.length;e++)if(this.ops[e].objName==t)i.push(this.ops[e]);return i}getOpsByOpId(t){const i=[];for(let e=0;e<this.ops.length;e++)if(this.ops[e].opId==t)i.push(this.ops[e]);return i}getSubPatchOpsByName(t,i){const s=[];for(let e=0;e<this.ops.length;e++)if(this.ops[e].uiAttribs&&this.ops[e].uiAttribs.subPatch==t&&this.ops[e].objName==i)s.push(this.ops[e]);return s}getSubPatchOp(e,t){return this.getFirstSubPatchOpByName(e,t)}getFirstSubPatchOpByName(t,i){for(let e=0;e<this.ops.length;e++)if(this.ops[e].uiAttribs&&this.ops[e].uiAttribs.subPatch==t&&this.ops[e].objName==i)return this.ops[e];return null}_addLink(e,t,i,s){return this.link(this.getOpById(e),i,this.getOpById(t),s,false,true)}logStartup(e){if(window.logStartup)window.logStartup(e)}deSerialize(a,e={genIds:false,createRef:false}){if(this.aborted)return;const s=[];const t=this.loading.start("core","deserialize");if(typeof a==="string")a=JSON.parse(a);if(this.#initialDeserialize){this.namespace=a.namespace||"";this.name=a.name||"";this.settings=a.settings}this.emitEvent("patchLoadStart");a.ops=a.ops||[];this.logStartup("add "+a.ops.length+" ops... ");const r=[];for(let i=0;i<a.ops.length;i++){const n=CABLES.now();const o=a.ops[i];let t=null;try{if(o.opId)t=this.addOp(o.opId,o.uiAttribs,o.id,true,o.objName);else t=this.addOp(o.objName,o.uiAttribs,o.id,true)}catch(e){this._log.error("[instancing error] op data:",o,e)}if(t){r.push(t);if(e.genIds)t.id=(0,v.shortId)();t.portsInData=o.portsIn;t._origData=JSON.parse(JSON.stringify(o));t.storage=o.storage;if(o.portsIn)for(let e=0;e<o.portsIn.length;e++){const h=o.portsIn[e];if(h&&h.hasOwnProperty("name")){const u=t.getPort(h.name);if(u&&(u.uiAttribs.display=="bool"||u.uiAttribs.type=="bool")&&!isNaN(h.value))h.value=h.value==true?1:0;if(u&&h.value!==undefined&&u.type!=E.I.TYPE_TEXTURE)u.set(h.value);if(u){u.deSerializeSettings(h)}else{t.preservedPortValues=t.preservedPortValues||{};t.preservedPortValues[h.name]=h.value}}}if(o.portsOut)for(let e=0;e<o.portsOut.length;e++){const h=o.portsOut[e];if(h&&h.hasOwnProperty("name")){const c=t.getPort(h.name);if(c){c.deSerializeSettings(h);if(c.uiAttribs.hasOwnProperty("title")){t.preservedPortTitles=t.preservedPortTitles||{};t.preservedPortTitles[c.name]=c.uiAttribs.title}if(c.type!=E.I.TYPE_TEXTURE&&h.hasOwnProperty("value"))c.set(a.ops[i].portsOut[e].value);if(h.expose)c.setUiAttribs({expose:true})}}}s.push(t)}const l=Math.round(100*(CABLES.now()-n))/100;if(!this.silent&&l>5)console.log("long op init ",a.ops[i].objName,l)}this.logStartup("add ops done");for(let e=0;e<this.ops.length;e++){if(this.ops[e].onLoadedValueSet){this.ops[e].onLoadedValueSet(this.ops[e]._origData);this.ops[e].onLoadedValueSet=null;this.ops[e]._origData=null}this.ops[e].emitEvent(I.EVENT_VALUESSET)}this.logStartup("creating links");if(e.opsCreated)e.opsCreated(r);if(a.ops){for(let n=0;n<a.ops.length;n++){if(a.ops[n].portsIn){for(let t=0;t<a.ops[n].portsIn.length;t++){if(a.ops[n].portsIn[t]&&a.ops[n].portsIn[t].links){for(let e=0;e<a.ops[n].portsIn[t].links.length;e++){this._addLink(a.ops[n].portsIn[t].links[e].objIn,a.ops[n].portsIn[t].links[e].objOut,a.ops[n].portsIn[t].links[e].portIn,a.ops[n].portsIn[t].links[e].portOut)}}}}if(a.ops[n].portsOut)for(let r=0;r<a.ops[n].portsOut.length;r++)if(a.ops[n].portsOut[r]&&a.ops[n].portsOut[r].links){for(let s=0;s<a.ops[n].portsOut[r].links.length;s++){if(a.ops[n].portsOut[r].links[s]){if(a.ops[n].portsOut[r].links[s].subOpRef){const f=this.getOpById(a.ops[n].portsOut[r].links[s].objOut);let t=null;let i=0;for(let e=0;e<this.ops.length;e++){if(this.ops[e].storage&&this.ops[e].storage.ref==a.ops[n].portsOut[r].links[s].subOpRef&&f.uiAttribs.subPatch==this.ops[e].uiAttribs.subPatch){i=this.ops[e].patchId.get();break}}for(let e=0;e<this.ops.length;e++){if(this.ops[e].storage&&this.ops[e].storage.ref==a.ops[n].portsOut[r].links[s].refOp&&this.ops[e].uiAttribs.subPatch==i){t=this.ops[e];break}}if(!t)this._log.warn("could not find op for lost link");else{this._addLink(t.id,a.ops[n].portsOut[r].links[s].objOut,a.ops[n].portsOut[r].links[s].portIn,a.ops[n].portsOut[r].links[s].portOut)}}else{const i=this._addLink(a.ops[n].portsOut[r].links[s].objIn,a.ops[n].portsOut[r].links[s].objOut,a.ops[n].portsOut[r].links[s].portIn,a.ops[n].portsOut[r].links[s].portOut);if(!i){const g=this.getOpById(a.ops[n].portsOut[r].links[s].objIn);const d=this.getOpById(a.ops[n].portsOut[r].links[s].objOut);if(!g)console.log("could not find link op1");if(!d)console.log("could not find link op2");const m=a.ops[n].portsOut[r].links[s].portIn;if(g&&!g.getPort(m)){g.preservedPortLinks[m]=g.preservedPortLinks[m]||[];g.preservedPortLinks[m].push(a.ops[n].portsOut[r].links[s])}const p=a.ops[n].portsOut[r].links[s].portOut;if(d&&!d.getPort(p)){d.preservedPortLinks[m]=d.preservedPortLinks[m]||[];d.preservedPortLinks[m].push(a.ops[n].portsOut[r].links[s])}}}}}}}}this.logStartup("calling ops onloaded");for(let e=0;e<this.ops.length;e++){if(this.ops[e].onLoaded){this.ops[e].onLoaded();this.ops[e].onLoaded=null}}this.logStartup("initializing ops...");for(let e=0;e<this.ops.length;e++){if(this.ops[e].init){try{this.ops[e].init();this.ops[e].init=null}catch(e){console.error("op.init crash",e)}}}this.logStartup("initializing vars...");if(this.config.variables)for(const _ in this.config.variables)this.setVarValue(_,this.config.variables[_]);this.logStartup("initializing var ports");for(let e=0;e<this.ops.length;e++){this.ops[e].initVarPorts();delete this.ops[e].uiAttribs.pasted}setTimeout(()=>{this.loading.finished(t)},100);this.updateAnimMaxTime();if(this.config.onPatchLoaded)this.config.onPatchLoaded(this);this.emitEvent(I.EVENT_PATCHLOADEND,s,a,e.genIds);this.#initialDeserialize=false}profile(e){this.profiler=new S(this);for(let e=0;e<this.ops.length;e++)this.ops[e].profile()}setVariable(e,t){if(this._variables[e]!==undefined){this._variables[e].setValue(t)}else{this._log.warn("variable "+e+" not found!")}}_sortVars(){if(!this.isEditorMode())return;const t={};Object.keys(this._variables).sort((e,t)=>{return e.localeCompare(t,"en",{sensitivity:"base"})}).forEach(e=>{t[e]=this._variables[e]});this._variables=t}hasVar(e){return this._variables[e]!==undefined}setVarValue(e,t,i){if(this.hasVar(e)){this._variables[e].setValue(t)}else{this._variables[e]=new M(e,t,i);this._sortVars();this.emitEvent(I.EVENT_VARIABLES_CHANGED)}return this._variables[e]}getVarValue(e,t){if(this._variables.hasOwnProperty(e))return this._variables[e].getValue()}getVar(e){if(this._variables.hasOwnProperty(e))return this._variables[e]}deleteVar(i){for(let t=0;t<this.ops.length;t++)for(let e=0;e<this.ops[t].portsIn.length;e++)if(this.ops[t].portsIn[e].getVariableName()==i)this.ops[t].portsIn[e].setVariable(null);delete this._variables[i];this.emitEvent("variableDeleted",i);this.emitEvent("variablesChanged")}getVars(t){if(t===undefined)return this._variables;if(t===1)return{};const e=I.getGui().uiProfiler.start("[corepatchetend] getVars");const i=[];let s="";if(t==E.I.TYPE_STRING)s="string";else if(t==E.I.TYPE_VALUE)s="number";else if(t==E.I.TYPE_ARRAY)s="array";else if(t==E.I.TYPE_OBJECT)s="object";else if(t==E.I.TYPE_DYNAMIC)s="dynamic";else{console.log("unknown port type",t);console.log((new Error).stack)}for(const e in this._variables){if(!this._variables[e].type||this._variables[e].type==s||this._variables[e].type==t)i.push(this._variables[e])}e.finish();return i}preRenderOps(){this._log.log("prerendering...");for(let e=0;e<this.ops.length;e++){if(this.ops[e].preRender){this.ops[e].preRender();this._log.log("prerender "+this.ops[e].objName)}}}dispose(){this.pause();this.clear();this.cgl.dispose()}pushTriggerStack(e){this._triggerStack.push(e)}popTriggerStack(){this._triggerStack.pop()}printTriggerStack(){if(this._triggerStack.length==0){return}console.groupCollapsed("trigger port stack "+this._triggerStack[this._triggerStack.length-1].op.objName+"."+this._triggerStack[this._triggerStack.length-1].name);const t=[];for(let e=0;e<this._triggerStack.length;e++){t.push(e+". "+this._triggerStack[e].op.objName+" "+this._triggerStack[e].name)}console.table(t);console.groupEnd()}get containerElement(){return this.config.containerElement||this.cgl.canvas.parentElement||null}getDocument(){return this.containerElement.ownerDocument}static getOpClass(e){const t=e.split(".");let i=null;try{if(t.length==2)i=window[t[0]][t[1]];else if(t.length==3)i=window[t[0]][t[1]][t[2]];else if(t.length==4)i=window[t[0]][t[1]][t[2]][t[3]];else if(t.length==5)i=window[t[0]][t[1]][t[2]][t[3]][t[4]];else if(t.length==6)i=window[t[0]][t[1]][t[2]][t[3]][t[4]][t[5]];else if(t.length==7)i=window[t[0]][t[1]][t[2]][t[3]][t[4]][t[5]][t[6]];else if(t.length==8)i=window[t[0]][t[1]][t[2]][t[3]][t[4]][t[5]][t[6]][t[7]];else if(t.length==9)i=window[t[0]][t[1]][t[2]][t[3]][t[4]][t[5]][t[6]][t[7]][t[8]];else if(t.length==10)i=window[t[0]][t[1]][t[2]][t[3]][t[4]][t[5]][t[6]][t[7]][t[8]][t[9]];return i}catch(e){return null}}static replaceOpIds(s,r){const t={};for(const e in s.ops){t[s.ops[e].id]=s.ops[e]}for(const i in s.ops){for(const o in s.ops[i].portsOut){const l=s.ops[i].portsOut[o].links;if(l){let e=l.length;while(e--){if(l[e]&&(!t[l[e].objIn]||!t[l[e].objOut])){if(!r.doNotUnlinkLostLinks){l.splice(e,1)}else{if(r.fixLostLinks){const h=I.getGui().corePatch().getOpById(l[e].objIn);if(!h)console.log("op not found!");else{const u=I.getGui().patchView.getSubPatchOuterOp(h.uiAttribs.subPatch);if(u){h.storage=h.storage||{};h.storage.ref=h.storage.ref||(0,v.shortId)();l[e].refOp=h.storage.ref;l[e].subOpRef=u.storage.ref}}}}}}}}}for(const t in s.ops){const h=s.ops[t];const c=h.id;let e=(0,v.shortId)();if(r.prefixHash)e=(0,v.prefixedHash)(r.prefixHash+c);else if(r.prefixId)e=r.prefixId+c;else if(r.refAsId){if(h.storage&&h.storage.ref){e=h.storage.ref;delete h.storage.ref}else{h.storage=h.storage||{};h.storage.ref=e=(0,v.shortId)()}}const f=h.id=e;if(r.oldIdAsRef){h.storage=h.storage||{};h.storage.ref=c}for(const i in s.ops){if(s.ops[i].portsIn)for(const o in s.ops[i].portsIn){if(s.ops[i].portsIn[o].links){let e=s.ops[i].portsIn[o].links.length;while(e--)if(s.ops[i].portsIn[o].links[e]===null)s.ops[i].portsIn[o].links.splice(e,1);for(e in s.ops[i].portsIn[o].links){if(s.ops[i].portsIn[o].links[e].objIn===c)s.ops[i].portsIn[o].links[e].objIn=f;if(s.ops[i].portsIn[o].links[e].objOut===c)s.ops[i].portsIn[o].links[e].objOut=f}}}if(s.ops[i].portsOut)for(const o in s.ops[i].portsOut){if(s.ops[i].portsOut[o].links){let e=s.ops[i].portsOut[o].links.length;while(e--)if(s.ops[i].portsOut[o].links[e]===null)s.ops[i].portsOut[o].links.splice(e,1);for(e in s.ops[i].portsOut[o].links){if(s.ops[i].portsOut[o].links[e].objIn===c)s.ops[i].portsOut[o].links[e].objIn=f;if(s.ops[i].portsOut[o].links[e].objOut===c)s.ops[i].portsOut[o].links[e].objOut=f}}}}}const n=[];const a=[];for(let i=0;i<s.ops.length;i++){if(s.ops[i].storage&&s.ops[i].storage.subPatchVer){for(let t=0;t<s.ops[i].portsIn.length;t++){if(s.ops[i].portsIn[t].name==="patchId"){let e=(0,v.shortId)();if(r.prefixHash)e=(0,v.prefixedHash)(r.prefixHash+s.ops[i].portsIn[t].value);const g=s.ops[i].portsIn[t].value;const d=s.ops[i].portsIn[t].value=e;n.push(d);for(let e=0;e<s.ops.length;e++){if(s.ops[e].uiAttribs){if(s.ops[e].uiAttribs.subPatch===g){s.ops[e].uiAttribs.subPatch=d;a.push(s.ops[e].id)}}}}}}}for(const m in s.ops){let t=false;for(let e=0;e<a.length;e++){if(s.ops[m].id===a[e]){t=true;break}}if(!t&&s.ops[m].uiAttribs&&r.parentSubPatchId!=null)s.ops[m].uiAttribs.subPatch=r.parentSubPatchId}return s}}class O extends E.I{constructor(e,t,i,s,r){super(e,t,i,s);this.get=()=>{let e=super.get();if(CABLES.UI){if(e===""||e===null||e===undefined||s.values&&s.values.indexOf(String(e))===-1){this.op.setUiError("invalidswitch","Invalid Value ["+this.name+']: "'+e+'"',1)}else this.op.setUiError("invalidswitch",null)}if(e===null||e===undefined)e="";return e};this.indexPort=r;this.indexPort.set=e=>{const t=s.values;if(!t){return}let i=Math.floor(e);i=Math.min(i,t.length-1);i=Math.max(i,0);this.indexPort.setValue(i);this.set(t[i]);if(this.op.patch.isEditorMode()&&performance.now()-(this.lastTime||0)>100&&I.getGui()&&I.getGui().patchView.isCurrentOp(this.op)){I.getGui().opParams.show(this.op);this.lastTime=performance.now()}}}setUiAttribs(e){const t=e.hidePort;e.hidePort=true;super.setUiAttribs(e);if(typeof t!=="undefined")this.indexPort.setUiAttribs({hidePort:t})}}class R extends O{setUiAttribs(e){if(this.indexPort.isLinked()){for(const t in e){if(t=="greyout"&&!e[t])e[t]="true"}}super.setUiAttribs(e)}}const C=2;class P extends E.I{constructor(e,i,s,r,t,n){super(e,i,E.I.TYPE_ARRAY,t);this.setUiAttribs({multiPort:true,group:this.name,order:-1});this.ports=[];this.direction=r;this._uiAttribsPorts=n;const a=()=>{const t=[];let i=1;if(this.uiAttribs.multiPortManual)i=0;for(let e=0;e<this.ports.length-i;e++)t[e]=this.ports[e];this.setRef(t)};const o=()=>{let n=!this.uiAttribs.multiPortManual||false;if(this.direction==x.a.PORT.PORT_DIR_OUT)n=false;for(let r=0;r<this.ports.length;r++){let e;let t=false;let i;let s={};if(this.op.preservedPortTitles&&this.op.preservedPortTitles[this.ports[r].name])i=this.op.preservedPortTitles[this.ports[r].name];if(r==0)e=this.ports.length;if(!this.uiAttribs.multiPortManual)if(r==this.ports.length-1){i="add port";t=true;n=true}for(const a in this._uiAttribsPorts){s[a]=this._uiAttribsPorts[a]}s.addPort=t;s.longPort=e;s.title=i;s.greyout=n;s.group=this.name;this.ports[r].setUiAttribs(s)}};this.removeInvalidPorts=()=>{for(let e=0;e<this.ports.length;e++){if(!this.ports[e])this.ports.splice(e,1)}if(!this.uiAttribs.multiPortManual){if(this.ports.length>C)for(let e=this.ports.length-1;e>1;e--){if(!this.ports[e].isLinked())this.uiAttribs.multiPortNum=e;else break}}a()};this.countPorts=()=>{const e=I.getGui();if(CABLES.UI&&!e.isRemoteClient&&e.patchView&&e.patchView.patchRenderer&&e.patchView.patchRenderer.isDraggingPort()){clearTimeout(this.retryTo);this.retryTo=setTimeout(this.countPorts.bind(this));return}this.retryTo=null;let i=false;this.removeListeners();this.removeInvalidPorts();for(let e=0;e<this.ports.length;e++){if(this.ports[e]&&this.ports[e].links.length>1){const s=this.ports[e+1];const r=this.ports[e].links[0].getOtherPort(this.ports[e]);if(!s||!r){this._log.warn("no port found?")}else{this.ports[e].links[0].remove();this.op.patch.link(this.op,s.name,r.op,r.name);i=true}break}}if(!this.uiAttribs.multiPortManual){let t=true;while(t){t=false;for(let e=this.ports.length-1;e>1;e--){if(this.ports[e]&&this.ports[e].links.length>0&&this.ports[e-1].links.length==0){const r=this.ports[e].links[0].getOtherPort(this.ports[e]);this.ports[e].links[0].remove();const s=this.ports[e-1];if(s&&this.ports[e]){this.op.patch.link(this.op,s.name,r.op,r.name);t=true;i=true;break}}}}}if(!this.uiAttribs.multiPortManual){while(this.ports.length>C&&!this.ports[this.ports.length-1].isLinked()&&!this.ports[this.ports.length-2].isLinked()){let e=this.ports.length-1;if(!this.ports[e].isLinked()&&this.ports[e-1]&&!this.ports[e-1].isLinked()){this.ports[e].setUiAttribs({removed:true});this.ports[e].remove();this.ports.splice(e,1)}}}this.removeInvalidPorts();if(!this.uiAttribs.multiPortManual&&this.ports.length>0&&this.ports[this.ports.length-1].isLinked())this.newPort();a();o();if(i)this.countPorts();else this.addListeners()};this.removeListeners=()=>{for(let e=0;e<this.ports.length;e++){const t=this.ports[e];if(t.multiPortChangeListener)t.multiPortChangeListener=t.off(t.multiPortChangeListener);if(t.multiLinkChangeListener)t.multiLinkChangeListener=t.off(t.multiLinkChangeListener)}};this.addListeners=()=>{for(let e=0;e<this.ports.length;e++){const t=this.ports[e];const i=e;if(t.multiPortChangeListener)t.multiPortChangeListener=t.off(t.multiPortChangeListener);t.multiPortChangeListener=t.on("change",a.bind(this));if(t.multiPortTriggerListener)t.multiPortTriggerListener=t.off(t.multiPortTriggerListener);t.multiPortTriggerListener=t.on("trigger",()=>{this._onTriggered()});if(t.multiLinkChangeListener)t.multiLinkChangeListener=t.off(t.multiLinkChangeListener);t.multiLinkChangeListener=t.on("onLinkChanged",()=>{this.countPorts();this.emitEvent("onLinkChanged")});if(t.multiLinkRemoveListener)t.multiLinkRemoveListener=t.off(t.multiLinkRemoveListener);t.multiLinkRemoveListener=t.on("onLinkRemoved",()=>{o();this.emitEvent("onLinkChanged")})}};this.newPort=()=>{const e={};e.type=s;const t=new E.I(this.op,i+"_"+this.ports.length,s,e);t.direction=r;if(this.direction==x.a.PORT.PORT_DIR_OUT)this.op.addOutPort(t);else this.op.addInPort(t,this.ports[this.ports.length-1]);this.ports.push(t);if(s==E.I.TYPE_NUMBER)t.setInitialValue(0);else if(s==E.I.TYPE_STRING)t.setInitialValue("");this.addListeners();o();a();this.emitEvent("onLinkChanged");if(this.op.preservedPortTitles&&this.op.preservedPortTitles[t.name])t.setUiAttribs({title:this.op.preservedPortTitles[t.name]});return t};this.initPorts=()=>{for(let e=0;e<C;e++)this.newPort();a();o()};this.checkNum=()=>{this.uiAttribs.multiPortNum=Math.max(C,this.uiAttribs.multiPortNum);while(this.ports.length<this.uiAttribs.multiPortNum)this.newPort();while(this.ports.length>this.uiAttribs.multiPortNum)if(this.ports[this.ports.length-1])this.ports.pop().remove();this.removeInvalidPorts()};this.incDec=e=>{this.uiAttribs.multiPortNum=this.uiAttribs.multiPortNum||C;this.setUiAttribs({multiPortNum:this.uiAttribs.multiPortNum+e});this.checkNum();o()};this.toggleManual=()=>{this.setUiAttribs({multiPortManual:!this.uiAttribs.multiPortManual});this.op.refreshParams()};this.on("onUiAttrChange",e=>{if(e.hasOwnProperty("multiPortManual")){o();this.removeInvalidPorts();this.checkNum();this.countPorts();o()}});this.on("onUiAttrChange",this.checkNum.bind(this));this.checkNum();this.countPorts();this.removeInvalidPorts();o()}}class N extends g.A{static OP_VERSION_PREFIX="_v";static EVENT_INIT="init";static EVENT_UIATTR_CHANGE="onUiAttribsChange";#objName="";_log=new d.A("core_op");#shortOpName="";opId="";portsOut=[];patch=null;data={};storage={};portsIn=[];portsInData=[];uiAttribs={};enabled=true;onAnimFrame=null;preservedPortTitles={};preservedPortValues={};preservedPortLinks={};linkTimeRules={needsLinkedToWork:[],needsStringToWork:[],needsParentOp:null};shouldWork={};hasUiErrors=0;uiErrors={};hasAnimPort=false;patchId=null;constructor(e,t,i=null){super();this.opId=i;this.#objName=t;this.patch=e;this.#shortOpName=CABLES.getShortOpName(t);this.getTitle();this.id=i||(0,v.shortId)();this.onAddPort=null;this.onCreate=null;this.onResize=null;this.onLoaded=null;this.onDelete=null;this.onError=null;this._instances=null;this.preRender=null;this.init=null}isInBlueprint2(){return false}get name(){return this.getTitle()}set name(e){this.setTitle(e)}set _objName(e){this.#objName=e;this._log=new d.A("op "+e)}get objName(){return this.#objName}get shortName(){return this.#shortOpName}require(e){if(CABLES.platform&&CABLES.StandaloneElectron&&!CABLES.platform.frontendOptions.isElectron)this.setUiError("notstandalone","This op will only work in cables standalone version",3);return null}checkMainloopExists(){if(!CABLES.UI)return;if(!this.patch.tempData.mainloopOp)this.setUiError("nomainloop","patch should have a mainloop to use this op");else this.setUiError("nomainloop",null)}getTitle(){if(!this.uiAttribs)return"nouiattribs"+this.shortName;return this.uiAttribs.title||this.#shortOpName}setTitle(e){if(e!=this.getTitle())this._setUiAttrib({title:e})}setStorage(e){if(!e)return;this.storage=this.storage||{};let t=false;for(const i in e){if(this.storage[i]!=e[i])t=true;this.storage[i]=e[i]}if(t)this.emitEvent("onStorageChange",e)}isSubPatchOp(){if(this.patchId&&this.storage)return this.storage.subPatchVer||this.storage.blueprintVer||0;return false}setUiAttrib(e){this._setUiAttrib(e)}setUiAttribs(e){this._setUiAttrib(e)}uiAttr(e){this._setUiAttrib(e)}_setUiAttrib(e){if(!e)return;if(typeof e!="object")this._log.error("op.uiAttrib attribs are not of type object");if(!this.uiAttribs)this.uiAttribs={};let t=false;let i=false;if(CABLES.UI&&e.hasOwnProperty("translate")&&(!this.uiAttribs.translate||this.uiAttribs.translate.x!=e.translate.x||this.uiAttribs.translate.y!=e.translate.y))i=true;if(e.hasOwnProperty("title")&&e.title!=this.uiAttribs.title){this.uiAttribs.title=e.title;t=true}if(e.hasOwnProperty("disabled")){t=true;this.setEnabled(!e.disabled)}for(const s in e){if(this.uiAttribs[s]!=e[s])t=true;this.uiAttribs[s]=e[s]}if(this.uiAttribs.hasOwnProperty("highlighted")&&this.uiAttribs.highlighted==false)delete this.uiAttribs.highlighted;if(this.uiAttribs.hasOwnProperty("highlightedMore")&&this.uiAttribs.highlightedMore==false)delete this.uiAttribs.highlightedMore;if(this.uiAttribs.hasOwnProperty("selected")&&this.uiAttribs.selected==false)delete this.uiAttribs.selected;if(this.uiAttribs.hasOwnProperty("selected"))t=true;if(t){this.emitEvent(N.EVENT_UIATTR_CHANGE,e);this.patch.emitEvent("onUiAttribsChange",this,e)}if(i)this.emitEvent("move")}getName(){return this.#shortOpName}addOutPort(e){e.direction=x.a.PORT.PORT_DIR_OUT;if(e.op!=this)console.error("port op is not this...");this.portsOut.push(e);this.emitEvent("onPortAdd",e);return e}hasDynamicPort(){let e=0;for(e=0;e<this.portsIn.length;e++){if(this.portsIn[e].type==E.I.TYPE_DYNAMIC)return true;if(this.portsIn[e].getName()=="dyn")return true}for(e=0;e<this.portsOut.length;e++){if(this.portsOut[e].type==E.I.TYPE_DYNAMIC)return true;if(this.portsOut[e].getName()=="dyn")return true}return false}addInPort(e,t){e.direction=E.I.DIR_IN;e._op=this;if(!t){this.portsIn.push(e)}else{const i=this.portsIn.indexOf(t);this.portsIn.splice(i+1,0,e)}this.emitEvent("onPortAdd",e);return e}inFunction(e,t){return this.inTrigger(e,t)}inTrigger(e,t){const i=this.addInPort(new E.I(this,e,E.I.TYPE_FUNCTION));if(t!==undefined)i.set(t);return i}inTriggerButton(e,t){const i=this.addInPort(new E.I(this,e,E.I.TYPE_FUNCTION,{display:"button"}));if(t!==undefined)i.set(t);return i}inUiTriggerButtons(e,t){const i=this.addInPort(new E.I(this,e,E.I.TYPE_FUNCTION,{display:"buttons"}));if(t!==undefined)i.set(t);return i}inValueFloat(e,t){return this.inFloat(e,t)}inValue(e,t){return this.inFloat(e,t)}inFloat(e,t){const i=this.addInPort(new E.I(this,e,E.I.TYPE_VALUE));i.setInitialValue(t);return i}inValueBool(e,t){return this.inBool(e,t)}inBool(e,t){const i=this.addInPort(new E.I(this,e,E.I.TYPE_NUMBER,{display:"bool"}));if(t===true)t=1;if(t===false)t=0;i.setInitialValue(t);return i}inMultiPort(e,t){const i=new P(this,e,t,E.I.DIR_IN,{addPort:true,hidePort:true});i.ignoreValueSerialize=true;this.addInPort(i);i.initPorts();return i}outMultiPort(e,t,i={}){const s=new P(this,e,t,x.a.PORT.PORT_DIR_OUT,{display:"multiport",hidePort:true},i);s.ignoreValueSerialize=true;this.addOutPort(s);s.initPorts();return s}inValueString(e,t){const i=this.addInPort(new E.I(this,e,E.I.TYPE_VALUE,{type:"string"}));i.value="";i.setInitialValue(t);return i}inString(e,t){const i=this.addInPort(new E.I(this,e,E.I.TYPE_STRING,{type:"string"}));t=t||"";i.setInitialValue(t);return i}inTextarea(e,t){const i=this.addInPort(new E.I(this,e,E.I.TYPE_STRING,{type:"string",display:"text"}));i.value="";if(t!==undefined){i.set(t);i.defaultValue=t}return i}inStringEditor(e,t,i,s=true){const r=this.addInPort(new E.I(this,e,E.I.TYPE_STRING,{type:"string",display:"editor",editShortcut:true,editorSyntax:i,hideFormatButton:s}));r.value="";if(t!==undefined){r.set(t);r.defaultValue=t}return r}inValueEditor(e,t,i,s=true){const r=this.addInPort(new E.I(this,e,E.I.TYPE_NUMBER,{type:"string",display:"editor",editorSyntax:i,hideFormatButton:s}));r.value="";if(t!==undefined){r.set(t);r.defaultValue=t}return r}inValueSelect(e,t,i,s){return this.inDropDown(e,t,i,s)}inDropDown(e,t,i,s){let r=null;if(!s){const n=new E.I(this,e+" index",E.I.TYPE_NUMBER,{increment:"integer",hideParam:true});const a=this.addInPort(n);if(t)for(let e=0;e<t.length;e++)t[e]=String(t[e]);const o=new R(this,e,E.I.TYPE_NUMBER,{display:"dropdown",hidePort:true,type:"string",values:t},a);o.indexPort=n;o.on("change",(e,t)=>{if(!t.indexPort.isLinked()&&t.uiAttribs.values){const i=t.uiAttribs.values.indexOf(e);if(i>-1)t.indexPort.set(i)}});n.onLinkChanged=()=>{o.setUiAttribs({greyout:n.isLinked()})};r=this.addInPort(o);if(i!==undefined){r.set(i);const l=t.findIndex(e=>{return e==i});a.setValue(l);r.defaultValue=i;a.defaultValue=l}}else{const o=new E.I(this,e,E.I.TYPE_VALUE,{display:"dropdown",hidePort:true,type:"string",values:t});r=this.addInPort(o)}return r}inSwitch(e,t,i,s){let r=null;if(!s){if(!i)i=t[0];const n=new E.I(this,e+" index",E.I.TYPE_VALUE,{increment:"integer",values:t,hideParam:true});const a=this.addInPort(n);if(t)for(let e=0;e<t.length;e++)t[e]=String(t[e]);const o=new O(this,e,E.I.TYPE_STRING,{display:"switch",hidePort:true,type:"string",values:t},a);o.indexPort=n;o.on("change",(e,t)=>{if(!t.indexPort.isLinked()&&t.uiAttribs.values){const i=t.uiAttribs.values.indexOf(e);if(i>-1)t.indexPort.set(i)}});n.onLinkChanged=function(){o.setUiAttribs({greyout:n.isLinked()})};r=this.addInPort(o);if(i!==undefined){r.set(i);const l=t.findIndex(e=>{return e==i});a.setValue(l);r.defaultValue=i;a.defaultValue=l}}else{const o=new E.I(this,e,E.I.TYPE_STRING,{display:"switch",hidePort:true,type:"string",values:t});r=this.addInPort(o)}return r}inValueInt(e,t){return this.inInt(e,t)}inInt(e,t){const i=this.addInPort(new E.I(this,e,E.I.TYPE_VALUE,{increment:"integer"}));if(t!==undefined){i.set(t);i.defaultValue=t}return i}inFile(e,t,i){const s=this.addInPort(new E.I(this,e,E.I.TYPE_VALUE,{display:"file",type:"string",filter:t}));if(i!==undefined){s.set(i);s.defaultValue=i}return s}inUrl(e,t,i){const s=this.addInPort(new E.I(this,e,E.I.TYPE_STRING,{display:"file",type:"string",filter:t}));if(i!==undefined){s.set(i);s.defaultValue=i}return s}inTexture(e,t){const i=this.addInPort(new E.I(this,e,E.I.TYPE_OBJECT,{display:"texture",objType:"texture",preview:true}));i.ignoreValueSerialize=true;if(t!==undefined)i.set(t);return i}inObject(e,t,i){const s=this.addInPort(new E.I(this,e,E.I.TYPE_OBJECT,{objType:i}));s.ignoreValueSerialize=true;if(t!==undefined)s.set(t);return s}inGradient(e,t){const i=this.addInPort(new E.I(this,e,E.I.TYPE_VALUE,{display:"gradient"}));if(t!==undefined)i.set(t);return i}getPortVisibleIndex(t){let i=this.portsIn;if(t.direction==x.a.PORT_DIR_OUT)i=this.portsOut;let s=0;for(let e=0;e<i.length;e++){if(i[e].uiAttribs.hidePort)continue;s++;if(i[e]==t)return s}}inArray(e,t=undefined,i=undefined){let s=i;if(!i&&CABLES.isNumeric(t))s=t;const r=this.addInPort(new E.I(this,e,E.I.TYPE_ARRAY,{stride:s}));if(t!==undefined&&(Array.isArray(t)||t==null))r.set(t);return r}inValueSlider(e,t,i,s){return this.inFloatSlider(e,t,i,s)}inFloatSlider(e,t,i,s){const r={display:"range"};if(i!=undefined&&s!=undefined){r.min=i;r.max=s}const n=this.addInPort(new E.I(this,e,E.I.TYPE_VALUE,r));if(t!==undefined){n.set(t);n.defaultValue=t}return n}outFunction(e,t){return this.outTrigger(e,t)}outTrigger(e,t){const i=this.addOutPort(new E.I(this,e,E.I.TYPE_FUNCTION));if(t!==undefined)i.set(t);return i}outValue(e,t){return this.outNumber(e,t)}outNumber(e,t){const i=this.addOutPort(new E.I(this,e,E.I.TYPE_VALUE));if(t!==undefined)i.set(t);return i}outValueBool(e,t){return this.outBool(e,t)}outBool(e,t){const i=this.addOutPort(new E.I(this,e,E.I.TYPE_VALUE,{display:"bool"}));if(t!==undefined)i.set(t);else i.set(0);return i}outBoolNum(e,t){const i=this.addOutPort(new E.I(this,e,E.I.TYPE_VALUE,{display:"boolnum"}));i.set=function(e){this.setValue(e?1:0)}.bind(i);if(t!==undefined)i.set(t);else i.set(0);return i}outValueString(e,t){const i=this.addOutPort(new E.I(this,e,E.I.TYPE_VALUE,{type:"string"}));if(t!==undefined)i.set(t);return i}outString(e,t){const i=this.addOutPort(new E.I(this,e,E.I.TYPE_STRING,{type:"string"}));if(t!==undefined)i.set(t);else i.set("");return i}outObject(e,t,i){const s=this.addOutPort(new E.I(this,e,E.I.TYPE_OBJECT,{objType:i||null}));s.set(t||null);s.ignoreValueSerialize=true;return s}outArray(e,t,i){if(!i&&CABLES.isNumeric(t))i=t;const s=this.addOutPort(new E.I(this,e,E.I.TYPE_ARRAY,{stride:i}));if(t!==undefined&&(Array.isArray(t)||t==null))s.set(t);s.ignoreValueSerialize=true;return s}outTexture(e,t){const i=this.addOutPort(new E.I(this,e,E.I.TYPE_OBJECT,{preview:true,objType:"texture",display:"texture"}));if(t!==undefined)i.setRef(t||_.Rq.Texture.getEmptyTexture(this.patch.cgl));i.ignoreValueSerialize=true;return i}inDynamic(e,t,i,s){const r=new E.I(this,e,E.I.TYPE_DYNAMIC,i);r.shouldLink=()=>{if(t&&Array.isArray(t))return false;return true};this.addInPort(r);if(s!==undefined){r.set(s);r.defaultValue=s}return r}removeLinks(){for(let e=0;e<this.portsIn.length;e++)this.portsIn[e].removeLinks();for(let e=0;e<this.portsOut.length;e++)this.portsOut[e].removeLinks()}getSerialized(){const t={};if(this.opId)t.opId=this.opId;if(this.patch.storeObjNames)t.objName=this.objName;t.id=this.id;t.uiAttribs=JSON.parse(JSON.stringify(this.uiAttribs))||{};if(this.storage&&Object.keys(this.storage).length>0)t.storage=JSON.parse(JSON.stringify(this.storage));if(this.uiAttribs.hasOwnProperty("working")&&this.uiAttribs.working==true)delete this.uiAttribs.working;if(t.uiAttribs.hasOwnProperty("uierrors"))delete t.uiAttribs.uierrors;if(t.uiAttribs.hasOwnProperty("highlighted"))delete t.uiAttribs.highlighted;if(t.uiAttribs.hasOwnProperty("highlightedMore"))delete t.uiAttribs.highlightedMore;if(t.uiAttribs.title==="")delete t.uiAttribs.title;if(t.uiAttribs.color===null)delete t.uiAttribs.color;if(t.uiAttribs.comment===null)delete t.uiAttribs.comment;if(t.uiAttribs.title==this.#shortOpName||(this.uiAttribs.title||"").toLowerCase()==this.#shortOpName.toLowerCase())delete t.uiAttribs.title;t.portsIn=[];t.portsOut=[];for(let e=0;e<this.portsIn.length;e++){const i=this.portsIn[e].getSerialized();if(i)t.portsIn.push(i)}for(let e=0;e<this.portsOut.length;e++){const i=this.portsOut[e].getSerialized();if(i)t.portsOut.push(i)}if(t.portsIn.length==0)delete t.portsIn;if(t.portsOut.length==0)delete t.portsOut;(0,v.cleanJson)(t);return t}getFirstOutPortByType(t){for(let e=0;e<this.portsOut.length;e++)if(this.portsOut[e].type==t)return this.portsOut[e]}getFirstInPortByType(t){for(let e=0;e<this.portsIn.length;e++)if(this.portsIn[e].type==t)return this.portsIn[e]}getPort(e,t=false){return this.getPortByName(e,t)}getPortByName(t,e=false){if(e){for(let e=0;e<this.portsIn.length;e++)if(this.portsIn[e].getName().toLowerCase()==t||this.portsIn[e].id.toLowerCase()==t)return this.portsIn[e];for(let e=0;e<this.portsOut.length;e++)if(this.portsOut[e].getName().toLowerCase()==t||this.portsOut[e].id.toLowerCase()==t)return this.portsOut[e]}else{for(let e=0;e<this.portsIn.length;e++)if(this.portsIn[e].getName()==t||this.portsIn[e].id==t)return this.portsIn[e];for(let e=0;e<this.portsOut.length;e++)if(this.portsOut[e].getName()==t||this.portsOut[e].id==t)return this.portsOut[e]}}getPortById(t){for(let e=0;e<this.portsIn.length;e++)if(this.portsIn[e].id==t)return this.portsIn[e];for(let e=0;e<this.portsOut.length;e++)if(this.portsOut[e].id==t)return this.portsOut[e]}updateAnims(){if(this.hasAnimPort)for(let e=0;e<this.portsIn.length;e++)this.portsIn[e].updateAnim()}log(){this._log.log(...arguments)}error(){this._log.error(...arguments)}logError(){this._log.error(...arguments)}warn(){this._log.warn(...arguments)}logWarn(){this._log.warn(...arguments)}verbose(){this._log.verbose(...arguments)}logVerbose(){this._log.verbose(...arguments)}profile(){for(let e=0;e<this.portsIn.length;e++){this.portsIn[e]._onTriggered=this.portsIn[e]._onTriggeredProfiling;this.portsIn[e].set=this.portsIn[e]._onSetProfiling}}cleanUp(){if(this._instances){for(let e=0;e<this._instances.length;e++)if(this._instances[e].onDelete)this._instances[e].onDelete();this._instances.length=0}for(let e=0;e<this.portsIn.length;e++)this.portsIn[e].setAnimated(false);if(this.onAnimFrame)this.patch.removeOnAnimFrame(this)}instanced(e){return false}initInstancable(){}hasUiError(e){return this.uiErrors.hasOwnProperty(e)&&this.uiErrors[e]}setUiError(e,t,i=2,s={}){}setEnabled(e){this.enabled=e;this.emitEvent("onEnabledChange",e)}setPortGroup(t,i){for(let e=0;e<i.length;e++){if(i[e])if(i[e].setUiAttribs)i[e].setUiAttribs({group:t});else this._log.error("setPortGroup: invalid port!")}}setUiAxisPorts(e,t,i){if(e)e.setUiAttribs({axis:"X"});if(t)t.setUiAttribs({axis:"Y"});if(i)i.setUiAttribs({axis:"Z"})}removePort(t){for(let e=0;e<this.portsIn.length;e++){if(this.portsIn[e]==t){this.portsIn.splice(e,1);this.emitEvent(N.EVENT_UIATTR_CHANGE,{});this.emitEvent("onPortRemoved",{});return}}for(let e=0;e<this.portsOut.length;e++){if(this.portsOut[e]==t){this.portsOut.splice(e,1);this.emitEvent(N.EVENT_UIATTR_CHANGE,{});this.emitEvent("onPortRemoved",{});return}}}toWorkNeedsParent(e){this.linkTimeRules.needsParentOp=e}toWorkShouldNotBeChild(e,t){if(!this.patch.isEditorMode())return;this.linkTimeRules.forbiddenParent=e;if(t!=undefined)this.linkTimeRules.forbiddenParentType=t}toWorkPortsNeedsString(){if(!this.patch.isEditorMode())return;for(let e=0;e<arguments.length;e++)if(this.linkTimeRules.needsStringToWork.indexOf(arguments[e])==-1)this.linkTimeRules.needsStringToWork.push(arguments[e])}toWorkPortsNeedToBeLinked(){if(!this.patch.isEditorMode())return;for(let e=0;e<arguments.length;e++)if(this.linkTimeRules.needsLinkedToWork.indexOf(arguments[e])==-1)this.linkTimeRules.needsLinkedToWork.push(arguments[e])}toWorkPortsNeedToBeLinkedReset(){if(!this.patch.isEditorMode())return;this.linkTimeRules.needsLinkedToWork.length=0;if(this.checkLinkTimeWarnings)this.checkLinkTimeWarnings()}initVarPorts(){for(let e=0;e<this.portsIn.length;e++)if(this.portsIn[e].getVariableName())this.portsIn[e].setVariable(this.portsIn[e].getVariableName())}checkLinkTimeWarnings(){}_checkLinksNeededToWork(){}refreshParams(){if(this.patch&&this.patch.isEditorMode()&&this.isCurrentUiOp())I.getGui().opParams.show(this)}isCurrentUiOp(){if(this.patch.isEditorMode())return I.getGui().patchView.isCurrentOp(this)}checkGraphicsApi(e=b.G.API_WEBGL){if(this.patch.isEditorMode())if(this.patch.cg&&this.patch.cg.gApi!=e)this.setUiError("wronggapi","Wrong graphics API",2)}}const F={};F.addPatch=function(e,t){let i=e;let s=(0,v.generateUUID)();if(typeof e=="string"){s=e;i=document.getElementById(s);if(!i){console.error(s+" Polyshape Container Element not found!");return}}const r=document.createElement("canvas");r.id="glcanvas_"+s;r.width=i.clientWidth;r.height=i.clientHeight;window.addEventListener("resize",function(){this.setAttribute("width",i.clientWidth);this.height=i.clientHeight}.bind(r));i.appendChild(r);t=t||{};t.glCanvasId=r.id;if(!t.onError){t.onError=function(e){console.error(e)}}CABLES.patch=new I(t);return r};const L=function(){let t=null;const i=[];this.onChanged=function(e){i.push(e)};this.getValue=function(){return t};this.setValue=function(e){t=e;this.emitChanged()};this.emitChanged=function(){for(let e=0;e<i.length;e++){i[e]()}}};var D=t(963);CABLES=CABLES||{};CABLES={...CABLES,...x.a.PORT,...x.a.PACO,...x.a.ANIM,...x.a.OP};CABLES.EMBED=F;CABLES.Link=p;CABLES.Port=E.I;CABLES.Op=N;CABLES.Profiler=S;CABLES.Patch=I;CABLES.Timer=A.M4;CABLES.Variable=L;CABLES.LoadingStatus=T;CABLES.now=A.tB;CABLES.internalNow=A.uw;CABLES.Anim=m.k;CABLES.AnimKey=D.rA;CABLES.shortId=v.shortId;CABLES.uuid=v.uuid;CABLES.getShortOpName=v.getShortOpName;CABLES.simpleId=v.simpleId;CABLES.clamp=v.clamp;CABLES.map=v.map;CABLES.shuffleArray=v.shuffleArray;CABLES.generateUUID=v.generateUUID;CABLES.prefixedHash=v.prefixedHash;CABLES.smoothStep=v.smoothStep;CABLES.smootherStep=v.smootherStep;CABLES.cacheBust=v.cacheBust;CABLES.copyArray=v.copyArray;CABLES.basename=v.basename;CABLES.logStack=v.logStack;CABLES.filename=v.filename;CABLES.ajax=v.ajax;CABLES.request=v.request;CABLES.logErrorConsole=v.logErrorConsole;CABLES.isNumeric=v.isNumeric;CABLES.uniqueArray=v.uniqueArray;CABLES.OPS=[];CABLES.utils=v;CABLES.CONSTANTS=x.a;CABLES.GLMatrix=i;CABLES.SHARED={};CABLES.SHARED.Events=g.A;CABLES.SHARED.Logger=d.A;const y=CABLES;if(!function(){return!this}())console.warn("not in strict mode: index core")},920:(e,t,i)=>{"use strict";i.d(t,{M4:()=>a,tB:()=>n,uw:()=>r});var s=i(125);const r=function(){return window.performance.now()};const n=function(){return r()};class a extends s.A{static EVENT_PLAY_PAUSE="playPause";static EVENT_TIME_CHANGED="timeChanged";constructor(){super();this._timeStart=r();this._timeOffset=0;this._currentTime=0;this._lastTime=0;this._paused=true;this._delay=0;this.overwriteTime=-1}_internalNow(){if(this._ts)return this._ts;return r()}_getTime(){this._lastTime=(this._internalNow()-this._timeStart)/1e3;return this._lastTime+this._timeOffset}setDelay(e){this._delay=e;this.emitEvent(a.EVENT_TIME_CHANGED)}isPlaying(){return!this._paused}update(e){if(e)this._ts=e;if(this._paused)return;this._currentTime=this._getTime();return this._currentTime}getMillis(){return this.get()*1e3}get(){return this.getTime()}getTime(){if(this.overwriteTime>=0)return this.overwriteTime-this._delay;return this._currentTime-this._delay}togglePlay(){if(this._paused)this.play();else this.pause()}setTime(e){if(isNaN(e)||e<0)e=0;this._timeStart=this._internalNow();this._timeOffset=e;this._currentTime=e;this.emitEvent(a.EVENT_TIME_CHANGED)}setOffset(e){if(this._currentTime+e<0){this._timeStart=this._internalNow();this._timeOffset=0;this._currentTime=0}else{this._timeOffset+=e;this._currentTime=this._lastTime+this._timeOffset}this.emitEvent(a.EVENT_TIME_CHANGED)}play(){this._timeStart=this._internalNow();this._paused=false;this.emitEvent(a.EVENT_PLAY_PAUSE)}pause(){this._timeOffset=this._currentTime;this._paused=true;this.emitEvent(a.EVENT_PLAY_PAUSE)}static now(){return window.performance.now()}}},562:(e,t,i)=>{"use strict";i.r(t);i.d(t,{ajax:()=>I,basename:()=>A,cacheBust:()=>x,clamp:()=>v,cleanJson:()=>f,copyArray:()=>T,escapeHTML:()=>L,filename:()=>M,float32Concat:()=>n,generateUUID:()=>c,getShortOpName:()=>a,isNumeric:()=>b,logErrorConsole:()=>R,logStack:()=>S,map:()=>E,prefixedHash:()=>g,request:()=>O,shortId:()=>h,shuffleArray:()=>o,simpleId:()=>m,smoothStep:()=>p,smootherStep:()=>_,uniqueArray:()=>C,uuid:()=>u});var s=i(440);Math.randomSeed=1;Math.setRandomSeed=function(e){Math.randomSeed=e*50728129;if(e!=0){Math.randomSeed=Math.seededRandom()*17624813;Math.randomSeed=Math.seededRandom()*9737333}};Math.seededRandom=function(e,t){if(Math.randomSeed===0)Math.randomSeed=Math.random()*999;e=e||1;t=t||0;Math.randomSeed=(Math.randomSeed*9301+49297)%233280;const i=Math.randomSeed/233280;return t+i*(e-t)};String.prototype.endl=function(){return this+"\n"};String.prototype.contains=function(e){console.warn("string.contains deprecated, use string.includes");console.log((new Error).stack);return this.includes(e)};function r(){}r();function n(e,t){if(!(e instanceof Float32Array))e=new Float32Array(e);if(!(t instanceof Float32Array))t=new Float32Array(t);const i=new Float32Array(e.length+t.length);i.set(e);i.set(t,e.length);return i}const a=function(e){let t=e.split(".")[e.split(".").length-1];if(t.includes(s.a.OP.OP_VERSION_PREFIX)){const i=t.split(s.a.OP.OP_VERSION_PREFIX)[1];t=t.substring(0,t.length-(s.a.OP.OP_VERSION_PREFIX+i).length)}return t};const o=function(t){for(let e=t.length-1;e>0;e--){const i=Math.floor(Math.seededRandom()*(e+1));const s=t[e];t[e]=t[i];t[i]=s}return t};const l={};const h=function(){let e=Math.random().toString(36).substr(2,9);if(l.hasOwnProperty(e))e=h();l[e]=true;return e};const u=function(){let i=(new Date).getTime();const e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=(i+Math.random()*16)%16|0;i=Math.floor(i/16);return(e=="x"?t:t&3|8).toString(16)});return e};const c=u;function f(t){for(const e in t){if(t[e]&&typeof objValue==="object"&&t[e].constructor===Object)t[e]=f(t[e]);if(t[e]===null||t[e]===undefined)delete t[e];else if(Array.isArray(t[e])&&t[e].length==0)delete t[e]}return t}const g=function(i,e="id"){let s=0;if(i.length>0){for(let t=0;t<i.length;t++){let e=i.charCodeAt(t);s=(s<<5)-s+e;s&=s}}return e+""+s};let d=0;const m=function(){d++;return d};const p=function(e){const t=Math.max(0,Math.min(1,(e-0)/(1-0)));e=t*t*(3-2*t);return e};const _=function(e){const t=Math.max(0,Math.min(1,(e-0)/(1-0)));e=t*t*t*(t*(t*6-15)+10);return e};const v=function(e,t,i){return Math.min(Math.max(e,t),i)};const E=function(e,t,i,s,r,n=0,a=true){if(a){if(e>=i)return r;if(e<=t)return s}let o=false;const l=Math.min(t,i);const h=Math.max(t,i);if(l!=t)o=true;let u=false;const c=Math.min(s,r);const f=Math.max(s,r);if(c!=s)u=true;let g=0;let d=0;if(o)g=(h-e)*(f-c)/(h-l);else g=(e-l)*(f-c)/(h-l);if(u)d=f-g;else d=g+c;if(!n)return d;if(n==1){e=Math.max(0,Math.min(1,(d-s)/(r-s)));return s+e*e*(3-2*e)*(r-s)}if(n==2){e=Math.max(0,Math.min(1,(d-s)/(r-s)));return s+e*e*e*(e*(e*6-15)+10)*(r-s)}return d};function b(e){return!isNaN(parseFloat(e))&&isFinite(e)}const x=function(e=""){if(!e)return"";if(e.startsWith("data:"))return;if(e.includes("?"))e+="&";else e+="?";return e+"cache="+CABLES.uuid()};const T=function(t,i){if(!t)return null;i=i||[];i.length=t.length;for(let e=0;e<t.length;e++)i[e]=t[e];return i};const A=function(e){let t=CABLES.filename(e);const i=t.split(".");t=i[0];return t};const S=function(){console.log("logstack",(new Error).stack)};const M=function(e){let t="";if(!e)return"";if(e.startsWith("data:")&&e.includes(":")){const i=e.split(",");return i[0]}let i=(e+"").split("/");if(i.length>0){const s=i[i.length-1];let e=s.split("?");t=e[0]}return t||""};const I=function(e,t,i,s,r,n,a={},o={}){const l={url:e,cb:t,method:i,data:s,contenttype:r,sync:false,jsonP:n,headers:a};if(o&&o.credentials)l.credentials=o.credentials;O(l)};const O=function(t){if(!t.hasOwnProperty("asynch"))t.asynch=true;let i;try{i=new XMLHttpRequest}catch(e){}i.onreadystatechange=function(){if(i.readyState!=4)return;if(t.cb){if(i.status==200||i.status==0)t.cb(false,i.responseText,i);else t.cb(true,i.responseText,i)}};try{i.open(t.method?t.method.toUpperCase():"GET",t.url,!t.sync)}catch(e){if(t.cb&&e)t.cb(true,e.msg,i)}if(typeof t.headers==="object"){if(t.headers){const s=Object.keys(t.headers);for(let e=0;e<s.length;e++){const r=s[e];const n=t.headers[r];i.setRequestHeader(r,n)}}}if(t.credentials&&t.credentials!=="omit"){i.withCredentials=true}try{if(!t.post&&!t.data){i.send()}else{i.setRequestHeader("Content-type",t.contenttype?t.contenttype:"application/x-www-form-urlencoded");i.send(t.data||t.post)}}catch(e){if(t.cb)t.cb(true,e.msg,i)}};const R=function(e){CABLES.errorConsole=CABLES.errorConsole||{log:[]};CABLES.errorConsole.log.push({initiator:e,arguments:arguments});if(!CABLES.errorConsole.ele){const t=document.createElement("div");t.id="cablesErrorConsole";t.style.width="90%";t.style.height="300px";t.style.zIndex="9999999";t.style.display="inline-block";t.style.position="absolute";t.style.padding="10px";t.style.fontFamily="monospace";t.style.color="red";t.style.backgroundColor="#200";CABLES.errorConsole.ele=t;document.body.appendChild(t)}let s="ERROR<br/>for more info, open your browsers dev tools console (Ctrl+Shift+I or Command+Alt+I)<br/>";for(let i=0;i<CABLES.errorConsole.log.length;i++){s+=CABLES.errorConsole.log[i].initiator+" ";for(let e=1;e<CABLES.errorConsole.log[i].arguments.length;e++){if(e>2)s+=", ";let t=CABLES.errorConsole.log[i].arguments[e];if(t.constructor.name.indexOf("Error")>-1||t.constructor.name.indexOf("error")>-1){let e="Uncaught ErrorEvent ";if(t.message)e+=" message: "+t.message;s+=e}else if(typeof t=="string")s+=t;else if(typeof t=="number")s+=String(t)+" "}s+="<br/>"}CABLES.errorConsole.ele.innerHTML=s};function C(i){const s={},r=[];for(let e=0,t=i.length;e<t;++e){if(!s.hasOwnProperty(i[e])){r.push(i[e]);s[i[e]]=1}}return r}const P={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};const N=/[&<>"']/g;const F=RegExp(N.source);const L=function(e){return e&&F.test(e)?e.replace(N,function(e){return P[e]}):e||""}},982:(e,t,i)=>{"use strict";i.d(t,{I:()=>a});var s=i(329);var r=i(684);var n=i(562);class a{constructor(e){this._init();this._first=true;this._wireMesh=null;if(e)this.applyGeom(e)}_init(){this._max=[-0,-0,-0];this._min=[0,0,0];this._center=[0,0,0];this._size=[0,0,0];this._maxAxis=0;this._first=true}get maxAxis(){return this._maxAxis||1}get size(){return this._size}get center(){return this._center}get x(){return this._center[0]}get y(){return this._center[1]}get z(){return this._center[2]}get minX(){return this._min[0]}get minY(){return this._min[1]}get minZ(){return this._min[2]}get maxX(){return this._max[0]}get maxY(){return this._max[1]}get maxZ(){return this._max[2]}apply(e){return this.applyGeom(e)}applyGeom(t){if(!t)return;if(t instanceof a){const e=t;this.applyPos(e.maxX,e.maxY,e.maxZ);this.applyPos(e.minX,e.minY,e.minZ)}else{if(t.isGeometry)for(let e=0;e<t.vertices.length;e+=3)this.applyPos(t.vertices[e],t.vertices[e+1],t.vertices[e+2])}this.calcCenterSize()}copy(){return new a(this)}get changed(){return!(this._max[0]==-Number.MAX_VALUE&&this._max[1]==-Number.MAX_VALUE&&this._max[2]==-Number.MAX_VALUE)}applyPos(e,t,i){if(e==Number.MAX_VALUE||e==-Number.MAX_VALUE||t==Number.MAX_VALUE||t==-Number.MAX_VALUE||i==Number.MAX_VALUE||i==-Number.MAX_VALUE)return;if(!n.isNumeric(e)||!n.isNumeric(t)||!n.isNumeric(i))return;if(this._first){this._max[0]=e;this._max[1]=t;this._max[2]=i;this._min[0]=e;this._min[1]=t;this._min[2]=i;this._first=false;return}this._max[0]=Math.max(this._max[0],e);this._max[1]=Math.max(this._max[1],t);this._max[2]=Math.max(this._max[2],i);this._min[0]=Math.min(this._min[0],e);this._min[1]=Math.min(this._min[1],t);this._min[2]=Math.min(this._min[2],i)}calcCenterSize(){if(this._first)return;this._size[0]=this._max[0]-this._min[0];this._size[1]=this._max[1]-this._min[1];this._size[2]=this._max[2]-this._min[2];this._center[0]=(this._min[0]+this._max[0])/2;this._center[1]=(this._min[1]+this._max[1])/2;this._center[2]=(this._min[2]+this._max[2])/2;this._maxAxis=Math.max(this._size[2],Math.max(this._size[0],this._size[1]))}mulMat4(e){if(this._first){this._max[0]=0;this._max[1]=0;this._max[2]=0;this._min[0]=0;this._min[1]=0;this._min[2]=0;this._first=false}s.transformMat4(this._max,this._max,e);s.transformMat4(this._min,this._min,e);this.calcCenterSize()}render(e,t,i){if(!this._wireMesh)this._wireMesh=new CGL.WireCube(e);e.pushModelMatrix();r.translate(e.mMatrix,e.mMatrix,this._center);if(CABLES.UI&&i){CABLES.UI.OverlayMeshes.drawCube(i,this._size[0]/2,this._size[1]/2,this._size[2]/2)}e.popModelMatrix()}}},223:(e,t,i)=>{"use strict";i.d(t,{f:()=>r});var s=i(849);class r{hasFocus=false;forceAspect=0;pixelDensity=1;_oldWidthRp=-1;_oldHeightRp=-1;constructor(e){this._log=new s.A("CgCanvas");if(!e){this._log.error("CgCanvas no options")}else{this._canvasEle=e.canvasEle}if(!e.cg)this._log.error("CgCanvas options has no cg");this._cg=e.cg;if(this.canvasEle){this.canvasWidth=this.canvasEle.clientWidth;this.canvasHeight=this.canvasEle.clientHeight;this.setSize(this.canvasWidth,this.canvasHeight);this.canvasEle.addEventListener("focus",()=>{this.hasFocus=true});this.canvasEle.addEventListener("blur",()=>{this.hasFocus=false})}}get canvasEle(){return this._canvasEle}setSize(t,i,e=false){let s=0;if(this.forceAspect){let e=t/this.forceAspect;if(e<i)s=(i-e)/2;i=e}if(this._oldWidthRp!=t*this.pixelDensity||this._oldHeightRp!=i*this.pixelDensity){this._oldWidthRp=this.canvasEle.width=t*this.pixelDensity;this._oldHeightRp=this.canvasEle.height=i*this.pixelDensity;if(!e){this.canvasEle.style.width=t+"px";this.canvasEle.style.height=i+"px";this.canvasEle.style.marginTop=s+"px"}this.updateSize();this._cg.emitEvent("resize")}}updateSize(){this.canvasEle.width=this.canvasWidth=Math.ceil(this.canvasEle.clientWidth*this.pixelDensity);this.canvasEle.height=this.canvasHeight=Math.ceil(this.canvasEle.clientHeight*this.pixelDensity)}dispose(){if(this._canvasEle)this._canvasEle.remove();this._canvasEle=null}}},628:(e,t,i)=>{"use strict";i.d(t,{A:()=>c});var s=i(125);var r=i(849);var n=i(329);var a=i(684);var o=i(223);var l=i(868);var h=i(460);var u=i(294);class c extends s.A{static API_UNKNOWN=0;static API_WEBGL=1;static API_WEBGPU=2;static EVENT_RESIZE="resize";gApi=0;_textureslots=[];_pMatrixStack=new l.u;_mMatrixStack=new l.u;_vMatrixStack=new l.u;canvasScale=1;constructor(e){super();this._log=new r.A("cg_context",{onError:e.config.onError});this.tempData=this.frameStore=this.frameStore||{};this.fpsCounter=new u.K;this._identView=n.create();this._ident=n.create();n.set(this._identView,0,0,-2);n.set(this._ident,0,0,0);this._onetimeCallbacks=[];this.maxTexSize=2048;this._viewPort=[0,0,1,1];this._viewPortStack=[];this.patch=e;this.autoReSize=true;this.DEPTH_COMPARE_FUNC_NEVER=0;this.DEPTH_COMPARE_FUNC_LESS=1;this.DEPTH_COMPARE_FUNC_EQUAL=2;this.DEPTH_COMPARE_FUNC_LESSEQUAL=3;this.DEPTH_COMPARE_FUNC_GREATER=4;this.DEPTH_COMPARE_FUNC_NOTEQUAL=5;this.DEPTH_COMPARE_FUNC_GREATEREQUAL=6;this.DEPTH_COMPARE_FUNC_ALWAYS=7;this.profileData=new h.E(this);this.pMatrix=a.create();this.mMatrix=a.create();this.vMatrix=a.create();a.identity(this.mMatrix);a.identity(this.vMatrix);window.matchMedia("screen and (min-resolution: 2dppx)").addEventListener("change",()=>{this.emitEvent("resize")})}get canvasWidth(){return this.width}get canvasHeight(){return this.height}get width(){return this.cgCanvas.canvasWidth}get height(){return this.cgCanvas.canvasHeight}get widthCss(){return this.cgCanvas.canvasWidth/this.pixelDensity}get heightCss(){return this.cgCanvas.canvasHeight/this.pixelDensity}set pixelDensity(e){if(this.cgCanvas.pixelDensity!=e){this.cgCanvas.pixelDensity=e;this.cgCanvas.updateSize();this.emitEvent("resize")}}get pixelDensity(){return this.cgCanvas.pixelDensity}getGApiName(){return["unknown","WebGL","WebGPU"][this.gApi]}get canvas(){return this.cgCanvas.canvasEle}get viewPort(){return[0,0,this.canvasWidth,this.canvasHeight]}setCanvas(e){if(this.cgCanvas&&e==this.cgCanvas.canvasEle)return;if(typeof e==="string")e=document.getElementById(e);this.cgCanvas=new o.f({canvasEle:e,cg:this});if(!e)return;e.parentElement.classList.add("cablesContainer");if(this._setCanvas)this._setCanvas(e);this.updateSize()}_setCanvas(e){}updateSize(){this.cgCanvas.updateSize()}setSize(e,t,i=false){this.cgCanvas.setSize(e,t,i)}_resizeToWindowSize(){if(this.autoReSize){this.setSize(window.innerWidth,window.innerHeight);this.updateSize()}}_resizeToParentSize(){if(this.autoReSize){const e=this.canvas.parentElement;if(!e){this._log.error("cables: can not resize to container element");return}this.setSize(e.clientWidth,e.clientHeight);this.updateSize()}}setAutoResize(e){window.removeEventListener("resize",this._resizeToWindowSize.bind(this));window.removeEventListener("resize",this._resizeToParentSize.bind(this));if(e=="window"){window.addEventListener("resize",this._resizeToWindowSize.bind(this));window.addEventListener("orientationchange",this._resizeToWindowSize.bind(this));this._resizeToWindowSize()}if(e=="parent"){window.addEventListener("resize",this._resizeToParentSize.bind(this));this._resizeToParentSize()}}pushPMatrix(){this.pMatrix=this._pMatrixStack.push(this.pMatrix)}popPMatrix(){this.pMatrix=this._pMatrixStack.pop();return this.pMatrix}getProjectionMatrixStateCount(){return this._pMatrixStack.stateCounter}pushModelMatrix(){this.mMatrix=this._mMatrixStack.push(this.mMatrix)}popModelMatrix(){this.mMatrix=this._mMatrixStack.pop();return this.mMatrix}modelMatrix(){return this.mMatrix}pushViewMatrix(){this.vMatrix=this._vMatrixStack.push(this.vMatrix)}popViewMatrix(){this.vMatrix=this._vMatrixStack.pop()}getViewMatrixStateCount(){return this._vMatrixStack.stateCounter}_startMatrixStacks(e,t){e=e||this._ident;t=t||this._identView;a.perspective(this.pMatrix,45,this.canvasWidth/this.canvasHeight,.1,1e3);a.identity(this.mMatrix);a.identity(this.vMatrix);a.translate(this.mMatrix,this.mMatrix,e);a.translate(this.vMatrix,this.vMatrix,t);this.pushPMatrix();this.pushModelMatrix();this.pushViewMatrix()}_endMatrixStacks(){this.popViewMatrix();this.popModelMatrix();this.popPMatrix()}dispose(){this.aborted=true;if(this.cgCanvas)this.cgCanvas.dispose();if(this._dispose)this._dispose()}_dispose(){}shouldDrawHelpers(e){return false}addNextFrameOnceCallback(e){if(e&&this._onetimeCallbacks.indexOf(e)==-1)this._onetimeCallbacks.push(e)}_execOneTimeCallbacks(){if(this._onetimeCallbacks.length>0){for(let e=0;e<this._onetimeCallbacks.length;e++)this._onetimeCallbacks[e]();this._onetimeCallbacks.length=0}}checkTextureSize(e){e=e||1;e=Math.floor(e);e=Math.min(e,this.maxTexSize);e=Math.max(e,1);return e}screenShot(e,t,i,s){console.log("no screenshot function implemented")}saveScreenshot(i,s,e,t,r){this.patch.renderOneFrame();let n=this.canvas.clientWidth*this.pixelDensity;let a=this.canvas.clientHeight*this.pixelDensity;if(e){this.canvas.width=e;n=e}if(t){this.canvas.height=t;a=t}function o(e,t,i){return Array(t-String(e).length+1).join(i||"0")+e}const l=new Date;const h="".concat(String(l.getFullYear())+String(l.getMonth()+1)+String(l.getDate()),"_").concat(o(l.getHours(),2)).concat(o(l.getMinutes(),2)).concat(o(l.getSeconds(),2));if(!i)i="cables_"+h+".png";else i+=".png";this.screenShot(e=>{this.canvas.width=n;this.canvas.height=a;if(e){const t=document.createElement("a");t.download=i;t.href=URL.createObjectURL(e);console.log("scrrenshot");setTimeout(function(){t.click();if(s)s(e)},100)}else{this._log.log("screenshot: no blob")}})}hasFocus(){return this.cgCanvas.hasFocus}}},294:(e,t,i)=>{"use strict";i.d(t,{K:()=>n});var s=i(125);var r=i(920);class n extends s.A{#timeStartFrame=0;#timeStartSecond=0;#fpsCounter=0;#msCounter=0;#frameCount=0;logFps=false;constructor(){super();this.stats={ms:0,fps:0}}get frameCount(){return this.#frameCount}startFrame(){this.#timeStartFrame=(0,r.tB)()}endFrame(){this.#frameCount++;this.#fpsCounter++;const e=(0,r.tB)()-this.#timeStartFrame;this.#msCounter+=e;if((0,r.tB)()-this.#timeStartSecond>1e3)this.endSecond()}endSecond(){this.stats.fps=this.#fpsCounter;this.stats.ms=Math.round(this.#msCounter/this.#fpsCounter*100)/100;this.emitEvent("performance",this.stats);if(this.logFps)console.log(this.stats);this.#fpsCounter=0;this.#msCounter=0;this.#timeStartSecond=(0,r.tB)()}}},331:(e,t,i)=>{"use strict";i.d(t,{V:()=>u});var s=i(849);var w=i(329);var B=i(842);var r=i(562);var n=i(982);class u{isGeometry=true;constructor(e){this.name=e||"unknown";this._log=new s.A("cgl_geometry");this.faceVertCount=3;this.glPrimitive=null;this._attributes={};this._vertices=[];this.verticesIndices=[];this.morphTargets=[]}get vertices(){return this._vertices}set vertices(e){this.setVertices(e)}get texCoords(){const e=this.getAttribute("texCoords");if(!e)return[];return e.data}set texCoords(e){this.setAttribute("texCoords",e,2)}get vertexNormals(){const e=this.getAttribute("vertexNormals");if(!e)return[];return e.data}set vertexNormals(e){this.setAttribute("vertexNormals",e,3)}get tangents(){const e=this.getAttribute("tangents");if(!e)return[];return e.data}set tangents(e){this.setAttribute("tangents",e,3)}get biTangents(){const e=this.getAttribute("biTangents");if(!e)return[];return e.data}set biTangents(e){this.setAttribute("biTangents",e,3)}get vertexColors(){const e=this.getAttribute("vertexColors");if(!e)return[];return e.data}set vertexColors(e){this.setAttribute("vertexColors",e,4)}clear(){this._vertices=new Float32Array([]);this.verticesIndices=[];this.texCoords=new Float32Array([]);this.vertexNormals=new Float32Array([]);this.tangents=[];this.biTangents=[];this._attributes={}}getAttributes(){return this._attributes}getAttribute(t){for(const e in this._attributes){if(this._attributes[e].name==t)return this._attributes[e]}return null}setAttribute(e,t,i){let s="";if(!i||i>4){this._log.warn("itemsize wrong?",i,e);this._log.stack("itemsize");i=3}if(i==1)s="float";else if(i==2)s="vec2";else if(i==3)s="vec3";else if(i==4)s="vec4";const r={name:e,data:t,itemSize:i,type:s};this._attributes[e]=r}copyAttribute(e,t){const i=this.getAttribute(e);t.setAttribute(e,new Float32Array(i.data),i.itemSize)}setVertices(e){if(e instanceof Float32Array)this._vertices=e;else this._vertices=new Float32Array(e)}setTexCoords(e){if(e instanceof Float32Array)this.texCoords=e;else this.texCoords=new Float32Array(e)}calcNormals(e){const t={smooth:e};this.calculateNormals(t)}flipNormals(t,i,s){let r=w.create();if(t==undefined)t=1;if(i==undefined)i=1;if(s==undefined)s=1;for(let e=0;e<this.vertexNormals.length;e+=3){w.set(r,this.vertexNormals[e+0],this.vertexNormals[e+1],this.vertexNormals[e+2]);r[0]*=-t;r[1]*=-i;r[2]*=-s;w.normalize(r,r);this.vertexNormals[e+0]=r[0];this.vertexNormals[e+1]=r[1];this.vertexNormals[e+2]=r[2]}}getNumTriangles(){if(this.verticesIndices&&this.verticesIndices.length)return this.verticesIndices.length/3;return this.vertices.length/3}flipVertDir(){const t=[];t.length=this.verticesIndices.length;for(let e=0;e<this.verticesIndices.length;e+=3){t[e]=this.verticesIndices[e+2];t[e+1]=this.verticesIndices[e+1];t[e+2]=this.verticesIndices[e]}this.verticesIndices=t}setPointVertices(t){if(t.length%3!==0){this._log.error("SetPointVertices: Array must be multiple of three.");return}if(!(t instanceof Float32Array))this.vertices=new Float32Array(t);else this.vertices=t;if(!(this.texCoords instanceof Float32Array))this.texCoords=new Float32Array(t.length/3*2);this.verticesIndices.length=t.length/3;for(let e=0;e<t.length/3;e++){this.verticesIndices[e]=e;this.texCoords[e*2]=0;this.texCoords[e*2+1]=0}}merge(t){if(!t)return;if(this.isIndexed()!=t.isIndexed()){if(this.isIndexed()){this.unIndex(false,true)}if(t.isIndexed()){const e=t.copy();e.unIndex(false,true);t=e}}const i=this.verticesIndices.length;const s=this._vertices.length/3;this.verticesIndices.length+=t.verticesIndices.length;for(let e=0;e<t.verticesIndices.length;e++)this.verticesIndices[i+e]=t.verticesIndices[e]+s;this.vertices=r.float32Concat(this._vertices,t.vertices);this.texCoords=r.float32Concat(this.texCoords,t.texCoords);this.vertexNormals=r.float32Concat(this.vertexNormals,t.vertexNormals);this.tangents=r.float32Concat(this.tangents,t.tangents);this.biTangents=r.float32Concat(this.biTangents,t.biTangents)}copy(){const t=new u(this.name+" copy");t.faceVertCount=this.faceVertCount;t.glPrimitive=this.glPrimitive;t.setVertices(this._vertices.slice(0));if(this.verticesIndices){t.verticesIndices.length=this.verticesIndices.length;for(let e=0;e<this.verticesIndices.length;e++)t.verticesIndices[e]=this.verticesIndices[e]}for(let e in this._attributes)this.copyAttribute(e,t);t.morphTargets.length=this.morphTargets.length;for(let e=0;e<this.morphTargets.length;e++)t.morphTargets[e]=this.morphTargets[e];return t}calculateNormals(t=null){t=t||{};if(t.smooth===false)this.unIndex();const i=w.create();const s=w.create();const r=w.create();function n(e){w.subtract(i,e[0],e[1]);w.subtract(s,e[0],e[2]);w.cross(r,i,s);w.normalize(r,r);if(t&&t.forceZUp){if(r[2]<0){r[0]*=-1;r[1]*=-1;r[2]*=-1}}return r}this.getVertexVec=function(e){const t=[0,0,0];t[0]=this.vertices[e*3+0];t[1]=this.vertices[e*3+1];t[2]=this.vertices[e*3+2];return t};if(!(this.vertexNormals instanceof Float32Array)||this.vertexNormals.length!=this.vertices.length)this.vertexNormals=new Float32Array(this.vertices.length);for(let e=0;e<this.vertices.length;e++){this.vertexNormals[e]=0}if(!this.isIndexed()){const a=[];for(let e=0;e<this.vertices.length;e+=9){const o=[[this.vertices[e+0],this.vertices[e+1],this.vertices[e+2]],[this.vertices[e+3],this.vertices[e+4],this.vertices[e+5]],[this.vertices[e+6],this.vertices[e+7],this.vertices[e+8]]];const l=n(o);a.push(l[0],l[1],l[2],l[0],l[1],l[2],l[0],l[1],l[2])}this.vertexNormals=a}else{const h=[];h.length=Math.floor(this.verticesIndices.length/3);for(let e=0;e<this.verticesIndices.length;e+=3){const o=[this.getVertexVec(this.verticesIndices[e+0]),this.getVertexVec(this.verticesIndices[e+1]),this.getVertexVec(this.verticesIndices[e+2])];h[e/3]=n(o);this.vertexNormals[this.verticesIndices[e+0]*3+0]+=h[e/3][0];this.vertexNormals[this.verticesIndices[e+0]*3+1]+=h[e/3][1];this.vertexNormals[this.verticesIndices[e+0]*3+2]+=h[e/3][2];this.vertexNormals[this.verticesIndices[e+1]*3+0]+=h[e/3][0];this.vertexNormals[this.verticesIndices[e+1]*3+1]+=h[e/3][1];this.vertexNormals[this.verticesIndices[e+1]*3+2]+=h[e/3][2];this.vertexNormals[this.verticesIndices[e+2]*3+0]+=h[e/3][0];this.vertexNormals[this.verticesIndices[e+2]*3+1]+=h[e/3][1];this.vertexNormals[this.verticesIndices[e+2]*3+2]+=h[e/3][2]}for(let t=0;t<this.verticesIndices.length;t+=3){for(let e=0;e<3;e++){const u=[this.vertexNormals[this.verticesIndices[t+e]*3+0],this.vertexNormals[this.verticesIndices[t+e]*3+1],this.vertexNormals[this.verticesIndices[t+e]*3+2]];w.normalize(u,u);this.vertexNormals[this.verticesIndices[t+e]*3+0]=u[0];this.vertexNormals[this.verticesIndices[t+e]*3+1]=u[1];this.vertexNormals[this.verticesIndices[t+e]*3+2]=u[2]}}}}calcTangentsBitangents(){if(!this.vertices.length){return}if(!this.vertexNormals.length){return}if(!this.texCoords.length){const b=this.vertices.length/3*2;this.texCoords=new Float32Array(b);for(let e=0;e<b;e+=1)this.texCoords[e]=0}if(!this.verticesIndices||!this.verticesIndices.length){return}if(this.verticesIndices.length%3!==0){this._log.error("Vertex indices mismatch!");return}const t=this.verticesIndices.length/3;const i=this.vertices.length/3;this.tangents=new Float32Array(this.vertexNormals.length);this.biTangents=new Float32Array(this.vertexNormals.length);const s=[];s.length=i*2;const r=w.create();const n=w.create();const a=w.create();const o=B.create();const l=B.create();const h=B.create();const u=w.create();const c=w.create();for(let e=0;e<t;e+=1){const x=this.verticesIndices[e*3];const T=this.verticesIndices[e*3+1];const A=this.verticesIndices[e*3+2];w.set(r,this.vertices[x*3],this.vertices[x*3+1],this.vertices[x*3+2]);w.set(n,this.vertices[T*3],this.vertices[T*3+1],this.vertices[T*3+2]);w.set(a,this.vertices[A*3],this.vertices[A*3+1],this.vertices[A*3+2]);B.set(o,this.texCoords[x*2],this.texCoords[x*2+1]);B.set(l,this.texCoords[T*2],this.texCoords[T*2+1]);B.set(h,this.texCoords[A*2],this.texCoords[A*2+1]);const S=n[0]-r[0];const M=a[0]-r[0];const I=n[1]-r[1];const O=a[1]-r[1];const R=n[2]-r[2];const C=a[2]-r[2];const P=l[0]-o[0];const N=h[0]-o[0];const F=l[1]-o[1];const L=h[1]-o[1];const D=1/(P*L-N*F);w.set(u,(L*S-F*M)*D,(L*I-F*O)*D,(L*R-F*C)*D);w.set(c,(P*M-N*S)*D,(P*O-N*I)*D,(P*C-N*R)*D);s[x]=u;s[T]=u;s[A]=u;s[x+i]=c;s[T+i]=c;s[A+i]=c}const f=w.create();const g=w.create();const d=w.create();const m=w.create();const p=w.create();const _=w.create();const v=w.create();const E=w.create();for(let e=0;e<i;e+=1){if(!s[e])continue;w.set(f,this.vertexNormals[e*3],this.vertexNormals[e*3+1],this.vertexNormals[e*3+2]);w.set(g,s[e][0],s[e][1],s[e][2]);const y=w.dot(f,g);w.scale(p,f,y);w.subtract(_,g,p);w.normalize(E,_);w.cross(v,f,g);const U=1;w.scale(d,E,1/U);w.cross(m,f,d);this.tangents[e*3+0]=d[0];this.tangents[e*3+1]=d[1];this.tangents[e*3+2]=d[2];this.biTangents[e*3+0]=m[0];this.biTangents[e*3+1]=m[1];this.biTangents[e*3+2]=m[2]}}isIndexed(){if(this._vertices.length==0)return true;return this.verticesIndices.length!=0}unIndex(e=false,t=false){const i=[];const s=[];let r=0;for(let e in this._attributes){const n=this._attributes[e];let i=[];for(let t=0;t<this.verticesIndices.length;t+=3){for(let e=0;e<3;e++){if(n.itemSize==3)i.push(n.data[this.verticesIndices[t+e]*3+0],n.data[this.verticesIndices[t+e]*3+1],n.data[this.verticesIndices[t+e]*3+2]);else if(n.itemSize==4)i.push(n.data[this.verticesIndices[t+e]*4+0],n.data[this.verticesIndices[t+e]*4+1],n.data[this.verticesIndices[t+e]*4+2],n.data[this.verticesIndices[t+e]*4+3]);else if(n.itemSize==2)i.push(n.data[this.verticesIndices[t+e]*2+0],n.data[this.verticesIndices[t+e]*2+1]);else if(n.itemSize==1)i.push(n.data[this.verticesIndices[t+e]]);else this._log.warn("unknown attr",n)}}this.setAttribute(n.name,i,n.itemSize)}for(let e=0;e<this.verticesIndices.length;e+=3){i.push(this.vertices[this.verticesIndices[e+0]*3+0],this.vertices[this.verticesIndices[e+0]*3+1],this.vertices[this.verticesIndices[e+0]*3+2]);s.push(r);r++;i.push(this.vertices[this.verticesIndices[e+1]*3+0],this.vertices[this.verticesIndices[e+1]*3+1],this.vertices[this.verticesIndices[e+1]*3+2]);s.push(r);r++;i.push(this.vertices[this.verticesIndices[e+2]*3+0],this.vertices[this.verticesIndices[e+2]*3+1],this.vertices[this.verticesIndices[e+2]*3+2]);s.push(r);r++}this.vertices=i;this.verticesIndices=[];if(e)this.verticesIndices=s;if(!t)this.calculateNormals()}calcBarycentric(){let t=[];t.length=this.vertices.length;for(let e=0;e<this.vertices.length;e++)t[e]=0;let i=0;for(let e=0;e<this.vertices.length;e+=3){t[e+i]=1;i++;if(i==3)i=0}this.setAttribute("attrBarycentric",t,3)}getBounds(){return new n.I(this)}center(e,t,i){if(e===undefined){e=true;t=true;i=true}let s=0;const r=this.getBounds();const n=[r.minX+(r.maxX-r.minX)/2,r.minY+(r.maxY-r.minY)/2,r.minZ+(r.maxZ-r.minZ)/2];for(s=0;s<this.vertices.length;s+=3){if(this.vertices[s+0]==this.vertices[s+0]){if(e)this.vertices[s+0]-=n[0];if(t)this.vertices[s+1]-=n[1];if(i)this.vertices[s+2]-=n[2]}}return n}mapTexCoords2d(){const t=this.getBounds();const i=this.vertices.length/3;this.texCoords=new Float32Array(i*2);for(let e=0;e<i;e++){const s=this.vertices[e*3+0];const r=this.vertices[e*3+1];this.texCoords[e*2+0]=s/(t.maxX-t.minX)+.5;this.texCoords[e*2+1]=1-r/(t.maxY-t.minY)+.5}}getInfoOneLine(){let e="";if(this.faceVertCount==3&&this.verticesIndices)e+=this.verticesIndices.length/3;else e+=0;e+=" tris ";if(this.vertices)e+=this.vertices.length/3;else e+=0;e+=" verts";return e}getInfo(){const e={};e.name=this.name;e.class=this.constructor.name;if(this.faceVertCount==3&&this.verticesIndices)e.numFaces=this.verticesIndices.length/3;else e.numFaces=0;if(this.verticesIndices&&this.verticesIndices.length)e.indices=this.verticesIndices.length;if(this.vertices)e.numVerts=this.vertices.length/3;else e.numVerts=0;if(this.vertexNormals)e.numNormals=this.vertexNormals.length/3;else e.numNormals=0;if(this.texCoords)e.numTexCoords=this.texCoords.length/2;else e.numTexCoords=0;if(this.tangents)e.numTangents=this.tangents.length/3;else e.numTangents=0;if(this.biTangents)e.numBiTangents=this.biTangents.length/3;else e.numBiTangents=0;if(this.biTangents)e.numBiTangents=this.biTangents.length/3;else e.numBiTangents=0;if(this.vertexColors)e.numVertexColors=this.vertexColors.length/4;else e.numVertexColors=0;if(this.getAttributes())e.numAttribs=Object.keys(this.getAttributes()).length;else e.numAttribs=0;e.isIndexed=this.isIndexed();return e}}u.buildFromFaces=function(t,e,i){const s=[];const r=[];for(let e=0;e<t.length;e+=3){const a=t[e+0];const o=t[e+1];const l=t[e+2];const h=[-1,-1,-1];if(i)for(let e=0;e<s.length;e+=3){if(s[e+0]==a[0]&&s[e+1]==a[1]&&s[e+2]==a[2])h[0]=e/3;if(s[e+0]==o[0]&&s[e+1]==o[1]&&s[e+2]==o[2])h[1]=e/3;if(s[e+0]==l[0]&&s[e+1]==l[1]&&s[e+2]==l[2])h[2]=e/3}if(h[0]==-1){s.push(a[0],a[1],a[2]);h[0]=(s.length-1)/3}if(h[1]==-1){s.push(o[0],o[1],o[2]);h[1]=(s.length-1)/3}if(h[2]==-1){s.push(l[0],l[1],l[2]);h[2]=(s.length-1)/3}r.push(h[0]);r.push(h[1]);r.push(h[2])}const n=new u(e);n.name=e;n.vertices=s;n.verticesIndices=r;return n}},868:(e,t,i)=>{"use strict";i.d(t,{u:()=>r});var s=i(684);class r{constructor(){this._arr=[s.create()];this._index=0;this.stateCounter=0}push(e){this._index++;this.stateCounter++;if(this._index==this._arr.length){const t=s.create();this._arr.push(t)}s.copy(this._arr[this._index],e||this._arr[this._index-1]);return this._arr[this._index]}pop(){this.stateCounter++;this._index--;if(this._index<0)this._index=0;return this._arr[this._index]}length(){return this._index}}},434:(e,t,i)=>{"use strict";i.d(t,{w:()=>s});class s{_name="unknown";constructor(){}}},694:(e,t,i)=>{"use strict";i.d(t,{U:()=>n});var s=i(125);var r=i(562);class n extends s.A{id=r.simpleId();_isValid=true;_defines=[];_moduleNames=[];_moduleNumId=0;_needsRecompile=true;_compileReason="initial";_modules=[];_compileCount=0;logError=true;num=-1;lastCompile=0;constructor(){super()}setWhyCompile(e){this._compileReason=e;this._needsRecompile=true}getWhyCompile(){return this._compileReason}needsRecompile(){return this._needsRecompile}removeUniform(t){for(let e=0;e<this._uniforms.length;e++){if(this._uniforms[e].getName()==t){this._uniforms.splice(e,1)}}this.setWhyCompile("remove uniform "+t)}hasUniformInStage(t,e){let i=this.defaultUniBindingFrag;if(e==GPUShaderStage.VERTEX)i=this.defaultUniBindingVert;if(e==GPUShaderStage.COMPUTE)i=this.defaultUniBindingCompute;for(let e=0;e<this._uniforms.length;e++){console.log("hasuniiiiiiiiiiiiiii",this._uniforms[e].getName(),t);if(this._uniforms[e].getName()==t)return true}return false}hasUniform(e){}toggleDefine(t,e){if(e&&typeof e=="object"&&e.addEventListener){if(e.changeListener)e.off(e.changeListener);e.onToggleDefine=e=>{this.toggleDefine(t,e)};e.changeListener=e.on("change",e.onToggleDefine);e=e.get()}if(e)this.define(t);else this.removeDefine(t)}define(t,i=""){if(i===null||i===undefined)i="";if(typeof i=="object"){i.removeEventListener("change",i.onDefineChange);i.onDefineChange=e=>{this.define(t,e)};i.on("change",i.onDefineChange);i=i.get()}for(let e=0;e<this._defines.length;e++){if(this._defines[e][0]==t&&this._defines[e][1]==i)return;if(this._defines[e][0]==t){this._defines[e][1]=i;this.setWhyCompile("define "+t+" "+i);return}}this.setWhyCompile("define "+t+" "+i);this._defines.push([t,i])}getDefines(){return this._defines}getDefine(t){for(let e=0;e<this._defines.length;e++)if(this._defines[e][0]==t)return this._defines[e][1];return null}hasDefine(t){for(let e=0;e<this._defines.length;e++)if(this._defines[e][0]==t)return true}removeDefine(t){for(let e=0;e<this._defines.length;e++){if(this._defines[e][0]==t){this._defines.splice(e,1);this.setWhyCompile("define removed:"+t);return}}}hasModule(t){for(let e=0;e<this._modules.length;e++)if(this._modules[e].id==t)return true;return false}setModules(e){this._moduleNames=e}removeModule(i){for(let e=0;e<this._modules.length;e++){if(i&&i.id){if(this._modules[e].id==i.id||!this._modules[e]){let t=true;while(t){t=false;for(let e=0;e<this._uniforms.length;e++){if(this._uniforms[e].getName().startsWith(i.prefix)){this._uniforms.splice(e,1);t=true;continue}}}this.setWhyCompile("remove module "+i.title);this._modules.splice(e,1);break}}}}getNumModules(){return this._modules.length}getCurrentModules(){return this._modules}addModule(e,t){if(this.hasModule(e.id))return;if(!e.id)e.id=r.simpleId();if(!e.numId)e.numId=this._moduleNumId;if(!e.num)e.num=this._modules.length;if(t&&!t.group)t.group=r.simpleId();if(!e.group)if(t)e.group=t.group;else e.group=r.simpleId();e.prefix="mod"+e.group+"_";this._modules.push(e);this.setWhyCompile("add module "+e.title);this._moduleNumId++;return e}isValid(){return this._isValid}}},356:(e,t,i)=>{"use strict";i.d(t,{U:()=>l});var s=i(562);const r=8;class l{constructor(e={}){this.id=s.uuid();this.width=0;this.height=0;this.name="unknown";e=e||{};this.pixelFormat=e.pixelFormat||l.PFORMATSTR_RGBA8UB;this.name=e.name||"unknown";if(!e.width)e.width=r;if(!e.height)e.height=r}}l.getDefaultTextureData=(e,n,a={})=>{if(e=="empty"){return new Uint8Array(n*n*4).fill(0)}else if(e=="color"){const r=new Uint8Array(n*n*4);let t=a.r||1;let i=a.g||1;let s=a.b||1;for(let e=0;e<n*n;e++){r[e*4+0]=t;r[e*4+1]=i;r[e*4+2]=s;r[e*4+3]=255}return r}else if(e=="randomUInt"){const r=new Uint8Array(n*n*4);for(let e=0;e<n*n;e++){r[e*4+0]=Math.random()*255;r[e*4+1]=Math.random()*255;r[e*4+2]=Math.random()*255;r[e*4+3]=255}return r}else if(e=="random"||e=="randomFloat"){const r=new Float32Array(n*n*4);for(let e=0;e<n*n;e++){r[e*4+0]=(Math.random()-.5)*2;r[e*4+1]=(Math.random()-.5)*2;r[e*4+2]=(Math.random()-.5)*2;r[e*4+3]=1}return r}else if(e=="stripes"){const o=[];let i=a.r;let s=a.g;let r=a.b;if(i===undefined)i=1;if(s===undefined)s=1;if(r===undefined)r=1;for(let t=0;t<n;t++){for(let e=0;e<n;e++){if((e+t)%64<32){o.push((200+t/n*25+e/n*25)*i);o.push((200+t/n*25+e/n*25)*s);o.push((200+t/n*25+e/n*25)*r)}else{o.push((40+t/n*25+e/n*25)*i);o.push((40+t/n*25+e/n*25)*s);o.push((40+t/n*25+e/n*25)*r)}o.push(255)}}return new Uint8Array(o)}else{console.warn("unknown default texture",e);return l.getDefaultTextureData("stripes",n,{r:1,g:0,b:0})}};l.FILTER_NEAREST=0;l.FILTER_LINEAR=1;l.FILTER_MIPMAP=2;l.WRAP_REPEAT=0;l.WRAP_MIRRORED_REPEAT=1;l.WRAP_CLAMP_TO_EDGE=2;l.TYPE_DEFAULT=0;l.TYPE_DEPTH=1;l.TYPE_FLOAT=2;l.PFORMATSTR_RGB565="RGB 5/6/5bit ubyte";l.PFORMATSTR_R8UB="R 8bit ubyte";l.PFORMATSTR_RG8UB="RG 8bit ubyte";l.PFORMATSTR_RGB8UB="RGB 8bit ubyte";l.PFORMATSTR_RGBA8UB="RGBA 8bit ubyte";l.PFORMATSTR_SRGBA8="SRGBA 8bit ubyte";l.PFORMATSTR_R11FG11FB10F="RGB 11/11/10bit float";l.PFORMATSTR_R16F="R 16bit float";l.PFORMATSTR_RG16F="RG 16bit float";l.PFORMATSTR_RGB16F="RGB 16bit float";l.PFORMATSTR_RGBA16F="RGBA 16bit float";l.PFORMATSTR_R32F="R 32bit float";l.PFORMATSTR_RG32F="RG 32bit float";l.PFORMATSTR_RGB32F="RGB 32bit float";l.PFORMATSTR_RGBA32F="RGBA 32bit float";l.PFORMATSTR_DEPTH="DEPTH";l.PIXELFORMATS=[l.PFORMATSTR_RGB565,l.PFORMATSTR_R8UB,l.PFORMATSTR_RG8UB,l.PFORMATSTR_RGB8UB,l.PFORMATSTR_RGBA8UB,l.PFORMATSTR_SRGBA8,l.PFORMATSTR_R11FG11FB10F,l.PFORMATSTR_R16F,l.PFORMATSTR_RG16F,l.PFORMATSTR_RGBA16F,l.PFORMATSTR_R32F,l.PFORMATSTR_RGBA32F]},475:(e,t,i)=>{"use strict";i.d(t,{v:()=>s});var u=i(849);var c=i(50);class s{constructor(e,t,i,s,r,n,a,o,l,h){this._log=new u.A("cg_uniform");this._type=t;this._name=i;this._shader=e;this._value=1e-5;this._oldValue=null;this._port=null;this._structName=l;this._structUniformName=o;this._propertyName=h;if(this._shader._addUniform)this._shader._addUniform(this);this.needsUpdate=true;this.shaderType=null;this.comment=null;if(t=="f"){this.set=this.setValue=this.setValueF.bind(this);this.updateValue=this.updateValueF.bind(this)}else if(t=="f[]"){this.set=this.setValue=this.setValueArrayF.bind(this);this.updateValue=this.updateValueArrayF.bind(this)}else if(t=="2f[]"){this.set=this.setValue=this.setValueArray2F.bind(this);this.updateValue=this.updateValueArray2F.bind(this)}else if(t=="3f[]"){this.set=this.setValue=this.setValueArray3F.bind(this);this.updateValue=this.updateValueArray3F.bind(this)}else if(t=="4f[]"){this.set=this.setValue=this.setValueArray4F.bind(this);this.updateValue=this.updateValueArray4F.bind(this)}else if(t=="i"){this.set=this.setValue=this.setValueI.bind(this);this.updateValue=this.updateValueI.bind(this)}else if(t=="2i"){this.set=this.setValue=this.setValue2I.bind(this);this.updateValue=this.updateValue2I.bind(this)}else if(t=="3i"){this.set=this.setValue=this.setValue3I.bind(this);this.updateValue=this.updateValue3I.bind(this)}else if(t=="4i"){this.set=this.setValue=this.setValue4I.bind(this);this.updateValue=this.updateValue4I.bind(this)}else if(t=="b"){this.set=this.setValue=this.setValueBool.bind(this);this.updateValue=this.updateValueBool.bind(this)}else if(t=="4f"){this.set=this.setValue=this.setValue4F.bind(this);this.updateValue=this.updateValue4F.bind(this)}else if(t=="3f"){this.set=this.setValue=this.setValue3F.bind(this);this.updateValue=this.updateValue3F.bind(this)}else if(t=="2f"){this.set=this.setValue=this.setValue2F.bind(this);this.updateValue=this.updateValue2F.bind(this)}else if(t=="t"){this.set=this.setValue=this.setValueT.bind(this);this.updateValue=this.updateValueT.bind(this)}else if(t=="sampler"){if(this.setValueAny){this.set=this.setValue=this.setValueAny.bind(this);this.updateValue=this.updateValueAny.bind(this)}}else if(t=="tc"){this.set=this.setValue=this.setValueT.bind(this);this.updateValue=this.updateValueT.bind(this)}else if(t=="t[]"){this.set=this.setValue=this.setValueArrayT.bind(this);this.updateValue=this.updateValueArrayT.bind(this)}else if(t=="m4"||t=="m4[]"){this.set=this.setValue=this.setValueM4.bind(this);this.updateValue=this.updateValueM4.bind(this)}else{this._log.error("Unknown uniform type "+t,i,typeof this._shader)}if(typeof s=="object"&&s instanceof c.I){this._port=s;this._value=this._port.get();if(r&&n&&a){if(!(r instanceof c.I)||!(n instanceof c.I)||!(a instanceof c.I)){this._log.error("[cgl_uniform] mixed port/value parameter for vec4 ",this._name)}this._value=[0,0,0,0];this._port2=r;this._port3=n;this._port4=a;this._port.on("change",this.updateFromPort4f.bind(this));this._port2.on("change",this.updateFromPort4f.bind(this));this._port3.on("change",this.updateFromPort4f.bind(this));this._port4.on("change",this.updateFromPort4f.bind(this));this.updateFromPort4f()}else if(r&&n){if(!(r instanceof c.I)||!(n instanceof c.I)){this._log.error("[cgl_uniform] mixed port/value parameter for vec4 ",this._name)}this._value=[0,0,0];this._port2=r;this._port3=n;this._port.on("change",this.updateFromPort3f.bind(this));this._port2.on("change",this.updateFromPort3f.bind(this));this._port3.on("change",this.updateFromPort3f.bind(this));this.updateFromPort3f()}else if(r){if(!(r instanceof c.I)){this._log.error("[cgl_uniform] mixed port/value parameter for vec4 ",this._name)}this._value=[0,0];this._port2=r;this._port.on("change",this.updateFromPort2f.bind(this));this._port2.on("change",this.updateFromPort2f.bind(this));this.updateFromPort2f()}else{this._port.on("change",this.updateFromPort.bind(this))}}else this._value=s;if(this._value==undefined){this._value=0}this.setValue(this._value);this.needsUpdate=true}getType(){return this._type}get type(){return this._type}get name(){return this._name}getName(){return this._name}getValue(){return this._value}getShaderType(){return this.shaderType}isStructMember(){return!!this._structName}updateFromPort4f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this._value[3]=this._port4.get();this.setValue(this._value)}updateFromPort3f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this.setValue(this._value)}updateFromPort2f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this.setValue(this._value)}updateFromPort(){this.setValue(this._port.get())}get port(){return this._port}}},748:(e,t,i)=>{"use strict";var s=i(823);var r=i(522);var n=i(964);var a=i(409);var o=i(684);var l=i(221);var h=i(991);var u=i(842);var c=i(329);var f=i(796);var g=i(982);var d=i(223);var m=i(331);var p=i(294);const _={DEPTH_COMPARE_NEVER:0,DEPTH_COMPARE_LESS:1,DEPTH_COMPARE_EQUAL:2,DEPTH_COMPARE_LESSEQUAL:3,DEPTH_COMPARE_GREATER:4,DEPTH_COMPARE_NOTEQUAL:5,DEPTH_COMPARE_GREATEREQUAL:6,DEPTH_COMPARE_ALWAYS:7,CULL_NONE:0,CULL_BACK:1,CULL_FRONT:2,CULL_BOTH:3,Geometry:m.V,BoundingBox:g.I,FpsCounter:p.K,CgCanvas:d.f};window.CABLES=window.CABLES||{};window.CABLES.CG=window.CABLES.CG||_;window.CG=window.CG||_;window.glMatrix=s;window.mat2=r;window.mat2d=n;window.mat3=a;window.mat4=o;window.quat=l;window.quat2=h;window.vec2=u;window.vec3=c;window.vec4=f},264:(e,t,i)=>{"use strict";i.d(t,{C:()=>f,e:()=>o});var r=i(849);var n=i(562);var s=i(923);var c=i(997);var a=i(434);const f={};f.lastMesh=null;class o extends a.w{#cgl=null;#geom=null;#bufVerticesIndizes=null;constructor(e,t,i={}){super();this.#cgl=e;let s=i||{};if(n.isNumeric(s))s={glPrimitive:i};this._log=new r.A("cgl_mesh");this._bufVertexAttrib=null;this.#bufVerticesIndizes=this.#cgl.gl.createBuffer();this._indexType=this.#cgl.gl.UNSIGNED_SHORT;this._attributes=[];this._attribLocs={};this._lastShader=null;this._numInstances=0;this._glPrimitive=s.glPrimitive;this.opId=s.opId||"";this._preWireframeGeom=null;this.addVertexNumbers=false;this.feedBackAttributes=[];this.setGeom(t);this._feedBacks=[];this._feedBacksChanged=false;this._transformFeedBackLoc=-1;this._lastAttrUpdate=0;this.memFreed=false;this.#cgl.profileData.addHeavyEvent("mesh constructed",this._name);this._queryExt=null}get geom(){return this.#geom}get numInstances(){return this._numInstances}set numInstances(e){this.setNumInstances(e)}freeMem(){this.memFreed=true;for(let e=0;e<this._attributes.length;e++)this._attributes[e].floatArray=null}updateVertices(e){this.setAttribute(c.a.SHADER.SHADERVAR_VERTEX_POSITION,e.vertices,3);this._numVerts=e.vertices.length/3}setAttributePointer(t,i,s,r){for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].name==t){if(!this._attributes[e].pointer)this._attributes[e].pointer=[];this._attributes[e].pointer.push({loc:-1,name:i,stride:s,offset:r,instanced:t==c.a.SHADER.SHADERVAR_INSTANCE_MMATRIX})}}}getAttribute(t){for(let e=0;e<this._attributes.length;e++)if(this._attributes[e].name==t)return this._attributes[e]}setAttributeRange(e,t,i,s){if(!e)return;if(!i&&!s)return;if(!e.name)this._log.stack("no attrname?!");const r=this.#cgl.gl;r.bindBuffer(r.ARRAY_BUFFER,e.buffer);this.#cgl.profileData.profileMeshAttributes+=s-i||0;this.#cgl.profileData.profileSingleMeshAttribute[this._name]=this.#cgl.profileData.profileSingleMeshAttribute[this._name]||0;this.#cgl.profileData.profileSingleMeshAttribute[this._name]+=s-i||0;if(e.numItems<t.length/e.itemSize){this._resizeAttr(t,e)}if(s>t.length&&!this.warned){this.warned=true;this._log.warn(this.#cgl.canvas.id+" "+e.name+" buffersubdata out of bounds ?",t.length,s,i,e);return}r.bufferSubData(r.ARRAY_BUFFER,i*4,t,i,s-i)}_resizeAttr(e,t){const i=this.#cgl.gl;if(t.buffer)i.deleteBuffer(t.buffer);t.buffer=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,t.buffer);this._bufferArray(e,t);t.numItems=e.length/t.itemSize}_bufferArray(e,t){let i=t.floatArray||null;if(!e)return;if(this.#cgl.debugOneFrame){console.log("_bufferArray",e.length,t.name)}if(!(e instanceof Float32Array)){if(t&&i&&i.length==e.length){i.set(e)}else{i=new Float32Array(e);if(this.#cgl.debugOneFrame){console.log("_bufferArray create new float32array",e.length,t.name)}if(e.length>1e4){this.#cgl.profileData.profileNonTypedAttrib++;this.#cgl.profileData.profileNonTypedAttribNames="("+this._name+":"+t.name+")"}}}else i=e;t.arrayLength=i.length;t.floatArray=null;this.#cgl.gl.bufferData(this.#cgl.gl.ARRAY_BUFFER,i,this.#cgl.gl.DYNAMIC_DRAW)}addAttribute(e,t,i,s){this.setAttribute(e,t,i,s)}setAttribute(e,t,i,s={}){if(!t){this._log.error("mesh addAttribute - no array given! "+e);throw new Error}let r=null;let n=false;let a=0;const o=t.length/i;this.#cgl.profileData.profileMeshAttributes+=o||0;if(typeof s=="function"){r=s}if(typeof s=="object"){if(s.cb)r=s.cb;if(s.instanced)n=s.instanced}if(e==c.a.SHADER.SHADERVAR_INSTANCE_MMATRIX)n=true;for(a=0;a<this._attributes.length;a++){const u=this._attributes[a];if(u.name==e){if(u.numItems===o){}else{this._resizeAttr(t,u)}this.#cgl.gl.bindBuffer(this.#cgl.gl.ARRAY_BUFFER,u.buffer);this._bufferArray(t,u);return u}}const l=this.#cgl.gl.createBuffer();this.#cgl.gl.bindBuffer(this.#cgl.gl.ARRAY_BUFFER,l);let h=this.#cgl.gl.FLOAT;if(s&&s.type)h=s.type;const u={buffer:l,name:e,cb:r,itemSize:i,numItems:o,startItem:0,instanced:n,type:h};this._bufferArray(t,u);if(e==c.a.SHADER.SHADERVAR_VERTEX_POSITION)this._bufVertexAttrib=u;this._attributes.push(u);this._attribLocs={};return u}getAttributes(){return this._attributes}updateTexCoords(e){if(e.texCoords&&e.texCoords.length>0){this.setAttribute(c.a.SHADER.SHADERVAR_VERTEX_TEXCOORD,e.texCoords,2)}else{const t=new Float32Array(Math.round(e.vertices.length/3*2));this.setAttribute(c.a.SHADER.SHADERVAR_VERTEX_TEXCOORD,t,2)}}updateNormals(e){if(e.vertexNormals&&e.vertexNormals.length>0){this.setAttribute(c.a.SHADER.SHADERVAR_VERTEX_NORMAL,e.vertexNormals,3)}else{const t=new Float32Array(Math.round(e.vertices.length));this.setAttribute(c.a.SHADER.SHADERVAR_VERTEX_NORMAL,t,3)}}_setVertexNumbers(e=null){if(!this._verticesNumbers||this._verticesNumbers.length!=this._numVerts||e){if(e)this._verticesNumbers=e;else{this._verticesNumbers=new Float32Array(this._numVerts);for(let e=0;e<this._numVerts;e++)this._verticesNumbers[e]=e}this.setAttribute(c.a.SHADER.SHADERVAR_VERTEX_NUMBER,this._verticesNumbers,1,(e,t,i)=>{if(!i.uniformNumVertices)i.uniformNumVertices=new s.n(i,"f","numVertices",this._numVerts);i.uniformNumVertices.setValue(this._numVerts)})}}setVertexIndices(t){if(!this.#bufVerticesIndizes){this._log.warn("no bufVerticesIndizes: "+this._name);return}if(t.length>0){if(t instanceof Float32Array)this._log.warn("vertIndices float32Array: "+this._name);for(let e=0;e<t.length;e++){if(t[e]>=this._numVerts){this._log.warn("invalid index in "+this._name,e,t[e]);return}}this.#cgl.gl.bindBuffer(this.#cgl.gl.ELEMENT_ARRAY_BUFFER,this.#bufVerticesIndizes);if(t.length>65535){this.vertIndicesTyped=new Uint32Array(t);this._indexType=this.#cgl.gl.UNSIGNED_INT}else if(t instanceof Uint32Array){this.vertIndicesTyped=t;this._indexType=this.#cgl.gl.UNSIGNED_INT}else if(!(t instanceof Uint16Array)){this.vertIndicesTyped=new Uint16Array(t);this._indexType=this.#cgl.gl.UNSIGNED_SHORT}else this.vertIndicesTyped=t;this.#cgl.gl.bufferData(this.#cgl.gl.ELEMENT_ARRAY_BUFFER,this.vertIndicesTyped,this.#cgl.gl.DYNAMIC_DRAW);this.#bufVerticesIndizes.itemSize=1;this.#bufVerticesIndizes.numItems=t.length}else this.#bufVerticesIndizes.numItems=0}setGeom(e,t=false){this.#geom=e;if(e.glPrimitive!=null)this._glPrimitive=e.glPrimitive;if(this.#geom&&this.#geom.name)this._name="mesh "+this.#geom.name;f.lastMesh=null;this.#cgl.profileData.profileMeshSetGeom++;this._disposeAttributes();this.updateVertices(this.#geom);this.setVertexIndices(this.#geom.verticesIndices);if(this.addVertexNumbers)this._setVertexNumbers();const i=this.#geom.getAttributes();const s={texCoords:c.a.SHADER.SHADERVAR_VERTEX_TEXCOORD,vertexNormals:c.a.SHADER.SHADERVAR_VERTEX_NORMAL,vertexColors:c.a.SHADER.SHADERVAR_VERTEX_COLOR,tangents:"attrTangent",biTangents:"attrBiTangent"};for(const r in i)if(i[r].data&&i[r].data.length)this.setAttribute(s[r]||r,i[r].data,i[r].itemSize);if(t){this.#geom=null}}_preBind(t){for(let e=0;e<this._attributes.length;e++)if(this._attributes[e].cb)this._attributes[e].cb(this._attributes[e],this.#geom,t)}_checkAttrLengths(){if(this.memFreed)return;for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].arrayLength/this._attributes[e].itemSize<this._attributes[0].arrayLength/this._attributes[0].itemSize){let e="unknown";if(this.#geom)e=this.#geom.name}}}_bind(t){if(!t)return;if(!t.isValid())return;let i=[];if(this._attribLocs[t.id])i=this._attribLocs[t.id];else this._attribLocs[t.id]=i;this._lastShader=t;if(t.lastCompile>this._lastAttrUpdate||i.length!=this._attributes.length){this._lastAttrUpdate=t.lastCompile;for(let e=0;e<this._attributes.length;e++)i[e]=-1}for(let e=0;e<this._attributes.length;e++){const s=this._attributes[e];if(i[e]==-1){if(s._attrLocationLastShaderTime!=t.lastCompile){s._attrLocationLastShaderTime=t.lastCompile;i[e]=this.#cgl.glGetAttribLocation(t.getProgram(),s.name);this.#cgl.profileData.profileAttrLoc++}}if(i[e]!=-1){this.#cgl.gl.enableVertexAttribArray(i[e]);this.#cgl.gl.bindBuffer(this.#cgl.gl.ARRAY_BUFFER,s.buffer);if(s.instanced){if(s.itemSize<=4){if(!s.itemSize||s.itemSize==0)this._log.warn("instanced attrib itemsize error",this.#geom.name,s);this.#cgl.gl.vertexAttribPointer(i[e],s.itemSize,s.type,false,s.itemSize*4,0);this.#cgl.gl.vertexAttribDivisor(i[e],1)}else if(s.itemSize==16){const r=16*4;this.#cgl.gl.vertexAttribPointer(i[e],4,s.type,false,r,0);this.#cgl.gl.enableVertexAttribArray(i[e]+1);this.#cgl.gl.vertexAttribPointer(i[e]+1,4,s.type,false,r,4*4*1);this.#cgl.gl.enableVertexAttribArray(i[e]+2);this.#cgl.gl.vertexAttribPointer(i[e]+2,4,s.type,false,r,4*4*2);this.#cgl.gl.enableVertexAttribArray(i[e]+3);this.#cgl.gl.vertexAttribPointer(i[e]+3,4,s.type,false,r,4*4*3);this.#cgl.gl.vertexAttribDivisor(i[e],1);this.#cgl.gl.vertexAttribDivisor(i[e]+1,1);this.#cgl.gl.vertexAttribDivisor(i[e]+2,1);this.#cgl.gl.vertexAttribDivisor(i[e]+3,1)}else{this._log.warn("unknown instance attrib size",s.name)}}else{if(!s.itemSize||s.itemSize==0)this._log.warn("attrib itemsize error",this._name,s);this.#cgl.gl.vertexAttribPointer(i[e],s.itemSize,s.type,false,s.itemSize*4,0);if(s.pointer){for(let e=0;e<s.pointer.length;e++){const n=s.pointer[e];if(n.loc==-1)n.loc=this.#cgl.glGetAttribLocation(t.getProgram(),n.name);this.#cgl.profileData.profileAttrLoc++;this.#cgl.gl.enableVertexAttribArray(n.loc);this.#cgl.gl.vertexAttribPointer(n.loc,s.itemSize,s.type,false,n.stride,n.offset)}}if(this.bindFeedback)this.bindFeedback(s)}}}if(this.#bufVerticesIndizes&&this.#bufVerticesIndizes.numItems!==0)this.#cgl.gl.bindBuffer(this.#cgl.gl.ELEMENT_ARRAY_BUFFER,this.#bufVerticesIndizes)}unBind(){const e=this._lastShader;this._lastShader=null;if(!e)return;let t=[];if(this._attribLocs[e.id])t=this._attribLocs[e.id];else this._attribLocs[e.id]=t;f.lastMesh=null;for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].instanced){if(this._attributes[e].itemSize<=4){if(t[e]!=-1)this.#cgl.gl.vertexAttribDivisor(t[e],0);if(t[e]>=0)this.#cgl.gl.disableVertexAttribArray(t[e])}else{this.#cgl.gl.vertexAttribDivisor(t[e],0);this.#cgl.gl.vertexAttribDivisor(t[e]+1,0);this.#cgl.gl.vertexAttribDivisor(t[e]+2,0);this.#cgl.gl.vertexAttribDivisor(t[e]+3,0);this.#cgl.gl.disableVertexAttribArray(t[e]+1);this.#cgl.gl.disableVertexAttribArray(t[e]+2);this.#cgl.gl.disableVertexAttribArray(t[e]+3)}}if(t[e]!=-1)this.#cgl.gl.disableVertexAttribArray(t[e])}}meshChanged(){return this.#cgl.lastMesh&&this.#cgl.lastMesh!=this}printDebug(){console.log("--attributes");for(let e=0;e<this._attributes.length;e++){console.log("attribute "+e+" "+this._attributes[e].name)}}setNumVertices(e){this._bufVertexAttrib.numItems=e}getNumVertices(){return this._bufVertexAttrib.numItems}setNumIndices(e){this.#bufVerticesIndizes.numItems=e}getNumIndices(){return this.#bufVerticesIndizes.numItems}render(i){if(this.#cgl.aborted)return;i=i||this.#cgl.getShader();if(!i){return console.log("shader not valid")}if(!i.isValid()){i=this.#cgl.getErrorShader()}this._checkAttrLengths();if(this.#geom){if(this._preWireframeGeom&&!i.wireframe&&!this.#geom.isIndexed()){this.setGeom(this._preWireframeGeom);this._preWireframeGeom=null}if(i.wireframe){let e=false;if(this.#geom.isIndexed()){if(!this._preWireframeGeom){this._preWireframeGeom=this.#geom;this.#geom=this.#geom.copy()}this.#geom.unIndex();e=true}if(!this.#geom.getAttribute("attrBarycentric")){if(!this._preWireframeGeom){this._preWireframeGeom=this.#geom;this.#geom=this.#geom.copy()}e=true;this.#geom.calcBarycentric()}if(e)this.setGeom(this.#geom)}}let e=false;if(f.lastMesh!=this){if(f.lastMesh)f.lastMesh.unBind();e=true}if(e)this._preBind(i);if(!i.bind())return;this._bind(i);if(this.addVertexNumbers)this._setVertexNumbers();f.lastMesh=this;let t=this.#cgl.gl.TRIANGLES;if(this._glPrimitive!==undefined)t=this._glPrimitive;if(i.glPrimitive!==null)t=i.glPrimitive;let s=1;let r=this.#cgl.profileData.doProfileGlQuery;let n=false;if(r){let e=this._name+" - "+i.getName()+" #"+i.id;if(this._numInstances)e+=" instanced "+this._numInstances+"x";let t=this.#cgl.profileData.glQueryData[e];if(!t)t={id:e,num:0};if(i.opId)t.shaderOp=i.opId;if(this.opId)t.meshOp=this.opId;this.#cgl.profileData.glQueryData[e]=t;if(!this._queryExt&&this._queryExt!==false)this._queryExt=this.#cgl.enableExtension("EXT_disjoint_timer_query_webgl2")||false;if(this._queryExt){if(t._drawQuery){const a=this.#cgl.gl.getQueryParameter(t._drawQuery,this.#cgl.gl.QUERY_RESULT_AVAILABLE);if(a){const o=this.#cgl.gl.getQueryParameter(t._drawQuery,this.#cgl.gl.QUERY_RESULT);const l=o/1e6;t._times=t._times||0;t._times+=l;t._numcount++;t.when=performance.now();t._drawQuery=null;t.queryStarted=false}}if(!t.queryStarted){t._drawQuery=this.#cgl.gl.createQuery();this.#cgl.gl.beginQuery(this._queryExt.TIME_ELAPSED_EXT,t._drawQuery);n=t.queryStarted=true}}}if(this.hasFeedbacks&&this.hasFeedbacks())this.drawFeedbacks(i,t);else if(!this.#bufVerticesIndizes||this.#bufVerticesIndizes.numItems===0){if(t==this.#cgl.gl.TRIANGLES)s=3;if(this._numInstances===0)this.#cgl.gl.drawArrays(t,this._bufVertexAttrib.startItem,this._bufVertexAttrib.numItems-this._bufVertexAttrib.startItem);else this.#cgl.gl.drawArraysInstanced(t,this._bufVertexAttrib.startItem,this._bufVertexAttrib.numItems,this._numInstances)}else{if(t==this.#cgl.gl.TRIANGLES)s=3;if(this._numInstances===0){this.#cgl.gl.drawElements(t,this.#bufVerticesIndizes.numItems,this._indexType,0)}else{this.#cgl.gl.drawElementsInstanced(t,this.#bufVerticesIndizes.numItems,this._indexType,0,this._numInstances)}}if(this.#cgl.debugOneFrame&&this.#cgl.gl.getError()!=this.#cgl.gl.NO_ERROR){this._log.error("mesh draw gl error");this._log.error("mesh",this);this._log.error("shader",i);const h=[];for(let e=0;e<this.#cgl.gl.getProgramParameter(i.getProgram(),this.#cgl.gl.ACTIVE_ATTRIBUTES);e++){const u=this.#cgl.gl.getActiveAttrib(i.getProgram(),e).name;this._log.error("attrib ",u)}}this.#cgl.profileData.profileMeshNumElements+=this._bufVertexAttrib.numItems/s*(this._numInstances||1);this.#cgl.profileData.profileMeshDraw++;if(r&&n){this.#cgl.gl.endQuery(this._queryExt.TIME_ELAPSED_EXT)}this.#cgl.printError("mesh render "+this._name);this.unBind()}setNumInstances(t){t=Math.max(0,t);if(this._numInstances!=t){this._numInstances=t;const i=new Float32Array(t);for(let e=0;e<t;e++)i[e]=e;this.setAttribute(c.a.SHADER.SHADERVAR_INSTANCE_INDEX,i,1,{instanced:true})}}_disposeAttributes(){if(!this._attributes)return;for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].buffer){this.#cgl.gl.deleteBuffer(this._attributes[e].buffer);this._attributes[e].buffer=null}}this._attributes.length=0}dispose(){if(this.#cgl.aborted)return;if(this._bufVertexAttrib&&this._bufVertexAttrib.buffer)this.#cgl.gl.deleteBuffer(this._bufVertexAttrib.buffer);if(this.#bufVerticesIndizes)this.#cgl.gl.deleteBuffer(this.#bufVerticesIndizes);this.#bufVerticesIndizes=null;this._disposeAttributes();return null}}},460:(e,t,i)=>{"use strict";i.d(t,{E:()=>s});class s{constructor(e){this._cgl=e;this._lastTime=0;this.pause=false;this.profileUniformCount=0;this.profileShaderBinds=0;this.profileUniformCount=0;this.profileShaderCompiles=0;this.profileVideosPlaying=0;this.profileMVPMatrixCount=0;this.profileEffectBuffercreate=0;this.profileShaderGetUniform=0;this.profileFrameBuffercreate=0;this.profileMeshSetGeom=0;this.profileTextureNew=0;this.profileGenMipMap=0;this.profileOnAnimFrameOps=0;this.profileFencedPixelRead=0;this.profileMainloopMs=0;this.profileMeshDraw=0;this.profileTextureEffect=0;this.profileTexPreviews=0;this.shaderCompileTime=0;this.profileMeshNumElements=0;this.profileMeshAttributes=0;this.profileSingleMeshAttribute=[];this.heavyEvents=[];this.doProfileGlQuery=false;this.glQueryData={};this.counts={}}clear(){this.counts={};this.profileSingleMeshAttribute={};this.profileMeshAttributes=0;this.profileUniformCount=0;this.profileShaderGetUniform=0;this.profileShaderCompiles=0;this.profileShaderBinds=0;this.profileTextureResize=0;this.profileFrameBuffercreate=0;this.profileEffectBuffercreate=0;this.profileTextureDelete=0;this.profileMeshSetGeom=0;this.profileVideosPlaying=0;this.profileMVPMatrixCount=0;this.profileNonTypedAttrib=0;this.profileNonTypedAttribNames="";this.profileTextureNew=0;this.profileGenMipMap=0;this.profileFramebuffer=0;this.profileMeshDraw=0;this.profileTextureEffect=0;this.profileTexPreviews=0;this.profileMeshNumElements=0;this.profileFencedPixelRead=0}clearGlQuery(){for(let e in this.glQueryData){if(!this.glQueryData[e].lastClear||performance.now()-this.glQueryData[e].lastClear>1e3){this.glQueryData[e].time=this.glQueryData[e]._times/this.glQueryData[e]._numcount;this.glQueryData[e].num=this.glQueryData[e]._numcount;this.glQueryData[e]._times=0;this.glQueryData[e]._numcount=0;this.glQueryData[e].lastClear=performance.now()}}}count(e,t){this.counts[e]=this.counts[e]||[];this.counts[e].push(t)}addHeavyEvent(e,t,i){const s={event:e,name:t,info:i,date:performance.now()};this.heavyEvents.push(s);this._cgl.emitEvent("heavyEvent",s)}}},24:(e,t,i)=>{"use strict";i.d(t,{M:()=>c});var s=i(849);var r=i(684);var T=i(920);var n=i(960);var A=i(264);var S=i(997);var a=i(694);var o=i(70);var l=i(923);const h=`
{{MODULES_HEAD}}
IN vec3 vPosition; //!@
IN vec2 attrTexCoord;
IN vec3 attrVertNormal;
IN vec3 attrTangent,attrBiTangent;

IN float attrVertIndex;

OUT vec2 texCoord;
OUT vec3 norm;
UNI mat4 projMatrix;
UNI mat4 viewMatrix;
UNI mat4 modelMatrix;

void main()
{
    texCoord=attrTexCoord;
    norm=attrVertNormal;
    vec4 pos=vec4(vPosition,  1.0);
    vec3 tangent=attrTangent;
    vec3 bitangent=attrBiTangent;
    mat4 mMatrix=modelMatrix;
    gl_PointSize=10.0;

    {{MODULE_VERTEX_POSITION}}

    mat4 modelViewMatrix=viewMatrix*mMatrix;
    {{MODULE_VERTEX_MODELVIEW}}

    gl_Position = projMatrix * modelViewMatrix * pos;
}
`;let u=0;function M(){return h}function I(e,t,i){if(e==undefined){e=.5;t=.5;i=.5}return""+S.nl+"IN vec2 texCoord;"+S.nl+"{{MODULES_HEAD}}"+S.nl+"void main()"+S.nl+"{"+S.nl+"    vec4 col=vec4("+e+","+t+","+i+",1.0);"+S.nl+"    {{MODULE_COLOR}}"+S.nl+"    outColor = col;"+S.nl+"}"}class c extends a.U{_uniforms=[];constructor(e,t,i){super();if(!e)throw new Error("shader constructed without cgl "+t);this._log=new s.A("cgl_shader");this._cgl=e;if(!t)this._log.stack("no shader name given");this._name=t||"unknown";if(i)this.opId=i.id;this.glslVersion=0;if(e.glVersion>1)this.glslVersion=300;this._materialId=++u;this._program=null;this._drawBuffers=[true];this.error=null;this.ignoreMissingUniforms=false;this._projMatrixUniform=null;this._mvMatrixUniform=null;this._mMatrixUniform=null;this._vMatrixUniform=null;this._camPosUniform=null;this._normalMatrixUniform=null;this._inverseViewMatrixUniform=null;this._fromUserInteraction=false;this._attrVertexPos=-1;this.precision=e.patch.config.glslPrecision||"highp";this._pMatrixState=-1;this._vMatrixState=-1;this._countMissingUniforms=0;this._modGroupCount=0;this._feedBackNames=[];this._attributes=[];this.glPrimitive=null;this.offScreenPass=false;this._extensions=[];this.srcVert=M();this.srcFrag=I();this.lastCompile=0;this._libs=[];this._structNames=[];this._structUniformNames=[];this._textureStackUni=[];this._textureStackTex=[];this._textureStackType=[];this._textureStackTexCgl=[];this._tempNormalMatrix=r.create();this._tempCamPosMatrix=r.create();this._tempInverseViewMatrix=r.create();this._tempInverseProjMatrix=r.create();this.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_NORMAL","MODULE_BEGIN_FRAG","MODULE_VERTEX_MODELVIEW"])}isValid(){return this._isValid}getCgl(){return this._cgl}getName(){return this._name}enableExtension(e){this.setWhyCompile("enable extension "+e);this._extensions.push(e)}getAttrVertexPos(){return this._attrVertexPos}hasTextureUniforms(){for(let e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getType()=="t")return true;return false}copyUniformValues(t){for(let e=0;e<t._uniforms.length;e++){if(!this._uniforms[e]){this._log.log("unknown uniform?!");continue}this.getUniform(t._uniforms[e].getName()).set(t._uniforms[e].getValue())}this.popTextures();for(let e=0;e<t._textureStackUni.length;e++){this._textureStackUni[e]=t._textureStackUni[e];this._textureStackTex[e]=t._textureStackTex[e];this._textureStackType[e]=t._textureStackType[e];this._textureStackTexCgl[e]=t._textureStackTexCgl[e]}}copy(){const t=new c(this._cgl,this._name+" copy");t.setSource(this.srcVert,this.srcFrag);t._modules=JSON.parse(JSON.stringify(this._modules));t._defines=JSON.parse(JSON.stringify(this._defines));t._modGroupCount=this._modGroupCount;t._moduleNames=this._moduleNames;t.glPrimitive=this.glPrimitive;t.offScreenPass=this.offScreenPass;t._extensions=this._extensions;t.wireframe=this.wireframe;t._attributes=this._attributes;for(let e=0;e<this._uniforms.length;e++){const i=this._uniforms[e].copy(t);i.resetLoc()}t.setWhyCompile("copy");return t}setSource(e,t,i=false){this._fromUserInteraction=i;this.srcVert=e;this.srcFrag=t;this.setWhyCompile("Source changed");this._isValid=true}_addLibs(e){for(const t in n.y){if(e.includes(t)){const i=new n.y[t];e=e.replace("{{"+t+"}}",i.srcHeadFrag);this._libs.push(i);if(i.initUniforms)i.initUniforms(this)}}return e}createStructUniforms(){let s="";let r="";this._structNames=[];this._injectedStringsFrag={};this._injectedStringsVert={};this._structUniformNamesIndicesFrag=[];this._structUniformNamesIndicesVert=[];for(let i=0;i<this._uniforms.length;i++){if(this._uniforms[i].isStructMember()){const n="{{INJECTION_POINT_STRUCT_"+this._uniforms[i]._structName+"}}";if(!this._structNames.includes(this._uniforms[i]._structName)){const a="struct "+this._uniforms[i]._structName+" {"+S.nl+n+"};"+S.nl+S.nl;if(this._uniforms[i].getShaderType()==="both"||this._uniforms[i].getShaderType()==="frag")s=s.concat(a);if(this._uniforms[i].getShaderType()==="both"||this._uniforms[i].getShaderType()==="vert")r=r.concat(a);this._structNames.push(this._uniforms[i]._structName);this._injectedStringsFrag[this._uniforms[i]._structName]=[];this._injectedStringsVert[this._uniforms[i]._structName]=[]}let e="";if(this._uniforms[i].comment)e=" // "+this._uniforms[i].comment;let t="";if(this._uniforms[i].getGlslTypeString()==undefined)t+="//";t+="  "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i]._propertyName+";"+e;if(this._uniforms[i].getShaderType()==="both"){if(!this._injectedStringsFrag[this._uniforms[i]._structName].includes(t)&&!this._injectedStringsVert[this._uniforms[i]._structName].includes(t)){const o=s.lastIndexOf(n);const l=r.lastIndexOf(n);s=s.slice(0,o)+t+s.slice(o-1);r=r.slice(0,l)+t+r.slice(l-1);this._injectedStringsFrag[this._uniforms[i]._structName].push(t);this._injectedStringsVert[this._uniforms[i]._structName].push(t)}if(!this._structUniformNamesIndicesFrag.includes(i))this._structUniformNamesIndicesFrag.push(i);if(!this._structUniformNamesIndicesVert.includes(i))this._structUniformNamesIndicesVert.push(i)}else if(this._uniforms[i].getShaderType()==="frag"){if(!this._injectedStringsFrag[this._uniforms[i]._structName].includes(t)){const o=s.lastIndexOf(n);s=s.slice(0,o)+t+s.slice(o-1);this._injectedStringsFrag[this._uniforms[i]._structName].push(t)}if(!this._structUniformNamesIndicesFrag.includes(i))this._structUniformNamesIndicesFrag.push(i)}else if(this._uniforms[i].getShaderType()==="vert"){if(!this._injectedStringsVert[this._uniforms[i]._structName].includes(t)){const l=r.lastIndexOf(n);r=r.slice(0,l)+t+r.slice(l-1);this._injectedStringsVert[this._uniforms[i]._structName].push(t)}if(!this._structUniformNamesIndicesVert.includes(i))this._structUniformNamesIndicesVert.push(i)}}}this._uniDeclarationsFrag=[];this._uniDeclarationsVert=[];for(let e=0;e<this._structUniformNamesIndicesFrag.length;e+=1){const t=this._structUniformNamesIndicesFrag[e];const i="UNI "+this._uniforms[t]._structName+" "+this._uniforms[t]._structUniformName+";"+S.nl;if(!this._uniDeclarationsFrag.includes(i)){const n="{{INJECTION_POINT_STRUCT_"+this._uniforms[t]._structName+"}}";s=s.replace(n,"");s+=i;this._uniDeclarationsFrag.push(i)}}for(let e=0;e<this._structUniformNamesIndicesVert.length;e+=1){const t=this._structUniformNamesIndicesVert[e];const i="UNI "+this._uniforms[t]._structName+" "+this._uniforms[t]._structUniformName+";"+S.nl;if(!this._uniDeclarationsVert.includes(i)){const n="{{INJECTION_POINT_STRUCT_"+this._uniforms[t]._structName+"}}";r=r.replace(n,"");r+=i;this._uniDeclarationsVert.push(i)}}return[r,s]}_getAttrSrc(e,t){const i={};if(e.name&&e.type){i.srcHeadVert="";if(!t)i.srcHeadVert+="#ifndef ATTRIB_"+e.name+S.nl;i.srcHeadVert+="#define ATTRIB_"+e.name+S.nl;i.srcHeadVert+="IN "+e.type+" "+e.name+";"+S.nl;if(!t)i.srcHeadVert+="#endif"+S.nl;if(e.nameFrag){i.srcHeadVert+="";if(!t)i.srcHeadVert+="#ifndef ATTRIB_"+e.nameFrag+S.nl;i.srcHeadVert+="#define ATTRIB_"+e.nameFrag+S.nl;i.srcHeadVert+="OUT "+e.type+" "+e.nameFrag+";"+S.nl;if(!t)i.srcHeadVert+="#endif"+S.nl;i.srcVert=""+S.nl+e.nameFrag+"="+e.name+";";i.srcHeadFrag="";if(!t)i.srcHeadFrag+="#ifndef ATTRIB_"+e.nameFrag+S.nl;i.srcHeadFrag+="#define ATTRIB_"+e.nameFrag+S.nl;i.srcHeadFrag+="IN "+e.type+" "+e.nameFrag+";"+S.nl;if(!t)i.srcHeadFrag+="#endif"+S.nl}}return i}compile(){if(this._cgl.aborted)return;const e=performance.now();this._cgl.profileData.profileShaderCompiles++;this._cgl.profileData.profileShaderCompileName=this._name+" ["+this._compileReason+"]";let t="";if(this._extensions)for(let e=0;e<this._extensions.length;e++)t+="#extension "+this._extensions[e]+" : enable"+S.nl;let i="";if(this._defines.length)i="\n// cgl generated"+S.nl;for(let e=0;e<this._defines.length;e++)i+="#define "+this._defines[e][0]+" "+this._defines[e][1]+""+S.nl;const s=this.createStructUniforms();this._cgl.profileData.addHeavyEvent("shader compile",this._name+" ["+this._compileReason+"]");this._compileReason="";if(this._uniforms){const p=this._uniforms.map(e=>{return e._name});const _=[];for(let e=0;e<this._uniforms.length;e++){const v=this._uniforms[e];const E=p.indexOf(v._name,e+1);if(E>-1)_.push(e)}for(let e=this._uniforms.length-1;e>=0;e-=1){if(_.includes(e))this._uniforms.splice(e,1);else this._uniforms[e].resetLoc()}}this._cgl.printError("uniform resets");this._compileCount++;if(this.hasTextureUniforms())i+="#define HAS_TEXTURES"+S.nl;let r="";let n="";if(!this.srcFrag){this._log.warn("[cgl shader] has no fragment source!",this._name,this);this.srcVert=M();this.srcFrag=I()}r="#version 300 es"+S.nl+"// "+S.nl+"// vertex shader "+this._name+S.nl+"// "+S.nl+"precision "+this.precision+" float;"+S.nl+"precision "+this.precision+" sampler2D;"+S.nl+""+S.nl+"#define WEBGL2"+S.nl+"#define texture2D texture"+S.nl+"#define UNI uniform"+S.nl+"#define IN in"+S.nl+"#define OUT out"+S.nl;n="#version 300 es"+S.nl+"// "+S.nl+"// fragment shader "+this._name+S.nl+"// "+S.nl+"precision "+this.precision+" float;"+S.nl+"precision "+this.precision+" sampler2D;"+S.nl+""+S.nl+"#define WEBGL2"+S.nl+"#define texture2D texture"+S.nl+"#define IN in"+S.nl+"#define OUT out"+S.nl+"#define UNI uniform"+S.nl+"{{DRAWBUFFER}}"+S.nl;let a="\n// cgl generated"+S.nl;let o="\n// cgl generated"+S.nl;n+="\n// active mods: --------------- ";r+="\n// active mods: --------------- ";let l=false;let h=false;for(let t=0;t<this._moduleNames.length;t++){for(let e=0;e<this._modules.length;e++){if(this._modules[e].name==this._moduleNames[t]){if(this._modules[e].srcBodyFrag||this._modules[e].srcHeadFrag){l=true;n+="\n// "+t+"."+e+". "+this._modules[e].title+" ("+this._modules[e].name+")"}if(this._modules[e].srcBodyVert||this._modules[e].srcHeadVert){r+="\n// "+t+"."+e+". "+this._modules[e].title+" ("+this._modules[e].name+")";h=true}}}}if(!h)n+="\n// no mods used...";if(!l)n+="\n// no mods used...";n+="\n";r+="\n";for(let i=0;i<this._uniforms.length;i++){if(this._uniforms[i].shaderType&&!this._uniforms[i].isStructMember()){let e="";if(!this._uniforms[i].getGlslTypeString())e+="// ";e+="UNI "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i].getName();let t="";if(this._uniforms[i].comment)t=" // "+this._uniforms[i].comment;if(this._uniforms[i].shaderType=="vert"||this._uniforms[i].shaderType=="both")if(!this.srcVert.includes(e)&&!this.srcVert.includes("uniform "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i].getName()))a+=e+";"+t+S.nl;if(this._uniforms[i].shaderType=="frag"||this._uniforms[i].shaderType=="both")if(!this.srcFrag.includes(e)&&!this.srcFrag.includes("uniform "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i].getName()))o+=e+";"+t+S.nl}}let u=0;let c=0;for(let e=0;e<this._uniforms.length;e++){if(this._uniforms[e].shaderType&&!this._uniforms[e].isStructMember()){if(this._uniforms[e].shaderType=="vert"||this._uniforms[e].shaderType=="both")c++;if(this._uniforms[e].shaderType=="frag"||this._uniforms[e].shaderType=="both")u++}}if(u>=this._cgl.maxUniformsFrag)this._log.warn("[cgl_shader] num uniforms frag: "+u+" / "+this._cgl.maxUniformsFrag);if(c>=this._cgl.maxUniformsVert)this._log.warn("[cgl_shader] num uniforms vert: "+c+" / "+this._cgl.maxUniformsVert);if(!n.includes("precision"))n="precision "+this.precision+" float;"+S.nl+n;if(!r.includes("precision"))r="precision "+this.precision+" float;"+S.nl+r;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){n+="#define MOBILE"+S.nl;r+="#define MOBILE"+S.nl}r=t+r+i+s[0]+a+"\n// -- \n"+this.srcVert;n=t+n+i+s[1]+o+"\n// -- \n"+this.srcFrag;let f="";let g="";this._modules.sort(function(e,t){return e.priority||0-t.priority||0});let d=false;for(let s=0;s<this._moduleNames.length;s++){let t="";let i="";if(!d){d=true;for(let e=0;e<this._attributes.length;e++){const b=this._getAttrSrc(this._attributes[e],true);if(b.srcHeadVert)f+=b.srcHeadVert;if(b.srcVert)t+=b.srcVert;if(b.srcHeadFrag)g+=b.srcHeadFrag}}for(let e=0;e<this._modules.length;e++){const x=this._modules[e];if(x.name==this._moduleNames[s]){f+="\n//---- MOD: group:"+x.group+": idx:"+e+" - prfx:"+x.prefix+" - "+x.title+" ------\n";g+="\n//---- MOD: group:"+x.group+": idx:"+e+" - prfx:"+x.prefix+" - "+x.title+" ------\n";t+="\n\n//---- MOD: "+x.title+" / "+x.priority+" ------\n";i+="\n\n//---- MOD: "+x.title+" / "+x.priority+" ------\n";if(x.attributes)for(let e=0;e<x.attributes.length;e++){const b=this._getAttrSrc(x.attributes[e],false);if(b.srcHeadVert)f+=b.srcHeadVert;if(b.srcVert)t+=b.srcVert;if(b.srcHeadFrag)g+=b.srcHeadFrag}f+=x.srcHeadVert||"";g+=x.srcHeadFrag||"";t+=x.srcBodyVert||"";i+=x.srcBodyFrag||"";f+="\n//---- end mod ------\n";g+="\n//---- end mod ------\n";t+="\n//---- end mod ------\n";i+="\n//---- end mod ------\n";t=t.replace(/{{mod}}/g,x.prefix);i=i.replace(/{{mod}}/g,x.prefix);f=f.replace(/{{mod}}/g,x.prefix);g=g.replace(/{{mod}}/g,x.prefix);t=t.replace(/MOD_/g,x.prefix);i=i.replace(/MOD_/g,x.prefix);f=f.replace(/MOD_/g,x.prefix);g=g.replace(/MOD_/g,x.prefix)}}r=r.replace("{{"+this._moduleNames[s]+"}}",t);n=n.replace("{{"+this._moduleNames[s]+"}}",i)}r=r.replace("{{MODULES_HEAD}}",f);n=n.replace("{{MODULES_HEAD}}",g);r=this._addLibs(r);n=this._addLibs(n);let m="";for(let e=0;e<16;e++)if(n.includes("outColor"+e))this._drawBuffers[e]=true;if(this._drawBuffers.length==1){m="out vec4 outColor;"+S.nl;m+="#define gl_FragColor outColor"+S.nl}else{m+="#define MULTI_COLORTARGETS"+S.nl;m+="vec4 outColor;"+S.nl;let t=0;for(let e=0;e<this._drawBuffers.length;e++){if(t==0)m+="#define gl_FragColor outColor"+e+""+S.nl;m+="layout(location = "+e+") out vec4 outColor"+e+";"+S.nl;t++}}n=n.replace("{{DRAWBUFFER}}",m);if(!this._program){this._program=this._createProgram(r,n)}else{this._program=this._createProgram(r,n);this._projMatrixUniform=null;for(let e=0;e<this._uniforms.length;e++)this._uniforms[e].resetLoc()}this.finalShaderFrag=n;this.finalShaderVert=r;A.C.lastMesh=null;A.C.lastShader=null;this._countMissingUniforms=0;this._needsRecompile=false;this.lastCompile=(0,T.tB)();this._cgl.profileData.shaderCompileTime+=performance.now()-e}bind(){if(!this._isValid||this._cgl.aborted)return;A.C.lastShader=this;if(!this._program||this.needsRecompile())this.compile();if(!this._isValid)return;if(!this._projMatrixUniform&&!this.ignoreMissingUniforms){this._countMissingUniforms++;if(this._countMissingUniforms<10){this._projMatrixUniform=this._cgl.gl.getUniformLocation(this._program,S.a.SHADER.SHADERVAR_UNI_PROJMAT);this._attrVertexPos=this._cgl.glGetAttribLocation(this._program,S.a.SHADER.SHADERVAR_VERTEX_POSITION);this._mvMatrixUniform=this._cgl.gl.getUniformLocation(this._program,"mvMatrix");this._vMatrixUniform=this._cgl.gl.getUniformLocation(this._program,S.a.SHADER.SHADERVAR_UNI_VIEWMAT);this._mMatrixUniform=this._cgl.gl.getUniformLocation(this._program,S.a.SHADER.SHADERVAR_UNI_MODELMAT);this._camPosUniform=this._cgl.gl.getUniformLocation(this._program,S.a.SHADER.SHADERVAR_UNI_VIEWPOS);this._normalMatrixUniform=this._cgl.gl.getUniformLocation(this._program,S.a.SHADER.SHADERVAR_UNI_NORMALMAT);this._inverseViewMatrixUniform=this._cgl.gl.getUniformLocation(this._program,S.a.SHADER.SHADERVAR_UNI_INVVIEWMAT);this._inverseProjMatrixUniform=this._cgl.gl.getUniformLocation(this._program,S.a.SHADER.SHADERVAR_UNI_INVPROJMAT);this._materialIdUniform=this._cgl.gl.getUniformLocation(this._program,S.a.SHADER.SHADERVAR_UNI_MATERIALID);this._objectIdUniform=this._cgl.gl.getUniformLocation(this._program,S.a.SHADER.SHADERVAR_UNI_OBJECTID);for(let e=0;e<this._uniforms.length;e++)this._uniforms[e].needsUpdate=true}}if(this._cgl.currentProgram!=this._program){this._cgl.profileData.profileShaderBinds++;this._cgl.gl.useProgram(this._program);this._cgl.currentProgram=this._program}for(let e=0;e<this._uniforms.length;e++)if(this._uniforms[e].needsUpdate)this._uniforms[e].updateValue();if(this._pMatrixState!=this._cgl.getProjectionMatrixStateCount()){this._pMatrixState=this._cgl.getProjectionMatrixStateCount();this._cgl.gl.uniformMatrix4fv(this._projMatrixUniform,false,this._cgl.pMatrix);this._cgl.profileData.profileMVPMatrixCount++}if(this._objectIdUniform)this._cgl.gl.uniform1f(this._objectIdUniform,++this._cgl.tempData.objectIdCounter);if(this._materialIdUniform)this._cgl.gl.uniform1f(this._materialIdUniform,this._materialId);if(this._vMatrixUniform){if(this._vMatrixState!=this._cgl.getViewMatrixStateCount()){this._cgl.gl.uniformMatrix4fv(this._vMatrixUniform,false,this._cgl.vMatrix);this._cgl.profileData.profileMVPMatrixCount++;this._vMatrixState=this._cgl.getViewMatrixStateCount();if(this._inverseViewMatrixUniform){r.invert(this._tempInverseViewMatrix,this._cgl.vMatrix);this._cgl.gl.uniformMatrix4fv(this._inverseViewMatrixUniform,false,this._tempInverseViewMatrix);this._cgl.profileData.profileMVPMatrixCount++}if(this._inverseProjMatrixUniform){r.invert(this._tempInverseProjMatrix,this._cgl.pMatrix);this._cgl.gl.uniformMatrix4fv(this._inverseProjMatrixUniform,false,this._tempInverseProjMatrix);this._cgl.profileData.profileMVPMatrixCount++}}this._cgl.gl.uniformMatrix4fv(this._mMatrixUniform,false,this._cgl.mMatrix);this._cgl.profileData.profileMVPMatrixCount++;if(this._camPosUniform){r.invert(this._tempCamPosMatrix,this._cgl.vMatrix);this._cgl.gl.uniform3f(this._camPosUniform,this._tempCamPosMatrix[12],this._tempCamPosMatrix[13],this._tempCamPosMatrix[14]);this._cgl.profileData.profileMVPMatrixCount++}}else{const e=r.create();r.mul(e,this._cgl.vMatrix,this._cgl.mMatrix);this._cgl.gl.uniformMatrix4fv(this._mvMatrixUniform,false,e);this._cgl.profileData.profileMVPMatrixCount++}if(this._normalMatrixUniform){r.invert(this._tempNormalMatrix,this._cgl.mMatrix);r.transpose(this._tempNormalMatrix,this._tempNormalMatrix);this._cgl.gl.uniformMatrix4fv(this._normalMatrixUniform,false,this._tempNormalMatrix);this._cgl.profileData.profileMVPMatrixCount++}for(let e=0;e<this._libs.length;e++){if(this._libs[e].onBind)this._libs[e].onBind.bind(this._libs[e])(this._cgl,this)}this._bindTextures();return this._isValid}unBind(){}dispose(){if(this._program&&this._cgl&&this._cgl.gl)this._cgl.gl.deleteProgram(this._program);this._program=null}setDrawBuffers(e){this._log.warn("useless drawbuffers...?!")}getUniforms(){return this._uniforms}getUniform(t){for(let e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()==t)return this._uniforms[e];return null}removeAllUniforms(){this._uniforms=[]}_addUniform(e){this._uniforms.push(e);this.setWhyCompile("add uniform "+name)}addUniformFrag(e,t,i,s,r,n){const a=new l.n(this,e,t,i,s,r,n);a.shaderType="frag";return a}addUniformVert(e,t,i,s,r,n){const a=new l.n(this,e,t,i,s,r,n);a.shaderType="vert";return a}addUniformBoth(e,t,i,s,r,n){const a=new l.n(this,e,t,i,s,r,n);a.shaderType="both";return a}addUniformStructFrag(t,i,s){const r={};if(!s)return r;for(let e=0;e<s.length;e+=1){const n=s[e];if(!this.hasUniform(i+"."+n.name)){const a=new l.n(this,n.type,i+"."+n.name,n.v1,n.v2,n.v3,n.v4,i,t,n.name);a.shaderType="frag";r[i+"."+n.name]=a}}return r}addUniformStructVert(t,i,s){const r={};if(!s)return r;for(let e=0;e<s.length;e+=1){const n=s[e];if(!this.hasUniform(i+"."+n.name)){const a=new l.n(this,n.type,i+"."+n.name,n.v1,n.v2,n.v3,n.v4,i,t,n.name);a.shaderType="vert";r[i+"."+n.name]=a}}return r}addUniformStructBoth(t,i,s){const r={};if(!s)return r;for(let e=0;e<s.length;e+=1){const n=s[e];if(n.type==="2i"||n.type==="i"||n.type==="3i")this._log.error("Adding an integer struct member to both shaders can potentially error. Please use different structs for each shader. Error occured in struct:",t," with member:",n.name," of type:",n.type,".");if(!this.hasUniform(i+"."+n.name)){const a=new l.n(this,n.type,i+"."+n.name,n.v1,n.v2,n.v3,n.v4,i,t,n.name);a.shaderType="both";r[i+"."+n.name]=a}}return r}_createProgram(e,t){this._cgl.printError("before _createprogram");const i=this._cgl.gl.createProgram();this.vshader=c.createShader(this._cgl,e,this._cgl.gl.VERTEX_SHADER,this);this.fshader=c.createShader(this._cgl,t,this._cgl.gl.FRAGMENT_SHADER,this);if(this.vshader&&this.fshader){this._cgl.gl.attachShader(i,this.vshader);this._cgl.gl.attachShader(i,this.fshader);this._linkProgram(i,e,t)}else{this._isValid=false;this._cgl.printError("shader _createProgram");this._log.error("could not link shaderprogram");return null}this._cgl.printError("shader _createProgram");return i}hasErrors(){return this._hasErrors}_linkProgram(e,t,i){this._cgl.printError("before _linkprogram");if(this._feedBackNames.length>0){this._cgl.gl.transformFeedbackVaryings(e,this._feedBackNames,this._cgl.gl.SEPARATE_ATTRIBS)}this._cgl.gl.linkProgram(e);this._cgl.printError("gl.linkprogram");this._isValid=true;this._hasErrors=false;if(this._cgl.patch.config.glValidateShader!==false){this._cgl.gl.validateProgram(e);if(!this._cgl.gl.getProgramParameter(e,this._cgl.gl.VALIDATE_STATUS)){this._log.log("shaderprogram validation failed...");this._cgl.gl.getProgramInfoLog(e)}if(!this._cgl.gl.getProgramParameter(e,this._cgl.gl.LINK_STATUS)){this._hasErrors=true;const s=this._cgl.gl.getShaderInfoLog(this.fshader);const r=this._cgl.gl.getShaderInfoLog(this.vshader);if(this.logError)this._log.error(this._name+" shader linking fail...");else this._log.warn(this._name+" shader linking fail...");if(s)this._log.warn(this._cgl.gl.getShaderInfoLog(this.fshader));if(r)this._log.warn(this._cgl.gl.getShaderInfoLog(this.vshader));this._cgl.gl.getProgramInfoLog(e);if(!CABLES.UI)this._log.log(this);this._isValid=false;this._cgl.printError("shader link err")}}}getProgram(){return this._program}setFeedbackNames(e){this.setWhyCompile("setFeedbackNames");this._feedBackNames=e}addAttribute(t){for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].name==t.name&&this._attributes[e].nameFrag==t.nameFrag)return}this._attributes.push(t);this.setWhyCompile("addAttribute")}bindTextures(){this._bindTextures()}_bindTextures(){if(this._textureStackTex.length>this._cgl.maxTextureUnits){this._log.warn("[shader._bindTextures] too many textures bound",this._textureStackTex.length+"/"+this._cgl.maxTextureUnits)}for(let i=0;i<this._textureStackTex.length;i++){if(!this._textureStackTex[i]&&!this._textureStackTexCgl[i]){this._log.warn("no texture for pushtexture",this._name)}else{let e=this._textureStackTex[i];if(this._textureStackTexCgl[i]){e=this._textureStackTexCgl[i].tex||CGL.Texture.getEmptyTexture(this._cgl).tex}let t=true;if(!this._textureStackUni[i]){this._log.warn("no uniform for pushtexture",this._name);t=this._cgl.setTexture(i,e,this._textureStackType[i])}else{this._textureStackUni[i].setValue(i);t=this._cgl.setTexture(i,e,this._textureStackType[i])}if(!t)this._log.warn("tex bind failed",this.getName(),this._textureStackUni[i])}}}setUniformTexture(t,i){i=i||o.g.getTempTexture(this._cgl);for(let e=0;e<this._textureStackUni.length;e++)if(this._textureStackUni[e]==t){const s=this._textureStackTex[e]||this._textureStackTexCgl[e];if(i.hasOwnProperty("tex")){this._textureStackTexCgl[e]=i;this._textureStackTex[e]=null}else{this._textureStackTexCgl[e]=null;this._textureStackTex[e]=i}return s}return null}pushTexture(e,t,i){if(!e){return}if(!t){return}if(!t.hasOwnProperty("tex")&&!(t instanceof WebGLTexture)){this._log.warn(new Error("invalid texture").stack);this._log.warn("[cgl_shader] invalid texture...",t);return}this._textureStackUni.push(e);if(t.hasOwnProperty("tex")){this._textureStackTexCgl.push(t);this._textureStackTex.push(null)}else{this._textureStackTexCgl.push(null);this._textureStackTex.push(t)}this._textureStackType.push(i)}popTexture(){this._textureStackUni.pop();this._textureStackTex.pop();this._textureStackTexCgl.pop();this._textureStackType.pop()}popTextures(){this._textureStackTex.length=this._textureStackTexCgl.length=this._textureStackType.length=this._textureStackUni.length=0}getMaterialId(){return this._materialId}getInfo(){const e={};e.name=this._name;e.defines=this.getDefines();e.hasErrors=this.hasErrors();return e}getDefaultFragmentShader(e,t,i,s){return I(e,t,i,s)}getDefaultVertexShader(){return M()}}c.getDefaultVertexShader=M;c.getDefaultFragmentShader=I;c.getErrorFragmentShader=function(){return""+S.nl+"void main()"+S.nl+"{"+S.nl+"   float g=mod((gl_FragCoord.y+gl_FragCoord.x),50.0)/50.0;"+S.nl+"   g= step(0.1,g);"+S.nl+"   outColor = vec4( g+0.5, 0.0, 0.0, 1.0);"+S.nl+"}"};c.createShader=function(e,t,i,s){if(e.aborted)return;const r=e.gl.createShader(i);e.gl.shaderSource(r,t);e.gl.compileShader(r);if(!e.gl.getShaderParameter(r,e.gl.COMPILE_STATUS)){s.error={str:t,infoLog:e.gl.getShaderInfoLog(r)};if(CABLES.UI)gui.emitEvent("ShaderError",s);if(!s.error.infoLog){s._log.warn("empty shader info log",this._name);return}s.setSource(c.getDefaultVertexShader(),c.getErrorFragmentShader())}return r}},960:(e,t,i)=>{"use strict";i.d(t,{y:()=>a});var s=i(923);var r=i(771);var n=i(70);const a={"CGL.BLENDMODES":function(){this.name="blendmodes";this.srcHeadFrag=r.p.getBlendCode()},"CGL.BLENDMODES3":function(){this.name="blendmodes3";this.srcHeadFrag=r.p.getBlendCode(3)},"CGL.LUMINANCE":function(){this.name="luminance";this.srcHeadFrag="".endl()+"float cgl_luminance(vec3 c)".endl()+"{".endl()+"    return dot(vec3(0.2126,0.7152,0.0722),c);".endl()+"}".endl()},"CGL.RANDOM_OLD":function(){this.name="randomNumber";this.srcHeadFrag="".endl()+"float cgl_random(vec2 co)".endl()+"{".endl()+"    return fract(sin(dot(co.xy ,vec2(12.9898,4.1414))) * 432758.5453);".endl()+"}".endl()+"vec3 cgl_random3(vec2 co)".endl()+"{".endl()+"    return vec3( cgl_random(co),cgl_random(co+0.5711),cgl_random(co+1.5711));".endl()+"}"},"CGL.RANDOM_LOW":function(){this.name="randomNumber";this.srcHeadFrag="".endl()+"float cgl_random(vec2 co)".endl()+"{".endl()+"    return fract(sin(dot(co.xy ,vec2(12.9898,4.1414))) * 358.5453);".endl()+"}".endl()+"vec3 cgl_random3(vec2 co)".endl()+"{".endl()+"    return vec3( cgl_random(co),cgl_random(co+0.5711),cgl_random(co+1.5711));".endl()+"}"},"CGL.RANDOM_TEX":function(){this.name="randomNumbertex";this.srcHeadFrag="".endl()+"UNI sampler2D CGLRNDTEX;".endl()+"float cgl_random(vec2 co)".endl()+"{".endl()+"    return texture(CGLRNDTEX,co*5711.0).r;".endl()+"}".endl()+"vec3 cgl_random3(vec2 co)".endl()+"{".endl()+"    return texture(CGLRNDTEX,co*5711.0).rgb;".endl()+"}";this.initUniforms=function(e){return[new s.n(e,"t","CGLRNDTEX",7)]};this.onBind=function(e,t){n.g.getRandomTexture(e);e.setTexture(7,n.g.getRandomTexture(e).tex)}}}},923:(e,t,i)=>{"use strict";i.d(t,{n:()=>r});var s=i(475);class r extends s.v{constructor(e,t,i,s,r,n,a,o,l,h){super(e,t,i,s,r,n,a,o,l,h);this._loc=-1;this._cgl=e._cgl}get name(){return this._name}copy(e){const t=new r(e,this._type,this._name,this._value,this._port2,this._port3,this._port4,this._structUniformName,this._structName,this._propertyName);t.shaderType=this.shaderType;return t}getGlslTypeString(){return r.glslTypeString(this._type)}_isValidLoc(){return this._loc!=-1}resetLoc(){this._loc=-1;this.needsUpdate=true}bindTextures(){}getLoc(){return this._loc}updateFromPort4f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this._value[3]=this._port4.get();this.setValue(this._value)}updateFromPort3f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this.setValue(this._value)}updateFromPort2f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this.setValue(this._value)}updateFromPort(){this.setValue(this._port.get())}updateValueF(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;this._shader.getCgl().gl.uniform1f(this._loc,this._value);this._cgl.profileData.profileUniformCount++}setValueF(e){if(e!=this._value){this.needsUpdate=true;this._value=e}}updateValueI(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;this._shader.getCgl().gl.uniform1i(this._loc,this._value);this._cgl.profileData.profileUniformCount++}updateValue2I(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform2i(this._loc,this._value[0],this._value[1]);this.needsUpdate=false;this._cgl.profileData.profileUniformCount++}updateValue3I(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform3i(this._loc,this._value[0],this._value[1],this._value[2]);this.needsUpdate=false;this._cgl.profileData.profileUniformCount++}updateValue4I(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform4i(this._loc,this._value[0],this._value[1],this._value[2],this._value[3]);this._cgl.profileData.profileUniformCount++}setValueI(e){if(e!=this._value){this.needsUpdate=true;this._value=e}}setValue2I(e){if(!e)return;if(!this._oldValue){this._oldValue=[e[0]-1,1];this.needsUpdate=true}else if(e[0]!=this._oldValue[0]||e[1]!=this._oldValue[1]){this._oldValue[0]=e[0];this._oldValue[1]=e[1];this.needsUpdate=true}this._value=e}setValue3I(e){if(!e)return;if(!this._oldValue){this._oldValue=[e[0]-1,1,2];this.needsUpdate=true}else if(e[0]!=this._oldValue[0]||e[1]!=this._oldValue[1]||e[2]!=this._oldValue[2]){this._oldValue[0]=e[0];this._oldValue[1]=e[1];this._oldValue[2]=e[2];this.needsUpdate=true}this._value=e}setValue4I(e){this.needsUpdate=true;this._value=e||vec4.create()}updateValueBool(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;this._shader.getCgl().gl.uniform1i(this._loc,this._value?1:0);this._cgl.profileData.profileUniformCount++}setValueBool(e){if(e!=this._value){this.needsUpdate=true;this._value=e}}setValueArray4F(e){this.needsUpdate=true;this._value=e}updateValueArray4F(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform4fv(this._loc,this._value);this._cgl.profileData.profileUniformCount++}setValueArray3F(e){this.needsUpdate=true;this._value=e}updateValueArray3F(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform3fv(this._loc,this._value);this._cgl.profileData.profileUniformCount++}setValueArray2F(e){this.needsUpdate=true;this._value=e}updateValueArray2F(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform2fv(this._loc,this._value);this._cgl.profileData.profileUniformCount++}setValueArrayF(e){this.needsUpdate=true;this._value=e}updateValueArrayF(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform1fv(this._loc,this._value);this._cgl.profileData.profileUniformCount++}setValueArrayT(e){this.needsUpdate=true;this._value=e}updateValue3F(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform3f(this._loc,this._value[0],this._value[1],this._value[2]);this.needsUpdate=false;this._cgl.profileData.profileUniformCount++}setValue3F(e){if(!e)return;if(!this._oldValue){this._oldValue=[e[0]-1,1,2];this.needsUpdate=true}else if(e[0]!=this._oldValue[0]||e[1]!=this._oldValue[1]||e[2]!=this._oldValue[2]){this._oldValue[0]=e[0];this._oldValue[1]=e[1];this._oldValue[2]=e[2];this.needsUpdate=true}this._value=e}updateValue2F(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform2f(this._loc,this._value[0],this._value[1]);this.needsUpdate=false;this._cgl.profileData.profileUniformCount++}setValue2F(e){if(!e)return;if(!this._oldValue){this._oldValue=[e[0]-1,1];this.needsUpdate=true}else if(e[0]!=this._oldValue[0]||e[1]!=this._oldValue[1]){this._oldValue[0]=e[0];this._oldValue[1]=e[1];this.needsUpdate=true}this._value=e}updateValue4F(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}if(!this._value){this._log.warn("no value for uniform",this._name,this);this._value=[0,0,0,0]}this.needsUpdate=false;this._shader.getCgl().gl.uniform4f(this._loc,this._value[0],this._value[1],this._value[2],this._value[3]);this._cgl.profileData.profileUniformCount++}setValue4F(e){if(typeof this.value=="number")this.value=vec4.create();if(!e)return;if(!this._oldValue){this._oldValue=[e[0]-1,1,2,3];this.needsUpdate=true}else if(e[0]!=this._oldValue[0]||e[1]!=this._oldValue[1]||e[2]!=this._oldValue[2]||e[3]!=this._oldValue[3]){this._oldValue[0]=e[0];this._oldValue[1]=e[1];this._oldValue[2]=e[2];this.needsUpdate=true}this._value=e}updateValueM4(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}if(!this._value||this._value.length%16!=0)return console.log("this.name",this._name,this._value);this._shader.getCgl().gl.uniformMatrix4fv(this._loc,false,this._value);this._cgl.profileData.profileUniformCount++}setValueM4(e){this.needsUpdate=true;this._value=e||mat4.create()}updateValueArrayT(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform1iv(this._loc,this._value);this._cgl.profileData.profileUniformCount++}updateValueT(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._cgl.profileData.profileUniformCount++;this._shader.getCgl().gl.uniform1i(this._loc,this._value);this.needsUpdate=false}setValueT(e){this.needsUpdate=true;this._value=e}}r.glslTypeString=e=>{if(e=="f")return"float";if(e=="b")return"bool";if(e=="i")return"int";if(e=="2i")return"ivec2";if(e=="2f")return"vec2";if(e=="3f")return"vec3";if(e=="4f")return"vec4";if(e=="m4")return"mat4";if(e=="t")return"sampler2D";if(e=="tc")return"samplerCube";if(e=="3f[]")return null;if(e=="m4[]")return null;if(e=="f[]")return null;console.warn("[CGL UNIFORM] unknown glsl type string ",e)}},273:(e,t,i)=>{"use strict";i.d(t,{S:()=>n});var r=i(331);var s=i(264);const n={};n.getSimpleRect=function(e,t,i=1){const s=new r.V(t);s.vertices=[1*i,1*i,0,-1*i,1*i,0,1*i,-1*i,0,-1*i,-1*i,0];s.texCoords=[1,1,0,1,1,0,0,0];s.verticesIndices=[0,1,2,2,1,3];s.vertexNormals=[0,0,0,0,0,0,0,0,0,0,0,0];return e.createMesh(s)};n.getSimpleCube=function(e,t){const i=new r.V(t);i.vertices=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1];i.setTexCoords([0,1,1,1,1,0,0,0,1,1,1,0,0,0,0,1,0,0,0,1,1,1,1,0,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,0,1,1,1,1,0,0,0]);i.verticesIndices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];i.vertexNormals=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0]);i.tangents=new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1]);i.biTangents=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1]);return new s.e(e,i)}},308:(e,t,i)=>{"use strict";i.d(t,{G:()=>c});var s=i(849);var r=i(562);var n=i(997);var a=i(24);var o=i(628);var l=i(264);var h=i(70);const u={BLEND_NONE:0,BLEND_NORMAL:1,BLEND_ADD:2,BLEND_SUB:3,BLEND_MUL:4};class c extends o.A{#cursor="auto";constructor(e){super(e);this.gApi=o.A.API_WEBGL;this.aborted=false;this.pushMvMatrix=this.pushModelMatrix;this.popMvMatrix=this.popmMatrix=this.popModelMatrix;this._log=new s.A("cgl_context",{onError:e.config.onError});this.glVersion=0;this.glUseHalfFloatTex=false;this.clearCanvasTransparent=true;this.clearCanvasDepth=true;this.debugOneFrame=false;this.checkGlErrors=false;this.maxTextureUnits=0;this.maxVaryingVectors=0;this.currentProgram=null;this._hadStackError=false;this.glSlowRendere=false;this._isSafariCrap=false;this.temporaryTexture=null;this.gl=null;this.#cursor="auto";this._currentCursor="";this._viewPortStack=[];this._glFrameBufferStack=[];this._frameBufferStack=[];this._shaderStack=[];this._stackDepthTest=[];this.mainloopOp=null;this._stackBlendMode=[];this._stackBlendModePremul=[];this._stackBlend=[];this._stackDepthFunc=[];this._stackCullFaceFacing=[];this._stackCullFace=[];this._stackDepthWrite=[];this._stackDepthTest=[];this._stackStencil=[];this._simpleShader=new a.M(this,"simpleshader");this._simpleShader.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_BEGIN_FRAG","MODULE_VERTEX_MODELVIEW"]);this._simpleShader.setSource(a.M.getDefaultVertexShader(),a.M.getDefaultFragmentShader());this._currentShader=this._simpleShader;this._oldCanvasWidth=-1;this._oldCanvasHeight=-1;this._enabledExtensions={};this.errorShader=null}get viewPort(){if(this._viewPortStack.length>3){const e=this._viewPortStack.length;return[this._viewPortStack[e-4],this._viewPortStack[e-3],this._viewPortStack[e-2],this._viewPortStack[e-1]]}else{return this._viewPort}}get mvMatrix(){return this.mMatrix}set mvMatrix(e){this.mMatrix=e}_setCanvas(e){if(!e)this._log.stack("_setCanvas undef");if(!this.patch.config.canvas)this.patch.config.canvas={};if(!this.patch.config.canvas.hasOwnProperty("preserveDrawingBuffer"))this.patch.config.canvas.preserveDrawingBuffer=true;if(!this.patch.config.canvas.hasOwnProperty("premultipliedAlpha"))this.patch.config.canvas.premultipliedAlpha=false;if(!this.patch.config.canvas.hasOwnProperty("alpha"))this.patch.config.canvas.alpha=false;this.patch.config.canvas.stencil=true;if(this.patch.config.hasOwnProperty("clearCanvasColor"))this.clearCanvasTransparent=this.patch.config.clearCanvasColor;if(this.patch.config.hasOwnProperty("clearCanvasDepth"))this.clearCanvasDepth=this.patch.config.clearCanvasDepth;if(/^((?!chrome|android).)*safari/i.test(navigator.userAgent)){this._isSafariCrap=true;this.glUseHalfFloatTex=true}if(!this.patch.config.canvas.forceWebGl1)this.gl=e.getContext("webgl2",this.patch.config.canvas);if(!this.gl||this.gl.isContextLost()){this.aborted=true;this._log.error("NO_WEBGL","sorry, could not initialize WebGL. Please check if your Browser supports WebGL or try to restart your browser.");return}if(this.gl.getParameter(this.gl.VERSION)!="WebGL 1.0"){this.glVersion=2}else{this.gl=e.getContext("webgl",this.patch.config.canvas)||e.getContext("experimental-webgl",this.patch.config.canvas);this.glVersion=1;if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){if(!this.patch.config.canvas.hasOwnProperty("powerPreference"))this.patch.config.canvas.powerPreference="high-performance"}this.enableExtension("OES_standard_derivatives");const i=this.enableExtension("ANGLE_instanced_arrays")||this.gl;if(i.vertexAttribDivisorANGLE){this.gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i);this.gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i)}}const t=this.enableExtension("WEBGL_debug_renderer_info");if(t){this.glRenderer=this.gl.getParameter(t.UNMASKED_RENDERER_WEBGL);if(this.glRenderer==="Google SwiftShader")this.glSlowRenderer=true}this.canvas.addEventListener("webglcontextlost",e=>{if(this.aborted)return this._log.warn("[cgl_state] aborted context lost... can be ignored...");this._log.error("canvas lost...",e);this.emitEvent("webglcontextlost");this.aborted=true});this.maxAnisotropic=0;if(this.enableExtension("EXT_texture_filter_anisotropic"))this.maxAnisotropic=this.gl.getParameter(this.enableExtension("EXT_texture_filter_anisotropic").MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.maxVaryingVectors=this.gl.getParameter(this.gl.MAX_VARYING_VECTORS);this.maxTextureUnits=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS);this.maxTexSize=this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE);this.maxUniformsFrag=this.gl.getParameter(this.gl.MAX_FRAGMENT_UNIFORM_VECTORS);this.maxUniformsVert=this.gl.getParameter(this.gl.MAX_VERTEX_UNIFORM_VECTORS);this.maxSamples=0;if(this.gl.MAX_SAMPLES)this.maxSamples=this.gl.getParameter(this.gl.MAX_SAMPLES);if(this.glVersion==1){this.enableExtension("OES_standard_derivatives");const i=this.enableExtension("ANGLE_instanced_arrays")||this.gl;if(i.vertexAttribDivisorANGLE){this.gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i);this.gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i)}}this.DEPTH_FUNCS=[this.gl.NEVER,this.gl.ALWAYS,this.gl.LESS,this.gl.LEQUAL,this.gl.GREATER,this.gl.GEQUAL,this.gl.EQUAL,this.gl.NOTEQUAL];this.CULL_MODES=[null,this.gl.BACK,this.gl.FRONT,this.gl.FRONT_AND_BACK]}getInfo(){return{glVersion:this.glVersion,glRenderer:this.glRenderer,glUseHalfFloatTex:this.glUseHalfFloatTex,maxVaryingVectors:this.maxVaryingVectors,maxTextureUnits:this.maxTextureUnits,maxTexSize:this.maxTexSize,maxUniformsFrag:this.maxUniformsFrag,maxUniformsVert:this.maxUniformsVert,maxSamples:this.maxSamples}}popViewPort(){this._viewPortStack.pop();this._viewPortStack.pop();this._viewPortStack.pop();this._viewPortStack.pop();if(this._viewPortStack.length==0)this.setViewPort(0,0,this.canvasWidth,this.canvasHeight);else this.setViewPort(this._viewPortStack[this._viewPort.length-4],this._viewPortStack[this._viewPort.length-3],this._viewPortStack[this._viewPort.length-2],this._viewPortStack[this._viewPort.length-1])}pushViewPort(e,t,i,s){this._viewPortStack.push(e,t,i,s);this.setViewPort(e,t,i,s)}getViewPort(){return this._viewPort}resetViewPort(){this.gl.viewport(this._viewPort[0],this._viewPort[1],this._viewPort[2],this._viewPort[3])}setViewPort(e,t,i,s){this._viewPort[0]=Math.round(e);this._viewPort[1]=Math.round(t);this._viewPort[2]=Math.round(i);this._viewPort[3]=Math.round(s);this.gl.viewport(this._viewPort[0],this._viewPort[1],this._viewPort[2],this._viewPort[3])}screenShot(t,e,i,s){if(e){this.gl.clearColor(1,1,1,1);this.gl.colorMask(false,false,false,true);this.gl.clear(this.gl.COLOR_BUFFER_BIT);this.gl.colorMask(true,true,true,true)}if(this.canvas&&this.canvas.toBlob){this.canvas.toBlob(e=>{if(t)t(e);else this._log.log("no screenshot callback...")},i,s)}}endFrame(){if(this.patch.isEditorMode())CABLES.GL_MARKER.drawMarkerLayer(this);this.setPreviousShader();if(this._vMatrixStack.length()>0)this.logStackError("view matrix stack length !=0 at end of rendering...");if(this._mMatrixStack.length()>0)this.logStackError("mvmatrix stack length !=0 at end of rendering...");if(this._pMatrixStack.length()>0)this.logStackError("pmatrix stack length !=0 at end of rendering...");if(this._glFrameBufferStack.length>0)this.logStackError("glFrameBuffer stack length !=0 at end of rendering...");if(this._stackDepthTest.length>0)this.logStackError("depthtest stack length !=0 at end of rendering...");if(this._stackDepthWrite.length>0)this.logStackError("depthwrite stack length !=0 at end of rendering...");if(this._stackDepthFunc.length>0)this.logStackError("depthfunc stack length !=0 at end of rendering...");if(this._stackBlend.length>0)this.logStackError("blend stack length !=0 at end of rendering...");if(this._stackBlendMode.length>0)this.logStackError("blendMode stack length !=0 at end of rendering...");if(this._shaderStack.length>0)this.logStackError("this._shaderStack length !=0 at end of rendering...");if(this._stackCullFace.length>0)this.logStackError("this._stackCullFace length !=0 at end of rendering...");if(this._stackCullFaceFacing.length>0)this.logStackError("this._stackCullFaceFacing length !=0 at end of rendering...");if(this._viewPortStack.length>0)this.logStackError("viewport stack length !=0 at end of rendering...");this._frameStarted=false;if(this._oldCanvasWidth!=this.canvasWidth||this._oldCanvasHeight!=this.canvasHeight){this._oldCanvasWidth=this.canvasWidth;this._oldCanvasHeight=this.canvasHeight;this.emitEvent(o.A.EVENT_RESIZE)}if(this.#cursor!=this._currentCursor){this._currentCursor=this.canvas.style.cursor=this.#cursor}this.emitEvent("endframe");this.fpsCounter.endFrame()}logStackError(e){if(!this._hadStackError){this._hadStackError=true;this._log.warn("["+this.canvas.id+"]: ",e)}}getShader(){if(this._currentShader)if(!this.tempData||this.tempData.renderOffscreen===true==this._currentShader.offScreenPass===true)return this._currentShader;for(let e=this._shaderStack.length-1;e>=0;e--)if(this._shaderStack[e])if(this.tempData.renderOffscreen==this._shaderStack[e].offScreenPass)return this._shaderStack[e]}getDefaultShader(){return this._simpleShader}setShader(e){this.pushShader(e)}pushShader(t){if(this.tempData.forceShaderMods){for(let e=0;e<this.tempData.forceShaderMods.length;e++){t=this.tempData.forceShaderMods[e].bind(t,false)}}this._shaderStack.push(t);this._currentShader=t}popShader(){this.setPreviousShader()}setPreviousShader(){if(this.tempData.forceShaderMods){for(let e=0;e<this.tempData.forceShaderMods.length;e++){this.tempData.forceShaderMods[e].unbind(false)}}if(this._shaderStack.length===0)throw new Error("Invalid shader stack pop!");this._shaderStack.pop();this._currentShader=this._shaderStack[this._shaderStack.length-1]}pushGlFrameBuffer(e){this._glFrameBufferStack.push(e)}popGlFrameBuffer(){if(this._glFrameBufferStack.length==0)return null;this._glFrameBufferStack.pop();return this._glFrameBufferStack[this._glFrameBufferStack.length-1]}getCurrentGlFrameBuffer(){if(this._glFrameBufferStack.length===0)return null;return this._glFrameBufferStack[this._glFrameBufferStack.length-1]}pushFrameBuffer(e){this._frameBufferStack.push(e)}popFrameBuffer(){if(this._frameBufferStack.length==0)return null;this._frameBufferStack.pop();return this._frameBufferStack[this._frameBufferStack.length-1]}getCurrentFrameBuffer(){if(this._frameBufferStack.length===0)return null;return this._frameBufferStack[this._frameBufferStack.length-1]}renderStart(e,t,i){this.fpsCounter.startFrame();this.pushDepthTest(true);this.pushDepthWrite(true);this.pushDepthFunc(e.gl.LEQUAL);this.pushCullFaceFacing(e.gl.BACK);this.pushCullFace(false);e.setViewPort(0,0,e.canvasWidth,e.canvasHeight);this._startMatrixStacks(t,i);e.pushBlendMode(n.a.BLEND_MODES.BLEND_NORMAL,false);for(let e=0;e<this._textureslots.length;e++)this._textureslots[e]=null;this.pushShader(this._simpleShader);this._frameStarted=true;this._execOneTimeCallbacks();for(let e=0;e<this._textureslots.length;e++){this.gl.activeTexture(this.gl.TEXTURE0+e);this.gl.bindTexture(this.gl.TEXTURE_2D,null);this._textureslots[e]=null}this.emitEvent("beginFrame")}renderEnd(e){this._endMatrixStacks();this.popDepthTest();this.popDepthWrite();this.popDepthFunc();this.popCullFaceFacing();this.popCullFace();this.popBlend();this.popBlendMode();e.endFrame();this.emitEvent("endFrame")}getTexture(e){return this._textureslots[e]}hasFrameStarted(){return this._frameStarted}checkFrameStarted(e){if(!this._frameStarted){this._log.warn("frame not started "+e);Error.stackTraceLimit=25;r.logStack();this.patch.printTriggerStack()}}setTexture(e,t,i){this.checkFrameStarted("cgl setTexture");if(t===null)t=h.g.getEmptyTexture(this).tex;if(this._textureslots[e]!=t){this.gl.activeTexture(this.gl.TEXTURE0+e);this.gl.bindTexture(i||this.gl.TEXTURE_2D,t);this._textureslots[e]=t}return true}fullScreen(){if(this.canvas.requestFullscreen)this.canvas.requestFullscreen();else if(this.canvas.mozRequestFullScreen)this.canvas.mozRequestFullScreen();else if(this.canvas.webkitRequestFullscreen)this.canvas.webkitRequestFullscreen();else if(this.canvas.msRequestFullscreen)this.canvas.msRequestFullscreen()}printError(t){if(!this.checkGlErrors)return;let i=false;let s=this.gl.getError();if(s!=this.gl.NO_ERROR){let e="";if(s==this.gl.OUT_OF_MEMORY)e="OUT_OF_MEMORY";if(s==this.gl.INVALID_ENUM)e="INVALID_ENUM";if(s==this.gl.INVALID_OPERATION)e="INVALID_OPERATION";if(s==this.gl.INVALID_FRAMEBUFFER_OPERATION)e="INVALID_FRAMEBUFFER_OPERATION";if(s==this.gl.INVALID_VALUE)e="INVALID_VALUE";if(s==this.gl.CONTEXT_LOST_WEBGL){this.aborted=true;e="CONTEXT_LOST_WEBGL"}if(s==this.gl.NO_ERROR)e="NO_ERROR";i=true;this._log.warn("gl error ["+this.canvas.id+"]: ",t,s,e);if(this.canvas.id.includes("glGuiCanvas"))if(!this._loggedGlError){this.patch.printTriggerStack();this._log.stack("glerror");this._loggedGlError=true}}s=this.gl.getError();return i}_dispose(){this._simpleShader.dispose();this.gl=null}pushDepthTest(e){this._stackDepthTest.push(e);if(!e)this.gl.disable(this.gl.DEPTH_TEST);else this.gl.enable(this.gl.DEPTH_TEST)}stateDepthTest(){return this._stackDepthTest[this._stackDepthTest.length-1]}popDepthTest(){this._stackDepthTest.pop();if(!this._stackDepthTest[this._stackDepthTest.length-1])this.gl.disable(this.gl.DEPTH_TEST);else this.gl.enable(this.gl.DEPTH_TEST)}pushDepthWrite(e){e=e||false;this._stackDepthWrite.push(e);this.gl.depthMask(e)}stateDepthWrite(){return this._stackDepthWrite[this._stackDepthWrite.length-1]}popDepthWrite(){this._stackDepthWrite.pop();this.gl.depthMask(this._stackDepthWrite[this._stackDepthWrite.length-1]||false)}pushCullFace(e){this._stackCullFace.push(e);if(e)this.gl.enable(this.gl.CULL_FACE);else this.gl.disable(this.gl.CULL_FACE)}stateCullFace(){return this._stackCullFace[this._stackCullFace.length-1]}popCullFace(){this._stackCullFace.pop();if(this._stackCullFace[this._stackCullFace.length-1])this.gl.enable(this.gl.CULL_FACE);else this.gl.disable(this.gl.CULL_FACE)}pushCullFaceFacing(e){this._stackCullFaceFacing.push(e);this.gl.cullFace(this._stackCullFaceFacing[this._stackCullFaceFacing.length-1])}stateCullFaceFacing(){return this._stackCullFaceFacing[this._stackCullFaceFacing.length-1]}popCullFaceFacing(){this._stackCullFaceFacing.pop();if(this._stackCullFaceFacing.length>0)this.gl.cullFace(this._stackCullFaceFacing[this._stackCullFaceFacing.length-1])}pushDepthFunc(e){this._stackDepthFunc.push(e);this.gl.depthFunc(e)}stateDepthFunc(){if(this._stackDepthFunc.length>0)return this._stackDepthFunc[this._stackDepthFunc.length-1];return false}popDepthFunc(){this._stackDepthFunc.pop();if(this._stackDepthFunc.length>0)this.gl.depthFunc(this._stackDepthFunc[this._stackDepthFunc.length-1])}pushBlend(e){this._stackBlend.push(e);if(!e)this.gl.disable(this.gl.BLEND);else this.gl.enable(this.gl.BLEND)}popBlend(){this._stackBlend.pop();if(!this._stackBlend[this._stackBlend.length-1])this.gl.disable(this.gl.BLEND);else this.gl.enable(this.gl.BLEND)}stateBlend(){return this._stackBlend[this._stackBlend.length-1]}pushBlendMode(e,t){this._stackBlendMode.push(e);this._stackBlendModePremul.push(t);const i=this._stackBlendMode.length-1;this.pushBlend(this._stackBlendMode[i]!==n.a.BLEND_MODES.BLEND_NONE);this._setBlendMode(this._stackBlendMode[i],this._stackBlendModePremul[i])}popBlendMode(){this._stackBlendMode.pop();this._stackBlendModePremul.pop();const e=this._stackBlendMode.length-1;this.popBlend();if(e>=0)this._setBlendMode(this._stackBlendMode[e],this._stackBlendModePremul[e])}pushStencil(e){this._stackStencil.push(e);if(!e)this.gl.disable(this.gl.STENCIL_TEST);else this.gl.enable(this.gl.STENCIL_TEST)}popStencil(){this._stackStencil.pop();if(!this._stackStencil[this._stackStencil.length-1])this.gl.disable(this.gl.STENCIL_TEST);else this.gl.enable(this.gl.STENCIL_TEST)}glGetAttribLocation(e,t){const i=this.gl.getAttribLocation(e,t);return i}shouldDrawHelpers(e){if(this.tempData.shadowPass)return false;if(!e.patch.isEditorMode())return false;return gui.shouldDrawOverlay}_setBlendMode(e,t){const i=this.gl;if(e==n.a.BLEND_MODES.BLEND_NONE){}else if(e==n.a.BLEND_MODES.BLEND_ADD){if(t){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ONE,i.ONE,i.ONE,i.ONE)}else{i.blendEquation(i.FUNC_ADD);i.blendFunc(i.SRC_ALPHA,i.ONE)}}else if(e==n.a.BLEND_MODES.BLEND_SUB){if(t){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ZERO,i.ZERO,i.ONE_MINUS_SRC_COLOR,i.ONE_MINUS_SRC_ALPHA)}else{i.blendEquation(i.FUNC_ADD);i.blendFunc(i.ZERO,i.ONE_MINUS_SRC_COLOR)}}else if(e==n.a.BLEND_MODES.BLEND_MUL){if(t){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ZERO,i.SRC_COLOR,i.ZERO,i.SRC_ALPHA)}else{i.blendEquation(i.FUNC_ADD);i.blendFunc(i.ZERO,i.SRC_COLOR)}}else if(e==n.a.BLEND_MODES.BLEND_NORMAL){if(t){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ONE,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA)}else{i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA)}}else{this._log.log("setblendmode: unknown blendmode")}}createMesh(e,t){if(r.isNumeric(t))t={glPrimitive:t};return new l.e(this,e,t)}setCursor(e){this.#cursor=e}enableExtension(e){if(!this.gl)return null;if(this._enabledExtensions.hasOwnProperty(e))return this._enabledExtensions[e];const t=this.gl.getExtension(e);this._enabledExtensions[e]=t;if(!t)this._log.warn("[cgl_state] extension not available "+e);return t}getErrorShader(){if(this.errorShader)return this.errorShader;this.errorShader=new a.M(this,"errormaterial");this.errorShader.setSource(a.M.getDefaultVertexShader(),a.M.getErrorFragmentShader());return this.errorShader}}},70:(e,t,i)=>{"use strict";i.d(t,{g:()=>u});var s=i(849);var h=i(562);var r=i(356);const n=8;const a=new s.A("cgl_texture");class u extends r.U{constructor(e,t={}){super(t);if(!e)throw new Error("no cgl");this._cgl=e;this._log=new s.A("tex");this.tex=this._cgl.gl.createTexture();this.loading=false;this.flip=true;this.flipped=false;this.shadowMap=false;this.deleted=false;this.image=null;this.anisotropic=0;this.filter=u.FILTER_NEAREST;this.wrap=u.WRAP_CLAMP_TO_EDGE;this.texTarget=this._cgl.gl.TEXTURE_2D;if(t&&t.type)this.texTarget=t.type;this.textureType=u.TYPE_DEFAULT;this.unpackAlpha=true;this._fromData=true;this._glDataType=-1;this._glInternalFormat=-1;this._glDataFormat=-1;if(t){if(t.isDepthTexture)this.textureType=u.TYPE_DEPTH;if(t.isFloatingPointTexture===true)this.textureType=u.TYPE_FLOAT;if("textureType"in t)this.textureType=t.textureType;if("filter"in t)this.filter=t.filter;if("wrap"in t)this.wrap=t.wrap;if("unpackAlpha"in t)this.unpackAlpha=t.unpackAlpha;if("flip"in t)this.flip=t.flip;if("shadowMap"in t)this.shadowMap=t.shadowMap;if("anisotropic"in t)this.anisotropic=t.anisotropic}else{t={}}if(!t.pixelFormat&&t.isFloatingPointTexture)this.pixelFormat=u.PFORMATSTR_RGBA32F;if(this.textureType==u.TYPE_DEPTH)this.pixelFormat=u.PFORMATSTR_DEPTH;this._cgl.profileData.profileTextureNew++;this.setFormat(u.setUpGlPixelFormat(this._cgl,this.pixelFormat));this._cgl.profileData.addHeavyEvent("texture created",this.name,t.width+"x"+t.height);this.setSize(t.width,t.height);this.getInfoOneLine()}isFloatingPoint(){return u.isPixelFormatFloat(this.pixelFormat)}compareSettings(e){if(!e)return false;return e.width==this.width&&e.height==this.height&&e.filter==this.filter&&e.wrap==this.wrap&&e.textureType==this.textureType&&e.unpackAlpha==this.unpackAlpha&&e.anisotropic==this.anisotropic&&e.shadowMap==this.shadowMap&&e.texTarget==this.texTarget&&e.flip==this.flip}clone(){const e=new u(this._cgl,{name:this.name,filter:this.filter,anisotropic:this.anisotropic,wrap:this.wrap,textureType:this.textureType,pixelFormat:this.pixelFormat,unpackAlpha:this.unpackAlpha,flip:this.flip,width:this.width,height:this.height});this._cgl.profileData.addHeavyEvent("texture created",this.name,this.width+"x"+this.height);if(!this.compareSettings(e)){this._log.error("Cloned texture settings do not compare!");this._log.error(this);this._log.error(e)}return e}setFormat(e){this.pixelFormat=e.pixelFormat;this._glDataFormat=e.glDataFormat;this._glInternalFormat=e.glInternalFormat;this._glDataType=e.glDataType}setSize(e,t){if(this._cgl.aborted)return;if(e!=e||e<=0||!e)e=n;if(t!=t||t<=0||!t)t=n;if(e>this._cgl.maxTexSize||t>this._cgl.maxTexSize)this._log.error("texture size too big! "+e+"x"+t+" / max: "+this._cgl.maxTexSize);e=Math.min(e,this._cgl.maxTexSize);t=Math.min(t,this._cgl.maxTexSize);e=Math.floor(e);t=Math.floor(t);if(this.width==e&&this.height==t)return;e=this._cgl.checkTextureSize(e);t=this._cgl.checkTextureSize(t);this.width=e;this.height=t;this.deleted=false;this.setFormat(u.setUpGlPixelFormat(this._cgl,this.pixelFormat));this.shortInfoString=this.getInfoOneLine();this._cgl.gl.bindTexture(this.texTarget,this.tex);this._cgl.profileData.profileTextureResize++;const i=null;this._cgl.gl.texImage2D(this.texTarget,0,this._glInternalFormat,e,t,0,this._glDataFormat,this._glDataType,i);this._setFilter();this.updateMipMap();this._cgl.gl.bindTexture(this.texTarget,null)}initFromData(e,t,i,s,r){this.filter=s;this.wrap=r;if(s==undefined)this.filter=u.FILTER_LINEAR;if(r==undefined)this.wrap=u.WRAP_CLAMP_TO_EDGE;this.width=t;this.height=i;this._fromData=true;this.deleted=false;if(this.height>this._cgl.maxTexSize||this.width>this._cgl.maxTexSize){const n=CGL.Texture.getTempTexture(this._cgl);this.width=n.width;this.height=n.height;this.tex=n.tex;this._log.warn("[cgl_texture] texture size too big!",this.width,this.height,this._cgl.maxTexSize);return}if(this.flip)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,this.flip);this._cgl.gl.bindTexture(this.texTarget,this.tex);this.setFormat(u.setUpGlPixelFormat(this._cgl,this.pixelFormat));this._cgl.gl.texImage2D(this.texTarget,0,this._glInternalFormat,t,i,0,this._glDataFormat,this._glDataType,e);this._setFilter();this.updateMipMap();if(this.flip)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,false);this._cgl.gl.bindTexture(this.texTarget,null)}updateMipMap(){if((this._cgl.glVersion==2||this.isPowerOfTwo())&&this.filter==u.FILTER_MIPMAP){this._cgl.gl.generateMipmap(this.texTarget);this._cgl.profileData.profileGenMipMap++}}initTexture(e,t=null){this._cgl.printError("before initTexture");this._cgl.checkFrameStarted("texture inittexture");this._fromData=false;this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.unpackAlpha);if(e.width||e.videoWidth)this.width=e.videoWidth||e.width;if(e.height||e.videoHeight)this.height=e.videoHeight||e.height;if(t!==null)this.filter=t;if(e.height>this._cgl.maxTexSize||e.width>this._cgl.maxTexSize){const i=CGL.Texture.getTempTexture(this._cgl);this.width=i.width;this.height=i.height;this.tex=i.tex;this._log.warn("[cgl_texture] texture size too big!",e.width,e.height,this._cgl.maxTexSize);return}this._cgl.gl.bindTexture(this.texTarget,this.tex);this.deleted=false;this.flipped=!this.flip;if(this.flipped)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,this.flipped);this.setFormat(u.setUpGlPixelFormat(this._cgl,this.pixelFormat));this._cgl.gl.texImage2D(this.texTarget,0,this._glInternalFormat,this._glDataFormat,this._glDataType,e);this._setFilter();this.updateMipMap();this._cgl.gl.bindTexture(this.texTarget,null);this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);if(this.flipped)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,false);this.getInfoOneLine();this._cgl.printError("initTexture")}dispose(){this.delete()}delete(){if(this.loading){return}this.deleted=true;this.width=0;this.height=0;this._cgl.profileData.profileTextureDelete++;this._cgl.gl.deleteTexture(this.tex);this.image=null;this.tex=null}isPowerOfTwo(){return u.isPowerOfTwo(this.width)&&u.isPowerOfTwo(this.height)}printInfo(){a.log(this.getInfo())}getInfoReadable(){const t=this.getInfo();let i="";t.name=t.name.substr(0,t.name.indexOf("?rnd="));for(const e in t){i+="* "+e+":  **"+t[e]+"**\n"}return i}getInfoOneLine(){let e=""+this.width+"x"+this.height;e+=" ";e+=this.pixelFormat;if(this.filter===u.FILTER_NEAREST)e+=" nearest";if(this.filter===u.FILTER_LINEAR)e+=" linear";if(this.filter===u.FILTER_MIPMAP)e+=" mipmap";if(this.wrap===u.WRAP_CLAMP_TO_EDGE)e+=" clamp";if(this.wrap===u.WRAP_REPEAT)e+=" repeat";if(this.wrap===u.WRAP_MIRRORED_REPEAT)e+=" repeatmir";this.shortInfoString=e;return e}getInfoOneLineShort(){let e=""+this.width+"x"+this.height;e+=" ";e+=this.pixelFormat;this.shortInfoString=e;return e}getInfo(){return u.getTexInfo(this)}_setFilter(){this._cgl.printError("before _setFilter");if(!this._fromData){this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.unpackAlpha)}if(this.shadowMap){this._cgl.gl.texParameteri(this._cgl.gl.TEXTURE_2D,this._cgl.gl.TEXTURE_COMPARE_MODE,this._cgl.gl.COMPARE_REF_TO_TEXTURE);this._cgl.gl.texParameteri(this._cgl.gl.TEXTURE_2D,this._cgl.gl.TEXTURE_COMPARE_FUNC,this._cgl.gl.LEQUAL)}if(this.textureType==u.TYPE_FLOAT&&this.filter==u.FILTER_MIPMAP){this.filter=u.FILTER_LINEAR;this._log.stack("texture: HDR and mipmap filtering at the same time is not possible")}if(this._cgl.glVersion==1&&!this.isPowerOfTwo()){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.CLAMP_TO_EDGE);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.CLAMP_TO_EDGE);this.filter=u.FILTER_NEAREST;this.wrap=u.WRAP_CLAMP_TO_EDGE}else{if(this.wrap==u.WRAP_CLAMP_TO_EDGE){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.CLAMP_TO_EDGE);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.CLAMP_TO_EDGE)}else if(this.wrap==u.WRAP_REPEAT){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.REPEAT);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.REPEAT)}else if(this.wrap==u.WRAP_MIRRORED_REPEAT){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.MIRRORED_REPEAT);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.MIRRORED_REPEAT)}if(this.filter==u.FILTER_NEAREST){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.NEAREST)}else if(this.filter==u.FILTER_LINEAR){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.LINEAR);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.LINEAR)}else if(this.filter==u.FILTER_MIPMAP){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.LINEAR);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.LINEAR_MIPMAP_LINEAR)}else{this._log.log("unknown texture filter!",this.filter);throw new Error("unknown texture filter!"+this.filter)}if(this.anisotropic){const e=this._cgl.enableExtension("EXT_texture_filter_anisotropic");if(this._cgl.maxAnisotropic){const t=Math.min(this._cgl.maxAnisotropic,this.anisotropic);this._cgl.gl.texParameterf(this._cgl.gl.TEXTURE_2D,e.TEXTURE_MAX_ANISOTROPY_EXT,t)}}}this.getInfoOneLine();this._cgl.printError("_setFilter")}}u.load=function(i,s,r,e){if(!s)return r({error:true});let n=null;if(!i.patch.loading.existByName(s))n=i.patch.loading.start("cgl.texture",s);const a=new u(i);a.name=s;a.image=new Image;a.image.crossOrigin="anonymous";a.loading=true;if(e&&e.hasOwnProperty("filter"))a.filter=e.filter;if(e&&e.hasOwnProperty("flip"))a.flip=e.flip;if(e&&e.hasOwnProperty("wrap"))a.wrap=e.wrap;if(e&&e.hasOwnProperty("anisotropic"))a.anisotropic=e.anisotropic;if(e&&e.hasOwnProperty("unpackAlpha"))a.unpackAlpha=e.unpackAlpha;if(e&&e.hasOwnProperty("pixelFormat"))a.pixelFormat=e.pixelFormat;a.image.onabort=a.image.onerror=e=>{console.warn("[cgl.texture.load] error loading texture",s,e);a.loading=false;if(n)i.patch.loading.finished(n);const t={error:true};if(r)r(t,a)};a.image.onload=function(e){i.addNextFrameOnceCallback(()=>{a.initTexture(a.image);if(n)i.patch.loading.finished(n);a.loading=false;if(r)r(null,a)})};a.image.src=s;return a};u.getTempTexture=function(e){if(!e)console.error("[getTempTexture] no cgl!");if(!e.tempTexture)e.tempTexture=u.getTemporaryTexture(e,256,u.FILTER_LINEAR,u.REPEAT);return e.tempTexture};u.getErrorTexture=function(e){if(!e)console.error("[getTempTexture] no cgl!");if(!e.errorTexture)e.errorTexture=u.getTemporaryTexture(e,256,u.FILTER_LINEAR,u.REPEAT,1,.2,.2);return e.errorTexture};u.getEmptyTexture=function(e,t){if(t)return u.getEmptyTextureFloat(e);if(!e)console.error("[getEmptyTexture] no cgl!");if(e.tempTextureEmpty)return e.tempTextureEmpty;let i=8;e.tempTextureEmpty=new u(e,{name:"emptyTexture"});const s=u.getDefaultTextureData("empty",i);e.tempTextureEmpty.initFromData(s,i,i,u.FILTER_NEAREST,u.WRAP_REPEAT);return e.tempTextureEmpty};u.getEmptyTextureFloat=function(e){if(!e)console.error("[getEmptyTextureFloat] no cgl!");if(e.tempTextureEmptyFloat)return e.tempTextureEmptyFloat;e.tempTextureEmptyFloat=new u(e,{name:"emptyTexture",isFloatingPointTexture:true});const t=new Float32Array(8*8*4).fill(1);for(let e=0;e<8*8*4;e+=4)t[e+3]=0;e.tempTextureEmptyFloat.initFromData(t,8,8,u.FILTER_NEAREST,u.WRAP_REPEAT);return e.tempTextureEmptyFloat};u.getRandomTexture=function(e){if(!e)console.error("[getRandomTexture] no cgl!");if(e.randomTexture)return e.randomTexture;const t=256;const i=u.getDefaultTextureData("randomUInt",t);e.randomTexture=new u(e);e.randomTexture.initFromData(i,t,t,u.FILTER_NEAREST,u.WRAP_REPEAT);return e.randomTexture};u.getRandomFloatTexture=function(e){if(!e)console.error("[getRandomTexture] no cgl!");if(e.getRandomFloatTexture)return e.getRandomFloatTexture;const t=256;const i=u.getDefaultTextureData("randomFloat",t);e.getRandomFloatTexture=new u(e,{isFloatingPointTexture:true});e.getRandomFloatTexture.initFromData(i,t,t,u.FILTER_NEAREST,u.WRAP_REPEAT);return e.getRandomFloatTexture};u.getBlackTexture=function(e){if(e.blackTexture)return e.blackTexture;const t=8;const i=u.getDefaultTextureData("color",t,{r:0,g:0,b:0});e.blackTexture=new u(e);e.blackTexture.initFromData(i,t,t,u.FILTER_NEAREST,u.WRAP_REPEAT);return e.blackTexture};u.getEmptyCubemapTexture=function(t){const i=[t.gl.TEXTURE_CUBE_MAP_POSITIVE_X,t.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,t.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,t.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,t.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z];const e=t.gl.createTexture();const s=t.gl.TEXTURE_CUBE_MAP;const r=u.FILTER_NEAREST;const n=u.WRAP_CLAMP_TO_EDGE;const a=8;const o=8;t.profileData.profileTextureNew++;t.gl.bindTexture(s,e);t.profileData.profileTextureResize++;for(let e=0;e<6;e+=1){const l=new Uint8Array(8*8*4);t.gl.texImage2D(i[e],0,t.gl.RGBA,8,8,0,t.gl.RGBA,t.gl.UNSIGNED_BYTE,l);t.gl.texParameteri(s,t.gl.TEXTURE_MAG_FILTER,t.gl.NEAREST);t.gl.texParameteri(s,t.gl.TEXTURE_MIN_FILTER,t.gl.NEAREST);t.gl.texParameteri(s,t.gl.TEXTURE_WRAP_S,t.gl.CLAMP_TO_EDGE);t.gl.texParameteri(s,t.gl.TEXTURE_WRAP_T,t.gl.CLAMP_TO_EDGE)}t.gl.bindTexture(s,null);return{id:h.uuid(),tex:e,cubemap:e,width:a,height:o,filter:r,wrap:n,unpackAlpha:true,flip:true,_fromData:true,name:"emptyCubemapTexture",anisotropic:0}};u.getTempGradientTexture=function(e){if(!e)console.error("[getTempGradientTexture] no cgl!");return u.getTempTexture(e)};u.getTemporaryTexture=function(e,t,i,s,r,n,a){const o=u.getDefaultTextureData("stripes",256,{r:r,g:n,b:a});const l=new u(e);l.initFromData(o,t,t,i,s);return l};u.createFromImage=function(e,t,i){i=i||{};const s=new u(e,i);s.flip=false;s.image=t;s.width=t.videoWidth||t.width||8;s.height=t.videoHeight||t.height||8;if(i.hasOwnProperty("wrap"))s.wrap=i.wrap;s.initTexture(t,i.filter);return s};u.fromImage=function(e,t,i,s){console.error("deprecated texture from image...");const r=new u(e);r.flip=false;if(i)r.filter=i;if(s)r.wrap=s;r.image=t;r.initTexture(t);return r};u.isPowerOfTwo=function(e){return e==1||e==2||e==4||e==8||e==16||e==32||e==64||e==128||e==256||e==512||e==1024||e==2048||e==4096||e==8192||e==16384};u.getTexInfo=function(e){const t={};t.name=e.name;t["power of two"]=e.isPowerOfTwo();t.size=e.width+" x "+e.height;let i=e.texTarget;if(e.texTarget==e._cgl.gl.TEXTURE_2D)i="TEXTURE_2D";t.target=i;t.unpackAlpha=e.unpackAlpha;if(e.cubemap)t.cubemap=true;if(e.textureType==u.TYPE_FLOAT)t.textureType="TYPE_FLOAT";if(e.textureType==u.TYPE_HALF_FLOAT)t.textureType="TYPE_HALF_FLOAT";else if(e.textureType==u.TYPE_DEPTH)t.textureType="TYPE_DEPTH";else if(e.textureType==u.TYPE_DEFAULT)t.textureType="TYPE_DEFAULT";else t.textureType="UNKNOWN "+this.textureType;if(e.wrap==u.WRAP_CLAMP_TO_EDGE)t.wrap="CLAMP_TO_EDGE";else if(e.wrap==u.WRAP_REPEAT)t.wrap="WRAP_REPEAT";else if(e.wrap==u.WRAP_MIRRORED_REPEAT)t.wrap="WRAP_MIRRORED_REPEAT";else t.wrap="UNKNOWN";if(e.filter==u.FILTER_NEAREST)t.filter="FILTER_NEAREST";else if(e.filter==u.FILTER_LINEAR)t.filter="FILTER_LINEAR";else if(e.filter==u.FILTER_MIPMAP)t.filter="FILTER_MIPMAP";else t.filter="UNKNOWN";t.pixelFormat=e.pixelFormat||"unknown";return t};u.setUpGlPixelFormat=function(e,t){const i={};if(!t){e._log.error("no pixelformatstr!");e._log.log(new Error);t=u.PFORMATSTR_RGBA8UB}i.pixelFormatBase=t;i.pixelFormat=t;i.glDataType=e.gl.UNSIGNED_BYTE;i.glInternalFormat=e.gl.RGBA8;i.glDataFormat=e.gl.RGBA;let s=e.gl.FLOAT;if(e.glUseHalfFloatTex){if(t==u.PFORMATSTR_RGBA32F)t=u.PFORMATSTR_RGBA16F;if(t==u.PFORMATSTR_RG32F)t=u.PFORMATSTR_RG16F;if(t==u.PFORMATSTR_R32F)t=u.PFORMATSTR_R16F}if(t.includes("16bit")){if(e.glVersion==2){const r=e.enableExtension("EXT_color_buffer_half_float");if(!r){console.warn("no 16bit extension, fallback to 32bit",t);if(t==u.PFORMATSTR_RGBA16F)t=u.PFORMATSTR_RGBA32F;if(t==u.PFORMATSTR_RGB16F)t=u.PFORMATSTR_RGB32F;if(t==u.PFORMATSTR_RG16F)t=u.PFORMATSTR_RG32F;if(t==u.PFORMATSTR_R16F)t=u.PFORMATSTR_R32F}else{s=e.gl.HALF_FLOAT}}}if(e.glVersion==1){i.glInternalFormat=e.gl.RGBA;if(t==u.PFORMATSTR_RGBA16F||t==u.PFORMATSTR_RG16F||t==u.PFORMATSTR_R16F){const n=e.enableExtension("OES_texture_half_float");if(!n)throw new Error("no half float texture extension");s=n.HALF_FLOAT_OES}}if(t==u.PFORMATSTR_RGBA8UB){}else if(t==u.PFORMATSTR_RGB565){i.glInternalFormat=e.gl.RGB565;i.glDataFormat=e.gl.RGB}else if(t==u.PFORMATSTR_R8UB){i.glInternalFormat=e.gl.R8;i.glDataFormat=e.gl.RED}else if(t==u.PFORMATSTR_RG8UB){i.glInternalFormat=e.gl.RG8;i.glDataFormat=e.gl.RG}else if(t==u.PFORMATSTR_RGB8UB){i.glInternalFormat=e.gl.RGB8;i.glDataFormat=e.gl.RGB}else if(t==u.PFORMATSTR_SRGBA8){i.glInternalFormat=e.gl.SRGB8_ALPHA8}else if(t==u.PFORMATSTR_R32F){i.glInternalFormat=e.gl.R32F;i.glDataFormat=e.gl.RED;i.glDataType=s}else if(t==u.PFORMATSTR_R16F){i.glInternalFormat=e.gl.R16F;i.glDataType=s;i.glDataFormat=e.gl.RED}else if(t==u.PFORMATSTR_RG16F){i.glInternalFormat=e.gl.RG16F;i.glDataType=s;i.glDataFormat=e.gl.RG}else if(t==u.PFORMATSTR_RGBA16F){if(e.glVersion==1)i.glInternalFormat=e.gl.RGBA;else i.glInternalFormat=e.gl.RGBA16F;i.glDataType=s}else if(t==u.PFORMATSTR_R11FG11FB10F){i.glInternalFormat=e.gl.R11F_G11F_B10F;i.glDataType=s;i.glDataFormat=e.gl.RGB}else if(t==u.PFORMATSTR_RGBA32F){if(e.glVersion==1)i.glInternalFormat=e.gl.RGBA;else i.glInternalFormat=e.gl.RGBA32F;i.glDataType=s}else if(t==u.PFORMATSTR_DEPTH){if(e.glVersion==1){i.glInternalFormat=e.gl.DEPTH_COMPONENT;i.glDataType=e.gl.UNSIGNED_SHORT;i.glDataFormat=e.gl.DEPTH_COMPONENT}else{i.glInternalFormat=e.gl.DEPTH_COMPONENT32F;i.glDataType=e.gl.FLOAT;i.glDataFormat=e.gl.DEPTH_COMPONENT}}else{a.log("unknown pixelformat ",t)}if(t.includes("32bit")||t==u.PFORMATSTR_R11FG11FB10F){if(e.glVersion==2)e.enableExtension("EXT_color_buffer_float");if(e.glVersion==2)e.enableExtension("EXT_float_blend");e.enableExtension("OES_texture_float_linear")}i.numColorChannels=u.getPixelFormatNumChannels(t);if(!i.glDataType||!i.glInternalFormat||!i.glDataFormat)a.log("pixelformat wrong ?!",t,i.glDataType,i.glInternalFormat,i.glDataFormat,this);return i};u.getPixelFormatNumChannels=e=>{if(e.startsWith("RGBA"))return 4;if(e.startsWith("RGB"))return 3;if(e.startsWith("RG"))return 2;return 1};u.isPixelFormatFloat=e=>{return(e||"").includes("float")};u.isPixelFormatHalfFloat=e=>{return(e||"").includes("float")&&(e||"").includes("16bit")}},771:(e,t,i)=>{"use strict";i.d(t,{p:()=>o});var s=i(849);var r=i(70);var n=i(273);class o{constructor(e,t){this._cgl=e;this._log=new s.A("cgl_TextureEffect");if(!e.TextureEffectMesh)this.createMesh();this._textureSource=null;this._options=t;this.name=t.name||"unknown";this.imgCompVer=0;this.aspectRatio=1;this._textureTarget=null;this._frameBuf=this._cgl.gl.createFramebuffer();this._frameBuf2=this._cgl.gl.createFramebuffer();this._renderbuffer=this._cgl.gl.createRenderbuffer();this._renderbuffer2=this._cgl.gl.createRenderbuffer();this.switched=false;this.depth=false}dispose(){if(this._renderbuffer)this._cgl.gl.deleteRenderbuffer(this._renderbuffer);if(this._frameBuf)this._cgl.gl.deleteFramebuffer(this._frameBuf);if(this._renderbuffer2)this._cgl.gl.deleteRenderbuffer(this._renderbuffer2);if(this._frameBuf2)this._cgl.gl.deleteFramebuffer(this._frameBuf2)}getWidth(){return this._textureSource.width}getHeight(){return this._textureSource.height}setSourceTexture(e){if(e===null){this._textureSource=new r.g(this._cgl);this._textureSource.setSize(16,16)}else{this._textureSource=e}if(!this._textureSource.compareSettings(this._textureTarget)){if(this._textureTarget)this._textureTarget.delete();this._textureTarget=this._textureSource.clone();this._cgl.profileData.profileEffectBuffercreate++;this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._renderbuffer);if(this.depth)this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,this._cgl.gl.DEPTH_COMPONENT16,this._textureSource.width,this._textureSource.height);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.TEXTURE_2D,this._textureTarget.tex,0);if(this.depth)this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._renderbuffer);this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf2);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._renderbuffer2);if(this.depth)this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,this._cgl.gl.DEPTH_COMPONENT16,this._textureSource.width,this._textureSource.height);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.TEXTURE_2D,this._textureSource.tex,0);if(this.depth)this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._renderbuffer2);this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null)}this.aspectRatio=this._textureSource.width/this._textureSource.height}continueEffect(){this._cgl.pushDepthTest(false);this._cgl.pushModelMatrix();this._cgl.pushPMatrix();this._cgl.pushViewPort(0,0,this.getCurrentTargetTexture().width,this.getCurrentTargetTexture().height);mat4.perspective(this._cgl.pMatrix,45,this.getCurrentTargetTexture().width/this.getCurrentTargetTexture().height,.1,1100);this._cgl.pushPMatrix();mat4.identity(this._cgl.pMatrix);this._cgl.pushViewMatrix();mat4.identity(this._cgl.vMatrix);this._cgl.pushModelMatrix();mat4.identity(this._cgl.mMatrix)}startEffect(e){if(!this._textureTarget){this._log.warn("effect has no target");return}this.switched=false;this.continueEffect();if(e){this._bgTex=e}this._countEffects=0}endEffect(){this._cgl.popDepthTest();this._cgl.popModelMatrix();this._cgl.popPMatrix();this._cgl.popModelMatrix();this._cgl.popViewMatrix();this._cgl.popPMatrix();this._cgl.popViewPort()}bind(){if(this._textureSource===null){this._log.warn("no base texture set!");return}if(!this.switched){this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf);this._cgl.pushGlFrameBuffer(this._frameBuf)}else{this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf2);this._cgl.pushGlFrameBuffer(this._frameBuf2)}}finish(){if(this._textureSource===null){this._log.warn("no base texture set!");return}this._cgl.TextureEffectMesh.render(this._cgl.getShader());this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.popGlFrameBuffer());this._cgl.profileData.profileTextureEffect++;if(this._textureTarget.filter==r.g.FILTER_MIPMAP){if(!this.switched){this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,this._textureTarget.tex);this._textureTarget.updateMipMap()}else{this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,this._textureSource.tex);this._textureSource.updateMipMap()}this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null)}this.switched=!this.switched;this._countEffects++}getCurrentTargetTexture(){if(this.switched)return this._textureSource;return this._textureTarget}getCurrentSourceTexture(){if(this._countEffects==0&&this._bgTex)return this._bgTex;if(this.switched)return this._textureTarget;return this._textureSource}delete(){if(this._textureTarget)this._textureTarget.delete();if(this._textureSource)this._textureSource.delete();this._cgl.gl.deleteRenderbuffer(this._renderbuffer);this._cgl.gl.deleteFramebuffer(this._frameBuf)}createMesh(){this._cgl.TextureEffectMesh=n.S.getSimpleRect(this._cgl,"texEffectRect")}}o.checkOpNotInTextureEffect=function(e){if(!e.patch.cgl)return true;if(e.uiAttribs.error&&!e.patch.cgl.currentTextureEffect){e.setUiError("textureeffect",null);return true}if(!e.patch.cgl.currentTextureEffect)return true;if(e.patch.cgl.currentTextureEffect&&!e.uiAttribs.error){e.setUiError("textureeffect","This op can not be a child of a ImageCompose/texture effect! imagecompose should only have textureeffect childs.",0);return false}if(e.patch.cgl.currentTextureEffect)return false;return true};o.checkOpInEffect=function(e,t){t=t||0;if(e.patch.cgl.currentTextureEffect){if(e.uiAttribs.uierrors&&e.patch.cgl.currentTextureEffect.imgCompVer>=t){e.setUiError("texeffect",null);return true}if(t&&e.patch.cgl.currentTextureEffect.imgCompVer<t){e.setUiError("texeffect","This op must be a child of an ImageCompose op with version >="+t+' <span class="button-small" onclick="gui.patchView.downGradeOp(\''+e.id+"','"+e.name+"')\">Downgrade</span> to previous version",1)}}if(e.patch.cgl.currentTextureEffect)return true;if(!e.patch.cgl.currentTextureEffect&&(!e.uiAttribs.uierrors||e.uiAttribs.uierrors.length==0)){e.setUiError("texeffect",'This op must be a child of an ImageCompose op! More infos <a href="https://cables.gl/docs/image_composition/image_composition.html" target="_blank">here</a>. ',1);return false}if(!e.patch.cgl.currentTextureEffect)return false;return true};o.getBlendCode=function(e){let t="".endl()+"vec3 _blend(vec3 base,vec3 blend)".endl()+"{".endl()+"   vec3 colNew=blend;".endl()+"   #ifdef BM_MULTIPLY".endl()+"       colNew=base*blend;".endl()+"   #endif".endl()+"   #ifdef BM_MULTIPLY_INV".endl()+"       colNew=base* vec3(1.0)-blend;".endl()+"   #endif".endl()+"   #ifdef BM_AVERAGE".endl()+"       colNew=((base + blend) / 2.0);".endl()+"   #endif".endl()+"   #ifdef BM_ADD".endl()+"       colNew=min(base + blend, vec3(1.0));".endl()+"   #endif".endl()+"   #ifdef BM_SUBTRACT_ONE".endl()+"       colNew=max(base + blend - vec3(1.0), vec3(0.0));".endl()+"   #endif".endl()+"   #ifdef BM_SUBTRACT".endl()+"       colNew=base - blend;".endl()+"   #endif".endl()+"   #ifdef BM_DIFFERENCE".endl()+"       colNew=abs(base - blend);".endl()+"   #endif".endl()+"   #ifdef BM_NEGATION".endl()+"       colNew=(vec3(1.0) - abs(vec3(1.0) - base - blend));".endl()+"   #endif".endl()+"   #ifdef BM_EXCLUSION".endl()+"       colNew=(base + blend - 2.0 * base * blend);".endl()+"   #endif".endl()+"   #ifdef BM_LIGHTEN".endl()+"       colNew=max(blend, base);".endl()+"   #endif".endl()+"   #ifdef BM_DARKEN".endl()+"       colNew=min(blend, base);".endl()+"   #endif".endl()+"   #ifdef BM_OVERLAY".endl()+"      #define BlendOverlayf(base, blend)  (base < 0.5 ? (2.0 * base * blend) : (1.0 - 2.0 * (1.0 - base) * (1.0 - blend)))".endl()+"      colNew=vec3(BlendOverlayf(base.r, blend.r),BlendOverlayf(base.g, blend.g),BlendOverlayf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_SCREEN".endl()+"      #define BlendScreenf(base, blend)       (1.0 - ((1.0 - base) * (1.0 - blend)))".endl()+"      colNew=vec3(BlendScreenf(base.r, blend.r),BlendScreenf(base.g, blend.g),BlendScreenf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_SOFTLIGHT".endl()+"      #define BlendSoftLightf(base, blend)    ((blend < 0.5) ? (2.0 * base * blend + base * base * (1.0 - 2.0 * blend)) : (sqrt(base) * (2.0 * blend - 1.0) + 2.0 * base * (1.0 - blend)))".endl()+"      colNew=vec3(BlendSoftLightf(base.r, blend.r),BlendSoftLightf(base.g, blend.g),BlendSoftLightf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_HARDLIGHT".endl()+"      #define BlendOverlayf(base, blend)  (base < 0.5 ? (2.0 * base * blend) : (1.0 - 2.0 * (1.0 - base) * (1.0 - blend)))".endl()+"      colNew=vec3(BlendOverlayf(base.r, blend.r),BlendOverlayf(base.g, blend.g),BlendOverlayf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_COLORDODGE".endl()+"      #define BlendColorDodgef(base, blend)   ((blend == 1.0) ? blend : min(base / (1.0 - blend), 1.0))".endl()+"      colNew=vec3(BlendColorDodgef(base.r, blend.r),BlendColorDodgef(base.g, blend.g),BlendColorDodgef(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_COLORBURN".endl()+"      #define BlendColorBurnf(base, blend)    ((blend == 0.0) ? blend : max((1.0 - ((1.0 - base) / blend)), 0.0))".endl()+"      colNew=vec3(BlendColorBurnf(base.r, blend.r),BlendColorBurnf(base.g, blend.g),BlendColorBurnf(base.b, blend.b));".endl()+"   #endif".endl()+"   return colNew;".endl()+"}".endl();if(!e)t+="vec4 cgl_blend(vec4 oldColor,vec4 newColor,float amount)".endl()+"{".endl()+"vec4 col=vec4( _blend(oldColor.rgb,newColor.rgb) ,1.0);".endl()+"col=vec4( mix( col.rgb, oldColor.rgb ,1.0-oldColor.a*amount),1.0);".endl()+"return col;".endl()+"}".endl();if(e>=3)t+="vec4 cgl_blendPixel(vec4 base,vec4 col,float amount)".endl()+"{".endl()+"#ifdef BM_MATH_ADD".endl()+"   return vec4(base.rgb+col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifdef BM_MATH_SUB".endl()+"   return vec4(base.rgb-col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifdef BM_MATH_MUL".endl()+"   return vec4(base.rgb*col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifdef BM_MATH_DIV".endl()+"   return vec4(base.rgb/col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifndef BM_MATH".endl()+"vec3 colNew=_blend(base.rgb,col.rgb);".endl()+"float newA=clamp(base.a+(col.a*amount),0.,1.);".endl()+"#ifdef BM_ALPHAMASKED".endl()+"newA=base.a;".endl()+"#endif".endl()+"return vec4(".endl()+"mix(colNew,base.rgb,1.0-(amount*col.a)),".endl()+"newA);".endl()+"#endif".endl()+"}".endl();return t};o.onChangeBlendSelect=function(e,t,i=false){t=String(t);e.toggleDefine("BM_NORMAL",t=="normal");e.toggleDefine("BM_MULTIPLY",t=="multiply");e.toggleDefine("BM_MULTIPLY_INV",t=="multiply invert");e.toggleDefine("BM_AVERAGE",t=="average");e.toggleDefine("BM_ADD",t=="add");e.toggleDefine("BM_SUBTRACT_ONE",t=="subtract one");e.toggleDefine("BM_SUBTRACT",t=="subtract");e.toggleDefine("BM_DIFFERENCE",t=="difference");e.toggleDefine("BM_NEGATION",t=="negation");e.toggleDefine("BM_EXCLUSION",t=="exclusion");e.toggleDefine("BM_LIGHTEN",t=="lighten");e.toggleDefine("BM_DARKEN",t=="darken");e.toggleDefine("BM_OVERLAY",t=="overlay");e.toggleDefine("BM_SCREEN",t=="screen");e.toggleDefine("BM_SOFTLIGHT",t=="softlight");e.toggleDefine("BM_HARDLIGHT",t=="hardlight");e.toggleDefine("BM_COLORDODGE",t=="color dodge");e.toggleDefine("BM_COLORBURN",t=="color burn");e.toggleDefine("BM_MATH_ADD",t=="Math Add");e.toggleDefine("BM_MATH_SUB",t=="Math Subtract");e.toggleDefine("BM_MATH_MUL",t=="Math Multiply");e.toggleDefine("BM_MATH_DIV",t=="Math Divide");e.toggleDefine("BM_MATH",t.indexOf("Math ")==0);e.toggleDefine("BM_ALPHAMASKED",i)};o.AddBlendSelect=function(e,t,i){const s=e.inValueSelect(t||"Blend Mode",["normal","lighten","darken","multiply","multiply invert","average","add","subtract","difference","negation","exclusion","overlay","screen","color dodge","color burn","softlight","hardlight","subtract one","Math Add","Math Subtract","Math Multiply","Math Divide"],i||"normal");return s};o.AddBlendAlphaMask=function(e,t,i){const s=e.inSwitch(t||"Alpha Mask",["Off","On"],i||"Off");return s};o.setupBlending=function(i,s,r,e,n){const t=()=>{let e=false;if(n)e=n.get()=="On";o.onChangeBlendSelect(s,r.get(),e);let t=r.get();if(t=="normal")t=null;else if(t=="multiply")t="mul";else if(t=="multiply invert")t="mulinv";else if(t=="lighten")t="light";else if(t=="darken")t="darken";else if(t=="average")t="avg";else if(t=="subtract one")t="sub one";else if(t=="subtract")t="sub";else if(t=="difference")t="diff";else if(t=="negation")t="neg";else if(t=="exclusion")t="exc";else if(t=="overlay")t="ovl";else if(t=="color dodge")t="dodge";else if(t=="color burn")t="burn";else if(t=="softlight")t="soft";else if(t=="hardlight")t="hard";else if(t=="Math Add")t="+";else if(t=="Math Subtract")t="-";else if(t=="Math Multiply")t="*";else if(t=="Math Divide")t="/";i.setUiAttrib({extendTitle:t})};i.setPortGroup("Blending",[r,e,n]);let a=false;r.onChange=t;if(n){n.onChange=t;a=n.get()=="On"}o.onChangeBlendSelect(s,r.get(),a)}},997:(e,t,i)=>{"use strict";i.d(t,{a:()=>o,nl:()=>l});const s={SHADERVAR_VERTEX_POSITION:"vPosition",SHADERVAR_VERTEX_NUMBER:"attrVertIndex",SHADERVAR_VERTEX_NORMAL:"attrVertNormal",SHADERVAR_VERTEX_TEXCOORD:"attrTexCoord",SHADERVAR_INSTANCE_MMATRIX:"instMat",SHADERVAR_VERTEX_COLOR:"attrVertColor",SHADERVAR_INSTANCE_INDEX:"instanceIndex",SHADERVAR_UNI_PROJMAT:"projMatrix",SHADERVAR_UNI_VIEWMAT:"viewMatrix",SHADERVAR_UNI_MODELMAT:"modelMatrix",SHADERVAR_UNI_NORMALMAT:"normalMatrix",SHADERVAR_UNI_INVVIEWMAT:"inverseViewMatrix",SHADERVAR_UNI_INVPROJMAT:"invProjMatrix",SHADERVAR_UNI_MATERIALID:"materialId",SHADERVAR_UNI_OBJECTID:"objectId",SHADERVAR_UNI_VIEWPOS:"camPos"};const r={BLEND_NONE:0,BLEND_NORMAL:1,BLEND_ADD:2,BLEND_SUB:3,BLEND_MUL:4};const n=180/Math.PI;const a=Math.PI/180;const o={MATH:{DEG2RAD:a,RAD2DEG:n},SHADER:s,BLEND_MODES:r};const l="\n"},772:(e,t,i)=>{"use strict";i.d(t,{Rq:()=>P});var c=i(344);var a=i(849);var l=i(70);class s{constructor(t,e,i,s){this._log=new a.A("cgl_framebuffer2");if(t.glVersion==1)this._log.error("framebuffer2 used on webgl1");this.Framebuffer2DrawTargetsDefault=null;this.Framebuffer2BlittingFramebuffer=null;this.Framebuffer2FinalFramebuffer=null;this._cgl=t;this._cgl.printError("before framebuffer2 constructor");this._width=0;this._height=0;this.valid=true;this._depthRenderbuffer=null;this._frameBuffer=null;this._textureFrameBuffer=null;this._colorRenderbuffers=[];this._drawTargetArray=[];this._disposed=false;if(!this.Framebuffer2BlittingFramebuffer)this.Framebuffer2BlittingFramebuffer=t.gl.createFramebuffer();if(!this.Framebuffer2FinalFramebuffer)this.Framebuffer2FinalFramebuffer=t.gl.createFramebuffer();if(!this.Framebuffer2DrawTargetsDefault)this.Framebuffer2DrawTargetsDefault=[t.gl.COLOR_ATTACHMENT0];this._options=s||{isFloatingPointTexture:false};this.name=this._options.name||"unknown";this._cgl.profileData.addHeavyEvent("framebuffer create",this.name);if(!this._options.hasOwnProperty("numRenderBuffers"))this._options.numRenderBuffers=1;if(!this._options.hasOwnProperty("depth"))this._options.depth=true;if(!this._options.hasOwnProperty("clear"))this._options.clear=true;if(!this._options.hasOwnProperty("multisampling")){this._options.multisampling=false;this._options.multisamplingSamples=0}if(this._options.multisamplingSamples){if(this._cgl.glSlowRenderer)this._options.multisamplingSamples=0;if(!this._cgl.gl.MAX_SAMPLES)this._options.multisamplingSamples=0;else this._options.multisamplingSamples=Math.min(this._cgl.maxSamples,this._options.multisamplingSamples)}if(!this._options.hasOwnProperty("filter"))this._options.filter=l.g.FILTER_LINEAR;if(!this._options.hasOwnProperty("wrap"))this._options.wrap=l.g.WRAP_REPEAT;this._numRenderBuffers=this._options.numRenderBuffers;this._colorTextures=[];this.clearColors=[];for(let e=0;e<this._numRenderBuffers;e++)this.clearColors.push([0,0,0,1]);if(!s.pixelFormat){if(s.isFloatingPointTexture)this._options.pixelFormat=l.g.PFORMATSTR_RGBA32F;else this._options.pixelFormat=l.g.PFORMATSTR_RGBA8UB}for(let e=0;e<this._numRenderBuffers;e++){this._colorTextures[e]=new l.g(t,{name:"fb2 "+this.name+" "+e,isFloatingPointTexture:this._options.isFloatingPointTexture,anisotropic:this._options.anisotropic||0,pixelFormat:this._options.pixelFormat,filter:this._options.filter,wrap:this._options.wrap})}let r=l.g.FILTER_NEAREST;if(this._options.shadowMap)r=l.g.FILTER_LINEAR;const n=512;if(this._options.depth){this._textureDepth=new l.g(t,{name:"fb2 depth "+this.name,isDepthTexture:true,filter:r,shadowMap:this._options.shadowMap||false,width:e||n,height:i||n})}if(t.aborted)return;this.setSize(e||n,i||n);this._cgl.printError("framebuffer2 constructor")}getWidth(){return this._width}getHeight(){return this._height}getGlFrameBuffer(){return this._frameBuffer}getDepthRenderBuffer(){return this._depthRenderbuffer}getTextureColor(){return this._colorTextures[0]}getTextureColorNum(e){return this._colorTextures[e]}getTextureDepth(){return this._textureDepth}setFilter(t){for(let e=0;e<this._numRenderBuffers;e++){this._colorTextures[e].filter=t;this._colorTextures[e].setSize(this._width,this._height)}}delete(){this.dispose()}dispose(){this._disposed=true;let e=0;for(e=0;e<this._numRenderBuffers;e++)this._colorTextures[e].delete();if(this._textureDepth)this._textureDepth.delete();for(e=0;e<this._numRenderBuffers;e++)this._cgl.gl.deleteRenderbuffer(this._colorRenderbuffers[e]);this._cgl.gl.deleteRenderbuffer(this._depthRenderbuffer);this._cgl.gl.deleteFramebuffer(this._frameBuffer);this._cgl.gl.deleteFramebuffer(this._textureFrameBuffer)}setSize(e,t){if(this._disposed)return this._log.warn("disposed framebuffer setsize...");this._cgl.profileData.addHeavyEvent("framebuffer resize",this.name);let i=0;this._width=this._cgl.checkTextureSize(e);this._height=this._cgl.checkTextureSize(t);this._cgl.profileData.profileFrameBuffercreate++;if(this._frameBuffer){for(i=0;i<this._numRenderBuffers;i++)this._cgl.gl.deleteRenderbuffer(this._colorRenderbuffers[i]);this._cgl.gl.deleteRenderbuffer(this._depthRenderbuffer);this._cgl.gl.deleteFramebuffer(this._frameBuffer);this._cgl.gl.deleteFramebuffer(this._textureFrameBuffer)}this._frameBuffer=this._cgl.gl.createFramebuffer();this._textureFrameBuffer=this._cgl.gl.createFramebuffer();const s=this._options.depth;for(i=0;i<this._numRenderBuffers;i++){this._colorTextures[i].setSize(this._width,this._height)}for(i=0;i<this._numRenderBuffers;i++){const a=this._cgl.gl.createRenderbuffer();this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,a);const o=l.g.setUpGlPixelFormat(this._cgl,this._options.pixelFormat);let e=o.glInternalFormat;if(CGL.Texture.isPixelFormatHalfFloat(o.pixelFormat)){if(!this._cgl.enableExtension("OES_texture_float_linear")){this._options.filter=l.g.FILTER_NEAREST;this.setFilter(this._options.filter)}}else if(CGL.Texture.isPixelFormatFloat(o.pixelFormat)){if(!this._cgl.enableExtension("OES_texture_float_linear")){this._log.warn("no linear pixelformat,using nearest");this._options.filter=l.g.FILTER_NEAREST;this.setFilter(this._options.filter)}}if(this._options.multisampling&&this._options.multisamplingSamples){this._cgl.gl.renderbufferStorageMultisample(this._cgl.gl.RENDERBUFFER,this._options.multisamplingSamples,e,this._width,this._height)}else{this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,e,this._width,this._height)}this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0+i,this._cgl.gl.RENDERBUFFER,a);this._colorRenderbuffers[i]=a}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._textureFrameBuffer);for(i=0;i<this._numRenderBuffers;i++){this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0+i,this._cgl.gl.TEXTURE_2D,this._colorTextures[i].tex,0)}if(this._options.depth){this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.TEXTURE_2D,this._textureDepth.tex,0)}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);let r=this._cgl.gl.DEPTH_COMPONENT32F;if(this._cgl.glSlowRenderer)r=this._cgl.gl.DEPTH_COMPONENT16;if(s){this._textureDepth.setSize(this._width,this._height);this._depthRenderbuffer=this._cgl.gl.createRenderbuffer();this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._depthRenderbuffer);if(this._options.isFloatingPointTexture){if(this._options.multisampling)this._cgl.gl.renderbufferStorageMultisample(this._cgl.gl.RENDERBUFFER,this._options.multisamplingSamples,r,this._width,this._height);else this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,r,this._width,this._height)}else if(this._options.multisampling){this._cgl.gl.renderbufferStorageMultisample(this._cgl.gl.RENDERBUFFER,this._options.multisamplingSamples,r,this._width,this._height)}else{this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,r,this._width,this._height)}this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._depthRenderbuffer)}this._drawTargetArray.length=0;for(i=0;i<this._numRenderBuffers;i++)this._drawTargetArray.push(this._cgl.gl.COLOR_ATTACHMENT0+i);if(!this._cgl.gl.isFramebuffer(this._textureFrameBuffer))this._log.warn("invalid framebuffer");const n=this._cgl.gl.checkFramebufferStatus(this._cgl.gl.FRAMEBUFFER);if(n!=this._cgl.gl.FRAMEBUFFER_COMPLETE){this._log.error("framebuffer incomplete: "+this.name,this);this._log.log("options",this._options);this._log.log("options pixelformat",this._options.pixelFormat);switch(n){case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:this._log.warn("FRAMEBUFFER_INCOMPLETE_ATTACHMENT...",this);throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:this._log.warn("FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:this._log.warn("FRAMEBUFFER_INCOMPLETE_DIMENSIONS");throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case this._cgl.gl.FRAMEBUFFER_UNSUPPORTED:this._log.warn("FRAMEBUFFER_UNSUPPORTED");throw new Error("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:this.valid=false;this._log.error("incomplete framebuffer",n,this._frameBuffer);this._cgl.printError();this._frameBuffer=null;throw new Error("Incomplete framebuffer: "+n)}}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,null)}renderStart(){if(this._disposed)return this._log.warn("disposed framebuffer renderStart...");this._cgl.checkFrameStarted("fb2 renderstart");this._cgl.pushModelMatrix();this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);this._cgl.pushGlFrameBuffer(this._frameBuffer);this._cgl.pushFrameBuffer(this);this._cgl.pushPMatrix();this._cgl.pushViewPort(0,0,this._width,this._height);this._cgl.gl.drawBuffers(this._drawTargetArray);if(this._options.clear){this._cgl.gl.clearColor(0,0,0,0);this._cgl.gl.clear(this._cgl.gl.COLOR_BUFFER_BIT|this._cgl.gl.DEPTH_BUFFER_BIT)}}clear(){if(this._numRenderBuffers<=1){this._cgl.gl.bindFramebuffer(this._cgl.gl.READ_FRAMEBUFFER,this._frameBuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.DRAW_FRAMEBUFFER,this._textureFrameBuffer)}else this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);this._cgl.gl.drawBuffers(this._drawTargetArray);for(let e=0;e<this._numRenderBuffers;e++){this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0+e,this._cgl.gl.TEXTURE_2D,this._colorTextures[e].tex,0);this._cgl.gl.clearBufferfv(this._cgl.gl.COLOR,e,this.clearColors[e])}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null)}renderEnd(){if(this._disposed)return this._log.warn("disposed framebuffer renderEnd...");this._cgl.popPMatrix();this._cgl.profileData.profileFramebuffer++;if(this._numRenderBuffers<=1){this._cgl.gl.bindFramebuffer(this._cgl.gl.READ_FRAMEBUFFER,this._frameBuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.DRAW_FRAMEBUFFER,this._textureFrameBuffer);this._cgl.gl.clearBufferfv(this._cgl.gl.COLOR,0,[0,0,0,1]);this._cgl.gl.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,this._cgl.gl.COLOR_BUFFER_BIT|this._cgl.gl.DEPTH_BUFFER_BIT,this._cgl.gl.NEAREST)}else{this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2BlittingFramebuffer);this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._depthRenderbuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2FinalFramebuffer);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.TEXTURE_2D,this._textureDepth.tex,0);for(let t=0;t<this._numRenderBuffers;t++){this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2BlittingFramebuffer);this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.RENDERBUFFER,this._colorRenderbuffers[t]);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2FinalFramebuffer);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.TEXTURE_2D,this._colorTextures[t].tex,0);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.READ_FRAMEBUFFER,this.Framebuffer2BlittingFramebuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.DRAW_FRAMEBUFFER,this.Framebuffer2FinalFramebuffer);let e=this._cgl.gl.COLOR_BUFFER_BIT;if(t==0)e|=this._cgl.gl.DEPTH_BUFFER_BIT;this._cgl.gl.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,e,this._cgl.gl.NEAREST)}}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.popGlFrameBuffer());this._cgl.popFrameBuffer();this._cgl.popModelMatrix();this._cgl.popViewPort();if(this._colorTextures[0].filter==l.g.FILTER_MIPMAP){for(let e=0;e<this._numRenderBuffers;e++){this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,this._colorTextures[e].tex);this._colorTextures[e].updateMipMap();this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null)}}}}const r=function(e){this.draw=function(e,t,i){}};const n=function(e){this.render=function(e,t){}};const o=function(e){this.render=function(e,t,i,s){}};var h=i(264);var u=i(923);var f=i(960);class g{constructor(e){this.shader=new CGL.Shader(e,"markermaterial");const t="".endl()+"void main()".endl()+"{".endl()+"    outColor = vec4(color.rgb,1.0);".endl()+"}";const i="".endl()+"IN vec3 vPosition;".endl()+"UNI mat4 projMatrix;".endl()+"UNI mat4 mvMatrix;".endl()+"void main()".endl()+"{".endl()+"   gl_Position = projMatrix * mvMatrix * vec4(vPosition,1.0);".endl()+"}";this.shader.setSource(i,t);this.coloruni=this.shader.addUniformFrag("4f","color",[1,.777,1,1])}setColor(e,t,i,s){this.coloruni.set(e,t,i,s)}}var d=i(24);var m=i(273);const p=Math.PI/180;const _=180/Math.PI;const v=null;const E=window.navigator.userAgent.includes("Windows");const b=function(t){let i;if(t.wheelDelta){i=t.wheelDelta%120-0==-0?t.wheelDelta/120:t.wheelDelta/30;i*=-1.5;if(E)i*=2}else{let e=t.deltaY;if(t.shiftKey)e=t.deltaX;const s=e||t.detail;i=-(s%3?s*10:s/3);i*=-3}if(i>20)i=20;if(i<-20)i=-20;return i};const x=b;const T=b;var A=i(771);var S=i(997);var M=i(460);var I=i(331);var O=i(982);var R=i(868);var C=i(308);const P={Framebuffer2:s,Geometry:I.V,BoundingBox:O.I,Marker:r,WirePoint:n,WireCube:o,MatrixStack:R.u,Mesh:h.e,MESH:h.C,ShaderLibMods:f.y,Shader:d.M,Uniform:u.n,MESHES:m.S,getWheelSpeed:x,getWheelDelta:T,Context:C.G,Texture:l.g,TextureEffect:A.p,onLoadingAssetsFinished:v,ProfileData:M.E,UniColorShader:g,...S.a.BLEND_MODES,...S.a.SHADER,...S.a.MATH,...S.a.BLEND_MODES};window.CABLES=window.CABLES||{};window.CABLES.CGL=window.CABLES.CGL||P;window.CGL=window.CGL||P;c.k.slerpQuaternion=function(e,t,i,s,r,n){if(!c.k.slerpQuaternion.q1){c.k.slerpQuaternion.q1=quat.create();c.k.slerpQuaternion.q2=quat.create()}const a=i.getKeyIndex(e);let o=a+1;if(o>=i.keys.length)o=i.keys.length-1;if(a==o){quat.set(t,i.keys[a].value,s.keys[a].value,r.keys[a].value,n.keys[a].value)}else{const l=i.keys[a].time;const h=i.keys[o].time;const u=(e-l)/(h-l);quat.set(c.k.slerpQuaternion.q1,i.keys[a].value,s.keys[a].value,r.keys[a].value,n.keys[a].value);quat.set(c.k.slerpQuaternion.q2,i.keys[o].value,s.keys[o].value,r.keys[o].value,n.keys[o].value);quat.slerp(t,c.k.slerpQuaternion.q1,c.k.slerpQuaternion.q2,u)}return t}},626:(e,t,i)=>{"use strict";var r=i(849);var s=i(628);var n=i(356);var a=i(684);var o=i(920);var l=i(475);class h extends l.v{#cgp=null;gpuBuffer=null;gpuBufferChanged=false;constructor(e,t,i,s,r,n,a){super(e,t,i,s,r,n,a);this.#cgp=e._cgp;if(!s||s.get&&!s.get()){if(this.getType()=="t"){this._value=this.#cgp.getEmptyTexture()}}}getInfo(){return{name:this.name,type:this.type,value:this.getValue()}}updateValueF(){}updateValueArrayF(){}setValueArrayF(e){this.needsUpdate=true;this._value=e}setValueF(e){this.needsUpdate=true;this._value=e}updateValue2F(){}setValue2F(e){this.needsUpdate=true;this._value=e}updateValue3F(){}setValue3F(e){this.needsUpdate=true;this._value=e}updateValue4F(){}setValue4F(e){if(e[0]==undefined){this._log.stack("uniform value undefined");console.error("uniform value undefined")}this.needsUpdate=true;this._value=e}setValueT(e){this.needsUpdate=true;this._value=e}updateValueM4(e){}setValueM4(e){this.needsUpdate=true;this._value=e}setValueAny(e){this.needsUpdate=true;this._value=e}updateValueAny(){}updateValueT(){}setGpuBuffer(e){this.gpuBufferChanged=true;this.gpuBuffer=e}copyToBuffer(t,i=0){if(this._type=="f"){t[i]=this._value}else if(this._type=="t"){}else if(this._type=="4f"){t[i]=this._value[0];t[i+1]=this._value[1];t[i+2]=this._value[2];t[i+3]=this._value[3]}else if(this._type=="2f"){t[i]=this._value[0];t[i+1]=this._value[1]}else if(this._type=="3f"){t[i]=this._value[0];t[i+1]=this._value[1];t[i+2]=this._value[2]}else if(this._type=="f[]"){for(let e=0;e<this._value.length;e++)t[i+e]=this._value[e]}else if(this._type=="m4"){for(let e=0;e<16;e++)t[i+e]=this._value[e]}else{this._log.warn("uniform copy to buffer unknown",this._type)}}getWgslTypeStr(){if(this._type=="m4")return"mat4x4f";if(this._type=="4f")return"vec4f";if(this._type=="3f")return"vec3f";if(this._type=="2f")return"vec2f";if(this._type=="f")return"f32";if(this._type=="f[]")return"array<vec4f>";if(this._type=="i")return"int";if(this._type=="sampler")return"sampler";if(this._type=="t")return"texture_2d<f32>";this._log.warn("unknown type getWgslTypeStr",this._type);return"???"}getSizeBytes(){const e=4;const t=4;if(this._type=="t")return 4;if(this._type=="sampler")return 4;if(this._type=="f")return 1*e;if(this._type=="2f")return 2*e;if(this._type=="3f")return 3*e;if(this._type=="4f")return 4*e;if(this._type=="f[]")return this._value.length*e;if(this._type=="m4")return 4*4*e;if(this._type=="i")return 1*t;if(this._type=="2i")return 2*t;this._log.warn("unknown type getSizeBytes",this._type);return 4}copy(e){const t=new h(e,this._type,this._name,this._value,this._port2,this._port3,this._port4);t.shaderType=this.shaderType;return t}}function u(e,s){if(!e){console.warn("shader preproc no shader code given")}e=e||"";const r=e.split("\n");const n=[];let a=[];for(let i=0;i<r.length;i++){let e=r[i].trim();let t=e.split(" ");if(e.startsWith("#ifdef ")){const l=s[t[1]];a.push({state:l});continue}if(e.startsWith("#ifndef ")){const l=s[t[1]];a.push({state:!l});continue}if(e.startsWith("#endif")){a.pop();continue}const o=a[a.length-1];if(e.startsWith("#else")){o.state=!o.state;continue}if(!o||o.state){n.push(r[i])}}return n.join("\n")}var c=i(694);class f{#gpuBindGroups=[];#bindings=[];name="";needsPipelineUpdate=false;bla=1;#cgp;constructor(e,t){this.#cgp=e;this.name=t}hasBinding(e){return this.#bindings.includes(e)}getBindingByName(t){for(let e=0;e<this.#bindings.length;e++){if(this.#bindings[e].name==t)return this.#bindings[e]}}removeBinding(e){const t=this.#bindings.indexOf(e);this.#bindings.splice(t,1)}addBinding(e){const t=this.getBindingByName(e.name);if(t)this.removeBinding(t);e.needsRebuildBindgroup=true;e.bindNum=this.#bindings.length;this.#bindings.push(e);return e}getLayoutEntries(t){const i=[];for(let e=0;e<this.#bindings.length;e++){i.push(this.#bindings[e].getLayoutEntry(t))}if(i.length==0){}return i}getEntries(t){const i=[];for(let e=0;e<this.#bindings.length;e++){i.push(this.#bindings[e].getBindgroupEntry(t))}if(i.length==0){}return i}getLayout(e){const t=this.#cgp.device.createBindGroupLayout({label:"bindgrouplayout "+this.name,entries:this.getLayoutEntries(e)});return t}create(e){const t={label:" "+this.name+" i"+e,layout:this.getLayout(),entries:this.getEntries(e)};this.#cgp.profileData.count("bindgroup created",this.name);try{this.#gpuBindGroups[e]=this.#cgp.device.createBindGroup(t);this.needsRebuildBindgroup=true}catch(e){console.log(t);console.error(e)}this.updateValues(e)}updateValues(t){for(let e=0;e<this.#bindings.length;e++){this.#bindings[e].updateValues(t)}}bind(t=0,e=null,i=0){for(let e=0;e<this.#bindings.length;e++)if(this.#bindings[e].needsRebuildBindgroup){this.create(t);this.#bindings[e].needsRebuildBindgroup=false;this.#gpuBindGroups=[]}if(!this.#gpuBindGroups[t])this.create(t);(e||this.#cgp.passEncoder).setBindGroup(i,this.#gpuBindGroups[t])}getShaderHeaderCode(i,s){const r={vertex:"",fragment:"",compute:""};this.#cgp.profileData.count("bindgroup shadercode",this.name);for(let t=0;t<this.#bindings.length;t++){const n=this.#bindings[t];let e="";e+=n.getShaderHeaderCode(i,s);if(n.stage&GPUShaderStage.VERTEX)r.vertex+=e;else if(n.stage===GPUShaderStage.FRAGMENT)r.fragment+=e;else if(n.stage&GPUShaderStage.COMPUTE)r.compute+=e}return r}copy(t){const i=new f(this.#cgp,this.name);for(let e=0;e<this.#bindings.length;e++){i.addBinding(this.#bindings[e].copy(t))}return i}setBindingNums(){for(let e=0;e<this.#bindings.length;e++){this.#bindings[e].setBindNum(e)}}getInfo(){const t={name:this.name,bindings:[]};for(let e=0;e<this.#bindings.length;e++){t.bindings.push(this.#bindings[e].getInfo())}return t}}var g=i(562);var d=i(997);class m{id=g.simpleId();name="";bindNum=0;stage=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT;define="";log=new r.A("binding");needsRebuildBindgroup=false;cgp=null;constructor(e,t,i){this.cgp=e;this.name=t;if(!t)this.log.error("no binding name given");this.options=i||{};if(i.hasOwnProperty("stage"))this.stage=i.stage}getResource(e){return null}setBindNum(e){if(this.bindNum!=e)this.needsRebuildBindgroup=true;this.bindNum=e}getLayoutEntry(e){this.log.warn("unknown binding type?",this);return null}getBindgroupEntry(e){let t="layout "+this.name+" ["+this.constructor.name;t+="]";return{binding:this.bindNum,resource:this.getResource(e)}}isActiveByDefine(e){if(!this.define)return true;return true}updateValues(e){}getShaderHeaderCode(e,t){return"//getShaderHeaderCode function not emplemented "+d.nl}copy(e){return null}getInfo(){const e={name:this.name,id:this.id,class:this.constructor.name};return e}}var p=i(125);class _ extends p.A{#name="unknown";#cgp=null;#gpuBuffer=null;buffCfg=null;#length=0;id=g.shortId();floatArr=null;needsUpdate=true;#log;constructor(e,t,i=null,s={}){super();this.#log=new r.A("cgpGpubuffer");if(!e.supported)return;this.#name=t;this.buffCfg=s.buffCfg||{};if(i)this.setData(i);if(s.length)this.setLength(s.length);this.buffCfg.usage=this.buffCfg.usage||GPUBufferUsage.COPY_DST|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC;this.updateGpuBuffer(e)}setData(e){this.floatArr=new Float32Array(e);this.setLength(this.floatArr.length);this.needsUpdate=true}setLength(e){this.#length=e;if(!this.floatArr||e!=this.floatArr.length){this.floatArr=new Float32Array(this.#length);this.needsUpdate=true}}hasUsage(e){return(this.buffCfg.usage&e)===e}updateGpuBuffer(e=null){if(e)this.#cgp=e;if(!this.#cgp||!this.#cgp.device){this.#log.warn("no cgp...",this.#name,this.#cgp);return}this.#cgp.pushErrorScope("updateGpuBuffer");if(!this.#gpuBuffer||this.buffCfg.mappedAtCreation){this.buffCfg=this.buffCfg||{};this.buffCfg.label="gpuBuffer-"+this.#name;if(!this.buffCfg.hasOwnProperty("size")&&this.floatArr)this.buffCfg.size=this.floatArr.length*4;this.#gpuBuffer=this.#cgp.device.createBuffer(this.buffCfg)}if(this.floatArr){if(this.buffCfg.mappedAtCreation){new Float32Array(this.#gpuBuffer.getMappedRange()).set(this.floatArr);this.#gpuBuffer.unmap()}else this.#cgp.device.queue.writeBuffer(this.#gpuBuffer,0,this.floatArr.buffer,this.floatArr.byteOffset,this.floatArr.byteLength)}this.#cgp.popErrorScope();this.needsUpdate=false}get name(){return this.#name}get gpuBuffer(){if(!this.#gpuBuffer||this.needsUpdate)this.updateGpuBuffer();return this.#gpuBuffer}get length(){return this.#length}getSizeBytes(){return this.floatArr.length*4}dispose(){}}class v extends m{#uniforms=[];cgpBuffer=[];constructor(e,t,i){super(e,t,i);console.log("new binding uniform",this.id)}copy(s){const r=new v(this.cgp,this.name,this.options);console.log("copybinuni",this.id,r.id);r.stage=this.stage;for(let i=0;i<this.#uniforms.length;i++){let t=false;for(let e=0;e<s.worldUniforms.length;e++){if(s.worldUniforms[e].getName()==this.#uniforms[i].getName()){r.addUniform(s.worldUniforms[e]);t=true}}if(!t)r.addUniform(this.#uniforms[i])}return r}addUniform(e){this.#uniforms.push(e);this.needsRebuildBindgroup=true;console.log(this.#uniforms,this);return e}getResource(e){this.updateBuffer(e);return{buffer:this.cgpBuffer[e].gpuBuffer}}getSizeBytes(){let t=0;for(let e=0;e<this.#uniforms.length;e++)t+=this.#uniforms[e].getSizeBytes();return t}getUniform(t){for(let e=0;e<this.#uniforms.length;e++){if(this.#uniforms[e].name==t)return this.#uniforms[e]}return null}removeUniformByName(t){for(let e=0;e<this.#uniforms.length;e++)if(this.#uniforms[e].name==t){this.needsRebuildBindgroup=true;return this.#uniforms.splice(e,1)}}createBuffer(e){let t={label:this.name,size:this.getSizeBytes(),usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM};this.cgpBuffer[e]=new _(this.cgp,this.name+" buff",null,{buffCfg:t})}pipelineUpdated(){this.needsRebuildBindgroup=false}needsPipeUpdate(){return this.needsRebuildBindgroup}updateBuffer(t){let i={name:this.#uniforms.length+" uniforms","stage ":x.getStageString(this.stage),uniforms:[]};let e=this.getSizeBytes()/4;i.s=this.getSizeBytes();if(e==16)e=16;if(!this.cgpBuffer[t]){this.createBuffer(t)}this.cgpBuffer[t].setLength(e);let s=0;for(let e=0;e<this.#uniforms.length;e++){this.#uniforms[e].copyToBuffer(this.cgpBuffer[t].floatArr,s);if(this.#uniforms[e].gpuBufferChanged)console.log("un changed",this.cgpBuffer[t].floatArr);i.uniforms.push(this.#uniforms[e].getInfo());s+=this.#uniforms[e].getSizeBytes()/4}if(this.cgp.branchProfiler)this.cgp.branchProfiler.push("binding update buff",x.getStageString(this.stage),{info:i});this.cgpBuffer[t].updateGpuBuffer();if(this.cgp.branchProfiler)this.cgp.branchProfiler.pop()}getShaderHeaderCode(e,t){this.cgp.profileData.count("shadercode uni",this.name);let i="";let s="";let r=this.name;i+='//   [binding_uniform] - "'+this.name+'" '+this.id+" uniforms:"+this.#uniforms.length+"\n";if(!this.isActiveByDefine(e)){i+="// "+s+" "+this.name+": excluded because define "+this.define+"\n";return i}if(this.#uniforms.length>1){s="strct_"+r;i+="struct "+s+"\n";i+="{\n";for(let e=0;e<this.#uniforms.length;e++){i+="    "+this.#uniforms[e].name+": "+this.#uniforms[e].getWgslTypeStr();if(e!=this.#uniforms.length-1)i+=",";i+="\n"}i+="};\n"}else if(this.#uniforms.length==1){s=this.#uniforms[0].getWgslTypeStr();r=this.#uniforms[0].name}else if(this.#uniforms.length==0){return i}i+="@group("+t+") ";i+="@binding("+this.bindNum+") ";i+="var<uniform> ";i+=r+": "+s+";\n";return i+"\n"}getLayoutEntry(){return{visibility:this.stage,binding:this.bindNum,minBindingSize:this.getSizeBytes(),hasDynamicOffset:0,buffer:{}}}updateValues(e){for(let e=0;e<this.#uniforms.length;e++){}return this.updateBuffer(e)}getInfo(){const t={name:this.name,id:this.id,stage:this.stage,class:this.constructor.name,uniforms:[]};for(let e=0;e<this.#uniforms.length;e++){t.uniforms.push(this.#uniforms[e].getInfo())}return t}}class E extends m{smplDesc={addressModeU:"mirror-repeat",addressModeV:"mirror-repeat",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"};sampler=null;constructor(e,t,i){super(e,t,i);this.sampler=this.cgp.device.createSampler(this.smplDesc)}copy(){const e=new E(this.cgp,this.name,this.options);return e}getResource(){return this.sampler}getLayoutEntry(){return{visibility:this.stage,binding:this.bindNum,sampler:{}}}getShaderHeaderCode(e,t){let i="@group("+t+") @binding("+this.bindNum+") ";i+="var "+this.name+": sampler;".endl();return i}}class b extends m{sampler=null;uniform=null;constructor(e,t,i){super(e,t,i);this.uniform=i.uniform;if(this.uniform.port){this.uniform.port.on("change",()=>{this.needsRebuildBindgroup=true})}console.log(this.uniform)}copy(){const e=new b(this.cgp,this.name,this.options);return e}getResource(){if(this.uniform.getValue()&&this.uniform.getValue().gpuTexture)return this.uniform.getValue().gpuTexture.createView();else return this.cgp.getDefaultTexture().createView()}getLayoutEntry(){return{visibility:this.stage,binding:this.bindNum,texture:{}}}getShaderHeaderCode(e,t){let i="@group("+t+") @binding("+this.bindNum+") ";i+="var "+this.name+": "+this.uniform.getWgslTypeStr()+";\n";return i}}class x extends c.U{#lastCompileReason="first";uniModelMatrix;uniViewMatrix;uniProjMatrix;compilationInfo;constructor(e,t,i={}){super();if(!e)throw new Error("shader constructed without cgp "+t);this._log=new r.A("cgp_shader");this._cgp=e;this._name=t;this.options=i;this.options.compute=this.options.compute||false;if(!t)this._log.stack("no shader name given");this._name=t||"unknown";this.gpuShaderModule=null;this.frameUsageCounter=0;this.lastFrameUsageCounter=-2;this.frameUsageFrame=-1;this._bindingIndexCount=0;this.compileCount=0;this.worldUniforms=[];this.defaultBindGroup=new f(e,this._name);this.modsBindGroup=new f(e,this._name);this.bindGroups=[this.defaultBindGroup,this.modsBindGroup];if(!this.options.compute){this.defaultUniBindingVert=new v(e,"uniVert",{stage:GPUShaderStage.VERTEX});this.defaultBindGroup.addBinding(this.defaultUniBindingVert);this.defaultUniBindingFrag=new v(e,"uniFrag",{stage:GPUShaderStage.FRAGMENT});this.defaultBindGroup.addBinding(this.defaultUniBindingFrag)}else{this.defaultUniBindingCompute=new v(e,"uniCompute",{stage:GPUShaderStage.COMPUTE});this.defaultBindGroup.addBinding(this.defaultUniBindingCompute)}if(!this.options.compute){this.uniModelMatrix=this.addUniform(new h(this,"m4","modelMatrix"),GPUShaderStage.VERTEX);this.uniViewMatrix=this.addUniform(new h(this,"m4","viewMatrix"),GPUShaderStage.VERTEX);this.uniProjMatrix=this.addUniform(new h(this,"m4","projMatrix"),GPUShaderStage.VERTEX);this.uniNormalMatrix=this.addUniform(new h(this,"m4","normalMatrix"),GPUShaderStage.VERTEX);this.uniModelViewMatrix=this.addUniform(new h(this,"m4","modelViewMatrix"),GPUShaderStage.VERTEX);this._tempNormalMatrix=a.create();this._tempModelViewMatrix=a.create();this.worldUniforms.push(this.uniModelMatrix,this.uniViewMatrix,this.uniProjMatrix,this.uniNormalMatrix,this.uniModelViewMatrix)}this._src="";this._cgp.on("deviceChange",()=>{this.gpuShaderModule=null;this.setWhyCompile("device changed")})}reInit(){}isValid(){return this._isValid}getName(){return this._name}incFrameUsageCount(){if(this.frameUsageFrame!=this._cgp.frame){this.lastFrameUsageCounter=this.frameUsageCounter;this.frameUsageCounter=0}else this.frameUsageCounter++;this.frameUsageFrame=this._cgp.frame;return this.frameUsageCounter}getNewBindingGroupIndex(){return++this._bindingIndexCount}setSource(e){this._src=e;this.setWhyCompile("Source changed")}_replaceModPrefixes(e,t){return t.replace(/MOD_/g,e.prefix)}_replaceMods(e,s){let r="";for(let i=0;i<this._moduleNames.length;i++){let t="";for(let e=0;e<this._modules.length;e++){const n=this._modules[e];if(n.name==this._moduleNames[i]){r+=d.nl+d.nl+"//---- MOD: group:"+n.group+": idx:"+e+" - prfx:"+n.prefix+" - "+n.title+" ------"+d.nl;t+=d.nl+d.nl+"//---- MOD: "+n.title+" / "+n.priority+" ------"+d.nl;if(n.attributes)for(let e=0;e<n.attributes.length;e++){const a=this._getAttrSrc(n.attributes[e],false);if(a.srcHeadVert)r+=a.srcHeadVert;if(a.srcVert)t+=a.srcVert}r+=n.srcHead||"";t+=n.srcBody||"";r+=d.nl+"//---- end mod ------"+d.nl;t+=d.nl+"//---- end mod ------"+d.nl;t=this._replaceModPrefixes(n,t);r=this._replaceModPrefixes(n,r)}}t=u(t,s);e=e.replace("{{"+this._moduleNames[i]+"}}",t)}r=u(r,s);e=e.replace("{{MODULES_HEAD}}",r);return e}_replaceVertexOutputs(r=""){const n="{{VERTEX_OUTPUT";const i=r.indexOf(n);if(i>-1){try{let e=r.substring(i+n.length,i+100);let t=e.indexOf("}}");let s=parseInt(e.substring(0,t));for(let i=0;i<this._modules.length;i++){if(!this._modules[i].outputs)continue;let e=this._modules[i].outputs;let t=0;while(e.indexOf("@location("+t+")")>-1){e=e.replaceAll("@location("+t+")","@location("+(t+s)+")")}e=this._replaceModPrefixes(this._modules[i],e);r=r.replaceAll(n+" "+s+"}}",e)}}catch(e){console.log(e)}}return r}getDefines(){return this._defines}getProcessedSource(){const t={};for(let e=0;e<this._defines.length;e++)t[this._defines[e][0]]=this._defines[e][1]||true;let r="";r+=u(this._src,t);let i="";for(let e=0;e<this._defines.length;e++)i+="// #define "+this._defines[e]+"\n";let s="";let n="";let a="";for(let e=0;e<this.bindGroups.length;e++){const r=this.bindGroups[e].getShaderHeaderCode(this,e);n+=r.fragment||"";s+=r.vertex||"";a+=r.compute||""}if(this.options.compute)r=a+"\n\n////////////////\n\n"+r;else r=n+"\n\n////////////////\n\n"+s+"\n\n////////////////\n\n"+r;r=this._replaceMods(r,t);r=this._replaceVertexOutputs(r);const o="{{VERTEX_OUTPUT";const l=r.indexOf(o);if(l>-1){try{let e=r.substring(l+o.length,l+100);let t=e.indexOf("}}");let i=parseInt(e.substring(0,t));let s="@location("+i+") pos:vec4f, // generated";r=r.replaceAll(o+" "+i+"}}",s)}catch(e){console.log(e)}}r=i+"\n"+r;let e="//"+d.nl+"// ";if(this.options.compute)e+="Compute ";else e+="Render ";e+="Shader: "+this._name+" - "+this.id+d.nl;e+="//"+d.nl;return e+r}compile(){this._isValid=true;this._cgp.pushErrorScope("cgp_shader "+this._name);if(this._cgp.branchProfiler)this._cgp.branchProfiler.push("shadercompile",this._name,{info:this.getInfo()});this._cgp.profileData.count("shader compile",this._name);this.gpuShaderModule=this._cgp.device.createShaderModule({code:this.getProcessedSource(),label:this._name});this.gpuShaderModule.getCompilationInfo().then(t=>{this.compilationInfo=t;if(t.messages.length>0){let e=false;for(const i of t.messages){switch(i.type){case"error":console.error("Shader "+i.type+" at line "+i.lineNum+":"+i.linePos+" :"+i.message);e=true;case"warning":console.warn("Shader "+i.type+" at line "+i.lineNum+":"+i.linePos+" :"+i.message);break;case"info":console.info("Shader "+i.type+" at line "+i.lineNum+":"+i.linePos+" :"+i.message);break}}if(e){console.log("has errrrrrrrrrr");CABLES.UI.showShaderErrorCgp(this,t,this.getProcessedSource())}}});this._cgp.popErrorScope(this.error.bind(this));this.#lastCompileReason=this._compileReason;this.lastCompile=(0,o.tB)();this.emitEvent("compiled",this._compileReason);this._needsRecompile=false;this._compileReason="none";this.compileCount++;if(this._cgp.branchProfiler)this._cgp.branchProfiler.pop()}error(e){this._isValid=false}bind(t=null){this.incFrameUsageCount();if(!this.options.compute){this.uniModelMatrix.setValue(this._cgp.mMatrix);this.uniViewMatrix.setValue(this._cgp.vMatrix);this.uniProjMatrix.setValue(this._cgp.pMatrix);a.mul(this._tempModelViewMatrix,this._cgp.vMatrix,this._cgp.mMatrix);this.uniModelViewMatrix.setValue(this._tempModelViewMatrix);a.copy(this._tempNormalMatrix,this._cgp.mMatrix);a.invert(this._tempNormalMatrix,this._tempNormalMatrix);a.transpose(this._tempNormalMatrix,this._tempNormalMatrix);this.uniNormalMatrix.setValue(this._tempNormalMatrix)}for(let e=0;e<this.bindGroups.length;e++){this.bindGroups[e].updateValues(this.frameUsageCounter);this.bindGroups[e].bind(this.frameUsageCounter,t,e)}if(this._needsRecompile)this.compile()}getDefaultUniBinding(e){let t=this.defaultUniBindingFrag;if(e==GPUShaderStage.VERTEX)t=this.defaultUniBindingVert;if(this.options.compute&&e==GPUShaderStage.COMPUTE)t=this.defaultUniBindingCompute;return t}pipelineUpdated(){if(this.defaultUniBindingFrag)this.defaultUniBindingFrag.pipelineUpdated();if(this.defaultUniBindingVert)this.defaultUniBindingVert.pipelineUpdated();if(this.defaultUniBindingCompute)this.defaultUniBindingCompute.pipelineUpdated()}bindingsNeedPipeUpdate(){return this.defaultUniBindingFrag&&this.defaultUniBindingFrag.needsPipeUpdate()||this.defaultUniBindingVert&&this.defaultUniBindingVert.needsPipeUpdate()||this.defaultUniBindingCompute&&this.defaultUniBindingCompute.needsPipeUpdate()}hasUniformInStage(e,t){let i=this.getDefaultUniBinding(t);if(!i)return false;return!!i.getUniform(e)}hasUniform(e){return this.hasUniformInStage(e,GPUShaderStage.FRAGMENT)||this.hasUniformInStage(e,GPUShaderStage.VERTEX)||this.hasUniformInStage(e,GPUShaderStage.COMPUTE)}addUniform(e,t){const i=this.getDefaultUniBinding(t);if(e.type=="t")this.defaultBindGroup.addBinding(new b(this._cgp,e.name,{uniform:e}));else if(e.type=="sampler")this.defaultBindGroup.addBinding(new E(this._cgp,e.name,{uniform:e}));else{i.addUniform(e)}this.needsPipelineUpdate="add uniform";console.log("adduni2",this._name,e.name,this.id,i,x.getStageString(t));console.log("code",i.getShaderHeaderCode(this,0));return e}removeUniformByName(e){const t=this.getDefaultUniBinding(stage);t.removeUniformByName(e)}copy(){this.bind();const t=new x(this._cgp,this._name+" copy",this.options);console.log("copyyyyyy",this.id,t.id);t.setSource(this._src);t._modules=JSON.parse(JSON.stringify(this._modules));t._defines=JSON.parse(JSON.stringify(this._defines));t._moduleNames=this._moduleNames;t.bindGroups=[];for(let e=0;e<this.bindGroups.length;e++){const i=this.bindGroups[e].copy(t);t.bindGroups.push(i);if(this.bindGroups[e]==this.defaultBindGroup)t.defaultBindGroup=i;i.setBindingNums()}t.setWhyCompile("copy");t.compile();return t}dispose(){}static getStageString(e){if(e==GPUShaderStage.FRAGMENT)return"frag";if(e==GPUShaderStage.VERTEX)return"vertex";if(e==(GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX))return"frag+vertex";if(e==(GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX|GPUShaderStage.COMPUTE))return"frag+vertex+comp";if(e==GPUShaderStage.COMPUTE)return"compute";return"unknown"+e}getInfo(){const t={class:this.constructor.name,id:this.id,name:this._name,needsPipelineUpdate:this.needsPipelineUpdate,frameUsageCounter:this.lastFrameUsageCounter,lastCompileReason:this.#lastCompileReason,compileCount:this.compileCount,defines:this._defines,isCompute:this.options.compute,modules:[],bindgroups:[]};for(let e=0;e<this.bindGroups.length;e++){t.bindgroups.push(this.bindGroups[e].getInfo())}for(let e=0;e<this._modules.length;e++){t.modules.push(this._modules[e].title+" "+this._modules[e].name+" "+this._modules[e].group)}return t}copyUniformValues(e){}}class T extends n.U{#log=new r.A("cgp_texture");#cgp=null;gpuTexture=null;gpuTextureDescriptor=null;name="unknown";width=8;height=8;textureType="???";samplerDesc={};constructor(e,t={}){super(t);t=t||{};this.#cgp=e;if(!this.#cgp)throw new Error("no cgp");if(t.name)this.name=t.name;if(t.height&&t.width)this.setSize(t.width,t.height);this.#cgp.on("deviceChange",()=>{});this.samplerDesc={addressModeU:t.wrap||t.addressModeU||"clamp-to-edge",addressModeV:t.wrap||t.addressModeV||"clamp-to-edge",magFilter:t.magFilter||t.filter||"linear",minFilter:t.minFilter||t.filter||"linear"}}setSize(e,t){this.width=e;this.height=t}initTexture(e,t){this.width=e.width;this.height=e.height;const i="rgba8unorm";this.#cgp.pushErrorScope("inittexture",{logger:this.#log});this.gpuTextureDescriptor={size:{width:e.width,height:e.height},format:i,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};this.gpuTexture=this.#cgp.device.createTexture(this.gpuTextureDescriptor);this.#cgp.device.queue.copyExternalImageToTexture({source:e},{texture:this.gpuTexture},this.gpuTextureDescriptor.size);this.#cgp.popErrorScope();return this.gpuTexture}dispose(){console.log("todo dispose")}getInfo(){const e={};e.name=this.name||"???";e.size=this.width+" x "+this.height;e.textureType=this.textureType;return e}createView(){if(!this.gpuTexture){console.log("no gputexture...");return null}return this.gpuTexture.createView()}getSampler(){return this.samplerDesc}initFromData(e,t,i,s,r){if(!t||!i)this.#log.error("texture size is 0");this.width=t;this.height=i;this.gpuTexture=this.#cgp.device.createTexture({size:[t,i],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});this.#cgp.device.queue.writeTexture({texture:this.gpuTexture},e,{bytesPerRow:t*4},{width:t,height:i})}setWrap(e){this.samplerDesc.addressModeU=this.samplerDesc.addressModeV=e}setFilter(e){this.samplerDesc.minFilter=this.samplerDesc.magFilter=e}}T.load=function(i,s,r,e){fetch(s).then(e=>{const t=new T(i,{name:s});e.blob().then(e=>{createImageBitmap(e).then(e=>{t.initTexture(e);if(r)r(t);else console.log("Texture.load no onFinished callback")}).catch(e=>{if(r)r(i.getErrorTexture())})})})};class A{static TYPE_RENDER=0;static TYPE_COMPUTE=1;#log=new r.A("pipeline");name="";#cgp=null;#isValid=true;presentationFormat=null;#pipeCfg=null;bindGroupLayout=null;#shaderListeners=[];#type=-1;lastRebuildReason="first";rebuildCount=0;profile=false;bindingGroupLayoutEntries=[];constructor(e,t,i=0){if(!e)throw new Error("Pipeline constructed without cgp "+t);this.name=t;this.#cgp=e;this.#type=i}get passEncoder(){return this.#cgp.passEncoder}get log(){return this.#log}get cgp(){return this.#cgp}get isValid(){return this.#isValid}setName(e){this.name=e}getInfo(){const e={class:this.constructor.name,name:this.name,rebuildReason:this.lastRebuildReason,rebuildCount:this.rebuildCount,bindingGroupLayoutEntries:this.bindingGroupLayoutEntries};if(this.#type==A.TYPE_COMPUTE)e.type="COMPUTE";if(this.#type==A.TYPE_RENDER)e.type="RENDER";return e}pushDebug(){this.#cgp.currentPipeDebug={name:this.name,rebuildreason:this.lastRebuildReason,rebuildCount:this.rebuildCount,cfg:this.#pipeCfg,bindingGroupLayoutEntries:this.bindingGroupLayoutEntries}}_bindUniforms(e){e.bind()}dispose(){}}class S extends A{static DEPTH_COMPARE_FUNCS_STRINGS=["never","less","equal","lessequal","greater","notequal","greaterequal","always"];#isValid=true;presentationFormat=null;#pipeCfg=null;#renderPipeline=null;bindGroupLayout=null;#passEncoder;#old={};#type=S.TYPE_RENDER;lastRebuildReason="first";#rebuildNumBindingGroups=false;#compileCount=-1;constructor(e,t){super(e,t,A.TYPE_RENDER)}setPipeline(t,e=null){if(this.#type==S.TYPE_RENDER){if(!e){this.log.log("pipeline unknown mesh");return}}if(!t){this.log.log("pipeline unknown shader");return}if(this.cgp.branchProfiler)this.cgp.branchProfiler.push("setPipeline",this.name,{info:this.getInfo(),shader:t.getInfo()});let i="";if(!this.#renderPipeline)i="no renderpipeline";if(!this.#pipeCfg)i="no pipecfg";if(this.#old.mesh!=e)i="no mesh";if(this.#old.shader!=t){i="shader changed"}if(t.needsPipelineUpdate){i="shader needs update: "+t.needsPipelineUpdate;t.needsPipelineUpdate=""}if(this.#type==S.TYPE_RENDER&&e.needsPipelineUpdate){i="mesh needs update";e.needsPipelineUpdate=false}if(this.bindingGroupLayoutEntries.length!=t.defaultBindGroup.getLayoutEntries(t).length){i="num bindgroup layouts wrong..."}if(t.bindingsNeedPipeUpdate()){console.log("binding needs uptate");i="bindings needs update";this.needsRebuildBindgroup=true}if(this.#pipeCfg){this.#pipeCfg=this.#pipeCfg||{};if(this.#pipeCfg.depthStencil.depthWriteEnabled!=this.cgp.stateDepthWrite())i="depth changed";if(this.#pipeCfg.fragment.targets[0].blend!=this.cgp.stateBlend()){i="blend changed";this.#pipeCfg.fragment.targets[0].blend=this.cgp.stateBlend()}if(this.#pipeCfg.depthStencil.depthCompare!=this.cgp.getDepthCompare())i="depth compare changed";if(this.#pipeCfg.primitive.cullMode!=this.cgp.stateCullFaceFacing())i="cullmode change";if(this.#pipeCfg.multisample.count!=this.cgp.stateMultisampling())i="multisample change"}if(this.#compileCount!=t.compileCount){i="shader compiled "+t.compileCount}this.pushDebug();if(i!=""){this.cgp.profileData.addHeavyEvent("pipeline created",this.name,i);this.lastRebuildReason=i;this.rebuildCount++;this.cgp.pushErrorScope("createPipeline",{logger:this.log});this.#rebuildNumBindingGroups=false;this.#pipeCfg=this.getPipelineObject(t);this.#old.device=this.cgp.device;this.#old.shader=t;this.#old.mesh=e;this.#isValid=true;this.#compileCount=t.compileCount;t.pipelineUpdated();try{this.#renderPipeline=this.cgp.device.createRenderPipeline(this.#pipeCfg)}catch(e){console.error("pipe error catch...",e.message,this.#pipeCfg);this.#isValid=false}this.cgp.popErrorScope(()=>{console.log("this.#pipeCfg",this.#pipeCfg)})}if(this.#renderPipeline&&this.#isValid){this.cgp.pushErrorScope("setpipeline",{logger:this.log});let e=this.cgp.passEncoder;if(this.cgp.branchProfiler)this.cgp.branchProfiler.push("pipe updateUniforms",this.name,{shader:t.getInfo()});t.bind();e.setPipeline(this.#renderPipeline);if(this.cgp.branchProfiler)this.cgp.branchProfiler.pop();this.cgp.popErrorScope()}if(this.cgp.branchProfiler)this.cgp.branchProfiler.pop()}getPipelineObject(e){this.bindingGroupLayoutEntries=[];this.bindingGroupLayoutEntries=e.defaultBindGroup.getLayoutEntries(e);const t=[e.defaultBindGroup.getLayout(e)];const i=this.cgp.device.createPipelineLayout({label:"pipe layout "+this.name,bindGroupLayouts:t});let s=[{arrayStride:3*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"}]},{arrayStride:2*4,attributes:[{shaderLocation:2,offset:0,format:"float32x2"}]},{arrayStride:3*4,attributes:[{shaderLocation:1,offset:0,format:"float32x3"}]}];let r={label:this.name,layout:i,primitive:{topology:"triangle-list",cullMode:this.cgp.stateCullFaceFacing()},multisample:{count:this.cgp.stateMultisampling(),alphaToCoverageEnabled:false},depthStencil:{depthWriteEnabled:this.cgp.stateDepthWrite(),depthCompare:this.cgp.getDepthCompare(),format:"depth24plus"},vertex:{module:e.gpuShaderModule,entryPoint:"myVSMain",buffers:s},fragment:{module:e.gpuShaderModule,entryPoint:"myFSMain",targets:[{format:this.cgp.presentationFormat,blend:this.cgp.stateBlend()}]}};return r}dispose(){}}var M=i(434);class I extends M.w{#log=new r.A("cgl_mesh");needsPipelineUpdate=false;constructor(e,t){super();this.cgp=e;this._geom=null;this.numIndex=0;this.instances=1;this._pipe=new S(this.cgp,"pipe mesh "+t.name);this._numNonIndexed=0;this._positionBuffer=null;this._attributes=[];if(t)this.setGeom(t)}_createBuffer(e,t,i){let s={size:t.byteLength,usage:i,mappedAtCreation:true};const r=e.createBuffer(s);const n=new t.constructor(r.getMappedRange());n.set(t);r.unmap();return r}setGeom(e){this.needsPipelineUpdate=true;this._geom=e;this._disposeAttributes();this._positionBuffer=this._createBuffer(this.cgp.device,new Float32Array(e.vertices),GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST);let t=e.verticesIndices;if(!e.isIndexed())t=Array.from(Array(e.vertices.length/3).keys());this._numIndices=t.length;this._indicesBuffer=this._createBuffer(this.cgp.device,new Uint32Array(t),GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST);if(e.texCoords&&e.texCoords.length)this.setAttribute("texCoords",e.texCoords,2);if(e.vertexNormals&&e.vertexNormals.length)this.setAttribute("normals",e.vertexNormals,3);this.setAttribute("normals",e.vertexNormals,3)}_disposeAttributes(){this.needsPipelineUpdate=true;for(let e=0;e<this._attributes.length;e++)this._attributes[e].buffer.destroy();this._attributes.length=0}dispose(){this._disposeAttributes()}setAttribute(e,t,i,s={}){if(!t){this.#log.error("mesh addAttribute - no array given! "+e);throw new Error}let r=false;if(s.instanced)r=s.instanced;const n=this._createBuffer(this.cgp.device,new Float32Array(t),GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST);const a={buffer:n,name:e,instanced:r};this._attributes.push(a);return a}render(e){if(!this._positionBuffer)return;if(this.instances<=0)return;if(this.cgp.branchProfiler)this.cgp.branchProfiler.push("mesh.render()","geom "+this._geom.name);e=e||this.cgp.getShader();if(e)e.bind();if(!e||!e.isValid){return}this._pipe.setName("mesh.render "+this._geom.name+" "+e.getName()+" "+e.id);this._pipe.setPipeline(e,this);if(this._pipe.isValid){if(this.cgp.branchProfiler)this.cgp.branchProfiler.push("mesh.render().draw","geom "+this._geom.name,{geom:this._geom.getInfo(),shader:e.getInfo(),numAttributes:this._attributes.length});this.cgp.passEncoder.setVertexBuffer(0,this._positionBuffer);for(let e=0;e<this._attributes.length;e++)this.cgp.passEncoder.setVertexBuffer(e+1,this._attributes[e].buffer);this.cgp.passEncoder.setIndexBuffer(this._indicesBuffer,"uint32");this.cgp.profileData.count("draw mesh",this._name);if(this._numNonIndexed)this.cgp.passEncoder.draw(this._numIndices,this.instances);else this.cgp.passEncoder.drawIndexed(this._numIndices,this.instances);if(this.cgp.branchProfiler)this.cgp.branchProfiler.pop()}else{if(this.cgp.branchProfiler){this.cgp.branchProfiler.push("mesh invalid pipeline ","geom "+this._geom.name);this.cgp.branchProfiler.pop()}}if(this.cgp.branchProfiler)this.cgp.branchProfiler.pop()}}const O=`
struct MyVSInput
{
    @location(0) position: vec3<f32>,
    @location(1) normal: vec3<f32>,
    @location(2) texcoord: vec2<f32>,
};

struct MyVSOutput
{
    @builtin(position) position: vec4<f32>,
    @location(0) normal: vec3<f32>,
    @location(1) texcoord: vec2<f32>,
};

@vertex
fn myVSMain(v: MyVSInput) -> MyVSOutput
{
    var vsOut: MyVSOutput;
    var pos =vec4<f32>(v.position, 1.0);

    var mvMatrix=uniVert.viewMatrix * uniVert.modelMatrix;
    vsOut.position = uniVert.projMatrix * mvMatrix * pos;

    vsOut.normal = v.normal;
    vsOut.texcoord = v.texcoord;
    return vsOut;
}

@fragment
fn myFSMain(v: MyVSOutput) -> @location(0) vec4<f32>
{
    return vec4<f32>(.5,.5,.5,1.0);
}
`;class R extends s.A{branchProfiler=null;constructor(e){super(e);this.patch=e;this.lastErrorMsg="";this._log=new r.A("WebGpuContext");this.gApi=s.A.API_WEBGPU;this._viewport=[0,0,256,256];this._shaderStack=[];this._simpleShader=null;this.frame=0;this.catchErrors=true;this._stackCullFaceFacing=[];this._stackDepthTest=[];this._stackCullFace=[];this._stackDepthFunc=[];this._stackDepthWrite=[];this._stackErrorScope=[];this._stackBlend=[];this._stackErrorScopeLogs=[];this._stackMultisampling=[];this.currentPipeDebug=null;this.canvasAttachments=[];this.device=null;this.passEncoder=null;this._defaultBlend={color:{operation:"add",srcFactor:"one",dstFactor:"zero"},alpha:{operation:"add",srcFactor:"one",dstFactor:"zero"}};this.DEPTH_FUNCS=["never","always","less","less-equal","greater","greater-equal","equal","not-equal"];this.CULL_MODES=["none","back","front","none"];this.presentationFormat="bgra8unorm"}get supported(){return!!navigator.gpu}renderStart(e,t,i){this.frame++;this.pushErrorScope("cgpstate internal",{scope:"internal"});this.pushErrorScope("cgpstate out-of-memory",{scope:"out-of-memory"});if(!this._simpleShader){this._simpleShader=new x(this,"simple default shader");this._simpleShader.setSource(O);this._simpleShader.addUniform(new h(this._simpleShader,"4f","color",[1,1,0,1]),GPUShaderStage.FRAGMENT)}this.fpsCounter.startFrame();this._startMatrixStacks(t,i);this.setViewPort(0,0,this.canvasWidth,this.canvasHeight);this.pushShader(this._simpleShader);this.pushDepthTest(true);this.pushDepthWrite(true);this.pushDepthFunc("less-equal");this.pushBlend(this._defaultBlend);this._execOneTimeCallbacks();this.emitEvent("beginFrame")}renderEnd(){this._endMatrixStacks();this.popShader();this.popDepthFunc();this.popDepthWrite();this.popDepthTest();this.popErrorScope();this.popErrorScope();if(this._stackErrorScope.length>0)console.log("error scope stack length invalid...");this._stackErrorScope.length=0;this.emitEvent("endFrame");this.fpsCounter.endFrame()}setViewPort(e,t,i,s){this._viewport=[e,t,i,s]}getViewPort(){return this._viewPort}createMesh(e,t){return new I(this,e)}popViewPort(){this._viewPortStack.pop();if(this._viewPortStack.length==0)this._viewPort=[0,0,this.canvasWidth,this.canvasHeight];else this.setViewPort(this._viewPortStack[this._viewPort.length-1])}pushViewPort(e,t,i,s){this._viewPortStack.push([e,t,i,s]);this._viewPort=[e,t,i,s]}pushShader(e){this._shaderStack.push(e)}popShader(){if(this._shaderStack.length===0)throw new Error("Invalid shader stack pop!");this._shaderStack.pop()}getShader(){return this._shaderStack[this._shaderStack.length-1]}setDevice(e){this.device=e;if(this._emptyTexture)this._emptyTexture=this._emptyTexture.dispose();if(this._defaultTexture)this._defaultTexture=this._defaultTexture.dispose();if(this._errorTexture)this._errorTexture=this._errorTexture.dispose();this.emitEvent("deviceChange")}pushErrorScope(e,t={}){if(this.catchErrors){this._stackErrorScope.push(e);this._stackErrorScopeLogs.push(t.logger||null);this.device.pushErrorScope(t.scope||"validation")}}popErrorScope(i){if(this.catchErrors){const s=this._stackErrorScope.pop();const t=this._stackErrorScopeLogs.pop();this.device.popErrorScope().then(e=>{if(e){if(this.lastErrorMsg==e.message){}else{(t||this._log).error(e.constructor.name,"in ERROR SCOPE:",s);(t||this._log).error(e.message)}this.lastErrorMsg=e.message;if(i)i(e)}})}}pushDepthTest(e){this._stackDepthTest.push(e)}getDepthCompare(){let e=this.stateDepthFunc();if(!this.stateDepthTest())e="always";return e}stateDepthTest(){return this._stackDepthTest[this._stackDepthTest.length-1]}popDepthTest(){this._stackDepthTest.pop()}pushDepthWrite(e){e=e||false;this._stackDepthWrite.push(e)}stateDepthWrite(){return this._stackDepthWrite[this._stackDepthWrite.length-1]}popDepthWrite(){this._stackDepthWrite.pop()}pushDepthFunc(e){this._stackDepthFunc.push(e)}stateDepthFunc(){if(this._stackDepthFunc.length>0)return this._stackDepthFunc[this._stackDepthFunc.length-1];return"less"}popDepthFunc(){this._stackDepthFunc.pop()}pushCullFace(e){this._stackCullFace.push(e)}stateMultisampling(){return this._stackMultisampling[this._stackMultisampling.length-1]}pushMultisampling(e){this._stackMultisampling.push(e)}popMultisampling(){this._stackMultisampling.pop()}pushCullFaceFacing(e){this._stackCullFaceFacing.push(e)}stateCullFaceFacing(){return this._stackCullFaceFacing[this._stackCullFaceFacing.length-1]}popCullFaceFacing(){this._stackCullFaceFacing.pop()}pushBlend(e){this._stackBlend.push(e)}popBlend(){this._stackBlend.pop()}stateBlend(){return this._stackBlend[this._stackBlend.length-1]}getEmptyTexture(){if(this._emptyTexture)return this._emptyTexture;const e=8;this._emptyTexture=new T(this,{});this._emptyTexture.initFromData(n.U.getDefaultTextureData("empty",e),e,e);return this._emptyTexture}getErrorTexture(){const e=256;this._errorTexture=new T(this,{});this._errorTexture.initFromData(n.U.getDefaultTextureData("stripes",e,{r:1,g:0,b:0}),e,e);return this._errorTexture}getDefaultTexture(){if(this._defaultTexture)return this._defaultTexture;const e=256;this._defaultTexture=new T(this,{});this._defaultTexture.initFromData(n.U.getDefaultTextureData("stripes",e),e,e);return this._defaultTexture}screenShot(t,e,i,s){if(this.canvas&&this.canvas.toBlob){this.canvas.toBlob(e=>{if(t)t(e);else this._log.log("no screenshot callback...")},i,s)}}}var C=i(273);class P{#canvas=null;#cgp=null;#ctx=null;constructor(e){this.#cgp=e;this.#canvas=document.createElement("canvas");this.#canvas.id="webgpucanvasOut";this.#canvas.style.width=128+"px";this.#canvas.style.height=128+"px"}get canvas(){return this.#canvas}render(e){const t=this.#cgp.canvas;if(this.#canvas.width!=t.width||this.#canvas.height!=t.height){this.#canvas.style.width=t.width+"px";this.#canvas.style.height=t.height+"px";this.#canvas.width=t.width;this.#canvas.height=t.height}if(!this.#ctx){this.#ctx=this.#canvas.getContext("webgpu");if(!this.#ctx)return console.log("no context",this.#canvas,this.#ctx);this.#ctx.configure({device:this.#cgp.device,format:this.#cgp.presentationFormat})}this.#cgp.renderPassDescriptor={label:"preview renderpass",colorAttachments:[{view:this.#ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.#cgp.canvasInfo.depthTextureView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}};this.#cgp.passEncoder=this.#cgp.commandEncoder.beginRenderPass(this.#cgp.renderPassDescriptor);this.#cgp.textureView=this.#ctx.getCurrentTexture().createView();this.#cgp.renderStart();e();this.#cgp.tempPrevCanvas=this.#canvas;this.#cgp.renderEnd();this.#cgp.passEncoder.end()}}class N extends m{cgpbuffer=null;bindingType="read-only-storage";constructor(e,t,i){super(e,t,i);this.cgpbuffer=i.cgpBuffer||new _(e,"temp",[0,0,0,0])}copy(){const e=new N(this.cgp,this.name,this.options);return e}getResource(e){return{buffer:this.cgpbuffer.gpuBuffer}}getLayoutEntry(e=null){let t="read-only-storage";if(this.stage&GPUShaderStage.COMPUTE)if(this.cgpbuffer.hasUsage(GPUBufferUsage.COPY_SRC)&&this.cgpbuffer.hasUsage(GPUBufferUsage.COPY_DST))t="storage";return{visibility:this.stage,binding:this.bindNum,buffer:{type:t}}}getShaderHeaderCode(e,t){this.cgp.profileData.count("shadercode storage",this.name);let i="";let s="read";if(this.stage&GPUShaderStage.COMPUTE)if(this.cgpbuffer.hasUsage(GPUBufferUsage.COPY_SRC)&&this.cgpbuffer.hasUsage(GPUBufferUsage.COPY_DST))s="read_write";else if(this.cgpbuffer.hasUsage(GPUBufferUsage.COPY_DST))s="write";i+="@group("+t+") ";i+="@binding("+this.bindNum+") ";i+="var<storage,"+s+"> ";let r="array<f32>";i+=this.name+": "+r+";\n";return i+"\n"}}class F extends A{#isValid=true;presentationFormat=null;#pipeCfg=null;#computePipeline=null;bindGroupLayout=null;#computePassEncoder;#shaderListeners=[];#old={};#errorCount=0;lastRebuildReason="first";rebuildCount=0;profile=false;#rebuildNumBindingGroups=false;constructor(e,t){super(e,t,A.TYPE_COMPUTE)}setPipeline(e,t=null){if(!e){this.log.log("pipeline unknown shader");return}let i="";if(!this.#pipeCfg)i="no pipecfg";if(this.#old.mesh!=t)i="no mesh";if(this.#old.shader!=e){i="shader changed"}if(e.needsPipelineUpdate){i="shader needs update: "+e.needsPipelineUpdate;e.needsPipelineUpdate=""}if(this.#rebuildNumBindingGroups){i="num bindgroups wrong..."}this.pushDebug();if(i!=""){this.cgp.profileData.count("pipeline created",this.name);this.lastRebuildReason=i;this.rebuildCount++;this.cgp.pushErrorScope("createPipeline",{logger:this.log});this.#rebuildNumBindingGroups=false;this.#pipeCfg=this.getPipelineObject(e);console.log(this.#pipeCfg);this.#old.device=this.cgp.device;this.#old.shader=e;this.#old.mesh=t;this.#isValid=true;console.log(this.#pipeCfg);try{this.#computePipeline=this.cgp.device.createComputePipeline(this.#pipeCfg)}catch(e){console.error("pipe error catch...",e.message,this.#pipeCfg);this.#isValid=false}this.cgp.popErrorScope(()=>{console.log("this.#pipeCfg",this.#pipeCfg)})}if(this.cgp.branchProfiler)this.cgp.branchProfiler.pop()}getPipelineObject(e){this.bindingGroupLayoutEntries=[];this.bindingGroupLayoutEntries=e.defaultBindGroup.getLayoutEntries(e);const t=[e.defaultBindGroup.getLayout(e)];const i=this.cgp.device.createPipelineLayout({label:"pipe layout "+this.name,bindGroupLayouts:t});let s={label:this.name,layout:i,compute:{module:e.gpuShaderModule,entryPoint:e.options.entryPoint||"main"}};console.log("pipecft",s,t);return s}compute(e,t=[8,8]){if(!e.gpuShaderModule)e.compile();const i=this.cgp.device.createCommandEncoder();this.#computePassEncoder=i.beginComputePass({label:"computepass "+e.getName()});this.setPipeline(e);if(!this.#computePipeline){this.log.warn("no render pipe");return}this.#computePassEncoder.setPipeline(this.#computePipeline);e.bind(this.#computePassEncoder);if(t.length==1)this.#computePassEncoder.dispatchWorkgroups(t[0]||8);else if(t.length==2)this.#computePassEncoder.dispatchWorkgroups(t[0]||8,t[1]||8);else if(t.length==3)this.#computePassEncoder.dispatchWorkgroups(t[0]||8,t[1]||8,t[2]||8);else console.log("workgroups length wrong,,,");this.#computePassEncoder.end();this.cgp.profileData.count("compute pipe",this.name);const s=i.finish();this.cgp.device.queue.submit([s]);this.pushDebug()}dispose(){}}class L{onBind=null;constructor(e,t,i){this._cgl=e;this._name=t;this._origShaders={};this._uniforms=[];this._structUniforms=[];this._definesToggled={};this._defines={};this._mods=[];this._textures=[];this._boundShader=null;this._changedDefines=true;this._changedUniforms=true;this._modulesChanged=false;this.needsTexturePush=false;this._lastShader=null;this._attributes=[];if(i&&i.opId)this.opId=i.opId}bind(e,t=true){const i=e||this._cgl.getShader();if(!i)return;this._boundShader=this._origShaders[i.id];let s=false;if(this._boundShader&&this._lastShader!=this._boundShader.shader){if(!this._boundShader.shader.hasModule(this._mods[0].id))s=true}if(s)console.warn("copy because  (missingMod)");if(!this._boundShader)console.warn("copy because  (!this._boundShader)");else if(i.lastCompile!=this._boundShader.lastCompile)console.warn("copy because  shader.lastCompile");if(this._modulesChanged)console.warn("copy because  this._modulesChanged");if(i._needsRecompile)console.warn("copy because  shader._needsRecompile ",i._compileReason);if(s||!this._boundShader||i.lastCompile!=this._boundShader.lastCompile||this._modulesChanged||i._needsRecompile){if(this._boundShader)this._boundShader.shader.dispose();if(i._needsRecompile)i.compile();this.needsTexturePush=true;this._boundShader=this._origShaders[i.id]={lastCompile:i.lastCompile,orig:i,shader:i.copy()};console.log("mod shaderrrrrrrrrrr",i.getName(),this._boundShader.shader.getName());this._addModulesToShader(this._boundShader.shader);this._updateDefinesShader(this._boundShader.shader);this._updateUniformsShader(this._boundShader.shader)}this._boundShader.wireframe=i.wireframe;if(this._changedDefines)this._updateDefines();if(this._changedUniforms)this._updateUniforms();if(t){this._cgl.pushShader(this._boundShader.shader)}if(this.needsTexturePush){for(let e=0;e<this._textures.length;e++){const r=this._textures[e][0];const n=this._textures[e][1];const a=this._textures[e][2];if(this._getUniform(r)){const o=this.getPrefixedName(r);const l=this._boundShader.shader.getUniform(o);if(l)this._boundShader.shader.pushTexture(l,n,a)}}this.needsTexturePush=false;this._textures.length=0}this._modulesChanged=false;this._boundShader.shader.fromMod=this;if(this.onBind)this.onBind(this._boundShader.shader);return this._boundShader.shader}unbind(e=true){if(this._boundShader)if(e)this._cgl.popShader();this._boundShader=null}_addModulesToShader(t){let i;if(this._mods.length>1)i=this._mods[0];for(let e=0;e<this._mods.length;e++)t.addModule(this._mods[e],i)}_removeModulesFromShader(e){for(const t in this._origShaders)this._origShaders[t].shader.removeModule(e)}addModule(e){this._mods.push(e);this._modulesChanged=true}removeModule(t){const i=[];let s=false;for(let e=0;e<this._mods.length;e++){if(this._mods[e].title==t){s=true;this._removeModulesFromShader(this._mods[e]);i.push(e)}}for(let e=i.length-1;e>=0;e-=1)this._mods.splice(i[e],1);this._modulesChanged=true}_updateUniformsShader(t){for(let e=0;e<this._uniforms.length;e++){const i=this._uniforms[e];const s=this.getPrefixedName(i.name);if(!t.hasUniform(s)){console.log("shadermod uni ",s,t.id,i.stage);const r=new h(t,i.type,s,i.v1,i.v2,i.v3,i.v4);console.log(i);t.addUniform(r,i.stage)}}}_updateUniforms(){for(const e in this._origShaders)this._updateUniformsShader(this._origShaders[e].shader);this._changedUniforms=false}_setUniformValue(e,t,i){const s=e.getUniform(t);if(s)s.setValue(i)}setUniformValue(e,t){const i=this._getUniform(e);if(!i)return;const s=this.getPrefixedName(e);for(const r in this._origShaders){this._setUniformValue(this._origShaders[r].shader,s,t)}}hasUniform(e){return!!this._getUniform(e)}_getUniform(t){for(let e=0;e<this._uniforms.length;e++){if(this._uniforms[e].name==t)return this._uniforms[e]}return null}addUniform(e,t,i,s,r,n,a){if(!this._getUniform(i)){this._uniforms.push({name:i,stage:e,type:t,v1:s,v2:r,v3:n,v4:a});this._changedUniforms=true}}addAttribute(t){for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].name==t.name&&this._attributes[e].nameFrag==t.nameFrag)return}this._attributes.push(t)}pushTexture(e,t,i){if(!t)throw new Error("no texture given to texturestack");this._textures.push([e,t,i]);this.needsTexturePush=true}_removeUniformFromShader(e,t){if(t.hasUniform(e))t.removeUniform(e)}removeUniform(t){if(this._getUniform(t)){for(let e=this._uniforms.length-1;e>=0;e-=1){const i=t;if(this._uniforms[e].name==t){for(const s in this._origShaders){this._removeUniformFromShader(this.getPrefixedName(i),this._origShaders[s].shader)}this._uniforms.splice(e,1)}}this._changedUniforms=true}}getPrefixedName(e){const t=this._mods[0].group;if(t===undefined){return}if(e.startsWith("MOD_")){e=e.substr("MOD_".length);e="mod"+t+"_"+e}return e}_updateDefinesShader(t){for(const e in this._defines){const i=this.getPrefixedName(e);if(this._defines[e]!==null&&this._defines[e]!==undefined)t.define(i,this._defines[e]);else t.removeDefine(i)}for(const e in this._definesToggled){const i=this.getPrefixedName(e);t.toggleDefine(i,this._definesToggled[e])}}_updateDefines(){for(const e in this._origShaders)this._updateDefinesShader(this._origShaders[e].shader);this._changedDefines=false}define(e,t){if(t===undefined)t=true;this._defines[e]=t;this._changedDefines=true}removeDefine(e){this._defines[e]=null;this._changedDefines=true}hasDefine(e){if(this._defines[e]!==null&&this._defines[e]!==undefined)return true;return false}toggleDefine(e,t){this._changedDefines=true;this._definesToggled[e]=t}currentShader(){if(!this._boundShader)return null;return this._boundShader.shader}dispose(){}}const D={Context:R,Shader:x,Mesh:I,Texture:T,Uniform:h,MESHES:C.S,GPUBuffer:_};window.CABLES=window.CABLES||{};window.CABLES.CGP=window.CABLES.CGP||D;window.CGP=window.CGP||D;window.CGP.WebGpuCanvasAttachment=P;window.CGP.RenderPipeline=S;window.CGP.ComputePipeline=F;window.CGP.ShaderModifier=L;window.CGP.BindingStorage=N;window.CGP.BindingUniform=v;window.CGP.BindingTexture=b;window.CGP.BindingSampler=E},564:(e,t,i)=>{"use strict";var a=i(440);class s{constructor(){this.toneJsInitialized=false}createAudioContext(e){window.AudioContext=window.AudioContext||window.webkitAudioContext;if(window.AudioContext){if(!window.audioContext){window.audioContext=new AudioContext}if(window.Tone&&!this.toneJsInitialized){if(Tone.setContext)Tone.setContext(window.audioContext,true);this.toneJsInitialized=true}}else{if(e.patch.config.onError)e.logError("NO_WEBAUDIO","Web Audio is not supported in this browser.");return}return window.audioContext}_getAudioContext(){return window.audioContext}createAudioInPort(i,e,t,s){if(!i||!e||!t){const n="ERROR: createAudioInPort needs three parameters, op, portName and audioNode";i.log(n);throw new Error(n)}if(!s){s=0}i.webAudio=i.webAudio||{};i.webAudio.audioInPorts=i.webAudio.audioInPorts||[];const r=i.inObject(e);r.webAudio={};r.webAudio.previousAudioInNode=null;r.webAudio.audioNode=t;i.webAudio.audioInPorts[e]=r;r.onChange=function(){const t=r.get();if(!t){if(r.webAudio.previousAudioInNode){try{if(r.webAudio.previousAudioInNode.disconnect)r.webAudio.previousAudioInNode.disconnect(r.webAudio.audioNode,0,s);i.setUiError("audioCtx",null)}catch(t){try{r.webAudio.previousAudioInNode.disconnect(r.webAudio.audioNode)}catch(e){i.log("Disconnecting audio node with in/out port index, as well as without in/out-port-index did not work ",t);if(t.printStackTrace){t.printStackTrace()}throw t}}}}else{try{if(t.connect){t.connect(r.webAudio.audioNode,0,s);i.setUiError("audioCtx",null)}else i.setUiError("audioCtx","The passed input is not an audio context. Please make sure you connect an audio context to the input.",2)}catch(e){i.log("Error: Failed to connect web audio node!",e);i.log("port.webAudio.audioNode",r.webAudio.audioNode);i.log("audioInNode: ",t);i.log("inputChannelIndex:",s);i.log("audioInNode.connect: ",t.connect);throw e}}r.webAudio.previousAudioInNode=t};return r}createAudioOutPort(e,t,i){if(!e||!t||!i){const r="ERROR: createAudioOutPort needs three parameters, op, portName and audioNode";e.log(r);throw new Error(r)}const s=e.outObject(t);s.set(i);return s}createAudioParamInPort(s,e,t,i,r){if(!s||!e||!t){s.log("ERROR: createAudioParamInPort needs three parameters, op, portName and audioNode");if(s&&s.name)s.log("opname: ",s.name);s.log("portName",e);s.log("audioNode: ",t);return}s.webAudio=s.webAudio||{};s.webAudio.audioInPorts=s.webAudio.audioInPorts||[];const n=s.inDynamic(e,[a.a.OP.OP_PORT_TYPE_VALUE,a.a.OP.OP_PORT_TYPE_OBJECT],i,r);n.webAudio={};n.webAudio.previousAudioInNode=null;n.webAudio.audioNode=t;s.webAudio.audioInPorts[e]=n;n.onChange=()=>{const e=n.get();const t=n.webAudio.audioNode;const i=this._getAudioContext();if(e!=undefined){if(typeof e==="object"&&e.connect){try{e.connect(t)}catch(e){s.log("Could not connect audio node: ",e);if(e.printStackTrace){e.printStackTrace()}throw e}n.webAudio.previousAudioInNode=e}else{if(t._param&&t._param.minValue&&t._param.maxValue){if(e>=t._param.minValue&&e<=t._param.maxValue){try{if(t.setValueAtTime){t.setValueAtTime(e,i.currentTime)}else{t.value=e}}catch(e){s.log("Possible AudioParam problem with tone.js op: ",e);if(e.printStackTrace){e.printStackTrace()}throw e}}else{s.log("Warning: The value for an audio parameter is out of range!")}}else if(t.minValue&&t.maxValue){if(e>=t.minValue&&e<=t.maxValue){try{if(t.setValueAtTime){t.setValueAtTime(e,i.currentTime)}else{t.value=e}}catch(e){s.log("AudioParam has minValue / maxValue defined, and value is in range, but setting the value failed! ",e);if(e.printStackTrace){e.printStackTrace()}throw e}}else{s.log("Warning: The value for an audio parameter is out of range!")}}else{try{if(t.setValueAtTime){t.setValueAtTime(e,i.currentTime)}else{t.value=e}}catch(e){s.log("Possible AudioParam problem (without minValue / maxValue): ",e);if(e.printStackTrace){e.printStackTrace()}throw e}}if(n.webAudio.previousAudioInNode&&n.webAudio.previousAudioInNode.disconnect){try{n.webAudio.previousAudioInNode.disconnect(t)}catch(e){s.log("Could not disconnect previous audio node: ",e);throw e}n.webAudio.previousAudioInNode=undefined}}}else{if(n.webAudio.previousAudioInNode){}}};return n}loadAudioFile(e,t,i,s,r){const n=this.createAudioContext();if(!n)s(new Error("No Audiocontext"));let a=null;if(r||r===undefined){a=e.loading.start("audio",t);if(e.isEditorMode())gui.jobs().start({id:"loadaudio"+a,title:" loading audio ("+t+")"})}const o=new XMLHttpRequest;if(!t)return;o.open("GET",t,true);o.responseType="arraybuffer";o.onload=function(){e.loading.finished(a);if(e.isEditorMode())gui.jobs().finish("loadaudio"+a);n.decodeAudioData(o.response,i,s).catch(e=>{s(e)})};o.send()}isValidToneTime(e){try{const t=new Tone.Time(e)}catch(e){return false}return true}isValidToneNote(e){try{Tone.Frequency(e)}catch(e){return false}return true}}const r=new s;window.CABLES=window.CABLES||{};window.CABLES.WEBAUDIO=r},125:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});class n{constructor(e,t,i,s){this.targetObj=e;this.id=t;this.eventName=i;this.cb=s}remove(){this.targetObj.off(this.id)}}class s{constructor(){this._simpleIdCounter=0}uuid(){let i=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=(i+Math.random()*16)%16|0;i=Math.floor(i/16);return(e==="x"?t:t&3|8).toString(16)})}isNumeric(e){const t=parseFloat(e);return!isNaN(t)&&isFinite(t)}simpleId(){this._simpleIdCounter++;return this._simpleIdCounter}pathLookup(e,t){const i=t.split(".");if(i.length==1){return e[i[0]]}return this.pathLookup(e[i[0]],i.slice(1).join("."))}}const a=new s;var r=i(849);class o{#eventLog=new r.A("eventtarget");#listeners={};#logEvents=false;#logName="";#eventCallbacks={};#countErrorUnknowns=0;eventsPaused=false;constructor(){}on(e,t,i=""){const s=(i||"")+a.simpleId();const r=new n(this,s,e,t);if(!this.#eventCallbacks[e])this.#eventCallbacks[e]=[r];else this.#eventCallbacks[e].push(r);this.#listeners[r.id]=r;return r}removeAllEventListeners(){for(const e in this.#listeners){this.off(this.#listeners[e])}}addEventListener(e,t,i=""){return this.on(e,t,i)}hasEventListener(e,t=null){if(e&&!t){if(typeof e=="string")return!!this.#listeners[e];else return!!this.#listeners[e.id]}else{this.#eventLog.warn("old eventtarget function haseventlistener!");if(e&&t){if(this.#eventCallbacks[e]){const i=this.#eventCallbacks[e].indexOf(t);return i!==-1}}}}hasListenerForEventName(e){return this.#eventCallbacks[e]&&this.#eventCallbacks[e].length>0}removeEventListener(e){return this.off(e)}off(e){if(e===null||e===undefined){this.#eventLog.warn("removeEventListener id null",e);return}let i=e;if(e.eventName)i=e.id;if(typeof i!="string"){console.log("old function signature: removeEventListener! use listener id");return}const s=this.#listeners[i];if(!s){if(this.#countErrorUnknowns==20)this.#eventLog.warn("stopped reporting unknown events");if(this.#countErrorUnknowns<20)this.#eventLog.warn("could not find event...",i,s);this.#countErrorUnknowns++;return}let r=0;let n=true;while(n){n=false;let t=-1;for(let e=0;e<this.#eventCallbacks[s.eventName].length;e++){if(this.#eventCallbacks[s.eventName][e].id.indexOf(i)===0){n=true;t=e}}if(t!==-1){this.#eventCallbacks[s.eventName].splice(t,1);delete this.#listeners[i];r++}}if(r==0)console.log("no events removed",s.eventName,i);return}logEvents(e,t){this.#logEvents=e;this.#logName=t}emitEvent(t,i=null,s=null,r=null,n=null,a=null,o=null,l=null,h=null){if(this.eventsPaused)return;if(this.#logEvents)this.#eventLog.log("[event] ",this.#logName,t,this.#eventCallbacks);if(this.#eventCallbacks[t]){for(let e=0;e<this.#eventCallbacks[t].length;e++){if(this.#eventCallbacks[t][e]){this.#eventCallbacks[t][e].cb(i,s,r,n,a,o,l,h)}}}else{if(this.#logEvents)this.#eventLog.log("[event] has no event callback",t,this.#eventCallbacks)}}}},849:(e,t,i)=>{"use strict";i.d(t,{A:()=>s});class s{constructor(e,t){this.initiator=e;this._options=t;if(!this.initiator){console.error("no log initator given");CABLES.logStack()}}stack(e){console.info("["+this.initiator+"] ",e);console.log((new Error).stack)}groupCollapsed(e){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:0},...arguments)||!CABLES.logSilent)console.log("["+this.initiator+"]",...arguments);console.groupCollapsed("["+this.initiator+"] "+e)}table(e){console.table(e)}groupEnd(){console.groupEnd()}error(){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:2},...arguments)||!CABLES.UI){console.error("["+this.initiator+"]",...arguments)}if(this._options&&this._options.onError){this._options.onError(this.initiator,...arguments)}}errorGui(){if(CABLES.UI)CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:2},...arguments)}warn(){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:1},...arguments)||!CABLES.logSilent)console.warn("["+this.initiator+"]",...arguments)}verbose(){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:0},...arguments)||!CABLES.logSilent)console.log("["+this.initiator+"]",...arguments)}info(){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:0},...arguments)||!CABLES.logSilent)console.info("["+this.initiator+"]",...arguments)}log(){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:0},...arguments)||!CABLES.logSilent)console.log("["+this.initiator+"]",...arguments)}logGui(){if(CABLES.UI)CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:0},...arguments)}userInteraction(e){}}}};var r={};function n(e){var t=r[e];if(t!==undefined){return t.exports}var i=r[e]={exports:{}};s[e](i,i.exports,n);return i.exports}(()=>{n.d=(e,t)=>{for(var i in t){if(n.o(t,i)&&!n.o(e,i)){Object.defineProperty(e,i,{enumerable:true,get:t[i]})}}}})();(()=>{n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{n.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();n(748);n(772);n(626);n(564);var e=n(606);var t=CABLES=typeof CABLES==="undefined"?{}:CABLES;for(var i in e)t[i]=e[i];if(e.__esModule)Object.defineProperty(t,"__esModule",{value:true})})();var CABLES=CABLES||{};CABLES.build={timestamp:1762432270881,created:"2025-11-06T12:31:10.881Z",git:{branch:"master",commit:"fe3a23dbc2b01a01dcdee092a7a7d01270564c1f",date:"1762431873",message:"Merge branch 'develop'"}};if(!CABLES.exportedPatches)CABLES.exportedPatches={};CABLES.exportedPatches["JdRYK1"]={_id:"690c5bf3f14f018a4f2950c7",ops:[{id:"2itge87xk",uiAttribs:{},portsIn:[{name:"Max Pixel Density (DPR)",value:2},{name:"FPS Limit",value:0},{name:"Reduce FPS unfocussed",value:0},{name:"Transparent",value:0},{name:"Active",value:1},{name:"Focus canvas",value:1}],portsOut:[{name:"trigger",links:[{portIn:"exe",portOut:"trigger",objIn:"ik229swsc",objOut:"2itge87xk"},{portIn:"exe",portOut:"trigger",objIn:"n3p40o0am",objOut:"2itge87xk"}]},{name:"width",value:1933},{name:"height",value:761},{name:"Pixel Density",value:1}],objName:"Ops.Gl.MainLoop_v2"},{id:"ik229swsc",uiAttribs:{},portsOut:[{name:"trigger 0",links:[{portIn:"render",portOut:"trigger 0",objIn:"83gr9ygbh",objOut:"ik229swsc"},{portIn:"Render",portOut:"trigger 0",objIn:"v3fq64k7j",objOut:"ik229swsc"}]},{name:"trigger 1",links:[{portIn:"render",portOut:"trigger 1",objIn:"20gq79ste",objOut:"ik229swsc"},{portIn:"Update",portOut:"trigger 1",objIn:"uarrtd7nm",objOut:"ik229swsc"},{portIn:"Update",portOut:"trigger 1",objIn:"i3l0ebcmj",objOut:"ik229swsc"}]},{name:"trigger 4",links:[{portIn:"Render",portOut:"trigger 4",objIn:"w6i0p89a1",objOut:"ik229swsc"}]},{name:"trigger 7",links:[{portIn:"Render",portOut:"trigger 7",objIn:"8mbqzuwvf",objOut:"ik229swsc"}]},{name:"trigger 9",links:[{portIn:"Render",portOut:"trigger 9",objIn:"h8sqbt3n2",objOut:"ik229swsc"}]},{name:"trigger 15",links:[{portIn:"render",portOut:"trigger 15",objIn:"ohpoy07w7",objOut:"ik229swsc"}]}],objName:"Ops.Trigger.Sequence"},{id:"cz27k4rjm",uiAttribs:{},portsIn:[{name:"Size index",value:0},{name:"Size",value:"Canvas"},{name:"texture width",value:1933},{name:"texture height",value:761},{name:"Auto Aspect",value:1},{name:"filter index",value:1},{name:"filter",value:"linear"},{name:"Wrap index",value:1},{name:"Wrap",value:"Repeat"},{name:"MSAA index",value:0},{name:"MSAA",value:"none"},{name:"Pixel Format index",value:4},{name:"Pixel Format",value:"RGBA 8bit ubyte"},{name:"Depth",value:1},{name:"Clear",value:1}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"v46ykonef",objOut:"cz27k4rjm"}]},{name:"texture",links:[{portIn:"Image",portOut:"texture",objIn:"ripba7hks",objOut:"cz27k4rjm"}]},{name:"textureDepth",links:[{portIn:"image",portOut:"textureDepth",objIn:"96z3mhecj",objOut:"cz27k4rjm"}]}],objName:"Ops.Gl.RenderToTexture_v3"},{id:"ohpoy07w7",uiAttribs:{},portsIn:[{name:"Scale index",value:1},{name:"Scale",value:"Fit"},{name:"Flip Y",value:0},{name:"Flip X",value:0}],objName:"Ops.Gl.Meshes.FullscreenRectangle_v2"},{id:"h8sqbt3n2",uiAttribs:{},portsIn:[{name:"Size index",value:1},{name:"Size",value:"Canvas"},{name:"Width",value:640},{name:"Height",value:480},{name:"Filter index",value:1},{name:"Filter",value:"linear"},{name:"Wrap index",value:1},{name:"Wrap",value:"repeat"},{name:"Anisotropic index",value:0},{name:"Anisotropic",value:"0"},{name:"Pixel Format index",value:4},{name:"Pixel Format",value:"RGBA 8bit ubyte"},{name:"Clear",value:1},{name:"R",value:0},{name:"G",value:0},{name:"B",value:0},{name:"A",value:0}],portsOut:[{name:"Next",links:[{portIn:"render",portOut:"Next",objIn:"ripba7hks",objOut:"h8sqbt3n2"}]},{name:"texture_out",links:[{portIn:"Texture",portOut:"texture_out",objIn:"ohpoy07w7",objOut:"h8sqbt3n2"}]},{name:"Aspect Ratio",value:2.540078843626807},{name:"Texture Width",links:[{portIn:"number1",portOut:"Texture Width",objIn:"tuuxfeo9v",objOut:"h8sqbt3n2"}]},{name:"Texture Height",links:[{portIn:"number1",portOut:"Texture Height",objIn:"em66yq9jx",objOut:"h8sqbt3n2"}]}],objName:"Ops.Gl.ImageCompose.ImageCompose_v4"},{id:"e6cgoaiuk",uiAttribs:{},portsIn:[{name:"stacks",value:512},{name:"slices",value:512},{name:"Filloffset",value:1},{name:"Render",value:1}],objName:"Ops.Graphics.Meshes.Sphere_v3"},{id:"6vl5wt27l",uiAttribs:{},portsIn:[{name:"blendMode index",value:1},{name:"blendMode",value:"lighten"},{name:"Target index",value:0},{name:"Target",value:"Color"},{name:"Scale",value:2.18},{name:"Use Texture Alpha",value:0},{name:"Pos X",value:0},{name:"Pos Y",value:0},{name:"Rot X",value:0},{name:"Rot Y",value:0},{name:"Mapping index",value:1},{name:"Mapping",value:"XY"},{name:"Discard",value:0},{name:"WorldSpace",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"jl4t9v5im",objOut:"6vl5wt27l"}]}],objName:"Ops.Gl.ShaderEffects.TextureProjection_v2"},{id:"jl4t9v5im",uiAttribs:{},portsIn:[{name:"Source index",value:0},{name:"Source",value:"X * Z + Time"},{name:"amount",value:.1},{name:"Scale",value:5.32},{name:"axisX",value:1},{name:"axisY",value:1},{name:"axisZ",value:1},{name:"Range index",value:0},{name:"Range",value:"-1 to 1"},{name:"Area index",value:0},{name:"Area",value:"Sphere"},{name:"Size",value:1.41},{name:"Falloff",value:0},{name:"x",value:0},{name:"y",value:.65},{name:"z",value:0},{name:"WorldSpace",value:0},{name:"Invert",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"fnfxr95el",objOut:"jl4t9v5im"}]}],objName:"Ops.Gl.ShaderEffects.VertexWobble_v2"},{id:"v46ykonef",uiAttribs:{},portsIn:[{name:"min distance",value:1},{name:"max distance",value:2.5},{name:"min rot y",value:0},{name:"max rot y",value:0},{name:"initial radius",value:2},{name:"initial axis y",value:.5},{name:"initial axis x",value:.25},{name:"Smoothness",value:1},{name:"Speed X",value:1},{name:"Speed Y",value:1},{name:"Active",value:1},{name:"Allow Panning",value:0},{name:"Allow Zooming",value:1},{name:"Allow Rotation",value:1},{name:"restricted",value:1},{name:"Identity",value:1}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"etme2op0q",objOut:"v46ykonef"}]},{name:"radius",links:[{portIn:"Value",portOut:"radius",objIn:"840umln1j",objOut:"v46ykonef"}]},{name:"Rot X",value:109.4232692549348},{name:"Rot Y",value:91.8}],objName:"Ops.Graphics.OrbitControls_v3"},{id:"l1y7hs0j2",uiAttribs:{},portsIn:[{name:"Speed",value:2},{name:"Play",value:1},{name:"Sync to timeline",value:0}],portsOut:[{name:"Time",links:[{portIn:"Time",portOut:"Time",objIn:"jl4t9v5im",objOut:"l1y7hs0j2"},{portIn:"Value",portOut:"Time",objIn:"9c08dwj6z",objOut:"l1y7hs0j2"}]}],objName:"Ops.Anim.Timer_v2"},{id:"murks73r9",uiAttribs:{},portsIn:[{name:"Gradient",value:'{"keys":[{"pos":0,"posy":0.5,"r":1,"g":0.8703759765625001,"b":0.45989990234375},{"pos":0.123046875,"posy":0.5,"r":1,"g":0.8703759765625001,"b":0.45989990234375},{"pos":0.404296875,"posy":0.53,"r":0.8633725490196078,"g":0.9098039215686274,"b":0.764705882352941},{"pos":0.70703125,"posy":0.25,"r":0.5609476725260417,"g":0.8466666666666667,"b":0.7323790690104168},{"pos":1,"posy":0.6,"r":0.6758577473958334,"g":0.9133333333333333,"b":0.8951928371853299},{"pos":1,"posy":0.6,"r":0.6758577473958334,"g":0.9133333333333333,"b":0.8951928371853299}]}'},{name:"Direction index",value:0},{name:"Direction",value:"X"},{name:"Smoothstep",value:1},{name:"Step",value:0},{name:"Flip",value:0},{name:"sRGB",value:0},{name:"Oklab",value:0},{name:"Size",value:597},{name:"filter index",value:1},{name:"filter",value:"linear"},{name:"wrap index",value:0},{name:"wrap",value:"clamp to edge"},{name:"Dither",value:0},{name:"Gradient Array",value:0}],portsOut:[{name:"Texture",links:[{portIn:"Texture",portOut:"Texture",objIn:"6vl5wt27l",objOut:"murks73r9"}]}],objName:"Ops.Gl.GradientTexture"},{id:"fnfxr95el",uiAttribs:{},portsIn:[{name:"Source index",value:0},{name:"Source",value:"X * Z + Time"},{name:"amount",value:.1},{name:"Scale",value:5.32},{name:"axisX",value:1},{name:"axisY",value:1},{name:"axisZ",value:1},{name:"Range index",value:0},{name:"Range",value:"-1 to 1"},{name:"Area index",value:0},{name:"Area",value:"Sphere"},{name:"Size",value:1.41},{name:"Falloff",value:0},{name:"x",value:0},{name:"y",value:-.65},{name:"z",value:0},{name:"WorldSpace",value:0},{name:"Invert",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"e6cgoaiuk",objOut:"fnfxr95el"}]}],objName:"Ops.Gl.ShaderEffects.VertexWobble_v2"},{id:"9c08dwj6z",uiAttribs:{},portsOut:[{name:"Result",links:[{portIn:"Time",portOut:"Result",objIn:"fnfxr95el",objOut:"9c08dwj6z"}]}],objName:"Ops.Math.FlipSign"},{id:"ripba7hks",uiAttribs:{},portsIn:[{name:"blendMode index",value:0},{name:"blendMode",value:"normal"},{name:"amount",value:1},{name:"Premultiplied",value:0},{name:"Alpha Mask",value:0},{name:"removeAlphaSrc",value:0},{name:"Mask Src index",value:1},{name:"Mask Src",value:"luminance"},{name:"Invert alpha channel",value:0},{name:"Aspect Ratio",value:0},{name:"Stretch Axis index",value:0},{name:"Stretch Axis",value:"X"},{name:"Position",value:0},{name:"Crop",value:0},{name:"flip x",value:0},{name:"flip y",value:0},{name:"Transform",value:0},{name:"Scale X",value:1},{name:"Scale Y",value:1},{name:"Position X",value:0},{name:"Position Y",value:0},{name:"Rotation",value:0},{name:"Clip Repeat",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"d3k66fpsw",objOut:"ripba7hks"}]}],objName:"Ops.Gl.ImageCompose.DrawImage_v3"},{id:"g2yabiv7o",uiAttribs:{},portsIn:[{name:"Speed",value:20},{name:"Play",value:1},{name:"Sync to timeline",value:0}],portsOut:[{name:"Time",links:[{portIn:"rotZ",portOut:"Time",objIn:"etme2op0q",objOut:"g2yabiv7o"}]}],objName:"Ops.Anim.Timer_v2"},{id:"62kbm7ctj",uiAttribs:{},portsIn:[{name:"Active",value:1},{name:"R",value:1},{name:"G",value:.8745883711973874},{name:"B",value:.1449218988418579},{name:"Fresnel Intensity",value:2.39},{name:"Fresnel Exponent",value:6.97}],portsOut:[{name:"Trigger Out",links:[{portIn:"render",portOut:"Trigger Out",objIn:"6vl5wt27l",objOut:"62kbm7ctj"}]}],objName:"Ops.Gl.ShaderEffects.FresnelGlow"},{id:"etme2op0q",uiAttribs:{},portsIn:[{name:"posX",value:-.25},{name:"posY",value:0},{name:"posZ",value:0},{name:"scale",value:1}],portsOut:[{name:"trigger",links:[{portIn:"Trigger In",portOut:"trigger",objIn:"dn82usydr",objOut:"etme2op0q"}]}],objName:"Ops.Graphics.TransformView"},{id:"2abqvfihl",uiAttribs:{},portsIn:[{name:"amount",value:5},{name:"direction index",value:0},{name:"direction",value:"both"},{name:"Fast",value:1}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"i9ejmrtse",objOut:"2abqvfihl"}]}],objName:"Ops.Gl.ImageCompose.Blur"},{id:"v3fq64k7j",uiAttribs:{},portsIn:[{name:"Size index",value:2},{name:"Size",value:"Manual"},{name:"Filter index",value:1},{name:"Filter",value:"linear"},{name:"Wrap index",value:1},{name:"Wrap",value:"repeat"},{name:"Anisotropic index",value:0},{name:"Anisotropic",value:"0"},{name:"Pixel Format index",value:4},{name:"Pixel Format",value:"RGBA 8bit ubyte"},{name:"Clear",value:1},{name:"R",value:0},{name:"G",value:0},{name:"B",value:0},{name:"A",value:0}],portsOut:[{name:"Next",links:[{portIn:"render",portOut:"Next",objIn:"6t9amqbse",objOut:"v3fq64k7j"}]},{name:"texture_out",links:[{portIn:"Texture In",portOut:"texture_out",objIn:"zpvjkiooc",objOut:"v3fq64k7j"}]},{name:"Aspect Ratio",value:2.5340314136125652},{name:"Texture Width",value:484},{name:"Texture Height",value:191}],objName:"Ops.Gl.ImageCompose.ImageCompose_v4"},{id:"6t9amqbse",uiAttribs:{},portsIn:[{name:"Blend Mode index",value:0},{name:"Blend Mode",value:"normal"},{name:"Alpha Mask index",value:0},{name:"Alpha Mask",value:"Off"},{name:"Amount",value:1},{name:"Color index",value:0},{name:"Color",value:"Mono"},{name:"Scale",value:3},{name:"Multiply",value:1.57},{name:"Value index",value:1},{name:"Value",value:"-1-1"},{name:"Harmonics index",value:4},{name:"Harmonics",value:"5"},{name:"X",value:0},{name:"Y",value:0},{name:"Offset Multiply",value:1},{name:"Offset X index",value:0},{name:"Offset X",value:"None"},{name:"Offset Y index",value:0},{name:"Offset Y",value:"None"},{name:"Offset Z index",value:1},{name:"Offset Z",value:"R"}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"pl3gnockq",objOut:"6t9amqbse"}]}],objName:"Ops.Gl.ImageCompose.Noise.PerlinNoise_v2"},{id:"n88ru4dnn",uiAttribs:{},portsIn:[{name:"Speed",value:.24},{name:"Play",value:1},{name:"Sync to timeline",value:0}],portsOut:[{name:"Time",links:[{portIn:"Z",portOut:"Time",objIn:"6t9amqbse",objOut:"n88ru4dnn"}]}],objName:"Ops.Anim.Timer_v2"},{id:"zpvjkiooc",uiAttribs:{},portsIn:[{name:"Show Info",value:0},{name:"Visualize outside 0-1 index",value:1},{name:"Visualize outside 0-1",value:"Anim"},{name:"Alpha index",value:0},{name:"Alpha",value:"A"},{name:"Show Color",value:0},{name:"X",value:.5},{name:"Y",value:.5}],portsOut:[{name:"Texture Out",links:[{portIn:"mask",portOut:"Texture Out",objIn:"2abqvfihl",objOut:"zpvjkiooc"}]},{name:"Info",value:""}],objName:"Ops.Ui.VizTexture"},{id:"ylcl2b4ri",uiAttribs:{},portsIn:[{name:"blendMode index",value:6},{name:"blendMode",value:"add"},{name:"amount",value:1},{name:"Premultiplied",value:0},{name:"Alpha Mask",value:0},{name:"removeAlphaSrc",value:0},{name:"Mask Src index",value:1},{name:"Mask Src",value:"luminance"},{name:"Invert alpha channel",value:0},{name:"Aspect Ratio",value:0},{name:"Stretch Axis index",value:0},{name:"Stretch Axis",value:"X"},{name:"Position",value:0},{name:"Crop",value:0},{name:"flip x",value:0},{name:"flip y",value:0},{name:"Transform",value:0},{name:"Scale X",value:1},{name:"Scale Y",value:1},{name:"Position X",value:0},{name:"Position Y",value:0},{name:"Rotation",value:0},{name:"Clip Repeat",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"pf1ldyivz",objOut:"ylcl2b4ri"}]}],objName:"Ops.Gl.ImageCompose.DrawImage_v3"},{id:"6jvkudkne",uiAttribs:{},portsIn:[{name:"File",value:"assets/squaremask.png",display:"file"},{name:"Filter index",value:2},{name:"Filter",value:"mipmap"},{name:"Wrap index",value:0},{name:"Wrap",value:"repeat"},{name:"Anisotropic index",value:0},{name:"Anisotropic",value:"0"},{name:"Data Format index",value:3},{name:"Data Format",value:"RGBA"},{name:"Flip",value:0},{name:"Pre Multiplied Alpha",value:0},{name:"Active",value:1},{name:"Save Memory",value:1},{name:"Add Cachebuster",value:0}],portsOut:[{name:"Texture",links:[{portIn:"Image",portOut:"Texture",objIn:"ylcl2b4ri",objOut:"6jvkudkne"}]},{name:"Width",value:698},{name:"Height",value:698},{name:"Aspect Ratio",value:1},{name:"Loaded",value:1},{name:"Loading",value:0}],objName:"Ops.Gl.Texture_v2"},{id:"pl3gnockq",uiAttribs:{},portsIn:[{name:"blendMode index",value:3},{name:"blendMode",value:"multiply"},{name:"amount",value:.002},{name:"Premultiplied",value:0},{name:"Alpha Mask",value:0},{name:"removeAlphaSrc",value:0},{name:"Mask Src index",value:1},{name:"Mask Src",value:"luminance"},{name:"Invert alpha channel",value:0},{name:"Aspect Ratio",value:0},{name:"Stretch Axis index",value:0},{name:"Stretch Axis",value:"X"},{name:"Position",value:0},{name:"Crop",value:0},{name:"flip x",value:0},{name:"flip y",value:0},{name:"Transform",value:0},{name:"Scale X",value:1},{name:"Scale Y",value:1},{name:"Position X",value:0},{name:"Position Y",value:0},{name:"Rotation",value:0},{name:"Clip Repeat",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"ylcl2b4ri",objOut:"pl3gnockq"}]}],objName:"Ops.Gl.ImageCompose.DrawImage_v3"},{id:"qky66y4pr",uiAttribs:{},portsIn:[{name:"Gradient",value:'{"keys":[{"pos":0,"posy":0.43,"r":0,"g":0,"b":0},{"pos":0.408203125,"posy":0.43,"r":0,"g":0,"b":0},{"pos":1,"posy":0.5,"r":1,"g":1,"b":1},{"pos":1,"posy":0.5,"r":1,"g":1,"b":1}]}'},{name:"Direction index",value:6},{name:"Direction",value:"Radial"},{name:"Smoothstep",value:0},{name:"Step",value:0},{name:"Flip",value:0},{name:"sRGB",value:0},{name:"Oklab",value:0},{name:"Size",value:256},{name:"filter index",value:1},{name:"filter",value:"linear"},{name:"wrap index",value:0},{name:"wrap",value:"clamp to edge"},{name:"Dither",value:0},{name:"Gradient Array",value:0}],portsOut:[{name:"Texture",links:[{portIn:"Image",portOut:"Texture",objIn:"pl3gnockq",objOut:"qky66y4pr"}]}],objName:"Ops.Gl.GradientTexture"},{id:"83gr9ygbh",uiAttribs:{},portsIn:[{name:"Size index",value:0},{name:"Size",value:"Canvas"},{name:"texture width",value:1933},{name:"texture height",value:761},{name:"Auto Aspect",value:1},{name:"filter index",value:1},{name:"filter",value:"linear"},{name:"Wrap index",value:1},{name:"Wrap",value:"Repeat"},{name:"MSAA index",value:0},{name:"MSAA",value:"none"},{name:"Pixel Format index",value:4},{name:"Pixel Format",value:"RGBA 8bit ubyte"},{name:"Depth",value:1},{name:"Clear",value:1}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"uuwi4ja48",objOut:"83gr9ygbh"}]},{name:"texture",links:[{portIn:"Texture In",portOut:"texture",objIn:"2knlqlrps",objOut:"83gr9ygbh"},{portIn:"Array In",portOut:"texture",objIn:"qili4etm5",objOut:"83gr9ygbh"}]}],objName:"Ops.Gl.RenderToTexture_v3"},{id:"gthklqdrf",uiAttribs:{},portsIn:[{name:"radius",value:.95},{name:"innerRadius",value:0},{name:"segments",value:40},{name:"percent",value:1},{name:"steps",value:0},{name:"invertSteps",value:0},{name:"mapping index",value:0},{name:"mapping",value:"flat"},{name:"Spline",value:0},{name:"Draw",value:1,title:"Render mesh"}],objName:"Ops.Graphics.Meshes.Circle_v3"},{id:"2knlqlrps",uiAttribs:{},portsIn:[{name:"Show Info",value:0},{name:"Visualize outside 0-1 index",value:1},{name:"Visualize outside 0-1",value:"Anim"},{name:"Alpha index",value:0},{name:"Alpha",value:"A"},{name:"Show Color",value:0},{name:"X",value:.5},{name:"Y",value:.5}],portsOut:[{name:"Info",value:""}],objName:"Ops.Ui.VizTexture"},{id:"uuwi4ja48",uiAttribs:{},portsIn:[{name:"posZ",value:0},{name:"scale",value:1},{name:"rotX",value:0},{name:"rotY",value:0},{name:"rotZ",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"atsj59l5i",objOut:"uuwi4ja48"}]}],objName:"Ops.Graphics.Transform"},{id:"atsj59l5i",uiAttribs:{},portsIn:[{name:"r",value:.04326883635336942},{name:"g",value:.36414275270066965},{name:"b",value:.609268689064467},{name:"a",value:1},{name:"colorizeTexture",value:0},{name:"Vertex Colors",value:0},{name:"Alpha Mask Source index",value:0},{name:"Alpha Mask Source",value:"Luminance"},{name:"Opacity TexCoords Transform",value:0},{name:"Discard Transparent Pixels",value:0},{name:"diffuseRepeatX",value:1},{name:"diffuseRepeatY",value:1},{name:"Tex Offset X",value:0},{name:"Tex Offset Y",value:0},{name:"Crop TexCoords",value:0},{name:"billboard",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"gthklqdrf",objOut:"atsj59l5i"}]}],objName:"Ops.Gl.Shader.BasicMaterial_v3"},{id:"w3lpsbjo2",uiAttribs:{},portsIn:[{name:"Gradient",value:'{"keys":[{"pos":0,"posy":0.44,"r":0,"g":0,"b":0},{"pos":0.33984375,"posy":0.44,"r":0,"g":0,"b":0},{"pos":1,"posy":0.5,"r":1,"g":1,"b":1},{"pos":1,"posy":0.5,"r":1,"g":1,"b":1}]}'},{name:"Direction index",value:6},{name:"Direction",value:"Radial"},{name:"Smoothstep",value:0},{name:"Step",value:0},{name:"Flip",value:0},{name:"sRGB",value:0},{name:"Oklab",value:0},{name:"Size",value:256},{name:"filter index",value:1},{name:"filter",value:"linear"},{name:"wrap index",value:0},{name:"wrap",value:"clamp to edge"},{name:"Dither",value:.023},{name:"Gradient Array",value:0}],portsOut:[{name:"Texture",links:[{portIn:"texture",portOut:"Texture",objIn:"atsj59l5i",objOut:"w3lpsbjo2"}]}],objName:"Ops.Gl.GradientTexture"},{id:"pf1ldyivz",uiAttribs:{},portsIn:[{name:"blendMode index",value:3},{name:"blendMode",value:"multiply"},{name:"amount",value:1},{name:"Premultiplied",value:0},{name:"Alpha Mask",value:0},{name:"removeAlphaSrc",value:0},{name:"Mask Src index",value:1},{name:"Mask Src",value:"luminance"},{name:"Invert alpha channel",value:0},{name:"Aspect Ratio",value:0},{name:"Stretch Axis index",value:0},{name:"Stretch Axis",value:"X"},{name:"Position",value:0},{name:"Crop",value:0},{name:"flip x",value:0},{name:"flip y",value:0},{name:"Transform",value:0},{name:"Scale X",value:1},{name:"Scale Y",value:1},{name:"Position X",value:0},{name:"Position Y",value:0},{name:"Rotation",value:0},{name:"Clip Repeat",value:0}],objName:"Ops.Gl.ImageCompose.DrawImage_v3"},{id:"qili4etm5",uiAttribs:{},portsOut:[{name:"Array Out",links:[{portIn:"Array In",portOut:"Array Out",objIn:"so5h28ndk",objOut:"qili4etm5"}]}],objName:"Ops.Ui.Routing.RouteObject"},{id:"so5h28ndk",uiAttribs:{},portsOut:[{name:"Array Out",links:[{portIn:"Image",portOut:"Array Out",objIn:"pf1ldyivz",objOut:"so5h28ndk"}]}],objName:"Ops.Ui.Routing.RouteObject"},{id:"cj04h28nx",uiAttribs:{},portsOut:[{name:"CSS Width",value:1933},{name:"CSS Height",value:761},{name:"Pixel Ratio",value:1},{name:"Pixel Width",value:1933},{name:"Pixel Height",value:761},{name:"Aspect Ratio",links:[{portIn:"number1",portOut:"Aspect Ratio",objIn:"m4pr2y4lv",objOut:"cj04h28nx"}]},{name:"Landscape",value:1}],objName:"Ops.Gl.CanvasInfo_v3"},{id:"m4pr2y4lv",uiAttribs:{},portsOut:[{name:"result",links:[{portIn:"posX",portOut:"result",objIn:"uuwi4ja48",objOut:"m4pr2y4lv"}]}],objName:"Ops.Math.Multiply"},{id:"axhmj19q6",uiAttribs:{},portsOut:[{name:"CSS Width",value:1933},{name:"CSS Height",value:761},{name:"Pixel Ratio",value:1},{name:"Pixel Width",links:[{portIn:"number1",portOut:"Pixel Width",objIn:"8maqllvmq",objOut:"axhmj19q6"}]},{name:"Pixel Height",links:[{portIn:"number1",portOut:"Pixel Height",objIn:"7julk4sl2",objOut:"axhmj19q6"}]},{name:"Aspect Ratio",value:2.540078843626807},{name:"Landscape",value:1}],objName:"Ops.Gl.CanvasInfo_v3"},{id:"8maqllvmq",uiAttribs:{},portsIn:[{name:"number2",value:4}],portsOut:[{name:"result",links:[{portIn:"Width",portOut:"result",objIn:"v3fq64k7j",objOut:"8maqllvmq"}]}],objName:"Ops.Math.Divide"},{id:"7julk4sl2",uiAttribs:{},portsIn:[{name:"number2",value:4}],portsOut:[{name:"result",links:[{portIn:"Height",portOut:"result",objIn:"v3fq64k7j",objOut:"7julk4sl2"}]}],objName:"Ops.Math.Divide"},{id:"lvs03rsvy",uiAttribs:{},portsIn:[{name:"Blend Mode index",value:2},{name:"Blend Mode",value:"darken"},{name:"Amount",value:.677},{name:"Pixel",value:2},{name:"Lens Distort",value:1},{name:"Smooth",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"d5v87fn2g",objOut:"lvs03rsvy"}]}],objName:"Ops.Gl.ImageCompose.ChromaticAberration_v2"},{id:"d5v87fn2g",uiAttribs:{},portsIn:[{name:"Blend Mode index",value:0},{name:"Blend Mode",value:"normal"},{name:"Amount",value:1}],objName:"Ops.Gl.ImageCompose.BarrelDistortion_v3"},{id:"c2i8nlkvk",uiAttribs:{},portsIn:[{name:"Speed",value:1},{name:"Play",value:1},{name:"Sync to timeline",value:0}],portsOut:[{name:"Time",links:[{portIn:"Value",portOut:"Time",objIn:"kawkonm9x",objOut:"c2i8nlkvk"}]}],objName:"Ops.Anim.Timer_v2"},{id:"h6kyjyruw",uiAttribs:{},portsIn:[{name:"old min",value:0},{name:"old max",value:4},{name:"new min",value:-300},{name:"new max",value:0},{name:"Easing index",value:0},{name:"Easing",value:"Linear"},{name:"Clamp",value:1}],portsOut:[{name:"result",links:[{portIn:"Intensity",portOut:"result",objIn:"d5v87fn2g",objOut:"h6kyjyruw"}]}],objName:"Ops.Math.MapRange"},{id:"kawkonm9x",uiAttribs:{},portsIn:[{name:"Min",value:0},{name:"Max",value:4},{name:"Easing index",value:17},{name:"Easing",value:"Quint Out"}],portsOut:[{name:"Result",links:[{portIn:"value",portOut:"Result",objIn:"h6kyjyruw",objOut:"kawkonm9x"}]}],objName:"Ops.Math.Ease"},{id:"20gq79ste",uiAttribs:{},portsIn:[{name:"posX",value:0},{name:"posY",value:0},{name:"posZ",value:0},{name:"scale",value:1},{name:"rotZ",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"ehhiz7pcp",objOut:"20gq79ste"}]}],objName:"Ops.Graphics.TransformView"},{id:"00unzpbfk",uiAttribs:{},portsIn:[{name:"Speed",value:1},{name:"Play",value:1},{name:"Sync to timeline",value:0}],portsOut:[{name:"Time",links:[{portIn:"value",portOut:"Time",objIn:"vl443ir8t",objOut:"00unzpbfk"}]}],objName:"Ops.Anim.Timer_v2"},{id:"vl443ir8t",uiAttribs:{},portsIn:[{name:"old min",value:0},{name:"old max",value:5},{name:"new min",value:0},{name:"new max",value:1},{name:"Easing index",value:0},{name:"Easing",value:"Linear"},{name:"Clamp",value:1}],portsOut:[{name:"result",links:[{portIn:"Value",portOut:"result",objIn:"uakwq5wgh",objOut:"vl443ir8t"}]}],objName:"Ops.Math.MapRange"},{id:"uakwq5wgh",uiAttribs:{},portsIn:[{name:"Min",value:0},{name:"Max",value:1},{name:"Easing index",value:5},{name:"Easing",value:"Cubic Out"}],portsOut:[{name:"Result",links:[{portIn:"value",portOut:"Result",objIn:"dq4si1lrk",objOut:"uakwq5wgh"}]}],objName:"Ops.Math.Ease"},{id:"dq4si1lrk",uiAttribs:{},portsIn:[{name:"old min",value:0},{name:"old max",value:1},{name:"new min",value:2.1},{name:"new max",value:1.3},{name:"Easing index",value:0},{name:"Easing",value:"Linear"},{name:"Clamp",value:1}],portsOut:[{name:"result",links:[{portIn:"scale",portOut:"result",objIn:"ehhiz7pcp",objOut:"dq4si1lrk"}]}],objName:"Ops.Math.MapRange"},{id:"9dg4roxee",uiAttribs:{},portsIn:[{name:"key code",value:82},{name:"canvas only",value:1},{name:"Mod Key index",value:0},{name:"Mod Key",value:"none"},{name:"Enabled",value:1},{name:"Prevent Default",value:0}],portsOut:[{name:"on press",links:[{portIn:"Reset",portOut:"on press",objIn:"00unzpbfk",objOut:"9dg4roxee"}]},{name:"Pressed",value:0},{name:"Key",value:"R"}],objName:"Ops.Devices.Keyboard.KeyPressLearn"},{id:"n4t27e9d1",uiAttribs:{},portsIn:[{name:"key code",value:82},{name:"canvas only",value:1},{name:"Mod Key index",value:0},{name:"Mod Key",value:"none"},{name:"Enabled",value:1},{name:"Prevent Default",value:0}],portsOut:[{name:"on press",links:[{portIn:"Reset",portOut:"on press",objIn:"c2i8nlkvk",objOut:"n4t27e9d1"}]},{name:"Pressed",value:0},{name:"Key",value:"R"}],objName:"Ops.Devices.Keyboard.KeyPressLearn"},{id:"ehhiz7pcp",uiAttribs:{},portsIn:[{name:"x",value:1},{name:"y",value:1},{name:"z",value:1}],portsOut:[{name:"trigger",links:[{portIn:"Trigger",portOut:"trigger",objIn:"31q3tlzl3",objOut:"ehhiz7pcp"},{portIn:"Update",portOut:"trigger",objIn:"840umln1j",objOut:"ehhiz7pcp"},{portIn:"render",portOut:"trigger",objIn:"cz27k4rjm",objOut:"ehhiz7pcp"},{portIn:"render",portOut:"trigger",objIn:"cgm3z6pgu",objOut:"ehhiz7pcp"}]}],objName:"Ops.Gl.Matrix.Scale"},{id:"hrot9cdev",uiAttribs:{},portsIn:[{name:"radius",value:.5},{name:"stacks",value:64},{name:"slices",value:64},{name:"Filloffset",value:1},{name:"Render",value:1}],objName:"Ops.Graphics.Meshes.Sphere_v3"},{id:"ex1e5uu4e",uiAttribs:{},portsIn:[{name:"A",value:1},{name:"Enable",value:0},{name:"Albedo",value:.707},{name:"Roughness",value:.835},{name:"Active",value:0},{name:"Fresnel Intensity",value:.7},{name:"Fresnel Width",value:1},{name:"Fresnel Exponent",value:6},{name:"Fresnel R",value:1},{name:"Fresnel G",value:1},{name:"Fresnel B",value:1},{name:"Emissive Active",value:1},{name:"Color Intensity",value:.262},{name:"Emissive R",value:.33725490196078417},{name:"Emissive G",value:.21176470588235294},{name:"Emissive B",value:.807843137254902},{name:"Shininess",value:14.19},{name:"Specular Amount",value:0},{name:"Specular Model index",value:2},{name:"Specular Model",value:"Phong"},{name:"Energy Conservation",value:0},{name:"Double Sided Material",value:0},{name:"Falloff Mode index",value:0},{name:"Falloff Mode",value:"A"},{name:"Colorize Texture",value:0},{name:"Diffuse Repeat X",value:1},{name:"Diffuse Repeat Y",value:1},{name:"Texture Offset X",value:0},{name:"Texture Offset Y",value:0},{name:"Specular Intensity",value:1},{name:"Normal Map Intensity",value:.5},{name:"AO Intensity",value:1},{name:"AO UV Channel index",value:0},{name:"AO UV Channel",value:1},{name:"Emissive Intensity",value:1},{name:"Emissive Mask Intensity",value:1},{name:"Env Map Intensity",value:1},{name:"Env Map Blend index",value:0},{name:"Env Map Blend",value:"Add"},{name:"Env Mask Intensity",value:1},{name:"Alpha Mask Source index",value:0},{name:"Alpha Mask Source",value:"Luminance"},{name:"Discard Transparent Pixels",value:0}],portsOut:[{name:"Trigger Out",links:[{portIn:"Trigger",portOut:"Trigger Out",objIn:"zvmel54ic",objOut:"ex1e5uu4e"}]}],objName:"Ops.Gl.Phong.PhongMaterial_v6"},{id:"1gi5mg2hr",uiAttribs:{},portsIn:[{name:"scale",value:.08},{name:"rotX",value:0},{name:"rotY",value:0},{name:"rotZ",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"gv5zo7qtz",objOut:"1gi5mg2hr"}]}],objName:"Ops.Graphics.Transform"},{id:"2976legsg",uiAttribs:{},portsOut:[{name:"result",links:[{portIn:"radius",portOut:"result",objIn:"e6cgoaiuk",objOut:"2976legsg"},{portIn:"number1",portOut:"result",objIn:"4erq6qkzd",objOut:"2976legsg"}]}],objName:"Ops.Number.Number"},{id:"euh159ywa",uiAttribs:{},portsIn:[{name:"scale",value:1},{name:"x",value:1},{name:"z",value:.3}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"hrot9cdev",objOut:"euh159ywa"}]}],objName:"Ops.Gl.Matrix.Scale"},{id:"gh02yq60d",uiAttribs:{},portsIn:[{name:"radius",value:.5},{name:"stacks",value:64},{name:"slices",value:4},{name:"Filloffset",value:1},{name:"Render",value:1}],objName:"Ops.Graphics.Meshes.Sphere_v3"},{id:"h0fnqbbpg",uiAttribs:{},portsIn:[{name:"scale",value:1},{name:"x",value:1},{name:"z",value:.3}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"gh02yq60d",objOut:"h0fnqbbpg"}]}],objName:"Ops.Gl.Matrix.Scale"},{id:"aisdzcq2y",uiAttribs:{},portsIn:[{name:"posY",value:0},{name:"posZ",value:0},{name:"scale",value:1},{name:"rotX",value:0},{name:"rotY",value:0},{name:"rotZ",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"euh159ywa",objOut:"aisdzcq2y"}]}],objName:"Ops.Graphics.Transform"},{id:"ug49w813h",uiAttribs:{},portsIn:[{name:"posY",value:0},{name:"posZ",value:0},{name:"scale",value:1},{name:"rotX",value:0},{name:"rotY",value:0},{name:"rotZ",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"h0fnqbbpg",objOut:"ug49w813h"}]}],objName:"Ops.Graphics.Transform"},{id:"p70xgy7wj",uiAttribs:{},portsIn:[{name:"value",value:1.05}],portsOut:[{name:"result",links:[{portIn:"Value",portOut:"result",objIn:"lgeckpzff",objOut:"p70xgy7wj"},{portIn:"posX",portOut:"result",objIn:"ug49w813h",objOut:"p70xgy7wj"}]}],objName:"Ops.Number.Number"},{id:"lgeckpzff",uiAttribs:{},portsOut:[{name:"Result",links:[{portIn:"posX",portOut:"Result",objIn:"aisdzcq2y",objOut:"lgeckpzff"}]}],objName:"Ops.Math.FlipSign"},{id:"0v4af37jc",uiAttribs:{},portsIn:[{name:"Speed",value:8},{name:"Play",value:1},{name:"Sync to timeline",value:0}],portsOut:[{name:"Time",links:[{portIn:"val",portOut:"Time",objIn:"z72c5tm0f",objOut:"0v4af37jc"}]}],objName:"Ops.Anim.Timer_v2"},{id:"8litnc4qu",uiAttribs:{},portsIn:[{name:"key code",value:76},{name:"canvas only",value:1},{name:"Mod Key index",value:0},{name:"Mod Key",value:"none"},{name:"Enabled",value:1},{name:"Prevent Default",value:0}],portsOut:[{name:"on press",links:[{portIn:"Reset",portOut:"on press",objIn:"0v4af37jc",objOut:"8litnc4qu"}]},{name:"Pressed",value:0},{name:"Key",value:"L"}],objName:"Ops.Devices.Keyboard.KeyPressLearn"},{id:"da2t0zzop",uiAttribs:{},portsIn:[{name:"Frequency",value:1},{name:"Type index",value:1},{name:"Type",value:"triangle"},{name:"Phase",value:0},{name:"Range Min",value:1},{name:"Range Max",value:0}],portsOut:[{name:"Result",links:[{portIn:"Value",portOut:"Result",objIn:"rn9eb3huy",objOut:"da2t0zzop"}]}],objName:"Ops.Anim.LFO_v3"},{id:"8btm586rf",uiAttribs:{},portsIn:[{name:"Number 2",value:0},{name:"Number 3",value:0},{name:"Number 4",value:0},{name:"Number 5",value:0},{name:"Number 6",value:0},{name:"Number 7",value:0},{name:"Number 8",value:0},{name:"Fill Graph",value:1}],objName:"Ops.Ui.VizGraph"},{id:"z72c5tm0f",uiAttribs:{},portsIn:[{name:"min",value:0},{name:"max",value:2},{name:"ignore outside values",value:0}],portsOut:[{name:"result",links:[{portIn:"Time",portOut:"result",objIn:"da2t0zzop",objOut:"z72c5tm0f"}]}],objName:"Ops.Math.Clamp"},{id:"rn9eb3huy",uiAttribs:{},portsIn:[{name:"Min",value:0},{name:"Max",value:1},{name:"Easing index",value:14},{name:"Easing",value:"Quart Out"}],portsOut:[{name:"Result",links:[{portIn:"Number 1",portOut:"Result",objIn:"8btm586rf",objOut:"rn9eb3huy"},{portIn:"value",portOut:"Result",objIn:"71o5numex",objOut:"rn9eb3huy"}]}],objName:"Ops.Math.Ease"},{id:"71o5numex",uiAttribs:{},portsIn:[{name:"old min",value:0},{name:"old max",value:1},{name:"new min",value:.2},{name:"new max",value:1.55},{name:"Easing index",value:0},{name:"Easing",value:"Linear"},{name:"Clamp",value:1}],portsOut:[{name:"result",links:[{portIn:"y",portOut:"result",objIn:"euh159ywa",objOut:"71o5numex"},{portIn:"y",portOut:"result",objIn:"h0fnqbbpg",objOut:"71o5numex"}]}],objName:"Ops.Math.MapRange"},{id:"72g6xn69e",uiAttribs:{},portsIn:[{name:"Y",value:0},{name:"Z",value:0},{name:"Scale",value:.2},{name:"Seed",value:1}],portsOut:[{name:"Result",links:[{portIn:"value",portOut:"Result",objIn:"w4druv73s",objOut:"72g6xn69e"}]}],objName:"Ops.Math.PerlinNoise_v2"},{id:"hceus9rry",uiAttribs:{},portsIn:[{name:"Number 2",value:0},{name:"Number 3",value:0},{name:"Number 4",value:0},{name:"Number 5",value:0},{name:"Number 6",value:0},{name:"Number 7",value:0},{name:"Number 8",value:0},{name:"Fill Graph",value:1}],objName:"Ops.Ui.VizGraph"},{id:"pbc272cjf",uiAttribs:{},portsIn:[{name:"Speed",value:1},{name:"Play",value:1},{name:"Sync to timeline",value:0}],portsOut:[{name:"Time",links:[{portIn:"X",portOut:"Time",objIn:"72g6xn69e",objOut:"pbc272cjf"},{portIn:"X",portOut:"Time",objIn:"bptch9yb8",objOut:"pbc272cjf"}]}],objName:"Ops.Anim.Timer_v2"},{id:"bptch9yb8",uiAttribs:{},portsIn:[{name:"Y",value:0},{name:"Z",value:0},{name:"Scale",value:.4},{name:"Seed",value:9}],portsOut:[{name:"Result",links:[{portIn:"value",portOut:"Result",objIn:"8dyntdgyq",objOut:"bptch9yb8"}]}],objName:"Ops.Math.PerlinNoise_v2"},{id:"w4druv73s",uiAttribs:{},portsIn:[{name:"old min",value:0},{name:"old max",value:1},{name:"Easing index",value:0},{name:"Easing",value:"Linear"},{name:"Clamp",value:1}],portsOut:[{name:"result",links:[{portIn:"Number 1",portOut:"result",objIn:"hceus9rry",objOut:"w4druv73s"},{portIn:"number1",portOut:"result",objIn:"7n93vy9rz",objOut:"w4druv73s"}]}],objName:"Ops.Math.MapRange"},{id:"8dyntdgyq",uiAttribs:{},portsIn:[{name:"old min",value:0},{name:"old max",value:1},{name:"Easing index",value:0},{name:"Easing",value:"Linear"},{name:"Clamp",value:1}],portsOut:[{name:"result",links:[{portIn:"number1",portOut:"result",objIn:"3ol0ekl1x",objOut:"8dyntdgyq"}]}],objName:"Ops.Math.MapRange"},{id:"4erq6qkzd",uiAttribs:{},portsIn:[{name:"number2",value:.05}],portsOut:[{name:"result",links:[{portIn:"posZ",portOut:"result",objIn:"1gi5mg2hr",objOut:"4erq6qkzd"}]}],objName:"Ops.Math.Sum"},{id:"txwz4q4ov",uiAttribs:{},portsIn:[{name:"min",value:200},{name:"max",value:3e3},{name:"Integer",value:0},{name:"No consecutive duplicates",value:0}],portsOut:[{name:"result",links:[{portIn:"interval",portOut:"result",objIn:"9dyey5vef",objOut:"txwz4q4ov"}]}],objName:"Ops.Math.TriggerRandomNumber_v3"},{id:"9dyey5vef",uiAttribs:{},portsIn:[{name:"Active",value:1}],portsOut:[{name:"trigger",links:[{portIn:"Generate",portOut:"trigger",objIn:"txwz4q4ov",objOut:"9dyey5vef"},{portIn:"Reset",portOut:"trigger",objIn:"0v4af37jc",objOut:"9dyey5vef"}]}],objName:"Ops.Trigger.Interval"},{id:"zvmel54ic",uiAttribs:{},portsOut:[{name:"Next",links:[{portIn:"render",portOut:"Next",objIn:"ug49w813h",objOut:"zvmel54ic"},{portIn:"render",portOut:"Next",objIn:"aisdzcq2y",objOut:"zvmel54ic"},{portIn:"render",portOut:"Next",objIn:"b7apu9im7",objOut:"zvmel54ic"}]}],objName:"Ops.Ui.Routing.RouteTrigger"},{id:"d4bs7kv8n",uiAttribs:{},portsIn:[{name:"Integer",value:0},{name:"No consecutive duplicates",value:0}],portsOut:[{name:"result",links:[{portIn:"val",portOut:"result",objIn:"6xtxncxmr",objOut:"d4bs7kv8n"}]}],objName:"Ops.Math.TriggerRandomNumber_v3"},{id:"17tt1y5td",uiAttribs:{},portsIn:[{name:"duration",value:.2},{name:"easing index",value:8},{name:"easing",value:"Expo Out"}],portsOut:[{name:"Next",links:[{portIn:"exe",portOut:"Next",objIn:"htxpcnnh7",objOut:"17tt1y5td"}]},{name:"result",links:[{portIn:"number2",portOut:"result",objIn:"7n93vy9rz",objOut:"17tt1y5td"}]}],objName:"Ops.Anim.AnimNumber"},{id:"31q3tlzl3",uiAttribs:{},portsOut:[{name:"Next",links:[{portIn:"exe",portOut:"Next",objIn:"17tt1y5td",objOut:"31q3tlzl3"}]}],objName:"Ops.Ui.Routing.RouteTrigger"},{id:"7n93vy9rz",uiAttribs:{},portsOut:[{name:"result",links:[{portIn:"posX",portOut:"result",objIn:"1gi5mg2hr",objOut:"7n93vy9rz"}]}],objName:"Ops.Math.Sum"},{id:"79hobvqso",uiAttribs:{},portsIn:[{name:"min",value:1e3},{name:"max",value:3e3},{name:"Integer",value:0},{name:"No consecutive duplicates",value:0}],portsOut:[{name:"result",links:[{portIn:"interval",portOut:"result",objIn:"2ky3hu0p6",objOut:"79hobvqso"}]}],objName:"Ops.Math.TriggerRandomNumber_v3"},{id:"2ky3hu0p6",uiAttribs:{},portsIn:[{name:"Active",value:1}],portsOut:[{name:"trigger",links:[{portIn:"Generate",portOut:"trigger",objIn:"79hobvqso",objOut:"2ky3hu0p6"},{portIn:"Generate",portOut:"trigger",objIn:"d4bs7kv8n",objOut:"2ky3hu0p6"}]}],objName:"Ops.Trigger.Interval"},{id:"kdvvvb6qi",uiAttribs:{},portsIn:[{name:"Integer",value:0},{name:"No consecutive duplicates",value:0}],portsOut:[{name:"result",links:[{portIn:"val",portOut:"result",objIn:"msl6lzddd",objOut:"kdvvvb6qi"}]}],objName:"Ops.Math.TriggerRandomNumber_v3"},{id:"htxpcnnh7",uiAttribs:{},portsIn:[{name:"duration",value:.2},{name:"easing index",value:8},{name:"easing",value:"Expo Out"}],portsOut:[{name:"result",links:[{portIn:"Number 1",portOut:"result",objIn:"gqzdtaz3v",objOut:"htxpcnnh7"},{portIn:"number2",portOut:"result",objIn:"3ol0ekl1x",objOut:"htxpcnnh7"}]}],objName:"Ops.Anim.AnimNumber"},{id:"bdyd66322",uiAttribs:{},portsIn:[{name:"min",value:1e3},{name:"max",value:3e3},{name:"Integer",value:0},{name:"No consecutive duplicates",value:0}],portsOut:[{name:"result",links:[{portIn:"interval",portOut:"result",objIn:"mjwelt64p",objOut:"bdyd66322"}]}],objName:"Ops.Math.TriggerRandomNumber_v3"},{id:"mjwelt64p",uiAttribs:{},portsIn:[{name:"Active",value:1}],portsOut:[{name:"trigger",links:[{portIn:"Generate",portOut:"trigger",objIn:"bdyd66322",objOut:"mjwelt64p"},{portIn:"Generate",portOut:"trigger",objIn:"kdvvvb6qi",objOut:"mjwelt64p"}]}],objName:"Ops.Trigger.Interval"},{id:"3ol0ekl1x",uiAttribs:{},portsOut:[{name:"result",links:[{portIn:"posY",portOut:"result",objIn:"1gi5mg2hr",objOut:"3ol0ekl1x"}]}],objName:"Ops.Math.Sum"},{id:"mhgjji6ww",uiAttribs:{},portsIn:[{name:"value",value:.05}],portsOut:[{name:"result",links:[{portIn:"Value",portOut:"result",objIn:"rouh4o2pl",objOut:"mhgjji6ww"},{portIn:"max",portOut:"result",objIn:"d4bs7kv8n",objOut:"mhgjji6ww"},{portIn:"max",portOut:"result",objIn:"kdvvvb6qi",objOut:"mhgjji6ww"},{portIn:"max",portOut:"result",objIn:"6xtxncxmr",objOut:"mhgjji6ww"},{portIn:"max",portOut:"result",objIn:"msl6lzddd",objOut:"mhgjji6ww"}]}],objName:"Ops.Number.Number"},{id:"rouh4o2pl",uiAttribs:{},portsOut:[{name:"Result",links:[{portIn:"min",portOut:"Result",objIn:"d4bs7kv8n",objOut:"rouh4o2pl"},{portIn:"min",portOut:"Result",objIn:"kdvvvb6qi",objOut:"rouh4o2pl"},{portIn:"min",portOut:"Result",objIn:"6xtxncxmr",objOut:"rouh4o2pl"},{portIn:"min",portOut:"Result",objIn:"msl6lzddd",objOut:"rouh4o2pl"}]}],objName:"Ops.Math.FlipSign"},{id:"gqzdtaz3v",uiAttribs:{},portsIn:[{name:"Number 2",value:0},{name:"Number 3",value:0},{name:"Number 4",value:0},{name:"Number 5",value:0},{name:"Number 6",value:0},{name:"Number 7",value:0},{name:"Number 8",value:0},{name:"Fill Graph",value:1}],objName:"Ops.Ui.VizGraph"},{id:"lyq3v9gum",uiAttribs:{},portsIn:[{name:"value",value:.05}],portsOut:[{name:"result",links:[{portIn:"Value",portOut:"result",objIn:"kb4oitcby",objOut:"lyq3v9gum"},{portIn:"new max",portOut:"result",objIn:"w4druv73s",objOut:"lyq3v9gum"},{portIn:"new max",portOut:"result",objIn:"8dyntdgyq",objOut:"lyq3v9gum"}]}],objName:"Ops.Number.Number"},{id:"kb4oitcby",uiAttribs:{},portsOut:[{name:"Result",links:[{portIn:"new min",portOut:"Result",objIn:"w4druv73s",objOut:"kb4oitcby"},{portIn:"new min",portOut:"Result",objIn:"8dyntdgyq",objOut:"kb4oitcby"}]}],objName:"Ops.Math.FlipSign"},{id:"e1ijl2j3v",uiAttribs:{},portsOut:[{name:"Result",links:[{portIn:"number",portOut:"Result",objIn:"zfuht2u9i",objOut:"e1ijl2j3v"},{portIn:"A",portOut:"Result",objIn:"ykbscws2u",objOut:"e1ijl2j3v"}]}],objName:"Ops.Ui.VizNumber"},{id:"gv5zo7qtz",uiAttribs:{},portsIn:[{name:"x",value:1},{name:"y",value:1},{name:"z",value:1}],portsOut:[{name:"trigger",links:[{portIn:"Trigger In",portOut:"trigger",objIn:"ex1e5uu4e",objOut:"gv5zo7qtz"}]}],objName:"Ops.Gl.Matrix.Scale"},{id:"zfuht2u9i",uiAttribs:{},portsOut:[{name:"result",value:7.38905609893065}],objName:"Ops.Math.Exp"},{id:"ygzv51ai5",uiAttribs:{},portsOut:[{name:"Result",value:.25}],objName:"Ops.Ui.VizNumber"},{id:"hvaljn2f6",uiAttribs:{},portsIn:[{name:"number1",value:1}],portsOut:[{name:"result",links:[{portIn:"Number",portOut:"result",objIn:"ygzv51ai5",objOut:"hvaljn2f6"},{portIn:"value",portOut:"result",objIn:"mc3b1iq0t",objOut:"hvaljn2f6"}]}],objName:"Ops.Math.Divide"},{id:"mc3b1iq0t",uiAttribs:{},portsIn:[{name:"old min",value:0},{name:"old max",value:.25},{name:"new min",value:0},{name:"new max",value:1},{name:"Easing index",value:0},{name:"Easing",value:"Linear"},{name:"Clamp",value:0}],portsOut:[{name:"result",links:[{portIn:"scale",portOut:"result",objIn:"gv5zo7qtz",objOut:"mc3b1iq0t"}]}],objName:"Ops.Math.MapRange"},{id:"ykbscws2u",uiAttribs:{},portsIn:[{name:"B",value:1},{name:"C",value:2},{name:"D",value:3},{name:"Expression",value:"a*a"}],portsOut:[{name:"Result",links:[{portIn:"number2",portOut:"Result",objIn:"hvaljn2f6",objOut:"ykbscws2u"}]},{name:"Expression Valid",value:true}],objName:"Ops.Math.MathExpression"},{id:"840umln1j",uiAttribs:{},portsIn:[{name:"Separate inc/dec",value:0},{name:"Inc factor",value:10,title:"Inc/Dec factor"},{name:"Dec factor",value:4}],portsOut:[{name:"Result",links:[{portIn:"Number",portOut:"Result",objIn:"e1ijl2j3v",objOut:"840umln1j"}]}],objName:"Ops.Anim.Smooth"},{id:"un52p22kf",uiAttribs:{},portsIn:[{name:"Coordinates index",value:0},{name:"Coordinates",value:"-1 to 1"},{name:"Area index",value:0},{name:"Area",value:"Canvas Area"},{name:"flip y",value:1},{name:"right click prevent default",value:1},{name:"Events index",value:0},{name:"Events",value:"Pointer"},{name:"Passive Events",value:0},{name:"Active",value:1}],portsOut:[{name:"x",links:[{portIn:"Value",portOut:"x",objIn:"79h5bn98z",objOut:"un52p22kf"}]},{name:"y",links:[{portIn:"Value",portOut:"y",objIn:"q9jhdb3em",objOut:"un52p22kf"}]},{name:"Button is down",value:0},{name:"Mouse is hovering",links:[{portIn:"value",portOut:"Mouse is hovering",objIn:"n3p40o0am",objOut:"un52p22kf"}]},{name:"Movement X",value:0},{name:"Movement Y",value:1}],objName:"Ops.Devices.Mouse.Mouse_v4"},{id:"q25z33wno",uiAttribs:{},portsIn:[{name:"Value 1",value:0}],portsOut:[{name:"Result",links:[{portIn:"value",portOut:"Result",objIn:"m4i3cy4vp",objOut:"q25z33wno"}]}],objName:"Ops.Math.Interpolate"},{id:"vn2p4m4mt",uiAttribs:{},portsIn:[{name:"Value 1",value:0}],portsOut:[{name:"Result",links:[{portIn:"value",portOut:"Result",objIn:"fdfkd537s",objOut:"vn2p4m4mt"}]}],objName:"Ops.Math.Interpolate"},{id:"fdfkd537s",uiAttribs:{},portsOut:[{name:"result",links:[{portIn:"Value",portOut:"result",objIn:"292di9ueu",objOut:"fdfkd537s"}]}],objName:"Ops.Number.Number"},{id:"m4i3cy4vp",uiAttribs:{},portsOut:[{name:"result",links:[{portIn:"Value",portOut:"result",objIn:"023o3vebw",objOut:"m4i3cy4vp"}]}],objName:"Ops.Number.Number"},{id:"79h5bn98z",uiAttribs:{},portsIn:[{name:"Separate inc/dec",value:0},{name:"Inc factor",value:1.3666666666666667,useVariable:"baseSmooth",title:"Inc/Dec factor"},{name:"Dec factor",value:4}],portsOut:[{name:"Result",links:[{portIn:"Value 2",portOut:"Result",objIn:"q25z33wno",objOut:"79h5bn98z"}]}],objName:"Ops.Anim.Smooth"},{id:"q9jhdb3em",uiAttribs:{},portsIn:[{name:"Separate inc/dec",value:0},{name:"Inc factor",value:1.3666666666666667,useVariable:"baseSmooth",title:"Inc/Dec factor"},{name:"Dec factor",value:4}],portsOut:[{name:"Result",links:[{portIn:"Value 2",portOut:"Result",objIn:"vn2p4m4mt",objOut:"q9jhdb3em"}]}],objName:"Ops.Anim.Smooth"},{id:"023o3vebw",uiAttribs:{},portsIn:[{name:"Variable",value:"mousex"}],objName:"Ops.Vars.VarSetNumber_v2"},{id:"292di9ueu",uiAttribs:{},portsIn:[{name:"Variable",value:"mousey"}],objName:"Ops.Vars.VarSetNumber_v2"},{id:"n3p40o0am",uiAttribs:{},portsIn:[{name:"damping",value:.803},{name:"stiffness",value:.999}],portsOut:[{name:"trigger",links:[{portIn:"Update",portOut:"trigger",objIn:"79h5bn98z",objOut:"n3p40o0am"},{portIn:"Update",portOut:"trigger",objIn:"q9jhdb3em",objOut:"n3p40o0am"}]},{name:"result",links:[{portIn:"Percentage",portOut:"result",objIn:"q25z33wno",objOut:"n3p40o0am"},{portIn:"Percentage",portOut:"result",objIn:"vn2p4m4mt",objOut:"n3p40o0am"}]}],objName:"Ops.Patch.PJdRYK1.SpringCustom"},{id:"028vx1zi3",uiAttribs:{},portsIn:[{name:"number2",value:60}],portsOut:[{name:"result",links:[{portIn:"number2",portOut:"result",objIn:"er7y1ix1k",objOut:"028vx1zi3"}]}],objName:"Ops.Math.Divide"},{id:"er7y1ix1k",uiAttribs:{},portsIn:[{name:"number1",value:2}],portsOut:[{name:"result",links:[{portIn:"Value",portOut:"result",objIn:"k9ccteo7h",objOut:"er7y1ix1k"}]}],objName:"Ops.Math.Multiply"},{id:"k9ccteo7h",uiAttribs:{},portsIn:[{name:"Variable",value:"baseSmooth"}],objName:"Ops.Vars.VarSetNumber_v2"},{id:"asf5pkq9d",uiAttribs:{},portsOut:[{name:"FPS",links:[{portIn:"val",portOut:"FPS",objIn:"vj82nituv",objOut:"asf5pkq9d"}]},{name:"MS",value:6.29}],objName:"Ops.Cables.FPS_v2"},{id:"54eic43lh",uiAttribs:{},portsIn:[{name:"Variable",value:"mousex"}],portsOut:[{name:"Value",links:[{portIn:"number1",portOut:"Value",objIn:"h93rw8ff4",objOut:"54eic43lh"}]}],objName:"Ops.Vars.VarGetNumber_v2"},{id:"4qdldn8fo",uiAttribs:{},portsIn:[{name:"Variable",value:"mousey"}],portsOut:[{name:"Value",links:[{portIn:"number1",portOut:"Value",objIn:"ws07ccks0",objOut:"4qdldn8fo"}]}],objName:"Ops.Vars.VarGetNumber_v2"},{id:"h93rw8ff4",uiAttribs:{},portsIn:[{name:"number2",value:10}],portsOut:[{name:"result",links:[{portIn:"number",portOut:"result",objIn:"vd275tofj",objOut:"h93rw8ff4"}]}],objName:"Ops.Math.Multiply"},{id:"zmnc6oe6i",uiAttribs:{},portsIn:[{name:"Speed",value:10},{name:"Play",value:1},{name:"Sync to timeline",value:0}],portsOut:[{name:"Time",links:[{portIn:"rotY",portOut:"Time",objIn:"etme2op0q",objOut:"zmnc6oe6i"}]}],objName:"Ops.Anim.Timer_v2"},{id:"spgu0ur35",uiAttribs:{},portsIn:[{name:"Speed",value:10},{name:"Play",value:1},{name:"Sync to timeline",value:0}],portsOut:[{name:"Time",links:[{portIn:"rotX",portOut:"Time",objIn:"etme2op0q",objOut:"spgu0ur35"}]}],objName:"Ops.Anim.Timer_v2"},{id:"6yfxiel8o",uiAttribs:{},portsIn:[{name:"Cast Light",value:1},{name:"Intensity",value:1.89},{name:"Radius",value:15},{name:"X",value:2.58},{name:"Y",value:4.86},{name:"Z",value:7.68},{name:"R",value:.8},{name:"G",value:.8},{name:"B",value:.8},{name:"Specular R",value:1},{name:"Specular G",value:1},{name:"Specular B",value:1},{name:"Falloff",value:.5},{name:"Cast Shadow",value:0},{name:"Rendering Active",value:1},{name:"Map Size index",value:1},{name:"Map Size",value:512},{name:"Shadow Strength",value:1},{name:"Near",value:.1},{name:"Far",value:30},{name:"Bias",value:.004},{name:"Polygon Offset",value:0}],portsOut:[{name:"Trigger Out",links:[{portIn:"render",portOut:"Trigger Out",objIn:"1gi5mg2hr",objOut:"6yfxiel8o"}]},{name:"World Position X",value:3.3539998531341553},{name:"World Position Y",value:6.317999839782715},{name:"World Position Z",value:9.983999252319336}],objName:"Ops.Gl.Phong.PointLight_v5"},{id:"sdsijwz7p",uiAttribs:{},portsIn:[{name:"Gradient",value:'{"keys":[{"pos":0,"posy":0.52,"r":0.5172090657552083,"g":0.8733333333333333,"b":0.8622044499715169},{"pos":0.419921875,"posy":0.52,"r":0.5172090657552083,"g":0.8733333333333333,"b":0.8622044499715169},{"pos":1,"posy":0.42,"r":0.7173120117187499,"g":0.829632000990317,"b":0.84},{"pos":1,"posy":0.42,"r":0.7173120117187499,"g":0.829632000990317,"b":0.84}]}'},{name:"Direction index",value:6},{name:"Direction",value:"Radial"},{name:"Smoothstep",value:1},{name:"Step",value:0},{name:"Flip",value:0},{name:"sRGB",value:0},{name:"Oklab",value:0},{name:"Size",value:128},{name:"filter index",value:1},{name:"filter",value:"linear"},{name:"wrap index",value:1},{name:"wrap",value:"repeat"},{name:"Dither",value:0},{name:"Gradient Array",value:0}],portsOut:[{name:"Texture",links:[{portIn:"Image",portOut:"Texture",objIn:"gu49yw83j",objOut:"sdsijwz7p"}]}],objName:"Ops.Gl.GradientTexture"},{id:"cgm3z6pgu",uiAttribs:{},portsIn:[{name:"Size index",value:0},{name:"Size",value:"Canvas"},{name:"texture width",value:1933},{name:"texture height",value:761},{name:"Auto Aspect",value:1},{name:"filter index",value:1},{name:"filter",value:"linear"},{name:"Wrap index",value:1},{name:"Wrap",value:"Repeat"},{name:"MSAA index",value:0},{name:"MSAA",value:"none"},{name:"Pixel Format index",value:4},{name:"Pixel Format",value:"RGBA 8bit ubyte"},{name:"Depth",value:1},{name:"Clear",value:1}],portsOut:[{name:"trigger",links:[{portIn:"Trigger In",portOut:"trigger",objIn:"6yfxiel8o",objOut:"cgm3z6pgu"}]},{name:"texture",links:[{portIn:"Image",portOut:"texture",objIn:"d3k66fpsw",objOut:"cgm3z6pgu"}]}],objName:"Ops.Gl.RenderToTexture_v3"},{id:"d3k66fpsw",uiAttribs:{},portsIn:[{name:"blendMode index",value:0},{name:"blendMode",value:"normal"},{name:"amount",value:1},{name:"Premultiplied",value:0},{name:"Alpha Mask",value:0},{name:"removeAlphaSrc",value:0},{name:"Mask Src index",value:1},{name:"Mask Src",value:"luminance"},{name:"Invert alpha channel",value:0},{name:"Aspect Ratio",value:0},{name:"Stretch Axis index",value:0},{name:"Stretch Axis",value:"X"},{name:"Position",value:0},{name:"Crop",value:0},{name:"flip x",value:0},{name:"flip y",value:0},{name:"Transform",value:0},{name:"Scale X",value:1},{name:"Scale Y",value:1},{name:"Position X",value:0},{name:"Position Y",value:0},{name:"Rotation",value:0},{name:"Clip Repeat",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"2abqvfihl",objOut:"d3k66fpsw"}]}],objName:"Ops.Gl.ImageCompose.DrawImage_v3"},{id:"i9ejmrtse",uiAttribs:{},portsIn:[{name:"blendMode index",value:11},{name:"blendMode",value:"overlay"},{name:"amount",value:0},{name:"Premultiplied",value:0},{name:"Alpha Mask",value:0},{name:"removeAlphaSrc",value:0},{name:"Mask Src index",value:1},{name:"Mask Src",value:"luminance"},{name:"Invert alpha channel",value:0},{name:"Aspect Ratio",value:0},{name:"Stretch Axis index",value:0},{name:"Stretch Axis",value:"X"},{name:"Position",value:0},{name:"Crop",value:0},{name:"flip x",value:0},{name:"flip y",value:0},{name:"Transform",value:0},{name:"Scale X",value:1},{name:"Scale Y",value:1},{name:"Position X",value:0},{name:"Position Y",value:0},{name:"Rotation",value:0},{name:"Clip Repeat",value:0}],portsOut:[{name:"trigger",links:[{portIn:"Render",portOut:"trigger",objIn:"7nk9ycmxj",objOut:"i9ejmrtse"}]}],objName:"Ops.Gl.ImageCompose.DrawImage_v3"},{id:"tud1nnwm5",uiAttribs:{},portsIn:[{name:"Filter index",value:0},{name:"Filter",value:"nearest"},{name:"Wrap index",value:0},{name:"Wrap",value:"repeat"},{name:"Color",value:1},{name:"Pixel Format index",value:4},{name:"Pixel Format",value:"RGBA 8bit ubyte"},{name:"Integer",value:0},{name:"Seed",value:1},{name:"Channel R",value:1},{name:"Min R",value:0},{name:"Max R",value:1},{name:"Channel G",value:1},{name:"Min G",value:0},{name:"Max G",value:1},{name:"Channel B",value:1},{name:"Min B",value:0},{name:"Max B",value:1},{name:"Channel A",value:1},{name:"Min A",value:1},{name:"Max A",value:1}],portsOut:[{name:"Texture",links:[{portIn:"Image",portOut:"Texture",objIn:"i9ejmrtse",objOut:"tud1nnwm5"}]},{name:"Total Pixel",value:30193}],objName:"Ops.Gl.Textures.NoiseTexture"},{id:"tuuxfeo9v",uiAttribs:{},portsIn:[{name:"number2",value:7}],portsOut:[{name:"result",links:[{portIn:"Width",portOut:"result",objIn:"tud1nnwm5",objOut:"tuuxfeo9v"}]}],objName:"Ops.Math.Divide"},{id:"em66yq9jx",uiAttribs:{},portsIn:[{name:"number2",value:7}],portsOut:[{name:"result",links:[{portIn:"Height",portOut:"result",objIn:"tud1nnwm5",objOut:"em66yq9jx"}]}],objName:"Ops.Math.Divide"},{id:"96z3mhecj",uiAttribs:{},portsIn:[{name:"Blend Mode index",value:0},{name:"Blend Mode",value:"normal"},{name:"Amount",value:1},{name:"farplane",value:50},{name:"nearplane",value:.1},{name:"Invert",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"nt515w4t7",objOut:"96z3mhecj"}]}],objName:"Ops.Gl.ImageCompose.DepthTexture_v2"},{id:"8mbqzuwvf",uiAttribs:{},portsIn:[{name:"Size index",value:0},{name:"Size",value:"Auto"},{name:"Width",value:640},{name:"Height",value:480},{name:"Filter index",value:1},{name:"Filter",value:"linear"},{name:"Wrap index",value:1},{name:"Wrap",value:"repeat"},{name:"Anisotropic index",value:0},{name:"Anisotropic",value:"0"},{name:"Pixel Format index",value:4},{name:"Pixel Format",value:"RGBA 8bit ubyte"},{name:"Clear",value:1},{name:"R",value:0},{name:"G",value:0},{name:"B",value:0},{name:"A",value:0}],portsOut:[{name:"Next",links:[{portIn:"render",portOut:"Next",objIn:"96z3mhecj",objOut:"8mbqzuwvf"}]},{name:"texture_out",links:[{portIn:"Mask",portOut:"texture_out",objIn:"i9ejmrtse",objOut:"8mbqzuwvf"},{portIn:"Mask",portOut:"texture_out",objIn:"7nk9ycmxj",objOut:"8mbqzuwvf"}]},{name:"Aspect Ratio",value:2.540078843626807},{name:"Texture Width",value:1933},{name:"Texture Height",value:761}],objName:"Ops.Gl.ImageCompose.ImageCompose_v4"},{id:"nt515w4t7",uiAttribs:{},portsIn:[{name:"Blend Mode index",value:0},{name:"Blend Mode",value:"normal"},{name:"Amount",value:1},{name:"Mask Invert",value:0},{name:"Invert R",value:1},{name:"Invert G",value:1},{name:"Invert B",value:1}],objName:"Ops.Gl.ImageCompose.Invert_v2"},{id:"7nk9ycmxj",uiAttribs:{},portsIn:[{name:"Blend Mode index",value:11},{name:"Blend Mode",value:"overlay"},{name:"Amount",value:0},{name:"threshold",value:1},{name:"strength",value:500},{name:"Mask Src index",value:0},{name:"Mask Src",value:"R"}],portsOut:[{name:"Trigger",links:[{portIn:"render",portOut:"Trigger",objIn:"lvs03rsvy",objOut:"7nk9ycmxj"}]}],objName:"Ops.Gl.ImageCompose.Dither_v2"},{id:"w6i0p89a1",uiAttribs:{},portsIn:[{name:"Size index",value:0},{name:"Size",value:"Auto"},{name:"Filter index",value:0},{name:"Filter",value:"nearest"},{name:"Wrap index",value:1},{name:"Wrap",value:"repeat"},{name:"Anisotropic index",value:0},{name:"Anisotropic",value:"0"},{name:"Pixel Format index",value:4},{name:"Pixel Format",value:"RGBA 8bit ubyte"},{name:"Clear",value:1},{name:"R",value:0},{name:"G",value:0},{name:"B",value:0},{name:"A",value:0}],portsOut:[{name:"Next",links:[{portIn:"render",portOut:"Next",objIn:"ldcwmakfd",objOut:"w6i0p89a1"}]},{name:"texture_out",links:[{portIn:"Base Texture",portOut:"texture_out",objIn:"h8sqbt3n2",objOut:"w6i0p89a1"},{portIn:"Texture In",portOut:"texture_out",objIn:"ow6w9gd4p",objOut:"w6i0p89a1"}]},{name:"Aspect Ratio",value:2.540078843626807},{name:"Texture Width",value:1933},{name:"Texture Height",value:761}],objName:"Ops.Gl.ImageCompose.ImageCompose_v4"},{id:"qucydf7c1",uiAttribs:{},portsIn:[{name:"Blend Mode index",value:0},{name:"Blend Mode",value:"normal"},{name:"Alpha Mask index",value:0},{name:"Alpha Mask",value:"Off"},{name:"Amount",value:1},{name:"Width",value:20},{name:"Height",value:20},{name:"Aspect",value:1},{name:"Mul",value:-3.47},{name:"X",value:0},{name:"Y",value:0},{name:"Greyscale",value:1},{name:"Offset Multiply",value:1},{name:"Offset X index",value:0},{name:"Offset X",value:"None"},{name:"Offset Y index",value:0},{name:"Offset Y",value:"None"},{name:"Offset Time index",value:1},{name:"Offset Time",value:"R"}],portsOut:[{name:"trigger",links:[{portIn:"Render",portOut:"trigger",objIn:"ek3gcor4t",objOut:"qucydf7c1"}]}],objName:"Ops.Gl.ImageCompose.Plasma_v2"},{id:"ow6w9gd4p",uiAttribs:{},portsIn:[{name:"Show Info",value:0},{name:"Visualize outside 0-1 index",value:1},{name:"Visualize outside 0-1",value:"Anim"},{name:"Alpha index",value:0},{name:"Alpha",value:"A"},{name:"Show Color",value:0},{name:"X",value:.5},{name:"Y",value:.5}],portsOut:[{name:"Info",value:""}],objName:"Ops.Ui.VizTexture"},{id:"o80c8iva8",uiAttribs:{},portsIn:[{name:"Speed",value:1},{name:"Play",value:1},{name:"Sync to timeline",value:0}],portsOut:[{name:"Time",links:[{portIn:"Time",portOut:"Time",objIn:"qucydf7c1",objOut:"o80c8iva8"},{portIn:"Time",portOut:"Time",objIn:"u47x2ktcp",objOut:"o80c8iva8"}]}],objName:"Ops.Anim.Timer_v2"},{id:"b0bogmu5t",uiAttribs:{},portsOut:[{name:"CSS Width",value:1933},{name:"CSS Height",value:761},{name:"Pixel Ratio",value:1},{name:"Pixel Width",links:[{portIn:"number1",portOut:"Pixel Width",objIn:"twza7la1k",objOut:"b0bogmu5t"}]},{name:"Pixel Height",links:[{portIn:"number1",portOut:"Pixel Height",objIn:"5ehdiczkp",objOut:"b0bogmu5t"}]},{name:"Aspect Ratio",value:2.540078843626807},{name:"Landscape",value:1}],objName:"Ops.Gl.CanvasInfo_v3"},{id:"twza7la1k",uiAttribs:{},portsIn:[{name:"number2",value:1}],portsOut:[{name:"result",links:[{portIn:"Width",portOut:"result",objIn:"w6i0p89a1",objOut:"twza7la1k"}]}],objName:"Ops.Math.Divide"},{id:"5ehdiczkp",uiAttribs:{},portsIn:[{name:"number2",value:1}],portsOut:[{name:"result",links:[{portIn:"Height",portOut:"result",objIn:"w6i0p89a1",objOut:"5ehdiczkp"}]}],objName:"Ops.Math.Divide"},{id:"ek3gcor4t",uiAttribs:{},portsIn:[{name:"Blend Mode index",value:0},{name:"Blend Mode",value:"normal"},{name:"Amount",value:1},{name:"threshold",value:.35},{name:"strength",value:2},{name:"Mask Src index",value:0},{name:"Mask Src",value:"R"}],portsOut:[{name:"Trigger",links:[{portIn:"render",portOut:"Trigger",objIn:"u47x2ktcp",objOut:"ek3gcor4t"}]}],objName:"Ops.Gl.ImageCompose.Dither_v2"},{id:"gu49yw83j",uiAttribs:{},portsIn:[{name:"blendMode index",value:3},{name:"blendMode",value:"multiply"},{name:"Premultiplied",value:0},{name:"Alpha Mask",value:0},{name:"removeAlphaSrc",value:0},{name:"Mask Src index",value:1},{name:"Mask Src",value:"luminance"},{name:"Invert alpha channel",value:0},{name:"Aspect Ratio",value:0},{name:"Stretch Axis index",value:0},{name:"Stretch Axis",value:"X"},{name:"Position",value:0},{name:"Crop",value:0},{name:"flip x",value:0},{name:"flip y",value:0},{name:"Transform",value:0},{name:"Scale X",value:1},{name:"Scale Y",value:1},{name:"Position X",value:0},{name:"Position Y",value:0},{name:"Rotation",value:0},{name:"Clip Repeat",value:0}],objName:"Ops.Gl.ImageCompose.DrawImage_v3"},{id:"hf7rthxr6",uiAttribs:{},portsIn:[{name:"Coordinates index",value:0},{name:"Coordinates",value:"-1 to 1"},{name:"Area index",value:0},{name:"Area",value:"Canvas Area"},{name:"flip y",value:1},{name:"right click prevent default",value:1},{name:"Events index",value:0},{name:"Events",value:"Pointer"},{name:"Passive Events",value:0},{name:"Active",value:1}],portsOut:[{name:"x",value:-.8644593895499224},{name:"y",value:.6320630749014455},{name:"Button is down",links:[{portIn:"Value",portOut:"Button is down",objIn:"uarrtd7nm",objOut:"hf7rthxr6"}]},{name:"Mouse is hovering",value:1},{name:"Movement X",value:0},{name:"Movement Y",value:1}],objName:"Ops.Devices.Mouse.Mouse_v4"},{id:"uarrtd7nm",uiAttribs:{},portsIn:[{name:"Separate inc/dec",value:0},{name:"Inc factor",value:1.3666666666666667,useVariable:"baseSmooth",title:"Inc/Dec factor"},{name:"Dec factor",value:4}],portsOut:[{name:"Result",links:[{portIn:"Number",portOut:"Result",objIn:"ywfuvec02",objOut:"uarrtd7nm"}]}],objName:"Ops.Anim.Smooth"},{id:"ywfuvec02",uiAttribs:{},portsOut:[{name:"Result",links:[{portIn:"Value",portOut:"Result",objIn:"l4zl6zfzv",objOut:"ywfuvec02"}]}],objName:"Ops.Ui.VizNumber"},{id:"l4zl6zfzv",uiAttribs:{},portsIn:[{name:"Variable",value:"darkmode"}],objName:"Ops.Vars.VarSetNumber_v2"},{id:"0hcz2boje",uiAttribs:{},portsIn:[{name:"Variable",value:"darkmode"}],portsOut:[{name:"Value",links:[{portIn:"Value",portOut:"Value",objIn:"rkkpjmiq5",objOut:"0hcz2boje"}]}],objName:"Ops.Vars.VarGetNumber_v2"},{id:"rkkpjmiq5",uiAttribs:{},portsOut:[{name:"Result",links:[{portIn:"Amount",portOut:"Result",objIn:"ubyoiou88",objOut:"rkkpjmiq5"},{portIn:"Amount",portOut:"Result",objIn:"u47x2ktcp",objOut:"rkkpjmiq5"}]}],objName:"Ops.Math.OneMinus"},{id:"7pchqjalb",uiAttribs:{},portsIn:[{name:"Variable",value:"darkmode"}],portsOut:[{name:"Value",links:[{portIn:"Value",portOut:"Value",objIn:"kdr8ff0i7",objOut:"7pchqjalb"},{portIn:"Rot Z",portOut:"Value",objIn:"6vl5wt27l",objOut:"7pchqjalb"}]}],objName:"Ops.Vars.VarGetNumber_v2"},{id:"kdr8ff0i7",uiAttribs:{},portsOut:[{name:"Result",links:[{portIn:"Amount",portOut:"Result",objIn:"6vl5wt27l",objOut:"kdr8ff0i7"}]}],objName:"Ops.Math.OneMinus"},{id:"usbfvd5mv",uiAttribs:{},portsIn:[{name:"Variable",value:"darkmode"}],portsOut:[{name:"Value",links:[{portIn:"value",portOut:"Value",objIn:"4t2n7bhn7",objOut:"usbfvd5mv"}]}],objName:"Ops.Vars.VarGetNumber_v2"},{id:"4t2n7bhn7",uiAttribs:{},portsIn:[{name:"old min",value:0},{name:"old max",value:1},{name:"new min",value:.2},{name:"new max",value:1},{name:"Easing index",value:0},{name:"Easing",value:"Linear"},{name:"Clamp",value:1}],portsOut:[{name:"result",links:[{portIn:"R",portOut:"result",objIn:"ex1e5uu4e",objOut:"4t2n7bhn7"},{portIn:"B",portOut:"result",objIn:"ex1e5uu4e",objOut:"4t2n7bhn7"},{portIn:"G",portOut:"result",objIn:"ex1e5uu4e",objOut:"4t2n7bhn7"}]}],objName:"Ops.Math.MapRange"},{id:"u47x2ktcp",uiAttribs:{},portsIn:[{name:"Blend Mode index",value:0},{name:"Blend Mode",value:"normal"},{name:"Alpha Mask index",value:0},{name:"Alpha Mask",value:"Off"},{name:"Width",value:20},{name:"Height",value:20},{name:"Aspect",value:1},{name:"Mul",value:.36},{name:"X",value:0},{name:"Y",value:0},{name:"Greyscale",value:1},{name:"Offset Multiply",value:1},{name:"Offset X index",value:0},{name:"Offset X",value:"None"},{name:"Offset Y index",value:0},{name:"Offset Y",value:"None"},{name:"Offset Time index",value:1},{name:"Offset Time",value:"R"}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"ubyoiou88",objOut:"u47x2ktcp"}]}],objName:"Ops.Gl.ImageCompose.Plasma_v2"},{id:"ubyoiou88",uiAttribs:{},portsIn:[{name:"Blend Mode index",value:0},{name:"Blend Mode",value:"normal"},{name:"Method index",value:0},{name:"Method",value:"Luminance"},{name:"Min",value:0},{name:"Max",value:1},{name:"Position",value:.5}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"gu49yw83j",objOut:"ubyoiou88"}]}],objName:"Ops.Gl.ImageCompose.ColorMap_v2"},{id:"gc8aewsg9",uiAttribs:{},portsIn:[{name:"Gradient",value:'{"keys":[{"pos":0,"posy":0.57,"r":0.9109558783637153,"g":0.9866666666666667,"b":0.8468929036458333},{"pos":0.0068359375,"posy":0.57,"r":0.9109558783637153,"g":0.9866666666666667,"b":0.8468929036458333},{"pos":1,"posy":0.42,"r":0.74896240234375,"g":1,"b":0.9593558175223215},{"pos":1,"posy":0.42,"r":0.74896240234375,"g":1,"b":0.9593558175223215}]}'},{name:"Direction index",value:0},{name:"Direction",value:"X"},{name:"Smoothstep",value:1},{name:"Step",value:0},{name:"Flip",value:0},{name:"sRGB",value:0},{name:"Oklab",value:0},{name:"Size",value:128},{name:"filter index",value:1},{name:"filter",value:"linear"},{name:"wrap index",value:1},{name:"wrap",value:"repeat"},{name:"Dither",value:0},{name:"Gradient Array",value:0}],portsOut:[{name:"Texture",links:[{portIn:"Gradient",portOut:"Texture",objIn:"ubyoiou88",objOut:"gc8aewsg9"}]}],objName:"Ops.Gl.GradientTexture"},{id:"vd275tofj",uiAttribs:{},portsIn:[{name:"Decimal Places",value:0}],portsOut:[{name:"result",links:[{portIn:"number1",portOut:"result",objIn:"cj5iytrto",objOut:"vd275tofj"}]}],objName:"Ops.Math.Round"},{id:"cj5iytrto",uiAttribs:{},portsIn:[{name:"number2",value:2}],portsOut:[{name:"result",links:[{portIn:"Value",portOut:"result",objIn:"i3l0ebcmj",objOut:"cj5iytrto"}]}],objName:"Ops.Math.Multiply"},{id:"ws07ccks0",uiAttribs:{},portsIn:[{name:"number2",value:10}],portsOut:[{name:"result",links:[{portIn:"number",portOut:"result",objIn:"blbtffokp",objOut:"ws07ccks0"}]}],objName:"Ops.Math.Multiply"},{id:"blbtffokp",uiAttribs:{},portsIn:[{name:"Decimal Places",value:0}],portsOut:[{name:"result",links:[{portIn:"number1",portOut:"result",objIn:"yelzzguhv",objOut:"blbtffokp"}]}],objName:"Ops.Math.Round"},{id:"yelzzguhv",uiAttribs:{},portsIn:[{name:"number2",value:-2}],portsOut:[{name:"result",links:[{portIn:"Value",portOut:"result",objIn:"jzcmi4ajg",objOut:"yelzzguhv"}]}],objName:"Ops.Math.Multiply"},{id:"i3l0ebcmj",uiAttribs:{},portsIn:[{name:"Separate inc/dec",value:0},{name:"Inc factor",title:"Inc/Dec factor"},{name:"Dec factor",value:4}],portsOut:[{name:"Next",links:[{portIn:"Update",portOut:"Next",objIn:"jzcmi4ajg",objOut:"i3l0ebcmj"}]},{name:"Result",links:[{portIn:"val",portOut:"Result",objIn:"zikwoely8",objOut:"i3l0ebcmj"}]}],objName:"Ops.Anim.Smooth"},{id:"jzcmi4ajg",uiAttribs:{},portsIn:[{name:"Separate inc/dec",value:0},{name:"Inc factor",title:"Inc/Dec factor"},{name:"Dec factor",value:4}],portsOut:[{name:"Result",links:[{portIn:"val",portOut:"Result",objIn:"fqedjtmi0",objOut:"jzcmi4ajg"}]}],objName:"Ops.Anim.Smooth"},{id:"m7dfk5h9p",uiAttribs:{},portsIn:[{name:"Variable",value:"baseSmooth"}],portsOut:[{name:"Value",links:[{portIn:"Inc factor",portOut:"Value",objIn:"jzcmi4ajg",objOut:"m7dfk5h9p"},{portIn:"Inc factor",portOut:"Value",objIn:"i3l0ebcmj",objOut:"m7dfk5h9p"}]}],objName:"Ops.Vars.VarGetNumber_v2"},{id:"7sfozwdrr",uiAttribs:{},portsIn:[{name:"Variable",value:"mousex"}],portsOut:[{name:"Value",links:[{portIn:"number2",portOut:"Value",objIn:"m4pr2y4lv",objOut:"7sfozwdrr"}]}],objName:"Ops.Vars.VarGetNumber_v2"},{id:"oi58ev427",uiAttribs:{},portsIn:[{name:"Variable",value:"mousey"}],portsOut:[{name:"Value",links:[{portIn:"posY",portOut:"Value",objIn:"uuwi4ja48",objOut:"oi58ev427"}]}],objName:"Ops.Vars.VarGetNumber_v2"},{id:"yd9lvgh8w",uiAttribs:{},portsIn:[{name:"R",value:1},{name:"G",value:1},{name:"B",value:1},{name:"A",value:1},{name:"Enable",value:0},{name:"Albedo",value:.264},{name:"Roughness",value:.366},{name:"Active",value:1},{name:"Fresnel Intensity",value:1},{name:"Fresnel Width",value:17.98},{name:"Fresnel Exponent",value:9.61},{name:"Fresnel R",value:.20392156862745103},{name:"Fresnel G",value:.9469281855564492},{name:"Fresnel B",value:1},{name:"Emissive Active",value:0},{name:"Color Intensity",value:.3},{name:"Emissive R",value:.17554552554266523},{name:"Emissive G",value:.19076810864448357},{name:"Emissive B",value:.6484094451349655},{name:"Shininess",value:4.51},{name:"Specular Amount",value:.537},{name:"Specular Model index",value:0},{name:"Specular Model",value:"Blinn"},{name:"Energy Conservation",value:1},{name:"Double Sided Material",value:0},{name:"Falloff Mode index",value:0},{name:"Falloff Mode",value:"A"},{name:"Colorize Texture",value:0},{name:"Diffuse Repeat X",value:-4.39},{name:"Diffuse Repeat Y",value:1},{name:"Texture Offset X",value:0},{name:"Texture Offset Y",value:0},{name:"Specular Intensity",value:1},{name:"Normal Map Intensity",value:.5},{name:"AO Intensity",value:1},{name:"AO UV Channel index",value:0},{name:"AO UV Channel",value:1},{name:"Emissive Intensity",value:1},{name:"Emissive Mask Intensity",value:1},{name:"Env Map Intensity",value:1},{name:"Env Map Blend index",value:0},{name:"Env Map Blend",value:"Add"},{name:"Env Mask Intensity",value:1},{name:"Alpha Mask Source index",value:0},{name:"Alpha Mask Source",value:"Luminance"},{name:"Discard Transparent Pixels",value:0}],portsOut:[{name:"Trigger Out",links:[{portIn:"Trigger In",portOut:"Trigger Out",objIn:"62kbm7ctj",objOut:"yd9lvgh8w"}]}],objName:"Ops.Gl.Phong.PhongMaterial_v6"},{id:"dn82usydr",uiAttribs:{},portsIn:[{name:"Cast Light",value:0},{name:"Intensity",value:22},{name:"Radius",value:22.17},{name:"X",value:1},{name:"Y",value:3},{name:"Z",value:1},{name:"Point At X",value:0},{name:"Point At Y",value:0},{name:"Point At Z",value:0},{name:"R",value:1},{name:"G",value:1},{name:"B",value:1},{name:"Specular R",value:1},{name:"Specular G",value:1},{name:"Specular B",value:1},{name:"Cone Angle",value:140},{name:"Inner Cone Angle",value:60},{name:"Spot Exponent",value:.97},{name:"Falloff",value:.776},{name:"Cast Shadow",value:0},{name:"Rendering Active",value:1},{name:"Map Size index",value:1},{name:"Map Size",value:512},{name:"Shadow Strength",value:.99},{name:"Near",value:.1},{name:"Far",value:30},{name:"Bias",value:1e-4},{name:"Polygon Offset",value:0},{name:"Normal Offset",value:0},{name:"Blur Amount",value:0},{name:"Enable Advanced",value:0},{name:"MSAA index",value:0},{name:"MSAA",value:"none"},{name:"Texture Filter index",value:0},{name:"Texture Filter",value:"Linear"},{name:"Anisotropic index",value:0},{name:"Anisotropic",value:"0"}],portsOut:[{name:"Trigger Out",links:[{portIn:"Trigger In",portOut:"Trigger Out",objIn:"yd9lvgh8w",objOut:"dn82usydr"}]},{name:"World Position X",value:1.2999999523162842},{name:"World Position Y",value:3.8999998569488525},{name:"World Position Z",value:1.2999999523162842}],objName:"Ops.Gl.Phong.SpotLight_v5"},{id:"seqh507em",uiAttribs:{},portsIn:[{name:"key code",value:82},{name:"canvas only",value:1},{name:"Mod Key index",value:0},{name:"Mod Key",value:"none"},{name:"Enabled",value:1},{name:"Prevent Default",value:0}],portsOut:[{name:"on press",links:[{portIn:"Reset",portOut:"on press",objIn:"v46ykonef",objOut:"seqh507em"}]},{name:"Pressed",value:0},{name:"Key",value:"R"}],objName:"Ops.Devices.Keyboard.KeyPressLearn"},{id:"wghnm1gib",uiAttribs:{},portsIn:[{name:"radius",value:.5},{name:"stacks",value:32},{name:"slices",value:32},{name:"Filloffset",value:1},{name:"Render",value:1}],objName:"Ops.Graphics.Meshes.Sphere_v3"},{id:"lwqga9d1b",uiAttribs:{},portsIn:[{name:"scale",value:1.42},{name:"x",value:.32},{name:"y",value:.18},{name:"z",value:.16}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"wghnm1gib",objOut:"lwqga9d1b"}]}],objName:"Ops.Gl.Matrix.Scale"},{id:"b7apu9im7",uiAttribs:{},portsIn:[{name:"posX",value:-.02},{name:"posY",value:-.93},{name:"posZ",value:0},{name:"scale",value:1},{name:"rotX",value:0},{name:"rotY",value:0},{name:"rotZ",value:0}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"lwqga9d1b",objOut:"b7apu9im7"}]}],objName:"Ops.Graphics.Transform"},{id:"wzg28yy61",uiAttribs:{},portsIn:[{name:"Title",value:"Render body"}],objName:"Ops.Ui.Area"},{id:"ufput3567",uiAttribs:{},portsIn:[{name:"Title",value:"Eye movements"}],objName:"Ops.Ui.Area"},{id:"14qwpqmzg",uiAttribs:{},portsIn:[{name:"Title",value:"Render face"}],objName:"Ops.Ui.Area"},{id:"8j7powt0k",uiAttribs:{},portsIn:[{name:"Title",value:"Blur mask"}],objName:"Ops.Ui.Area"},{id:"pwv34jnbd",uiAttribs:{},portsIn:[{name:"Title",value:"Mouse movement"}],objName:"Ops.Ui.Area"},{id:"9rz8blx6p",uiAttribs:{},portsIn:[{name:"Title",value:"Post processing"}],objName:"Ops.Ui.Area"},{id:"xyuagn46d",uiAttribs:{},portsIn:[{name:"Speed",value:1},{name:"Play",value:1},{name:"Sync to timeline",value:0}],portsOut:[{name:"Time",links:[{portIn:"Time",portOut:"Time",objIn:"4m22av8e6",objOut:"xyuagn46d"}]}],objName:"Ops.Anim.Timer_v2"},{id:"4m22av8e6",uiAttribs:{},portsIn:[{name:"Frequency",value:.5},{name:"Type index",value:0},{name:"Type",value:"sine"},{name:"Phase",value:0},{name:"Range Min",value:.48},{name:"Range Max",value:.53}],portsOut:[{name:"Result",links:[{portIn:"value",portOut:"Result",objIn:"2976legsg",objOut:"4m22av8e6"}]}],objName:"Ops.Anim.LFO_v3"},{id:"fqedjtmi0",uiAttribs:{},portsIn:[{name:"min",value:-20},{name:"max",value:20},{name:"ignore outside values",value:0}],portsOut:[{name:"result",links:[{portIn:"rotX",portOut:"result",objIn:"20gq79ste",objOut:"fqedjtmi0"}]}],objName:"Ops.Math.Clamp"},{id:"zikwoely8",uiAttribs:{},portsIn:[{name:"min",value:-20},{name:"max",value:20},{name:"ignore outside values",value:0}],portsOut:[{name:"result",links:[{portIn:"rotY",portOut:"result",objIn:"20gq79ste",objOut:"zikwoely8"}]}],objName:"Ops.Math.Clamp"},{id:"vj82nituv",uiAttribs:{},portsIn:[{name:"min",value:30},{name:"max",value:9999},{name:"ignore outside values",value:0}],portsOut:[{name:"result",links:[{portIn:"number1",portOut:"result",objIn:"028vx1zi3",objOut:"vj82nituv"}]}],objName:"Ops.Math.Clamp"},{id:"6xtxncxmr",uiAttribs:{},portsIn:[{name:"ignore outside values",value:0}],portsOut:[{name:"result",links:[{portIn:"Value",portOut:"result",objIn:"17tt1y5td",objOut:"6xtxncxmr"}]}],objName:"Ops.Math.Clamp"},{id:"msl6lzddd",uiAttribs:{},portsIn:[{name:"ignore outside values",value:0}],portsOut:[{name:"result",links:[{portIn:"Value",portOut:"result",objIn:"htxpcnnh7",objOut:"msl6lzddd"}]}],objName:"Ops.Math.Clamp"},{id:"odzxwy82w",uiAttribs:{},portsIn:[{name:"File",value:"assets/P7150897.png",display:"file"},{name:"Filter index",value:2},{name:"Filter",value:"mipmap"},{name:"Wrap index",value:0},{name:"Wrap",value:"repeat"},{name:"Anisotropic index",value:0},{name:"Anisotropic",value:"0"},{name:"Data Format index",value:3},{name:"Data Format",value:"RGBA"},{name:"Flip",value:0},{name:"Pre Multiplied Alpha",value:0},{name:"Active",value:1},{name:"Save Memory",value:1},{name:"Add Cachebuster",value:0}],portsOut:[{name:"Width",value:5184},{name:"Height",value:3888},{name:"Aspect Ratio",value:1.3333333333333333},{name:"Loaded",value:1},{name:"Loading",value:0}],objName:"Ops.Gl.Texture_v2"},{id:"mgd6z52wa",uiAttribs:{},portsIn:[{name:"Key",value:""}],portsOut:[{name:"Result",links:[{portIn:"amount",portOut:"Result",objIn:"gu49yw83j",objOut:"mgd6z52wa"}]},{name:"Found",value:0}],objName:"Ops.Json.ObjectGetNumber_v2"},{id:"qnm22pvvi",uiAttribs:{},portsIn:[{name:"File",value:"assets/P7150897.png",display:"file"},{name:"Filter index",value:2},{name:"Filter",value:"mipmap"},{name:"Wrap index",value:0},{name:"Wrap",value:"repeat"},{name:"Anisotropic index",value:0},{name:"Anisotropic",value:"0"},{name:"Data Format index",value:3},{name:"Data Format",value:"RGBA"},{name:"Flip",value:0},{name:"Pre Multiplied Alpha",value:0},{name:"Active",value:1},{name:"Save Memory",value:1},{name:"Add Cachebuster",value:0}],portsOut:[{name:"Texture",links:[{portIn:"Image",portOut:"Texture",objIn:"ldcwmakfd",objOut:"qnm22pvvi"}]},{name:"Width",value:5184},{name:"Height",value:3888},{name:"Aspect Ratio",value:1.3333333333333333},{name:"Loaded",value:1},{name:"Loading",value:0}],objName:"Ops.Gl.Texture_v2"},{id:"ldcwmakfd",uiAttribs:{},portsIn:[{name:"blendMode index",value:1},{name:"blendMode",value:"lighten"},{name:"amount",value:1},{name:"Premultiplied",value:0},{name:"Alpha Mask",value:0},{name:"removeAlphaSrc",value:0},{name:"Mask Src index",value:1},{name:"Mask Src",value:"luminance"},{name:"Invert alpha channel",value:0},{name:"Aspect Ratio",value:0},{name:"Stretch Axis index",value:0},{name:"Stretch Axis",value:"X"},{name:"Position",value:0},{name:"Crop",value:0},{name:"flip x",value:0},{name:"flip y",value:0},{name:"Transform",value:0},{name:"Scale X",value:1},{name:"Scale Y",value:1},{name:"Position X",value:0},{name:"Position Y",value:0},{name:"Rotation",value:0},{name:"Clip Repeat",value:0}],objName:"Ops.Gl.ImageCompose.DrawImage_v3"},{id:"31ueshxcw",uiAttribs:{},portsIn:[{name:"Size index",value:0},{name:"Size",value:"Auto"},{name:"Width",value:640},{name:"Height",value:480},{name:"Filter index",value:1},{name:"Filter",value:"linear"},{name:"Wrap index",value:1},{name:"Wrap",value:"repeat"},{name:"Anisotropic index",value:0},{name:"Anisotropic",value:"0"},{name:"Pixel Format index",value:4},{name:"Pixel Format",value:"RGBA 8bit ubyte"},{name:"Clear",value:1},{name:"R",value:0},{name:"G",value:0},{name:"B",value:0},{name:"A",value:0}],portsOut:[{name:"texture_out",links:[{portIn:"Texture",portOut:"texture_out",objIn:"ohpoy07w7",objOut:"31ueshxcw"}]},{name:"Aspect Ratio",value:1.2685589519650655},{name:"Texture Width",value:581},{name:"Texture Height",value:458}],objName:"Ops.Gl.ImageCompose.ImageCompose_v4"}],export:{time:"2025-11-06 14:40",service:"github",exportNumber:1}};if(!CABLES.exportedPatch){CABLES.exportedPatch=CABLES.exportedPatches["JdRYK1"]}"use strict";var CABLES=CABLES||{};CABLES.OPS=CABLES.OPS||{};var Ops=Ops||{};Ops.Gl=Ops.Gl||{};Ops.Ui=Ops.Ui||{};Ops.Anim=Ops.Anim||{};Ops.Json=Ops.Json||{};Ops.Math=Ops.Math||{};Ops.Vars=Ops.Vars||{};Ops.Patch=Ops.Patch||{};Ops.Cables=Ops.Cables||{};Ops.Number=Ops.Number||{};Ops.Devices=Ops.Devices||{};Ops.Trigger=Ops.Trigger||{};Ops.Gl.Phong=Ops.Gl.Phong||{};Ops.Graphics=Ops.Graphics||{};Ops.Gl.Matrix=Ops.Gl.Matrix||{};Ops.Gl.Meshes=Ops.Gl.Meshes||{};Ops.Gl.Shader=Ops.Gl.Shader||{};Ops.Ui.Routing=Ops.Ui.Routing||{};Ops.Gl.Textures=Ops.Gl.Textures||{};Ops.Devices.Mouse=Ops.Devices.Mouse||{};Ops.Patch.PJdRYK1=Ops.Patch.PJdRYK1||{};Ops.Gl.ImageCompose=Ops.Gl.ImageCompose||{};Ops.Graphics.Meshes=Ops.Graphics.Meshes||{};Ops.Devices.Keyboard=Ops.Devices.Keyboard||{};Ops.Gl.ShaderEffects=Ops.Gl.ShaderEffects||{};Ops.Gl.ImageCompose.Noise=Ops.Gl.ImageCompose.Noise||{};Ops.Gl.MainLoop_v2=class extends CABLES.Op{constructor(){super(...arguments);const i=this;const e=i.attachments={};const t=i.inFloat("Max Pixel Density (DPR)",2),s=i.inValue("FPS Limit",0),r=i.inValueBool("Reduce FPS unfocussed",false),n=i.inValueBool("Transparent",false),a=i.inValueBool("Active",1),o=i.inValueBool("Focus canvas",1),l=i.outTrigger("trigger"),h=i.outNumber("width"),u=i.outNumber("height"),c=i.outNumber("Pixel Density");i.onAnimFrame=I;t.onChange=A;const f=i.patch.cg=i.patch.cgl;let g=0;let d=0;let m=null;let p=false;if(!i.patch.cgl)i.uiAttr({error:"No webgl cgl context"});const _=vec3.create();vec3.set(_,0,0,0);const v=vec3.create();vec3.set(v,0,0,-2);let E=true;let b=null;let x=true;let T=true;window.addEventListener("blur",()=>{x=false});window.addEventListener("focus",()=>{x=true});document.addEventListener("visibilitychange",()=>{T=!document.hidden});O();i.patch.tempData.mainloopOp=this;function A(){M();if(CABLES.UI){if(t.get()<1)i.patch.cgl.canvas.style.imageRendering="pixelated"}i.patch.cgl.updateSize();if(CABLES.UI)gui.setLayout()}a.onChange=function(){i.patch.removeOnAnimFrame(i);if(a.get()){i.setUiAttrib({extendTitle:""});i.onAnimFrame=I;i.patch.addOnAnimFrame(i);i.log("adding again!")}else{i.setUiAttrib({extendTitle:"Inactive"})}};function S(){if(r.get()){if(!T)return 10;if(!x)return 30}return s.get()}i.onDelete=function(){f.gl.clearColor(0,0,0,0);f.gl.clear(f.gl.COLOR_BUFFER_BIT|f.gl.DEPTH_BUFFER_BIT)};function M(){if(t.get()!=0)i.patch.cgl.pixelDensity=Math.min(t.get(),window.devicePixelRatio);else i.patch.cgl.pixelDensity=window.devicePixelRatio}function I(e){if(!a.get())return;if(f.aborted||f.canvas.clientWidth===0||f.canvas.clientHeight===0)return;i.patch.cg=f;M();const t=performance.now();i.patch.config.fpsLimit=S();if(f.canvasWidth==-1){f.setCanvas(i.patch.config.glCanvasId);return}if(f.canvasWidth!=h.get()||f.canvasHeight!=u.get()){h.set(f.canvasWidth/1);u.set(f.canvasHeight/1)}if(CABLES.now()-d>1e3){CGL.fpsReport=CGL.fpsReport||[];if(i.patch.loading.getProgress()>=1&&d!==0)CGL.fpsReport.push(g);g=0;d=CABLES.now()}CGL.MESH.lastShader=null;CGL.MESH.lastMesh=null;f.renderStart(f,_,v);if(!n.get())f.gl.clearColor(0,0,0,1);else f.gl.clearColor(0,0,0,0);f.gl.clear(f.gl.COLOR_BUFFER_BIT|f.gl.DEPTH_BUFFER_BIT);l.trigger();if(CGL.MESH.lastMesh)CGL.MESH.lastMesh.unBind();if(CGL.Texture.previewTexture){if(!CGL.Texture.texturePreviewer)CGL.Texture.texturePreviewer=new CGL.Texture.texturePreview(f);CGL.Texture.texturePreviewer.render(CGL.Texture.previewTexture)}f.renderEnd(f);i.patch.cg=null;if(!n.get()){f.gl.clearColor(1,1,1,1);f.gl.colorMask(false,false,false,true);f.gl.clear(f.gl.COLOR_BUFFER_BIT);f.gl.colorMask(true,true,true,true)}if(!f.tempData.phong)f.tempData.phong={};g++;if(E){if(o.get())f.canvas.focus();E=false}c.set(i.patch.cgl.pixelDensity);i.patch.cgl.profileData.profileMainloopMs=performance.now()-t}function O(){clearTimeout(m);m=setTimeout(()=>{if(i.patch.getOpsByObjName(i.name).length>1){i.setUiError("multimainloop","there should only be one mainloop op!");if(!p)p=i.patch.addEventListener("onOpDelete",O)}else i.setUiError("multimainloop",null,1)},500)}}};CABLES.OPS["f1029550-d877-42da-9b1e-63a5163a0350"]={f:Ops.Gl.MainLoop_v2,objName:"Ops.Gl.MainLoop_v2"};Ops.Trigger.Sequence=class extends CABLES.Op{constructor(){super(...arguments);const n=this;const e=n.attachments={};const t=n.inTrigger("exe"),i=n.inTriggerButton("Clean up connections");n.setUiAttrib({resizable:true,resizableY:false,stretchPorts:true});const s=[],a=[],r=16;let o=null,l=[];t.onTriggered=c;i.onTriggered=f;i.setUiAttribs({hideParam:true,hidePort:true});for(let t=0;t<r;t++){const g=n.outTrigger("trigger "+t);a.push(g);g.onLinkChanged=u;if(t<r-1){let e=n.inTrigger("exe "+t);e.onTriggered=c;s.push(e)}}h();function h(){l.length=0;for(let e=0;e<a.length;e++)if(a[e].links.length>0)l.push(a[e])}function u(){h();clearTimeout(o);o=setTimeout(()=>{let t=false;for(let e=0;e<a.length;e++)if(a[e].links.length>1)t=true;i.setUiAttribs({hideParam:!t});if(n.isCurrentUiOp())n.refreshParams()},60)}function c(){for(let e=0;e<l.length;e++)l[e].trigger()}function f(){let s=0;for(let i=0;i<a.length;i++){let t=[];if(a[i].links.length>1)for(let e=1;e<a[i].links.length;e++){while(a[s].links.length>0)s++;t.push(a[i].links[e]);const r=a[i].links[e].getOtherPort(a[i]);n.patch.link(n,"trigger "+s,r.op,r.name);s++}for(let e=0;e<t.length;e++)t[e].remove()}u();h()}}};CABLES.OPS["a466bc1f-06e9-4595-8849-bffb9fe22f99"]={f:Ops.Trigger.Sequence,objName:"Ops.Trigger.Sequence"};Ops.Gl.RenderToTexture_v3=class extends CABLES.Op{constructor(){super(...arguments);const r=this;const e=r.attachments={};const t=r.inTrigger("render"),i=r.inSwitch("Size",["Canvas","Manual"],"Canvas"),s=r.inValueInt("texture width",512),n=r.inValueInt("texture height",512),a=r.inBool("Auto Aspect",true),o=r.inSwitch("filter",["nearest","linear","mipmap"],"linear"),l=r.inSwitch("Wrap",["Clamp","Repeat","Mirror"],"Repeat"),h=r.inSwitch("MSAA",["none","2x","4x","8x"],"none"),u=r.outTrigger("trigger"),c=r.outTexture("texture"),f=r.outTexture("textureDepth"),g=r.inDropDown("Pixel Format",CGL.Texture.PIXELFORMATS,CGL.Texture.PFORMATSTR_RGBA8UB),d=r.inValueBool("Depth",true),m=r.inValueBool("Clear",true);const p=r.patch.cgl;let _=null;let v=true;r.setPortGroup("Size",[i,s,n,a]);g.onChange=d.onChange=m.onChange=o.onChange=l.onChange=h.onChange=b;i.onChange=E;t.onTriggered=r.preRender=x;E();function E(){s.setUiAttribs({greyout:i.get()!="Manual"});n.setUiAttribs({greyout:i.get()!="Manual"});a.setUiAttribs({greyout:i.get()!="Manual"})}function b(){v=true}function x(){CGL.TextureEffect.checkOpNotInTextureEffect(r);if(!_||v){if(_)_.delete();let i=CGL.Texture.WRAP_REPEAT;if(l.get()=="Clamp")i=CGL.Texture.WRAP_CLAMP_TO_EDGE;else if(l.get()=="Mirror")i=CGL.Texture.WRAP_MIRRORED_REPEAT;let s=CGL.Texture.FILTER_NEAREST;if(o.get()=="nearest")s=CGL.Texture.FILTER_NEAREST;else if(o.get()=="linear")s=CGL.Texture.FILTER_LINEAR;else if(o.get()=="mipmap")s=CGL.Texture.FILTER_MIPMAP;if(g.get().indexOf("loat")>-1&&o.get()=="mipmap")r.setUiError("fpmipmap","Can't use mipmap and float texture at the same time");else r.setUiError("fpmipmap",null);if(p.glVersion>=2){let e=true;let t=4;if(h.get()=="none"){t=0;e=false}if(h.get()=="2x")t=2;if(h.get()=="4x")t=4;if(h.get()=="8x")t=8;_=new CGL.Framebuffer2(p,8,8,{name:"render2texture "+r.id,pixelFormat:g.get(),multisampling:e,multisamplingSamples:t,wrap:i,filter:s,depth:d.get(),clear:m.get()})}else{_=new CGL.Framebuffer(p,8,8,{isFloatingPointTexture:false,clear:m.get()})}if(_&&_.valid){f.setRef(_.getTextureDepth());v=false}else{_=null;v=true}}let e=a.get();if(i.get()=="Canvas"){e=true;s.set(r.patch.cgl.checkTextureSize(p.canvasWidth));n.set(r.patch.cgl.checkTextureSize(p.canvasHeight))}if(_.getWidth()!=r.patch.cgl.checkTextureSize(s.get())||_.getHeight()!=r.patch.cgl.checkTextureSize(n.get())){_.setSize(r.patch.cgl.checkTextureSize(s.get()),r.patch.cgl.checkTextureSize(n.get()))}_.renderStart(p);p.pushViewPort(0,0,s.get(),n.get());if(e)mat4.perspective(p.pMatrix,45,s.get()/n.get(),.1,1e3);u.trigger();_.renderEnd(p);p.popViewPort();f.setRef(_.getTextureDepth());c.setRef(_.getTextureColor())}}};CABLES.OPS["41eec5c7-c480-477a-be81-04c3efac8357"]={f:Ops.Gl.RenderToTexture_v3,objName:"Ops.Gl.RenderToTexture_v3"};Ops.Gl.Meshes.FullscreenRectangle_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={shader_frag:"UNI sampler2D tex;\nIN vec2 texCoord;\n\nvoid main()\n{\n    outColor= texture(tex,texCoord);\n}\n\n",shader_vert:"{{MODULES_HEAD}}\n\nIN vec3 vPosition;\nUNI mat4 projMatrix;\nUNI mat4 mvMatrix;\n\nOUT vec2 texCoord;\nIN vec2 attrTexCoord;\n\nvoid main()\n{\n   vec4 pos=vec4(vPosition,  1.0);\n\n   texCoord=vec2(attrTexCoord.x,(1.0-attrTexCoord.y));\n\n   gl_Position = projMatrix * mvMatrix * pos;\n}\n"};const i=e.inTrigger("render"),s=e.inSwitch("Scale",["Stretch","Fit"],"Fit"),r=e.inValueBool("Flip Y"),n=e.inValueBool("Flip X"),a=e.inTexture("Texture"),o=e.outTrigger("trigger");const l=e.patch.cgl;let h=null;let u=new CGL.Geometry("fullscreen rectangle");let c=0,f=0,g=0,d=0;e.toWorkShouldNotBeChild("Ops.Gl.TextureEffects.ImageCompose",CABLES.OP_PORT_TYPE_FUNCTION);e.toWorkPortsNeedToBeLinked(i);n.onChange=A;r.onChange=A;i.onTriggered=T;a.onLinkChanged=E;s.onChange=x;const m=new CGL.Shader(l,"fullscreenrectangle",this);m.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_BEGIN_FRAG"]);m.setSource(t.shader_vert,t.shader_frag);m.fullscreenRectUniform=new CGL.Uniform(m,"t","tex",0);m.aspectUni=new CGL.Uniform(m,"f","aspectTex",0);let p=false;let _=true;let v=false;E();x();a.onChange=function(){_=true};function E(){if(!CABLES.UI)return;r.setUiAttribs({greyout:!a.isLinked()});n.setUiAttribs({greyout:!a.isLinked()});s.setUiAttribs({greyout:!a.isLinked()})}function b(){let e=a.get();if(e)p=true;else p=false}e.preRender=function(){b();m.bind();if(h)h.render(m);T()};function x(){v=s.get()=="Fit"}function T(){if(l.viewPort[2]!=g||l.viewPort[3]!=d||!h)S();if(_)b();l.pushPMatrix();mat4.identity(l.pMatrix);mat4.ortho(l.pMatrix,0,g,d,0,-10,1e3);l.pushModelMatrix();mat4.identity(l.mMatrix);l.pushViewMatrix();mat4.identity(l.vMatrix);if(v&&a.get()){const i=a.get().width/a.get().height;let e=d;let t=d*i;if(t>g){e=g*1/i;t=g}l.pushViewPort((g-t)/2,(d-e)/2,t,e)}if(p){if(a.get())l.setTexture(0,a.get().tex);h.render(m)}else{h.render(l.getShader())}l.gl.clear(l.gl.DEPTH_BUFFER_BIT);l.popPMatrix();l.popModelMatrix();l.popViewMatrix();if(v&&a.get())l.popViewPort();o.trigger()}function A(){h=null}function S(){if(l.viewPort[2]==g&&l.viewPort[3]==d&&h)return;let e=0,t=0;g=l.viewPort[2];d=l.viewPort[3];u.vertices=new Float32Array([e+g,t+d,0,e,t+d,0,e+g,t,0,e,t,0]);let i=null;if(r.get())i=new Float32Array([1,0,0,0,1,1,0,1]);else i=new Float32Array([1,1,0,1,1,0,0,0]);if(n.get()){i[0]=0;i[2]=1;i[4]=0;i[6]=1}u.setTexCoords(i);u.verticesIndices=new Uint16Array([2,1,0,3,1,2]);u.vertexNormals=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1]);u.tangents=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0]);u.biTangents==new Float32Array([0,-1,0,0,-1,0,0,-1,0,0,-1,0]);if(!h)h=new CGL.Mesh(l,u);else h.setGeom(u)}}};CABLES.OPS["fb70721a-eac2-4ff5-a5a2-5c59e2393972"]={f:Ops.Gl.Meshes.FullscreenRectangle_v2,objName:"Ops.Gl.Meshes.FullscreenRectangle_v2"};Ops.Gl.ImageCompose.ImageCompose_v4=class extends CABLES.Op{constructor(){super(...arguments);const i=this;const e=i.attachments={imgcomp_frag:"IN vec2 texCoord;\nUNI vec4 bgColor;\nUNI sampler2D tex;\n#ifdef USE_UVTEX\nUNI sampler2D UVTex;\n#endif\n\nvoid main()\n{\n\n    #ifndef USE_TEX\n        outColor=bgColor;\n    #endif\n    #ifdef USE_TEX\n        #ifndef USE_UVTEX\n        outColor=texture(tex,texCoord);\n        #else\n        outColor=texture(tex,texture(UVTex,texCoord).xy);\n        #endif\n    #endif\n\n\n\n}\n"};const t=i.patch.cgl,s=i.inTrigger("Render"),r=i.inTexture("Base Texture"),n=i.inTexture("UV Texture"),a=i.inSwitch("Size",["Auto","Canvas","Manual"],"Auto"),o=i.inValueInt("Width",640),l=i.inValueInt("Height",480),h=i.inSwitch("Filter",["nearest","linear","mipmap"],"linear"),u=i.inValueSelect("Wrap",["clamp to edge","repeat","mirrored repeat"],"repeat"),c=i.inSwitch("Anisotropic",["0","1","2","4","8","16"],"0"),f=i.inDropDown("Pixel Format",CGL.Texture.PIXELFORMATS,CGL.Texture.PFORMATSTR_RGBA8UB),g=i.inBool("Clear",true),d=i.inValueSlider("R",0),m=i.inValueSlider("G",0),p=i.inValueSlider("B",0),_=i.inValueSlider("A",0),v=i.outTrigger("Next"),E=i.outTexture("texture_out",CGL.Texture.getEmptyTexture(t)),b=i.outNumber("Aspect Ratio"),y=i.outNumber("Texture Width"),U=i.outNumber("Texture Height");i.setPortGroup("Texture Size",[a,o,l]);i.setPortGroup("Texture Parameters",[u,c,h,f]);d.setUiAttribs({colorPick:true});i.setPortGroup("Color",[d,m,p,_,g]);i.toWorkPortsNeedToBeLinked(s);const w=[0,0,0,0];let x=null;let T=null;let A=true;let B=false;let S=null;let V=null;let k=null;let G=null;u.onChange=h.onChange=c.onChange=f.onChange=j;r.onLinkChanged=g.onChange=a.onChange=n.onChange=F;s.onTriggered=i.preRender=D;F();function M(){if(x)x.delete();if(T)T.delete();T=null;x=new CGL.TextureEffect(t,{isFloatingPointTexture:CGL.Texture.isPixelFormatFloat(f.get()),name:i.name});const e=Math.min(t.maxAnisotropic,parseFloat(c.get()));T=new CGL.Texture(t,{anisotropic:e,name:"image_compose_v2_"+i.id,pixelFormat:f.get(),filter:I(),wrap:O(),width:R(),height:C()});x.setSourceTexture(T);y.set(R());U.set(C());b.set(R()/C());E.setRef(CGL.Texture.getEmptyTexture(t));A=false;F()}function I(){if(h.get()=="nearest")return CGL.Texture.FILTER_NEAREST;else if(h.get()=="linear")return CGL.Texture.FILTER_LINEAR;else if(h.get()=="mipmap")return CGL.Texture.FILTER_MIPMAP}function O(){if(u.get()=="repeat")return CGL.Texture.WRAP_REPEAT;else if(u.get()=="mirrored repeat")return CGL.Texture.WRAP_MIRRORED_REPEAT;else if(u.get()=="clamp to edge")return CGL.Texture.WRAP_CLAMP_TO_EDGE}function R(){let e=0;if(r.get()&&a.get()=="Auto")e=r.get().width;else if(a.get()=="Auto"||a.get()=="Canvas")e=t.canvasWidth;else if(a.get()=="ViewPort")e=t.getViewPort()[2];else e=Math.ceil(o.get());return i.patch.cgl.checkTextureSize(e)}function C(){let e=0;if(r.get()&&a.get()=="Auto")e=r.get().height;else if(a.get()=="Auto"||a.get()=="Canvas")e=t.canvasHeight;else if(a.get()=="ViewPort")e=t.getViewPort()[3];else e=Math.ceil(l.get());return i.patch.cgl.checkTextureSize(e)}function j(){A=true}function H(){if((R()!=T.width||C()!=T.height||T.pixelFormat!=f.get()||T.filter!=I()||T.wrap!=O())&&(R()!==0&&C()!==0)){M();x.setSourceTexture(T);E.setRef(T);P();L()}}function P(){let e=null;if(a.get()=="Manual"){e=null}else if(a.get()=="Auto"){if(r.get())e="Input Texture";else e="Canvas Size";e+=": "+R()+" x "+C()}let t=false;t=a.uiAttribs.info!=e;a.setUiAttribs({info:e});if(t)i.refreshParams()}function N(){if(S)S.toggleDefine("USE_TEX",r.isLinked()||!g.get());if(S)S.toggleDefine("USE_UVTEX",n.isLinked())}function F(){c.setUiAttribs({greyout:I()!=CGL.Texture.FILTER_MIPMAP});d.setUiAttribs({greyout:r.isLinked()});p.setUiAttribs({greyout:r.isLinked()});m.setUiAttribs({greyout:r.isLinked()});_.setUiAttribs({greyout:r.isLinked()});g.setUiAttribs({greyout:r.isLinked()});o.setUiAttribs({greyout:a.get()!="Manual"});l.setUiAttribs({greyout:a.get()!="Manual"});if(T)if(CGL.Texture.isPixelFormatFloat(f.get())&&I()==CGL.Texture.FILTER_MIPMAP)i.setUiError("fpmipmap","Don't use mipmap and 32bit at the same time, many systems do not support this.");else i.setUiError("fpmipmap",null);P();N();L()}function L(){if(T)if(r.isLinked()&&r.get()&&T.isFloatingPoint()<r.get().isFloatingPoint())i.setUiError("textypediff","Warning: Mixing floating point and non floating point texture can result in data/precision loss",1);else i.setUiError("textypediff",null)}i.preRender=()=>{D()};function z(){if(!S){S=new CGL.Shader(t,"copytextureshader");S.setSource(S.getDefaultVertexShader(),e.imgcomp_frag);V=new CGL.Uniform(S,"t","tex",0);k=new CGL.Uniform(S,"t","UVTex",1);G=new CGL.Uniform(S,"4f","bgColor",d,m,p,_);N()}t.pushShader(S);t.currentTextureEffect.bind();if(r.get())t.setTexture(0,r.get().tex);else if(!g.get()&&E.get())t.setTexture(0,E.get().tex);if(n.get())t.setTexture(1,n.get().tex);t.currentTextureEffect.finish();t.popShader()}function D(){if(!x||A)M();t.pushBlend(false);H();const e=t.currentTextureEffect;t.currentTextureEffect=x;t.currentTextureEffect.imgCompVer=3;t.currentTextureEffect.width=o.get();t.currentTextureEffect.height=l.get();x.setSourceTexture(T);x.startEffect(r.get()||CGL.Texture.getEmptyTexture(t,B),true);z();v.trigger();t.pushViewPort(0,0,o.get(),l.get());x.endEffect();E.setRef(x.getCurrentSourceTexture());t.popViewPort();t.popBlend();t.currentTextureEffect=e}}};CABLES.OPS["17212e2b-d692-464c-8f8d-2d511dd3410a"]={f:Ops.Gl.ImageCompose.ImageCompose_v4,objName:"Ops.Gl.ImageCompose.ImageCompose_v4"};Ops.Graphics.Meshes.Sphere_v3=class extends CABLES.Op{constructor(){super(...arguments);const x=this;const e=x.attachments={};const T=Math.PI*2,t=x.inTrigger("render"),A=x.inValue("radius",.5),S=x.inValue("stacks",32),M=x.inValue("slices",32),I=x.inValueSlider("Filloffset",1),i=x.inValueBool("Render",true),s=x.outTrigger("trigger"),O=x.outObject("geometry",null,"geometry"),R=vec3.fromValues(0,1,0),C=vec3.fromValues(1,0,0);let r=null,P=new CGL.Geometry("Sphere"),N=vec3.create(),F=vec3.create(),L=true,D=0,y=true,n=vec3.create(),U=null;a();x.onDelete=function(){if(U)U.dispose()};t.onTriggered=function(){r=x.patch.cg||x.patch.cgl;if(L)o();if(y){r.pushModelMatrix();mat4.scale(r.mMatrix,r.mMatrix,n)}if(i.get())U.render(r.getShader());if(y){r.popModelMatrix()}s.trigger()};S.onChange=M.onChange=I.onChange=()=>{L=true};O.onLinkChanged=A.onChange=()=>{if(O.isLinked())y=false;else y=true;if(y)a();else L=true};function a(){if(y&&D!=1)L=true;vec3.set(n,A.get(),A.get(),A.get())}function o(){const e=Math.ceil(Math.max(S.get(),2)),t=Math.ceil(Math.max(M.get(),3)),i=Math.min(Math.max(I.get()*e,1),e);let s=A.get();if(y)s=1;D=s;let r=[],n=[],a=[],o=[],l=[],h=[],u,c,f,g,d,m,p,_,v,E,b;for(E=p=0;E<e+1;E++){v=(E/e-.5)*Math.PI;c=Math.sin(v);m=Math.cos(v);for(b=t;b>=0;b--){_=b/t*T;u=Math.cos(_)*m;f=Math.sin(_)*m;r.push(u*s,c*s,f*s);n.push(b/t,E/(e+1));g=Math.sqrt(u*u+c*c+f*f);a.push(N[0]=u/g,N[1]=c/g,N[2]=f/g);if(c==g)d=C;else d=R;vec3.cross(F,N,d);vec3.normalize(F,F);Array.prototype.push.apply(o,F);vec3.cross(F,F,N);Array.prototype.push.apply(l,F)}if(E==0||E>i)continue;for(b=0;b<t;b++,p++){h.push(p,p+1,p+t+1,p+1,p+t+2,p+t+1)}p++}P.clear();P.vertices=r;P.texCoords=n;P.vertexNormals=a;P.tangents=o;P.biTangents=l;P.verticesIndices=h;O.setRef(P);if(x.patch.cg)if(!U)U=x.patch.cg.createMesh(P,{opId:x.id});else U.setGeom(P);L=false}}};CABLES.OPS["6ee346d0-614e-4709-91a5-dc21ae975caf"]={f:Ops.Graphics.Meshes.Sphere_v3,objName:"Ops.Graphics.Meshes.Sphere_v3"};Ops.Gl.ShaderEffects.TextureProjection_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={maptexture_frag:"IN vec2 MOD_tc;\n\n#ifdef MOD_MAP_TRIPLANAR\n    IN vec2 MOD_tc1;\n    IN vec2 MOD_tc2;\n    IN vec3 MOD_blendingTri;\n#endif\n\n\n{{CGL.BLENDMODES3}}",maptexture_vert:"vec3 MOD_pos;\n\n#ifndef MOD_WORLDSPACE\n   MOD_pos=(vec4(vPosition,1.0)*1.0/MOD_scale).xyz;\n#endif\n#ifdef MOD_WORLDSPACE\n   MOD_pos=(mMatrix*pos).xyz*1.0/MOD_scale;\n#endif\n\nMOD_pos=(vec4(MOD_pos,1.0)*MOD_rotationX(MOD_rotX*MOD_DEG2RAD)).xyz;\nMOD_pos=(vec4(MOD_pos,1.0)*MOD_rotationY(MOD_rotY*MOD_DEG2RAD)).xyz;\nMOD_pos=(vec4(MOD_pos,1.0)*MOD_rotationZ(MOD_rotZ*MOD_DEG2RAD)).xyz;\n\n#ifdef MOD_MAP_XY\n    MOD_tc=MOD_pos.xy;\n#endif\n#ifdef MOD_MAP_XZ\n    MOD_tc=MOD_pos.xz;\n#endif\n#ifdef MOD_MAP_YZ\n    MOD_tc=MOD_pos.yz;\n#endif\n\nMOD_tc.xy+=vec2(0.5,0.5);\nMOD_tc.xy+=MOD_offset;\n\n\n#ifdef MOD_TARGET_POINTSIZE\n\n    gl_PointSize+=(texture(MOD_tex,MOD_tc).x*MOD_amount);\n\n#endif\n\n\n#ifdef MOD_MAP_TRIPLANAR\n    mapTriplanar((mMatrix*vec4(attrVertNormal,1.0)).xyz,MOD_pos);\n#endif\n\n",maptexture_body_frag:"#ifndef MOD_TARGET_POINTSIZE\n\n\n    vec4 MOD_color;\n\n    #ifdef MOD_MAP_TRIPLANAR\n        vec4 xaxis = texture( MOD_tex, MOD_tc);\n        vec4 yaxis = texture( MOD_tex, MOD_tc1);\n        vec4 zaxis = texture( MOD_tex, MOD_tc2);\n        MOD_color = xaxis *MOD_blendingTri.x + yaxis *MOD_blendingTri.y + zaxis *MOD_blendingTri.z;\n        MOD_color.a=1.0;\n    #endif\n\n\n    vec2 MOD_ntc=MOD_tc;\n\n    #ifdef MOD_MAP_SCREEN\n        MOD_ntc=(vec2(gl_FragCoord.x,gl_FragCoord.y)/vec2(MOD_viewPortW,MOD_viewPortH));\n\n        MOD_ntc-=vec2(0.5,0.5);\n        MOD_ntc*=1.0/MOD_scale;\n        MOD_ntc+=vec2(0.5,0.5);\n        MOD_ntc-=MOD_offset;\n    #endif\n\n    #ifdef MOD_MAP_TEXCOORD\n        MOD_ntc=texCoord*1.0/MOD_scale-MOD_offset;\n    #endif\n\n    #ifdef MOD_MAP_TEXCOORD1\n        MOD_ntc=texCoord1*1.0/MOD_scale-MOD_offset;\n    #endif\n\n    #ifdef MOD_MAP_TEXCOORD2\n        MOD_ntc=texCoord2*1.0/MOD_scale-MOD_offset;\n    #endif\n\n\n    #ifdef MOD_DISCARD\n    if(MOD_ntc.x>0.0 && MOD_ntc.x<1.0 && MOD_ntc.y>0.0 && MOD_ntc.y<1.0)\n    {\n    #endif\n\n        #ifndef MOD_MAP_TRIPLANAR\n            MOD_color=texture(MOD_tex,MOD_ntc);\n        #endif\n\n        #ifdef MOD_USE_IMGALPHA\n            col.a=MOD_color.a;\n        #endif\n\n        #ifdef MOD_TARGET_COLOR\n        col=cgl_blendPixel(col,MOD_color,MOD_amount*col.a);\n        #endif\n        #ifdef MOD_TARGET_ALPHA\n        col.a=1.0-MOD_color.r*MOD_amount;\n        #endif\n\n    #ifdef MOD_DISCARD\n    }\n\n    #endif\n#endif\n",maptexture_body_vert:"OUT vec2 MOD_tc;\n\nconst float MOD_DEG2RAD = 0.017453292519943;\n\n#ifdef MOD_MAP_TRIPLANAR\n\n    OUT vec2 MOD_tc1;\n    OUT vec2 MOD_tc2;\n    OUT vec3 MOD_blendingTri;\n\n    void mapTriplanar(vec3 wNorm,vec3 pos)\n    {\n        vec3 blending = abs( wNorm );\n        blending = normalize(max(blending, 0.1));\n        float b = (blending.x + blending.y + blending.z);\n        blending /= vec3(b);\n        MOD_blendingTri=blending;\n\n        MOD_tc = pos.yz;\n        MOD_tc1 = pos.xz;\n        MOD_tc2 = pos.xy;\n    }\n\n#endif\n\nmat4 MOD_rotationX( in float angle ) {\n\treturn mat4(\t1.0,\t\t0,\t\t\t0,\t\t\t0,\n\t\t\t \t\t0, \tcos(angle),\t-sin(angle),\t\t0,\n\t\t\t\t\t0, \tsin(angle),\t cos(angle),\t\t0,\n\t\t\t\t\t0, \t\t\t0,\t\t\t  0, \t\t1);\n}\n\nmat4 MOD_rotationY( in float angle ) {\n\treturn mat4(\tcos(angle),\t\t0,\t\tsin(angle),\t0,\n\t\t\t \t\t\t\t0,\t\t1.0,\t\t\t 0,\t0,\n\t\t\t\t\t-sin(angle),\t0,\t\tcos(angle),\t0,\n\t\t\t\t\t\t\t0, \t\t0,\t\t\t\t0,\t1);\n}\n\nmat4 MOD_rotationZ( in float angle ) {\n\treturn mat4(\tcos(angle),\t\t-sin(angle),\t0,\t0,\n\t\t\t \t\tsin(angle),\t\tcos(angle),\t\t0,\t0,\n\t\t\t\t\t\t\t0,\t\t\t\t0,\t\t1,\t0,\n\t\t\t\t\t\t\t0,\t\t\t\t0,\t\t0,\t1);\n}\n"};const i=e.inTrigger("render"),s=e.outTrigger("trigger"),r=e.inTexture("Texture"),n=CGL.TextureEffect.AddBlendSelect(e,"blendMode"),a=e.inValueSlider("Amount",.3),o=e.inSwitch("Target",["Color","Pointsize","Alpha"],"Color"),l=e.inValue("Scale",10),h=e.inBool("Use Texture Alpha",false),u=e.inFloat("Pos X",0),c=e.inFloat("Pos Y",0),f=e.inFloat("Rot X",0),g=e.inFloat("Rot Y",0),d=e.inFloat("Rot Z",0),m=e.inValueSelect("Mapping",["Triplanar","XY","XZ","YZ","Screen","TexCoords 1","TexCoords 2","TexCoords 3"],"XY"),p=e.inValueBool("Discard"),_=e.inValueBool("WorldSpace");const v=e.patch.cgl;i.onLinkChanged=h.onChange=o.onChange=n.onChange=p.onChange=_.onChange=r.onLinkChanged=m.onChange=A;e.toWorkPortsNeedToBeLinked(r,s);e.setPortGroup("Rotation",[f,g,d]);e.setPortGroup("Position",[u,c]);const E=new CGL.ShaderModifier(v,e.name,{opId:e.id});E.addModule({title:e.name,name:"MODULE_VERTEX_POSITION",srcHeadVert:t.maptexture_body_vert,srcBodyVert:t.maptexture_vert,attributes:[{type:"vec2",name:"attrTexCoord1",nameFrag:"texCoord1"},{type:"vec2",name:"attrTexCoord2",nameFrag:"texCoord2"}]});let b=t.maptexture_frag;E.addModule({title:e.name,name:"MODULE_COLOR",srcHeadFrag:b,srcBodyFrag:t.maptexture_body_frag});E.addUniformBoth("f","MOD_rotX",f);E.addUniformBoth("f","MOD_rotY",g);E.addUniformBoth("f","MOD_rotZ",d);E.addUniformBoth("t","MOD_tex");E.addUniformBoth("f","MOD_scale",l);E.addUniformBoth("f","MOD_amount",a);E.addUniformBoth("2f","MOD_offset",u,c);const x=E.addUniformFrag("f","MOD_viewPortW");const T=E.addUniformFrag("f","MOD_viewPortH");CGL.TextureEffect.setupBlending(e,E,n,a);A();function A(){E.toggleDefine("MOD_USE_IMGALPHA",h.get());E.toggleDefine("MOD_WORLDSPACE",_.get());E.toggleDefine("MOD_MAP_XY",m.get()=="XY");E.toggleDefine("MOD_MAP_XZ",m.get()=="XZ");E.toggleDefine("MOD_MAP_YZ",m.get()=="YZ");E.toggleDefine("MOD_MAP_TEXCOORD",m.get()=="TexCoords 1");E.toggleDefine("MOD_MAP_TEXCOORD1",m.get()=="TexCoords 2");E.toggleDefine("MOD_MAP_TEXCOORD2",m.get()=="TexCoords 3");E.toggleDefine("MOD_MAP_SCREEN",m.get()=="Screen");E.toggleDefine("MOD_MAP_TRIPLANAR",m.get()=="Triplanar");E.toggleDefine("MOD_DISCARD",p.get());E.toggleDefine("MOD_BLEND_NORMAL",n.get()=="Normal");E.toggleDefine("MOD_BLEND_ADD",n.get()=="Add");E.toggleDefine("MOD_BLEND_MUL",n.get()=="Mul");E.toggleDefine("MOD_BLEND_MUL",n.get()=="Mul");E.toggleDefine("MOD_TARGET_ALPHA",o.get()=="Alpha");E.toggleDefine("MOD_TARGET_COLOR",o.get()=="Color");E.toggleDefine("MOD_TARGET_POINTSIZE",o.get()=="Pointsize");if(o.get()=="Pointsize"&&m.get()=="Screen")e.setUiError("pointscreen","This combination of Mapping and Target is not possible",1);else e.setUiError("pointscreen",null);CGL.TextureEffect.setupBlending(e,E,n,a)}i.onTriggered=function(){const e=v.getViewPort();E.bind();E.setUniformValue("MOD_viewPortW",e[2]);E.setUniformValue("MOD_viewPortH",e[3]);let t=r.get();if(!t)t=CGL.Texture.getEmptyTexture(v).tex;else t=t.tex;E.pushTexture("MOD_tex",t);s.trigger();E.unbind()}}};CABLES.OPS["9be647c2-7afd-40ed-b669-9826ea6a50ca"]={f:Ops.Gl.ShaderEffects.TextureProjection_v2,objName:"Ops.Gl.ShaderEffects.TextureProjection_v2"};Ops.Gl.ShaderEffects.VertexWobble_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={sinewobble_vert:"\n#ifndef MOD_WORLDSPACE\n   vec4 MOD_vertPos=vec4(pos.xyz,1.0);\n#endif\n#ifdef MOD_WORLDSPACE\n   vec4 MOD_vertPos=mMatrix*pos;\n#endif\n\n#ifdef MOD_AREA_SPHERE\n    float MOD_de=distance(\n        MOD_posSize.xyz,\n        vec3(MOD_vertPos.x,MOD_vertPos.y,MOD_vertPos.z)\n        );\n#endif\n\n#ifdef MOD_AREA_BOX\n    float MOD_de=0.0;\n    if(abs(MOD_vertPos.y-MOD_posSize.y)>MOD_posSize.w ||\n        abs(MOD_vertPos.x-MOD_posSize.x)>MOD_posSize.w ||\n        abs(MOD_vertPos.z-MOD_posSize.z)>MOD_posSize.w ) MOD_de=1.0;\n#endif\n\n#ifdef MOD_AREA_AXIS_X\n    float MOD_de=abs(MOD_posSize.x-MOD_vertPos.x);\n#endif\n#ifdef MOD_AREA_AXIS_Y\n    float MOD_de=abs(MOD_posSize.y-MOD_vertPos.y);\n#endif\n#ifdef MOD_AREA_AXIS_Z\n    float MOD_de=abs(MOD_posSize.z-MOD_vertPos.z);\n#endif\n\n#ifdef MOD_AREA_AXIS_X_INFINITE\n    float MOD_de=MOD_posSize.x-MOD_vertPos.x;\n#endif\n#ifdef MOD_AREA_AXIS_Y_INFINITE\n    float MOD_de=MOD_posSize.y-MOD_vertPos.y;\n#endif\n#ifdef MOD_AREA_AXIS_Z_INFINITE\n    float MOD_de=MOD_posSize.z-MOD_vertPos.z;\n#endif\n\n#ifndef MOD_AREA_BOX\n    MOD_de=1.0-smoothstep(MOD_falloff,MOD_posSize.w,MOD_de);\n#endif\n\n#ifdef MOD_AREA_INVERT\n    MOD_de=1.0-MOD_de;\n#endif\n\nfloat MOD_v=0.0;\n\n#ifdef MOD_SRC_XZ\n   MOD_v=(MOD_vertPos.x+MOD_vertPos.z);\n#endif\n#ifdef MOD_SRC_XY\n   MOD_v=(MOD_vertPos.x+MOD_vertPos.y);\n#endif\n#ifdef MOD_SRC_X\n   MOD_v=MOD_vertPos.x;\n#endif\n#ifdef MOD_SRC_Y\n   MOD_v=MOD_vertPos.y;\n#endif\n#ifdef MOD_SRC_Z\n   MOD_v=MOD_vertPos.z;\n#endif\n\n#ifdef MOD_SRC_LENGTH\n  MOD_v=length(MOD_vertPos.xyz);\n#endif\n\n\nfloat MOD_amnt=MOD_amount*MOD_de;\n\nMOD_v=sin( (MOD_time)+( MOD_v*MOD_scale  ) ) ;\n#ifdef MOD_POSITIVE\n    MOD_v=(MOD_v+1.0)/2.0;\n#endif\nMOD_v*=MOD_amnt;\n\n\n\n\n#ifdef MOD_TO_AXIS_X\n   pos.x+=MOD_v;\n//   norm.x+=MOD_v;\n#endif\n\n#ifdef MOD_TO_AXIS_Y\n   pos.y+=MOD_v;\n//   norm.y+=MOD_v;\n#endif\n\n#ifdef MOD_TO_AXIS_Z\n   pos.z+=MOD_v;\n//   norm.z+=MOD_v;\n#endif\n\n// norm=normalize(norm);\n\n\n\n\n\n"};let i=this;const s=e.patch.cgl;const r=e.inTrigger("render");let n=e.inValueSelect("Source",["X * Z + Time","X * Y + Time","length","X + Time","Y + Time","Z + Time"],"X * Z + Time");const a=e.inValueSlider("amount",.1),o=e.inFloat("Time",0),l=e.inValueFloat("Scale",3),h=e.inValueBool("axisX",true),u=e.inValueBool("axisY",true),c=e.inValueBool("axisZ",true),f=e.inSwitch("Range",["-1 to 1","0 to 1"],"-1 to 1"),g=e.inValueSelect("Area",["Sphere","Box","Axis X","Axis Y","Axis Z","Axis X Infinite","Axis Y Infinite","Axis Z Infinite"],"Sphere"),d=e.inValue("Size",1),m=e.inValueSlider("Falloff",0),p=e.inValue("x"),_=e.inValue("y"),v=e.inValue("z"),E=e.inValueBool("WorldSpace",true),b=e.inValueBool("Invert"),x=this.outTrigger("trigger");e.setPortGroup("Area",[g,d,p,_,v,m,E,b]);f.onChange=g.onChange=E.onChange=d.onChange=n.onChange=c.onChange=h.onChange=u.onChange=S;const T="";const A=new CGL.ShaderModifier(s,e.name,{opId:e.id});A.addModule({title:e.name,name:"MODULE_VERTEX_POSITION",srcHeadVert:T,srcBodyVert:t.sinewobble_vert});A.addUniform("4f","MOD_posSize",p,_,v,d);A.addUniformVert("f","MOD_time",o);A.addUniformVert("f","MOD_amount",a);A.addUniformVert("f","MOD_scale",l);A.addUniformVert("f","MOD_falloff",m);S();function S(){A.toggleDefine("MOD_AREA_INVERT",b.get());A.toggleDefine("MOD_POSITIVE",f.get()=="0 to 1");A.toggleDefine("MOD_WORLDSPACE",E.get());A.toggleDefine("MOD_AREA_AXIS_X",g.get()=="Axis X");A.toggleDefine("MOD_AREA_AXIS_Y",g.get()=="Axis Y");A.toggleDefine("MOD_AREA_AXIS_Z",g.get()=="Axis Z");A.toggleDefine("MOD_AREA_AXIS_X_INFINITE",g.get()=="Axis X Infinite");A.toggleDefine("MOD_AREA_AXIS_Y_INFINITE",g.get()=="Axis Y Infinite");A.toggleDefine("MOD_AREA_AXIS_Z_INFINITE",g.get()=="Axis Z Infinite");A.toggleDefine("MOD_AREA_SPHERE",g.get()=="Sphere");A.toggleDefine("MOD_AREA_BOX",g.get()=="Box");A.toggleDefine("MOD_TO_AXIS_X",h.get());A.toggleDefine("MOD_TO_AXIS_Y",u.get());A.toggleDefine("MOD_TO_AXIS_Z",c.get());A.toggleDefine("MOD_SRC_XZ",!n.get()||n.get()=="X * Z + Time"||n.get()==="");A.toggleDefine("MOD_SRC_XY",n.get()=="X * Y + Time");A.toggleDefine("MOD_SRC_X",n.get()=="X + Time");A.toggleDefine("MOD_SRC_Y",n.get()=="Y + Time");A.toggleDefine("MOD_SRC_Z",n.get()=="Z + Time");A.toggleDefine("MOD_SRC_LENGTH",n.get()=="length")}r.onTriggered=function(){A.bind();x.trigger();A.unbind()}}};CABLES.OPS["76983d1c-be6d-453d-b34f-472efe8221e7"]={f:Ops.Gl.ShaderEffects.VertexWobble_v2,objName:"Ops.Gl.ShaderEffects.VertexWobble_v2"};Ops.Graphics.OrbitControls_v3=class extends CABLES.Op{constructor(){super(...arguments);const r=this;const U=r.attachments={};const w=r.inTrigger("render"),n=r.inValueFloat("min distance",1),a=r.inValueFloat("max distance",999999),o=r.inValue("min rot y",0),l=r.inValue("max rot y",0),t=r.inValue("initial radius",2),i=r.inValueSlider("initial axis y",.5),s=r.inValueSlider("initial axis x",.25),e=r.inValueSlider("Smoothness",1),B=r.inValue("Speed X",1),V=r.inValue("Speed Y",1),h=r.inValueBool("Active",true),k=r.inValueBool("Allow Panning",true),G=r.inValueBool("Allow Zooming",true),j=r.inValueBool("Allow Rotation",true),H=r.inValueBool("restricted",true),z=r.inBool("Identity",true),X=r.inTriggerButton("Reset"),Y=r.outTrigger("trigger"),W=r.outNumber("radius"),q=r.outNumber("Rot X"),K=r.outNumber("Rot Y");r.setPortGroup("Initial Values",[i,s,t]);r.setPortGroup("Interaction",[e,B,V]);r.setPortGroup("Boundaries",[o,l,n,a]);const Z=Math.PI;const u=Math.PI*2;const c=vec3.create(),f=vec3.create(),g=mat4.create(),Q=mat4.create(),d=vec3.create(),J=vec3.create(),m=vec3.create(),p=vec3.create(),_=vec3.create(),v=vec3.create();let E=vec3.create(),b=false,x=5,T=0,A=0,S=0,M=0,I=0,O=0,$=1,R=null,ee=true,te=[0,0,0,0,0,0],C=0;r.onDelete=y;e.onChange=se;t.onChange=X.onTriggered=ie;E=N(0);vec3.set(f,0,0,0);vec3.set(c,0,1,0);se();ie();function ie(){let e=0;if(I%u<-Z){e=-u;I%=-u}else if(I%u>Z){e=u;I%=u}else I%=u;O%=Math.PI;vec3.set(d,0,0,0);vec3.set(f,0,0,0);vec3.set(c,0,1,0);S=s.get()*Math.PI*2+e;M=i.get()-.5;x=t.get();E=N(M)}function se(){$=e.get()*10+1}function P(e,t){if(ee)return t;return e+(t-e)/$}w.onTriggered=function(){const e=r.patch.cg;if(!e)return;if(!R){ce(e.canvas);fe()}e.pushViewMatrix();I=P(I,S);O=P(O,M);let t=(O+.5)*180;if(o.get()!==0&&t<o.get()){t=o.get();O=C}else if(l.get()!==0&&t>l.get()){t=l.get();O=C}else{C=O}const i=I*CGL.RAD2DEG;K.set(t);q.set(i);re(E,O);vec3.add(m,E,d);vec3.add(_,f,d);p[0]=P(p[0],m[0]);p[1]=P(p[1],m[1]);p[2]=P(p[2],m[2]);v[0]=P(v[0],_[0]);v[1]=P(v[1],_[1]);v[2]=P(v[2],_[2]);const s=vec3.create();if(z.get())mat4.identity(e.vMatrix);mat4.lookAt(g,p,v,c);mat4.rotate(g,g,I,c);mat4.multiply(e.vMatrix,e.vMatrix,g);Y.trigger();e.popViewMatrix();ee=false};function re(e,t){if(x<n.get())x=n.get();if(x>a.get())x=a.get();W.set(x);let i=0,s=0;s=360*t/2*CGL.DEG2RAD;vec3.set(e,Math.cos(s)*x,Math.sin(s)*x,0);return e}function N(e){if(x<n.get())x=n.get();if(x>a.get())x=a.get();W.set(x);let t=0,i=0;const s=vec3.create();i=360*e/2*CGL.DEG2RAD;vec3.set(s,Math.cos(i)*x,Math.sin(i)*x,0);return s}function F(e){if(!b)return;const t=e.clientX;const i=e.clientY;let s=t-T;let r=i-A;s*=B.get();r*=V.get();if(e.buttons==2&&k.get()){d[2]+=s*.01;d[1]+=r*.01}else if(e.buttons==4&&G.get()){x+=r*.05;E=N(M)}else{if(j.get()){S+=s*.003;M+=r*.002;if(H.get()){if(M>.5)M=.5;if(M<-.5)M=-.5}}}T=t;A=i}function L(e){T=e.clientX;A=e.clientY;b=true;try{R.setPointerCapture(e.pointerId)}catch(e){}}function D(e){b=false;try{R.releasePointerCapture(e.pointerId)}catch(e){}}function ne(){const e=r.patch.cg.canvas;if(document.pointerLockElement===e||document.mozPointerLockElement===e||document.webkitPointerLockElement===e)document.addEventListener("mousemove",F,false)}function ae(e){}s.onChange=function(){I=S=s.get()*Math.PI*2};i.onChange=function(){O=M=i.get()-.5;E=N(M)};const oe=function(e){if(G.get()){const t=CGL.getWheelSpeed(e)*.06;x+=parseFloat(t)*1.2;E=N(M)}};const le=function(e){if(e.touches&&e.touches.length>0)L(e.touches[0])};const he=function(e){D()};const ue=function(e){if(e.touches&&e.touches.length>0)F(e.touches[0])};h.onChange=function(){if(h.get())fe();else y()};function ce(e){y();R=e;fe()}function fe(){if(!R)return;if(!h.get())return y();R.addEventListener("pointermove",F);R.addEventListener("pointerdown",L);R.addEventListener("pointerup",D);R.addEventListener("pointerleave",D);R.addEventListener("pointerenter",ae);R.addEventListener("contextmenu",function(e){e.preventDefault()});R.addEventListener("wheel",oe,{passive:true})}function y(){if(!R)return;R.removeEventListener("pointermove",F);R.removeEventListener("pointerdown",L);R.removeEventListener("pointerup",D);R.removeEventListener("pointerleave",D);R.removeEventListener("pointerenter",D);R.removeEventListener("wheel",oe)}}};CABLES.OPS["0655b098-d2a8-4ce2-a0b9-ecb2c78f873a"]={f:Ops.Graphics.OrbitControls_v3,objName:"Ops.Graphics.OrbitControls_v3"};Ops.Anim.Timer_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const n=e.inValue("Speed",1),i=e.inValueBool("Play",true),s=e.inTriggerButton("Reset"),r=e.inValueBool("Sync to timeline",false),a=e.outNumber("Time");e.setPortGroup("Controls",[i,s,n]);const o=new CABLES.Timer;let l=null;let h=0;let u=false;i.onChange=c;c();function c(){if(i.get()){o.play();e.patch.addOnAnimFrame(e)}else{o.pause();e.patch.removeOnAnimFrame(e)}}s.onTriggered=f;function f(){h=0;l=null;o.setTime(0);a.set(0)}r.onChange=function(){u=r.get();i.setUiAttribs({greyout:u});s.setUiAttribs({greyout:u})};e.onAnimFrame=function(e,t,i){if(o.isPlaying()){if(CABLES.overwriteTime!==undefined){a.set(CABLES.overwriteTime*n.get())}else if(u){a.set(e*n.get())}else{o.update();const s=o.get();if(l===null){l=s;return}const r=Math.abs(s-l);l=s;h+=r*n.get();if(h!=h)h=0;a.set(h)}}}}};CABLES.OPS["aac7f721-208f-411a-adb3-79adae2e471a"]={f:Ops.Anim.Timer_v2,objName:"Ops.Anim.Timer_v2"};Ops.Gl.GradientTexture=class extends CABLES.Op{constructor(){super(...arguments);const i=this;const e=i.attachments={};const O=i.inGradient("Gradient"),R=i.inValueSelect("Direction",["X","XX","Y","YY","XY","YX","Radial"],"X"),C=i.inValueBool("Smoothstep",false),P=i.inBool("Step",false),N=i.inBool("Flip",false),F=i.inBool("sRGB",false),L=i.inBool("Oklab",false),D=i.inValueInt("Size",256),y=i.inSwitch("filter",["nearest","linear","mipmap"],"linear"),U=i.inValueSelect("wrap",["clamp to edge","repeat","mirrored repeat"],"clamp to edge"),m=i.inFloatSlider("Dither",0),s=i.inArray("Gradient Array"),t=i.inTriggerButton("Randomize Colors"),w=i.outTexture("Texture"),B=i.outArray("Colors",null,3),V=i.outArray("Colors Pos",null,1);const k=i.patch.cgl;let r=null;O.setUiAttribs({editShortcut:true});const n=[221,125,40,94,163,50,214,174,69,229,135,79,25,92,217,129,103,155,16,237,168,75,212,126,203,157,104,223,50,96,115,189,0,104,199,16,185,242,83,26,123,95,191,175,247,159,32,170,0,88,203,133,106,46,227,14,35,246,66,20,240,205,36,159,74,252,148,231,132,117,6,145,254,39,222,5,111,46,67,197,228,116,181,66,25,245,98,139,172,89,190,149,127,177,64,138,210,169,58,28,70,100,206,188,164,107,60,150,203,126,235,142,56,249,38,222,148,178,195,56,115,230,45,108,7,84,234,21,44,90,110,216,178,37,226,53,14,77,212,31,86,180,100,23,82,14,162,93,122,6,81,156,24,209,75,255,163,218,196,121,237,187,9,152,247,136,158,91,128,232,169,137,251,10,216,154,188,131,211,71,200,34,236,216,129,13,179,136,32,54,99,146,33,131,202,49,84,18,64,197,245,114,21,193,52,74,118,44,243,105,173,50,252,110,63,166,41,102,199,62,117,184,15,77,250,162,69,120,231,107,213,2,177,43,67,102,159,238,171,206,64,29,233,10,151,135,185,87,247,147,223,91,241,152,225,175,3,102,220,25,191,170,36,143,81,152,209,224,133,35,93,2,145,87,124,193,97,22,228,1,120,51,171,8,26,210,108,48,205,59,179,92,147,253,124,99,237,186,11,120,19,181,229,112,198,160,220,76,42,210,160,71,202,31,78,190,130,67,86,138,115,156,243,14,46,74,57,219,28,51,90,250,59,81,140,47,255,17,58,181,243,114,56,178,239,139,228,156,251,40,167,232,28,38,82,136,206,161,9,196,106,139,167,204,150,195,218,70,172,35,132,103,146,27,89,128,16,107,96,57,119,201,15,187,239,126,194,225,112,182,234,131,174,240,72,39,109,29,8,100,122,207,231,4,166,224,198,153,217,44,183,212,4,93,143,72,99,172,64,0,97,34,85,66,20,208,3,125,243,164,186,235,156,82,191,67,248,49,80,10,253,68,23,162,244,179,49,215,24,151,246,51,214,153,251,118,45,157,98,224,53,88,134,62,42,23,116,94,140,33,121,188,169,141,113,76,33,131,227,110,11,202,78,122,168,18,141,194,221,80,187,142,177,210,18,249,144,221,180,12,201,215,106,60,91,226,200,236,150,85,61,164,185,133,42,229,187,73,55,101,27,235,59,12,35,75,113,199,101,163,237,57,152,174,234,134,1,37,53,123,193,6,208,253,34,91,145,104,8,240,211,175,129,164,109,253,123,230,171,6,50,79,27,127,73,43,19,246,161,211,103,17,172,96,46,117,70,241,219,27,162,115,88,38,4,148,204,92,189,154,63,130,217,188,111,254,208,101,86,191,144,75,180,249,65,137,233,157,18,171,192,49,66,201,137,246,218,51,71,15,43,214,29,95,239,38,139,165,7,225,124,30,59,112,221,154,28,197,217,106,58,85,209,128,232,151,15,79,182,120,238,168,134,81,248,146,173,16,88,195,65,150,183,205,242,11,41,89,126,80,8,183,121,141,3,98,180,31,108,58,196,97,24,222,107,198,2,116,70,207,52,230,22,109,47,80,165,132,199,235,170,52,148,247,165,23,242,74,45,254,170,226,155,36,142,179,60,158,48,182,223,154,124,98,178,250,140,5,231,96,68,19,116,204,32,227,43,200,113,161,213,122,87,0,130,248,77,13,241,92,229,30,102,13,244,77,160,33,209,119,55,176,143,190,255,103,71,93,186,62,223,145,12,189,68,202,47,211,114,192,41,127,203,141,65,189,40,135,198,61,89,222,158,24,216,45,1,157,213,130,239,83,104,26,55,134,238,29,159,95,63,167,149,7,78,255,119,166,212,1,233,19,105,186,37,244,110,86,135,56,173,11,151,36,176,196,230,94,149,109,184,226,20,236,215,105,175,22,219,52,87,111,174,128,248,149,78,125,63,184,227,242,118,22,220,138,252,119,76,168,39,250,10,136,84,123,54,69,194,37,95,147,241,73,153,48,68,7,194,17,207,161,31,76,201,90,166,69,4,48,215,21,204,57,73,176,200,30,249,155,133,233,163,9,197,32,183,220,205,137,232,167,94,144,9,105,181,44,111,207,99,132,155,182,85,127,219,147,42,97,184,5,83,208,108,61,125,228,21,100,39,90,114,53,218,41,252,129,61,234,143,30,192,245,12,112,236,101,2,244,113,165,225,118,47,20,176,251,142,84,117,160,254,177,26,238,121,72,193,213,153,13,55,173,79,224,65,140,34,195,158,54,17,206,62,144,240,190,72,40,214,54,192,5,146,60,82,185,3,138,169,25,83,245];const p=32;m.onChange=U.onChange=y.onChange=P.onChange=N.onChange=F.onChange=L.onChange=D.onChange=O.onChange=C.onChange=R.onChange=s.onChange=a;O.set('{"keys" : [{"pos":0,"r":0,"g":0,"b":0},{"pos":1,"r":1,"g":1,"b":1}]}');i.onLoaded=a;t.onTriggered=()=>{const e=l();if(e){e.forEach(e=>{e.r=Math.random();e.g=Math.random();e.b=Math.random()});const t=JSON.stringify({keys:e});O.set(t)}};function G(e,t,i){let s=.4122214708*e+.5363325363*t+.0514459929*i;let r=.2119034982*e+.6806995451*t+.1073969566*i;let n=.0883024619*e+.2817188376*t+.6299787005*i;s=Math.cbrt(s);r=Math.cbrt(r);n=Math.cbrt(n);return[s*+.2104542553+r*+.793617785+n*-.0040720468,s*+1.9779984951+r*-2.428592205+n*+.4505937099,s*+.0259040371+r*+.7827717662+n*-.808675766]}function j(e,t,i){let s=e+t*+.3963377774+i*+.2158037573;let r=e+t*-.1055613458+i*-.0638541728;let n=e+t*-.0894841775+i*-1.291485548;s**=3;r**=3;n**=3;let a=s*+4.0767416621+r*-3.3077115913+n*+.2309699292;let o=s*-1.2684380046+r*+2.6097574011+n*-.3413193965;let l=s*-.0041960863+r*-.7034186147+n*+1.707614701;a=CABLES.clamp(a,0,1);o=CABLES.clamp(o,0,1);l=CABLES.clamp(l,0,1);return[a,o,l]}function H(e,t,i){e/=255;const s=.0031308;let r=12.92*e;let n=1.055*Math.pow(e,.41666)-.055;return(e<s?r:n)*255}function a(){k.addNextFrameOnceCallback(o)}function o(){const e=l();if(e)h(e)}function l(){let t=null;i.setUiError("nodata",null);i.setUiError("parse",null);if(Array.isArray(s.get())){t=s.get()}else{let e=null;if(!O.get()||O.get()===""){return null}try{e=JSON.parse(O.get())}catch(e){i.setUiError("parse","could not parse gradient data")}if(!e||!e.keys){i.setUiError("nodata","gradient no data");return null}t=e.keys}return t}function _(e,t){e%=p;t%=p;return n[e+t*p]/255-.5}function z(r,n,a){if(m.get()==0)return r;for(let s=0;s<n;s++)for(let i=0;i<a;i++){const o=r[(s+i*n)*4+0];const l=r[(s+i*n)*4+1];const h=r[(s+i*n)*4+2];let e=n/8*m.get()*_(s,i);let t=a/8*m.get()*_(s+p/2,i+p/2);if(a==1)t=0;if(n==1)e=0;e=Math.round(e);t=Math.round(t);const u=CABLES.clamp(i+t,0,a-1);const c=CABLES.clamp(s+e,0,n-1);const f=r[(c+u*n)*4+0];const g=r[(c+u*n)*4+1];const d=r[(c+u*n)*4+2];r[(s+i*n)*4+0]=f;r[(s+i*n)*4+1]=g;r[(s+i*n)*4+2]=d;r[(c+u*n)*4+0]=o;r[(c+u*n)*4+1]=l;r[(c+u*n)*4+2]=h}return r}function h(t){let r=Math.round(D.get());if(r<4)r=4;O.setUiAttribs({editShortcut:true,gradEditSmoothstep:C.get(),gradEditStep:P.get(),gradOklab:L.get()});let e=0;let i=0;if(U.get()=="repeat")e=CGL.Texture.WRAP_REPEAT;else if(U.get()=="mirrored repeat")e=CGL.Texture.WRAP_MIRRORED_REPEAT;else if(U.get()=="clamp to edge")e=CGL.Texture.WRAP_CLAMP_TO_EDGE;if(y.get()=="nearest")i=CGL.Texture.FILTER_NEAREST;else if(y.get()=="linear")i=CGL.Texture.FILTER_LINEAR;else if(y.get()=="mipmap")i=CGL.Texture.FILTER_MIPMAP;const s=new CGL.Texture(k);let n=new Uint8Array(r*4);for(let e=0;e<t.length-1;e++){const l=t[e];const h=t[e+1];for(let i=l.pos*r;i<h.pos*r;i++){let e=CABLES.map(i,l.pos*r,h.pos*r,0,1);if(P.get())e=Math.round(e);if(C.get())e=CABLES.smoothStep(e);i=Math.round(i);let t=i;if(N.get())t=r-i-1;if(L.get()){const u=G(l.r,l.g,l.b);const c=u[0];const f=u[1];const g=u[2];const d=G(h.r,h.g,h.b);const m=d[0];const p=d[1];const _=d[2];const v=e*m+(1-e)*c;const E=e*p+(1-e)*f;const b=e*_+(1-e)*g;const x=j(v,E,b);n[t*4+0]=Math.round(x[0]*255);n[t*4+1]=Math.round(x[1]*255);n[t*4+2]=Math.round(x[2]*255)}else{n[t*4+0]=Math.round((e*h.r+(1-e)*l.r)*255);n[t*4+1]=Math.round((e*h.g+(1-e)*l.g)*255);n[t*4+2]=Math.round((e*h.b+(1-e)*l.b)*255)}if(typeof l.a!=="undefined"&&typeof h.a!=="undefined"){const T=Math.round((e*h.a+(1-e)*l.a)*255);n[t*4+3]=T}else{n[t*4+3]=Math.round(255)}}}if(F.get())for(let e=0;e<n.length;e+=4){n[e+0]=H(n[e+0]);n[e+1]=H(n[e+1]);n[e+2]=H(n[e+2])}if(R.get()=="X")s.initFromData(z(n,r,1),r,1,i,e);if(R.get()=="Y")s.initFromData(z(n,1,r),1,r,i,e);if(R.get()=="Radial"){const A=new Uint8Array(r*r*4);for(let s=0;s<r;s++){for(let i=0;i<r;i++){const S=s-(r-1)/2;const M=i-(r-1)/2;let e=Math.sqrt(S*S+M*M)/r*2;if(C.get())e=CABLES.smoothStep(e);let t=Math.round(e*r)*4;if(t>=r*4)t=r*4-4;A[s*4+i*4*r+0]=n[t+0];A[s*4+i*4*r+1]=n[t+1];A[s*4+i*4*r+2]=n[t+2];A[s*4+i*4*r+3]=Math.round(255)}}n=A;s.initFromData(z(n,r,r),r,r,i,e)}if(R.get()=="XX"){const A=new Uint8Array(r*r*4);for(let t=0;t<r;t++)for(let e=0;e<r;e++){const I=t*4;A[t*4+e*4*r+0]=n[I+0];A[t*4+e*4*r+1]=n[I+1];A[t*4+e*4*r+2]=n[I+2];A[t*4+e*4*r+3]=Math.round(255)}n=A;s.initFromData(z(n,r,r),r,r,i,e)}if(R.get()=="YY"){const A=new Uint8Array(r*r*4);for(let t=0;t<r;t++)for(let e=0;e<r;e++){const I=t*4;A[e*4+t*4*r+0]=n[I+0];A[e*4+t*4*r+1]=n[I+1];A[e*4+t*4*r+2]=n[I+2];A[e*4+t*4*r+3]=Math.round(255)}n=A;s.initFromData(z(n,r,r),r,r,i,e)}if(R.get()=="XY"||R.get()=="YX"){const A=new Uint8Array(r*r*4);for(let s=0;s<r;s++){let i=s;if(R.get()=="YX")i=r-s-1;for(let t=0;t<r;t++){let e=Math.round((i+t)/2)*4;A[s*4+t*4*r+0]=n[e+0];A[s*4+t*4*r+1]=n[e+1];A[s*4+t*4*r+2]=n[e+2];A[s*4+t*4*r+3]=Math.round(255)}}n=A;s.initFromData(z(n,r,r),r,r,i,e)}const a=[];for(let e=0;e<t.length-1;e++){a.push(t[e].r,t[e].g,t[e].b)}const o=[];for(let e=0;e<t.length-1;e++){o.push(t[e].pos)}B.set(a);V.set(o);w.setRef(s)}}};CABLES.OPS["01380a50-2dbb-4465-ae80-86349b0b717a"]={f:Ops.Gl.GradientTexture,objName:"Ops.Gl.GradientTexture"};Ops.Math.FlipSign=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValueFloat("Value",1),s=e.outNumber("Result");i.onChange=r;r();function r(){s.set(i.get()*-1)}}};CABLES.OPS["f5c858a2-2654-4108-86fe-319efa70ecec"]={f:Ops.Math.FlipSign,objName:"Ops.Math.FlipSign"};Ops.Gl.ImageCompose.DrawImage_v3=class extends CABLES.Op{constructor(){super(...arguments);const s=this;const e=s.attachments={drawimage_frag:"#ifdef HAS_TEXTURES\n    IN vec2 texCoord;\n    UNI sampler2D tex;\n    UNI sampler2D image;\n#endif\n\n#ifdef TEX_TRANSFORM\n    IN mat3 transform;\n#endif\n// UNI float rotate;\n\n{{CGL.BLENDMODES}}\n\n#ifdef HAS_TEXTUREALPHA\n   UNI sampler2D imageAlpha;\n#endif\n\nUNI float amount;\n\n#ifdef ASPECT_RATIO\n    UNI float aspectTex;\n    UNI float aspectPos;\n#endif\n\nvoid main()\n{\n    vec4 blendRGBA=vec4(0.0,0.0,0.0,1.0);\n\n    #ifdef HAS_TEXTURES\n        vec2 tc=texCoord;\n\n        #ifdef TEX_FLIP_X\n            tc.x=1.0-tc.x;\n        #endif\n        #ifdef TEX_FLIP_Y\n            tc.y=1.0-tc.y;\n        #endif\n\n        #ifdef ASPECT_RATIO\n            #ifdef ASPECT_AXIS_X\n                tc.y=(1.0-aspectPos)-(((1.0-aspectPos)-tc.y)*aspectTex);\n            #endif\n            #ifdef ASPECT_AXIS_Y\n                tc.x=(1.0-aspectPos)-(((1.0-aspectPos)-tc.x)/aspectTex);\n            #endif\n        #endif\n\n        #ifdef TEX_TRANSFORM\n            vec3 coordinates=vec3(tc.x, tc.y,1.0);\n            tc=(transform * coordinates ).xy;\n        #endif\n\n        blendRGBA=texture(image,tc);\n\n        vec3 blend=blendRGBA.rgb;\n        vec4 baseRGBA=texture(tex,texCoord);\n        vec3 base=baseRGBA.rgb;\n\n\n        #ifdef PREMUL\n            blend.rgb = (blend.rgb) + (base.rgb * (1.0 - blendRGBA.a));\n        #endif\n\n        vec3 colNew=_blend(base,blend);\n\n\n\n\n        #ifdef REMOVE_ALPHA_SRC\n            blendRGBA.a=1.0;\n        #endif\n\n        #ifdef HAS_TEXTUREALPHA\n            vec4 colImgAlpha=texture(imageAlpha,tc);\n            float colImgAlphaAlpha=colImgAlpha.a;\n\n            #ifdef ALPHA_FROM_LUMINANCE\n                vec3 gray = vec3(dot(vec3(0.2126,0.7152,0.0722), colImgAlpha.rgb ));\n                colImgAlphaAlpha=(gray.r+gray.g+gray.b)/3.0;\n            #endif\n\n            #ifdef ALPHA_FROM_INV_UMINANCE\n                vec3 gray = vec3(dot(vec3(0.2126,0.7152,0.0722), colImgAlpha.rgb ));\n                colImgAlphaAlpha=1.0-(gray.r+gray.g+gray.b)/3.0;\n            #endif\n\n            #ifdef INVERT_ALPHA\n                colImgAlphaAlpha=clamp(colImgAlphaAlpha,0.0,1.0);\n                colImgAlphaAlpha=1.0-colImgAlphaAlpha;\n            #endif\n\n            blendRGBA.a=colImgAlphaAlpha*blendRGBA.a;\n        #endif\n    #endif\n\n    float am=amount;\n\n    #ifdef CLIP_REPEAT\n        if(tc.y>1.0 || tc.y<0.0 || tc.x>1.0 || tc.x<0.0)\n        {\n            // colNew.rgb=vec3(0.0);\n            am=0.0;\n        }\n    #endif\n\n    #ifdef ASPECT_RATIO\n        #ifdef ASPECT_CROP\n            if(tc.y>1.0 || tc.y<0.0 || tc.x>1.0 || tc.x<0.0)\n            {\n                colNew.rgb=base.rgb;\n                am=0.0;\n            }\n\n        #endif\n    #endif\n\n\n\n    #ifndef PREMUL\n        blendRGBA.rgb=mix(colNew,base,1.0-(am*blendRGBA.a));\n        blendRGBA.a=clamp(baseRGBA.a+(blendRGBA.a*am),0.,1.);\n    #endif\n\n    #ifdef PREMUL\n        // premultiply\n        // blendRGBA.rgb = (blendRGBA.rgb) + (baseRGBA.rgb * (1.0 - blendRGBA.a));\n        blendRGBA=vec4(\n            mix(colNew.rgb,base,1.0-(am*blendRGBA.a)),\n            blendRGBA.a*am+baseRGBA.a\n            );\n    #endif\n\n    #ifdef ALPHA_MASK\n    blendRGBA.a=baseRGBA.a;\n    #endif\n\n    outColor=blendRGBA;\n}\n\n\n\n\n\n\n\n",drawimage_vert:"IN vec3 vPosition;\nIN vec2 attrTexCoord;\nIN vec3 attrVertNormal;\n\nUNI mat4 projMatrix;\nUNI mat4 mvMatrix;\n\nOUT vec2 texCoord;\n// OUT vec3 norm;\n\n#ifdef TEX_TRANSFORM\n    UNI float posX;\n    UNI float posY;\n    UNI float scaleX;\n    UNI float scaleY;\n    UNI float rotate;\n    OUT mat3 transform;\n#endif\n\nvoid main()\n{\n   texCoord=attrTexCoord;\n//   norm=attrVertNormal;\n\n   #ifdef TEX_TRANSFORM\n        vec3 coordinates=vec3(attrTexCoord.x, attrTexCoord.y,1.0);\n        float angle = radians( rotate );\n        vec2 scale= vec2(scaleX,scaleY);\n        vec2 translate= vec2(posX,posY);\n\n        transform = mat3(   scale.x * cos( angle ), scale.x * sin( angle ), 0.0,\n            - scale.y * sin( angle ), scale.y * cos( angle ), 0.0,\n            - 0.5 * scale.x * cos( angle ) + 0.5 * scale.y * sin( angle ) - 0.5 * translate.x*2.0 + 0.5,  - 0.5 * scale.x * sin( angle ) - 0.5 * scale.y * cos( angle ) - 0.5 * translate.y*2.0 + 0.5, 1.0);\n   #endif\n\n   gl_Position = projMatrix * mvMatrix * vec4(vPosition,  1.0);\n}\n"};const t=s.inTrigger("render"),i=CGL.TextureEffect.AddBlendSelect(s,"blendMode"),r=s.inValueSlider("amount",1),n=s.inTexture("Image"),a=s.inValueBool("Premultiplied",false),o=s.inValueBool("Alpha Mask",false),l=s.inValueBool("removeAlphaSrc",false),h=s.inTexture("Mask"),u=s.inValueSelect("Mask Src",["alpha channel","luminance","luminance inv"],"luminance"),c=s.inBool("Invert alpha channel"),f=s.inValueBool("Aspect Ratio",false),g=s.inValueSelect("Stretch Axis",["X","Y"],"X"),d=s.inValueSlider("Position",0),m=s.inValueBool("Crop",false),p=s.outTrigger("trigger");i.set("normal");const _=s.patch.cgl;const v=new CGL.Shader(_,"drawimage");h.onLinkChanged=E;s.setPortGroup("Aspect Ratio",[f,d,m,g]);s.setPortGroup("Mask",[h,u,c]);function E(){if(h.isLinked()){l.setUiAttribs({greyout:true});u.setUiAttribs({greyout:false});c.setUiAttribs({greyout:false})}else{l.setUiAttribs({greyout:false});u.setUiAttribs({greyout:true});c.setUiAttribs({greyout:true})}}s.toWorkPortsNeedToBeLinked(n);v.setSource(e.drawimage_vert,e.drawimage_frag);const b=new CGL.Uniform(v,"t","tex",0),y=new CGL.Uniform(v,"t","image",1),U=new CGL.Uniform(v,"t","imageAlpha",2),x=new CGL.Uniform(v,"f","aspectTex",1),w=new CGL.Uniform(v,"f","aspectPos",d);f.onChange=m.onChange=g.onChange=T;function T(){v.removeDefine("ASPECT_AXIS_X");v.removeDefine("ASPECT_AXIS_Y");v.removeDefine("ASPECT_CROP");d.setUiAttribs({greyout:!f.get()});m.setUiAttribs({greyout:!f.get()});g.setUiAttribs({greyout:!f.get()});if(f.get()){v.define("ASPECT_RATIO");if(m.get())v.define("ASPECT_CROP");if(g.get()=="X")v.define("ASPECT_AXIS_X");if(g.get()=="Y")v.define("ASPECT_AXIS_Y")}else{v.removeDefine("ASPECT_RATIO");if(m.get())v.define("ASPECT_CROP");if(g.get()=="X")v.define("ASPECT_AXIS_X");if(g.get()=="Y")v.define("ASPECT_AXIS_Y")}}const A=s.inValueBool("flip x");const S=s.inValueBool("flip y");let M=s.inValueBool("Transform");let I=s.inValueSlider("Scale X",1);let O=s.inValueSlider("Scale Y",1);let R=s.inValue("Position X",0);let C=s.inValue("Position Y",0);let P=s.inValue("Rotation",0);const N=s.inValueBool("Clip Repeat",false);const B=new CGL.Uniform(v,"f","scaleX",I);const V=new CGL.Uniform(v,"f","scaleY",O);const k=new CGL.Uniform(v,"f","posX",R);const G=new CGL.Uniform(v,"f","posY",C);const j=new CGL.Uniform(v,"f","rotate",P);M.onChange=F;function F(){v.toggleDefine("TEX_TRANSFORM",M.get());I.setUiAttribs({greyout:!M.get()});O.setUiAttribs({greyout:!M.get()});R.setUiAttribs({greyout:!M.get()});C.setUiAttribs({greyout:!M.get()});P.setUiAttribs({greyout:!M.get()})}CGL.TextureEffect.setupBlending(s,v,i,r);const H=new CGL.Uniform(v,"f","amount",r);t.onTriggered=D;N.onChange=h.onChange=a.onChange=o.onChange=c.onChange=S.onChange=A.onChange=l.onChange=u.onChange=L;F();E();T();L();function L(){v.toggleDefine("REMOVE_ALPHA_SRC",l.get());v.toggleDefine("ALPHA_MASK",o.get());v.toggleDefine("CLIP_REPEAT",N.get());v.toggleDefine("HAS_TEXTUREALPHA",h.get()&&h.get().tex);v.toggleDefine("TEX_FLIP_X",A.get());v.toggleDefine("TEX_FLIP_Y",S.get());v.toggleDefine("INVERT_ALPHA",c.get());v.toggleDefine("ALPHA_FROM_LUMINANCE",u.get()=="luminance");v.toggleDefine("ALPHA_FROM_INV_UMINANCE",u.get()=="luminance_inv");v.toggleDefine("PREMUL",a.get())}function D(){if(!CGL.TextureEffect.checkOpInEffect(s))return;const e=n.get();if(e&&e.tex&&r.get()>0){_.pushShader(v);_.currentTextureEffect.bind();const t=_.currentTextureEffect.getCurrentSourceTexture();_.setTexture(0,t.tex);const i=1/(_.currentTextureEffect.getWidth()/_.currentTextureEffect.getHeight())*(e.width/e.height);x.setValue(i);_.setTexture(1,e.tex);if(h.get()&&h.get().tex){_.setTexture(2,h.get().tex)}_.pushBlendMode(CGL.BLEND_NONE,true);_.currentTextureEffect.finish();_.popBlendMode();_.popShader()}p.trigger()}}};CABLES.OPS["8f6b2f15-fcb0-4597-90c0-e5173f2969fe"]={f:Ops.Gl.ImageCompose.DrawImage_v3,objName:"Ops.Gl.ImageCompose.DrawImage_v3"};Ops.Gl.ShaderEffects.FresnelGlow=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={fresnel_body_frag:"#ifdef ENABLE_FRESNEL_MOD\n    vec3 MOD_fragNormal = normalize(MOD_norm);\n    col.rgb += MOD_inFresnel.rgb *\n        MOD_CalculateFresnel(vec3(MOD_cameraSpace_pos), MOD_fragNormal)\n        * MOD_inFresnel.w;\n#endif\n",fresnel_body_vert:"#ifdef ENABLE_FRESNEL_MOD\n    MOD_cameraSpace_pos = viewMatrix*mMatrix * pos;\n    MOD_norm = norm;\n    MOD_viewMatrix = mat3(viewMatrix);\n#endif",fresnel_head_frag:"IN vec4 MOD_cameraSpace_pos;\nIN mat3 MOD_viewMatrix;\nIN vec3 MOD_norm;\n\n#ifdef ENABLE_FRESNEL_MOD\n    float MOD_CalculateFresnel(vec3 cameraSpace_pos, vec3 normal)\n    {\n\n        vec3 nDirection = normalize(cameraSpace_pos);\n        vec3 nNormal = normalize(MOD_viewMatrix * normal);\n        vec3 halfDirection = normalize(nNormal + nDirection);\n\n        float cosine = dot(halfDirection, nDirection);\n        float product = max(cosine, 0.0);\n        float factor = pow(product, MOD_inFresnelExponent);\n\n        return 5. * factor;\n\n\n    }\n#endif\n",fresnel_head_vert:"#ifdef ENABLE_FRESNEL_MOD\n    OUT vec4 MOD_cameraSpace_pos;\n    OUT mat3 MOD_viewMatrix;\n    OUT vec3 MOD_norm;\n#endif"};const i=e.patch.cgl;const s=e.inTrigger("Trigger In");const r=e.inBool("Active",true);const n=e.inFloatSlider("R",Math.random());const a=e.inFloatSlider("G",Math.random());const o=e.inFloatSlider("B",Math.random());n.setUiAttribs({colorPick:true});e.setPortGroup("Color",[n,a,o]);const l=e.inFloat("Fresnel Intensity",1);const h=e.inFloat("Fresnel Exponent",2.5);e.setPortGroup("Fresnel Settings",[l,h]);r.onChange=()=>{c.toggleDefine("ENABLE_FRESNEL_MOD",r);n.setUiAttribs({greyout:!r.get()});a.setUiAttribs({greyout:!r.get()});o.setUiAttribs({greyout:!r.get()});l.setUiAttribs({greyout:!r.get()});h.setUiAttribs({greyout:!r.get()})};const u=e.outTrigger("Trigger Out");const c=new CGL.ShaderModifier(i,"fresnelGlow");c.toggleDefine("ENABLE_FRESNEL_MOD",r);c.addModule({priority:2,title:"fresnelGlow",name:"MODULE_VERTEX_POSITION",srcHeadVert:t.fresnel_head_vert,srcBodyVert:t.fresnel_body_vert});c.addModule({title:"fresnelGlow",name:"MODULE_COLOR",srcHeadFrag:t.fresnel_head_frag,srcBodyFrag:t.fresnel_body_frag});c.addUniform("4f","MOD_inFresnel",n,a,o,l);c.addUniform("f","MOD_inFresnelExponent",h);s.onTriggered=()=>{c.bind();u.trigger();c.unbind()}}};CABLES.OPS["89979937-68a6-4736-8241-3c6b748103d4"]={f:Ops.Gl.ShaderEffects.FresnelGlow,objName:"Ops.Gl.ShaderEffects.FresnelGlow"};Ops.Graphics.TransformView=class extends CABLES.Op{constructor(){super(...arguments);const i=this;const e=i.attachments={};const t=i.inTrigger("render"),s=i.inValueFloat("posX"),r=i.inValueFloat("posY"),n=i.inValueFloat("posZ"),a=i.inValueFloat("scale"),o=i.inValueFloat("rotX"),l=i.inValueFloat("rotY"),h=i.inValueFloat("rotZ"),u=i.outTrigger("trigger");i.setPortGroup("Position",[s,r,n]);i.setPortGroup("Scale",[a]);i.setPortGroup("Rotation",[o,h,l]);const c=vec3.create();const f=vec3.create();const g=mat4.create();mat4.identity(g);let d=false;let m=false;let p=true;let _=true;let v=true;t.onTriggered=function(){const e=i.patch.cg||i.patch.cgl;let t=false;if(p){b();t=true}if(_){x();t=true}if(v){t=true}if(t)E();e.pushViewMatrix();mat4.multiply(e.vMatrix,e.vMatrix,g);u.trigger();e.popViewMatrix();if(i.isCurrentUiOp())gui.setTransformGizmo({posX:s,posY:r,posZ:n})};i.transform3d=function(){return{pos:[s,r,n]}};function E(){mat4.identity(g);if(m)mat4.translate(g,g,c);if(o.get()!==0)mat4.rotateX(g,g,o.get()*CGL.DEG2RAD);if(l.get()!==0)mat4.rotateY(g,g,l.get()*CGL.DEG2RAD);if(h.get()!==0)mat4.rotateZ(g,g,h.get()*CGL.DEG2RAD);if(d)mat4.scale(g,g,f);S=false}function b(){m=false;if(s.get()!==0||r.get()!==0||n.get()!==0)m=true;vec3.set(c,s.get(),r.get(),n.get());p=false}function x(){d=false;if(a.get()!==0)d=true;vec3.set(f,a.get(),a.get(),a.get());A=false}function T(){p=true}function A(){_=true}function S(){v=true}o.onChange=l.onChange=h.onChange=S;a.onChange=A;s.onChange=r.onChange=n.onChange=T;o.set(0);l.set(0);h.set(0);a.set(1);s.set(0);r.set(0);n.set(0);E()}};CABLES.OPS["0b3e04f7-323e-4ac8-8a22-a21e2f36e0e9"]={f:Ops.Graphics.TransformView,objName:"Ops.Graphics.TransformView"};Ops.Gl.ImageCompose.Blur=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={blur_frag:"IN vec2 texCoord;\nUNI sampler2D tex;\nUNI float dirX;\nUNI float dirY;\nUNI float amount;\n\n#ifdef HAS_MASK\n    UNI sampler2D imageMask;\n#endif\n\nfloat random(vec3 scale, float seed)\n{\n    return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);\n}\n\nvoid main()\n{\n    vec4 color = vec4(0.0);\n    float total = 0.0;\n\n    float am=amount;\n    #ifdef HAS_MASK\n        am=amount*texture(imageMask,texCoord).r;\n        if(am<=0.02)\n        {\n            outColor=texture(tex, texCoord);\n            return;\n        }\n    #endif\n\n    vec2 delta=vec2(dirX*am*0.01,dirY*am*0.01);\n\n\n    float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\n\n    #ifdef MOBILE\n        offset = 0.1;\n    #endif\n\n    #if defined(FASTBLUR) && !defined(MOBILE)\n        const float range=5.0;\n    #else\n        const float range=20.0;\n    #endif\n\n    for (float t = -range; t <= range; t+=1.0)\n    {\n        float percent = (t + offset - 0.5) / range;\n        float weight = 1.0 - abs(percent);\n        vec4 smpl = texture(tex, texCoord + delta * percent);\n\n        smpl.rgb *= smpl.a;\n\n        color += smpl * weight;\n        total += weight;\n    }\n\n    outColor= color / total;\n\n    outColor.rgb /= outColor.a + 0.00001;\n\n\n\n}\n"};const i=e.inTrigger("render");const s=e.outTrigger("trigger");const r=e.inValueFloat("amount");const n=e.inSwitch("direction",["both","vertical","horizontal"],"both");const a=e.inValueBool("Fast",true);const o=e.patch.cgl;r.set(10);let l=new CGL.Shader(o,"blur");l.define("FASTBLUR");a.onChange=function(){if(a.get())l.define("FASTBLUR");else l.removeDefine("FASTBLUR")};l.setSource(l.getDefaultVertexShader(),t.blur_frag);let h=new CGL.Uniform(l,"t","tex",0);let u=new CGL.Uniform(l,"f","dirX",0);let c=new CGL.Uniform(l,"f","dirY",0);let f=new CGL.Uniform(l,"f","width",0);let g=new CGL.Uniform(l,"f","height",0);let d=new CGL.Uniform(l,"f","amount",r.get());r.onChange=function(){d.setValue(r.get())};let m=new CGL.Uniform(l,"t","imageMask",1);let p=false;function _(){if(o.currentTextureEffect.getCurrentSourceTexture().width==o.canvasWidth&&o.currentTextureEffect.getCurrentSourceTexture().height==o.canvasHeight){e.setUiError("warning","Full screen blurs are slow! Try reducing the resolution to 1/2 or a 1/4",0)}else{e.setUiError("warning",null)}}let v=0;n.onChange=function(){if(n.get()=="both")v=0;if(n.get()=="horizontal")v=1;if(n.get()=="vertical")v=2};let E=e.inTexture("mask");E.onChange=function(){if(E.get()&&E.get().tex)l.define("HAS_MASK");else l.removeDefine("HAS_MASK")};i.onTriggered=function(){if(!CGL.TextureEffect.checkOpInEffect(e))return;o.pushShader(l);f.setValue(o.currentTextureEffect.getCurrentSourceTexture().width);g.setValue(o.currentTextureEffect.getCurrentSourceTexture().height);_();if(v===0||v==2){o.currentTextureEffect.bind();o.setTexture(0,o.currentTextureEffect.getCurrentSourceTexture().tex);if(E.get()&&E.get().tex){o.setTexture(1,E.get().tex)}u.setValue(0);c.setValue(1);o.currentTextureEffect.finish()}if(v===0||v==1){o.currentTextureEffect.bind();o.setTexture(0,o.currentTextureEffect.getCurrentSourceTexture().tex);if(E.get()&&E.get().tex){o.setTexture(1,E.get().tex)}u.setValue(1);c.setValue(0);o.currentTextureEffect.finish()}o.popShader();s.trigger()}}};CABLES.OPS["54f26f53-f637-44c1-9bfb-a2f2b722e998"]={f:Ops.Gl.ImageCompose.Blur,objName:"Ops.Gl.ImageCompose.Blur"};Ops.Gl.ImageCompose.Noise.PerlinNoise_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={perlinnoise3d_frag:'UNI float z;\nUNI float x;\nUNI float y;\nUNI float scale;\nUNI float rangeMul;\nUNI float harmonics;\nUNI float aspect;\n\nIN vec2 texCoord;\nUNI sampler2D tex;\n\n#ifdef HAS_TEX_OFFSETMAP\n    UNI sampler2D texOffsetZ;\n    UNI float offMul;\n#endif\n\n#ifdef HAS_TEX_MASK\n    UNI sampler2D texMask;\n#endif\n\nUNI float amount;\n\n{{CGL.BLENDMODES3}}\n\n\nfloat Interpolation_C2( float x ) { return x * x * x * (x * (x * 6.0 - 15.0) + 10.0); }   //  6x^5-15x^4+10x^3\t( Quintic Curve.  As used by Perlin in Improved Noise.  http://mrl.nyu.edu/~perlin/paper445.pdf )\nvec2 Interpolation_C2( vec2 x ) { return x * x * x * (x * (x * 6.0 - 15.0) + 10.0); }\nvec3 Interpolation_C2( vec3 x ) { return x * x * x * (x * (x * 6.0 - 15.0) + 10.0); }\nvec4 Interpolation_C2( vec4 x ) { return x * x * x * (x * (x * 6.0 - 15.0) + 10.0); }\nvec4 Interpolation_C2_InterpAndDeriv( vec2 x ) { return x.xyxy * x.xyxy * ( x.xyxy * ( x.xyxy * ( x.xyxy * vec2( 6.0, 0.0 ).xxyy + vec2( -15.0, 30.0 ).xxyy ) + vec2( 10.0, -60.0 ).xxyy ) + vec2( 0.0, 30.0 ).xxyy ); }\nvec3 Interpolation_C2_Deriv( vec3 x ) { return x * x * (x * (x * 30.0 - 60.0) + 30.0); }\n\n\nvoid FAST32_hash_3D( vec3 gridcell, out vec4 lowz_hash, out vec4 highz_hash )\t//\tgenerates a random number for each of the 8 cell corners\n{\n    //    gridcell is assumed to be an integer coordinate\n\n    //\tTODO: \tthese constants need tweaked to find the best possible noise.\n    //\t\t\tprobably requires some kind of brute force computational searching or something....\n    const vec2 OFFSET = vec2( 50.0, 161.0 );\n    const float DOMAIN = 69.0;\n    const float SOMELARGEFLOAT = 635.298681;\n    const float ZINC = 48.500388;\n\n    //\ttruncate the domain\n    gridcell.xyz = gridcell.xyz - floor(gridcell.xyz * ( 1.0 / DOMAIN )) * DOMAIN;\n    vec3 gridcell_inc1 = step( gridcell, vec3( DOMAIN - 1.5 ) ) * ( gridcell + 1.0 );\n\n    //\tcalculate the noise\n    vec4 P = vec4( gridcell.xy, gridcell_inc1.xy ) + OFFSET.xyxy;\n    P *= P;\n    P = P.xzxz * P.yyww;\n    highz_hash.xy = vec2( 1.0 / ( SOMELARGEFLOAT + vec2( gridcell.z, gridcell_inc1.z ) * ZINC ) );\n    lowz_hash = fract( P * highz_hash.xxxx );\n    highz_hash = fract( P * highz_hash.yyyy );\n}\n\n\n\n\nvoid FAST32_hash_3D( \tvec3 gridcell,\n                        out vec4 lowz_hash_0,\n                        out vec4 lowz_hash_1,\n                        out vec4 lowz_hash_2,\n                        out vec4 highz_hash_0,\n                        out vec4 highz_hash_1,\n                        out vec4 highz_hash_2\t)\t\t//\tgenerates 3 random numbers for each of the 8 cell corners\n{\n    //    gridcell is assumed to be an integer coordinate\n\n    //\tTODO: \tthese constants need tweaked to find the best possible noise.\n    //\t\t\tprobably requires some kind of brute force computational searching or something....\n    const vec2 OFFSET = vec2( 50.0, 161.0 );\n    const float DOMAIN = 69.0;\n    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\n    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\n\n    //\ttruncate the domain\n    gridcell.xyz = gridcell.xyz - floor(gridcell.xyz * ( 1.0 / DOMAIN )) * DOMAIN;\n    vec3 gridcell_inc1 = step( gridcell, vec3( DOMAIN - 1.5 ) ) * ( gridcell + 1.0 );\n\n    //\tcalculate the noise\n    vec4 P = vec4( gridcell.xy, gridcell_inc1.xy ) + OFFSET.xyxy;\n    P *= P;\n    P = P.xzxz * P.yyww;\n    vec3 lowz_mod = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + gridcell.zzz * ZINC.xyz ) );\n    vec3 highz_mod = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + gridcell_inc1.zzz * ZINC.xyz ) );\n    lowz_hash_0 = fract( P * lowz_mod.xxxx );\n    highz_hash_0 = fract( P * highz_mod.xxxx );\n    lowz_hash_1 = fract( P * lowz_mod.yyyy );\n    highz_hash_1 = fract( P * highz_mod.yyyy );\n    lowz_hash_2 = fract( P * lowz_mod.zzzz );\n    highz_hash_2 = fract( P * highz_mod.zzzz );\n}\nfloat Falloff_Xsq_C1( float xsq ) { xsq = 1.0 - xsq; return xsq*xsq; }\t// ( 1.0 - x*x )^2   ( Used by Humus for lighting falloff in Just Cause 2.  GPUPro 1 )\nfloat Falloff_Xsq_C2( float xsq ) { xsq = 1.0 - xsq; return xsq*xsq*xsq; }\t// ( 1.0 - x*x )^3.   NOTE: 2nd derivative is 0.0 at x=1.0, but non-zero at x=0.0\nvec4 Falloff_Xsq_C2( vec4 xsq ) { xsq = 1.0 - xsq; return xsq*xsq*xsq; }\n\n\n//\n//\tPerlin Noise 3D  ( gradient noise )\n//\tReturn value range of -1.0->1.0\n//\thttp://briansharpe.files.wordpress.com/2011/11/perlinsample.jpg\n//\nfloat Perlin3D( vec3 P )\n{\n    //\testablish our grid cell and unit position\n    vec3 Pi = floor(P);\n    vec3 Pf = P - Pi;\n    vec3 Pf_min1 = Pf - 1.0;\n\n#if 1\n    //\n    //\tclassic noise.\n    //\trequires 3 random values per point.  with an efficent hash function will run faster than improved noise\n    //\n\n    //\tcalculate the hash.\n    //\t( various hashing methods listed in order of speed )\n    vec4 hashx0, hashy0, hashz0, hashx1, hashy1, hashz1;\n    FAST32_hash_3D( Pi, hashx0, hashy0, hashz0, hashx1, hashy1, hashz1 );\n    //SGPP_hash_3D( Pi, hashx0, hashy0, hashz0, hashx1, hashy1, hashz1 );\n\n    //\tcalculate the gradients\n    vec4 grad_x0 = hashx0 - 0.49999;\n    vec4 grad_y0 = hashy0 - 0.49999;\n    vec4 grad_z0 = hashz0 - 0.49999;\n    vec4 grad_x1 = hashx1 - 0.49999;\n    vec4 grad_y1 = hashy1 - 0.49999;\n    vec4 grad_z1 = hashz1 - 0.49999;\n    vec4 grad_results_0 = inversesqrt( grad_x0 * grad_x0 + grad_y0 * grad_y0 + grad_z0 * grad_z0 ) * ( vec2( Pf.x, Pf_min1.x ).xyxy * grad_x0 + vec2( Pf.y, Pf_min1.y ).xxyy * grad_y0 + Pf.zzzz * grad_z0 );\n    vec4 grad_results_1 = inversesqrt( grad_x1 * grad_x1 + grad_y1 * grad_y1 + grad_z1 * grad_z1 ) * ( vec2( Pf.x, Pf_min1.x ).xyxy * grad_x1 + vec2( Pf.y, Pf_min1.y ).xxyy * grad_y1 + Pf_min1.zzzz * grad_z1 );\n\n#if 1\n    //\tClassic Perlin Interpolation\n    vec3 blend = Interpolation_C2( Pf );\n    vec4 res0 = mix( grad_results_0, grad_results_1, blend.z );\n    vec4 blend2 = vec4( blend.xy, vec2( 1.0 - blend.xy ) );\n    float final = dot( res0, blend2.zxzx * blend2.wwyy );\n    final *= 1.1547005383792515290182975610039;\t\t//\t(optionally) scale things to a strict -1.0->1.0 range    *= 1.0/sqrt(0.75)\n    return final;\n#else\n    //\tClassic Perlin Surflet\n    //\thttp://briansharpe.wordpress.com/2012/03/09/modifications-to-classic-perlin-noise/\n    Pf *= Pf;\n    Pf_min1 *= Pf_min1;\n    vec4 vecs_len_sq = vec4( Pf.x, Pf_min1.x, Pf.x, Pf_min1.x ) + vec4( Pf.yy, Pf_min1.yy );\n    float final = dot( Falloff_Xsq_C2( min( vec4( 1.0 ), vecs_len_sq + Pf.zzzz ) ), grad_results_0 ) + dot( Falloff_Xsq_C2( min( vec4( 1.0 ), vecs_len_sq + Pf_min1.zzzz ) ), grad_results_1 );\n    final *= 2.3703703703703703703703703703704;\t\t//\t(optionally) scale things to a strict -1.0->1.0 range    *= 1.0/cube(0.75)\n    return final;\n#endif\n\n#else\n    //\n    //\timproved noise.\n    //\trequires 1 random value per point.  Will run faster than classic noise if a slow hashing function is used\n    //\n\n    //\tcalculate the hash.\n    //\t( various hashing methods listed in order of speed )\n    vec4 hash_lowz, hash_highz;\n    FAST32_hash_3D( Pi, hash_lowz, hash_highz );\n    //BBS_hash_3D( Pi, hash_lowz, hash_highz );\n    //SGPP_hash_3D( Pi, hash_lowz, hash_highz );\n\n    //\n    //\t"improved" noise using 8 corner gradients.  Faster than the 12 mid-edge point method.\n    //\tKen mentions using diagonals like this can cause "clumping", but we\'ll live with that.\n    //\t[1,1,1]  [-1,1,1]  [1,-1,1]  [-1,-1,1]\n    //\t[1,1,-1] [-1,1,-1] [1,-1,-1] [-1,-1,-1]\n    //\n    hash_lowz -= 0.5;\n    vec4 grad_results_0_0 = vec2( Pf.x, Pf_min1.x ).xyxy * sign( hash_lowz );\n    hash_lowz = abs( hash_lowz ) - 0.25;\n    vec4 grad_results_0_1 = vec2( Pf.y, Pf_min1.y ).xxyy * sign( hash_lowz );\n    vec4 grad_results_0_2 = Pf.zzzz * sign( abs( hash_lowz ) - 0.125 );\n    vec4 grad_results_0 = grad_results_0_0 + grad_results_0_1 + grad_results_0_2;\n\n    hash_highz -= 0.5;\n    vec4 grad_results_1_0 = vec2( Pf.x, Pf_min1.x ).xyxy * sign( hash_highz );\n    hash_highz = abs( hash_highz ) - 0.25;\n    vec4 grad_results_1_1 = vec2( Pf.y, Pf_min1.y ).xxyy * sign( hash_highz );\n    vec4 grad_results_1_2 = Pf_min1.zzzz * sign( abs( hash_highz ) - 0.125 );\n    vec4 grad_results_1 = grad_results_1_0 + grad_results_1_1 + grad_results_1_2;\n\n    //\tblend the gradients and return\n    vec3 blend = Interpolation_C2( Pf );\n    vec4 res0 = mix( grad_results_0, grad_results_1, blend.z );\n    vec4 blend2 = vec4( blend.xy, vec2( 1.0 - blend.xy ) );\n    return dot( res0, blend2.zxzx * blend2.wwyy ) * (2.0 / 3.0);\t//\t(optionally) mult by (2.0/3.0) to scale to a strict -1.0->1.0 range\n#endif\n}\n\nvoid main()\n{\n    vec4 base=texture(tex,texCoord);\n    vec2 p=vec2(texCoord.x-0.5,texCoord.y-0.5);\n\n    p=p*scale;\n    p=vec2(p.x+0.5-x,p.y+0.5-y);\n\n\n\n    vec3 offset;\n    #ifdef HAS_TEX_OFFSETMAP\n        vec4 offMap=texture(texOffsetZ,texCoord);\n\n        #ifdef OFFSET_X_R\n            offset.x=offMap.r;\n        #endif\n        #ifdef OFFSET_X_G\n            offset.x=offMap.g;\n        #endif\n        #ifdef OFFSET_X_B\n            offset.x=offMap.b;\n        #endif\n\n        #ifdef OFFSET_Y_R\n            offset.y=offMap.r;\n        #endif\n        #ifdef OFFSET_Y_G\n            offset.y=offMap.g;\n        #endif\n        #ifdef OFFSET_Y_B\n            offset.y=offMap.b;\n        #endif\n\n        #ifdef OFFSET_Z_R\n            offset.z=offMap.r;\n        #endif\n        #ifdef OFFSET_Z_G\n            offset.z=offMap.g;\n        #endif\n        #ifdef OFFSET_Z_B\n            offset.z=offMap.b;\n        #endif\n        offset*=offMul;\n    #endif\n\n    float aa=texture(tex,texCoord).r;\n\n    float v = 0.0;\n    p.x*=aspect;\n\n    v+=Perlin3D(vec3(p.x,p.y,z)+offset);\n\n    #ifdef HARMONICS\n        if (harmonics >= 2.0) v += Perlin3D(vec3(p.x,p.y,z)*2.2+offset) * 0.5;\n        if (harmonics >= 3.0) v += Perlin3D(vec3(p.x,p.y,z)*4.3+offset) * 0.25;\n        if (harmonics >= 4.0) v += Perlin3D(vec3(p.x,p.y,z)*8.4+offset) * 0.125;\n        if (harmonics >= 5.0) v += Perlin3D(vec3(p.x,p.y,z)*16.5+offset) * 0.0625;\n    #endif\n\n\n    v*=rangeMul;\n    v=v*0.5+0.5;\n    float v2=v;\n    float v3=v;\n\n    #ifdef RGB\n        v2=Perlin3D(vec3(p.x+2.0,p.y+2.0,z))*0.5+0.5;\n\n        #ifdef HARMONICS\n            if (harmonics >= 2.0) v2 += Perlin3D(vec3(p.x,p.y,z)*2.2+offset) * 0.5;\n            if (harmonics >= 3.0) v2 += Perlin3D(vec3(p.x,p.y,z)*4.3+offset) * 0.25;\n            if (harmonics >= 4.0) v2 += Perlin3D(vec3(p.x,p.y,z)*8.4+offset) * 0.125;\n            if (harmonics >= 5.0) v2 += Perlin3D(vec3(p.x,p.y,z)*16.5+offset) * 0.0625;\n        #endif\n\n        v3=Perlin3D(vec3(p.x+3.0,p.y+3.0,z))*0.5+0.5;\n\n        #ifdef HARMONICS\n            if (harmonics >= 2.0) v3 += Perlin3D(vec3(p.x,p.y,z)*2.2+offset) * 0.5;\n            if (harmonics >= 3.0) v3 += Perlin3D(vec3(p.x,p.y,z)*4.3+offset) * 0.25;\n            if (harmonics >= 4.0) v3 += Perlin3D(vec3(p.x,p.y,z)*8.4+offset) * 0.125;\n            if (harmonics >= 5.0) v3 += Perlin3D(vec3(p.x,p.y,z)*16.5+offset) * 0.0625;\n        #endif\n\n    #endif\n\n    vec4 col=vec4(v,v2,v3,1.0);\n\n    float str=1.0;\n    #ifdef HAS_TEX_MASK\n        str=texture(texMask,texCoord).r;\n    #endif\n\n    #ifdef RANGE_MIN1\n        col=col*2.0-1.0;\n    #endif\n\n    col=cgl_blendPixel(base,col,amount*str);\n\n\n    #ifdef NO_CHANNEL_R\n        col.r=base.r;\n    #endif\n    #ifdef NO_CHANNEL_G\n        col.g=base.g;\n    #endif\n    #ifdef NO_CHANNEL_B\n        col.b=base.b;\n    #endif\n\n\n\n    outColor=col;\n}\n'};const i=e.inTrigger("render"),s=e.inTexture("Mask"),r=CGL.TextureEffect.AddBlendSelect(e),n=CGL.TextureEffect.AddBlendAlphaMask(e),a=e.inValueSlider("Amount",1),o=e.inSwitch("Color",["Mono","RGB","R","G","B"],"Mono"),l=e.inValue("Scale",8),h=e.inValue("Multiply",1),u=e.inSwitch("Value",["0-1","-1-1"],"0-1"),c=e.inSwitch("Harmonics",["1","2","3","4","5"],"1"),f=e.inValue("X",0),g=e.inValue("Y",0),d=e.inValue("Z",0),m=e.outTrigger("trigger");const p=e.patch.cgl;const _=new CGL.Shader(p,"perlinnoise");e.setPortGroup("Position",[f,g,d]);_.setSource(_.getDefaultVertexShader(),t.perlinnoise3d_frag);const v=new CGL.Uniform(_,"t","tex",0),E=new CGL.Uniform(_,"t","texOffsetZ",1),b=new CGL.Uniform(_,"t","texMask",2),x=new CGL.Uniform(_,"f","z",d),T=new CGL.Uniform(_,"f","x",f),A=new CGL.Uniform(_,"f","y",g),S=new CGL.Uniform(_,"f","scale",l),M=new CGL.Uniform(_,"f","amount",a),I=new CGL.Uniform(_,"f","rangeMul",h);CGL.TextureEffect.setupBlending(e,_,r,a,n);const O=e.inTexture("Offset"),R=e.inFloat("Offset Multiply",1),C=e.inSwitch("Offset X",["None","R","G","B"],"None"),P=e.inSwitch("Offset Y",["None","R","G","B"],"None"),N=e.inSwitch("Offset Z",["None","R","G","B"],"R");e.setPortGroup("Offset Map",[O,N,P,C,R]);const y=new CGL.Uniform(_,"f","offMul",R);const F=new CGL.Uniform(_,"f","aspect",1);const L=new CGL.Uniform(_,"f","harmonics",0);c.onChange=()=>{L.setValue(parseFloat(c.get()));_.toggleDefine("HARMONICS",c.get()>1)};u.onChange=C.onChange=P.onChange=N.onChange=s.onChange=o.onChange=O.onChange=D;D();function D(){_.toggleDefine("NO_CHANNEL_R",o.get()=="G"||o.get()=="B");_.toggleDefine("NO_CHANNEL_G",o.get()=="R"||o.get()=="B");_.toggleDefine("NO_CHANNEL_B",o.get()=="R"||o.get()=="G");_.toggleDefine("HAS_TEX_OFFSETMAP",O.get());_.toggleDefine("HAS_TEX_MASK",s.get());_.toggleDefine("OFFSET_X_R",C.get()=="R");_.toggleDefine("OFFSET_X_G",C.get()=="G");_.toggleDefine("OFFSET_X_B",C.get()=="B");_.toggleDefine("OFFSET_Y_R",P.get()=="R");_.toggleDefine("OFFSET_Y_G",P.get()=="G");_.toggleDefine("OFFSET_Y_B",P.get()=="B");_.toggleDefine("OFFSET_Z_R",N.get()=="R");_.toggleDefine("OFFSET_Z_G",N.get()=="G");_.toggleDefine("OFFSET_Z_B",N.get()=="B");_.toggleDefine("RANGE_MIN1",u.get()=="-1-1");C.setUiAttribs({greyout:!O.isLinked()});P.setUiAttribs({greyout:!O.isLinked()});N.setUiAttribs({greyout:!O.isLinked()});R.setUiAttribs({greyout:!O.isLinked()});_.toggleDefine("RGB",o.get()=="RGB")}i.onTriggered=function(){if(!CGL.TextureEffect.checkOpInEffect(e,3))return;p.pushShader(_);p.currentTextureEffect.bind();F.setValue(p.currentTextureEffect.aspectRatio);p.setTexture(0,p.currentTextureEffect.getCurrentSourceTexture().tex);if(O.get())p.setTexture(1,O.get().tex);if(s.get())p.setTexture(2,s.get().tex);p.currentTextureEffect.finish();p.popShader();m.trigger()}}};CABLES.OPS["b4b238d3-db68-4206-8dc7-4b52433fc932"]={f:Ops.Gl.ImageCompose.Noise.PerlinNoise_v2,objName:"Ops.Gl.ImageCompose.Noise.PerlinNoise_v2"};Ops.Ui.VizTexture=class extends CABLES.Op{constructor(){super(...arguments);const w=this;const i=w.attachments={viztex_frag:"IN vec2 texCoord;\nUNI sampler2D tex;\nUNI samplerCube cubeMap;\nUNI float width;\nUNI float height;\nUNI float type;\nUNI float time;\n\nfloat LinearizeDepth(float d,float zNear,float zFar)\n{\n    float z_n = 2.0 * d - 1.0;\n    return 2.0 * zNear / (zFar + zNear - z_n * (zFar - zNear));\n}\n\nvoid main()\n{\n    vec4 col=vec4(vec3(0.),0.0);\n\n    vec4 colTex=texture(tex,texCoord);\n\n\n\n    if(type==1.0)\n    {\n        vec4 depth=vec4(0.);\n        vec2 localST=texCoord;\n        localST.y = 1. - localST.y;\n\n        localST.t = mod(localST.t*3.,1.);\n        localST.s = mod(localST.s*4.,1.);\n\n        #ifdef WEBGL2\n            #define texCube texture\n        #endif\n        #ifdef WEBGL1\n            #define texCube textureCube\n        #endif\n\n//         //Due to the way my depth-cubeMap is rendered, objects to the -x,y,z side is projected to the positive x,y,z side\n//         //Inside where top/bottom is to be drawn?\n        if (texCoord.s*4.> 1. && texCoord.s*4.<2.)\n        {\n            //Bottom (-y) quad\n            if (texCoord.t*3. < 1.)\n            {\n                vec3 dir=vec3(localST.s*2.-1.,-1.,-localST.t*2.+1.);//Due to the (arbitrary) way I choose as up in my depth-viewmatrix, i her emultiply the latter coordinate with -1\n                depth = texCube(cubeMap, dir);\n            }\n            //top (+y) quad\n            else if (texCoord.t*3. > 2.)\n            {\n                vec3 dir=vec3(localST.s*2.-1.,1.,localST.t*2.-1.);//Get lower y texture, which is projected to the +y part of my cubeMap\n                depth = texCube(cubeMap, dir);\n            }\n            else//Front (-z) quad\n            {\n                vec3 dir=vec3(localST.s*2.-1.,-localST.t*2.+1.,1.);\n                depth = texCube(cubeMap, dir);\n            }\n        }\n//         //If not, only these ranges should be drawn\n        else if (texCoord.t*3. > 1. && texCoord.t*3. < 2.)\n        {\n            if (texCoord.x*4. < 1.)//left (-x) quad\n            {\n                vec3 dir=vec3(-1.,-localST.t*2.+1.,localST.s*2.-1.);\n                depth = texCube(cubeMap, dir);\n            }\n            else if (texCoord.x*4. < 3.)//right (+x) quad (front was done above)\n            {\n                vec3 dir=vec3(1,-localST.t*2.+1.,-localST.s*2.+1.);\n                depth = texCube(cubeMap, dir);\n            }\n            else //back (+z) quad\n            {\n                vec3 dir=vec3(-localST.s*2.+1.,-localST.t*2.+1.,-1.);\n                depth = texCube(cubeMap, dir);\n            }\n        }\n        // colTex = vec4(vec3(depth),1.);\n        colTex = vec4(depth);\n    }\n\n    if(type==2.0)\n    {\n       float near = 0.1;\n       float far = 50.;\n       float depth = LinearizeDepth(colTex.r, near, far);\n       colTex.rgb = vec3(depth);\n    }\n\n\n\n\n    #ifdef ANIM_RANGE\n\n        if(colTex.r>1.0 || colTex.r<0.0)\n            colTex.r=mod(colTex.r,1.0)*0.5+(sin(colTex.r+mod(colTex.r*3.0,1.0)+time*5.0)*0.5+0.5)*0.5;\n        if(colTex.g>1.0 || colTex.g<0.0)\n            colTex.g=mod(colTex.g,1.0)*0.5+(sin(colTex.g+mod(colTex.g*3.0,1.0)+time*5.0)*0.5+0.5)*0.5;\n        if(colTex.b>1.0 || colTex.b<0.0)\n            colTex.b=mod(colTex.b,1.0)*0.5+(sin(colTex.b+mod(colTex.b*3.0,1.0)+time*5.0)*0.5+0.5)*0.5;\n\n    #endif\n\n\n    // #ifdef ANIM_RANGE\n    //     if(colTex.r>1.0 || colTex.r<0.0)\n    //     {\n    //         float r=mod( time+colTex.r,1.0)*0.5+0.5;\n    //         colTex.r=r;\n    //     }\n    //     if(colTex.g>1.0 || colTex.g<0.0)\n    //     {\n    //         float r=mod( time+colTex.g,1.0)*0.5+0.5;\n    //         colTex.g=r;\n    //     }\n    //     if(colTex.b>1.0 || colTex.b<0.0)\n    //     {\n    //         float r=mod( time+colTex.b,1.0)*0.5+0.5;\n    //         colTex.b=r;\n    //     }\n    // #endif\n\n    #ifdef MOD_RANGE\n        colTex.r=mod(colTex.r,1.0001);\n        colTex.g=mod(colTex.g,1.0001);\n        colTex.b=mod(colTex.b,1.0001);\n\n    #endif\n\n    #ifdef ALPHA_ONE\n        colTex.a=1.0;\n    #endif\n    #ifdef ALPHA_INV\n        colTex.a=1.0-colTex.a;\n    #endif\n\n    outColor = mix(col,colTex,colTex.a);\n}\n\n",viztex_vert:"IN vec3 vPosition;\nIN vec2 attrTexCoord;\nOUT vec2 texCoord;\nUNI mat4 projMatrix;\nUNI mat4 modelMatrix;\nUNI mat4 viewMatrix;\n\nvoid main()\n{\n    texCoord=vec2(attrTexCoord.x,1.0-attrTexCoord.y);\n    vec4 pos = vec4( vPosition, 1. );\n    mat4 mvMatrix=viewMatrix * modelMatrix;\n    gl_Position = projMatrix * mvMatrix * pos;\n}"};const B=w.inTexture("Texture In"),V=w.inBool("Show Info",false),e=w.inSwitch("Visualize outside 0-1",["Off","Anim","Modulo"],"Anim"),t=w.inSwitch("Alpha",["A","1","1-A"],"A"),k=w.inBool("Show Color",false),G=w.inFloatSlider("X",.5),j=w.inFloatSlider("Y",.5),s=w.outTexture("Texture Out"),H=w.outString("Info");w.setUiAttrib({height:150,resizable:true});const z=new CABLES.Timer;let r=null;let X=null;let Y=null;let W="";let n=true;t.onChange=e.onChange=o;k.onChange=a;a();if(CABLES.UI){z.play()}function a(){G.setUiAttribs({greyout:!k.get()});j.setUiAttribs({greyout:!k.get()})}B.onChange=()=>{const e=B.get();s.setRef(e);let t="";if(B.get()&&B.isLinked())t=B.links[0].getOtherPort(B).name;w.setUiAttrib({extendTitle:t})};function o(){if(!r)return;r.toggleDefine("MOD_RANGE",e.get()=="Modulo");r.toggleDefine("ANIM_RANGE",e.get()=="Anim");r.toggleDefine("ALPHA_INV",t.get()=="1-A");r.toggleDefine("ALPHA_ONE",t.get()=="1")}w.renderVizLayerGl=(c,f)=>{if(!B.isLinked())return;if(!f.useGl)return;const g=B;const d=5;const m=d+1;const e=gui.uiProfiler.start("previewlayer texture");const p=g.op.patch.cgl;if(!this._emptyCubemap)this._emptyCubemap=CGL.Texture.getEmptyCubemapTexture(p);g.op.patch.cgl.profileData.profileTexPreviews++;const _=g.get()||CGL.Texture.getEmptyTexture(p);if(!this._mesh){const t=new CGL.Geometry("vizTexture rect");t.vertices=[1,1,0,-1,1,0,1,-1,0,-1,-1,0];t.texCoords=[1,1,0,1,1,0,0,0];t.verticesIndices=[0,1,2,3,1,2];this._mesh=new CGL.Mesh(p,t)}if(!this._shader){this._shader=new CGL.Shader(p,"glpreviewtex");this._shader.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_BEGIN_FRAG"]);this._shader.setSource(i.viztex_vert,i.viztex_frag);this._shaderTexUniform=new CGL.Uniform(this._shader,"t","tex",d);this._shaderTexCubemapUniform=new CGL.Uniform(this._shader,"tc","cubeMap",m);r=this._shader;o();this._shaderTexUniformW=new CGL.Uniform(this._shader,"f","width",_.width);this._shaderTexUniformH=new CGL.Uniform(this._shader,"f","height",_.height);this._shaderTypeUniform=new CGL.Uniform(this._shader,"f","type",0);this._shaderTimeUniform=new CGL.Uniform(this._shader,"f","time",0)}p.pushPMatrix();const v=[_.width,_.height];const E=g.op.patch.cgl.canvasWidth>v[0]&&g.op.patch.cgl.canvasHeight>v[1];if(E){mat4.ortho(p.pMatrix,0,g.op.patch.cgl.canvasWidth,g.op.patch.cgl.canvasHeight,0,.001,11)}else mat4.ortho(p.pMatrix,-1,1,1,-1,.001,11);const b=p.getTexture(d);const x=p.getTexture(m);let T=0;if(_){if(_.cubemap)T=1;if(_.textureType==CGL.Texture.TYPE_DEPTH)T=2;if(T==0||T==2){p.setTexture(d,_.tex);p.setTexture(m,this._emptyCubemap.cubemap,p.gl.TEXTURE_CUBE_MAP)}else if(T==1){p.setTexture(m,_.cubemap,p.gl.TEXTURE_CUBE_MAP)}z.update();this._shaderTimeUniform.setValue(z.get());this._shaderTypeUniform.setValue(T);let t=[g.op.patch.cgl.canvasWidth,g.op.patch.cgl.canvasHeight];p.gl.clearColor(0,0,0,0);p.gl.clear(p.gl.COLOR_BUFFER_BIT|p.gl.DEPTH_BUFFER_BIT);p.pushModelMatrix();if(E){t=v;mat4.translate(p.mMatrix,p.mMatrix,[v[0]/2,v[1]/2,0]);mat4.scale(p.mMatrix,p.mMatrix,[v[0]/2,v[1]/2,0])}this._mesh.render(this._shader);p.popModelMatrix();if(T==0)p.setTexture(d,b);if(T==1)p.setTexture(m,x);p.popPMatrix();p.resetViewPort();const A=[f.width,f.height];const S=false;if(_.width>_.height)A[1]=f.width*v[1]/v[0];else{A[1]=f.width*(v[1]/v[0]);if(A[1]>f.height){const R=f.height/A[1];A[0]*=R;A[1]*=R}}const M=A[0]>v[0]&&A[1]>v[1];c.imageSmoothingEnabled=true;c.fillStyle="#ffffff";c.fillRect(f.x,f.y-10,10,10);c.fillStyle="#000000";c.fillRect(f.x,f.y-10,5,5);c.fillRect(f.x+5,f.y-10+5,5,5);let e=f.height;let i=10*f.width/e*f.scale*2;let s=i*f.height/f.width;let r=e/s;let n=f.width/i;for(let t=0;t<i+1;t++)for(let e=0;e<s+1;e++){if((t+e)%2==0)c.fillStyle="#333333";else c.fillStyle="#393939";c.fillRect(f.x-f.x%n*2+n*t,f.y-f.y%n*2+r*e,n,r)}c.fillStyle="#222";const I=(f.width-A[0])/2;const O=(e-A[1])/2;let a=f.x+(f.width-A[0])/2;let o=f.y+(e-A[1])/2;let l=A[0];let h=A[1];if(e-A[1]<0){a=f.x+(f.width-A[0]*e/A[1])/2;o=f.y;l=A[0]*e/A[1];h=e}c.fillRect(f.x,f.y,a-f.x,e);c.fillRect(f.x+l+a-f.x,f.y,l,e);c.fillRect(f.x,f.y,f.width,O);c.fillRect(f.x,f.y+A[1]+O,f.width,O);if(p.canvas&&p.canvasWidth>0&&p.canvasHeight>0&&p.canvas.width>0&&p.canvas.height>0){try{const C=l/t[0]>3||h/t[1]>3;const P=l/t[0]>10||h/t[1]>10;if(v[1]==1){c.imageSmoothingEnabled=false;c.drawImage(p.canvas,0,0,t[0],t[1],f.x,f.y,f.width,e);c.imageSmoothingEnabled=true}else if(v[0]==1){c.imageSmoothingEnabled=false;c.drawImage(p.canvas,0,0,t[0],t[1],f.x,f.y,f.width,e);c.imageSmoothingEnabled=true}else if(A[0]!=0&&A[1]!=0&&f.width!=0&&e!=0&&l!=0&&h!=0){c.imageSmoothingEnabled=!C;c.drawImage(p.canvas,0,0,t[0],t[1],a,o,l,h)}if(P){const N=l/t[0];const F=h/t[1];c.imageSmoothingEnabled=true;c.lineWidth=1;c.globalAlpha=.5;c.beginPath();for(let e=0;e<=t[0];e++){c.moveTo(a+e*N,o);c.lineTo(a+e*N,o+h)}for(let e=0;e<=t[1];e++){c.moveTo(a,o+e*F);c.lineTo(a+l,o+e*F)}c.strokeStyle="#555";c.stroke();c.globalAlpha=1}}catch(e){console.error("canvas drawimage exception...",e)}}let u="";if(V.get()&&g.get()&&g.get().getInfoOneLine)u+=g.get().getInfoOneLine()+"\n";H.set(u);if(k.get()){u+=W+"\n";const L=a+l*G.get();const D=o+h*j.get();for(let e=0;e<2;e++){if(e==0)c.fillStyle="#000";else c.fillStyle="#fff";c.fillRect(L-1+e,D-10+e,1,20);c.fillRect(L-10+e,D-1+e,20,1)}}if(V.get()||k.get()){w.setUiAttrib({comment:u})}if(k.get()){const y=p.gl;const U=B.get();if(!U){W="";return}if(!X)X=y.createFramebuffer();if(!Y)Y=new CGL.PixelReader;y.bindFramebuffer(y.FRAMEBUFFER,X);y.framebufferTexture2D(y.FRAMEBUFFER,y.COLOR_ATTACHMENT0,y.TEXTURE_2D,U.tex,0);y.bindFramebuffer(y.FRAMEBUFFER,null);Y.read(p,X,U.pixelFormat,G.get()*U.width,U.height-j.get()*U.height,1,1,e=>{if(!CGL.Texture.isPixelFormatFloat(U.pixelFormat)){W="Pixel Float: "+Math.floor(e[0]/255*100)/100;if(!isNaN(e[1]))W+=", "+Math.floor(e[1]/255*100)/100;if(!isNaN(e[2]))W+=", "+Math.floor(e[2]/255*100)/100;if(!isNaN(e[3]))W+=", "+Math.floor(e[3]/255*100)/100;W+="\n";if(U.pixelFormat.indexOf("ubyte")>0){W+="Pixel UByte: ";W+=Math.round(e[0]);if(!isNaN(e[1]))W+=", "+Math.round(e[1]);if(!isNaN(e[2]))W+=", "+Math.round(e[2]);if(!isNaN(e[3]))W+=", "+Math.round(e[3]);W+="\n"}}else{W="Pixel Float: "+Math.round(e[0]*100)/100+", "+Math.round(e[1]*100)/100+", "+Math.round(e[2]*100)/100+", "+Math.round(e[3]*100)/100;W+="\n"}})}}p.gl.clearColor(0,0,0,0);p.gl.clear(p.gl.COLOR_BUFFER_BIT|p.gl.DEPTH_BUFFER_BIT);e.finish()}}};CABLES.OPS["4ea2d7b0-ca74-45db-962b-4d1965ac20c0"]={f:Ops.Ui.VizTexture,objName:"Ops.Ui.VizTexture"};Ops.Gl.Texture_v2=class extends CABLES.Op{constructor(){super(...arguments);const r=this;const e=r.attachments={};const n=r.inUrl("File",[".jpg",".png",".webp",".jpeg",".avif"]),t=r.inSwitch("Filter",["nearest","linear","mipmap"]),i=r.inValueSelect("Wrap",["repeat","mirrored repeat","clamp to edge"],"clamp to edge"),s=r.inSwitch("Anisotropic",["0","1","2","4","8","16"],"0"),a=r.inSwitch("Data Format",["R","RG","RGB","RGBA","SRGBA"],"RGBA"),o=r.inValueBool("Flip",false),l=r.inValueBool("Pre Multiplied Alpha",false),h=r.inValueBool("Active",true),u=r.inBool("Save Memory",true),c=r.outTexture("Texture"),f=r.inBool("Add Cachebuster",false),g=r.inTriggerButton("Reload"),d=r.outNumber("Width"),m=r.outNumber("Height"),p=r.outNumber("Aspect Ratio"),_=r.outBoolNum("Loaded",0),v=r.outBoolNum("Loading",0);const E=r.patch.cgl;r.toWorkPortsNeedToBeLinked(c);r.setPortGroup("Size",[d,m]);let b=null;let x=null;let T=null;let A=CGL.Texture.FILTER_MIPMAP;let S=CGL.Texture.WRAP_REPEAT;let M=0;let I=0;l.setUiAttribs({hidePort:true});l.onChange=n.onChange=a.onChange=f.onChange=o.onChange=R;s.onChange=t.onChange=N;i.onChange=F;t.set("mipmap");i.set("repeat");c.setRef(CGL.Texture.getEmptyTexture(E));g.onTriggered=R;h.onChange=function(){if(h.get()){if(b!=n.get()||!T)R();else c.setRef(T)}else{c.setRef(CGL.Texture.getEmptyTexture(E));d.set(CGL.Texture.getEmptyTexture(E).width);m.set(CGL.Texture.getEmptyTexture(E).height);if(T)T.delete();r.setUiAttrib({extendTitle:""});T=null}};const O=function(){const e=CGL.Texture.getTempTexture(E);c.setRef(e)};function R(e){clearTimeout(I);I=setTimeout(function(){P(e)},1)}function C(){if(a.get()=="R")return CGL.Texture.PFORMATSTR_R8UB;if(a.get()=="RG")return CGL.Texture.PFORMATSTR_RG8UB;if(a.get()=="RGB")return CGL.Texture.PFORMATSTR_RGB8UB;if(a.get()=="SRGBA")return CGL.Texture.PFORMATSTR_SRGBA8;return CGL.Texture.PFORMATSTR_RGBA8UB}function P(e){r.checkMainloopExists();if(!h.get())return;if(x)x=E.patch.loading.finished(x);x=E.patch.loading.start(r.objName,n.get(),r);let t=r.patch.getFilePath(String(n.get()));if(f.get()||e===true)t=CABLES.cacheBust(t);if(String(n.get()).indexOf("data:")==0)t=n.get();let i=false;b=n.get();if(n.get()&&n.get().length>1){_.set(false);v.set(true);const s=n.get();r.setUiAttrib({extendTitle:CABLES.basename(t)});if(i)r.refreshParams();E.patch.loading.addAssetLoadingTask(()=>{r.setUiError("urlerror",null);CGL.Texture.load(E,t,function(e,t){if(n.get()!=s){x=E.patch.loading.finished(x);return}if(T)T.delete();if(e){const i=CGL.Texture.getErrorTexture(E);c.setRef(i);r.setUiError("urlerror",'could not load texture: "'+n.get()+'"',2);x=E.patch.loading.finished(x);return}d.set(t.width);m.set(t.height);p.set(t.width/t.height);T=t;c.setRef(T);v.set(false);_.set(true);if(u.get())T.image=null;if(x){x=E.patch.loading.finished(x)}r.checkMainloopExists()},{anisotropic:M,wrap:S,flip:o.get(),unpackAlpha:l.get(),pixelFormat:C(),filter:A});r.checkMainloopExists()})}else{O();x=E.patch.loading.finished(x)}}function N(){if(t.get()=="nearest")A=CGL.Texture.FILTER_NEAREST;else if(t.get()=="linear")A=CGL.Texture.FILTER_LINEAR;else if(t.get()=="mipmap")A=CGL.Texture.FILTER_MIPMAP;else if(t.get()=="Anisotropic")A=CGL.Texture.FILTER_ANISOTROPIC;s.setUiAttribs({greyout:A!=CGL.Texture.FILTER_MIPMAP});M=parseFloat(s.get());R()}function F(){if(i.get()=="repeat")S=CGL.Texture.WRAP_REPEAT;if(i.get()=="mirrored repeat")S=CGL.Texture.WRAP_MIRRORED_REPEAT;if(i.get()=="clamp to edge")S=CGL.Texture.WRAP_CLAMP_TO_EDGE;R()}r.onFileChanged=function(e){if(n.get()&&n.get().indexOf(e)>-1){c.setRef(CGL.Texture.getEmptyTexture(r.patch.cgl));c.setRef(CGL.Texture.getTempTexture(E));P(true)}}}};CABLES.OPS["790f3702-9833-464e-8e37-6f0f813f7e16"]={f:Ops.Gl.Texture_v2,objName:"Ops.Gl.Texture_v2"};Ops.Graphics.Meshes.Circle_v3=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inTrigger("render"),P=e.inValue("radius",.5),N=e.inValueSlider("innerRadius",0),F=e.inValueInt("segments",40),L=e.inValueSlider("percent",1),D=e.inValue("steps",0),y=e.inValueBool("invertSteps",false),U=e.inSwitch("mapping",["flat","round"]),w=e.inValueBool("Spline",false),s=e.inValueBool("Draw",true),r=e.outTrigger("trigger"),B=e.outObject("geometry",null,"geometry");e.setPortGroup("Size",[P,N]);e.setPortGroup("Display",[L,D,y]);e.toWorkShouldNotBeChild("Ops.Gl.TextureEffects.ImageCompose",CABLES.OP_PORT_TYPE_FUNCTION);s.setUiAttribs({title:"Render mesh"});U.set("flat");U.onChange=F.onChange=P.onChange=N.onChange=L.onChange=D.onChange=y.onChange=w.onChange=c;B.ignoreValueSerialize=true;const n=e.patch.cgl;let V=new CGL.Geometry("circle");let k=null;const a=-1;let o=0;let l=null;let G=true;i.onTriggered=h;e.onDelete=function(){if(k)k.dispose()};e.preRender=()=>{h()};i.onLinkChanged=function(){if(!i.isLinked())B.set(null);else B.setRef(V)};function h(){if(!e.patch.cg)return;if(G)u();if(!CGL.TextureEffect.checkOpNotInTextureEffect(e))return;l=e.patch.cg.getShader();if(!l)return;o=l.glPrimitive;if(w.get())l.glPrimitive=n.gl.LINE_STRIP;if(s.get()&&k){k.render(l)}r.trigger();l.glPrimitive=o}function u(){const i=Math.max(3,Math.floor(F.get()));V.clear();const t=[];const s=[];const r=[];const n=[];const a=[];let o=0,l=0;let h=0,u=0;let c=0,f=0;let g=0,d=0;let m=0,p=0;let _=0,v=0;let E=0,b=0;let x=0,T=0;const A=Math.max(0,L.get());const S=[];if(w.get()){let e=0;let t=0;const M=[];for(o=0;o<=i*A;o++){l=360/i*o*CGL.DEG2RAD;x=Math.cos(l)*P.get();T=Math.sin(l)*P.get();b=.5;if(o>0){S.push(e);S.push(t);S.push(0);E=1-(o-1)/i;M.push(E,b)}S.push(x);S.push(T);S.push(0);e=x;t=T}V.setPointVertices(S)}else if(N.get()<=0){for(o=0;o<=i*A;o++){l=360/i*o*CGL.DEG2RAD;x=Math.cos(l)*P.get();T=Math.sin(l)*P.get();if(U.get()=="flat"){E=(Math.cos(l)+1)/2;b=1-(Math.sin(l)+1)/2;_=.5;v=.5}else if(U.get()=="round"){E=1-o/i;b=0;_=E;v=1}t.push([0,0,0],[h,u,0],[x,T,0]);s.push(_,v,c,f,E,b);r.push(0,0,1,0,0,1,0,0,1);n.push(1,0,0,1,0,0,1,0,0);a.push(0,-1,0,0,-1,0,0,-1,0);c=E;f=b;h=x;u=T}V=CGL.Geometry.buildFromFaces(t,"circle");V.vertexNormals=r;V.tangents=n;V.biTangents=a;V.texCoords=s}else{let e=0;const I=i*A;const O=0;for(o=0;o<=I;o++){e++;l=360/i*o*CGL.DEG2RAD;x=Math.cos(l)*P.get();T=Math.sin(l)*P.get();const R=Math.cos(l)*N.get()*P.get();const C=Math.sin(l)*N.get()*P.get();if(U.get()=="round"){E=1-o/i;b=0;_=E;v=1}if(D.get()===0||e%parseInt(D.get(),10)===0&&!y.get()||e%parseInt(D.get(),10)!==0&&y.get()){t.push([R,C,0],[h,u,0],[x,T,0]);t.push([g,d,0],[h,u,0],[R,C,0]);s.push(E,0,c,0,_,1,E,1,c,0,m,1);r.push(0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1);n.push(1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0);a.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1)}m=_;p=v;c=E;f=b;h=x;u=T;g=R;d=C}V=CGL.Geometry.buildFromFaces(t,"circle");V.vertexNormals=r;V.tangents=n;V.biTangents=a;if(U.get()=="flat")V.mapTexCoords2d();else V.texCoords=s}B.setRef(V);if(V.vertices.length==0)return;if(k)k.dispose();k=null;if(e.patch.cg)k=e.patch.cg.createMesh(V,{opId:e.id});G=false}function c(){G=true}}};CABLES.OPS["ae07830b-91c3-4cbe-a7d6-d3b737392c16"]={f:Ops.Graphics.Meshes.Circle_v3,objName:"Ops.Graphics.Meshes.Circle_v3"};Ops.Graphics.Transform=class extends CABLES.Op{constructor(){super(...arguments);const i=this;const e=i.attachments={};const t=i.inTrigger("render"),s=i.inValue("posX",0),r=i.inValue("posY",0),n=i.inValue("posZ",0),a=i.inValue("scale",1),o=i.inValue("rotX",0),l=i.inValue("rotY",0),h=i.inValue("rotZ",0),u=i.outTrigger("trigger");i.setPortGroup("Rotation",[o,l,h]);i.setPortGroup("Position",[s,r,n]);i.setPortGroup("Scale",[a]);i.setUiAxisPorts(s,r,n);i.toWorkPortsNeedToBeLinked(t,u);const c=vec3.create();const f=vec3.create();const g=mat4.create();mat4.identity(g);let d=false,m=false,p=true,_=true,v=true;o.onChange=l.onChange=h.onChange=S;s.onChange=r.onChange=n.onChange=T;a.onChange=A;t.onTriggered=function(){let e=false;if(p){b();e=true}if(_){x();e=true}if(v)e=true;if(e)E();const t=i.patch.cg||i.patch.cgl;t.pushModelMatrix();mat4.multiply(t.mMatrix,t.mMatrix,g);u.trigger();t.popModelMatrix();if(CABLES.UI){if(!s.isLinked()&&!r.isLinked()&&!n.isLinked()){gui.setTransform(i.id,s.get(),r.get(),n.get());if(i.isCurrentUiOp())gui.setTransformGizmo({posX:s,posY:r,posZ:n})}}};function E(){mat4.identity(g);if(m)mat4.translate(g,g,c);if(o.get()!==0)mat4.rotateX(g,g,o.get()*CGL.DEG2RAD);if(l.get()!==0)mat4.rotateY(g,g,l.get()*CGL.DEG2RAD);if(h.get()!==0)mat4.rotateZ(g,g,h.get()*CGL.DEG2RAD);if(d)mat4.scale(g,g,f);v=false}function b(){m=false;if(s.get()!==0||r.get()!==0||n.get()!==0)m=true;vec3.set(c,s.get(),r.get(),n.get());p=false}function x(){d=true;vec3.set(f,a.get(),a.get(),a.get());_=false}function T(){p=true}function A(){_=true}function S(){v=true}E()}};CABLES.OPS["650baeb1-db2d-4781-9af6-ab4e9d4277be"]={f:Ops.Graphics.Transform,objName:"Ops.Graphics.Transform"};Ops.Gl.Shader.BasicMaterial_v3=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={basicmaterial_frag:"{{MODULES_HEAD}}\n\nIN vec2 texCoord;\n\n#ifdef VERTEX_COLORS\nIN vec4 vertCol;\n#endif\n\n#ifdef HAS_TEXTURES\n    IN vec2 texCoordOrig;\n    #ifdef HAS_TEXTURE_DIFFUSE\n        UNI sampler2D tex;\n    #endif\n    #ifdef HAS_TEXTURE_OPACITY\n        UNI sampler2D texOpacity;\n   #endif\n#endif\n\n\n\nvoid main()\n{\n    {{MODULE_BEGIN_FRAG}}\n    vec4 col=color;\n\n\n    #ifdef HAS_TEXTURES\n        vec2 uv=texCoord;\n\n        #ifdef CROP_TEXCOORDS\n            if(uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) discard;\n        #endif\n\n        #ifdef HAS_TEXTURE_DIFFUSE\n            col=texture(tex,uv);\n\n            #ifdef COLORIZE_TEXTURE\n                col.r*=color.r;\n                col.g*=color.g;\n                col.b*=color.b;\n            #endif\n        #endif\n        col.a*=color.a;\n        #ifdef HAS_TEXTURE_OPACITY\n            #ifdef TRANSFORMALPHATEXCOORDS\n                uv=texCoordOrig;\n            #endif\n            #ifdef ALPHA_MASK_IR\n                col.a*=1.0-texture(texOpacity,uv).r;\n            #endif\n            #ifdef ALPHA_MASK_IALPHA\n                col.a*=1.0-texture(texOpacity,uv).a;\n            #endif\n            #ifdef ALPHA_MASK_ALPHA\n                col.a*=texture(texOpacity,uv).a;\n            #endif\n            #ifdef ALPHA_MASK_LUMI\n                col.a*=dot(vec3(0.2126,0.7152,0.0722), texture(texOpacity,uv).rgb);\n            #endif\n            #ifdef ALPHA_MASK_R\n                col.a*=texture(texOpacity,uv).r;\n            #endif\n            #ifdef ALPHA_MASK_G\n                col.a*=texture(texOpacity,uv).g;\n            #endif\n            #ifdef ALPHA_MASK_B\n                col.a*=texture(texOpacity,uv).b;\n            #endif\n            // #endif\n        #endif\n    #endif\n\n    {{MODULE_COLOR}}\n\n    #ifdef DISCARDTRANS\n        if(col.a<0.2) discard;\n    #endif\n\n    #ifdef VERTEX_COLORS\n        col*=vertCol;\n    #endif\n\n    outColor = col;\n}\n",basicmaterial_vert:"\n{{MODULES_HEAD}}\n\nOUT vec2 texCoord;\nOUT vec2 texCoordOrig;\n\nUNI mat4 projMatrix;\nUNI mat4 modelMatrix;\nUNI mat4 viewMatrix;\n\n#ifdef HAS_TEXTURES\n    UNI float diffuseRepeatX;\n    UNI float diffuseRepeatY;\n    UNI float texOffsetX;\n    UNI float texOffsetY;\n#endif\n\n#ifdef VERTEX_COLORS\n    in vec4 attrVertColor;\n    out vec4 vertCol;\n\n#endif\n\n\nvoid main()\n{\n    mat4 mMatrix=modelMatrix;\n    mat4 modelViewMatrix;\n\n    norm=attrVertNormal;\n    texCoordOrig=attrTexCoord;\n    texCoord=attrTexCoord;\n    #ifdef HAS_TEXTURES\n        texCoord.x=texCoord.x*diffuseRepeatX+texOffsetX;\n        texCoord.y=(1.0-texCoord.y)*diffuseRepeatY+texOffsetY;\n    #endif\n\n    #ifdef VERTEX_COLORS\n        vertCol=attrVertColor;\n    #endif\n\n    vec4 pos = vec4(vPosition, 1.0);\n\n    #ifdef BILLBOARD\n       vec3 position=vPosition;\n       modelViewMatrix=viewMatrix*modelMatrix;\n\n       gl_Position = projMatrix * modelViewMatrix * vec4((\n           position.x * vec3(\n               modelViewMatrix[0][0],\n               modelViewMatrix[1][0],\n               modelViewMatrix[2][0] ) +\n           position.y * vec3(\n               modelViewMatrix[0][1],\n               modelViewMatrix[1][1],\n               modelViewMatrix[2][1]) ), 1.0);\n    #endif\n\n    {{MODULE_VERTEX_POSITION}}\n\n    #ifndef BILLBOARD\n        modelViewMatrix=viewMatrix * mMatrix;\n\n        {{MODULE_VERTEX_MODELVIEW}}\n\n    #endif\n\n    // mat4 modelViewMatrix=viewMatrix*mMatrix;\n\n    #ifndef BILLBOARD\n        // gl_Position = projMatrix * viewMatrix * modelMatrix * pos;\n        gl_Position = projMatrix * modelViewMatrix * pos;\n    #endif\n}\n"};const i=e.inTrigger("render");const s=e.outTrigger("trigger");const r=e.outObject("shader",null,"shader");r.ignoreValueSerialize=true;e.toWorkPortsNeedToBeLinked(i);e.toWorkShouldNotBeChild("Ops.Gl.TextureEffects.ImageCompose",CABLES.OP_PORT_TYPE_FUNCTION);const n=e.patch.cgl;const a=new CGL.Shader(n,"basicmaterial",this);a.addAttribute({type:"vec3",name:"vPosition"});a.addAttribute({type:"vec2",name:"attrTexCoord"});a.addAttribute({type:"vec3",name:"attrVertNormal",nameFrag:"norm"});a.addAttribute({type:"float",name:"attrVertIndex"});a.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_BEGIN_FRAG","MODULE_VERTEX_MODELVIEW"]);a.setSource(t.basicmaterial_vert,t.basicmaterial_frag);r.setRef(a);i.onTriggered=O;const o=e.inValueSlider("r",Math.random());const l=e.inValueSlider("g",Math.random());const h=e.inValueSlider("b",Math.random());const u=e.inValueSlider("a",1);o.setUiAttribs({colorPick:true});const c=a.addUniformFrag("4f","color",o,l,h,u);a.uniformColorDiffuse=c;const f=e.inTexture("texture");let g=null;f.onChange=C;const d=e.inValueBool("colorizeTexture",false);const m=e.inValueBool("Vertex Colors",false);const p=e.inTexture("textureOpacity");let _=null;const v=e.inSwitch("Alpha Mask Source",["Luminance","R","G","B","A","1-A","1-R"],"Luminance");v.setUiAttribs({greyout:true});p.onChange=R;const E=e.inValueBool("Opacity TexCoords Transform",false);const b=e.inValueBool("Discard Transparent Pixels");const x=e.inValue("diffuseRepeatX",1),T=e.inValue("diffuseRepeatY",1),A=e.inValue("Tex Offset X",0),S=e.inValue("Tex Offset Y",0),M=e.inBool("Crop TexCoords",false);a.addUniformFrag("f","diffuseRepeatX",x);a.addUniformFrag("f","diffuseRepeatY",T);a.addUniformFrag("f","texOffsetX",A);a.addUniformFrag("f","texOffsetY",S);const I=e.inValueBool("billboard",false);v.onChange=I.onChange=b.onChange=E.onChange=M.onChange=m.onChange=d.onChange=N;e.setPortGroup("Color",[o,l,h,u]);e.setPortGroup("Color Texture",[f,m,d]);e.setPortGroup("Opacity",[p,v,b,E]);e.setPortGroup("Texture Transform",[x,T,A,S,M]);R();C();e.preRender=function(){a.bind();O();if(!a)return};function O(){e.checkGraphicsApi();n.pushShader(a);a.popTextures();if(g&&f.get())a.pushTexture(g,f.get());if(_&&p.get())a.pushTexture(_,p.get());s.trigger();n.popShader()}function R(){if(p.get()){if(_!==null)return;a.removeUniform("texOpacity");a.define("HAS_TEXTURE_OPACITY");if(!_)_=new CGL.Uniform(a,"t","texOpacity")}else{a.removeUniform("texOpacity");a.removeDefine("HAS_TEXTURE_OPACITY");_=null}N()}function C(){if(f.get()){if(!a.hasDefine("HAS_TEXTURE_DIFFUSE"))a.define("HAS_TEXTURE_DIFFUSE");if(!g)g=new CGL.Uniform(a,"t","texDiffuse")}else{a.removeUniform("texDiffuse");a.removeDefine("HAS_TEXTURE_DIFFUSE");g=null}P()}function P(){const e=f.isLinked()||p.isLinked();x.setUiAttribs({greyout:!e});T.setUiAttribs({greyout:!e});A.setUiAttribs({greyout:!e});S.setUiAttribs({greyout:!e});d.setUiAttribs({greyout:!e});v.setUiAttribs({greyout:!p.get()});E.setUiAttribs({greyout:!p.get()});let t=true;t=f.get()&&!d.get();o.setUiAttribs({greyout:t});l.setUiAttribs({greyout:t});h.setUiAttribs({greyout:t})}function N(){a.toggleDefine("VERTEX_COLORS",m.get());a.toggleDefine("CROP_TEXCOORDS",M.get());a.toggleDefine("COLORIZE_TEXTURE",d.get());a.toggleDefine("TRANSFORMALPHATEXCOORDS",E.get());a.toggleDefine("DISCARDTRANS",b.get());a.toggleDefine("BILLBOARD",I.get());a.toggleDefine("ALPHA_MASK_ALPHA",v.get()=="A");a.toggleDefine("ALPHA_MASK_IALPHA",v.get()=="1-A");a.toggleDefine("ALPHA_MASK_IR",v.get()=="1-R");a.toggleDefine("ALPHA_MASK_LUMI",v.get()=="Luminance");a.toggleDefine("ALPHA_MASK_R",v.get()=="R");a.toggleDefine("ALPHA_MASK_G",v.get()=="G");a.toggleDefine("ALPHA_MASK_B",v.get()=="B");P()}}};CABLES.OPS["ec55d252-3843-41b1-b731-0482dbd9e72b"]={f:Ops.Gl.Shader.BasicMaterial_v3,objName:"Ops.Gl.Shader.BasicMaterial_v3"};Ops.Ui.Routing.RouteObject=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inObject("Array In",""),s=e.outObject("Array Out");e.setUiAttribs({display:"reroute"});i.onChange=r;s.onLinkChanged=i.onLinkChanged=()=>{i.copyLinkedUiAttrib("objType",s)};function r(){s.setRef(i.get())}}};CABLES.OPS["c9b14538-bcd7-4559-9f61-c0d5a96b0ba8"]={f:Ops.Ui.Routing.RouteObject,objName:"Ops.Ui.Routing.RouteObject"};Ops.Gl.CanvasInfo_v3=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.outNumber("CSS Width"),s=t.outNumber("CSS Height"),r=t.outNumber("Pixel Ratio"),n=t.outNumber("Pixel Width"),a=t.outNumber("Pixel Height"),o=t.outNumber("Aspect Ratio"),l=t.outBool("Landscape"),h=t.outObject("Canvas","element"),u=t.outObject("Canvas Parent","element"),c=t.outTrigger("Resized");let f=t.patch.cgl;h.set(t.patch.cgl.canvas);u.set(t.patch.cgl.canvas.parentElement);f.on("resize",()=>{c.trigger();g()});g();function g(){let e=1;if(f.canvasHeight==0)setTimeout(g,100);s.set(f.canvasHeight/t.patch.cgl.pixelDensity);i.set(f.canvasWidth/t.patch.cgl.pixelDensity);n.set(f.canvasWidth);a.set(f.canvasHeight);r.set(t.patch.cgl.pixelDensity);o.set(f.canvasWidth/f.canvasHeight);l.set(f.canvasWidth>f.canvasHeight?1:0)}}};CABLES.OPS["be186ff9-427e-409f-b6a4-f8d957bf7bc7"]={f:Ops.Gl.CanvasInfo_v3,objName:"Ops.Gl.CanvasInfo_v3"};Ops.Math.Multiply=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValueFloat("number1",1),s=e.inValueFloat("number2",1),r=e.outNumber("result");e.setUiAttribs({mathTitle:true});i.onChange=s.onChange=n;n();function n(){const e=i.get();const t=s.get();r.set(e*t)}}};CABLES.OPS["1bbdae06-fbb2-489b-9bcc-36c9d65bd441"]={f:Ops.Math.Multiply,objName:"Ops.Math.Multiply"};Ops.Math.Divide=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValueFloat("number1",1),s=e.inValueFloat("number2",2),r=e.outNumber("result");e.setUiAttribs({mathTitle:true});i.onChange=s.onChange=n;n();function n(){r.set(i.get()/s.get())}}};CABLES.OPS["86fcfd8c-038d-4b91-9820-a08114f6b7eb"]={f:Ops.Math.Divide,objName:"Ops.Math.Divide"};Ops.Gl.ImageCompose.ChromaticAberration_v2=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={chromatic_frag:"IN vec2 texCoord;\nUNI sampler2D tex;\nUNI float pixel;\nUNI float onePixel;\nUNI float amount;\nUNI float lensDistort;\n\n#ifdef MASK\nUNI sampler2D texMask;\n#endif\n\n{{CGL.BLENDMODES3}}\n\nvoid main()\n{\n   vec4 base=texture(tex,texCoord);\n   vec4 col=texture(tex,texCoord);\n\n   vec2 tc=texCoord;;\n   float pix = pixel;\n   if(lensDistort>0.0)\n   {\n       float dist = distance(texCoord, vec2(0.5,0.5));\n       tc-=0.5;\n       tc *=smoothstep(-0.9,1.0*lensDistort,1.0-dist);\n       tc+=0.5;\n   }\n\n    #ifdef MASK\n        vec4 m=texture(texMask,texCoord);\n        pix*=m.r*m.a;\n    #endif\n\n    #ifdef SMOOTH\n    #ifdef WEBGL2\n        float numSamples=round(pix/onePixel/4.0+1.0);\n        col.r=0.0;\n        col.b=0.0;\n\n        for(float off=0.0;off<numSamples;off++)\n        {\n            float diff=(pix/numSamples)*off;\n            col.r+=texture(tex,vec2(tc.x+diff,tc.y)).r/numSamples;\n            col.b+=texture(tex,vec2(tc.x-diff,tc.y)).b/numSamples;\n        }\n    #endif\n    #endif\n\n    #ifndef SMOOTH\n        col.r=texture(tex,vec2(tc.x+pix,tc.y)).r;\n        col.b=texture(tex,vec2(tc.x-pix,tc.y)).b;\n    #endif\n\n   outColor= cgl_blendPixel(base,col,amount);\n\n}\n"};const i=t.inTrigger("render"),s=CGL.TextureEffect.AddBlendSelect(t,"Blend Mode","normal"),r=t.inValueSlider("Amount",1),n=t.inValue("Pixel",5),a=t.inValueSlider("Lens Distort",0),o=t.inValueBool("Smooth",false),l=t.inTexture("Mask"),h=t.outTrigger("trigger");const u=t.patch.cgl;const c=new CGL.Shader(u,"chromatic");CGL.TextureEffect.setupBlending(t,c,s,r);c.setSource(c.getDefaultVertexShader(),e.chromatic_frag);const f=new CGL.Uniform(c,"t","tex",0),g=new CGL.Uniform(c,"f","pixel",0),d=new CGL.Uniform(c,"f","onePixel",0),m=new CGL.Uniform(c,"t","texMask",1),p=new CGL.Uniform(c,"f","amount",r),_=new CGL.Uniform(c,"f","lensDistort",a);o.onChange=function(){if(o.get())c.define("SMOOTH");else c.removeDefine("SMOOTH")};l.onChange=function(){if(l.get())c.define("MASK");else c.removeDefine("MASK")};i.onTriggered=function(){if(!CGL.TextureEffect.checkOpInEffect(t,3))return;let e=u.currentTextureEffect.getCurrentSourceTexture();g.setValue(n.get()*(1/e.width));d.setValue(1/e.width);u.pushShader(c);u.currentTextureEffect.bind();u.setTexture(0,e.tex);if(l.get())u.setTexture(1,l.get().tex);u.currentTextureEffect.finish();u.popShader();h.trigger()}}};CABLES.OPS["07701f81-1a98-44c0-b1ef-592db3cbb5d3"]={f:Ops.Gl.ImageCompose.ChromaticAberration_v2,objName:"Ops.Gl.ImageCompose.ChromaticAberration_v2"};Ops.Gl.ImageCompose.BarrelDistortion_v3=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={barreldistort_frag:"IN vec2 texCoord;\nUNI sampler2D tex;\nUNI float amount;\nUNI float intensity;\n\n{{CGL.BLENDMODES3}}\n\n// adapted from https://www.shadertoy.com/view/MlSXR3\n\nvec2 brownConradyDistortion(vec2 uv)\n{\n// positive values of K1 give barrel distortion, negative give pincushion\n    float barrelDistortion1 = intensity*10.; // K1 in text books\n    float barrelDistortion2 = 0.; // K2 in text books\n    float r2 = uv.x*uv.x + uv.y*uv.y;\n    uv *= 1.0 + barrelDistortion1 * r2 + barrelDistortion2 * r2 * r2;\n\n    // tangential distortion (due to off center lens elements)\n    // is not modeled in this function, but if it was, the terms would go here\n    return uv;\n}\n\nvoid main()\n{\n    vec2 tc=brownConradyDistortion(texCoord-0.5)+0.5;\n    vec4 col=texture(tex,texCoord);\n    vec4 base=texture(tex,tc);\n\n    col.a=0.0;\n    outColor=cgl_blendPixel(col,base,amount);\n}"};const i=t.inTrigger("render"),s=CGL.TextureEffect.AddBlendSelect(t,"Blend Mode","normal"),r=t.inValueSlider("Amount",1),n=t.inValue("Intensity",10),a=t.outTrigger("Trigger");const o=t.patch.cgl;const l=new CGL.Shader(o,t.name,t);l.setSource(l.getDefaultVertexShader(),e.barreldistort_frag);const h=new CGL.Uniform(l,"t","tex",0),u=new CGL.Uniform(l,"f","intensity",0),c=new CGL.Uniform(l,"f","amount",r);CGL.TextureEffect.setupBlending(t,l,s,r);i.onTriggered=function(){if(!CGL.TextureEffect.checkOpInEffect(t,3))return;let e=o.currentTextureEffect.getCurrentSourceTexture();u.setValue(n.get()*(1/e.width));o.pushShader(l);o.currentTextureEffect.bind();o.setTexture(0,e.tex);o.currentTextureEffect.finish();o.popShader();a.trigger()}}};CABLES.OPS["d5efa9e4-d552-42f8-a345-d49e5e861602"]={f:Ops.Gl.ImageCompose.BarrelDistortion_v3,objName:"Ops.Gl.ImageCompose.BarrelDistortion_v3"};Ops.Math.MapRange=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const f=e.inValueFloat("value",0),g=e.inValueFloat("old min",0),d=e.inValueFloat("old max",1),m=e.inValueFloat("new min",0),p=e.inValueFloat("new max",1),i=e.inValueSelect("Easing",["Linear","Smoothstep","Smootherstep"],"Linear"),s=e.inBool("Clamp",true),_=e.outNumber("result",0);e.setPortGroup("Input Range",[g,d]);e.setPortGroup("Output Range",[m,p]);let v=true;let E=0;let b=0;f.onChange=g.onChange=d.onChange=m.onChange=p.onChange=r;r();s.onChange=()=>{v=s.get();r()};i.onChange=function(){if(i.get()=="Smoothstep")E=1;else if(i.get()=="Smootherstep")E=2;else E=0};function r(){const e=m.get();const t=p.get();const i=g.get();const s=d.get();let r=f.get();if(v){if(r>=Math.max(s,i)){_.set(t);return}else if(r<=Math.min(s,i)){_.set(e);return}}let n=false;const a=Math.min(i,s);const o=Math.max(i,s);if(a!=i)n=true;let l=false;const h=Math.min(e,t);const u=Math.max(e,t);if(h!=e)l=true;let c=0;if(n)c=(o-r)*(u-h)/(o-a);else c=(r-a)*(u-h)/(o-a);if(l)b=u-c;else b=c+h;if(E===0){_.set(b)}else if(E==1){r=Math.max(0,Math.min(1,(b-e)/(t-e)));_.set(e+r*r*(3-2*r)*(t-e))}else if(E==2){r=Math.max(0,Math.min(1,(b-e)/(t-e)));_.set(e+r*r*r*(r*(r*6-15)+10)*(t-e))}}}};CABLES.OPS["2617b407-60a0-4ff6-b4a7-18136cfa7817"]={f:Ops.Math.MapRange,objName:"Ops.Math.MapRange"};Ops.Math.Ease=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValue("Value"),s=e.inValue("Min",0),r=e.inValue("Max",1),n=e.outNumber("Result"),a=new CABLES.Anim;a.createPort(e,"Easing",l);a.setValue(0,0);a.setValue(1,1);e.onLoaded=s.onChange=r.onChange=o;function o(){a.keys[0].time=a.keys[0].value=Math.min(s.get(),r.get());a.keys[1].time=a.keys[1].value=Math.max(s.get(),r.get())}function l(){a.keys[0].setEasing(a.defaultEasing)}i.onChange=function(){const e=a.getValue(i.get());n.set(e)}}};CABLES.OPS["8f6e4a08-33e6-408f-ac4a-198bd03b417b"]={f:Ops.Math.Ease,objName:"Ops.Math.Ease"};Ops.Devices.Keyboard.KeyPressLearn=class extends CABLES.Op{constructor(){super(...arguments);const i=this;const e=i.attachments={};const s=i.inValueInt("key code");const t=i.inValueBool("canvas only",true);const r=i.inValueSelect("Mod Key",["none","alt"],"none");const n=i.inValueBool("Enabled",true);const a=i.inValueBool("Prevent Default");const o=i.inTriggerButton("learn");const l=i.outTrigger("on press");const h=i.outTrigger("on release");const u=i.outBoolNum("Pressed",false);const c=i.outString("Key");const f=i.patch.cgl;let g=false;r.onChange=s.onChange=b;function d(e){if(g){s.set(e.keyCode);if(CABLES.UI){i.refreshParams()}g=false;_();p();if(CABLES.UI)gui.emitEvent("portValueEdited",i,s,s.get())}else{if(e.keyCode==s.get()){if(r.get()=="alt"){if(e.altKey===true){l.trigger();u.set(true);if(a.get())e.preventDefault()}}else{l.trigger();u.set(true);if(a.get())e.preventDefault()}}}}function m(t){if(t.keyCode==s.get()){let e=true;if(r.get()=="alt"&&t.altKey!=true)e=false;if(e){h.trigger();u.set(false)}}}i.onDelete=function(){f.canvas.removeEventListener("keyup",m,false);f.canvas.removeEventListener("keydown",d,false);document.removeEventListener("keyup",m,false);document.removeEventListener("keydown",d,false)};o.onTriggered=function(){g=true;E();setTimeout(function(){g=false;_();p()},3e3)};function p(){if(t.get())v();else E()}function _(){document.removeEventListener("keydown",d,false);document.removeEventListener("keyup",m,false);f.canvas.removeEventListener("keydown",d,false);f.canvas.removeEventListener("keyup",m,false);u.set(false)}function v(){if(!CABLES.isNumeric(f.canvas.getAttribute("tabindex")))f.canvas.setAttribute("tabindex",1);f.canvas.addEventListener("keydown",d,false);f.canvas.addEventListener("keyup",m,false)}function E(){document.addEventListener("keydown",d,false);document.addEventListener("keyup",m,false)}n.onChange=function(){if(!n.get()){_()}else{p()}};t.onChange=function(){_();p()};function b(){let e=x(s.get());const t=r.get();if(t&&t!=="none"){e=t.charAt(0).toUpperCase()+t.slice(1)+"-"+e}i.setUiAttribs({extendTitle:e});c.set(e)}function x(e){if(!e&&e!==0)return"Unidentified";const t={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"};if(t[e]){return t[e]}else{return String.fromCharCode(e)}}v()}};CABLES.OPS["f069c0db-4051-4eae-989e-6ef7953787fd"]={f:Ops.Devices.Keyboard.KeyPressLearn,objName:"Ops.Devices.Keyboard.KeyPressLearn"};Ops.Gl.Matrix.Scale=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.inTrigger("render"),s=t.inValueFloat("scale",1),r=t.inValueFloat("x",1),n=t.inValueFloat("y",1),a=t.inValueFloat("z",1),o=t.outTrigger("trigger");t.setPortGroup("Axis",[r,n,a]);const l=vec3.create();r.onChange=n.onChange=a.onChange=s.onChange=h;h();i.onTriggered=function(){const e=t.patch.cg||t.patch.cgl;e.pushModelMatrix();mat4.scale(e.mMatrix,e.mMatrix,l);o.trigger();e.popModelMatrix()};function h(){const e=s.get();vec3.set(l,e*r.get(),e*n.get(),e*a.get())}}};CABLES.OPS["50e7f565-0cdb-47ca-912b-87c04e2f00e3"]={f:Ops.Gl.Matrix.Scale,objName:"Ops.Gl.Matrix.Scale"};Ops.Gl.Phong.PhongMaterial_v6=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const o=e.attachments={phong_frag:'IN vec3 viewDirection;\nIN vec3 normInterpolated;\nIN vec2 texCoord;\n\n#ifdef AO_CHAN_1\n    #ifndef ATTRIB_texCoord1\n        #define ATTRIB_texCoord1\n\n        IN vec2 texCoord1;\n    #endif\n#endif\n\n#ifdef HAS_TEXTURE_AO\nvec2 tcAo;\n#endif\n\n\n\n#ifdef ENABLE_FRESNEL\n    IN vec4 cameraSpace_pos;\n#endif\n\n// IN mat3 normalMatrix; // when instancing...\n\n#ifdef HAS_TEXTURE_NORMAL\n    IN mat3 TBN_Matrix; // tangent bitangent normal space transform matrix\n#endif\n\nIN vec3 fragPos;\nIN vec3 v_viewDirection;\n\nUNI vec4 inDiffuseColor;\nUNI vec4 inMaterialProperties;\n\n#ifdef ADD_EMISSIVE_COLOR\n    UNI vec4 inEmissiveColor; // .w = intensity\n#endif\n\n#ifdef ENABLE_FRESNEL\n    UNI mat4 viewMatrix;\n    UNI vec4 inFresnel;\n    UNI vec2 inFresnelWidthExponent;\n#endif\n\n#ifdef ENVMAP_MATCAP\n    IN vec3 viewSpaceNormal;\n    IN vec3 viewSpacePosition;\n#endif\n\nstruct Light {\n    vec3 color;\n    vec3 position;\n    vec3 specular;\n\n\n    // * SPOT LIGHT * //\n    #ifdef HAS_SPOT\n        vec3 conePointAt;\n        #define COSCONEANGLE x\n        #define COSCONEANGLEINNER y\n        #define SPOTEXPONENT z\n        vec3 spotProperties;\n    #endif\n\n    #define INTENSITY x\n    #define ATTENUATION y\n    #define FALLOFF z\n    #define RADIUS w\n    vec4 lightProperties;\n\n    int castLight;\n};\n\n/* CONSTANTS */\n#define NONE -1\n#define ALBEDO x\n#define ROUGHNESS y\n#define SHININESS z\n#define SPECULAR_AMT w\n#define NORMAL x\n#define AO y\n#define SPECULAR z\n#define EMISSIVE w\nconst float PI = 3.1415926535897932384626433832795;\nconst float TWO_PI = (2. * PI);\nconst float EIGHT_PI = (8. * PI);\n\n#define RECIPROCAL_PI 1./PI\n#define RECIPROCAL_PI2 RECIPROCAL_PI/2.\n\n// TEXTURES\n// #ifdef HAS_TEXTURES\n    UNI vec4 inTextureIntensities;\n\n    #ifdef HAS_TEXTURE_ENV\n        #ifdef TEX_FORMAT_CUBEMAP\n            UNI samplerCube texEnv;\n            #ifndef WEBGL1\n                #define SAMPLETEX textureLod\n            #endif\n            #ifdef WEBGL1\n                #define SAMPLETEX textureCubeLodEXT\n            #endif\n        #endif\n\n        #ifdef TEX_FORMAT_EQUIRECT\n            UNI sampler2D texEnv;\n            #ifdef WEBGL1\n                // #extension GL_EXT_shader_texture_lod : enable\n                #ifdef GL_EXT_shader_texture_lod\n                    #define textureLod texture2DLodEXT\n                #endif\n                // #define textureLod texture2D\n            #endif\n\n            #define SAMPLETEX sampleEquirect\n\n            const vec2 invAtan = vec2(0.1591, 0.3183);\n            vec4 sampleEquirect(sampler2D tex,vec3 direction,float lod)\n            {\n                #ifndef WEBGL1\n                    vec3 newDirection = normalize(direction);\n            \t\tvec2 sampleUV;\n            \t\tsampleUV.x = -1. * (atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.75);\n            \t\tsampleUV.y = asin( clamp(direction.y, -1., 1.) ) * RECIPROCAL_PI + 0.5;\n                #endif\n\n                #ifdef WEBGL1\n                    vec3 newDirection = normalize(direction);\n                \t\tvec2 sampleUV = vec2(atan(newDirection.z, newDirection.x), asin(newDirection.y+1e-6));\n                        sampleUV *= vec2(0.1591, 0.3183);\n                        sampleUV += 0.5;\n                #endif\n                return textureLod(tex, sampleUV, lod);\n            }\n        #endif\n        #ifdef ENVMAP_MATCAP\n            UNI sampler2D texEnv;\n            #ifdef WEBGL1\n                // #extension GL_EXT_shader_texture_lod : enable\n                #ifdef GL_EXT_shader_texture_lod\n                    #define textureLod texture2DLodEXT\n                #endif\n                // #define textureLod texture2D\n            #endif\n\n\n            // * taken & modified from https://github.com/mrdoob/three.js/blob/dev/src/renderers/shaders/ShaderLib/meshmatcap_frag.glsl.js\n            vec2 getMatCapUV(vec3 viewSpacePosition, vec3 viewSpaceNormal) {\n                vec3 viewDir = normalize(-viewSpacePosition);\n            \tvec3 x = normalize(vec3(viewDir.z, 0.0, - viewDir.x));\n            \tvec3 y = normalize(cross(viewDir, x));\n            \tvec2 uv = vec2(dot(x, viewSpaceNormal), dot(y, viewSpaceNormal)) * 0.495 + 0.5; // 0.495 to remove artifacts caused by undersized matcap disks\n            \treturn uv;\n            }\n        #endif\n\n        UNI float inEnvMapIntensity;\n        UNI float inEnvMapWidth;\n    #endif\n\n    #ifdef HAS_TEXTURE_LUMINANCE_MASK\n        UNI sampler2D texLuminance;\n        UNI float inLuminanceMaskIntensity;\n    #endif\n\n    #ifdef HAS_TEXTURE_DIFFUSE\n        UNI sampler2D texDiffuse;\n    #endif\n\n    #ifdef HAS_TEXTURE_SPECULAR\n        UNI sampler2D texSpecular;\n    #endif\n\n    #ifdef HAS_TEXTURE_NORMAL\n        UNI sampler2D texNormal;\n    #endif\n\n    #ifdef HAS_TEXTURE_AO\n        UNI sampler2D texAO;\n    #endif\n\n    #ifdef HAS_TEXTURE_EMISSIVE\n        UNI sampler2D texEmissive;\n    #endif\n\n    #ifdef HAS_TEXTURE_EMISSIVE_MASK\n        UNI sampler2D texMaskEmissive;\n        UNI float inEmissiveMaskIntensity;\n    #endif\n    #ifdef HAS_TEXTURE_ALPHA\n        UNI sampler2D texAlpha;\n    #endif\n// #endif\n\n{{MODULES_HEAD}}\n\nfloat when_gt(float x, float y) { return max(sign(x - y), 0.0); } // comparator function\nfloat when_lt(float x, float y) { return max(sign(y - x), 0.0); }\nfloat when_eq(float x, float y) { return 1. - abs(sign(x - y)); } // comparator function\nfloat when_neq(float x, float y) { return abs(sign(x - y)); } // comparator function\nfloat when_ge(float x, float y) { return 1.0 - when_lt(x, y); }\nfloat when_le(float x, float y) { return 1.0 - when_gt(x, y); }\n\n#ifdef FALLOFF_MODE_A\n    float CalculateFalloff(float distance, vec3 lightDirection, float falloff, float radius) {\n        // * original falloff\n        float denom = distance / radius + 1.0;\n        float attenuation = 1.0 / (denom*denom);\n        float t = (attenuation - falloff) / (1.0 - falloff);\n        return max(t, 0.0);\n    }\n#endif\n\n#ifdef FALLOFF_MODE_B\n    float CalculateFalloff(float distance, vec3 lightDirection, float falloff, float radius) {\n        float distanceSquared = dot(lightDirection, lightDirection);\n        float factor = distanceSquared * falloff;\n        float smoothFactor = clamp(1. - factor * factor, 0., 1.);\n        float attenuation = smoothFactor * smoothFactor;\n\n        return attenuation * 1. / max(distanceSquared, 0.00001);\n    }\n#endif\n\n#ifdef FALLOFF_MODE_C\n    float CalculateFalloff(float distance, vec3 lightDirection, float falloff, float radius) {\n        // https://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf\n        float falloffNumerator = 1. - pow(distance/radius, 4.);\n        falloffNumerator = clamp(falloffNumerator, 0., 1.);\n        falloffNumerator *= falloffNumerator;\n\n        float denominator = distance*distance + falloff;\n\n        return falloffNumerator/denominator;\n    }\n#endif\n\n#ifdef FALLOFF_MODE_D\n    float CalculateFalloff(float distance, vec3 lightDirection, float falloff, float radius) {\n        // inverse square falloff, "physically correct"\n        return 1.0 / max(distance * distance, 0.0001);\n    }\n#endif\n\n#ifdef ENABLE_FRESNEL\n    float CalculateFresnel(vec3 direction, vec3 normal)\n    {\n        vec3 nDirection = normalize( direction );\n        vec3 nNormal = normalize( mat3(viewMatrix) * normal );\n        vec3 halfDirection = normalize( nNormal + nDirection );\n\n        float cosine = dot( halfDirection, nDirection );\n        float product = max( cosine, 0.0 );\n        float factor = pow(product, inFresnelWidthExponent.y);\n\n        return 5. * factor;\n    }\n#endif\n\n#ifdef CONSERVE_ENERGY\n    // http://www.rorydriscoll.com/2009/01/25/energy-conservation-in-games/\n    // http://www.farbrausch.de/~fg/articles/phong.pdf\n    float EnergyConservation(float shininess) {\n        #ifdef SPECULAR_PHONG\n            return (shininess + 2.)/TWO_PI;\n        #endif\n        #ifdef SPECULAR_BLINN\n            return (shininess + 8.)/EIGHT_PI;\n        #endif\n\n        #ifdef SPECULAR_SCHLICK\n            return (shininess + 8.)/EIGHT_PI;\n        #endif\n\n        #ifdef SPECULAR_GAUSS\n            return (shininess + 8.)/EIGHT_PI;\n        #endif\n    }\n#endif\n\n#ifdef ENABLE_OREN_NAYAR_DIFFUSE\n    float CalculateOrenNayar(vec3 lightDirection, vec3 viewDirection, vec3 normal) {\n        float LdotV = dot(lightDirection, viewDirection);\n        float NdotL = dot(lightDirection, normal);\n        float NdotV = dot(normal, viewDirection);\n\n        float albedo = inMaterialProperties.ALBEDO;\n        albedo *= 1.8;\n        float s = LdotV - NdotL * NdotV;\n        float t = mix(1., max(NdotL, NdotV), step(0., s));\n\n        float roughness = inMaterialProperties.ROUGHNESS;\n        float sigma2 = roughness * roughness;\n        float A = 1. + sigma2 * (albedo / (sigma2 + 0.13) + 0.5 / (sigma2 + 0.33));\n        float B = 0.45 * sigma2 / (sigma2 + 0.09);\n\n        float factor = albedo * max(0., NdotL) * (A + B * s / t) / PI;\n\n        return factor;\n\n    }\n#endif\n\nvec3 CalculateDiffuseColor(\n    vec3 lightDirection,\n    vec3 viewDirection,\n    vec3 normal,\n    vec3 lightColor,\n    vec3 materialColor,\n    inout float lambert\n) {\n    #ifndef ENABLE_OREN_NAYAR_DIFFUSE\n        lambert = clamp(dot(lightDirection, normal), 0., 1.);\n    #endif\n\n    #ifdef ENABLE_OREN_NAYAR_DIFFUSE\n        lambert = CalculateOrenNayar(lightDirection, viewDirection, normal);\n    #endif\n\n    vec3 diffuseColor = lambert * lightColor * materialColor;\n    return diffuseColor;\n}\n\nvec3 CalculateSpecularColor(\n    vec3 specularColor,\n    float specularCoefficient,\n    float shininess,\n    vec3 lightDirection,\n    vec3 viewDirection,\n    vec3 normal,\n    float lambertian\n) {\n    vec3 resultColor = vec3(0.);\n\n    #ifdef SPECULAR_PHONG\n        vec3 reflectDirection = reflect(-lightDirection, normal);\n        float specularAngle = max(dot(reflectDirection, viewDirection), 0.);\n        float specularFactor = pow(specularAngle, max(0., shininess));\n    resultColor = lambertian * specularFactor * specularCoefficient * specularColor;\n    #endif\n\n    #ifdef SPECULAR_BLINN\n        vec3 halfDirection = normalize(lightDirection + viewDirection);\n        float specularAngle = max(dot(halfDirection, normal), 0.);\n        float specularFactor = pow(specularAngle, max(0., shininess));\n        resultColor = lambertian * specularFactor * specularCoefficient * specularColor;\n    #endif\n\n    #ifdef SPECULAR_SCHLICK\n        vec3 halfDirection = normalize(lightDirection + viewDirection);\n        float specularAngle = dot(halfDirection, normal);\n        float schlickShininess = max(0., shininess);\n        float specularFactor = specularAngle / (schlickShininess - schlickShininess*specularAngle + specularAngle);\n        resultColor = lambertian * specularFactor * specularCoefficient * specularColor;\n    #endif\n\n    #ifdef SPECULAR_GAUSS\n        vec3 halfDirection = normalize(lightDirection + viewDirection);\n        float specularAngle = acos(max(dot(halfDirection, normal), 0.));\n        float exponent = specularAngle * shininess * 0.17;\n        exponent = -(exponent*exponent);\n        float specularFactor = exp(exponent);\n\n        resultColor = lambertian * specularFactor * specularCoefficient * specularColor;\n    #endif\n\n    #ifdef CONSERVE_ENERGY\n        float conserveEnergyFactor = EnergyConservation(shininess);\n        resultColor = conserveEnergyFactor * resultColor;\n    #endif\n\n    return resultColor;\n}\n\n#ifdef HAS_SPOT\n    float CalculateSpotLightEffect(vec3 lightPosition, vec3 conePointAt, float cosConeAngle, float cosConeAngleInner, float spotExponent, vec3 lightDirection) {\n        vec3 spotLightDirection = normalize(lightPosition-conePointAt);\n        float spotAngle = dot(-lightDirection, spotLightDirection);\n        float epsilon = cosConeAngle - cosConeAngleInner;\n\n        float spotIntensity = clamp((spotAngle - cosConeAngle)/epsilon, 0.0, 1.0);\n        spotIntensity = pow(spotIntensity, max(0.01, spotExponent));\n\n        return max(0., spotIntensity);\n    }\n#endif\n\n\n\n{{PHONG_FRAGMENT_HEAD}}\n\n\nvoid main()\n{\n    {{MODULE_BEGIN_FRAG}}\n\n    vec4 col=vec4(0., 0., 0., inDiffuseColor.a);\n    vec3 calculatedColor = vec3(0.);\n    vec3 normal = normalize(normInterpolated);\n    vec3 baseColor = inDiffuseColor.rgb;\n\n    {{MODULE_BASE_COLOR}}\n\n\n\n    #ifdef AO_CHAN_0\n        vec2 tcAo=texCoord;\n    #endif\n    #ifdef AO_CHAN_1\n        vec2 tcAo=texCoord1;\n    #endif\n\n\n    vec3 viewDirection = normalize(v_viewDirection);\n\n    #ifdef DOUBLE_SIDED\n        if(!gl_FrontFacing) normal = normal * -1.0;\n    #endif\n\n    #ifdef HAS_TEXTURES\n        #ifdef HAS_TEXTURE_DIFFUSE\n            baseColor = texture(texDiffuse, texCoord).rgb;\n\n            #ifdef COLORIZE_TEXTURE\n                baseColor *= inDiffuseColor.rgb;\n            #endif\n        #endif\n\n        #ifdef HAS_TEXTURE_NORMAL\n            normal = texture(texNormal, texCoord).rgb;\n            normal = normalize(normal * 2. - 1.);\n            float normalIntensity = inTextureIntensities.NORMAL;\n            normal = normalize(mix(vec3(0., 0., 1.), normal, 2. * normalIntensity));\n            normal = normalize(TBN_Matrix * normal);\n        #endif\n    #endif\n\n    {{PHONG_FRAGMENT_BODY}}\n\n\n\n\n\n\n    #ifdef ENABLE_FRESNEL\n        calculatedColor += inFresnel.rgb * (CalculateFresnel(vec3(cameraSpace_pos), normal) * inFresnel.w * inFresnelWidthExponent.x);\n    #endif\n\n     #ifdef HAS_TEXTURE_ALPHA\n        #ifdef ALPHA_MASK_ALPHA\n            col.a*=texture(texAlpha,texCoord).a;\n        #endif\n        #ifdef ALPHA_MASK_LUMI\n            col.a*= dot(vec3(0.2126,0.7152,0.0722), texture(texAlpha,texCoord).rgb);\n        #endif\n        #ifdef ALPHA_MASK_R\n            col.a*=texture(texAlpha,texCoord).r;\n        #endif\n        #ifdef ALPHA_MASK_G\n            col.a*=texture(texAlpha,texCoord).g;\n        #endif\n        #ifdef ALPHA_MASK_B\n            col.a*=texture(texAlpha,texCoord).b;\n        #endif\n    #endif\n\n    #ifdef DISCARDTRANS\n        if(col.a<0.2) discard;\n    #endif\n\n\n    #ifdef HAS_TEXTURE_ENV\n        vec3 luminanceColor = vec3(0.);\n\n        #ifndef ENVMAP_MATCAP\n            float environmentMapWidth = inEnvMapWidth;\n            float glossyExponent = inMaterialProperties.SHININESS;\n            float glossyCoefficient = inMaterialProperties.SPECULAR_AMT;\n\n            vec3 envMapNormal =  normal;\n            vec3 reflectDirection = reflect(normalize(-viewDirection), normal);\n\n            float lambertianCoefficient = dot(viewDirection, reflectDirection); //0.44; // TODO: need prefiltered map for this\n            // lambertianCoefficient = 1.;\n            float specularAngle = max(dot(reflectDirection, viewDirection), 0.);\n            float specularFactor = pow(specularAngle, max(0., inMaterialProperties.SHININESS));\n\n            glossyExponent = specularFactor;\n\n            float maxMIPLevel = 10.;\n            float MIPlevel = log2(environmentMapWidth / 1024. * sqrt(3.)) - 0.5 * log2(glossyExponent + 1.);\n\n            luminanceColor = inEnvMapIntensity * (\n                inDiffuseColor.rgb *\n                SAMPLETEX(texEnv, envMapNormal, maxMIPLevel).rgb\n                +\n                glossyCoefficient * SAMPLETEX(texEnv, reflectDirection, MIPlevel).rgb\n            );\n        #endif\n        #ifdef ENVMAP_MATCAP\n            luminanceColor = inEnvMapIntensity * (\n                texture(texEnv, getMatCapUV(viewSpacePosition, viewSpaceNormal)).rgb\n                //inDiffuseColor.rgb\n                //* textureLod(texEnv, getMatCapUV(envMapNormal), maxMIPLevel).rgb\n                //+\n                //glossyCoefficient * textureLod(texEnv, getMatCapUV(reflectDirection), MIPlevel).rgb\n            );\n        #endif\n\n\n\n        #ifdef HAS_TEXTURE_LUMINANCE_MASK\n            luminanceColor *= texture(texLuminance, texCoord).r * inLuminanceMaskIntensity;\n        #endif\n\n        #ifdef HAS_TEXTURE_AO\n            luminanceColor *= texture(texAO, tcAo).r*inTextureIntensities.AO;\n        #endif\n\n        #ifdef ENV_BLEND_ADD\n            calculatedColor.rgb += luminanceColor;\n        #endif\n        #ifdef ENV_BLEND_MUL\n            calculatedColor.rgb *= luminanceColor;\n        #endif\n\n        #ifdef ENV_BLEND_MIX\n            calculatedColor.rgb=mix(luminanceColor,calculatedColor.rgb,luminanceColor);\n        #endif\n\n\n    #endif\n\n    #ifdef ADD_EMISSIVE_COLOR\n        vec3 emissiveRadiance = mix(calculatedColor, inEmissiveColor.rgb, inEmissiveColor.w); // .w = intensity of color;\n\n        #ifdef HAS_TEXTURE_EMISSIVE\n            float emissiveIntensity = inTextureIntensities.EMISSIVE;\n            emissiveRadiance = mix(calculatedColor, texture(texEmissive, texCoord).rgb, emissiveIntensity);\n        #endif\n\n        #ifdef HAS_TEXTURE_EMISSIVE_MASK\n           float emissiveMixValue = mix(1., texture(texMaskEmissive, texCoord).r, inEmissiveMaskIntensity);\n           calculatedColor = mix(calculatedColor, emissiveRadiance, emissiveMixValue);\n        #endif\n\n        #ifndef HAS_TEXTURE_EMISSIVE_MASK\n            calculatedColor = emissiveRadiance;\n        #endif\n    #endif\n\n    col.rgb = clamp(calculatedColor, 0., 1.);\n\n\n    {{MODULE_COLOR}}\n\n    outColor = col;\n\n}\n',phong_vert:"\n{{MODULES_HEAD}}\n\n#define NONE -1\n#define AMBIENT 0\n#define POINT 1\n#define DIRECTIONAL 2\n#define SPOT 3\n\n#define TEX_REPEAT_X x;\n#define TEX_REPEAT_Y y;\n#define TEX_OFFSET_X z;\n#define TEX_OFFSET_Y w;\n\nIN vec3 vPosition;\nIN vec2 attrTexCoord;\nIN vec3 attrVertNormal;\nIN float attrVertIndex;\nIN vec3 attrTangent;\nIN vec3 attrBiTangent;\n\nOUT vec2 texCoord;\nOUT vec3 normInterpolated;\nOUT vec3 fragPos;\n\n#ifdef AO_CHAN_1\n    #ifndef ATTRIB_attrTexCoord1\n        IN vec2 attrTexCoord1;\n        OUT vec2 texCoord1;\n        #define ATTRIB_attrTexCoord1\n        #define ATTRIB_texCoord1\n    #endif\n#endif\n\n#ifdef HAS_TEXTURE_NORMAL\n    OUT mat3 TBN_Matrix; // tangent bitangent normal space transform matrix\n#endif\n\n#ifdef ENABLE_FRESNEL\n    OUT vec4 cameraSpace_pos;\n#endif\n\nOUT vec3 v_viewDirection;\nOUT mat3 normalMatrix;\nOUT mat4 mvMatrix;\n\n#ifdef HAS_TEXTURES\n    UNI vec4 inTextureRepeatOffset;\n#endif\n\nUNI vec3 camPos;\nUNI mat4 projMatrix;\nUNI mat4 viewMatrix;\nUNI mat4 modelMatrix;\n\n#ifdef ENVMAP_MATCAP\n    OUT vec3 viewSpaceNormal;\n    OUT vec3 viewSpacePosition;\n#endif\n\n\nmat3 transposeMat3(mat3 m)\n{\n    return mat3(m[0][0], m[1][0], m[2][0],\n        m[0][1], m[1][1], m[2][1],\n        m[0][2], m[1][2], m[2][2]);\n}\n\nmat3 inverseMat3(mat3 m)\n{\n    float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n    float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n    float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n    float b01 = a22 * a11 - a12 * a21;\n    float b11 = -a22 * a10 + a12 * a20;\n    float b21 = a21 * a10 - a11 * a20;\n\n    float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n    return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n        b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n        b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n}\n\nvoid main()\n{\n    mat4 mMatrix=modelMatrix;\n    vec4 pos=vec4(vPosition,  1.0);\n\n    texCoord=attrTexCoord;\n    texCoord.y = 1. - texCoord.y;\n\n    #ifdef ATTRIB_texCoord1\n        texCoord1=attrTexCoord1;\n    #endif\n\n    vec3 norm=attrVertNormal;\n    vec3 tangent = attrTangent;\n    vec3 bitangent = attrBiTangent;\n\n    {{MODULE_VERTEX_POSITION}}\n\n    normalMatrix = transposeMat3(inverseMat3(mat3(mMatrix)));\n    mvMatrix = (viewMatrix * mMatrix);\n\n\n\n    #ifdef ENABLE_FRESNEL\n        cameraSpace_pos = mvMatrix * pos;\n    #endif\n\n    #ifdef HAS_TEXTURES\n        float repeatX = inTextureRepeatOffset.TEX_REPEAT_X;\n        float offsetX = inTextureRepeatOffset.TEX_OFFSET_X;\n        float repeatY = inTextureRepeatOffset.TEX_REPEAT_Y;\n        float offsetY = inTextureRepeatOffset.TEX_OFFSET_Y;\n\n        texCoord.x *= repeatX;\n        texCoord.x += offsetX;\n        texCoord.y *= repeatY;\n        texCoord.y += offsetY;\n    #endif\n\n   normInterpolated = vec3(normalMatrix*norm);\n\n    #ifdef HAS_TEXTURE_NORMAL\n        vec3 normCameraSpace = normalize((vec4(normInterpolated, 0.0)).xyz);\n        vec3 tangCameraSpace = normalize((mMatrix * vec4(tangent, 0.0)).xyz);\n        vec3 bitangCameraSpace = normalize((mMatrix * vec4(bitangent, 0.0)).xyz);\n\n        // re orthogonalization for smoother normals\n        tangCameraSpace = normalize(tangCameraSpace - dot(tangCameraSpace, normCameraSpace) * normCameraSpace);\n        bitangCameraSpace = cross(normCameraSpace, tangCameraSpace);\n\n        TBN_Matrix = mat3(tangCameraSpace, bitangCameraSpace, normCameraSpace);\n    #endif\n\n    fragPos = vec3((mMatrix) * pos);\n    v_viewDirection = normalize(camPos - fragPos);\n    // modelPos=mMatrix*pos;\n\n    #ifdef ENVMAP_MATCAP\n        mat3 viewSpaceNormalMatrix = normalMatrix = transposeMat3(inverseMat3(mat3(mvMatrix)));\n        viewSpaceNormal = normalize(viewSpaceNormalMatrix * norm);\n        viewSpacePosition = vec3(mvMatrix * pos);\n    #endif\n\n    mat4 modelViewMatrix=mvMatrix;\n    {{MODULE_VERTEX_MODELVIEW}}\n\n\n    gl_Position = projMatrix * modelViewMatrix * pos;\n}\n",snippet_body_ambient_frag:"    // * AMBIENT LIGHT {{LIGHT_INDEX}} *\n    vec3 diffuseColor{{LIGHT_INDEX}} = phongLight{{LIGHT_INDEX}}.lightProperties.INTENSITY*phongLight{{LIGHT_INDEX}}.color;\n    calculatedColor += diffuseColor{{LIGHT_INDEX}};\n",snippet_body_directional_frag:"    // * DIRECTIONAL LIGHT {{LIGHT_INDEX}} *\n\n    if (phongLight{{LIGHT_INDEX}}.castLight == 1) {\n        vec3 phongLightDirection{{LIGHT_INDEX}} = normalize(phongLight{{LIGHT_INDEX}}.position);\n\n        float phongLambert{{LIGHT_INDEX}} = 1.; // inout variable\n\n        vec3 lightColor{{LIGHT_INDEX}} = phongLight{{LIGHT_INDEX}}.color;\n        vec3 lightSpecular{{LIGHT_INDEX}} = phongLight{{LIGHT_INDEX}}.specular;\n\n        #ifdef HAS_TEXTURES\n            #ifdef HAS_TEXTURE_AO\n                // lightColor{{LIGHT_INDEX}} *= mix(vec3(1.), texture(texAO, texCoord).rgb, inTextureIntensities.AO);\n                lightColor{{LIGHT_INDEX}} *= texture(texAO, tcAo).g, inTextureIntensities.AO;\n\n            #endif\n\n            #ifdef HAS_TEXTURE_SPECULAR\n                lightSpecular{{LIGHT_INDEX}} *= mix(1., texture(texSpecular, texCoord).r, inTextureIntensities.SPECULAR);\n            #endif\n        #endif\n\n        vec3 diffuseColor{{LIGHT_INDEX}} = CalculateDiffuseColor(phongLightDirection{{LIGHT_INDEX}}, viewDirection, normal, lightColor{{LIGHT_INDEX}}, baseColor, phongLambert{{LIGHT_INDEX}});\n        vec3 specularColor{{LIGHT_INDEX}} = CalculateSpecularColor(\n            lightSpecular{{LIGHT_INDEX}},\n            inMaterialProperties.SPECULAR_AMT,\n            inMaterialProperties.SHININESS,\n            phongLightDirection{{LIGHT_INDEX}},\n            viewDirection,\n            normal,\n            phongLambert{{LIGHT_INDEX}}\n        );\n\n        vec3 combinedColor{{LIGHT_INDEX}} = (diffuseColor{{LIGHT_INDEX}} + specularColor{{LIGHT_INDEX}});\n\n        vec3 lightModelDiff{{LIGHT_INDEX}} = phongLight{{LIGHT_INDEX}}.position - fragPos.xyz;\n\n        combinedColor{{LIGHT_INDEX}} *= phongLight{{LIGHT_INDEX}}.lightProperties.INTENSITY;\n        calculatedColor += combinedColor{{LIGHT_INDEX}};\n    }",snippet_body_point_frag:"// * POINT LIGHT {{LIGHT_INDEX}} *\n    if (phongLight{{LIGHT_INDEX}}.castLight == 1) {\n        vec3 phongLightDirection{{LIGHT_INDEX}} = phongLight{{LIGHT_INDEX}}.position - fragPos.xyz;\n        // * get length before normalization for falloff calculation\n        phongLightDirection{{LIGHT_INDEX}} = normalize(phongLightDirection{{LIGHT_INDEX}});\n        float phongLightDistance{{LIGHT_INDEX}} = length(phongLightDirection{{LIGHT_INDEX}});\n\n        float phongLambert{{LIGHT_INDEX}} = 1.; // inout variable\n\n        vec3 lightColor{{LIGHT_INDEX}} = phongLight{{LIGHT_INDEX}}.color;\n        vec3 lightSpecular{{LIGHT_INDEX}} = phongLight{{LIGHT_INDEX}}.specular;\n\n        #ifdef HAS_TEXTURES\n            #ifdef HAS_TEXTURE_AO\n                lightColor{{LIGHT_INDEX}} -= (1.0-texture(texAO, tcAo).g)* (inTextureIntensities.AO);\n            #endif\n\n            #ifdef HAS_TEXTURE_SPECULAR\n                lightSpecular{{LIGHT_INDEX}} *= mix(1., texture(texSpecular, texCoord).r, inTextureIntensities.SPECULAR);\n            #endif\n        #endif\n\n        vec3 diffuseColor{{LIGHT_INDEX}} = CalculateDiffuseColor(phongLightDirection{{LIGHT_INDEX}}, viewDirection, normal, lightColor{{LIGHT_INDEX}}, baseColor, phongLambert{{LIGHT_INDEX}});\n        vec3 specularColor{{LIGHT_INDEX}} = CalculateSpecularColor(\n            lightSpecular{{LIGHT_INDEX}},\n            inMaterialProperties.SPECULAR_AMT,\n            inMaterialProperties.SHININESS,\n            phongLightDirection{{LIGHT_INDEX}},\n            viewDirection,\n            normal,\n            phongLambert{{LIGHT_INDEX}}\n        );\n\n        vec3 combinedColor{{LIGHT_INDEX}} = (diffuseColor{{LIGHT_INDEX}} + specularColor{{LIGHT_INDEX}});\n\n        combinedColor{{LIGHT_INDEX}} *= phongLight{{LIGHT_INDEX}}.lightProperties.INTENSITY;\n\n        float attenuation{{LIGHT_INDEX}} = CalculateFalloff(\n            phongLightDistance{{LIGHT_INDEX}},\n            phongLightDirection{{LIGHT_INDEX}},\n            phongLight{{LIGHT_INDEX}}.lightProperties.FALLOFF,\n            phongLight{{LIGHT_INDEX}}.lightProperties.RADIUS\n        );\n\n        attenuation{{LIGHT_INDEX}} *= when_gt(phongLambert{{LIGHT_INDEX}}, 0.);\n        combinedColor{{LIGHT_INDEX}} *= attenuation{{LIGHT_INDEX}};\n\n        calculatedColor += combinedColor{{LIGHT_INDEX}};\n    }\n",snippet_body_spot_frag:"    // * SPOT LIGHT {{LIGHT_INDEX}} *\n    if (phongLight{{LIGHT_INDEX}}.castLight == 1) {\n        vec3 phongLightDirection{{LIGHT_INDEX}} = phongLight{{LIGHT_INDEX}}.position - fragPos.xyz;\n        phongLightDirection{{LIGHT_INDEX}} = normalize( phongLightDirection{{LIGHT_INDEX}});\n        float phongLightDistance{{LIGHT_INDEX}} = length(phongLightDirection{{LIGHT_INDEX}});\n\n        float phongLambert{{LIGHT_INDEX}} = 1.; // inout variable\n\n        vec3 lightColor{{LIGHT_INDEX}} = phongLight{{LIGHT_INDEX}}.color;\n        vec3 lightSpecular{{LIGHT_INDEX}} = phongLight{{LIGHT_INDEX}}.specular;\n\n        #ifdef HAS_TEXTURES\n            #ifdef HAS_TEXTURE_AO\n                // lightColor{{LIGHT_INDEX}} *= mix(vec3(1.), texture(texAO, texCoord).rgb, inTextureIntensities.AO);\n                lightColor{{LIGHT_INDEX}} *= texture(texAO, texCoord).g, inTextureIntensities.AO;\n\n            #endif\n\n            #ifdef HAS_TEXTURE_SPECULAR\n                lightSpecular{{LIGHT_INDEX}} *= mix(1., texture(texSpecular, texCoord).r, inTextureIntensities.SPECULAR);\n            #endif\n        #endif\n\n        vec3 diffuseColor{{LIGHT_INDEX}} = CalculateDiffuseColor(phongLightDirection{{LIGHT_INDEX}}, viewDirection, normal, lightColor{{LIGHT_INDEX}}, baseColor, phongLambert{{LIGHT_INDEX}});\n        vec3 specularColor{{LIGHT_INDEX}} = CalculateSpecularColor(\n            lightSpecular{{LIGHT_INDEX}},\n            inMaterialProperties.SPECULAR_AMT,\n            inMaterialProperties.SHININESS,\n            phongLightDirection{{LIGHT_INDEX}},\n            viewDirection,\n            normal,\n            phongLambert{{LIGHT_INDEX}}\n        );\n\n        vec3 combinedColor{{LIGHT_INDEX}} = (diffuseColor{{LIGHT_INDEX}} + specularColor{{LIGHT_INDEX}});\n\n        float spotIntensity{{LIGHT_INDEX}} = CalculateSpotLightEffect(\n            phongLight{{LIGHT_INDEX}}.position, phongLight{{LIGHT_INDEX}}.conePointAt, phongLight{{LIGHT_INDEX}}.spotProperties.COSCONEANGLE,\n            phongLight{{LIGHT_INDEX}}.spotProperties.COSCONEANGLEINNER, phongLight{{LIGHT_INDEX}}.spotProperties.SPOTEXPONENT,\n            phongLightDirection{{LIGHT_INDEX}}\n        );\n\n        combinedColor{{LIGHT_INDEX}} *= spotIntensity{{LIGHT_INDEX}};\n\n        vec3 lightModelDiff{{LIGHT_INDEX}} = phongLight{{LIGHT_INDEX}}.position - fragPos.xyz;\n\n        float attenuation{{LIGHT_INDEX}} = CalculateFalloff(\n            phongLightDistance{{LIGHT_INDEX}},\n            phongLightDirection{{LIGHT_INDEX}},\n            phongLight{{LIGHT_INDEX}}.lightProperties.FALLOFF,\n            phongLight{{LIGHT_INDEX}}.lightProperties.RADIUS\n        );\n\n        attenuation{{LIGHT_INDEX}} *= when_gt(phongLambert{{LIGHT_INDEX}}, 0.);\n\n        combinedColor{{LIGHT_INDEX}} *= attenuation{{LIGHT_INDEX}};\n\n        combinedColor{{LIGHT_INDEX}} *= phongLight{{LIGHT_INDEX}}.lightProperties.INTENSITY;\n        calculatedColor += combinedColor{{LIGHT_INDEX}};\n    }",snippet_head_frag:"UNI Light phongLight{{LIGHT_INDEX}};\n"};const t=e.patch.cgl;const U=o.snippet_head_frag;const w={point:o.snippet_body_point_frag,spot:o.snippet_body_spot_frag,ambient:o.snippet_body_ambient_frag,directional:o.snippet_body_directional_frag,area:o.snippet_body_area_frag};const B=new RegExp("{{LIGHT_INDEX}}","g");const V=e=>{return U.replace("{{LIGHT_INDEX}}",e)};const k=(e,t)=>{return w[t].replace(B,e)};function G(){const e=o.phong_vert;let t=o.phong_frag;let i=V(0);let s=k(0,rt[0].type);t=t.replace(Te,i);t=t.replace(Ae,s);C.setSource(e,t);C.define("HAS_POINT");C.removeDefine("HAS_SPOT");C.removeDefine("HAS_DIRECTIONAL");C.removeDefine("HAS_AMBIENT")}const j=e.inTrigger("Trigger In");const H=e.inFloat("R",Math.random());const z=e.inFloat("G",Math.random());const X=e.inFloat("B",Math.random());const Y=e.inFloatSlider("A",1);const W=[H,z,X,Y];e.setPortGroup("Diffuse Color",W);const i=e.inBool("Enable",false);const s=e.inFloatSlider("Albedo",.707);const r=e.inFloatSlider("Roughness",.835);i.setUiAttribs({hidePort:true});s.setUiAttribs({greyout:true});r.setUiAttribs({greyout:true});H.setUiAttribs({colorPick:true});e.setPortGroup("Oren-Nayar Diffuse",[i,s,r]);e.toWorkShouldNotBeChild("Ops.Gl.TextureEffects.ImageCompose",CABLES.OP_PORT_TYPE_FUNCTION);i.onChange=function(){C.toggleDefine("ENABLE_OREN_NAYAR_DIFFUSE",i);s.setUiAttribs({greyout:!i.get()});r.setUiAttribs({greyout:!i.get()})};const n=e.inValueBool("Active",false);n.setUiAttribs({hidePort:true});const q=e.inValueSlider("Fresnel Intensity",.7);const K=e.inFloat("Fresnel Width",1);const Z=e.inFloat("Fresnel Exponent",6);const Q=e.inFloat("Fresnel R",1);const J=e.inFloat("Fresnel G",1);const $=e.inFloat("Fresnel B",1);Q.setUiAttribs({colorPick:true});const ee=[q,K,Z,Q,J,$];ee.forEach(function(e){e.setUiAttribs({greyout:true})});e.setPortGroup("Fresnel",ee.concat([n]));let a=null;let te=null;n.onChange=function(){C.toggleDefine("ENABLE_FRESNEL",n);if(n.get()){if(!a)a=new CGL.Uniform(C,"4f","inFresnel",Q,J,$,q);if(!te)te=new CGL.Uniform(C,"2f","inFresnelWidthExponent",K,Z)}else{if(a){C.removeUniform("inFresnel");a=null}if(te){C.removeUniform("inFresnelWidthExponent");te=null}}ee.forEach(function(e){e.setUiAttribs({greyout:!n.get()})})};const l=e.inBool("Emissive Active",false);const h=e.inFloatSlider("Color Intensity",.3);const u=e.inFloatSlider("Emissive R",Math.random());const c=e.inFloatSlider("Emissive G",Math.random());const f=e.inFloatSlider("Emissive B",Math.random());u.setUiAttribs({colorPick:true});e.setPortGroup("Emissive Color",[l,h,u,c,f]);h.setUiAttribs({greyout:!l.get()});u.setUiAttribs({greyout:!l.get()});c.setUiAttribs({greyout:!l.get()});f.setUiAttribs({greyout:!l.get()});let ie=null;l.onChange=()=>{C.toggleDefine("ADD_EMISSIVE_COLOR",l);if(l.get()){ie=new CGL.Uniform(C,"4f","inEmissiveColor",u,c,f,h);E.setUiAttribs({greyout:false});b.setUiAttribs({greyout:false});if(E.get())S.setUiAttribs({greyout:false});if(b.get())M.setUiAttribs({greyout:false})}else{e.log("ayayay");E.setUiAttribs({greyout:true});b.setUiAttribs({greyout:true});S.setUiAttribs({greyout:true});M.setUiAttribs({greyout:true});C.removeUniform("inEmissiveColor");ie=null}if(E.get()){h.setUiAttribs({greyout:true});u.setUiAttribs({greyout:true});c.setUiAttribs({greyout:true});f.setUiAttribs({greyout:true})}else{if(l.get()){h.setUiAttribs({greyout:false});u.setUiAttribs({greyout:false});c.setUiAttribs({greyout:false});f.setUiAttribs({greyout:false})}else{h.setUiAttribs({greyout:true});u.setUiAttribs({greyout:true});c.setUiAttribs({greyout:true});f.setUiAttribs({greyout:true})}}};const se=e.inFloat("Shininess",4);const re=e.inFloatSlider("Specular Amount",.5);const g=e.inSwitch("Specular Model",["Blinn","Schlick","Phong","Gauss"],"Blinn");g.setUiAttribs({hidePort:true});const ne=[se,re,g];e.setPortGroup("Specular",ne);const ae=e.inValueBool("Energy Conservation",false);const oe=e.inBool("Double Sided Material",false);const d=e.inSwitch("Falloff Mode",["A","B","C","D"],"A");ae.setUiAttribs({hidePort:true});oe.setUiAttribs({hidePort:true});d.setUiAttribs({hidePort:true});d.onChange=()=>{const e=["A","B","C","D"];C.define("FALLOFF_MODE_"+d.get());e.filter(e=>{return e!==d.get()}).forEach(e=>{return C.removeDefine("FALLOFF_MODE_"+e)})};const le=[ae,oe,d];e.setPortGroup("Light Options",le);const m=e.inTexture("Diffuse Texture");const p=e.inTexture("Specular Texture");const _=e.inTexture("Normal Map");const v=e.inTexture("AO Texture");const E=e.inTexture("Emissive Texture");const b=e.inTexture("Emissive Mask");const x=e.inTexture("Opacity Texture");const T=e.inTexture("Environment Map");const A=e.inTexture("Env Map Mask");e.setPortGroup("Textures",[m,p,_,v,E,b,x,T,A]);const he=e.inBool("Colorize Texture",false);const ue=e.inFloat("Diffuse Repeat X",1);const ce=e.inFloat("Diffuse Repeat Y",1);const fe=e.inFloat("Texture Offset X",0);const ge=e.inFloat("Texture Offset Y",0);const de=e.inFloatSlider("Specular Intensity",1);const me=e.inFloatSlider("Normal Map Intensity",.5);const pe=e.inFloatSlider("AO Intensity",1);const _e=e.inSwitch("AO UV Channel",["1","2"],1);const S=e.inFloatSlider("Emissive Intensity",1);const M=e.inFloatSlider("Emissive Mask Intensity",1);const ve=e.inFloatSlider("Env Map Intensity",1);const I=e.inSwitch("Env Map Blend",["Add","Multiply","Mix"],"Add");const Ee=e.inFloatSlider("Env Mask Intensity",1);he.setUiAttribs({hidePort:true});e.setPortGroup("Texture Transforms",[he,ce,ue,ge,fe]);e.setPortGroup("Texture Intensities",[me,pe,de,S,I,M,ve,Ee]);const O=e.inSwitch("Alpha Mask Source",["Luminance","R","G","B","A"],"Luminance");O.setUiAttribs({greyout:true});const R=e.inValueBool("Discard Transparent Pixels");R.setUiAttribs({hidePort:true});e.setPortGroup("Opacity Texture",[O,R]);_e.onChange=I.onChange=O.onChange=ze;const be=e.outTrigger("Trigger Out");const xe=e.outObject("Shader",null,"shader");xe.ignoreValueSerialize=true;const C=new CGL.Shader(t,"phongmaterial_"+e.id,this);C.op=this;C.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_BEGIN_FRAG","MODULE_BASE_COLOR","MODULE_VERTEX_MODELVIEW"]);C.setSource(o.simosphong_vert,o.simosphong_frag);C.define("FALLOFF_MODE_A");if(t.glVersion<2){C.enableExtension("GL_OES_standard_derivatives");if(t.enableExtension("OES_texture_float"))C.enableExtension("GL_OES_texture_float");else e.log("error loading extension OES_texture_float");if(t.enableExtension("OES_texture_float_linear"))C.enableExtension("GL_OES_texture_float_linear");else e.log("error loading extention OES_texture_float_linear");if(t.enableExtension("GL_OES_texture_half_float"))C.enableExtension("GL_OES_texture_half_float");else e.log("error loading extention GL_OES_texture_half_float");if(t.enableExtension("GL_OES_texture_half_float_linear"))C.enableExtension("GL_OES_texture_half_float_linear");else e.log("error loading extention GL_OES_texture_half_float_linear")}const Te=new RegExp("{{PHONG_FRAGMENT_HEAD}}","g");const Ae=new RegExp("{{PHONG_FRAGMENT_BODY}}","g");const P={directional:false,spot:false,ambient:false,point:false};function Se(t){let e=o.phong_frag;let i="";let s="";P.directional=false;P.spot=false;P.ambient=false;P.point=false;for(let e=0;e<t.length;e+=1){const r=t[e];const n=r.type;if(!P[n]){P[n]=true}i=i.concat(V(e));s=s.concat(k(e,r.type))}e=e.replace(Te,i);e=e.replace(Ae,s);C.setSource(o.phong_vert,e);for(let e=0,t=Object.keys(P);e<t.length;e+=1){const a=t[e];if(P[a]){if(!C.hasDefine("HAS_"+a.toUpperCase())){C.define("HAS_"+a.toUpperCase())}}else{if(C.hasDefine("HAS_"+a.toUpperCase())){C.removeDefine("HAS_"+a.toUpperCase())}}}}xe.setRef(C);let Me=null;let Ie=null;let Oe=null;let Re=null;let Ce=null;let Pe=null;let Ne=null;let N=null;let F=null;let L=null;let Fe=null;let Le=null;let De=null;he.onChange=function(){C.toggleDefine("COLORIZE_TEXTURE",he.get())};function ye(){if(m.get()){if(!C.hasDefine("HAS_TEXTURE_DIFFUSE")){C.define("HAS_TEXTURE_DIFFUSE");if(!Me)Me=new CGL.Uniform(C,"t","texDiffuse",0)}}else{C.removeUniform("texDiffuse");C.removeDefine("HAS_TEXTURE_DIFFUSE");Me=null}}function Ue(){if(p.get()){de.setUiAttribs({greyout:false});if(!C.hasDefine("HAS_TEXTURE_SPECULAR")){C.define("HAS_TEXTURE_SPECULAR");if(!Ie)Ie=new CGL.Uniform(C,"t","texSpecular",0)}}else{de.setUiAttribs({greyout:true});C.removeUniform("texSpecular");C.removeDefine("HAS_TEXTURE_SPECULAR");Ie=null}}function we(){if(_.get()){me.setUiAttribs({greyout:false});if(!C.hasDefine("HAS_TEXTURE_NORMAL")){C.define("HAS_TEXTURE_NORMAL");if(!Oe)Oe=new CGL.Uniform(C,"t","texNormal",0)}}else{me.setUiAttribs({greyout:true});C.removeUniform("texNormal");C.removeDefine("HAS_TEXTURE_NORMAL");Oe=null}}Re=new CGL.Uniform(C,"t","texAO");function Be(){C.toggleDefine("HAS_TEXTURE_AO",v.get());pe.setUiAttribs({greyout:!v.get()})}function Ve(){if(E.get()){u.setUiAttribs({greyout:true});c.setUiAttribs({greyout:true});f.setUiAttribs({greyout:true});h.setUiAttribs({greyout:true});if(l.get()){S.setUiAttribs({greyout:false})}if(!C.hasDefine("HAS_TEXTURE_EMISSIVE")){C.define("HAS_TEXTURE_EMISSIVE");if(!Ce)Ce=new CGL.Uniform(C,"t","texEmissive",0)}}else{S.setUiAttribs({greyout:true});if(l.get()){u.setUiAttribs({greyout:false});c.setUiAttribs({greyout:false});f.setUiAttribs({greyout:false});h.setUiAttribs({greyout:false})}else{E.setUiAttribs({greyout:true})}C.removeUniform("texEmissive");C.removeDefine("HAS_TEXTURE_EMISSIVE");Ce=null}}function ke(){if(b.get()){if(l.get()){M.setUiAttribs({greyout:false})}if(!C.hasDefine("HAS_TEXTURE_EMISSIVE_MASK")){C.define("HAS_TEXTURE_EMISSIVE_MASK");if(!Pe)Pe=new CGL.Uniform(C,"t","texMaskEmissive",0);if(!Ne)Ne=new CGL.Uniform(C,"f","inEmissiveMaskIntensity",M)}}else{if(!l.get()){b.setUiAttribs({greyout:true})}M.setUiAttribs({greyout:true});C.removeUniform("texMaskEmissive");C.removeUniform("inEmissiveMaskIntensity");C.removeDefine("HAS_TEXTURE_EMISSIVE_MASK");Pe=null;Ne=null}}let Ge=false;function je(){C.toggleDefine("HAS_TEXTURE_ENV",T.get());ve.setUiAttribs({greyout:!T.get()});if(T.get()){if(!F)F=new CGL.Uniform(C,"t","texEnv",0);C.toggleDefine("TEX_FORMAT_CUBEMAP",T.get().cubemap);if(T.get().cubemap){C.removeDefine("TEX_FORMAT_EQUIRECT");C.removeDefine("ENVMAP_MATCAP");if(!L)L=new CGL.Uniform(C,"f","inEnvMapIntensity",ve);if(!Fe)Fe=new CGL.Uniform(C,"f","inEnvMapWidth",T.get().cubemap.width)}else{const e=T.get().width===T.get().height;C.toggleDefine("TEX_FORMAT_EQUIRECT",!e);C.toggleDefine("ENVMAP_MATCAP",e);if(!L)L=new CGL.Uniform(C,"f","inEnvMapIntensity",ve);if(!Fe)Fe=new CGL.Uniform(C,"f","inEnvMapWidth",T.get().width)}}else{C.removeUniform("inEnvMapIntensity");C.removeUniform("inEnvMapWidth");C.removeUniform("texEnv");C.removeDefine("HAS_TEXTURE_ENV");C.removeDefine("ENVMAP_MATCAP");F=null;L=null}Ge=false}function He(){if(A.get()){Ee.setUiAttribs({greyout:false});if(!Le){C.define("HAS_TEXTURE_LUMINANCE_MASK");Le=new CGL.Uniform(C,"t","texLuminance",0);De=new CGL.Uniform(C,"f","inLuminanceMaskIntensity",Ee)}}else{Ee.setUiAttribs({greyout:true});C.removeDefine("HAS_TEXTURE_LUMINANCE_MASK");C.removeUniform("inLuminanceMaskIntensity");C.removeUniform("texLuminance");Le=null;De=null}}function ze(){C.toggleDefine("ENV_BLEND_ADD",I.get()=="Add");C.toggleDefine("ENV_BLEND_MUL",I.get()=="Multiply");C.toggleDefine("ENV_BLEND_MIX",I.get()=="Mix");C.toggleDefine("ALPHA_MASK_ALPHA",O.get()=="A"||O.get()=="Alpha");C.toggleDefine("ALPHA_MASK_LUMI",O.get()=="Luminance");C.toggleDefine("ALPHA_MASK_R",O.get()=="R");C.toggleDefine("ALPHA_MASK_G",O.get()=="G");C.toggleDefine("ALPHA_MASK_B",O.get()=="B");C.toggleDefine("AO_CHAN_0",_e.get()=="1");C.toggleDefine("AO_CHAN_1",_e.get()=="2")}function Xe(){if(x.get()){if(N!==null)return;C.removeUniform("texAlpha");C.define("HAS_TEXTURE_ALPHA");if(!N)N=new CGL.Uniform(C,"t","texAlpha",0);O.setUiAttribs({greyout:false});R.setUiAttribs({greyout:false})}else{C.removeUniform("texAlpha");C.removeDefine("HAS_TEXTURE_ALPHA");N=null;O.setUiAttribs({greyout:true});R.setUiAttribs({greyout:true})}ze()}R.onChange=function(){C.toggleDefine("DISCARDTRANS",R.get())};m.onChange=ye;p.onChange=Ue;_.onChange=we;v.onChange=Be;E.onChange=Ve;b.onChange=ke;x.onChange=Xe;T.onChange=()=>{Ge=true};A.onChange=He;const Ye=t.maxUniformsFrag;const We=Ye===64?6:16;C.define("MAX_LIGHTS",We.toString());C.define("SPECULAR_PHONG");g.onChange=function(){if(g.get()==="Phong"){C.define("SPECULAR_PHONG");C.removeDefine("SPECULAR_BLINN");C.removeDefine("SPECULAR_GAUSS");C.removeDefine("SPECULAR_SCHLICK")}else if(g.get()==="Blinn"){C.define("SPECULAR_BLINN");C.removeDefine("SPECULAR_PHONG");C.removeDefine("SPECULAR_GAUSS");C.removeDefine("SPECULAR_SCHLICK")}else if(g.get()==="Gauss"){C.define("SPECULAR_GAUSS");C.removeDefine("SPECULAR_BLINN");C.removeDefine("SPECULAR_PHONG");C.removeDefine("SPECULAR_SCHLICK")}else if(g.get()==="Schlick"){C.define("SPECULAR_SCHLICK");C.removeDefine("SPECULAR_BLINN");C.removeDefine("SPECULAR_PHONG");C.removeDefine("SPECULAR_GAUSS")}};ae.onChange=function(){C.toggleDefine("CONSERVE_ENERGY",ae.get())};oe.onChange=function(){C.toggleDefine("DOUBLE_SIDED",oe.get())};const qe=new CGL.Uniform(C,"4f","inMaterialProperties",s,r,se,re);const Ke=new CGL.Uniform(C,"4f","inDiffuseColor",H,z,X,Y);const Ze=new CGL.Uniform(C,"4f","inTextureIntensities",me,pe,de,S);const Qe=new CGL.Uniform(C,"4f","inTextureRepeatOffset",ue,ce,fe,ge);C.uniformColorDiffuse=Ke;const D=[];let Je=0;function $e(t){for(let e=0;e<D.length;e+=1){D[e]=null}for(let e=0;e<t;e+=1){D[e]=null;if(!D[e]){D[e]={color:new CGL.Uniform(C,"3f","phongLight"+e+".color",[1,1,1]),position:new CGL.Uniform(C,"3f","phongLight"+e+".position",[0,11,0]),specular:new CGL.Uniform(C,"3f","phongLight"+e+".specular",[1,1,1]),lightProperties:new CGL.Uniform(C,"4f","phongLight"+e+".lightProperties",[1,1,1,1]),conePointAt:new CGL.Uniform(C,"3f","phongLight"+e+".conePointAt",vec3.create()),spotProperties:new CGL.Uniform(C,"3f","phongLight"+e+".spotProperties",[0,0,0,0]),castLight:new CGL.Uniform(C,"i","phongLight"+e+".castLight",1)}}}}function et(e){y.position.setValue(e.position);y.color.setValue(e.color);y.specular.setValue(e.specular);y.lightProperties.setValue([e.intensity,e.attenuation,e.falloff,e.radius]);y.conePointAt.setValue(e.conePointAt);y.spotProperties.setValue([e.cosConeAngle,e.cosConeAngleInner,e.spotExponent])}function tt(t){for(let e=0;e<t.length;e+=1){const i=t[e];i.isUsed=true;D[e].position.setValue(i.position);D[e].color.setValue(i.color);D[e].specular.setValue(i.specular);D[e].lightProperties.setValue([i.intensity,i.attenuation,i.falloff,i.radius]);D[e].conePointAt.setValue(i.conePointAt);D[e].spotProperties.setValue([i.cosConeAngle,i.cosConeAngleInner,i.spotExponent]);D[e].castLight.setValue(i.castLight)}}function it(e){if(e.length!==Je){Se(e);$e(e.length);Je=e.length;tt(e)}else{tt(e)}}let y=null;function st(){y={color:new CGL.Uniform(C,"3f","phongLight"+0+".color",[1,1,1]),specular:new CGL.Uniform(C,"3f","phongLight"+0+".specular",[1,1,1]),position:new CGL.Uniform(C,"3f","phongLight"+0+".position",[0,11,0]),lightProperties:new CGL.Uniform(C,"4f","phongLight"+0+".lightProperties",[1,1,1,1]),conePointAt:new CGL.Uniform(C,"3f","phongLight"+0+".conePointAt",vec3.create()),spotProperties:new CGL.Uniform(C,"3f","phongLight"+0+".spotProperties",[0,0,0,0]),castLight:new CGL.Uniform(C,"i","phongLight"+0+".castLight",1)}}const rt=[{type:"point",position:[5,5,5],color:[1,1,1],specular:[1,1,1],intensity:1,attenuation:0,falloff:.5,radius:80,castLight:1}];const nt=mat4.create();function at(){if(t.tempData.lightStack){if(t.tempData.lightStack.length===0){e.setUiError("deflight","Default light is enabled. Please add lights to your patch to make this warning disappear.",1)}else e.setUiError("deflight",null)}if(!t.tempData.lightStack||!t.tempData.lightStack.length){if(!y){G();st()}mat4.invert(nt,t.vMatrix);rt[0].position=[nt[12],nt[13],nt[14]];et(rt[0]);Je=-1}else{if(C){if(t.tempData.lightStack){if(t.tempData.lightStack.length){y=null;it(t.tempData.lightStack)}}}}}const ot=function(){if(!C){e.log("NO SHADER");return}t.pushShader(C);C.popTextures();be.trigger();t.popShader()};e.preRender=function(){C.bind();ot()};const lt=mat4.create();const ht=vec3.create();const ut=vec3.create();j.onTriggered=function(){if(!C){e.log("phong has no shader...");return}if(Ge)je();t.pushShader(C);C.popTextures();if(m.get())C.pushTexture(Me,m.get());if(p.get())C.pushTexture(Ie,p.get());if(_.get())C.pushTexture(Oe,_.get());if(v.get())C.pushTexture(Re,v.get());if(E.get())C.pushTexture(Ce,E.get());if(b.get())C.pushTexture(Pe,b.get());if(x.get())C.pushTexture(N,x.get());if(T.get()){if(T.get().cubemap)C.pushTexture(F,T.get().cubemap,t.gl.TEXTURE_CUBE_MAP);else C.pushTexture(F,T.get())}if(A.get()){C.pushTexture(Le,A.get())}at();be.trigger();t.popShader()};if(t.glVersion==1){if(!t.enableExtension("EXT_shader_texture_lod")){e.log("no EXT_shader_texture_lod texture extension")}else{C.enableExtension("GL_EXT_shader_texture_lod");t.enableExtension("OES_texture_float");t.enableExtension("OES_texture_float_linear");t.enableExtension("OES_texture_half_float");t.enableExtension("OES_texture_half_float_linear");C.enableExtension("GL_OES_standard_derivatives");C.enableExtension("GL_OES_texture_float");C.enableExtension("GL_OES_texture_float_linear");C.enableExtension("GL_OES_texture_half_float");C.enableExtension("GL_OES_texture_half_float_linear")}}ye();Ue();we();Be();Xe();Ve();ke();je();He()}};CABLES.OPS["0d83ed06-cdbe-4fe0-87bb-0ccece7fb6e1"]={f:Ops.Gl.Phong.PhongMaterial_v6,objName:"Ops.Gl.Phong.PhongMaterial_v6"};Ops.Number.Number=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValueFloat("value"),s=e.outNumber("result");i.onChange=n;let r=false;i.onLinkChanged=()=>{if(!r&&i.isLinked())e.setUiAttribs({extendTitle:null});r=i.isLinked()};function n(){if(CABLES.UI&&!r)e.setUiAttribs({extendTitle:i.get()});s.set(Number(i.get()))}}};CABLES.OPS["8fb2bb5d-665a-4d0a-8079-12710ae453be"]={f:Ops.Number.Number,objName:"Ops.Number.Number"};Ops.Anim.LFO_v3=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValue("Time"),s=e.inFloat("Frequency",1),r=e.inValueSelect("Type",["sine","triangle","ramp up","ramp down","square"],"sine"),n=e.inValue("Phase",0),a=e.inValue("Range Min",-1),o=e.inValue("Range Max",1),l=e.outNumber("Result");let h=0;r.onChange=c;c();const u=Math.PI/2;function c(){if(r.get()=="sine")i.onChange=_;if(r.get()=="ramp up")i.onChange=d;if(r.get()=="ramp down")i.onChange=m;if(r.get()=="square")i.onChange=g;if(r.get()=="triangle")i.onChange=p}function f(){return i.get()*s.get()+n.get()}function g(){let e=f()+.5;h=e%2;if(h<=1)h=-1;else h=1;h=CABLES.map(h,-1,1,a.get(),o.get());l.set(h)}function d(){let e=f()+1;h=e%1;h-=.5;h*=2;h=CABLES.map(h,-1,1,a.get(),o.get());l.set(h)}function m(){let e=f();h=e%1;h-=.5;h*=-2;h=CABLES.map(h,-1,1,a.get(),o.get());l.set(h)}function p(){let e=f();h=e%2;if(h>1)h=2-h;h-=.5;h*=2;h=CABLES.map(h,-1,1,a.get(),o.get());l.set(h)}function _(){let e=f()*Math.PI-u;h=Math.sin(e);h=CABLES.map(h,-1,1,a.get(),o.get());l.set(h)}}};CABLES.OPS["5bdbe26b-dea3-4266-850c-1b66ed29936e"]={f:Ops.Anim.LFO_v3,objName:"Ops.Anim.LFO_v3"};Ops.Ui.VizGraph=class extends CABLES.Op{constructor(){super(...arguments);const h=this;const e=h.attachments={};const t=h.inFloat("Number 1"),i=h.inFloat("Number 2"),s=h.inFloat("Number 3"),r=h.inFloat("Number 4"),n=h.inFloat("Number 5"),a=h.inFloat("Number 6"),o=h.inFloat("Number 7"),l=h.inFloat("Number 8"),u=h.inBool("Fill Graph",true),c=h.inTriggerButton("Reset");h.setUiAttrib({height:150,resizable:true,vizLayerMaxZoom:2500});let f=[];let g=-Number.MAX_VALUE;let d=Number.MAX_VALUE;t.onLinkChanged=i.onLinkChanged=s.onLinkChanged=r.onLinkChanged=n.onLinkChanged=a.onLinkChanged=o.onLinkChanged=l.onLinkChanged=c.onTriggered=()=>{g=-Number.MAX_VALUE;d=Number.MAX_VALUE;f=[]};h.renderVizLayer=(s,r)=>{const e=u.get();const n=["#7AC4E0","#D183BF","#9091D6","#FFC395","#F0D165","#63A8E8","#CF5D9D","#66C984","#D66AA6","#515151"];let t=10*r.pixelDensity;s.font="bold "+t+"px sourceCodePro";s.fillStyle="#222";s.fillRect(r.x,r.y,r.width,r.height);for(let i=0;i<h.portsIn.length;i++){if(!h.portsIn[i].isLinked())continue;const a=h.portsIn[i].get();g=Math.max(h.portsIn[i].get(),g);d=Math.min(h.portsIn[i].get(),d);if(!f[i])f[i]=[];f[i].push(a);if(f[i].length>60)f[i].shift();const o=6;const l=r.width/60;s.lineWidth=3;s.strokeStyle="#555555";s.beginPath();s.moveTo(r.x,CABLES.map(0,d,g,r.height,0)+r.y);s.lineTo(r.x+r.width,CABLES.map(0,d,g,r.height,0)+r.y);s.stroke();s.beginPath();let t;for(let e=0;e<f[i].length;e++){t=f[i][e];t=CABLES.map(t,d,g,r.height-3,3);t+=r.y;if(e===0)s.moveTo(r.x,t);else s.lineTo(r.x+e*l,t)}if(e){s.lineTo(r.x+f[i].length*l,r.y+r.height);s.lineTo(r.x,r.y+r.height);s.fillStyle=n[i];s.fill()}else{s.strokeStyle=n[i];s.stroke()}}s.fillStyle="#fff";s.fillText("max:"+Math.round(g*100)/100,r.x+10,r.y+r.height-10);s.fillText("min:"+Math.round(d*100)/100,r.x+10,r.y+r.height-30)}}};CABLES.OPS["13c54eb4-60ef-4b9c-8425-d52a431f5c87"]={f:Ops.Ui.VizGraph,objName:"Ops.Ui.VizGraph"};Ops.Math.Clamp=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValueFloat("val",.5),s=e.inValueFloat("min",0),r=e.inValueFloat("max",1),n=e.inValueBool("ignore outside values"),a=e.outNumber("result");i.onChange=s.onChange=r.onChange=o;function o(){if(n.get()){if(i.get()>r.get())return;if(i.get()<s.get())return}a.set(Math.min(Math.max(i.get(),s.get()),r.get()))}}};CABLES.OPS["cda1a98e-5e16-40bd-9b18-a67e9eaad5a1"]={f:Ops.Math.Clamp,objName:"Ops.Math.Clamp"};Ops.Math.PerlinNoise_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inFloat("X",0),s=e.inFloat("Y",0),r=e.inFloat("Z",0),n=e.inFloat("Scale",4),a=e.inFloat("Seed",1),o=e.outNumber("Result");const p=4;const _=1<<p;const v=8;const E=1<<v;const b=4095;let x=4;let T=.5;const A=e=>.5*(1-Math.cos(e*Math.PI));let S=null;i.onChange=s.onChange=r.onChange=l;function l(){let e=n.get();let t=h(i.get()*e,s.get()*e,r.get()*e);o.set(t)}function h(e,t=0,i=0){if(S==null){S=new Array(b+1);for(let e=0;e<b+1;e++){S[e]=Math.random()}}if(e<0){e=-e}if(t<0){t=-t}if(i<0){i=-i}let s=Math.floor(e),r=Math.floor(t),n=Math.floor(i);let a=e-s;let o=t-r;let l=i-n;let h,u;let c=0;let f=.5;let g,d,m;for(let e=0;e<x;e++){let e=s+(r<<p)+(n<<v);h=A(a);u=A(o);g=S[e&b];g+=h*(S[e+1&b]-g);d=S[e+_&b];d+=h*(S[e+_+1&b]-d);g+=u*(d-g);e+=E;d=S[e&b];d+=h*(S[e+1&b]-d);m=S[e+_&b];m+=h*(S[e+_+1&b]-m);d+=u*(m-d);g+=A(l)*(d-g);c+=g*f;f*=T;s<<=1;a*=2;r<<=1;o*=2;n<<=1;l*=2;if(a>=1){s++;a--}if(o>=1){r++;o--}if(l>=1){n++;l--}}return c}a.onChange=()=>{Math.randomSeed=a.get();S=new Array(b+1);for(let e=0;e<b+1;e++){S[e]=Math.seededRandom()}}}};CABLES.OPS["b1a19b32-4ccd-4bce-a37d-e386e53dfc1c"]={f:Ops.Math.PerlinNoise_v2,objName:"Ops.Math.PerlinNoise_v2"};Ops.Math.Sum=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValueFloat("number1",0),s=e.inValueFloat("number2",0),r=e.outNumber("result");e.setUiAttribs({mathTitle:true});i.onChange=s.onChange=n;n();function n(){const e=i.get()+s.get();if(!isNaN(e))r.set(e)}}};CABLES.OPS["c8fb181e-0b03-4b41-9e55-06b6267bc634"]={f:Ops.Math.Sum,objName:"Ops.Math.Sum"};Ops.Math.TriggerRandomNumber_v3=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inTriggerButton("Generate"),s=e.inValue("min",0),r=e.inValue("max",1),n=e.outTrigger("next"),a=e.outNumber("result"),o=e.inValueBool("Integer",false),l=e.inValueBool("No consecutive duplicates",false);e.setPortGroup("Value Range",[s,r]);o.onChange=i.onTriggered=h;h();function h(){let e=Math.random()*(r.get()-s.get())+s.get();if(o.get())e=u();if(s.get()!=r.get()&&r.get()>s.get())while(l.get()&&e==a.get())e=u();a.set(e);n.trigger()}function u(){return Math.floor(Math.random()*(r.get()-s.get()+1)+s.get())}}};CABLES.OPS["d082beaf-ef4b-4e57-a900-9ee87c0c9fe4"]={f:Ops.Math.TriggerRandomNumber_v3,objName:"Ops.Math.TriggerRandomNumber_v3"};Ops.Trigger.Interval=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValue("interval"),s=e.outTrigger("trigger"),r=e.inValueBool("Active",true);r.onChange=function(){clearTimeout(n);n=-1;if(!r.get()){}else a()};i.set(1e3);let n=-1;function a(){if(!r.get())return;if(n!=-1)return;n=setTimeout(function(){n=-1;s.trigger();a()},i.get())}i.onChange=a;a()}};CABLES.OPS["3e9bae10-38af-4e36-9fcc-35faeeaf57f8"]={f:Ops.Trigger.Interval,objName:"Ops.Trigger.Interval"};Ops.Ui.Routing.RouteTrigger=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inTrigger("Trigger"),s=e.outTrigger("Next");e.setUiAttribs({display:"reroute"});i.onTriggered=()=>{s.trigger()}}};CABLES.OPS["0a2dc648-3a02-4559-b9af-cf3d47701e66"]={f:Ops.Ui.Routing.RouteTrigger,objName:"Ops.Ui.Routing.RouteTrigger"};Ops.Anim.AnimNumber=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inTrigger("exe"),s=e.inValue("Value"),r=e.inValueFloat("duration"),n=e.outTrigger("Next"),a=e.outNumber("result"),o=e.outTrigger("Finished");let l=0;let h=0;let u=0;let c=true;r.set(.5);const f=new CABLES.Anim;f.createPort(e,"easing",g);f.loop=false;r.onChange=s.onChange=g;function g(){h=performance.now();f.clear(CABLES.now()/1e3);if(c)f.setValue(CABLES.now()/1e3,s.get());f.setValue(r.get()+CABLES.now()/1e3,s.get(),d);c=false}function d(){o.trigger()}i.onTriggered=function(){let e=CABLES.now()/1e3;if(performance.now()-l>300){c=true;g()}l=performance.now();let t=f.getValue(e);a.set(t);n.trigger()}}};CABLES.OPS["e5b0b016-9663-4c9d-9365-f54ae3c5fbb6"]={f:Ops.Anim.AnimNumber,objName:"Ops.Anim.AnimNumber"};Ops.Ui.VizNumber=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.inFloat("Number",0);const s=t.outNumber("Result");t.setUiAttrib({widthOnlyGrow:true});i.onChange=r;r();function r(){let e=i.get();t.setUiAttribs({extendTitle:i.getValueForDisplay()});s.set(e)}}};CABLES.OPS["2b60d12d-2884-4ad0-bda4-0caeb6882f5c"]={f:Ops.Ui.VizNumber,objName:"Ops.Ui.VizNumber"};Ops.Math.Exp=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValueFloat("number");const s=e.outNumber("result");i.onChange=function(){let e=Math.exp(i.get());if(isNaN(e))e=0;s.set(e)}}};CABLES.OPS["612727c2-b2e5-446c-99bb-7e30132f2ff6"]={f:Ops.Math.Exp,objName:"Ops.Math.Exp"};Ops.Math.MathExpression=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inFloat("A",0);const s=e.inFloat("B",1);const r=e.inFloat("C",2);const n=e.inFloat("D",3);e.setPortGroup("Parameters",[i,s,r,n]);const a=e.inString("Expression","a*(b+c+d)");e.setPortGroup("Expression",[a]);const o=e.outNumber("Result");const l=e.outBool("Expression Valid");let h=a.get();let u=false;const c=()=>{try{h=new Function("m","a","b","c","d",`with(m) { return ${a.get()} }`);u=true;f();l.set(u)}catch(e){u=false;l.set(u);if(e instanceof ReferenceError||e instanceof SyntaxError)return}};const f=()=>{if(u){o.set(h(Math,i.get(),s.get(),r.get(),n.get()));if(!a.get())o.set(0)}l.set(u)};i.onChange=s.onChange=r.onChange=n.onChange=f;a.onChange=c;c()}};CABLES.OPS["d2343a1e-64ea-45b2-99ed-46e167bbdcd3"]={f:Ops.Math.MathExpression,objName:"Ops.Math.MathExpression"};Ops.Anim.Smooth=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inTrigger("Update"),s=e.inBool("Separate inc/dec",false),r=e.inValue("Value"),n=e.outTrigger("Next"),a=e.inValue("Inc factor",4),o=e.inValue("Dec factor",4),l=e.outNumber("Result",0);let h=0;let u=0;let c=0;let f=0;e.toWorkPortsNeedToBeLinked(i);let g;let d;let m=4;let p=true;let _=0;const v=0;const E=1;b();x();s.setUiAttribs({hidePort:true});a.onChange=o.onChange=x;s.onChange=b;T();function b(){const e=s.get();if(!e)_=v;else _=E;if(_==v){o.setUiAttribs({greyout:true});a.setUiAttribs({title:"Inc/Dec factor"})}else if(_==E){o.setUiAttribs({greyout:false});a.setUiAttribs({title:"Inc factor"})}x();T()}function x(){if(_==v){g=a.get();d=a.get()}else if(_==E){g=a.get();d=o.get()}if(g<=.2||g!=g)g=.2;if(d<=.2||d!=d)d=.2}r.onChange=function(){p=false;let e=u;u=r.get()};a.onChange=function(){x()};function T(){let e=1;if(performance.now()-f>500||f===0)h=r.get()||0;else e=(performance.now()-f)/(performance.now()-f);f=performance.now();if(h!=h)h=0;if(m<=0)m=1e-4;const t=u-h;if(t>=0)h+=t/(d*e);else h+=t/(g*e);if(Math.abs(t)<1e-5)h=u;if(m!=m)h=0;if(h!=h||h==-Infinity||h==Infinity)h=r.get();if(c!=h){l.set(h);c=h}if(h==u&&!p){p=true;l.set(h)}}i.onTriggered=function(){T();n.trigger()}}};CABLES.OPS["5677b5b5-753a-4fbf-9e91-64c81ec68a2f"]={f:Ops.Anim.Smooth,objName:"Ops.Anim.Smooth"};Ops.Devices.Mouse.Mouse_v4=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const y=t.attachments={};const e=t.inSwitch("Coordinates",["-1 to 1","Pixel Display","Pixel","0 to 1"],"-1 to 1"),r=t.inValueSelect("Area",["Canvas Area","Canvas","Document","Parent Element"],"Canvas Area"),n=t.inValueBool("flip y",true),i=t.inBool("right click prevent default",true),s=t.inSwitch("Events",["Pointer","Touch","Mouse"]),a=t.inValueBool("Passive Events",false),o=t.inObject("Element","element"),l=t.inValueBool("Active",true),h=t.outNumber("x",0),u=t.outNumber("y",0),c=t.outTrigger("click"),U=t.outTrigger("click right"),f=t.outBoolNum("Button is down"),g=t.outBoolNum("Mouse is hovering"),w=t.outNumber("Movement X",0),B=t.outNumber("Movement Y",0),d=t.outObject("Event");const m=t.patch.cgl;let p=1;let _=null;let v=null;a.onChange=r.onChange=D;e.onChange=k;t.onDelete=L;D();t.on("loadedValueSet",E);function E(){if(p==0){if(v.clientWidth===0)setTimeout(E,50);h.set(v.clientWidth/2);u.set(v.clientHeight/2)}else if(p==1){h.set(0);u.set(0)}else if(p==2){h.set(.5);u.set(.5)}else if(p==3){if(v.clientWidth===0){setTimeout(E,50)}h.set(v.clientWidth/2/m.pixelDensity);u.set(v.clientHeight/2/m.pixelDensity)}else console.error("unknown normalize mouse",p)}function V(r,n){r=r||0;n=n||0;if(p==0){h.set(r);u.set(n)}else if(p==3){h.set(r*m.pixelDensity);u.set(n*m.pixelDensity)}else{let i=v.clientWidth/m.pixelDensity;let s=v.clientHeight/m.pixelDensity;i=i||1;s=s||1;if(p==1){let e=r/i*2-1;let t=n/s*2-1;e=CABLES.clamp(e,-1,1);t=CABLES.clamp(t,-1,1);h.set(e);u.set(t)}else if(p==2){let e=r/i;let t=n/s;e=CABLES.clamp(e,0,1);t=CABLES.clamp(t,0,1);h.set(e);u.set(t)}}}function b(e){if(!v)return;const t=v.getBoundingClientRect();return e.clientX>t.left&&e.clientX<t.left+t.width&&e.clientY>t.top&&e.clientY<t.top+t.height}o.onChange=s.onChange=function(){r.setUiAttribs({greyout:o.isLinked()});L();D()};l.onChange=function(){if(_)L();if(l.get())D()};function k(){if(e.get()=="Pixel")p=0;else if(e.get()=="-1 to 1")p=1;else if(e.get()=="0 to 1")p=2;else if(e.get()=="Pixel Display")p=3}function x(e){d.setRef(e);f.set(false);g.set(b(e))}function T(e){if(!b(e))return;F(e);d.setRef(e);f.set(true)}function A(e){F(e);d.setRef(e);f.set(false)}function S(e){if(!b(e))return;d.setRef(e);U.trigger();if(i.get())e.preventDefault()}function M(e){if(!b(e))return;F(e);d.setRef(e);c.trigger()}function I(e){d.setRef(e);f.set(false);g.set(b(e))}function O(e){g.set(b(e));if(r.get()==="Canvas Area"){const t=v.getBoundingClientRect();const i=e.clientX-t.left;const s=e.clientY-t.top;if(i<0||i>t.width||s>t.height||s<0)return}d.setRef(e);F(e);w.set(e.movementX/m.pixelDensity);B.set(e.movementY/m.pixelDensity)}function R(e){if(event.touches&&event.touches.length>0)F(e.touches[0]);d.setRef(e)}function C(e){f.set(true);if(e.touches&&e.touches.length>0)T(e.touches[0]);d.setRef(e)}function P(e){f.set(false);A();d.setRef(e)}function N(e){console.log("mouse cancel");f.set(false);A();d.setRef(e)}function F(e){let t=e.clientX;let i=e.clientY;if(o.isLinked()){t=e.offsetX;i=e.offsetY}else{if(r.get()!="Document"){t=e.offsetX;i=e.offsetY}if(r.get()==="Canvas Area"){const s=v.getBoundingClientRect();t=e.clientX-s.left;i=e.clientY-s.top;if(t<0||t>s.width||i>s.height||i<0)return;t=CABLES.clamp(t,0,s.width);i=CABLES.clamp(i,0,s.height)}}if(n.get())i=v.clientHeight-i;V(t/m.pixelDensity,i/m.pixelDensity)}function L(){if(!_)return;_.removeEventListener("touchend",P);_.removeEventListener("touchstart",C);_.removeEventListener("touchmove",R);_.removeEventListener("touchcancel",N);_.removeEventListener("mousemove",O);_.removeEventListener("mouseleave",I);_.removeEventListener("mousedown",T);_.removeEventListener("mouseup",A);_.removeEventListener("mouseenter",x);_.removeEventListener("pointermove",O);_.removeEventListener("pointerleave",I);_.removeEventListener("pointerdown",T);_.removeEventListener("pointerup",A);_.removeEventListener("pointerenter",x);_.removeEventListener("pointercancel",N);_.removeEventListener("click",M);_.removeEventListener("contextmenu",S);_=null}function D(){if(_||!l.get())L();if(!l.get())return;_=v=m.canvas;if(o.isLinked()){_=v=o.get()}else{if(r.get()=="Canvas Area"&&m&&m.canvas){v=m.canvas.parentElement;_=document.body}if(r.get()=="Document")v=_=document.body;if(r.get()=="Parent Element")_=v=m.canvas.parentElement}if(!v){t.setUiError("noarea","could not find area element for mouse",2);return}t.setUiError("noarea",null);let e=false;if(a.get())e={passive:true};if(s.get()=="Touch"){_.addEventListener("touchend",P,e);_.addEventListener("touchstart",C,e);_.addEventListener("touchmove",R,e)}if(s.get()=="Mouse"){_.addEventListener("mousemove",O,e);_.addEventListener("mouseleave",I,e);_.addEventListener("mousedown",T,e);_.addEventListener("mouseup",A,e);_.addEventListener("mouseenter",x,e)}if(s.get()=="Pointer"){_.addEventListener("pointermove",O,e);_.addEventListener("pointerleave",I,e);_.addEventListener("pointerdown",T,e);_.addEventListener("pointerup",A,e);_.addEventListener("pointerenter",x,e)}_.addEventListener("contextmenu",S,e);_.addEventListener("click",M,e)}}};CABLES.OPS["c86eb411-a996-47cd-a149-264903dc408c"]={f:Ops.Devices.Mouse.Mouse_v4,objName:"Ops.Devices.Mouse.Mouse_v4"};Ops.Math.Interpolate=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inFloat("Value 1"),s=e.inFloat("Value 2"),r=e.inFloatSlider("Percentage"),n=e.outNumber("Result");i.onChange=s.onChange=r.onChange=a;function a(){n.set((s.get()-i.get())*r.get()+i.get())}}};CABLES.OPS["d126e2c8-221e-428f-8ff4-8b8c5f6b8905"]={f:Ops.Math.Interpolate,objName:"Ops.Math.Interpolate"};Ops.Vars.VarSetNumber_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValueFloat("Value",0);e.varName=e.inDropDown("Variable",[],"",true);new CABLES.VarSetOpWrapper(e,"number",i,e.varName)}};CABLES.OPS["b5249226-6095-4828-8a1c-080654e192fa"]={f:Ops.Vars.VarSetNumber_v2,objName:"Ops.Vars.VarSetNumber_v2"};Ops.Patch.PJdRYK1.SpringCustom=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inTrigger("exe"),s=e.inFloat("value",0),r=e.inFloatSlider("damping",.2),n=e.inFloatSlider("stiffness",.7),a=e.outTrigger("trigger"),o=e.outNumber("result");let l=CABLES.now();let h=0;let u=0;let c=0;let f=n.get();let g=r.get();let d=.001;let m=.001;r.onChange=function(){g=r.get()};n.onChange=function(){f=n.get()};i.onTriggered=function(){h=CABLES.now()-l;h=Math.min(h,50);let e=Math.max(0,1-g*50*h*.001);let t=(s.get()-u)*f*10*h*.01;c=c*e+t;u+=c*h*.01;if(Math.abs(u-s.get())<d&&Math.abs(c)<m){u=s.get();c=0}o.set(u);l=CABLES.now();a.trigger()}}};CABLES.OPS["41e7f81b-0e6e-4334-bd8c-b74dabd260fa"]={f:Ops.Patch.PJdRYK1.SpringCustom,objName:"Ops.Patch.PJdRYK1.SpringCustom"};Ops.Cables.FPS_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.outNumber("FPS"),s=e.outNumber("MS");const r=e.patch.cgl.fpsCounter.addEventListener("performance",n);e.onDelete=function(){e.patch.removeEventListener(r)};function n(e){i.set(e.fps);s.set(e.ms)}}};CABLES.OPS["6dbb866c-b57a-4875-9f1d-22172162eaa8"]={f:Ops.Cables.FPS_v2,objName:"Ops.Cables.FPS_v2"};Ops.Vars.VarGetNumber_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.outNumber("Value");e.varName=e.inValueSelect("Variable",[],"",true);new CABLES.VarGetOpWrapper(e,"number",e.varName,i)}};CABLES.OPS["421f5b52-c0fa-47c4-8b7a-012b9e1c864a"]={f:Ops.Vars.VarGetNumber_v2,objName:"Ops.Vars.VarGetNumber_v2"};Ops.Gl.Phong.PointLight_v5=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const y=e.attachments={};const t=e.patch.cgl;const U=t.gl;const w=CGL.MESHES.getSimpleRect(t,"fullscreenRectangle");function B(e){this.type=e.type||"point";this.color=e.color||[1,1,1];this.specular=e.specular||[0,0,0];this.position=e.position||null;this.intensity=e.intensity||1;this.radius=e.radius||1;this.falloff=e.falloff||1;this.spotExponent=e.spotExponent||1;this.cosConeAngle=Math.cos(CGL.DEG2RAD*this.coneAngle);this.conePointAt=e.conePointAt||[0,0,0];this.castShadow=e.castShadow||false;return this}const i=e.inTrigger("Trigger In");const s=e.inBool("Cast Light",true);const r=e.inFloat("Intensity",2);const n=e.inFloat("Radius",15);const a=e.inFloat("X",0);const o=e.inFloat("Y",2);const l=e.inFloat("Z",.75);const h=[a,o,l];e.setPortGroup("Position",h);const u=e.inFloat("R",.8);const c=e.inFloat("G",.8);const f=e.inFloat("B",.8);u.setUiAttribs({colorPick:true});const g=[u,c,f];e.setPortGroup("Color",g);const d=e.inFloat("Specular R",1);const m=e.inFloat("Specular G",1);const p=e.inFloat("Specular B",1);d.setUiAttribs({colorPick:true});const _=[d,m,p];e.setPortGroup("Specular Color",_);const v=e.inFloatSlider("Falloff",.5);const V=[r,s,n];e.setPortGroup("Light Attributes",V);const E=e.inBool("Cast Shadow",false);const b=e.inBool("Rendering Active",true);const x=e.inSwitch("Map Size",[256,512,1024,2048],512);const T=e.inFloatSlider("Shadow Strength",1);const A=e.inFloat("Near",.1);const S=e.inFloat("Far",30);const M=e.inFloatSlider("Bias",.004);const I=e.inInt("Polygon Offset",0);e.setPortGroup("",[E]);e.setPortGroup("Shadow Map Settings",[x,b,T,A,S,M,I]);const k=[A,S];x.setUiAttribs({greyout:!E.get()});b.setUiAttribs({greyout:!E.get()});T.setUiAttribs({greyout:!E.get()});A.setUiAttribs({greyout:!E.get()});M.setUiAttribs({greyout:!E.get()});S.setUiAttribs({greyout:!E.get()});I.setUiAttribs({greyout:!E.get()});let O=false;E.onChange=function(){O=true;N=true;x.setUiAttribs({greyout:!E.get()});b.setUiAttribs({greyout:!E.get()});T.setUiAttribs({greyout:!E.get()});A.setUiAttribs({greyout:!E.get()});S.setUiAttribs({greyout:!E.get()});M.setUiAttribs({greyout:!E.get()});I.setUiAttribs({greyout:!E.get()})};const R=e.outTrigger("Trigger Out");const C=e.outObject("Cubemap",null,"texture");const G=e.outNumber("World Position X");const j=e.outNumber("World Position Y");const H=e.outNumber("World Position Z");const P=new CGL.Light(t,{type:"point",position:[0,1,2].map(function(e){return h[e].get()}),color:[0,1,2].map(function(e){return g[e].get()}),specular:[0,1,2].map(function(e){return _[e].get()}),intensity:r.get(),radius:n.get(),falloff:v.get(),shadowStrength:T.get(),shadowBias:M.get()});P.castLight=s.get();let N=false;a.onChange=o.onChange=l.onChange=u.onChange=c.onChange=f.onChange=d.onChange=m.onChange=p.onChange=r.onChange=s.onChange=n.onChange=v.onChange=A.onChange=S.onChange=T.onChange=function(){N=true};x.onChange=function(){O=true};function z(){if(E.get()){const e=x.get();P.createFramebuffer(e,e,{});P.createShadowMapShader()}O=false}const X=vec3.create();const Y=vec3.create();const F=vec3.create();const L=vec3.create();function W(){if(t.tempData.shadowPass)return;if(CABLES.UI)gui.setTransform(e.id,a.get(),o.get(),l.get());if(e.isCurrentUiOp()){gui.setTransformGizmo({posX:a,posY:o,posZ:l});t.pushModelMatrix();mat4.translate(t.mMatrix,t.mMatrix,L);CABLES.GL_MARKER.drawSphere(e,n.get());t.popModelMatrix()}}let D=false;i.onTriggered=function(){if(O){if(t.tempData.shadowPass)return;z()}if(!t.tempData.shadowPass){if(!P.isUsed&&!D){e.setUiError("lightUsed","No operator is using this light. Make sure this op is positioned before an operator that uses lights. Also make sure there is an operator that uses lights after this.",1);D=true}else if(!P.isUsed&&D){}else if(P.isUsed&&D){e.setUiError("lightUsed",null);D=false}else if(P.isUsed&&!D){}P.isUsed=false}if(N){P.position=[0,1,2].map(function(e){return h[e].get()});P.color=[0,1,2].map(function(e){return g[e].get()});P.specular=[0,1,2].map(function(e){return _[e].get()});P.intensity=r.get();P.radius=n.get();P.falloff=v.get();P.castShadow=E.get();P.castLight=s.get();P.updateProjectionMatrix(null,A.get(),S.get(),null);N=false}if(!t.tempData.lightStack)t.tempData.lightStack=[];vec3.set(L,a.get(),o.get(),l.get());vec3.transformMat4(F,L,t.mMatrix);P.position=F;G.set(P.position[0]);j.set(P.position[1]);H.set(P.position[2]);if(!t.tempData.shadowPass)W();t.tempData.lightStack.push(P);if(E.get()){if(b.get())P.renderPasses(I.get(),null,function(){R.trigger()});if(!t.tempData.shadowPass){t.tempData.lightStack.pop();P.castShadow=E.get();P.shadowBias=M.get();P.shadowStrength=T.get();if(P.shadowCubeMap){if(P.shadowCubeMap.cubemap){C.set(null);C.set(P.shadowCubeMap);if(b.get()){P.positionForShadowMap=[P.position[0],P.position[1],P.position[2]]}}}t.tempData.lightStack.push(P)}}else{C.set(null)}R.trigger();t.tempData.lightStack.pop()}}};CABLES.OPS["54e5d3f5-e3f4-4381-990d-d5e32b9a2d39"]={f:Ops.Gl.Phong.PointLight_v5,objName:"Ops.Gl.Phong.PointLight_v5"};Ops.Gl.Textures.NoiseTexture=class extends CABLES.Op{constructor(){super(...arguments);const p=this;const e=p.attachments={};const _=p.inValueInt("Width",256),v=p.inValueInt("Height",256),E=p.inSwitch("Filter",["nearest","linear"],"nearest"),b=p.inValueSelect("Wrap",["repeat","mirrored repeat","clamp to edge"],"repeat"),x=p.inValueBool("Color",false),T=p.inDropDown("Pixel Format",CGL.Texture.PIXELFORMATS,CGL.Texture.PFORMATSTR_RGBA8UB),A=p.inBool("Integer",false),S=p.inFloat("Seed",1),M=p.inBool("Channel R",true),I=p.inFloat("Min R",0),O=p.inFloat("Max R",1),R=p.inBool("Channel G",true),C=p.inFloat("Min G",0),P=p.inFloat("Max G",1),N=p.inBool("Channel B",true),F=p.inFloat("Min B",0),L=p.inFloat("Max B",1),D=p.inBool("Channel A",true),y=p.inFloat("Min A",1),U=p.inFloat("Max A",1),w=p.outTexture("Texture"),B=p.outNumber("Total Pixel");const V=p.patch.cgl;let t=null;let k=null;S.onChange=_.onChange=v.onChange=T.onChange=I.onChange=O.onChange=C.onChange=y.onChange=P.onChange=U.onChange=F.onChange=L.onChange=M.onChange=N.onChange=R.onChange=D.onChange=E.onChange=b.onChange=A.onChange=x.onChange=i;i();function i(){if(k)V.patch.loading.finished(k);k=V.patch.loading.start("noisetexture","noisetexture");V.addNextFrameOnceCallback(s)}function s(){const e=T.get().indexOf("float")>-1;if(!e){if(I.get()<0||I.get()>1||C.get()<0||C.get()>1||F.get()<0||F.get()>1||O.get()<0||O.get()>1||U.get()<0||U.get()>1||P.get()<0||P.get()>1||L.get()<0||L.get()>1)p.setUiError("nonfprange","Non floating point textures have to be between 0 and 1");else p.setUiError("nonfprange",null)}else p.setUiError("nonfprange",null);C.setUiAttribs({greyout:!x.get()});P.setUiAttribs({greyout:!x.get()});F.setUiAttribs({greyout:!x.get()});L.setUiAttribs({greyout:!x.get()});U.setUiAttribs({greyout:!x.get()});let t=Math.ceil(_.get());let i=Math.ceil(v.get());if(t<1)t=1;if(i<1)i=1;let s;const r=t*4*i;const n=I.get();const a=O.get()-n;const o=C.get();const l=P.get()-o;const h=F.get();const u=L.get()-h;const c=y.get();const f=U.get()-c;Math.randomSeed=S.get();if(e){s=new Float32Array(r);if(x.get()){for(let e=0;e<r;e+=4){s[e+0]=n+Math.seededRandom()*a;s[e+1]=o+Math.seededRandom()*l;s[e+2]=h+Math.seededRandom()*u;s[e+3]=c+Math.seededRandom()*f}}else{for(let t=0;t<r;t+=4){let e=n+Math.seededRandom()*a;s[t+0]=s[t+1]=s[t+2]=e;s[t+3]=1}}}else{s=new Uint8Array(r);if(x.get()){for(let e=0;e<r;e+=4){s[e+0]=(n+Math.seededRandom()*a)*255;s[e+1]=(o+Math.seededRandom()*l)*255;s[e+2]=(h+Math.seededRandom()*u)*255;s[e+3]=(c+Math.seededRandom()*f)*255}}else{for(let e=0;e<r;e+=4){s[e+0]=s[e+1]=s[e+2]=(n+Math.seededRandom()*a)*255;s[e+3]=255}}}if(A.get()){for(let e=0;e<s.length;e++)s[e]=Math.round(s[e]-.5)}if(!M.get())for(let e=0;e<r;e+=4)s[e+0]=0;if(!R.get())for(let e=0;e<r;e+=4)s[e+1]=0;if(!N.get())for(let e=0;e<r;e+=4)s[e+2]=0;if(!D.get())for(let e=0;e<r;e+=4)s[e+3]=0;let g=CGL.Texture.FILTER_NEAREST;if(E.get()=="linear")g=CGL.Texture.FILTER_LINEAR;let d=CGL.Texture.WRAP_REPEAT;if(b.get()=="mirrored repeat")d=CGL.Texture.WRAP_MIRRORED_REPEAT;if(b.get()=="clamp to edge")d=CGL.Texture.WRAP_CLAMP_TO_EDGE;let m=new CGL.Texture(V,{isFloatingPointTexture:e,name:"noisetexture"});m.initFromData(s,t,i,g,d);B.set(t*i);w.setRef(m);k=V.patch.loading.finished(k)}}};CABLES.OPS["b781bc6b-b2cf-44fe-80eb-a840e430d27d"]={f:Ops.Gl.Textures.NoiseTexture,objName:"Ops.Gl.Textures.NoiseTexture"};Ops.Gl.ImageCompose.DepthTexture_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={depthtexture_frag:"IN vec2 texCoord;\nUNI float amount;\nUNI sampler2D texDepth;\nUNI sampler2D texBase;\nUNI float n;\nUNI float f;\n\n{{CGL.BLENDMODES3}}\n\nvoid main()\n{\n    vec4 col=texture(texDepth,texCoord);\n    float z=col.r;\n    float c=(2.0*n)/(f+n-z*(f-n));\n\n    #ifdef INVERT\n       c=1.0-c;\n    #endif\n\n    col=vec4(c,c,c,1.0);\n    vec4 base=texture(texBase,texCoord);\n\n    outColor=cgl_blendPixel(base,col,amount);\n\n}"};const i=e.inTrigger("render"),s=e.inTexture("image"),r=CGL.TextureEffect.AddBlendSelect(e,"Blend Mode","normal"),n=e.inValueSlider("Amount",1),a=e.inValue("farplane",50),o=e.inValue("nearplane",.1),l=e.inValueBool("Invert",false),h=e.outTrigger("trigger");e.setPortGroup("Frustum",[a,o]);const u=e.patch.cgl;const c=new CGL.Shader(u,e.name,e);c.setSource(c.getDefaultVertexShader(),t.depthtexture_frag);const f=new CGL.Uniform(c,"t","texDepth",0),g=new CGL.Uniform(c,"t","texBase",1),d=new CGL.Uniform(c,"f","amount",n),m=new CGL.Uniform(c,"f","f",a),p=new CGL.Uniform(c,"f","n",o);CGL.TextureEffect.setupBlending(e,c,r,n);l.onChange=function(){if(l.get())c.define("INVERT");else c.removeDefine("INVERT")};i.onTriggered=function(){if(!CGL.TextureEffect.checkOpInEffect(e,3))return;if(s.get()&&s.get().tex){u.pushShader(c);u.currentTextureEffect.bind();u.setTexture(0,s.get().tex);u.setTexture(1,u.currentTextureEffect.getCurrentSourceTexture().tex);u.currentTextureEffect.finish();u.popShader()}h.trigger()}}};CABLES.OPS["5958fbb8-fb78-4de2-85dc-5eb289f652cb"]={f:Ops.Gl.ImageCompose.DepthTexture_v2,objName:"Ops.Gl.ImageCompose.DepthTexture_v2"};Ops.Gl.ImageCompose.Invert_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={invert_frag:"IN vec2 texCoord;\nUNI sampler2D tex;\nUNI sampler2D texMask;\nUNI float amount;\n\n{{CGL.BLENDMODES3}}\n\nvoid main()\n{\n    vec4 col=texture(tex,texCoord);\n\n    #ifdef USE_MASK\n        #ifdef MASK_INVERT\n            if(texture(texMask,texCoord).r>0.5)\n            {\n                outColor= col;\n                return;\n            }\n        #endif\n\n        #ifndef MASK_INVERT\n            if(texture(texMask,texCoord).r<0.5)\n            {\n                outColor= col;\n                return;\n            }\n        #endif\n    #endif\n\n\n    vec3 m=vec3( INVR , INVG , INVB );\n    vec4 invert = vec4(clamp(m-col.rgb,0.0,1.0),col.a);\n\n    outColor=cgl_blendPixel(col,invert,amount);\n\n    // outColor.rgb=m;\n}\n"};const i=e.inTrigger("render"),s=CGL.TextureEffect.AddBlendSelect(e,"Blend Mode","normal"),r=e.inValueSlider("Amount",1),n=e.inBool("Mask Invert",false),a=e.inTexture("Mask"),o=e.inBool("Invert R",true),l=e.inBool("Invert G",true),h=e.inBool("Invert B",true),u=e.outTrigger("trigger");const c=e.patch.cgl;const f=new CGL.Shader(c,e.name,e);f.setSource(f.getDefaultVertexShader(),t.invert_frag);const g=new CGL.Uniform(f,"t","tex",0),d=new CGL.Uniform(f,"f","amount",r),m=new CGL.Uniform(f,"t","texMask",1);CGL.TextureEffect.setupBlending(e,f,s,r);n.onChange=o.onChange=l.onChange=h.onChange=a.onLinkChanged=p;p();function p(){f.toggleDefine("USE_MASK",a.isLinked());f.toggleDefine("MASK_INVERT",n.get());f.define("INVR",o.get()?"1.0":"0.0");f.define("INVG",l.get()?"1.0":"0.0");f.define("INVB",h.get()?"1.0":"0.0")}i.onTriggered=function(){if(!CGL.TextureEffect.checkOpInEffect(e,3))return;c.pushShader(f);c.currentTextureEffect.bind();c.setTexture(0,c.currentTextureEffect.getCurrentSourceTexture().tex);if(a.get())c.setTexture(1,a.get().tex);c.currentTextureEffect.finish();c.popShader();u.trigger()}}};CABLES.OPS["56e8c95b-da89-423b-9d31-23351c263bb6"]={f:Ops.Gl.ImageCompose.Invert_v2,objName:"Ops.Gl.ImageCompose.Invert_v2"};Ops.Gl.ImageCompose.Dither_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={dither_frag:"IN vec2 texCoord;\nUNI sampler2D tex;\n#ifdef MASK\n    UNI sampler2D texMask;\n#endif\n\nUNI float strength;\nUNI float amount;\nUNI float width;\nUNI float height;\nUNI float threshold;\n\nfloat lumi( vec4 col ) {\n    return (0.2126*col.r + 0.7152*col.g + 0.0722*col.b);\n}\n\n{{CGL.BLENDMODES3}}\n\nfloat adjustFrag( mat4 adjustments,float val, vec2 coord )\n{\n    vec2 coordMod = mod(vec2(coord.x*width,coord.y*height), 4.0);\n    int xMod = int(coordMod.x);\n    int yMod = int(coordMod.y);\n\n    vec4 col;\n    if (xMod == 0) col = adjustments[0];\n    else if (xMod == 1) col = adjustments[1];\n    else if (xMod == 2) col = adjustments[2];\n    else if (xMod == 3) col = adjustments[3];\n\n    float adjustment;\n    if (yMod == 0) adjustment = col.x;\n    else if (yMod == 1) adjustment = col.y;\n    else if (yMod == 2) adjustment = col.z;\n    else if (yMod == 3) adjustment = col.w;\n\n    return val + (val * adjustment);\n}\n\nvoid main()\n{\n    mat4 adjustments = ((mat4(\n        1, 13, 4, 16,\n        9, 5, 12, 8,\n        3, 15, 2, 14,\n        11, 7, 10, 6\n    ) - 8.) *  1.0 / strength);\n\n    vec4 base=texture(tex,texCoord);\n    vec4 color;\n    float am=amount;\n\n    #ifdef MASK\n        float m=texture(texMask,texCoord).r;\n        #ifdef MASK_SRC_1R\n            m=1.0-m;\n        #endif\n        am*=m;\n    #endif\n\n    float lum = lumi(base);\n    lum = adjustFrag(adjustments,lum, texCoord.xy);\n\n    if (lum > threshold) color = vec4(1, 1, 1, base.a);\n    else color = vec4(0, 0, 0, base.a);\n\n    outColor=cgl_blendPixel(base,color,am);\n}"};const i=e.inTrigger("Render"),s=CGL.TextureEffect.AddBlendSelect(e,"Blend Mode","normal"),r=e.inValueSlider("Amount",1),n=e.inValueSlider("threshold",.35),a=e.inValue("strength",2),o=e.inTexture("Mask"),l=e.inSwitch("Mask Src",["R","1-R"],"R"),h=e.outTrigger("Trigger");const u=e.patch.cgl,c=new CGL.Shader(u,e.name,e);c.setSource(c.getDefaultVertexShader(),t.dither_frag);const f=new CGL.Uniform(c,"t","tex",0),g=new CGL.Uniform(c,"t","texMask",1),d=new CGL.Uniform(c,"f","amount",r),m=new CGL.Uniform(c,"f","strength",a),p=new CGL.Uniform(c,"f","width",0),_=new CGL.Uniform(c,"f","height",0),v=new CGL.Uniform(c,"f","threshold",n);CGL.TextureEffect.setupBlending(e,c,s,r);l.onChange=o.onLinkChanged=function(){c.toggleDefine("MASK",o.isLinked());c.toggleDefine("MASK_SRC_R",l.get()=="R");c.toggleDefine("MASK_SRC_1R",l.get()=="1-R")};i.onTriggered=function(){if(!CGL.TextureEffect.checkOpInEffect(e,3))return;u.pushShader(c);u.currentTextureEffect.bind();p.setValue(u.currentTextureEffect.getCurrentSourceTexture().width);_.setValue(u.currentTextureEffect.getCurrentSourceTexture().height);u.setTexture(0,u.currentTextureEffect.getCurrentSourceTexture().tex);if(o.get())u.setTexture(1,o.get().tex);u.currentTextureEffect.finish();u.popShader();h.trigger()}}};CABLES.OPS["686ae373-2d2d-44cc-b45f-2ccb782dea26"]={f:Ops.Gl.ImageCompose.Dither_v2,objName:"Ops.Gl.ImageCompose.Dither_v2"};Ops.Gl.ImageCompose.Plasma_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={plasma_frag:"#define PI 3.1415926535897932384626433832795\n\nIN vec2 texCoord;\n\nUNI sampler2D tex;\nUNI vec2 size;\nUNI vec2 pos;\nUNI float mul;\nUNI float amount;\nUNI float time;\nUNI float aspect;\n\n#ifdef HAS_TEX_OFFSETMAP\n    UNI sampler2D texOffsetZ;\n    UNI float offMul;\n#endif\n\n#ifdef HAS_TEX_MASK\n    UNI sampler2D texMask;\n#endif\n\n\n{{CGL.BLENDMODES3}}\n\nvoid main()\n{\n    float v = 0.0;\n\n    vec2 s=size;\n    #ifdef FIXASPECT\n        s.y=size.x/aspect;\n    #endif\n\n    vec2 c = texCoord * s - s/2.0;\n\n    c+=pos;\n\n    vec3 offset;\n    #ifdef HAS_TEX_OFFSETMAP\n        vec4 offMap=texture(texOffsetZ,texCoord);\n\n        #ifdef OFFSET_X_R\n            offset.x=offMap.r;\n        #endif\n        #ifdef OFFSET_X_G\n            offset.x=offMap.g;\n        #endif\n        #ifdef OFFSET_X_B\n            offset.x=offMap.b;\n        #endif\n\n        #ifdef OFFSET_Y_R\n            offset.y=offMap.r;\n        #endif\n        #ifdef OFFSET_Y_G\n            offset.y=offMap.g;\n        #endif\n        #ifdef OFFSET_Y_B\n            offset.y=offMap.b;\n        #endif\n\n        #ifdef OFFSET_Z_R\n            offset.z=offMap.r;\n        #endif\n        #ifdef OFFSET_Z_G\n            offset.z=offMap.g;\n        #endif\n        #ifdef OFFSET_Z_B\n            offset.z=offMap.b;\n        #endif\n        offset*=offMul;\n    #endif\n\n    c+=offset.xy;\n    float t=time+offset.z;\n\n    v += sin((c.x+t));\n    v += sin((c.y+t)/2.0);\n    v += sin((c.x+c.y+t)/2.0);\n    c += size/2.0 * vec2(sin(t/3.0), cos(t/2.0));\n\n    v += sin(sqrt(c.x*c.x+c.y*c.y+1.0)+t);\n    v = v/2.0;\n\n    vec3 newColor = vec3(sin(PI*v*mul/4.0), sin(PI*v*mul), cos(PI*v*mul))*.5 + .5;\n    vec4 base=texture(tex,texCoord);\n\n    #ifndef GREY\n       vec4 col=vec4( _blend(base.rgb,newColor) ,1.0);\n    #endif\n    #ifdef GREY\n       vec4 col=vec4( _blend(base.rgb,vec3(newColor.g)) ,1.0);\n    #endif\n\n    float str=1.0;\n    #ifdef HAS_TEX_MASK\n        str=texture(texMask,texCoord).r;\n    #endif\n\n    outColor=cgl_blendPixel(base,col,amount*str);\n}\n\n"};const i=e.inTrigger("render"),s=CGL.TextureEffect.AddBlendSelect(e,"Blend Mode","normal"),r=CGL.TextureEffect.AddBlendAlphaMask(e),n=e.inValueSlider("Amount",1),a=e.inValue("Width",20),o=e.inValue("Height",20),l=e.inBool("Aspect",true),h=e.inValue("Mul",1),u=e.inValue("X",0),c=e.inValue("Y",0),f=e.inValue("Time",1),g=e.inValueBool("Greyscale",true),d=e.inTexture("Offset"),m=e.inFloat("Offset Multiply",1),p=e.inSwitch("Offset X",["None","R","G","B"],"None"),_=e.inSwitch("Offset Y",["None","R","G","B"],"None"),v=e.inSwitch("Offset Time",["None","R","G","B"],"R"),E=e.inTexture("Mask"),b=e.outTrigger("trigger");e.setPortGroup("Offset Map",[d,v,_,p,m]);const x=e.patch.cgl;const T=new CGL.Shader(x,e.name,e);T.setSource(T.getDefaultVertexShader(),t.plasma_frag);CGL.TextureEffect.setupBlending(e,T,s,n,r);const A=new CGL.Uniform(T,"2f","pos",u,c),S=new CGL.Uniform(T,"2f","size",a,o),M=new CGL.Uniform(T,"f","time",f),I=new CGL.Uniform(T,"f","mul",h),O=new CGL.Uniform(T,"f","aspect",1),R=new CGL.Uniform(T,"f","offMul",m),C=new CGL.Uniform(T,"t","tex",0),P=new CGL.Uniform(T,"t","texOffsetZ",1),N=new CGL.Uniform(T,"t","texMask",2),F=new CGL.Uniform(T,"f","amount",n);p.onChange=l.onChange=_.onChange=v.onChange=E.onChange=g.onChange=d.onLinkChanged=L;L();function L(){T.toggleDefine("GREY",g.get());T.toggleDefine("HAS_TEX_OFFSETMAP",d.isLinked());T.toggleDefine("HAS_TEX_MASK",E.isLinked());T.toggleDefine("OFFSET_X_R",p.get()=="R");T.toggleDefine("OFFSET_X_G",p.get()=="G");T.toggleDefine("OFFSET_X_B",p.get()=="B");T.toggleDefine("OFFSET_Y_R",_.get()=="R");T.toggleDefine("OFFSET_Y_G",_.get()=="G");T.toggleDefine("OFFSET_Y_B",_.get()=="B");T.toggleDefine("OFFSET_Z_R",v.get()=="R");T.toggleDefine("OFFSET_Z_G",v.get()=="G");T.toggleDefine("OFFSET_Z_B",v.get()=="B");p.setUiAttribs({greyout:!d.isLinked()});_.setUiAttribs({greyout:!d.isLinked()});v.setUiAttribs({greyout:!d.isLinked()});m.setUiAttribs({greyout:!d.isLinked()});o.setUiAttribs({greyout:l.get()});T.toggleDefine("FIXASPECT",l.get())}i.onTriggered=function(){if(!CGL.TextureEffect.checkOpInEffect(e,3))return;x.pushShader(T);x.currentTextureEffect.bind();if(l.get())O.setValue(x.currentTextureEffect.aspectRatio);else O.setValue(1);x.setTexture(0,x.currentTextureEffect.getCurrentSourceTexture().tex);if(d.get())x.setTexture(1,d.get().tex);if(E.get())x.setTexture(2,E.get().tex);x.currentTextureEffect.finish();x.popShader();b.trigger()}}};CABLES.OPS["89b3bf34-a9a8-4dcf-a304-9dee597fcf48"]={f:Ops.Gl.ImageCompose.Plasma_v2,objName:"Ops.Gl.ImageCompose.Plasma_v2"};Ops.Math.OneMinus=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValue("Value"),s=e.outNumber("Result");i.onChange=r;r();function r(){s.set(1-i.get())}}};CABLES.OPS["f34d019d-59ae-40d6-a55d-a7691bbc40e0"]={f:Ops.Math.OneMinus,objName:"Ops.Math.OneMinus"};Ops.Gl.ImageCompose.ColorMap_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={colormap_frag:"IN vec2 texCoord;\nUNI sampler2D tex;\nUNI sampler2D gradient;\nUNI float pos;\nUNI float amount;\nUNI float vmin;\nUNI float vmax;\n\n{{CGL.BLENDMODES3}}\n\n\nfloat lumi(vec3 color)\n{\n   return vec3(dot(vec3(0.2126,0.7152,0.0722), color)).r;\n}\n\nvoid main()\n{\n    vec4 base=texture(tex,texCoord);\n    float a=base.a;\n\n    base=clamp(base,vmin,vmax);\n\n    #ifdef METH_LUMI\n        vec4 color=texture(gradient,vec2(lumi(base.rgb),pos));\n    #endif\n\n    #ifdef METH_CHANNELS\n        vec4 color=vec4(1.0);\n        color.r=texture(gradient,vec2(base.r,pos)).r;\n        color.g=texture(gradient,vec2(base.g,pos)).g;\n        color.b=texture(gradient,vec2(base.b,pos)).b;\n    #endif\n\n    base.a=color.a=a;\n\n\n    outColor=cgl_blendPixel(base,color,amount);\n\n}\n"};let i=e.inTrigger("render");let s=e.outTrigger("trigger");const r=CGL.TextureEffect.AddBlendSelect(e,"Blend Mode","normal");const n=e.inValueSlider("Amount",1);let a=e.inTexture("Gradient");let o=e.inSwitch("Method",["Luminance","Channels"],"Luminance");let l=e.inFloatSlider("Min",0);let h=e.inFloatSlider("Max",1);let u=e.inValueSlider("Position",.5);e.setPortGroup("Vertical Position",[l,h,u]);let c=e.patch.cgl;let f=new CGL.Shader(c,e.name,e);f.define("METH_LUMI");f.setSource(f.getDefaultVertexShader(),t.colormap_frag);let g=new CGL.Uniform(f,"t","tex",0);let d=new CGL.Uniform(f,"t","gradient",1);let m=new CGL.Uniform(f,"f","pos",u);let p=new CGL.Uniform(f,"f","vmin",l);let _=new CGL.Uniform(f,"f","vmax",h);let v=new CGL.Uniform(f,"f","amount",n);CGL.TextureEffect.setupBlending(e,f,r,n);o.onChange=()=>{f.toggleDefine("METH_LUMI",o.get()=="Luminance");f.toggleDefine("METH_CHANNELS",o.get()=="Channels")};i.onTriggered=function(){if(!CGL.TextureEffect.checkOpInEffect(e,3))return;if(!a.get())return;c.pushShader(f);c.currentTextureEffect.bind();c.setTexture(0,c.currentTextureEffect.getCurrentSourceTexture().tex);c.setTexture(1,a.get().tex);c.currentTextureEffect.finish();c.popShader();s.trigger()}}};CABLES.OPS["440c1675-122d-411f-b848-16c60b677120"]={f:Ops.Gl.ImageCompose.ColorMap_v2,objName:"Ops.Gl.ImageCompose.ColorMap_v2"};Ops.Math.Round=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inValueFloat("number"),s=e.inInt("Decimal Places",0),r=e.outNumber("result");let n=0;i.onChange=o;s.onChange=a;a();function a(){n=Math.pow(10,s.get());o()}function o(){r.set(Math.round(i.get()*n)/n)}}};CABLES.OPS["1a1ef636-6d02-42ba-ae1e-627b917d0d2b"]={f:Ops.Math.Round,objName:"Ops.Math.Round"};Ops.Gl.Phong.SpotLight_v5=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const U=t.attachments={};const i=t.patch.cgl;const w=t.inTrigger("Trigger In");const s=t.inBool("Cast Light",true);const r=t.inFloat("Intensity",2);const n=t.inFloat("Radius",10);const a=t.inFloat("X",1);const o=t.inFloat("Y",3);const l=t.inFloat("Z",1);const h=[a,o,l];t.setPortGroup("Position",h);const u=t.inFloat("Point At X",0);const c=t.inFloat("Point At Y",0);const f=t.inFloat("Point At Z",0);const g=[u,c,f];t.setPortGroup("Point At",g);const e=t.inFloatSlider("R",1);const B=t.inFloatSlider("G",1);const V=t.inFloatSlider("B",1);e.setUiAttribs({colorPick:true});const d=[e,B,V];t.setPortGroup("Color",d);const m=t.inFloatSlider("Specular R",1);const k=t.inFloatSlider("Specular G",1);const G=t.inFloatSlider("Specular B",1);m.setUiAttribs({colorPick:true});const j=[m,k,G];t.setPortGroup("Specular Color",j);const p=t.inFloat("Cone Angle",120);const _=t.inFloat("Inner Cone Angle",60);const v=t.inFloat("Spot Exponent",.97);const H=[p,_,v];t.setPortGroup("Cone Attributes",H);const z=t.inFloatSlider("Falloff",1e-5);const X=[s,r,n];t.setPortGroup("Light Attributes",X);const E=t.inBool("Cast Shadow",false);const b=t.inBool("Rendering Active",true);const x=t.inSwitch("Map Size",[256,512,1024,2048],512);const T=t.inFloatSlider("Shadow Strength",.99);const A=t.inFloat("Near",.1);const S=t.inFloat("Far",30);const M=t.inFloatSlider("Bias",1e-4);const I=t.inInt("Polygon Offset",0);const O=t.inFloatSlider("Normal Offset",0);const R=t.inFloatSlider("Blur Amount",0);t.setPortGroup("",[E]);t.setPortGroup("Shadow Map Settings",[x,b,T,A,S,M,I,O,R]);x.setUiAttribs({greyout:true,hidePort:true});b.setUiAttribs({greyout:true});T.setUiAttribs({greyout:true});A.setUiAttribs({greyout:true,hidePort:true});S.setUiAttribs({greyout:true,hidePort:true});R.setUiAttribs({greyout:true,hidePort:true});I.setUiAttribs({greyout:true,hidePort:true});O.setUiAttribs({greyout:true,hidePort:true});M.setUiAttribs({greyout:true,hidePort:true});const C=t.inBool("Enable Advanced",false);const P=t.inSwitch("MSAA",["none","2x","4x","8x"],"none");const N=t.inSwitch("Texture Filter",["Linear","Nearest","Mip Map"],"Linear");const F=t.inSwitch("Anisotropic",[0,1,2,4,8,16],"0");P.setUiAttribs({greyout:true,hidePort:true});N.setUiAttribs({greyout:true,hidePort:true});F.setUiAttribs({greyout:true,hidePort:true});t.setPortGroup("Advanced Options",[C,P,N,F]);let L=false;C.setUiAttribs({hidePort:true});C.onChange=function(){P.setUiAttribs({greyout:!C.get()});N.setUiAttribs({greyout:!C.get()});F.setUiAttribs({greyout:!C.get()})};const Y=t.outTrigger("Trigger Out");const W=t.outTexture("Shadow Map");const q=t.outNumber("World Position X");const K=t.outNumber("World Position Y");const Z=t.outNumber("World Position Z");const D=new CGL.Light(i,{type:"spot",position:[0,1,2].map(function(e){return h[e].get()}),color:[0,1,2].map(function(e){return d[e].get()}),specular:[0,1,2].map(function(e){return j[e].get()}),conePointAt:[0,1,2].map(function(e){return g[e].get()}),intensity:r.get(),radius:n.get(),falloff:z.get(),cosConeAngleInner:Math.cos(CGL.DEG2RAD*_.get()),cosConeAngle:Math.cos(CGL.DEG2RAD*p.get()),spotExponent:v.get(),castShadow:false,shadowStrength:T.get(),shadowBias:M.get(),normalOffset:O.get()});D.castLight=s.get();let Q=false;e.onChange=B.onChange=V.onChange=m.onChange=k.onChange=G.onChange=u.onChange=c.onChange=f.onChange=a.onChange=o.onChange=l.onChange;s.onChange=r.onChange=n.onChange=z.onChange=p.onChange=_.onChange=v.onChange=T.onChange=A.onChange=S.onChange=J;function J(){Q=true}E.onChange=function(){L=true;const e=E.get();x.setUiAttribs({greyout:!e});b.setUiAttribs({greyout:!e});T.setUiAttribs({greyout:!e});A.setUiAttribs({greyout:!e});S.setUiAttribs({greyout:!e});O.setUiAttribs({greyout:!e});R.setUiAttribs({greyout:!e});M.setUiAttribs({greyout:!e});I.setUiAttribs({greyout:!e});Q=true};let $=1/Number(x.get());function ee(){const e=Number(P.get().charAt(0));let t=null;const i=Number(F.get());if(N.get()=="Linear"){t=CGL.Texture.FILTER_LINEAR}else if(N.get()=="Nearest"){t=CGL.Texture.FILTER_NEAREST}else if(N.get()=="Mip Map"){t=CGL.Texture.FILTER_MIPMAP}const s=Number(x.get());const r={isFloatingPointTexture:true,filter:t};if(e)Object.assign(r,{multisampling:true,multisamplingSamples:e});Object.assign(r,{anisotropic:i});D.createFramebuffer(s,s,r);D.createBlurEffect(r)}P.onChange=F.onChange=N.onChange=x.onChange=function(){L=true};function te(){const e=Number(x.get());$=1/e;if(E.get()){D.createFramebuffer(Number(x.get()),Number(x.get()),{});D.createShadowMapShader();D.createBlurEffect({});D.createBlurShader();D.updateProjectionMatrix(null,A.get(),S.get(),p.get())}if(C.get())ee();L=false}const ie=vec3.create();const se=vec3.create();const re=vec3.create();const ne=vec3.create();function ae(){if(i.tempData.shadowPass)return;if(i.shouldDrawHelpers(t)){gui.setTransformGizmo({posX:a,posY:o,posZ:l});CABLES.GL_MARKER.drawLineSourceDest(t,D.position[0],D.position[1],D.position[2],D.conePointAt[0],D.conePointAt[1],D.conePointAt[2])}}let y=false;w.onTriggered=oe;t.preRender=()=>{te();oe()};function oe(){if(L){if(i.tempData.shadowPass)return;te()}if(!i.tempData.shadowPass){if(!D.isUsed&&!y){t.setUiError("lightUsed","No operator is using this light. Make sure this op is positioned before an operator that uses lights. Also make sure there is an operator that uses lights after this.",1);y=true}else if(!D.isUsed&&y){}else if(D.isUsed&&y){t.setUiError("lightUsed",null);y=false}else if(D.isUsed&&!y){}D.isUsed=false}if(Q){D.position=[0,1,2].map(function(e){return h[e].get()});D.color=[0,1,2].map(function(e){return d[e].get()});D.specular=[0,1,2].map(function(e){return j[e].get()});D.conePointAt=[0,1,2].map(function(e){return g[e].get()});D.intensity=r.get();D.castLight=s.get();D.radius=n.get();D.falloff=z.get();D.cosConeAngleInner=Math.cos(CGL.DEG2RAD*_.get());D.cosConeAngle=Math.cos(CGL.DEG2RAD*p.get());D.spotExponent=v.get();D.castShadow=E.get();D.updateProjectionMatrix(null,A.get(),S.get(),p.get())}if(!i.tempData.lightStack)i.tempData.lightStack=[];vec3.set(ie,a.get(),o.get(),l.get());vec3.set(se,u.get(),c.get(),f.get());vec3.transformMat4(re,ie,i.mMatrix);vec3.transformMat4(ne,se,i.mMatrix);D.position=re;D.conePointAt=ne;q.set(D.position[0]);K.set(D.position[1]);Z.set(D.position[2]);if(!i.tempData.shadowPass)ae();i.tempData.lightStack.push(D);if(E.get()){const e=1.5*R.get()*$;if(b.get())D.renderPasses(I.get(),e,function(){Y.trigger()});W.setRef(D.getShadowMapDepth());i.tempData.lightStack.pop();D.castShadow=E.get();D.blurAmount=R.get();D.normalOffset=O.get();D.shadowBias=M.get();D.shadowStrength=T.get();i.tempData.lightStack.push(D)}Y.trigger();i.tempData.lightStack.pop()}}};CABLES.OPS["76418c17-abd5-401b-82e2-688db6f966ee"]={f:Ops.Gl.Phong.SpotLight_v5,objName:"Ops.Gl.Phong.SpotLight_v5"};Ops.Ui.Area=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inString("Title",""),s=e.inTriggerButton("Delete");i.setUiAttribs({hidePort:true});e.setUiAttrib({hasArea:true});e.init=i.onChange=e.onLoaded=r;r();function r(){if(CABLES.UI){gui.savedState.setUnSaved("areaOp",e.getSubPatch());e.uiAttr({comment_title:i.get()||" "});e.name=i.get()}}s.onTriggered=()=>{e.patch.deleteOp(e.id)}}};CABLES.OPS["38f79614-b0de-4960-8da5-2827e7f43415"]={f:Ops.Ui.Area,objName:"Ops.Ui.Area"};Ops.Json.ObjectGetNumber_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inObject("Data"),s=e.inString("Key"),r=e.outNumber("Result"),n=e.outBoolNum("Found");e.toWorkPortsNeedsString(s);r.ignoreValueSerialize=true;i.ignoreValueSerialize=true;e.toWorkPortsNeedToBeLinked(i);e.setUiAttrib({extendTitlePort:s.name});s.setUiAttribs({stringTrim:true});s.onChange=i.onChange=a;function a(){const e=i.get();if(e){const t=e[s.get()];r.set(parseFloat(t));if(t===undefined)n.set(0);else n.set(1)}else{r.set(0);n.set(0)}}}};CABLES.OPS["a7335e79-046e-40da-9e9c-db779b0a5e53"]={f:Ops.Json.ObjectGetNumber_v2,objName:"Ops.Json.ObjectGetNumber_v2"};window.addEventListener("load",function(e){CABLES.jsLoaded=new Event("CABLES.jsLoaded");document.dispatchEvent(CABLES.jsLoaded)});(()=>{var Q={};(()=>{Q.d=(e,t)=>{for(var i in t){if(Q.o(t,i)&&!Q.o(e,i)){Object.defineProperty(e,i,{enumerable:true,get:t[i]})}}}})();(()=>{Q.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{Q.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();var J={};(()=>{"use strict";Q.r(J);Q.d(J,{CopyTexture:()=>Z});const T=CABLES;const u=CABLES.SHARED;const t=8;class i{constructor(e={}){this.id=T.utils.uuid();this.width=0;this.height=0;this.name="unknown";e=e||{};this.pixelFormat=e.pixelFormat||i.PFORMATSTR_RGBA8UB;this.name=e.name||"unknown";if(!e.width)e.width=t;if(!e.height)e.height=t}}i.getDefaultTextureData=(e,n,a={})=>{if(e=="empty"){return new Uint8Array(n*n*4).fill(0)}else if(e=="color"){const r=new Uint8Array(n*n*4);let t=a.r||1;let i=a.g||1;let s=a.b||1;for(let e=0;e<n*n;e++){r[e*4+0]=t;r[e*4+1]=i;r[e*4+2]=s;r[e*4+3]=255}return r}else if(e=="randomUInt"){const r=new Uint8Array(n*n*4);for(let e=0;e<n*n;e++){r[e*4+0]=Math.random()*255;r[e*4+1]=Math.random()*255;r[e*4+2]=Math.random()*255;r[e*4+3]=255}return r}else if(e=="random"||e=="randomFloat"){const r=new Float32Array(n*n*4);for(let e=0;e<n*n;e++){r[e*4+0]=(Math.random()-.5)*2;r[e*4+1]=(Math.random()-.5)*2;r[e*4+2]=(Math.random()-.5)*2;r[e*4+3]=1}return r}else if(e=="stripes"){const o=[];let i=a.r;let s=a.g;let r=a.b;if(i===undefined)i=1;if(s===undefined)s=1;if(r===undefined)r=1;for(let t=0;t<n;t++){for(let e=0;e<n;e++){if((e+t)%64<32){o.push((200+t/n*25+e/n*25)*i);o.push((200+t/n*25+e/n*25)*s);o.push((200+t/n*25+e/n*25)*r)}else{o.push((40+t/n*25+e/n*25)*i);o.push((40+t/n*25+e/n*25)*s);o.push((40+t/n*25+e/n*25)*r)}o.push(255)}}return new Uint8Array(o)}else{console.warn("unknown default texture",e);return i.getDefaultTextureData("stripes",n,{r:1,g:0,b:0})}};i.FILTER_NEAREST=0;i.FILTER_LINEAR=1;i.FILTER_MIPMAP=2;i.WRAP_REPEAT=0;i.WRAP_MIRRORED_REPEAT=1;i.WRAP_CLAMP_TO_EDGE=2;i.TYPE_DEFAULT=0;i.TYPE_DEPTH=1;i.TYPE_FLOAT=2;i.PFORMATSTR_RGB565="RGB 5/6/5bit ubyte";i.PFORMATSTR_R8UB="R 8bit ubyte";i.PFORMATSTR_RG8UB="RG 8bit ubyte";i.PFORMATSTR_RGB8UB="RGB 8bit ubyte";i.PFORMATSTR_RGBA8UB="RGBA 8bit ubyte";i.PFORMATSTR_SRGBA8="SRGBA 8bit ubyte";i.PFORMATSTR_R11FG11FB10F="RGB 11/11/10bit float";i.PFORMATSTR_R16F="R 16bit float";i.PFORMATSTR_RG16F="RG 16bit float";i.PFORMATSTR_RGB16F="RGB 16bit float";i.PFORMATSTR_RGBA16F="RGBA 16bit float";i.PFORMATSTR_R32F="R 32bit float";i.PFORMATSTR_RG32F="RG 32bit float";i.PFORMATSTR_RGB32F="RGB 32bit float";i.PFORMATSTR_RGBA32F="RGBA 32bit float";i.PFORMATSTR_DEPTH="DEPTH";i.PIXELFORMATS=[i.PFORMATSTR_RGB565,i.PFORMATSTR_R8UB,i.PFORMATSTR_RG8UB,i.PFORMATSTR_RGB8UB,i.PFORMATSTR_RGBA8UB,i.PFORMATSTR_SRGBA8,i.PFORMATSTR_R11FG11FB10F,i.PFORMATSTR_R16F,i.PFORMATSTR_RG16F,i.PFORMATSTR_RGBA16F,i.PFORMATSTR_R32F,i.PFORMATSTR_RGBA32F];const s=8;const a=new u.Logger("cgl_texture");class h extends i{constructor(e,t={}){super(t);if(!e)throw new Error("no cgl");this._cgl=e;this._log=new u.Logger("tex");this.tex=this._cgl.gl.createTexture();this.loading=false;this.flip=true;this.flipped=false;this.shadowMap=false;this.deleted=false;this.image=null;this.anisotropic=0;this.filter=h.FILTER_NEAREST;this.wrap=h.WRAP_CLAMP_TO_EDGE;this.texTarget=this._cgl.gl.TEXTURE_2D;if(t&&t.type)this.texTarget=t.type;this.textureType=h.TYPE_DEFAULT;this.unpackAlpha=true;this._fromData=true;this._glDataType=-1;this._glInternalFormat=-1;this._glDataFormat=-1;if(t){if(t.isDepthTexture)this.textureType=h.TYPE_DEPTH;if(t.isFloatingPointTexture===true)this.textureType=h.TYPE_FLOAT;if("textureType"in t)this.textureType=t.textureType;if("filter"in t)this.filter=t.filter;if("wrap"in t)this.wrap=t.wrap;if("unpackAlpha"in t)this.unpackAlpha=t.unpackAlpha;if("flip"in t)this.flip=t.flip;if("shadowMap"in t)this.shadowMap=t.shadowMap;if("anisotropic"in t)this.anisotropic=t.anisotropic}else{t={}}if(!t.pixelFormat&&t.isFloatingPointTexture)this.pixelFormat=h.PFORMATSTR_RGBA32F;if(this.textureType==h.TYPE_DEPTH)this.pixelFormat=h.PFORMATSTR_DEPTH;this._cgl.profileData.profileTextureNew++;this.setFormat(h.setUpGlPixelFormat(this._cgl,this.pixelFormat));this._cgl.profileData.addHeavyEvent("texture created",this.name,t.width+"x"+t.height);this.setSize(t.width,t.height);this.getInfoOneLine()}isFloatingPoint(){return h.isPixelFormatFloat(this.pixelFormat)}compareSettings(e){if(!e)return false;return e.width==this.width&&e.height==this.height&&e.filter==this.filter&&e.wrap==this.wrap&&e.textureType==this.textureType&&e.unpackAlpha==this.unpackAlpha&&e.anisotropic==this.anisotropic&&e.shadowMap==this.shadowMap&&e.texTarget==this.texTarget&&e.flip==this.flip}clone(){const e=new h(this._cgl,{name:this.name,filter:this.filter,anisotropic:this.anisotropic,wrap:this.wrap,textureType:this.textureType,pixelFormat:this.pixelFormat,unpackAlpha:this.unpackAlpha,flip:this.flip,width:this.width,height:this.height});this._cgl.profileData.addHeavyEvent("texture created",this.name,this.width+"x"+this.height);if(!this.compareSettings(e)){this._log.error("Cloned texture settings do not compare!");this._log.error(this);this._log.error(e)}return e}setFormat(e){this.pixelFormat=e.pixelFormat;this._glDataFormat=e.glDataFormat;this._glInternalFormat=e.glInternalFormat;this._glDataType=e.glDataType}setSize(e,t){if(this._cgl.aborted)return;if(e!=e||e<=0||!e)e=s;if(t!=t||t<=0||!t)t=s;if(e>this._cgl.maxTexSize||t>this._cgl.maxTexSize)this._log.error("texture size too big! "+e+"x"+t+" / max: "+this._cgl.maxTexSize);e=Math.min(e,this._cgl.maxTexSize);t=Math.min(t,this._cgl.maxTexSize);e=Math.floor(e);t=Math.floor(t);if(this.width==e&&this.height==t)return;e=this._cgl.checkTextureSize(e);t=this._cgl.checkTextureSize(t);this.width=e;this.height=t;this.deleted=false;this.setFormat(h.setUpGlPixelFormat(this._cgl,this.pixelFormat));this.shortInfoString=this.getInfoOneLine();this._cgl.gl.bindTexture(this.texTarget,this.tex);this._cgl.profileData.profileTextureResize++;const i=null;this._cgl.gl.texImage2D(this.texTarget,0,this._glInternalFormat,e,t,0,this._glDataFormat,this._glDataType,i);this._setFilter();this.updateMipMap();this._cgl.gl.bindTexture(this.texTarget,null)}initFromData(e,t,i,s,r){this.filter=s;this.wrap=r;if(s==undefined)this.filter=h.FILTER_LINEAR;if(r==undefined)this.wrap=h.WRAP_CLAMP_TO_EDGE;this.width=t;this.height=i;this._fromData=true;this.deleted=false;if(this.height>this._cgl.maxTexSize||this.width>this._cgl.maxTexSize){const n=CGL.Texture.getTempTexture(this._cgl);this.width=n.width;this.height=n.height;this.tex=n.tex;this._log.warn("[cgl_texture] texture size too big!",this.width,this.height,this._cgl.maxTexSize);return}if(this.flip)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,this.flip);this._cgl.gl.bindTexture(this.texTarget,this.tex);this.setFormat(h.setUpGlPixelFormat(this._cgl,this.pixelFormat));this._cgl.gl.texImage2D(this.texTarget,0,this._glInternalFormat,t,i,0,this._glDataFormat,this._glDataType,e);this._setFilter();this.updateMipMap();if(this.flip)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,false);this._cgl.gl.bindTexture(this.texTarget,null)}updateMipMap(){if((this._cgl.glVersion==2||this.isPowerOfTwo())&&this.filter==h.FILTER_MIPMAP){this._cgl.gl.generateMipmap(this.texTarget);this._cgl.profileData.profileGenMipMap++}}initTexture(e,t=null){this._cgl.printError("before initTexture");this._cgl.checkFrameStarted("texture inittexture");this._fromData=false;this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.unpackAlpha);if(e.width||e.videoWidth)this.width=e.videoWidth||e.width;if(e.height||e.videoHeight)this.height=e.videoHeight||e.height;if(t!==null)this.filter=t;if(e.height>this._cgl.maxTexSize||e.width>this._cgl.maxTexSize){const i=CGL.Texture.getTempTexture(this._cgl);this.width=i.width;this.height=i.height;this.tex=i.tex;this._log.warn("[cgl_texture] texture size too big!",e.width,e.height,this._cgl.maxTexSize);return}this._cgl.gl.bindTexture(this.texTarget,this.tex);this.deleted=false;this.flipped=!this.flip;if(this.flipped)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,this.flipped);this.setFormat(h.setUpGlPixelFormat(this._cgl,this.pixelFormat));this._cgl.gl.texImage2D(this.texTarget,0,this._glInternalFormat,this._glDataFormat,this._glDataType,e);this._setFilter();this.updateMipMap();this._cgl.gl.bindTexture(this.texTarget,null);this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);if(this.flipped)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,false);this.getInfoOneLine();this._cgl.printError("initTexture")}dispose(){this.delete()}delete(){if(this.loading){return}this.deleted=true;this.width=0;this.height=0;this._cgl.profileData.profileTextureDelete++;this._cgl.gl.deleteTexture(this.tex);this.image=null;this.tex=null}isPowerOfTwo(){return h.isPowerOfTwo(this.width)&&h.isPowerOfTwo(this.height)}printInfo(){a.log(this.getInfo())}getInfoReadable(){const t=this.getInfo();let i="";t.name=t.name.substr(0,t.name.indexOf("?rnd="));for(const e in t){i+="* "+e+":  **"+t[e]+"**\n"}return i}getInfoOneLine(){let e=""+this.width+"x"+this.height;e+=" ";e+=this.pixelFormat;if(this.filter===h.FILTER_NEAREST)e+=" nearest";if(this.filter===h.FILTER_LINEAR)e+=" linear";if(this.filter===h.FILTER_MIPMAP)e+=" mipmap";if(this.wrap===h.WRAP_CLAMP_TO_EDGE)e+=" clamp";if(this.wrap===h.WRAP_REPEAT)e+=" repeat";if(this.wrap===h.WRAP_MIRRORED_REPEAT)e+=" repeatmir";this.shortInfoString=e;return e}getInfoOneLineShort(){let e=""+this.width+"x"+this.height;e+=" ";e+=this.pixelFormat;this.shortInfoString=e;return e}getInfo(){return h.getTexInfo(this)}_setFilter(){this._cgl.printError("before _setFilter");if(!this._fromData){this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.unpackAlpha)}if(this.shadowMap){this._cgl.gl.texParameteri(this._cgl.gl.TEXTURE_2D,this._cgl.gl.TEXTURE_COMPARE_MODE,this._cgl.gl.COMPARE_REF_TO_TEXTURE);this._cgl.gl.texParameteri(this._cgl.gl.TEXTURE_2D,this._cgl.gl.TEXTURE_COMPARE_FUNC,this._cgl.gl.LEQUAL)}if(this.textureType==h.TYPE_FLOAT&&this.filter==h.FILTER_MIPMAP){this.filter=h.FILTER_LINEAR;this._log.stack("texture: HDR and mipmap filtering at the same time is not possible")}if(this._cgl.glVersion==1&&!this.isPowerOfTwo()){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.CLAMP_TO_EDGE);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.CLAMP_TO_EDGE);this.filter=h.FILTER_NEAREST;this.wrap=h.WRAP_CLAMP_TO_EDGE}else{if(this.wrap==h.WRAP_CLAMP_TO_EDGE){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.CLAMP_TO_EDGE);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.CLAMP_TO_EDGE)}else if(this.wrap==h.WRAP_REPEAT){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.REPEAT);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.REPEAT)}else if(this.wrap==h.WRAP_MIRRORED_REPEAT){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.MIRRORED_REPEAT);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.MIRRORED_REPEAT)}if(this.filter==h.FILTER_NEAREST){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.NEAREST)}else if(this.filter==h.FILTER_LINEAR){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.LINEAR);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.LINEAR)}else if(this.filter==h.FILTER_MIPMAP){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.LINEAR);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.LINEAR_MIPMAP_LINEAR)}else{this._log.log("unknown texture filter!",this.filter);throw new Error("unknown texture filter!"+this.filter)}if(this.anisotropic){const e=this._cgl.enableExtension("EXT_texture_filter_anisotropic");if(this._cgl.maxAnisotropic){const t=Math.min(this._cgl.maxAnisotropic,this.anisotropic);this._cgl.gl.texParameterf(this._cgl.gl.TEXTURE_2D,e.TEXTURE_MAX_ANISOTROPY_EXT,t)}}}this.getInfoOneLine();this._cgl.printError("_setFilter")}}h.load=function(i,s,r,e){if(!s)return r({error:true});let n=null;if(!i.patch.loading.existByName(s))n=i.patch.loading.start("cgl.texture",s);const a=new h(i);a.name=s;a.image=new Image;a.image.crossOrigin="anonymous";a.loading=true;if(e&&e.hasOwnProperty("filter"))a.filter=e.filter;if(e&&e.hasOwnProperty("flip"))a.flip=e.flip;if(e&&e.hasOwnProperty("wrap"))a.wrap=e.wrap;if(e&&e.hasOwnProperty("anisotropic"))a.anisotropic=e.anisotropic;if(e&&e.hasOwnProperty("unpackAlpha"))a.unpackAlpha=e.unpackAlpha;if(e&&e.hasOwnProperty("pixelFormat"))a.pixelFormat=e.pixelFormat;a.image.onabort=a.image.onerror=e=>{console.warn("[cgl.texture.load] error loading texture",s,e);a.loading=false;if(n)i.patch.loading.finished(n);const t={error:true};if(r)r(t,a)};a.image.onload=function(e){i.addNextFrameOnceCallback(()=>{a.initTexture(a.image);if(n)i.patch.loading.finished(n);a.loading=false;if(r)r(null,a)})};a.image.src=s;return a};h.getTempTexture=function(e){if(!e)console.error("[getTempTexture] no cgl!");if(!e.tempTexture)e.tempTexture=h.getTemporaryTexture(e,256,h.FILTER_LINEAR,h.REPEAT);return e.tempTexture};h.getErrorTexture=function(e){if(!e)console.error("[getTempTexture] no cgl!");if(!e.errorTexture)e.errorTexture=h.getTemporaryTexture(e,256,h.FILTER_LINEAR,h.REPEAT,1,.2,.2);return e.errorTexture};h.getEmptyTexture=function(e,t){if(t)return h.getEmptyTextureFloat(e);if(!e)console.error("[getEmptyTexture] no cgl!");if(e.tempTextureEmpty)return e.tempTextureEmpty;let i=8;e.tempTextureEmpty=new h(e,{name:"emptyTexture"});const s=h.getDefaultTextureData("empty",i);e.tempTextureEmpty.initFromData(s,i,i,h.FILTER_NEAREST,h.WRAP_REPEAT);return e.tempTextureEmpty};h.getEmptyTextureFloat=function(e){if(!e)console.error("[getEmptyTextureFloat] no cgl!");if(e.tempTextureEmptyFloat)return e.tempTextureEmptyFloat;e.tempTextureEmptyFloat=new h(e,{name:"emptyTexture",isFloatingPointTexture:true});const t=new Float32Array(8*8*4).fill(1);for(let e=0;e<8*8*4;e+=4)t[e+3]=0;e.tempTextureEmptyFloat.initFromData(t,8,8,h.FILTER_NEAREST,h.WRAP_REPEAT);return e.tempTextureEmptyFloat};h.getRandomTexture=function(e){if(!e)console.error("[getRandomTexture] no cgl!");if(e.randomTexture)return e.randomTexture;const t=256;const i=h.getDefaultTextureData("randomUInt",t);e.randomTexture=new h(e);e.randomTexture.initFromData(i,t,t,h.FILTER_NEAREST,h.WRAP_REPEAT);return e.randomTexture};h.getRandomFloatTexture=function(e){if(!e)console.error("[getRandomTexture] no cgl!");if(e.getRandomFloatTexture)return e.getRandomFloatTexture;const t=256;const i=h.getDefaultTextureData("randomFloat",t);e.getRandomFloatTexture=new h(e,{isFloatingPointTexture:true});e.getRandomFloatTexture.initFromData(i,t,t,h.FILTER_NEAREST,h.WRAP_REPEAT);return e.getRandomFloatTexture};h.getBlackTexture=function(e){if(e.blackTexture)return e.blackTexture;const t=8;const i=h.getDefaultTextureData("color",t,{r:0,g:0,b:0});e.blackTexture=new h(e);e.blackTexture.initFromData(i,t,t,h.FILTER_NEAREST,h.WRAP_REPEAT);return e.blackTexture};h.getEmptyCubemapTexture=function(t){const i=[t.gl.TEXTURE_CUBE_MAP_POSITIVE_X,t.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,t.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,t.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,t.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z];const e=t.gl.createTexture();const s=t.gl.TEXTURE_CUBE_MAP;const r=h.FILTER_NEAREST;const n=h.WRAP_CLAMP_TO_EDGE;const a=8;const o=8;t.profileData.profileTextureNew++;t.gl.bindTexture(s,e);t.profileData.profileTextureResize++;for(let e=0;e<6;e+=1){const l=new Uint8Array(8*8*4);t.gl.texImage2D(i[e],0,t.gl.RGBA,8,8,0,t.gl.RGBA,t.gl.UNSIGNED_BYTE,l);t.gl.texParameteri(s,t.gl.TEXTURE_MAG_FILTER,t.gl.NEAREST);t.gl.texParameteri(s,t.gl.TEXTURE_MIN_FILTER,t.gl.NEAREST);t.gl.texParameteri(s,t.gl.TEXTURE_WRAP_S,t.gl.CLAMP_TO_EDGE);t.gl.texParameteri(s,t.gl.TEXTURE_WRAP_T,t.gl.CLAMP_TO_EDGE)}t.gl.bindTexture(s,null);return{id:T.utils.uuid(),tex:e,cubemap:e,width:a,height:o,filter:r,wrap:n,unpackAlpha:true,flip:true,_fromData:true,name:"emptyCubemapTexture",anisotropic:0}};h.getTempGradientTexture=function(e){if(!e)console.error("[getTempGradientTexture] no cgl!");return h.getTempTexture(e)};h.getTemporaryTexture=function(e,t,i,s,r,n,a){const o=h.getDefaultTextureData("stripes",256,{r:r,g:n,b:a});const l=new h(e);l.initFromData(o,t,t,i,s);return l};h.createFromImage=function(e,t,i){i=i||{};const s=new h(e,i);s.flip=false;s.image=t;s.width=t.videoWidth||t.width||8;s.height=t.videoHeight||t.height||8;if(i.hasOwnProperty("wrap"))s.wrap=i.wrap;s.initTexture(t,i.filter);return s};h.fromImage=function(e,t,i,s){console.error("deprecated texture from image...");const r=new h(e);r.flip=false;if(i)r.filter=i;if(s)r.wrap=s;r.image=t;r.initTexture(t);return r};h.isPowerOfTwo=function(e){return e==1||e==2||e==4||e==8||e==16||e==32||e==64||e==128||e==256||e==512||e==1024||e==2048||e==4096||e==8192||e==16384};h.getTexInfo=function(e){const t={};t.name=e.name;t["power of two"]=e.isPowerOfTwo();t.size=e.width+" x "+e.height;let i=e.texTarget;if(e.texTarget==e._cgl.gl.TEXTURE_2D)i="TEXTURE_2D";t.target=i;t.unpackAlpha=e.unpackAlpha;if(e.cubemap)t.cubemap=true;if(e.textureType==h.TYPE_FLOAT)t.textureType="TYPE_FLOAT";if(e.textureType==h.TYPE_HALF_FLOAT)t.textureType="TYPE_HALF_FLOAT";else if(e.textureType==h.TYPE_DEPTH)t.textureType="TYPE_DEPTH";else if(e.textureType==h.TYPE_DEFAULT)t.textureType="TYPE_DEFAULT";else t.textureType="UNKNOWN "+this.textureType;if(e.wrap==h.WRAP_CLAMP_TO_EDGE)t.wrap="CLAMP_TO_EDGE";else if(e.wrap==h.WRAP_REPEAT)t.wrap="WRAP_REPEAT";else if(e.wrap==h.WRAP_MIRRORED_REPEAT)t.wrap="WRAP_MIRRORED_REPEAT";else t.wrap="UNKNOWN";if(e.filter==h.FILTER_NEAREST)t.filter="FILTER_NEAREST";else if(e.filter==h.FILTER_LINEAR)t.filter="FILTER_LINEAR";else if(e.filter==h.FILTER_MIPMAP)t.filter="FILTER_MIPMAP";else t.filter="UNKNOWN";t.pixelFormat=e.pixelFormat||"unknown";return t};h.setUpGlPixelFormat=function(e,t){const i={};if(!t){e._log.error("no pixelformatstr!");e._log.log(new Error);t=h.PFORMATSTR_RGBA8UB}i.pixelFormatBase=t;i.pixelFormat=t;i.glDataType=e.gl.UNSIGNED_BYTE;i.glInternalFormat=e.gl.RGBA8;i.glDataFormat=e.gl.RGBA;let s=e.gl.FLOAT;if(e.glUseHalfFloatTex){if(t==h.PFORMATSTR_RGBA32F)t=h.PFORMATSTR_RGBA16F;if(t==h.PFORMATSTR_RG32F)t=h.PFORMATSTR_RG16F;if(t==h.PFORMATSTR_R32F)t=h.PFORMATSTR_R16F}if(t.includes("16bit")){if(e.glVersion==2){const r=e.enableExtension("EXT_color_buffer_half_float");if(!r){console.warn("no 16bit extension, fallback to 32bit",t);if(t==h.PFORMATSTR_RGBA16F)t=h.PFORMATSTR_RGBA32F;if(t==h.PFORMATSTR_RGB16F)t=h.PFORMATSTR_RGB32F;if(t==h.PFORMATSTR_RG16F)t=h.PFORMATSTR_RG32F;if(t==h.PFORMATSTR_R16F)t=h.PFORMATSTR_R32F}else{s=e.gl.HALF_FLOAT}}}if(e.glVersion==1){i.glInternalFormat=e.gl.RGBA;if(t==h.PFORMATSTR_RGBA16F||t==h.PFORMATSTR_RG16F||t==h.PFORMATSTR_R16F){const n=e.enableExtension("OES_texture_half_float");if(!n)throw new Error("no half float texture extension");s=n.HALF_FLOAT_OES}}if(t==h.PFORMATSTR_RGBA8UB){}else if(t==h.PFORMATSTR_RGB565){i.glInternalFormat=e.gl.RGB565;i.glDataFormat=e.gl.RGB}else if(t==h.PFORMATSTR_R8UB){i.glInternalFormat=e.gl.R8;i.glDataFormat=e.gl.RED}else if(t==h.PFORMATSTR_RG8UB){i.glInternalFormat=e.gl.RG8;i.glDataFormat=e.gl.RG}else if(t==h.PFORMATSTR_RGB8UB){i.glInternalFormat=e.gl.RGB8;i.glDataFormat=e.gl.RGB}else if(t==h.PFORMATSTR_SRGBA8){i.glInternalFormat=e.gl.SRGB8_ALPHA8}else if(t==h.PFORMATSTR_R32F){i.glInternalFormat=e.gl.R32F;i.glDataFormat=e.gl.RED;i.glDataType=s}else if(t==h.PFORMATSTR_R16F){i.glInternalFormat=e.gl.R16F;i.glDataType=s;i.glDataFormat=e.gl.RED}else if(t==h.PFORMATSTR_RG16F){i.glInternalFormat=e.gl.RG16F;i.glDataType=s;i.glDataFormat=e.gl.RG}else if(t==h.PFORMATSTR_RGBA16F){if(e.glVersion==1)i.glInternalFormat=e.gl.RGBA;else i.glInternalFormat=e.gl.RGBA16F;i.glDataType=s}else if(t==h.PFORMATSTR_R11FG11FB10F){i.glInternalFormat=e.gl.R11F_G11F_B10F;i.glDataType=s;i.glDataFormat=e.gl.RGB}else if(t==h.PFORMATSTR_RGBA32F){if(e.glVersion==1)i.glInternalFormat=e.gl.RGBA;else i.glInternalFormat=e.gl.RGBA32F;i.glDataType=s}else if(t==h.PFORMATSTR_DEPTH){if(e.glVersion==1){i.glInternalFormat=e.gl.DEPTH_COMPONENT;i.glDataType=e.gl.UNSIGNED_SHORT;i.glDataFormat=e.gl.DEPTH_COMPONENT}else{i.glInternalFormat=e.gl.DEPTH_COMPONENT32F;i.glDataType=e.gl.FLOAT;i.glDataFormat=e.gl.DEPTH_COMPONENT}}else{a.log("unknown pixelformat ",t)}if(t.includes("32bit")||t==h.PFORMATSTR_R11FG11FB10F){if(e.glVersion==2)e.enableExtension("EXT_color_buffer_float");if(e.glVersion==2)e.enableExtension("EXT_float_blend");e.enableExtension("OES_texture_float_linear")}i.numColorChannels=h.getPixelFormatNumChannels(t);if(!i.glDataType||!i.glInternalFormat||!i.glDataFormat)a.log("pixelformat wrong ?!",t,i.glDataType,i.glInternalFormat,i.glDataFormat,this);return i};h.getPixelFormatNumChannels=e=>{if(e.startsWith("RGBA"))return 4;if(e.startsWith("RGB"))return 3;if(e.startsWith("RG"))return 2;return 1};h.isPixelFormatFloat=e=>{return(e||"").includes("float")};h.isPixelFormatHalfFloat=e=>{return(e||"").includes("float")&&(e||"").includes("16bit")};class e{constructor(t,e,i,s){this._log=new u.Logger("cgl_framebuffer2");if(t.glVersion==1)this._log.error("framebuffer2 used on webgl1");this.Framebuffer2DrawTargetsDefault=null;this.Framebuffer2BlittingFramebuffer=null;this.Framebuffer2FinalFramebuffer=null;this._cgl=t;this._cgl.printError("before framebuffer2 constructor");this._width=0;this._height=0;this.valid=true;this._depthRenderbuffer=null;this._frameBuffer=null;this._textureFrameBuffer=null;this._colorRenderbuffers=[];this._drawTargetArray=[];this._disposed=false;if(!this.Framebuffer2BlittingFramebuffer)this.Framebuffer2BlittingFramebuffer=t.gl.createFramebuffer();if(!this.Framebuffer2FinalFramebuffer)this.Framebuffer2FinalFramebuffer=t.gl.createFramebuffer();if(!this.Framebuffer2DrawTargetsDefault)this.Framebuffer2DrawTargetsDefault=[t.gl.COLOR_ATTACHMENT0];this._options=s||{isFloatingPointTexture:false};this.name=this._options.name||"unknown";this._cgl.profileData.addHeavyEvent("framebuffer create",this.name);if(!this._options.hasOwnProperty("numRenderBuffers"))this._options.numRenderBuffers=1;if(!this._options.hasOwnProperty("depth"))this._options.depth=true;if(!this._options.hasOwnProperty("clear"))this._options.clear=true;if(!this._options.hasOwnProperty("multisampling")){this._options.multisampling=false;this._options.multisamplingSamples=0}if(this._options.multisamplingSamples){if(this._cgl.glSlowRenderer)this._options.multisamplingSamples=0;if(!this._cgl.gl.MAX_SAMPLES)this._options.multisamplingSamples=0;else this._options.multisamplingSamples=Math.min(this._cgl.maxSamples,this._options.multisamplingSamples)}if(!this._options.hasOwnProperty("filter"))this._options.filter=h.FILTER_LINEAR;if(!this._options.hasOwnProperty("wrap"))this._options.wrap=h.WRAP_REPEAT;this._numRenderBuffers=this._options.numRenderBuffers;this._colorTextures=[];this.clearColors=[];for(let e=0;e<this._numRenderBuffers;e++)this.clearColors.push([0,0,0,1]);if(!s.pixelFormat){if(s.isFloatingPointTexture)this._options.pixelFormat=h.PFORMATSTR_RGBA32F;else this._options.pixelFormat=h.PFORMATSTR_RGBA8UB}for(let e=0;e<this._numRenderBuffers;e++){this._colorTextures[e]=new h(t,{name:"fb2 "+this.name+" "+e,isFloatingPointTexture:this._options.isFloatingPointTexture,anisotropic:this._options.anisotropic||0,pixelFormat:this._options.pixelFormat,filter:this._options.filter,wrap:this._options.wrap})}let r=h.FILTER_NEAREST;if(this._options.shadowMap)r=h.FILTER_LINEAR;const n=512;if(this._options.depth){this._textureDepth=new h(t,{name:"fb2 depth "+this.name,isDepthTexture:true,filter:r,shadowMap:this._options.shadowMap||false,width:e||n,height:i||n})}if(t.aborted)return;this.setSize(e||n,i||n);this._cgl.printError("framebuffer2 constructor")}getWidth(){return this._width}getHeight(){return this._height}getGlFrameBuffer(){return this._frameBuffer}getDepthRenderBuffer(){return this._depthRenderbuffer}getTextureColor(){return this._colorTextures[0]}getTextureColorNum(e){return this._colorTextures[e]}getTextureDepth(){return this._textureDepth}setFilter(t){for(let e=0;e<this._numRenderBuffers;e++){this._colorTextures[e].filter=t;this._colorTextures[e].setSize(this._width,this._height)}}delete(){this.dispose()}dispose(){this._disposed=true;let e=0;for(e=0;e<this._numRenderBuffers;e++)this._colorTextures[e].delete();if(this._textureDepth)this._textureDepth.delete();for(e=0;e<this._numRenderBuffers;e++)this._cgl.gl.deleteRenderbuffer(this._colorRenderbuffers[e]);this._cgl.gl.deleteRenderbuffer(this._depthRenderbuffer);this._cgl.gl.deleteFramebuffer(this._frameBuffer);this._cgl.gl.deleteFramebuffer(this._textureFrameBuffer)}setSize(e,t){if(this._disposed)return this._log.warn("disposed framebuffer setsize...");this._cgl.profileData.addHeavyEvent("framebuffer resize",this.name);let i=0;this._width=this._cgl.checkTextureSize(e);this._height=this._cgl.checkTextureSize(t);this._cgl.profileData.profileFrameBuffercreate++;if(this._frameBuffer){for(i=0;i<this._numRenderBuffers;i++)this._cgl.gl.deleteRenderbuffer(this._colorRenderbuffers[i]);this._cgl.gl.deleteRenderbuffer(this._depthRenderbuffer);this._cgl.gl.deleteFramebuffer(this._frameBuffer);this._cgl.gl.deleteFramebuffer(this._textureFrameBuffer)}this._frameBuffer=this._cgl.gl.createFramebuffer();this._textureFrameBuffer=this._cgl.gl.createFramebuffer();const s=this._options.depth;for(i=0;i<this._numRenderBuffers;i++){this._colorTextures[i].setSize(this._width,this._height)}for(i=0;i<this._numRenderBuffers;i++){const a=this._cgl.gl.createRenderbuffer();this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,a);const o=h.setUpGlPixelFormat(this._cgl,this._options.pixelFormat);let e=o.glInternalFormat;if(CGL.Texture.isPixelFormatHalfFloat(o.pixelFormat)){if(!this._cgl.enableExtension("OES_texture_float_linear")){this._options.filter=h.FILTER_NEAREST;this.setFilter(this._options.filter)}}else if(CGL.Texture.isPixelFormatFloat(o.pixelFormat)){if(!this._cgl.enableExtension("OES_texture_float_linear")){this._log.warn("no linear pixelformat,using nearest");this._options.filter=h.FILTER_NEAREST;this.setFilter(this._options.filter)}}if(this._options.multisampling&&this._options.multisamplingSamples){this._cgl.gl.renderbufferStorageMultisample(this._cgl.gl.RENDERBUFFER,this._options.multisamplingSamples,e,this._width,this._height)}else{this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,e,this._width,this._height)}this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0+i,this._cgl.gl.RENDERBUFFER,a);this._colorRenderbuffers[i]=a}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._textureFrameBuffer);for(i=0;i<this._numRenderBuffers;i++){this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0+i,this._cgl.gl.TEXTURE_2D,this._colorTextures[i].tex,0)}if(this._options.depth){this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.TEXTURE_2D,this._textureDepth.tex,0)}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);let r=this._cgl.gl.DEPTH_COMPONENT32F;if(this._cgl.glSlowRenderer)r=this._cgl.gl.DEPTH_COMPONENT16;if(s){this._textureDepth.setSize(this._width,this._height);this._depthRenderbuffer=this._cgl.gl.createRenderbuffer();this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._depthRenderbuffer);if(this._options.isFloatingPointTexture){if(this._options.multisampling)this._cgl.gl.renderbufferStorageMultisample(this._cgl.gl.RENDERBUFFER,this._options.multisamplingSamples,r,this._width,this._height);else this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,r,this._width,this._height)}else if(this._options.multisampling){this._cgl.gl.renderbufferStorageMultisample(this._cgl.gl.RENDERBUFFER,this._options.multisamplingSamples,r,this._width,this._height)}else{this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,r,this._width,this._height)}this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._depthRenderbuffer)}this._drawTargetArray.length=0;for(i=0;i<this._numRenderBuffers;i++)this._drawTargetArray.push(this._cgl.gl.COLOR_ATTACHMENT0+i);if(!this._cgl.gl.isFramebuffer(this._textureFrameBuffer))this._log.warn("invalid framebuffer");const n=this._cgl.gl.checkFramebufferStatus(this._cgl.gl.FRAMEBUFFER);if(n!=this._cgl.gl.FRAMEBUFFER_COMPLETE){this._log.error("framebuffer incomplete: "+this.name,this);this._log.log("options",this._options);this._log.log("options pixelformat",this._options.pixelFormat);switch(n){case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:this._log.warn("FRAMEBUFFER_INCOMPLETE_ATTACHMENT...",this);throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:this._log.warn("FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:this._log.warn("FRAMEBUFFER_INCOMPLETE_DIMENSIONS");throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case this._cgl.gl.FRAMEBUFFER_UNSUPPORTED:this._log.warn("FRAMEBUFFER_UNSUPPORTED");throw new Error("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:this.valid=false;this._log.error("incomplete framebuffer",n,this._frameBuffer);this._cgl.printError();this._frameBuffer=null;throw new Error("Incomplete framebuffer: "+n)}}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,null)}renderStart(){if(this._disposed)return this._log.warn("disposed framebuffer renderStart...");this._cgl.checkFrameStarted("fb2 renderstart");this._cgl.pushModelMatrix();this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);this._cgl.pushGlFrameBuffer(this._frameBuffer);this._cgl.pushFrameBuffer(this);this._cgl.pushPMatrix();this._cgl.pushViewPort(0,0,this._width,this._height);this._cgl.gl.drawBuffers(this._drawTargetArray);if(this._options.clear){this._cgl.gl.clearColor(0,0,0,0);this._cgl.gl.clear(this._cgl.gl.COLOR_BUFFER_BIT|this._cgl.gl.DEPTH_BUFFER_BIT)}}clear(){if(this._numRenderBuffers<=1){this._cgl.gl.bindFramebuffer(this._cgl.gl.READ_FRAMEBUFFER,this._frameBuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.DRAW_FRAMEBUFFER,this._textureFrameBuffer)}else this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);this._cgl.gl.drawBuffers(this._drawTargetArray);for(let e=0;e<this._numRenderBuffers;e++){this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0+e,this._cgl.gl.TEXTURE_2D,this._colorTextures[e].tex,0);this._cgl.gl.clearBufferfv(this._cgl.gl.COLOR,e,this.clearColors[e])}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null)}renderEnd(){if(this._disposed)return this._log.warn("disposed framebuffer renderEnd...");this._cgl.popPMatrix();this._cgl.profileData.profileFramebuffer++;if(this._numRenderBuffers<=1){this._cgl.gl.bindFramebuffer(this._cgl.gl.READ_FRAMEBUFFER,this._frameBuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.DRAW_FRAMEBUFFER,this._textureFrameBuffer);this._cgl.gl.clearBufferfv(this._cgl.gl.COLOR,0,[0,0,0,1]);this._cgl.gl.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,this._cgl.gl.COLOR_BUFFER_BIT|this._cgl.gl.DEPTH_BUFFER_BIT,this._cgl.gl.NEAREST)}else{this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2BlittingFramebuffer);this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._depthRenderbuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2FinalFramebuffer);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.TEXTURE_2D,this._textureDepth.tex,0);for(let t=0;t<this._numRenderBuffers;t++){this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2BlittingFramebuffer);this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.RENDERBUFFER,this._colorRenderbuffers[t]);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2FinalFramebuffer);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.TEXTURE_2D,this._colorTextures[t].tex,0);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.READ_FRAMEBUFFER,this.Framebuffer2BlittingFramebuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.DRAW_FRAMEBUFFER,this.Framebuffer2FinalFramebuffer);let e=this._cgl.gl.COLOR_BUFFER_BIT;if(t==0)e|=this._cgl.gl.DEPTH_BUFFER_BIT;this._cgl.gl.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,e,this._cgl.gl.NEAREST)}}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.popGlFrameBuffer());this._cgl.popFrameBuffer();this._cgl.popModelMatrix();this._cgl.popViewPort();if(this._colorTextures[0].filter==h.FILTER_MIPMAP){for(let e=0;e<this._numRenderBuffers;e++){this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,this._colorTextures[e].tex);this._colorTextures[e].updateMipMap();this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null)}}}}const r=function(e){this.draw=function(e,t,i){}};const n=function(e){this.render=function(e,t){}};const o=function(e){this.render=function(e,t,i,s){}};class l{constructor(e,t,i,s,r,n,a,o,l,h){this._log=new u.Logger("cg_uniform");this._type=t;this._name=i;this._shader=e;this._value=1e-5;this._oldValue=null;this._port=null;this._structName=l;this._structUniformName=o;this._propertyName=h;if(this._shader._addUniform)this._shader._addUniform(this);this.needsUpdate=true;this.shaderType=null;this.comment=null;if(t=="f"){this.set=this.setValue=this.setValueF.bind(this);this.updateValue=this.updateValueF.bind(this)}else if(t=="f[]"){this.set=this.setValue=this.setValueArrayF.bind(this);this.updateValue=this.updateValueArrayF.bind(this)}else if(t=="2f[]"){this.set=this.setValue=this.setValueArray2F.bind(this);this.updateValue=this.updateValueArray2F.bind(this)}else if(t=="3f[]"){this.set=this.setValue=this.setValueArray3F.bind(this);this.updateValue=this.updateValueArray3F.bind(this)}else if(t=="4f[]"){this.set=this.setValue=this.setValueArray4F.bind(this);this.updateValue=this.updateValueArray4F.bind(this)}else if(t=="i"){this.set=this.setValue=this.setValueI.bind(this);this.updateValue=this.updateValueI.bind(this)}else if(t=="2i"){this.set=this.setValue=this.setValue2I.bind(this);this.updateValue=this.updateValue2I.bind(this)}else if(t=="3i"){this.set=this.setValue=this.setValue3I.bind(this);this.updateValue=this.updateValue3I.bind(this)}else if(t=="4i"){this.set=this.setValue=this.setValue4I.bind(this);this.updateValue=this.updateValue4I.bind(this)}else if(t=="b"){this.set=this.setValue=this.setValueBool.bind(this);this.updateValue=this.updateValueBool.bind(this)}else if(t=="4f"){this.set=this.setValue=this.setValue4F.bind(this);this.updateValue=this.updateValue4F.bind(this)}else if(t=="3f"){this.set=this.setValue=this.setValue3F.bind(this);this.updateValue=this.updateValue3F.bind(this)}else if(t=="2f"){this.set=this.setValue=this.setValue2F.bind(this);this.updateValue=this.updateValue2F.bind(this)}else if(t=="t"){this.set=this.setValue=this.setValueT.bind(this);this.updateValue=this.updateValueT.bind(this)}else if(t=="sampler"){if(this.setValueAny){this.set=this.setValue=this.setValueAny.bind(this);this.updateValue=this.updateValueAny.bind(this)}}else if(t=="tc"){this.set=this.setValue=this.setValueT.bind(this);this.updateValue=this.updateValueT.bind(this)}else if(t=="t[]"){this.set=this.setValue=this.setValueArrayT.bind(this);this.updateValue=this.updateValueArrayT.bind(this)}else if(t=="m4"||t=="m4[]"){this.set=this.setValue=this.setValueM4.bind(this);this.updateValue=this.updateValueM4.bind(this)}else{this._log.error("Unknown uniform type "+t,i,typeof this._shader)}if(typeof s=="object"&&s instanceof T.Port){this._port=s;this._value=this._port.get();if(r&&n&&a){if(!(r instanceof T.Port)||!(n instanceof T.Port)||!(a instanceof T.Port)){this._log.error("[cgl_uniform] mixed port/value parameter for vec4 ",this._name)}this._value=[0,0,0,0];this._port2=r;this._port3=n;this._port4=a;this._port.on("change",this.updateFromPort4f.bind(this));this._port2.on("change",this.updateFromPort4f.bind(this));this._port3.on("change",this.updateFromPort4f.bind(this));this._port4.on("change",this.updateFromPort4f.bind(this));this.updateFromPort4f()}else if(r&&n){if(!(r instanceof T.Port)||!(n instanceof T.Port)){this._log.error("[cgl_uniform] mixed port/value parameter for vec4 ",this._name)}this._value=[0,0,0];this._port2=r;this._port3=n;this._port.on("change",this.updateFromPort3f.bind(this));this._port2.on("change",this.updateFromPort3f.bind(this));this._port3.on("change",this.updateFromPort3f.bind(this));this.updateFromPort3f()}else if(r){if(!(r instanceof T.Port)){this._log.error("[cgl_uniform] mixed port/value parameter for vec4 ",this._name)}this._value=[0,0];this._port2=r;this._port.on("change",this.updateFromPort2f.bind(this));this._port2.on("change",this.updateFromPort2f.bind(this));this.updateFromPort2f()}else{this._port.on("change",this.updateFromPort.bind(this))}}else this._value=s;if(this._value==undefined){this._value=0}this.setValue(this._value);this.needsUpdate=true}getType(){return this._type}get type(){return this._type}get name(){return this._name}getName(){return this._name}getValue(){return this._value}getShaderType(){return this.shaderType}isStructMember(){return!!this._structName}updateFromPort4f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this._value[3]=this._port4.get();this.setValue(this._value)}updateFromPort3f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this.setValue(this._value)}updateFromPort2f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this.setValue(this._value)}updateFromPort(){this.setValue(this._port.get())}get port(){return this._port}}class c extends l{constructor(e,t,i,s,r,n,a,o,l,h){super(e,t,i,s,r,n,a,o,l,h);this._loc=-1;this._cgl=e._cgl}get name(){return this._name}copy(e){const t=new c(e,this._type,this._name,this._value,this._port2,this._port3,this._port4,this._structUniformName,this._structName,this._propertyName);t.shaderType=this.shaderType;return t}getGlslTypeString(){return c.glslTypeString(this._type)}_isValidLoc(){return this._loc!=-1}resetLoc(){this._loc=-1;this.needsUpdate=true}bindTextures(){}getLoc(){return this._loc}updateFromPort4f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this._value[3]=this._port4.get();this.setValue(this._value)}updateFromPort3f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this.setValue(this._value)}updateFromPort2f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this.setValue(this._value)}updateFromPort(){this.setValue(this._port.get())}updateValueF(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;this._shader.getCgl().gl.uniform1f(this._loc,this._value);this._cgl.profileData.profileUniformCount++}setValueF(e){if(e!=this._value){this.needsUpdate=true;this._value=e}}updateValueI(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;this._shader.getCgl().gl.uniform1i(this._loc,this._value);this._cgl.profileData.profileUniformCount++}updateValue2I(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform2i(this._loc,this._value[0],this._value[1]);this.needsUpdate=false;this._cgl.profileData.profileUniformCount++}updateValue3I(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform3i(this._loc,this._value[0],this._value[1],this._value[2]);this.needsUpdate=false;this._cgl.profileData.profileUniformCount++}updateValue4I(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform4i(this._loc,this._value[0],this._value[1],this._value[2],this._value[3]);this._cgl.profileData.profileUniformCount++}setValueI(e){if(e!=this._value){this.needsUpdate=true;this._value=e}}setValue2I(e){if(!e)return;if(!this._oldValue){this._oldValue=[e[0]-1,1];this.needsUpdate=true}else if(e[0]!=this._oldValue[0]||e[1]!=this._oldValue[1]){this._oldValue[0]=e[0];this._oldValue[1]=e[1];this.needsUpdate=true}this._value=e}setValue3I(e){if(!e)return;if(!this._oldValue){this._oldValue=[e[0]-1,1,2];this.needsUpdate=true}else if(e[0]!=this._oldValue[0]||e[1]!=this._oldValue[1]||e[2]!=this._oldValue[2]){this._oldValue[0]=e[0];this._oldValue[1]=e[1];this._oldValue[2]=e[2];this.needsUpdate=true}this._value=e}setValue4I(e){this.needsUpdate=true;this._value=e||vec4.create()}updateValueBool(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;this._shader.getCgl().gl.uniform1i(this._loc,this._value?1:0);this._cgl.profileData.profileUniformCount++}setValueBool(e){if(e!=this._value){this.needsUpdate=true;this._value=e}}setValueArray4F(e){this.needsUpdate=true;this._value=e}updateValueArray4F(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform4fv(this._loc,this._value);this._cgl.profileData.profileUniformCount++}setValueArray3F(e){this.needsUpdate=true;this._value=e}updateValueArray3F(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform3fv(this._loc,this._value);this._cgl.profileData.profileUniformCount++}setValueArray2F(e){this.needsUpdate=true;this._value=e}updateValueArray2F(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform2fv(this._loc,this._value);this._cgl.profileData.profileUniformCount++}setValueArrayF(e){this.needsUpdate=true;this._value=e}updateValueArrayF(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform1fv(this._loc,this._value);this._cgl.profileData.profileUniformCount++}setValueArrayT(e){this.needsUpdate=true;this._value=e}updateValue3F(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform3f(this._loc,this._value[0],this._value[1],this._value[2]);this.needsUpdate=false;this._cgl.profileData.profileUniformCount++}setValue3F(e){if(!e)return;if(!this._oldValue){this._oldValue=[e[0]-1,1,2];this.needsUpdate=true}else if(e[0]!=this._oldValue[0]||e[1]!=this._oldValue[1]||e[2]!=this._oldValue[2]){this._oldValue[0]=e[0];this._oldValue[1]=e[1];this._oldValue[2]=e[2];this.needsUpdate=true}this._value=e}updateValue2F(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform2f(this._loc,this._value[0],this._value[1]);this.needsUpdate=false;this._cgl.profileData.profileUniformCount++}setValue2F(e){if(!e)return;if(!this._oldValue){this._oldValue=[e[0]-1,1];this.needsUpdate=true}else if(e[0]!=this._oldValue[0]||e[1]!=this._oldValue[1]){this._oldValue[0]=e[0];this._oldValue[1]=e[1];this.needsUpdate=true}this._value=e}updateValue4F(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}if(!this._value){this._log.warn("no value for uniform",this._name,this);this._value=[0,0,0,0]}this.needsUpdate=false;this._shader.getCgl().gl.uniform4f(this._loc,this._value[0],this._value[1],this._value[2],this._value[3]);this._cgl.profileData.profileUniformCount++}setValue4F(e){if(typeof this.value=="number")this.value=vec4.create();if(!e)return;if(!this._oldValue){this._oldValue=[e[0]-1,1,2,3];this.needsUpdate=true}else if(e[0]!=this._oldValue[0]||e[1]!=this._oldValue[1]||e[2]!=this._oldValue[2]||e[3]!=this._oldValue[3]){this._oldValue[0]=e[0];this._oldValue[1]=e[1];this._oldValue[2]=e[2];this.needsUpdate=true}this._value=e}updateValueM4(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}if(!this._value||this._value.length%16!=0)return console.log("this.name",this._name,this._value);this._shader.getCgl().gl.uniformMatrix4fv(this._loc,false,this._value);this._cgl.profileData.profileUniformCount++}setValueM4(e){this.needsUpdate=true;this._value=e||mat4.create()}updateValueArrayT(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform1iv(this._loc,this._value);this._cgl.profileData.profileUniformCount++}updateValueT(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.profileShaderGetUniform++;this._cgl.profileData.profileShaderGetUniformName=this._name}this._cgl.profileData.profileUniformCount++;this._shader.getCgl().gl.uniform1i(this._loc,this._value);this.needsUpdate=false}setValueT(e){this.needsUpdate=true;this._value=e}}c.glslTypeString=e=>{if(e=="f")return"float";if(e=="b")return"bool";if(e=="i")return"int";if(e=="2i")return"ivec2";if(e=="2f")return"vec2";if(e=="3f")return"vec3";if(e=="4f")return"vec4";if(e=="m4")return"mat4";if(e=="t")return"sampler2D";if(e=="tc")return"samplerCube";if(e=="3f[]")return null;if(e=="m4[]")return null;if(e=="f[]")return null;console.warn("[CGL UNIFORM] unknown glsl type string ",e)};const f={SHADERVAR_VERTEX_POSITION:"vPosition",SHADERVAR_VERTEX_NUMBER:"attrVertIndex",SHADERVAR_VERTEX_NORMAL:"attrVertNormal",SHADERVAR_VERTEX_TEXCOORD:"attrTexCoord",SHADERVAR_INSTANCE_MMATRIX:"instMat",SHADERVAR_VERTEX_COLOR:"attrVertColor",SHADERVAR_INSTANCE_INDEX:"instanceIndex",SHADERVAR_UNI_PROJMAT:"projMatrix",SHADERVAR_UNI_VIEWMAT:"viewMatrix",SHADERVAR_UNI_MODELMAT:"modelMatrix",SHADERVAR_UNI_NORMALMAT:"normalMatrix",SHADERVAR_UNI_INVVIEWMAT:"inverseViewMatrix",SHADERVAR_UNI_INVPROJMAT:"invProjMatrix",SHADERVAR_UNI_MATERIALID:"materialId",SHADERVAR_UNI_OBJECTID:"objectId",SHADERVAR_UNI_VIEWPOS:"camPos"};const g={BLEND_NONE:0,BLEND_NORMAL:1,BLEND_ADD:2,BLEND_SUB:3,BLEND_MUL:4};const d=180/Math.PI;const m=Math.PI/180;const p={MATH:{DEG2RAD:m,RAD2DEG:d},SHADER:f,BLEND_MODES:g};const A="\n";class _{_name="unknown";constructor(){}}const S={};S.lastMesh=null;class v extends _{#cgl=null;#geom=null;#bufVerticesIndizes=null;constructor(e,t,i={}){super();this.#cgl=e;let s=i||{};if(T.utils.isNumeric(s))s={glPrimitive:i};this._log=new u.Logger("cgl_mesh");this._bufVertexAttrib=null;this.#bufVerticesIndizes=this.#cgl.gl.createBuffer();this._indexType=this.#cgl.gl.UNSIGNED_SHORT;this._attributes=[];this._attribLocs={};this._lastShader=null;this._numInstances=0;this._glPrimitive=s.glPrimitive;this.opId=s.opId||"";this._preWireframeGeom=null;this.addVertexNumbers=false;this.feedBackAttributes=[];this.setGeom(t);this._feedBacks=[];this._feedBacksChanged=false;this._transformFeedBackLoc=-1;this._lastAttrUpdate=0;this.memFreed=false;this.#cgl.profileData.addHeavyEvent("mesh constructed",this._name);this._queryExt=null}get geom(){return this.#geom}get numInstances(){return this._numInstances}set numInstances(e){this.setNumInstances(e)}freeMem(){this.memFreed=true;for(let e=0;e<this._attributes.length;e++)this._attributes[e].floatArray=null}updateVertices(e){this.setAttribute(p.SHADER.SHADERVAR_VERTEX_POSITION,e.vertices,3);this._numVerts=e.vertices.length/3}setAttributePointer(t,i,s,r){for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].name==t){if(!this._attributes[e].pointer)this._attributes[e].pointer=[];this._attributes[e].pointer.push({loc:-1,name:i,stride:s,offset:r,instanced:t==p.SHADER.SHADERVAR_INSTANCE_MMATRIX})}}}getAttribute(t){for(let e=0;e<this._attributes.length;e++)if(this._attributes[e].name==t)return this._attributes[e]}setAttributeRange(e,t,i,s){if(!e)return;if(!i&&!s)return;if(!e.name)this._log.stack("no attrname?!");const r=this.#cgl.gl;r.bindBuffer(r.ARRAY_BUFFER,e.buffer);this.#cgl.profileData.profileMeshAttributes+=s-i||0;this.#cgl.profileData.profileSingleMeshAttribute[this._name]=this.#cgl.profileData.profileSingleMeshAttribute[this._name]||0;this.#cgl.profileData.profileSingleMeshAttribute[this._name]+=s-i||0;if(e.numItems<t.length/e.itemSize){this._resizeAttr(t,e)}if(s>t.length&&!this.warned){this.warned=true;this._log.warn(this.#cgl.canvas.id+" "+e.name+" buffersubdata out of bounds ?",t.length,s,i,e);return}r.bufferSubData(r.ARRAY_BUFFER,i*4,t,i,s-i)}_resizeAttr(e,t){const i=this.#cgl.gl;if(t.buffer)i.deleteBuffer(t.buffer);t.buffer=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,t.buffer);this._bufferArray(e,t);t.numItems=e.length/t.itemSize}_bufferArray(e,t){let i=t.floatArray||null;if(!e)return;if(this.#cgl.debugOneFrame){console.log("_bufferArray",e.length,t.name)}if(!(e instanceof Float32Array)){if(t&&i&&i.length==e.length){i.set(e)}else{i=new Float32Array(e);if(this.#cgl.debugOneFrame){console.log("_bufferArray create new float32array",e.length,t.name)}if(e.length>1e4){this.#cgl.profileData.profileNonTypedAttrib++;this.#cgl.profileData.profileNonTypedAttribNames="("+this._name+":"+t.name+")"}}}else i=e;t.arrayLength=i.length;t.floatArray=null;this.#cgl.gl.bufferData(this.#cgl.gl.ARRAY_BUFFER,i,this.#cgl.gl.DYNAMIC_DRAW)}addAttribute(e,t,i,s){this.setAttribute(e,t,i,s)}setAttribute(e,t,i,s={}){if(!t){this._log.error("mesh addAttribute - no array given! "+e);throw new Error}let r=null;let n=false;let a=0;const o=t.length/i;this.#cgl.profileData.profileMeshAttributes+=o||0;if(typeof s=="function"){r=s}if(typeof s=="object"){if(s.cb)r=s.cb;if(s.instanced)n=s.instanced}if(e==p.SHADER.SHADERVAR_INSTANCE_MMATRIX)n=true;for(a=0;a<this._attributes.length;a++){const u=this._attributes[a];if(u.name==e){if(u.numItems===o){}else{this._resizeAttr(t,u)}this.#cgl.gl.bindBuffer(this.#cgl.gl.ARRAY_BUFFER,u.buffer);this._bufferArray(t,u);return u}}const l=this.#cgl.gl.createBuffer();this.#cgl.gl.bindBuffer(this.#cgl.gl.ARRAY_BUFFER,l);let h=this.#cgl.gl.FLOAT;if(s&&s.type)h=s.type;const u={buffer:l,name:e,cb:r,itemSize:i,numItems:o,startItem:0,instanced:n,type:h};this._bufferArray(t,u);if(e==p.SHADER.SHADERVAR_VERTEX_POSITION)this._bufVertexAttrib=u;this._attributes.push(u);this._attribLocs={};return u}getAttributes(){return this._attributes}updateTexCoords(e){if(e.texCoords&&e.texCoords.length>0){this.setAttribute(p.SHADER.SHADERVAR_VERTEX_TEXCOORD,e.texCoords,2)}else{const t=new Float32Array(Math.round(e.vertices.length/3*2));this.setAttribute(p.SHADER.SHADERVAR_VERTEX_TEXCOORD,t,2)}}updateNormals(e){if(e.vertexNormals&&e.vertexNormals.length>0){this.setAttribute(p.SHADER.SHADERVAR_VERTEX_NORMAL,e.vertexNormals,3)}else{const t=new Float32Array(Math.round(e.vertices.length));this.setAttribute(p.SHADER.SHADERVAR_VERTEX_NORMAL,t,3)}}_setVertexNumbers(e=null){if(!this._verticesNumbers||this._verticesNumbers.length!=this._numVerts||e){if(e)this._verticesNumbers=e;else{this._verticesNumbers=new Float32Array(this._numVerts);for(let e=0;e<this._numVerts;e++)this._verticesNumbers[e]=e}this.setAttribute(p.SHADER.SHADERVAR_VERTEX_NUMBER,this._verticesNumbers,1,(e,t,i)=>{if(!i.uniformNumVertices)i.uniformNumVertices=new c(i,"f","numVertices",this._numVerts);i.uniformNumVertices.setValue(this._numVerts)})}}setVertexIndices(t){if(!this.#bufVerticesIndizes){this._log.warn("no bufVerticesIndizes: "+this._name);return}if(t.length>0){if(t instanceof Float32Array)this._log.warn("vertIndices float32Array: "+this._name);for(let e=0;e<t.length;e++){if(t[e]>=this._numVerts){this._log.warn("invalid index in "+this._name,e,t[e]);return}}this.#cgl.gl.bindBuffer(this.#cgl.gl.ELEMENT_ARRAY_BUFFER,this.#bufVerticesIndizes);if(t.length>65535){this.vertIndicesTyped=new Uint32Array(t);this._indexType=this.#cgl.gl.UNSIGNED_INT}else if(t instanceof Uint32Array){this.vertIndicesTyped=t;this._indexType=this.#cgl.gl.UNSIGNED_INT}else if(!(t instanceof Uint16Array)){this.vertIndicesTyped=new Uint16Array(t);this._indexType=this.#cgl.gl.UNSIGNED_SHORT}else this.vertIndicesTyped=t;this.#cgl.gl.bufferData(this.#cgl.gl.ELEMENT_ARRAY_BUFFER,this.vertIndicesTyped,this.#cgl.gl.DYNAMIC_DRAW);this.#bufVerticesIndizes.itemSize=1;this.#bufVerticesIndizes.numItems=t.length}else this.#bufVerticesIndizes.numItems=0}setGeom(e,t=false){this.#geom=e;if(e.glPrimitive!=null)this._glPrimitive=e.glPrimitive;if(this.#geom&&this.#geom.name)this._name="mesh "+this.#geom.name;S.lastMesh=null;this.#cgl.profileData.profileMeshSetGeom++;this._disposeAttributes();this.updateVertices(this.#geom);this.setVertexIndices(this.#geom.verticesIndices);if(this.addVertexNumbers)this._setVertexNumbers();const i=this.#geom.getAttributes();const s={texCoords:p.SHADER.SHADERVAR_VERTEX_TEXCOORD,vertexNormals:p.SHADER.SHADERVAR_VERTEX_NORMAL,vertexColors:p.SHADER.SHADERVAR_VERTEX_COLOR,tangents:"attrTangent",biTangents:"attrBiTangent"};for(const r in i)if(i[r].data&&i[r].data.length)this.setAttribute(s[r]||r,i[r].data,i[r].itemSize);if(t){this.#geom=null}}_preBind(t){for(let e=0;e<this._attributes.length;e++)if(this._attributes[e].cb)this._attributes[e].cb(this._attributes[e],this.#geom,t)}_checkAttrLengths(){if(this.memFreed)return;for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].arrayLength/this._attributes[e].itemSize<this._attributes[0].arrayLength/this._attributes[0].itemSize){let e="unknown";if(this.#geom)e=this.#geom.name}}}_bind(t){if(!t)return;if(!t.isValid())return;let i=[];if(this._attribLocs[t.id])i=this._attribLocs[t.id];else this._attribLocs[t.id]=i;this._lastShader=t;if(t.lastCompile>this._lastAttrUpdate||i.length!=this._attributes.length){this._lastAttrUpdate=t.lastCompile;for(let e=0;e<this._attributes.length;e++)i[e]=-1}for(let e=0;e<this._attributes.length;e++){const s=this._attributes[e];if(i[e]==-1){if(s._attrLocationLastShaderTime!=t.lastCompile){s._attrLocationLastShaderTime=t.lastCompile;i[e]=this.#cgl.glGetAttribLocation(t.getProgram(),s.name);this.#cgl.profileData.profileAttrLoc++}}if(i[e]!=-1){this.#cgl.gl.enableVertexAttribArray(i[e]);this.#cgl.gl.bindBuffer(this.#cgl.gl.ARRAY_BUFFER,s.buffer);if(s.instanced){if(s.itemSize<=4){if(!s.itemSize||s.itemSize==0)this._log.warn("instanced attrib itemsize error",this.#geom.name,s);this.#cgl.gl.vertexAttribPointer(i[e],s.itemSize,s.type,false,s.itemSize*4,0);this.#cgl.gl.vertexAttribDivisor(i[e],1)}else if(s.itemSize==16){const r=16*4;this.#cgl.gl.vertexAttribPointer(i[e],4,s.type,false,r,0);this.#cgl.gl.enableVertexAttribArray(i[e]+1);this.#cgl.gl.vertexAttribPointer(i[e]+1,4,s.type,false,r,4*4*1);this.#cgl.gl.enableVertexAttribArray(i[e]+2);this.#cgl.gl.vertexAttribPointer(i[e]+2,4,s.type,false,r,4*4*2);this.#cgl.gl.enableVertexAttribArray(i[e]+3);this.#cgl.gl.vertexAttribPointer(i[e]+3,4,s.type,false,r,4*4*3);this.#cgl.gl.vertexAttribDivisor(i[e],1);this.#cgl.gl.vertexAttribDivisor(i[e]+1,1);this.#cgl.gl.vertexAttribDivisor(i[e]+2,1);this.#cgl.gl.vertexAttribDivisor(i[e]+3,1)}else{this._log.warn("unknown instance attrib size",s.name)}}else{if(!s.itemSize||s.itemSize==0)this._log.warn("attrib itemsize error",this._name,s);this.#cgl.gl.vertexAttribPointer(i[e],s.itemSize,s.type,false,s.itemSize*4,0);if(s.pointer){for(let e=0;e<s.pointer.length;e++){const n=s.pointer[e];if(n.loc==-1)n.loc=this.#cgl.glGetAttribLocation(t.getProgram(),n.name);this.#cgl.profileData.profileAttrLoc++;this.#cgl.gl.enableVertexAttribArray(n.loc);this.#cgl.gl.vertexAttribPointer(n.loc,s.itemSize,s.type,false,n.stride,n.offset)}}if(this.bindFeedback)this.bindFeedback(s)}}}if(this.#bufVerticesIndizes&&this.#bufVerticesIndizes.numItems!==0)this.#cgl.gl.bindBuffer(this.#cgl.gl.ELEMENT_ARRAY_BUFFER,this.#bufVerticesIndizes)}unBind(){const e=this._lastShader;this._lastShader=null;if(!e)return;let t=[];if(this._attribLocs[e.id])t=this._attribLocs[e.id];else this._attribLocs[e.id]=t;S.lastMesh=null;for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].instanced){if(this._attributes[e].itemSize<=4){if(t[e]!=-1)this.#cgl.gl.vertexAttribDivisor(t[e],0);if(t[e]>=0)this.#cgl.gl.disableVertexAttribArray(t[e])}else{this.#cgl.gl.vertexAttribDivisor(t[e],0);this.#cgl.gl.vertexAttribDivisor(t[e]+1,0);this.#cgl.gl.vertexAttribDivisor(t[e]+2,0);this.#cgl.gl.vertexAttribDivisor(t[e]+3,0);this.#cgl.gl.disableVertexAttribArray(t[e]+1);this.#cgl.gl.disableVertexAttribArray(t[e]+2);this.#cgl.gl.disableVertexAttribArray(t[e]+3)}}if(t[e]!=-1)this.#cgl.gl.disableVertexAttribArray(t[e])}}meshChanged(){return this.#cgl.lastMesh&&this.#cgl.lastMesh!=this}printDebug(){console.log("--attributes");for(let e=0;e<this._attributes.length;e++){console.log("attribute "+e+" "+this._attributes[e].name)}}setNumVertices(e){this._bufVertexAttrib.numItems=e}getNumVertices(){return this._bufVertexAttrib.numItems}setNumIndices(e){this.#bufVerticesIndizes.numItems=e}getNumIndices(){return this.#bufVerticesIndizes.numItems}render(i){if(this.#cgl.aborted)return;i=i||this.#cgl.getShader();if(!i){return console.log("shader not valid")}if(!i.isValid()){i=this.#cgl.getErrorShader()}this._checkAttrLengths();if(this.#geom){if(this._preWireframeGeom&&!i.wireframe&&!this.#geom.isIndexed()){this.setGeom(this._preWireframeGeom);this._preWireframeGeom=null}if(i.wireframe){let e=false;if(this.#geom.isIndexed()){if(!this._preWireframeGeom){this._preWireframeGeom=this.#geom;this.#geom=this.#geom.copy()}this.#geom.unIndex();e=true}if(!this.#geom.getAttribute("attrBarycentric")){if(!this._preWireframeGeom){this._preWireframeGeom=this.#geom;this.#geom=this.#geom.copy()}e=true;this.#geom.calcBarycentric()}if(e)this.setGeom(this.#geom)}}let e=false;if(S.lastMesh!=this){if(S.lastMesh)S.lastMesh.unBind();e=true}if(e)this._preBind(i);if(!i.bind())return;this._bind(i);if(this.addVertexNumbers)this._setVertexNumbers();S.lastMesh=this;let t=this.#cgl.gl.TRIANGLES;if(this._glPrimitive!==undefined)t=this._glPrimitive;if(i.glPrimitive!==null)t=i.glPrimitive;let s=1;let r=this.#cgl.profileData.doProfileGlQuery;let n=false;if(r){let e=this._name+" - "+i.getName()+" #"+i.id;if(this._numInstances)e+=" instanced "+this._numInstances+"x";let t=this.#cgl.profileData.glQueryData[e];if(!t)t={id:e,num:0};if(i.opId)t.shaderOp=i.opId;if(this.opId)t.meshOp=this.opId;this.#cgl.profileData.glQueryData[e]=t;if(!this._queryExt&&this._queryExt!==false)this._queryExt=this.#cgl.enableExtension("EXT_disjoint_timer_query_webgl2")||false;if(this._queryExt){if(t._drawQuery){const a=this.#cgl.gl.getQueryParameter(t._drawQuery,this.#cgl.gl.QUERY_RESULT_AVAILABLE);if(a){const o=this.#cgl.gl.getQueryParameter(t._drawQuery,this.#cgl.gl.QUERY_RESULT);const l=o/1e6;t._times=t._times||0;t._times+=l;t._numcount++;t.when=performance.now();t._drawQuery=null;t.queryStarted=false}}if(!t.queryStarted){t._drawQuery=this.#cgl.gl.createQuery();this.#cgl.gl.beginQuery(this._queryExt.TIME_ELAPSED_EXT,t._drawQuery);n=t.queryStarted=true}}}if(this.hasFeedbacks&&this.hasFeedbacks())this.drawFeedbacks(i,t);else if(!this.#bufVerticesIndizes||this.#bufVerticesIndizes.numItems===0){if(t==this.#cgl.gl.TRIANGLES)s=3;if(this._numInstances===0)this.#cgl.gl.drawArrays(t,this._bufVertexAttrib.startItem,this._bufVertexAttrib.numItems-this._bufVertexAttrib.startItem);else this.#cgl.gl.drawArraysInstanced(t,this._bufVertexAttrib.startItem,this._bufVertexAttrib.numItems,this._numInstances)}else{if(t==this.#cgl.gl.TRIANGLES)s=3;if(this._numInstances===0){this.#cgl.gl.drawElements(t,this.#bufVerticesIndizes.numItems,this._indexType,0)}else{this.#cgl.gl.drawElementsInstanced(t,this.#bufVerticesIndizes.numItems,this._indexType,0,this._numInstances)}}if(this.#cgl.debugOneFrame&&this.#cgl.gl.getError()!=this.#cgl.gl.NO_ERROR){this._log.error("mesh draw gl error");this._log.error("mesh",this);this._log.error("shader",i);const h=[];for(let e=0;e<this.#cgl.gl.getProgramParameter(i.getProgram(),this.#cgl.gl.ACTIVE_ATTRIBUTES);e++){const u=this.#cgl.gl.getActiveAttrib(i.getProgram(),e).name;this._log.error("attrib ",u)}}this.#cgl.profileData.profileMeshNumElements+=this._bufVertexAttrib.numItems/s*(this._numInstances||1);this.#cgl.profileData.profileMeshDraw++;if(r&&n){this.#cgl.gl.endQuery(this._queryExt.TIME_ELAPSED_EXT)}this.#cgl.printError("mesh render "+this._name);this.unBind()}setNumInstances(t){t=Math.max(0,t);if(this._numInstances!=t){this._numInstances=t;const i=new Float32Array(t);for(let e=0;e<t;e++)i[e]=e;this.setAttribute(p.SHADER.SHADERVAR_INSTANCE_INDEX,i,1,{instanced:true})}}_disposeAttributes(){if(!this._attributes)return;for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].buffer){this.#cgl.gl.deleteBuffer(this._attributes[e].buffer);this._attributes[e].buffer=null}}this._attributes.length=0}dispose(){if(this.#cgl.aborted)return;if(this._bufVertexAttrib&&this._bufVertexAttrib.buffer)this.#cgl.gl.deleteBuffer(this._bufVertexAttrib.buffer);if(this.#bufVerticesIndizes)this.#cgl.gl.deleteBuffer(this.#bufVerticesIndizes);this.#bufVerticesIndizes=null;this._disposeAttributes();return null}}const w=CABLES.GLMatrix;class E{constructor(e){this._init();this._first=true;this._wireMesh=null;if(e)this.applyGeom(e)}_init(){this._max=[-0,-0,-0];this._min=[0,0,0];this._center=[0,0,0];this._size=[0,0,0];this._maxAxis=0;this._first=true}get maxAxis(){return this._maxAxis||1}get size(){return this._size}get center(){return this._center}get x(){return this._center[0]}get y(){return this._center[1]}get z(){return this._center[2]}get minX(){return this._min[0]}get minY(){return this._min[1]}get minZ(){return this._min[2]}get maxX(){return this._max[0]}get maxY(){return this._max[1]}get maxZ(){return this._max[2]}apply(e){return this.applyGeom(e)}applyGeom(t){if(!t)return;if(t instanceof E){const e=t;this.applyPos(e.maxX,e.maxY,e.maxZ);this.applyPos(e.minX,e.minY,e.minZ)}else{if(t.isGeometry)for(let e=0;e<t.vertices.length;e+=3)this.applyPos(t.vertices[e],t.vertices[e+1],t.vertices[e+2])}this.calcCenterSize()}copy(){return new E(this)}get changed(){return!(this._max[0]==-Number.MAX_VALUE&&this._max[1]==-Number.MAX_VALUE&&this._max[2]==-Number.MAX_VALUE)}applyPos(e,t,i){if(e==Number.MAX_VALUE||e==-Number.MAX_VALUE||t==Number.MAX_VALUE||t==-Number.MAX_VALUE||i==Number.MAX_VALUE||i==-Number.MAX_VALUE)return;if(!T.utils.isNumeric(e)||!T.utils.isNumeric(t)||!T.utils.isNumeric(i))return;if(this._first){this._max[0]=e;this._max[1]=t;this._max[2]=i;this._min[0]=e;this._min[1]=t;this._min[2]=i;this._first=false;return}this._max[0]=Math.max(this._max[0],e);this._max[1]=Math.max(this._max[1],t);this._max[2]=Math.max(this._max[2],i);this._min[0]=Math.min(this._min[0],e);this._min[1]=Math.min(this._min[1],t);this._min[2]=Math.min(this._min[2],i)}calcCenterSize(){if(this._first)return;this._size[0]=this._max[0]-this._min[0];this._size[1]=this._max[1]-this._min[1];this._size[2]=this._max[2]-this._min[2];this._center[0]=(this._min[0]+this._max[0])/2;this._center[1]=(this._min[1]+this._max[1])/2;this._center[2]=(this._min[2]+this._max[2])/2;this._maxAxis=Math.max(this._size[2],Math.max(this._size[0],this._size[1]))}mulMat4(e){if(this._first){this._max[0]=0;this._max[1]=0;this._max[2]=0;this._min[0]=0;this._min[1]=0;this._min[2]=0;this._first=false}w.vec3.transformMat4(this._max,this._max,e);w.vec3.transformMat4(this._min,this._min,e);this.calcCenterSize()}render(e,t,i){if(!this._wireMesh)this._wireMesh=new CGL.WireCube(e);e.pushModelMatrix();w.mat4.translate(e.mMatrix,e.mMatrix,this._center);if(CABLES.UI&&i){CABLES.UI.OverlayMeshes.drawCube(i,this._size[0]/2,this._size[1]/2,this._size[2]/2)}e.popModelMatrix()}}class b{isGeometry=true;constructor(e){this.name=e||"unknown";this._log=new u.Logger("cgl_geometry");this.faceVertCount=3;this.glPrimitive=null;this._attributes={};this._vertices=[];this.verticesIndices=[];this.morphTargets=[]}get vertices(){return this._vertices}set vertices(e){this.setVertices(e)}get texCoords(){const e=this.getAttribute("texCoords");if(!e)return[];return e.data}set texCoords(e){this.setAttribute("texCoords",e,2)}get vertexNormals(){const e=this.getAttribute("vertexNormals");if(!e)return[];return e.data}set vertexNormals(e){this.setAttribute("vertexNormals",e,3)}get tangents(){const e=this.getAttribute("tangents");if(!e)return[];return e.data}set tangents(e){this.setAttribute("tangents",e,3)}get biTangents(){const e=this.getAttribute("biTangents");if(!e)return[];return e.data}set biTangents(e){this.setAttribute("biTangents",e,3)}get vertexColors(){const e=this.getAttribute("vertexColors");if(!e)return[];return e.data}set vertexColors(e){this.setAttribute("vertexColors",e,4)}clear(){this._vertices=new Float32Array([]);this.verticesIndices=[];this.texCoords=new Float32Array([]);this.vertexNormals=new Float32Array([]);this.tangents=[];this.biTangents=[];this._attributes={}}getAttributes(){return this._attributes}getAttribute(t){for(const e in this._attributes){if(this._attributes[e].name==t)return this._attributes[e]}return null}setAttribute(e,t,i){let s="";if(!i||i>4){this._log.warn("itemsize wrong?",i,e);this._log.stack("itemsize");i=3}if(i==1)s="float";else if(i==2)s="vec2";else if(i==3)s="vec3";else if(i==4)s="vec4";const r={name:e,data:t,itemSize:i,type:s};this._attributes[e]=r}copyAttribute(e,t){const i=this.getAttribute(e);t.setAttribute(e,new Float32Array(i.data),i.itemSize)}setVertices(e){if(e instanceof Float32Array)this._vertices=e;else this._vertices=new Float32Array(e)}setTexCoords(e){if(e instanceof Float32Array)this.texCoords=e;else this.texCoords=new Float32Array(e)}calcNormals(e){const t={smooth:e};this.calculateNormals(t)}flipNormals(t,i,s){let r=w.vec3.create();if(t==undefined)t=1;if(i==undefined)i=1;if(s==undefined)s=1;for(let e=0;e<this.vertexNormals.length;e+=3){w.vec3.set(r,this.vertexNormals[e+0],this.vertexNormals[e+1],this.vertexNormals[e+2]);r[0]*=-t;r[1]*=-i;r[2]*=-s;w.vec3.normalize(r,r);this.vertexNormals[e+0]=r[0];this.vertexNormals[e+1]=r[1];this.vertexNormals[e+2]=r[2]}}getNumTriangles(){if(this.verticesIndices&&this.verticesIndices.length)return this.verticesIndices.length/3;return this.vertices.length/3}flipVertDir(){const t=[];t.length=this.verticesIndices.length;for(let e=0;e<this.verticesIndices.length;e+=3){t[e]=this.verticesIndices[e+2];t[e+1]=this.verticesIndices[e+1];t[e+2]=this.verticesIndices[e]}this.verticesIndices=t}setPointVertices(t){if(t.length%3!==0){this._log.error("SetPointVertices: Array must be multiple of three.");return}if(!(t instanceof Float32Array))this.vertices=new Float32Array(t);else this.vertices=t;if(!(this.texCoords instanceof Float32Array))this.texCoords=new Float32Array(t.length/3*2);this.verticesIndices.length=t.length/3;for(let e=0;e<t.length/3;e++){this.verticesIndices[e]=e;this.texCoords[e*2]=0;this.texCoords[e*2+1]=0}}merge(t){if(!t)return;if(this.isIndexed()!=t.isIndexed()){if(this.isIndexed()){this.unIndex(false,true)}if(t.isIndexed()){const e=t.copy();e.unIndex(false,true);t=e}}const i=this.verticesIndices.length;const s=this._vertices.length/3;this.verticesIndices.length+=t.verticesIndices.length;for(let e=0;e<t.verticesIndices.length;e++)this.verticesIndices[i+e]=t.verticesIndices[e]+s;this.vertices=T.utils.float32Concat(this._vertices,t.vertices);this.texCoords=T.utils.float32Concat(this.texCoords,t.texCoords);this.vertexNormals=T.utils.float32Concat(this.vertexNormals,t.vertexNormals);this.tangents=T.utils.float32Concat(this.tangents,t.tangents);this.biTangents=T.utils.float32Concat(this.biTangents,t.biTangents)}copy(){const t=new b(this.name+" copy");t.faceVertCount=this.faceVertCount;t.glPrimitive=this.glPrimitive;t.setVertices(this._vertices.slice(0));if(this.verticesIndices){t.verticesIndices.length=this.verticesIndices.length;for(let e=0;e<this.verticesIndices.length;e++)t.verticesIndices[e]=this.verticesIndices[e]}for(let e in this._attributes)this.copyAttribute(e,t);t.morphTargets.length=this.morphTargets.length;for(let e=0;e<this.morphTargets.length;e++)t.morphTargets[e]=this.morphTargets[e];return t}calculateNormals(t=null){t=t||{};if(t.smooth===false)this.unIndex();const i=w.vec3.create();const s=w.vec3.create();const r=w.vec3.create();function n(e){w.vec3.subtract(i,e[0],e[1]);w.vec3.subtract(s,e[0],e[2]);w.vec3.cross(r,i,s);w.vec3.normalize(r,r);if(t&&t.forceZUp){if(r[2]<0){r[0]*=-1;r[1]*=-1;r[2]*=-1}}return r}this.getVertexVec=function(e){const t=[0,0,0];t[0]=this.vertices[e*3+0];t[1]=this.vertices[e*3+1];t[2]=this.vertices[e*3+2];return t};if(!(this.vertexNormals instanceof Float32Array)||this.vertexNormals.length!=this.vertices.length)this.vertexNormals=new Float32Array(this.vertices.length);for(let e=0;e<this.vertices.length;e++){this.vertexNormals[e]=0}if(!this.isIndexed()){const a=[];for(let e=0;e<this.vertices.length;e+=9){const o=[[this.vertices[e+0],this.vertices[e+1],this.vertices[e+2]],[this.vertices[e+3],this.vertices[e+4],this.vertices[e+5]],[this.vertices[e+6],this.vertices[e+7],this.vertices[e+8]]];const l=n(o);a.push(l[0],l[1],l[2],l[0],l[1],l[2],l[0],l[1],l[2])}this.vertexNormals=a}else{const h=[];h.length=Math.floor(this.verticesIndices.length/3);for(let e=0;e<this.verticesIndices.length;e+=3){const o=[this.getVertexVec(this.verticesIndices[e+0]),this.getVertexVec(this.verticesIndices[e+1]),this.getVertexVec(this.verticesIndices[e+2])];h[e/3]=n(o);this.vertexNormals[this.verticesIndices[e+0]*3+0]+=h[e/3][0];this.vertexNormals[this.verticesIndices[e+0]*3+1]+=h[e/3][1];this.vertexNormals[this.verticesIndices[e+0]*3+2]+=h[e/3][2];this.vertexNormals[this.verticesIndices[e+1]*3+0]+=h[e/3][0];this.vertexNormals[this.verticesIndices[e+1]*3+1]+=h[e/3][1];this.vertexNormals[this.verticesIndices[e+1]*3+2]+=h[e/3][2];this.vertexNormals[this.verticesIndices[e+2]*3+0]+=h[e/3][0];this.vertexNormals[this.verticesIndices[e+2]*3+1]+=h[e/3][1];this.vertexNormals[this.verticesIndices[e+2]*3+2]+=h[e/3][2]}for(let t=0;t<this.verticesIndices.length;t+=3){for(let e=0;e<3;e++){const u=[this.vertexNormals[this.verticesIndices[t+e]*3+0],this.vertexNormals[this.verticesIndices[t+e]*3+1],this.vertexNormals[this.verticesIndices[t+e]*3+2]];w.vec3.normalize(u,u);this.vertexNormals[this.verticesIndices[t+e]*3+0]=u[0];this.vertexNormals[this.verticesIndices[t+e]*3+1]=u[1];this.vertexNormals[this.verticesIndices[t+e]*3+2]=u[2]}}}}calcTangentsBitangents(){if(!this.vertices.length){return}if(!this.vertexNormals.length){return}if(!this.texCoords.length){const b=this.vertices.length/3*2;this.texCoords=new Float32Array(b);for(let e=0;e<b;e+=1)this.texCoords[e]=0}if(!this.verticesIndices||!this.verticesIndices.length){return}if(this.verticesIndices.length%3!==0){this._log.error("Vertex indices mismatch!");return}const t=this.verticesIndices.length/3;const i=this.vertices.length/3;this.tangents=new Float32Array(this.vertexNormals.length);this.biTangents=new Float32Array(this.vertexNormals.length);const s=[];s.length=i*2;const r=w.vec3.create();const n=w.vec3.create();const a=w.vec3.create();const o=w.vec2.create();const l=w.vec2.create();const h=w.vec2.create();const u=w.vec3.create();const c=w.vec3.create();for(let e=0;e<t;e+=1){const x=this.verticesIndices[e*3];const T=this.verticesIndices[e*3+1];const A=this.verticesIndices[e*3+2];w.vec3.set(r,this.vertices[x*3],this.vertices[x*3+1],this.vertices[x*3+2]);w.vec3.set(n,this.vertices[T*3],this.vertices[T*3+1],this.vertices[T*3+2]);w.vec3.set(a,this.vertices[A*3],this.vertices[A*3+1],this.vertices[A*3+2]);w.vec2.set(o,this.texCoords[x*2],this.texCoords[x*2+1]);w.vec2.set(l,this.texCoords[T*2],this.texCoords[T*2+1]);w.vec2.set(h,this.texCoords[A*2],this.texCoords[A*2+1]);const S=n[0]-r[0];const M=a[0]-r[0];const I=n[1]-r[1];const O=a[1]-r[1];const R=n[2]-r[2];const C=a[2]-r[2];const P=l[0]-o[0];const N=h[0]-o[0];const F=l[1]-o[1];const L=h[1]-o[1];const D=1/(P*L-N*F);w.vec3.set(u,(L*S-F*M)*D,(L*I-F*O)*D,(L*R-F*C)*D);w.vec3.set(c,(P*M-N*S)*D,(P*O-N*I)*D,(P*C-N*R)*D);s[x]=u;s[T]=u;s[A]=u;s[x+i]=c;s[T+i]=c;s[A+i]=c}const f=w.vec3.create();const g=w.vec3.create();const d=w.vec3.create();const m=w.vec3.create();const p=w.vec3.create();const _=w.vec3.create();const v=w.vec3.create();const E=w.vec3.create();for(let e=0;e<i;e+=1){if(!s[e])continue;w.vec3.set(f,this.vertexNormals[e*3],this.vertexNormals[e*3+1],this.vertexNormals[e*3+2]);w.vec3.set(g,s[e][0],s[e][1],s[e][2]);const y=w.vec3.dot(f,g);w.vec3.scale(p,f,y);w.vec3.subtract(_,g,p);w.vec3.normalize(E,_);w.vec3.cross(v,f,g);const U=1;w.vec3.scale(d,E,1/U);w.vec3.cross(m,f,d);this.tangents[e*3+0]=d[0];this.tangents[e*3+1]=d[1];this.tangents[e*3+2]=d[2];this.biTangents[e*3+0]=m[0];this.biTangents[e*3+1]=m[1];this.biTangents[e*3+2]=m[2]}}isIndexed(){if(this._vertices.length==0)return true;return this.verticesIndices.length!=0}unIndex(e=false,t=false){const i=[];const s=[];let r=0;for(let e in this._attributes){const n=this._attributes[e];let i=[];for(let t=0;t<this.verticesIndices.length;t+=3){for(let e=0;e<3;e++){if(n.itemSize==3)i.push(n.data[this.verticesIndices[t+e]*3+0],n.data[this.verticesIndices[t+e]*3+1],n.data[this.verticesIndices[t+e]*3+2]);else if(n.itemSize==4)i.push(n.data[this.verticesIndices[t+e]*4+0],n.data[this.verticesIndices[t+e]*4+1],n.data[this.verticesIndices[t+e]*4+2],n.data[this.verticesIndices[t+e]*4+3]);else if(n.itemSize==2)i.push(n.data[this.verticesIndices[t+e]*2+0],n.data[this.verticesIndices[t+e]*2+1]);else if(n.itemSize==1)i.push(n.data[this.verticesIndices[t+e]]);else this._log.warn("unknown attr",n)}}this.setAttribute(n.name,i,n.itemSize)}for(let e=0;e<this.verticesIndices.length;e+=3){i.push(this.vertices[this.verticesIndices[e+0]*3+0],this.vertices[this.verticesIndices[e+0]*3+1],this.vertices[this.verticesIndices[e+0]*3+2]);s.push(r);r++;i.push(this.vertices[this.verticesIndices[e+1]*3+0],this.vertices[this.verticesIndices[e+1]*3+1],this.vertices[this.verticesIndices[e+1]*3+2]);s.push(r);r++;i.push(this.vertices[this.verticesIndices[e+2]*3+0],this.vertices[this.verticesIndices[e+2]*3+1],this.vertices[this.verticesIndices[e+2]*3+2]);s.push(r);r++}this.vertices=i;this.verticesIndices=[];if(e)this.verticesIndices=s;if(!t)this.calculateNormals()}calcBarycentric(){let t=[];t.length=this.vertices.length;for(let e=0;e<this.vertices.length;e++)t[e]=0;let i=0;for(let e=0;e<this.vertices.length;e+=3){t[e+i]=1;i++;if(i==3)i=0}this.setAttribute("attrBarycentric",t,3)}getBounds(){return new E(this)}center(e,t,i){if(e===undefined){e=true;t=true;i=true}let s=0;const r=this.getBounds();const n=[r.minX+(r.maxX-r.minX)/2,r.minY+(r.maxY-r.minY)/2,r.minZ+(r.maxZ-r.minZ)/2];for(s=0;s<this.vertices.length;s+=3){if(this.vertices[s+0]==this.vertices[s+0]){if(e)this.vertices[s+0]-=n[0];if(t)this.vertices[s+1]-=n[1];if(i)this.vertices[s+2]-=n[2]}}return n}mapTexCoords2d(){const t=this.getBounds();const i=this.vertices.length/3;this.texCoords=new Float32Array(i*2);for(let e=0;e<i;e++){const s=this.vertices[e*3+0];const r=this.vertices[e*3+1];this.texCoords[e*2+0]=s/(t.maxX-t.minX)+.5;this.texCoords[e*2+1]=1-r/(t.maxY-t.minY)+.5}}getInfoOneLine(){let e="";if(this.faceVertCount==3&&this.verticesIndices)e+=this.verticesIndices.length/3;else e+=0;e+=" tris ";if(this.vertices)e+=this.vertices.length/3;else e+=0;e+=" verts";return e}getInfo(){const e={};e.name=this.name;e.class=this.constructor.name;if(this.faceVertCount==3&&this.verticesIndices)e.numFaces=this.verticesIndices.length/3;else e.numFaces=0;if(this.verticesIndices&&this.verticesIndices.length)e.indices=this.verticesIndices.length;if(this.vertices)e.numVerts=this.vertices.length/3;else e.numVerts=0;if(this.vertexNormals)e.numNormals=this.vertexNormals.length/3;else e.numNormals=0;if(this.texCoords)e.numTexCoords=this.texCoords.length/2;else e.numTexCoords=0;if(this.tangents)e.numTangents=this.tangents.length/3;else e.numTangents=0;if(this.biTangents)e.numBiTangents=this.biTangents.length/3;else e.numBiTangents=0;if(this.biTangents)e.numBiTangents=this.biTangents.length/3;else e.numBiTangents=0;if(this.vertexColors)e.numVertexColors=this.vertexColors.length/4;else e.numVertexColors=0;if(this.getAttributes())e.numAttribs=Object.keys(this.getAttributes()).length;else e.numAttribs=0;e.isIndexed=this.isIndexed();return e}}b.buildFromFaces=function(t,e,i){const s=[];const r=[];for(let e=0;e<t.length;e+=3){const a=t[e+0];const o=t[e+1];const l=t[e+2];const h=[-1,-1,-1];if(i)for(let e=0;e<s.length;e+=3){if(s[e+0]==a[0]&&s[e+1]==a[1]&&s[e+2]==a[2])h[0]=e/3;if(s[e+0]==o[0]&&s[e+1]==o[1]&&s[e+2]==o[2])h[1]=e/3;if(s[e+0]==l[0]&&s[e+1]==l[1]&&s[e+2]==l[2])h[2]=e/3}if(h[0]==-1){s.push(a[0],a[1],a[2]);h[0]=(s.length-1)/3}if(h[1]==-1){s.push(o[0],o[1],o[2]);h[1]=(s.length-1)/3}if(h[2]==-1){s.push(l[0],l[1],l[2]);h[2]=(s.length-1)/3}r.push(h[0]);r.push(h[1]);r.push(h[2])}const n=new b(e);n.name=e;n.vertices=s;n.verticesIndices=r;return n};const x={};x.getSimpleRect=function(e,t,i=1){const s=new b(t);s.vertices=[1*i,1*i,0,-1*i,1*i,0,1*i,-1*i,0,-1*i,-1*i,0];s.texCoords=[1,1,0,1,1,0,0,0];s.verticesIndices=[0,1,2,2,1,3];s.vertexNormals=[0,0,0,0,0,0,0,0,0,0,0,0];return e.createMesh(s)};x.getSimpleCube=function(e,t){const i=new b(t);i.vertices=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1];i.setTexCoords([0,1,1,1,1,0,0,0,1,1,1,0,0,0,0,1,0,0,0,1,1,1,1,0,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,0,1,1,1,1,0,0,0]);i.verticesIndices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];i.vertexNormals=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0]);i.tangents=new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1]);i.biTangents=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1]);return new v(e,i)};class M{constructor(e,t){this._cgl=e;this._log=new u.Logger("cgl_TextureEffect");if(!e.TextureEffectMesh)this.createMesh();this._textureSource=null;this._options=t;this.name=t.name||"unknown";this.imgCompVer=0;this.aspectRatio=1;this._textureTarget=null;this._frameBuf=this._cgl.gl.createFramebuffer();this._frameBuf2=this._cgl.gl.createFramebuffer();this._renderbuffer=this._cgl.gl.createRenderbuffer();this._renderbuffer2=this._cgl.gl.createRenderbuffer();this.switched=false;this.depth=false}dispose(){if(this._renderbuffer)this._cgl.gl.deleteRenderbuffer(this._renderbuffer);if(this._frameBuf)this._cgl.gl.deleteFramebuffer(this._frameBuf);if(this._renderbuffer2)this._cgl.gl.deleteRenderbuffer(this._renderbuffer2);if(this._frameBuf2)this._cgl.gl.deleteFramebuffer(this._frameBuf2)}getWidth(){return this._textureSource.width}getHeight(){return this._textureSource.height}setSourceTexture(e){if(e===null){this._textureSource=new h(this._cgl);this._textureSource.setSize(16,16)}else{this._textureSource=e}if(!this._textureSource.compareSettings(this._textureTarget)){if(this._textureTarget)this._textureTarget.delete();this._textureTarget=this._textureSource.clone();this._cgl.profileData.profileEffectBuffercreate++;this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._renderbuffer);if(this.depth)this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,this._cgl.gl.DEPTH_COMPONENT16,this._textureSource.width,this._textureSource.height);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.TEXTURE_2D,this._textureTarget.tex,0);if(this.depth)this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._renderbuffer);this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf2);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._renderbuffer2);if(this.depth)this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,this._cgl.gl.DEPTH_COMPONENT16,this._textureSource.width,this._textureSource.height);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.TEXTURE_2D,this._textureSource.tex,0);if(this.depth)this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._renderbuffer2);this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null)}this.aspectRatio=this._textureSource.width/this._textureSource.height}continueEffect(){this._cgl.pushDepthTest(false);this._cgl.pushModelMatrix();this._cgl.pushPMatrix();this._cgl.pushViewPort(0,0,this.getCurrentTargetTexture().width,this.getCurrentTargetTexture().height);mat4.perspective(this._cgl.pMatrix,45,this.getCurrentTargetTexture().width/this.getCurrentTargetTexture().height,.1,1100);this._cgl.pushPMatrix();mat4.identity(this._cgl.pMatrix);this._cgl.pushViewMatrix();mat4.identity(this._cgl.vMatrix);this._cgl.pushModelMatrix();mat4.identity(this._cgl.mMatrix)}startEffect(e){if(!this._textureTarget){this._log.warn("effect has no target");return}this.switched=false;this.continueEffect();if(e){this._bgTex=e}this._countEffects=0}endEffect(){this._cgl.popDepthTest();this._cgl.popModelMatrix();this._cgl.popPMatrix();this._cgl.popModelMatrix();this._cgl.popViewMatrix();this._cgl.popPMatrix();this._cgl.popViewPort()}bind(){if(this._textureSource===null){this._log.warn("no base texture set!");return}if(!this.switched){this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf);this._cgl.pushGlFrameBuffer(this._frameBuf)}else{this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf2);this._cgl.pushGlFrameBuffer(this._frameBuf2)}}finish(){if(this._textureSource===null){this._log.warn("no base texture set!");return}this._cgl.TextureEffectMesh.render(this._cgl.getShader());this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.popGlFrameBuffer());this._cgl.profileData.profileTextureEffect++;if(this._textureTarget.filter==h.FILTER_MIPMAP){if(!this.switched){this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,this._textureTarget.tex);this._textureTarget.updateMipMap()}else{this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,this._textureSource.tex);this._textureSource.updateMipMap()}this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null)}this.switched=!this.switched;this._countEffects++}getCurrentTargetTexture(){if(this.switched)return this._textureSource;return this._textureTarget}getCurrentSourceTexture(){if(this._countEffects==0&&this._bgTex)return this._bgTex;if(this.switched)return this._textureTarget;return this._textureSource}delete(){if(this._textureTarget)this._textureTarget.delete();if(this._textureSource)this._textureSource.delete();this._cgl.gl.deleteRenderbuffer(this._renderbuffer);this._cgl.gl.deleteFramebuffer(this._frameBuf)}createMesh(){this._cgl.TextureEffectMesh=x.getSimpleRect(this._cgl,"texEffectRect")}}M.checkOpNotInTextureEffect=function(e){if(!e.patch.cgl)return true;if(e.uiAttribs.error&&!e.patch.cgl.currentTextureEffect){e.setUiError("textureeffect",null);return true}if(!e.patch.cgl.currentTextureEffect)return true;if(e.patch.cgl.currentTextureEffect&&!e.uiAttribs.error){e.setUiError("textureeffect","This op can not be a child of a ImageCompose/texture effect! imagecompose should only have textureeffect childs.",0);return false}if(e.patch.cgl.currentTextureEffect)return false;return true};M.checkOpInEffect=function(e,t){t=t||0;if(e.patch.cgl.currentTextureEffect){if(e.uiAttribs.uierrors&&e.patch.cgl.currentTextureEffect.imgCompVer>=t){e.setUiError("texeffect",null);return true}if(t&&e.patch.cgl.currentTextureEffect.imgCompVer<t){e.setUiError("texeffect","This op must be a child of an ImageCompose op with version >="+t+' <span class="button-small" onclick="gui.patchView.downGradeOp(\''+e.id+"','"+e.name+"')\">Downgrade</span> to previous version",1)}}if(e.patch.cgl.currentTextureEffect)return true;if(!e.patch.cgl.currentTextureEffect&&(!e.uiAttribs.uierrors||e.uiAttribs.uierrors.length==0)){e.setUiError("texeffect",'This op must be a child of an ImageCompose op! More infos <a href="https://cables.gl/docs/image_composition/image_composition.html" target="_blank">here</a>. ',1);return false}if(!e.patch.cgl.currentTextureEffect)return false;return true};M.getBlendCode=function(e){let t="".endl()+"vec3 _blend(vec3 base,vec3 blend)".endl()+"{".endl()+"   vec3 colNew=blend;".endl()+"   #ifdef BM_MULTIPLY".endl()+"       colNew=base*blend;".endl()+"   #endif".endl()+"   #ifdef BM_MULTIPLY_INV".endl()+"       colNew=base* vec3(1.0)-blend;".endl()+"   #endif".endl()+"   #ifdef BM_AVERAGE".endl()+"       colNew=((base + blend) / 2.0);".endl()+"   #endif".endl()+"   #ifdef BM_ADD".endl()+"       colNew=min(base + blend, vec3(1.0));".endl()+"   #endif".endl()+"   #ifdef BM_SUBTRACT_ONE".endl()+"       colNew=max(base + blend - vec3(1.0), vec3(0.0));".endl()+"   #endif".endl()+"   #ifdef BM_SUBTRACT".endl()+"       colNew=base - blend;".endl()+"   #endif".endl()+"   #ifdef BM_DIFFERENCE".endl()+"       colNew=abs(base - blend);".endl()+"   #endif".endl()+"   #ifdef BM_NEGATION".endl()+"       colNew=(vec3(1.0) - abs(vec3(1.0) - base - blend));".endl()+"   #endif".endl()+"   #ifdef BM_EXCLUSION".endl()+"       colNew=(base + blend - 2.0 * base * blend);".endl()+"   #endif".endl()+"   #ifdef BM_LIGHTEN".endl()+"       colNew=max(blend, base);".endl()+"   #endif".endl()+"   #ifdef BM_DARKEN".endl()+"       colNew=min(blend, base);".endl()+"   #endif".endl()+"   #ifdef BM_OVERLAY".endl()+"      #define BlendOverlayf(base, blend)  (base < 0.5 ? (2.0 * base * blend) : (1.0 - 2.0 * (1.0 - base) * (1.0 - blend)))".endl()+"      colNew=vec3(BlendOverlayf(base.r, blend.r),BlendOverlayf(base.g, blend.g),BlendOverlayf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_SCREEN".endl()+"      #define BlendScreenf(base, blend)       (1.0 - ((1.0 - base) * (1.0 - blend)))".endl()+"      colNew=vec3(BlendScreenf(base.r, blend.r),BlendScreenf(base.g, blend.g),BlendScreenf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_SOFTLIGHT".endl()+"      #define BlendSoftLightf(base, blend)    ((blend < 0.5) ? (2.0 * base * blend + base * base * (1.0 - 2.0 * blend)) : (sqrt(base) * (2.0 * blend - 1.0) + 2.0 * base * (1.0 - blend)))".endl()+"      colNew=vec3(BlendSoftLightf(base.r, blend.r),BlendSoftLightf(base.g, blend.g),BlendSoftLightf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_HARDLIGHT".endl()+"      #define BlendOverlayf(base, blend)  (base < 0.5 ? (2.0 * base * blend) : (1.0 - 2.0 * (1.0 - base) * (1.0 - blend)))".endl()+"      colNew=vec3(BlendOverlayf(base.r, blend.r),BlendOverlayf(base.g, blend.g),BlendOverlayf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_COLORDODGE".endl()+"      #define BlendColorDodgef(base, blend)   ((blend == 1.0) ? blend : min(base / (1.0 - blend), 1.0))".endl()+"      colNew=vec3(BlendColorDodgef(base.r, blend.r),BlendColorDodgef(base.g, blend.g),BlendColorDodgef(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_COLORBURN".endl()+"      #define BlendColorBurnf(base, blend)    ((blend == 0.0) ? blend : max((1.0 - ((1.0 - base) / blend)), 0.0))".endl()+"      colNew=vec3(BlendColorBurnf(base.r, blend.r),BlendColorBurnf(base.g, blend.g),BlendColorBurnf(base.b, blend.b));".endl()+"   #endif".endl()+"   return colNew;".endl()+"}".endl();if(!e)t+="vec4 cgl_blend(vec4 oldColor,vec4 newColor,float amount)".endl()+"{".endl()+"vec4 col=vec4( _blend(oldColor.rgb,newColor.rgb) ,1.0);".endl()+"col=vec4( mix( col.rgb, oldColor.rgb ,1.0-oldColor.a*amount),1.0);".endl()+"return col;".endl()+"}".endl();if(e>=3)t+="vec4 cgl_blendPixel(vec4 base,vec4 col,float amount)".endl()+"{".endl()+"#ifdef BM_MATH_ADD".endl()+"   return vec4(base.rgb+col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifdef BM_MATH_SUB".endl()+"   return vec4(base.rgb-col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifdef BM_MATH_MUL".endl()+"   return vec4(base.rgb*col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifdef BM_MATH_DIV".endl()+"   return vec4(base.rgb/col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifndef BM_MATH".endl()+"vec3 colNew=_blend(base.rgb,col.rgb);".endl()+"float newA=clamp(base.a+(col.a*amount),0.,1.);".endl()+"#ifdef BM_ALPHAMASKED".endl()+"newA=base.a;".endl()+"#endif".endl()+"return vec4(".endl()+"mix(colNew,base.rgb,1.0-(amount*col.a)),".endl()+"newA);".endl()+"#endif".endl()+"}".endl();return t};M.onChangeBlendSelect=function(e,t,i=false){t=String(t);e.toggleDefine("BM_NORMAL",t=="normal");e.toggleDefine("BM_MULTIPLY",t=="multiply");e.toggleDefine("BM_MULTIPLY_INV",t=="multiply invert");e.toggleDefine("BM_AVERAGE",t=="average");e.toggleDefine("BM_ADD",t=="add");e.toggleDefine("BM_SUBTRACT_ONE",t=="subtract one");e.toggleDefine("BM_SUBTRACT",t=="subtract");e.toggleDefine("BM_DIFFERENCE",t=="difference");e.toggleDefine("BM_NEGATION",t=="negation");e.toggleDefine("BM_EXCLUSION",t=="exclusion");e.toggleDefine("BM_LIGHTEN",t=="lighten");e.toggleDefine("BM_DARKEN",t=="darken");e.toggleDefine("BM_OVERLAY",t=="overlay");e.toggleDefine("BM_SCREEN",t=="screen");e.toggleDefine("BM_SOFTLIGHT",t=="softlight");e.toggleDefine("BM_HARDLIGHT",t=="hardlight");e.toggleDefine("BM_COLORDODGE",t=="color dodge");e.toggleDefine("BM_COLORBURN",t=="color burn");e.toggleDefine("BM_MATH_ADD",t=="Math Add");e.toggleDefine("BM_MATH_SUB",t=="Math Subtract");e.toggleDefine("BM_MATH_MUL",t=="Math Multiply");e.toggleDefine("BM_MATH_DIV",t=="Math Divide");e.toggleDefine("BM_MATH",t.indexOf("Math ")==0);e.toggleDefine("BM_ALPHAMASKED",i)};M.AddBlendSelect=function(e,t,i){const s=e.inValueSelect(t||"Blend Mode",["normal","lighten","darken","multiply","multiply invert","average","add","subtract","difference","negation","exclusion","overlay","screen","color dodge","color burn","softlight","hardlight","subtract one","Math Add","Math Subtract","Math Multiply","Math Divide"],i||"normal");return s};M.AddBlendAlphaMask=function(e,t,i){const s=e.inSwitch(t||"Alpha Mask",["Off","On"],i||"Off");return s};M.setupBlending=function(i,s,r,e,n){const t=()=>{let e=false;if(n)e=n.get()=="On";M.onChangeBlendSelect(s,r.get(),e);let t=r.get();if(t=="normal")t=null;else if(t=="multiply")t="mul";else if(t=="multiply invert")t="mulinv";else if(t=="lighten")t="light";else if(t=="darken")t="darken";else if(t=="average")t="avg";else if(t=="subtract one")t="sub one";else if(t=="subtract")t="sub";else if(t=="difference")t="diff";else if(t=="negation")t="neg";else if(t=="exclusion")t="exc";else if(t=="overlay")t="ovl";else if(t=="color dodge")t="dodge";else if(t=="color burn")t="burn";else if(t=="softlight")t="soft";else if(t=="hardlight")t="hard";else if(t=="Math Add")t="+";else if(t=="Math Subtract")t="-";else if(t=="Math Multiply")t="*";else if(t=="Math Divide")t="/";i.setUiAttrib({extendTitle:t})};i.setPortGroup("Blending",[r,e,n]);let a=false;r.onChange=t;if(n){n.onChange=t;a=n.get()=="On"}M.onChangeBlendSelect(s,r.get(),a)};const I={"CGL.BLENDMODES":function(){this.name="blendmodes";this.srcHeadFrag=M.getBlendCode()},"CGL.BLENDMODES3":function(){this.name="blendmodes3";this.srcHeadFrag=M.getBlendCode(3)},"CGL.LUMINANCE":function(){this.name="luminance";this.srcHeadFrag="".endl()+"float cgl_luminance(vec3 c)".endl()+"{".endl()+"    return dot(vec3(0.2126,0.7152,0.0722),c);".endl()+"}".endl()},"CGL.RANDOM_OLD":function(){this.name="randomNumber";this.srcHeadFrag="".endl()+"float cgl_random(vec2 co)".endl()+"{".endl()+"    return fract(sin(dot(co.xy ,vec2(12.9898,4.1414))) * 432758.5453);".endl()+"}".endl()+"vec3 cgl_random3(vec2 co)".endl()+"{".endl()+"    return vec3( cgl_random(co),cgl_random(co+0.5711),cgl_random(co+1.5711));".endl()+"}"},"CGL.RANDOM_LOW":function(){this.name="randomNumber";this.srcHeadFrag="".endl()+"float cgl_random(vec2 co)".endl()+"{".endl()+"    return fract(sin(dot(co.xy ,vec2(12.9898,4.1414))) * 358.5453);".endl()+"}".endl()+"vec3 cgl_random3(vec2 co)".endl()+"{".endl()+"    return vec3( cgl_random(co),cgl_random(co+0.5711),cgl_random(co+1.5711));".endl()+"}"},"CGL.RANDOM_TEX":function(){this.name="randomNumbertex";this.srcHeadFrag="".endl()+"UNI sampler2D CGLRNDTEX;".endl()+"float cgl_random(vec2 co)".endl()+"{".endl()+"    return texture(CGLRNDTEX,co*5711.0).r;".endl()+"}".endl()+"vec3 cgl_random3(vec2 co)".endl()+"{".endl()+"    return texture(CGLRNDTEX,co*5711.0).rgb;".endl()+"}";this.initUniforms=function(e){return[new c(e,"t","CGLRNDTEX",7)]};this.onBind=function(e,t){h.getRandomTexture(e);e.setTexture(7,h.getRandomTexture(e).tex)}}};class y{constructor(e){this.shader=new CGL.Shader(e,"markermaterial");const t="".endl()+"void main()".endl()+"{".endl()+"    outColor = vec4(color.rgb,1.0);".endl()+"}";const i="".endl()+"IN vec3 vPosition;".endl()+"UNI mat4 projMatrix;".endl()+"UNI mat4 mvMatrix;".endl()+"void main()".endl()+"{".endl()+"   gl_Position = projMatrix * mvMatrix * vec4(vPosition,1.0);".endl()+"}";this.shader.setSource(i,t);this.coloruni=this.shader.addUniformFrag("4f","color",[1,.777,1,1])}setColor(e,t,i,s){this.coloruni.set(e,t,i,s)}}class U extends u.Events{id=T.utils.simpleId();_isValid=true;_defines=[];_moduleNames=[];_moduleNumId=0;_needsRecompile=true;_compileReason="initial";_modules=[];_compileCount=0;logError=true;num=-1;lastCompile=0;constructor(){super()}setWhyCompile(e){this._compileReason=e;this._needsRecompile=true}getWhyCompile(){return this._compileReason}needsRecompile(){return this._needsRecompile}removeUniform(t){for(let e=0;e<this._uniforms.length;e++){if(this._uniforms[e].getName()==t){this._uniforms.splice(e,1)}}this.setWhyCompile("remove uniform "+t)}hasUniformInStage(t,e){let i=this.defaultUniBindingFrag;if(e==GPUShaderStage.VERTEX)i=this.defaultUniBindingVert;if(e==GPUShaderStage.COMPUTE)i=this.defaultUniBindingCompute;for(let e=0;e<this._uniforms.length;e++){console.log("hasuniiiiiiiiiiiiiii",this._uniforms[e].getName(),t);if(this._uniforms[e].getName()==t)return true}return false}hasUniform(e){}toggleDefine(t,e){if(e&&typeof e=="object"&&e.addEventListener){if(e.changeListener)e.off(e.changeListener);e.onToggleDefine=e=>{this.toggleDefine(t,e)};e.changeListener=e.on("change",e.onToggleDefine);e=e.get()}if(e)this.define(t);else this.removeDefine(t)}define(t,i=""){if(i===null||i===undefined)i="";if(typeof i=="object"){i.removeEventListener("change",i.onDefineChange);i.onDefineChange=e=>{this.define(t,e)};i.on("change",i.onDefineChange);i=i.get()}for(let e=0;e<this._defines.length;e++){if(this._defines[e][0]==t&&this._defines[e][1]==i)return;if(this._defines[e][0]==t){this._defines[e][1]=i;this.setWhyCompile("define "+t+" "+i);return}}this.setWhyCompile("define "+t+" "+i);this._defines.push([t,i])}getDefines(){return this._defines}getDefine(t){for(let e=0;e<this._defines.length;e++)if(this._defines[e][0]==t)return this._defines[e][1];return null}hasDefine(t){for(let e=0;e<this._defines.length;e++)if(this._defines[e][0]==t)return true}removeDefine(t){for(let e=0;e<this._defines.length;e++){if(this._defines[e][0]==t){this._defines.splice(e,1);this.setWhyCompile("define removed:"+t);return}}}hasModule(t){for(let e=0;e<this._modules.length;e++)if(this._modules[e].id==t)return true;return false}setModules(e){this._moduleNames=e}removeModule(i){for(let e=0;e<this._modules.length;e++){if(i&&i.id){if(this._modules[e].id==i.id||!this._modules[e]){let t=true;while(t){t=false;for(let e=0;e<this._uniforms.length;e++){if(this._uniforms[e].getName().startsWith(i.prefix)){this._uniforms.splice(e,1);t=true;continue}}}this.setWhyCompile("remove module "+i.title);this._modules.splice(e,1);break}}}}getNumModules(){return this._modules.length}getCurrentModules(){return this._modules}addModule(e,t){if(this.hasModule(e.id))return;if(!e.id)e.id=T.utils.simpleId();if(!e.numId)e.numId=this._moduleNumId;if(!e.num)e.num=this._modules.length;if(t&&!t.group)t.group=T.utils.simpleId();if(!e.group)if(t)e.group=t.group;else e.group=T.utils.simpleId();e.prefix="mod"+e.group+"_";this._modules.push(e);this.setWhyCompile("add module "+e.title);this._moduleNumId++;return e}isValid(){return this._isValid}}const B=`
{{MODULES_HEAD}}
IN vec3 vPosition; //!@
IN vec2 attrTexCoord;
IN vec3 attrVertNormal;
IN vec3 attrTangent,attrBiTangent;

IN float attrVertIndex;

OUT vec2 texCoord;
OUT vec3 norm;
UNI mat4 projMatrix;
UNI mat4 viewMatrix;
UNI mat4 modelMatrix;

void main()
{
    texCoord=attrTexCoord;
    norm=attrVertNormal;
    vec4 pos=vec4(vPosition,  1.0);
    vec3 tangent=attrTangent;
    vec3 bitangent=attrBiTangent;
    mat4 mMatrix=modelMatrix;
    gl_PointSize=10.0;

    {{MODULE_VERTEX_POSITION}}

    mat4 modelViewMatrix=viewMatrix*mMatrix;
    {{MODULE_VERTEX_MODELVIEW}}

    gl_Position = projMatrix * modelViewMatrix * pos;
}
`;let V=0;function O(){return B}function R(e,t,i){if(e==undefined){e=.5;t=.5;i=.5}return""+A+"IN vec2 texCoord;"+A+"{{MODULES_HEAD}}"+A+"void main()"+A+"{"+A+"    vec4 col=vec4("+e+","+t+","+i+",1.0);"+A+"    {{MODULE_COLOR}}"+A+"    outColor = col;"+A+"}"}class C extends U{_uniforms=[];constructor(e,t,i){super();if(!e)throw new Error("shader constructed without cgl "+t);this._log=new u.Logger("cgl_shader");this._cgl=e;if(!t)this._log.stack("no shader name given");this._name=t||"unknown";if(i)this.opId=i.id;this.glslVersion=0;if(e.glVersion>1)this.glslVersion=300;this._materialId=++V;this._program=null;this._drawBuffers=[true];this.error=null;this.ignoreMissingUniforms=false;this._projMatrixUniform=null;this._mvMatrixUniform=null;this._mMatrixUniform=null;this._vMatrixUniform=null;this._camPosUniform=null;this._normalMatrixUniform=null;this._inverseViewMatrixUniform=null;this._fromUserInteraction=false;this._attrVertexPos=-1;this.precision=e.patch.config.glslPrecision||"highp";this._pMatrixState=-1;this._vMatrixState=-1;this._countMissingUniforms=0;this._modGroupCount=0;this._feedBackNames=[];this._attributes=[];this.glPrimitive=null;this.offScreenPass=false;this._extensions=[];this.srcVert=O();this.srcFrag=R();this.lastCompile=0;this._libs=[];this._structNames=[];this._structUniformNames=[];this._textureStackUni=[];this._textureStackTex=[];this._textureStackType=[];this._textureStackTexCgl=[];this._tempNormalMatrix=w.mat4.create();this._tempCamPosMatrix=w.mat4.create();this._tempInverseViewMatrix=w.mat4.create();this._tempInverseProjMatrix=w.mat4.create();this.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_NORMAL","MODULE_BEGIN_FRAG","MODULE_VERTEX_MODELVIEW"])}isValid(){return this._isValid}getCgl(){return this._cgl}getName(){return this._name}enableExtension(e){this.setWhyCompile("enable extension "+e);this._extensions.push(e)}getAttrVertexPos(){return this._attrVertexPos}hasTextureUniforms(){for(let e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getType()=="t")return true;return false}copyUniformValues(t){for(let e=0;e<t._uniforms.length;e++){if(!this._uniforms[e]){this._log.log("unknown uniform?!");continue}this.getUniform(t._uniforms[e].getName()).set(t._uniforms[e].getValue())}this.popTextures();for(let e=0;e<t._textureStackUni.length;e++){this._textureStackUni[e]=t._textureStackUni[e];this._textureStackTex[e]=t._textureStackTex[e];this._textureStackType[e]=t._textureStackType[e];this._textureStackTexCgl[e]=t._textureStackTexCgl[e]}}copy(){const t=new C(this._cgl,this._name+" copy");t.setSource(this.srcVert,this.srcFrag);t._modules=JSON.parse(JSON.stringify(this._modules));t._defines=JSON.parse(JSON.stringify(this._defines));t._modGroupCount=this._modGroupCount;t._moduleNames=this._moduleNames;t.glPrimitive=this.glPrimitive;t.offScreenPass=this.offScreenPass;t._extensions=this._extensions;t.wireframe=this.wireframe;t._attributes=this._attributes;for(let e=0;e<this._uniforms.length;e++){const i=this._uniforms[e].copy(t);i.resetLoc()}t.setWhyCompile("copy");return t}setSource(e,t,i=false){this._fromUserInteraction=i;this.srcVert=e;this.srcFrag=t;this.setWhyCompile("Source changed");this._isValid=true}_addLibs(e){for(const t in I){if(e.includes(t)){const i=new I[t];e=e.replace("{{"+t+"}}",i.srcHeadFrag);this._libs.push(i);if(i.initUniforms)i.initUniforms(this)}}return e}createStructUniforms(){let s="";let r="";this._structNames=[];this._injectedStringsFrag={};this._injectedStringsVert={};this._structUniformNamesIndicesFrag=[];this._structUniformNamesIndicesVert=[];for(let i=0;i<this._uniforms.length;i++){if(this._uniforms[i].isStructMember()){const n="{{INJECTION_POINT_STRUCT_"+this._uniforms[i]._structName+"}}";if(!this._structNames.includes(this._uniforms[i]._structName)){const a="struct "+this._uniforms[i]._structName+" {"+A+n+"};"+A+A;if(this._uniforms[i].getShaderType()==="both"||this._uniforms[i].getShaderType()==="frag")s=s.concat(a);if(this._uniforms[i].getShaderType()==="both"||this._uniforms[i].getShaderType()==="vert")r=r.concat(a);this._structNames.push(this._uniforms[i]._structName);this._injectedStringsFrag[this._uniforms[i]._structName]=[];this._injectedStringsVert[this._uniforms[i]._structName]=[]}let e="";if(this._uniforms[i].comment)e=" // "+this._uniforms[i].comment;let t="";if(this._uniforms[i].getGlslTypeString()==undefined)t+="//";t+="  "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i]._propertyName+";"+e;if(this._uniforms[i].getShaderType()==="both"){if(!this._injectedStringsFrag[this._uniforms[i]._structName].includes(t)&&!this._injectedStringsVert[this._uniforms[i]._structName].includes(t)){const o=s.lastIndexOf(n);const l=r.lastIndexOf(n);s=s.slice(0,o)+t+s.slice(o-1);r=r.slice(0,l)+t+r.slice(l-1);this._injectedStringsFrag[this._uniforms[i]._structName].push(t);this._injectedStringsVert[this._uniforms[i]._structName].push(t)}if(!this._structUniformNamesIndicesFrag.includes(i))this._structUniformNamesIndicesFrag.push(i);if(!this._structUniformNamesIndicesVert.includes(i))this._structUniformNamesIndicesVert.push(i)}else if(this._uniforms[i].getShaderType()==="frag"){if(!this._injectedStringsFrag[this._uniforms[i]._structName].includes(t)){const o=s.lastIndexOf(n);s=s.slice(0,o)+t+s.slice(o-1);this._injectedStringsFrag[this._uniforms[i]._structName].push(t)}if(!this._structUniformNamesIndicesFrag.includes(i))this._structUniformNamesIndicesFrag.push(i)}else if(this._uniforms[i].getShaderType()==="vert"){if(!this._injectedStringsVert[this._uniforms[i]._structName].includes(t)){const l=r.lastIndexOf(n);r=r.slice(0,l)+t+r.slice(l-1);this._injectedStringsVert[this._uniforms[i]._structName].push(t)}if(!this._structUniformNamesIndicesVert.includes(i))this._structUniformNamesIndicesVert.push(i)}}}this._uniDeclarationsFrag=[];this._uniDeclarationsVert=[];for(let e=0;e<this._structUniformNamesIndicesFrag.length;e+=1){const t=this._structUniformNamesIndicesFrag[e];const i="UNI "+this._uniforms[t]._structName+" "+this._uniforms[t]._structUniformName+";"+A;if(!this._uniDeclarationsFrag.includes(i)){const n="{{INJECTION_POINT_STRUCT_"+this._uniforms[t]._structName+"}}";s=s.replace(n,"");s+=i;this._uniDeclarationsFrag.push(i)}}for(let e=0;e<this._structUniformNamesIndicesVert.length;e+=1){const t=this._structUniformNamesIndicesVert[e];const i="UNI "+this._uniforms[t]._structName+" "+this._uniforms[t]._structUniformName+";"+A;if(!this._uniDeclarationsVert.includes(i)){const n="{{INJECTION_POINT_STRUCT_"+this._uniforms[t]._structName+"}}";r=r.replace(n,"");r+=i;this._uniDeclarationsVert.push(i)}}return[r,s]}_getAttrSrc(e,t){const i={};if(e.name&&e.type){i.srcHeadVert="";if(!t)i.srcHeadVert+="#ifndef ATTRIB_"+e.name+A;i.srcHeadVert+="#define ATTRIB_"+e.name+A;i.srcHeadVert+="IN "+e.type+" "+e.name+";"+A;if(!t)i.srcHeadVert+="#endif"+A;if(e.nameFrag){i.srcHeadVert+="";if(!t)i.srcHeadVert+="#ifndef ATTRIB_"+e.nameFrag+A;i.srcHeadVert+="#define ATTRIB_"+e.nameFrag+A;i.srcHeadVert+="OUT "+e.type+" "+e.nameFrag+";"+A;if(!t)i.srcHeadVert+="#endif"+A;i.srcVert=""+A+e.nameFrag+"="+e.name+";";i.srcHeadFrag="";if(!t)i.srcHeadFrag+="#ifndef ATTRIB_"+e.nameFrag+A;i.srcHeadFrag+="#define ATTRIB_"+e.nameFrag+A;i.srcHeadFrag+="IN "+e.type+" "+e.nameFrag+";"+A;if(!t)i.srcHeadFrag+="#endif"+A}}return i}compile(){if(this._cgl.aborted)return;const e=performance.now();this._cgl.profileData.profileShaderCompiles++;this._cgl.profileData.profileShaderCompileName=this._name+" ["+this._compileReason+"]";let t="";if(this._extensions)for(let e=0;e<this._extensions.length;e++)t+="#extension "+this._extensions[e]+" : enable"+A;let i="";if(this._defines.length)i="\n// cgl generated"+A;for(let e=0;e<this._defines.length;e++)i+="#define "+this._defines[e][0]+" "+this._defines[e][1]+""+A;const s=this.createStructUniforms();this._cgl.profileData.addHeavyEvent("shader compile",this._name+" ["+this._compileReason+"]");this._compileReason="";if(this._uniforms){const p=this._uniforms.map(e=>{return e._name});const _=[];for(let e=0;e<this._uniforms.length;e++){const v=this._uniforms[e];const E=p.indexOf(v._name,e+1);if(E>-1)_.push(e)}for(let e=this._uniforms.length-1;e>=0;e-=1){if(_.includes(e))this._uniforms.splice(e,1);else this._uniforms[e].resetLoc()}}this._cgl.printError("uniform resets");this._compileCount++;if(this.hasTextureUniforms())i+="#define HAS_TEXTURES"+A;let r="";let n="";if(!this.srcFrag){this._log.warn("[cgl shader] has no fragment source!",this._name,this);this.srcVert=O();this.srcFrag=R()}r="#version 300 es"+A+"// "+A+"// vertex shader "+this._name+A+"// "+A+"precision "+this.precision+" float;"+A+"precision "+this.precision+" sampler2D;"+A+""+A+"#define WEBGL2"+A+"#define texture2D texture"+A+"#define UNI uniform"+A+"#define IN in"+A+"#define OUT out"+A;n="#version 300 es"+A+"// "+A+"// fragment shader "+this._name+A+"// "+A+"precision "+this.precision+" float;"+A+"precision "+this.precision+" sampler2D;"+A+""+A+"#define WEBGL2"+A+"#define texture2D texture"+A+"#define IN in"+A+"#define OUT out"+A+"#define UNI uniform"+A+"{{DRAWBUFFER}}"+A;let a="\n// cgl generated"+A;let o="\n// cgl generated"+A;n+="\n// active mods: --------------- ";r+="\n// active mods: --------------- ";let l=false;let h=false;for(let t=0;t<this._moduleNames.length;t++){for(let e=0;e<this._modules.length;e++){if(this._modules[e].name==this._moduleNames[t]){if(this._modules[e].srcBodyFrag||this._modules[e].srcHeadFrag){l=true;n+="\n// "+t+"."+e+". "+this._modules[e].title+" ("+this._modules[e].name+")"}if(this._modules[e].srcBodyVert||this._modules[e].srcHeadVert){r+="\n// "+t+"."+e+". "+this._modules[e].title+" ("+this._modules[e].name+")";h=true}}}}if(!h)n+="\n// no mods used...";if(!l)n+="\n// no mods used...";n+="\n";r+="\n";for(let i=0;i<this._uniforms.length;i++){if(this._uniforms[i].shaderType&&!this._uniforms[i].isStructMember()){let e="";if(!this._uniforms[i].getGlslTypeString())e+="// ";e+="UNI "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i].getName();let t="";if(this._uniforms[i].comment)t=" // "+this._uniforms[i].comment;if(this._uniforms[i].shaderType=="vert"||this._uniforms[i].shaderType=="both")if(!this.srcVert.includes(e)&&!this.srcVert.includes("uniform "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i].getName()))a+=e+";"+t+A;if(this._uniforms[i].shaderType=="frag"||this._uniforms[i].shaderType=="both")if(!this.srcFrag.includes(e)&&!this.srcFrag.includes("uniform "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i].getName()))o+=e+";"+t+A}}let u=0;let c=0;for(let e=0;e<this._uniforms.length;e++){if(this._uniforms[e].shaderType&&!this._uniforms[e].isStructMember()){if(this._uniforms[e].shaderType=="vert"||this._uniforms[e].shaderType=="both")c++;if(this._uniforms[e].shaderType=="frag"||this._uniforms[e].shaderType=="both")u++}}if(u>=this._cgl.maxUniformsFrag)this._log.warn("[cgl_shader] num uniforms frag: "+u+" / "+this._cgl.maxUniformsFrag);if(c>=this._cgl.maxUniformsVert)this._log.warn("[cgl_shader] num uniforms vert: "+c+" / "+this._cgl.maxUniformsVert);if(!n.includes("precision"))n="precision "+this.precision+" float;"+A+n;if(!r.includes("precision"))r="precision "+this.precision+" float;"+A+r;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){n+="#define MOBILE"+A;r+="#define MOBILE"+A}r=t+r+i+s[0]+a+"\n// -- \n"+this.srcVert;n=t+n+i+s[1]+o+"\n// -- \n"+this.srcFrag;let f="";let g="";this._modules.sort(function(e,t){return e.priority||0-t.priority||0});let d=false;for(let s=0;s<this._moduleNames.length;s++){let t="";let i="";if(!d){d=true;for(let e=0;e<this._attributes.length;e++){const b=this._getAttrSrc(this._attributes[e],true);if(b.srcHeadVert)f+=b.srcHeadVert;if(b.srcVert)t+=b.srcVert;if(b.srcHeadFrag)g+=b.srcHeadFrag}}for(let e=0;e<this._modules.length;e++){const x=this._modules[e];if(x.name==this._moduleNames[s]){f+="\n//---- MOD: group:"+x.group+": idx:"+e+" - prfx:"+x.prefix+" - "+x.title+" ------\n";g+="\n//---- MOD: group:"+x.group+": idx:"+e+" - prfx:"+x.prefix+" - "+x.title+" ------\n";t+="\n\n//---- MOD: "+x.title+" / "+x.priority+" ------\n";i+="\n\n//---- MOD: "+x.title+" / "+x.priority+" ------\n";if(x.attributes)for(let e=0;e<x.attributes.length;e++){const b=this._getAttrSrc(x.attributes[e],false);if(b.srcHeadVert)f+=b.srcHeadVert;if(b.srcVert)t+=b.srcVert;if(b.srcHeadFrag)g+=b.srcHeadFrag}f+=x.srcHeadVert||"";g+=x.srcHeadFrag||"";t+=x.srcBodyVert||"";i+=x.srcBodyFrag||"";f+="\n//---- end mod ------\n";g+="\n//---- end mod ------\n";t+="\n//---- end mod ------\n";i+="\n//---- end mod ------\n";t=t.replace(/{{mod}}/g,x.prefix);i=i.replace(/{{mod}}/g,x.prefix);f=f.replace(/{{mod}}/g,x.prefix);g=g.replace(/{{mod}}/g,x.prefix);t=t.replace(/MOD_/g,x.prefix);i=i.replace(/MOD_/g,x.prefix);f=f.replace(/MOD_/g,x.prefix);g=g.replace(/MOD_/g,x.prefix)}}r=r.replace("{{"+this._moduleNames[s]+"}}",t);n=n.replace("{{"+this._moduleNames[s]+"}}",i)}r=r.replace("{{MODULES_HEAD}}",f);n=n.replace("{{MODULES_HEAD}}",g);r=this._addLibs(r);n=this._addLibs(n);let m="";for(let e=0;e<16;e++)if(n.includes("outColor"+e))this._drawBuffers[e]=true;if(this._drawBuffers.length==1){m="out vec4 outColor;"+A;m+="#define gl_FragColor outColor"+A}else{m+="#define MULTI_COLORTARGETS"+A;m+="vec4 outColor;"+A;let t=0;for(let e=0;e<this._drawBuffers.length;e++){if(t==0)m+="#define gl_FragColor outColor"+e+""+A;m+="layout(location = "+e+") out vec4 outColor"+e+";"+A;t++}}n=n.replace("{{DRAWBUFFER}}",m);if(!this._program){this._program=this._createProgram(r,n)}else{this._program=this._createProgram(r,n);this._projMatrixUniform=null;for(let e=0;e<this._uniforms.length;e++)this._uniforms[e].resetLoc()}this.finalShaderFrag=n;this.finalShaderVert=r;S.lastMesh=null;S.lastShader=null;this._countMissingUniforms=0;this._needsRecompile=false;this.lastCompile=(0,T.now)();this._cgl.profileData.shaderCompileTime+=performance.now()-e}bind(){if(!this._isValid||this._cgl.aborted)return;S.lastShader=this;if(!this._program||this.needsRecompile())this.compile();if(!this._isValid)return;if(!this._projMatrixUniform&&!this.ignoreMissingUniforms){this._countMissingUniforms++;if(this._countMissingUniforms<10){this._projMatrixUniform=this._cgl.gl.getUniformLocation(this._program,p.SHADER.SHADERVAR_UNI_PROJMAT);this._attrVertexPos=this._cgl.glGetAttribLocation(this._program,p.SHADER.SHADERVAR_VERTEX_POSITION);this._mvMatrixUniform=this._cgl.gl.getUniformLocation(this._program,"mvMatrix");this._vMatrixUniform=this._cgl.gl.getUniformLocation(this._program,p.SHADER.SHADERVAR_UNI_VIEWMAT);this._mMatrixUniform=this._cgl.gl.getUniformLocation(this._program,p.SHADER.SHADERVAR_UNI_MODELMAT);this._camPosUniform=this._cgl.gl.getUniformLocation(this._program,p.SHADER.SHADERVAR_UNI_VIEWPOS);this._normalMatrixUniform=this._cgl.gl.getUniformLocation(this._program,p.SHADER.SHADERVAR_UNI_NORMALMAT);this._inverseViewMatrixUniform=this._cgl.gl.getUniformLocation(this._program,p.SHADER.SHADERVAR_UNI_INVVIEWMAT);this._inverseProjMatrixUniform=this._cgl.gl.getUniformLocation(this._program,p.SHADER.SHADERVAR_UNI_INVPROJMAT);this._materialIdUniform=this._cgl.gl.getUniformLocation(this._program,p.SHADER.SHADERVAR_UNI_MATERIALID);this._objectIdUniform=this._cgl.gl.getUniformLocation(this._program,p.SHADER.SHADERVAR_UNI_OBJECTID);for(let e=0;e<this._uniforms.length;e++)this._uniforms[e].needsUpdate=true}}if(this._cgl.currentProgram!=this._program){this._cgl.profileData.profileShaderBinds++;this._cgl.gl.useProgram(this._program);this._cgl.currentProgram=this._program}for(let e=0;e<this._uniforms.length;e++)if(this._uniforms[e].needsUpdate)this._uniforms[e].updateValue();if(this._pMatrixState!=this._cgl.getProjectionMatrixStateCount()){this._pMatrixState=this._cgl.getProjectionMatrixStateCount();this._cgl.gl.uniformMatrix4fv(this._projMatrixUniform,false,this._cgl.pMatrix);this._cgl.profileData.profileMVPMatrixCount++}if(this._objectIdUniform)this._cgl.gl.uniform1f(this._objectIdUniform,++this._cgl.tempData.objectIdCounter);if(this._materialIdUniform)this._cgl.gl.uniform1f(this._materialIdUniform,this._materialId);if(this._vMatrixUniform){if(this._vMatrixState!=this._cgl.getViewMatrixStateCount()){this._cgl.gl.uniformMatrix4fv(this._vMatrixUniform,false,this._cgl.vMatrix);this._cgl.profileData.profileMVPMatrixCount++;this._vMatrixState=this._cgl.getViewMatrixStateCount();if(this._inverseViewMatrixUniform){w.mat4.invert(this._tempInverseViewMatrix,this._cgl.vMatrix);this._cgl.gl.uniformMatrix4fv(this._inverseViewMatrixUniform,false,this._tempInverseViewMatrix);this._cgl.profileData.profileMVPMatrixCount++}if(this._inverseProjMatrixUniform){w.mat4.invert(this._tempInverseProjMatrix,this._cgl.pMatrix);this._cgl.gl.uniformMatrix4fv(this._inverseProjMatrixUniform,false,this._tempInverseProjMatrix);this._cgl.profileData.profileMVPMatrixCount++}}this._cgl.gl.uniformMatrix4fv(this._mMatrixUniform,false,this._cgl.mMatrix);this._cgl.profileData.profileMVPMatrixCount++;if(this._camPosUniform){w.mat4.invert(this._tempCamPosMatrix,this._cgl.vMatrix);this._cgl.gl.uniform3f(this._camPosUniform,this._tempCamPosMatrix[12],this._tempCamPosMatrix[13],this._tempCamPosMatrix[14]);this._cgl.profileData.profileMVPMatrixCount++}}else{const e=w.mat4.create();w.mat4.mul(e,this._cgl.vMatrix,this._cgl.mMatrix);this._cgl.gl.uniformMatrix4fv(this._mvMatrixUniform,false,e);this._cgl.profileData.profileMVPMatrixCount++}if(this._normalMatrixUniform){w.mat4.invert(this._tempNormalMatrix,this._cgl.mMatrix);w.mat4.transpose(this._tempNormalMatrix,this._tempNormalMatrix);this._cgl.gl.uniformMatrix4fv(this._normalMatrixUniform,false,this._tempNormalMatrix);this._cgl.profileData.profileMVPMatrixCount++}for(let e=0;e<this._libs.length;e++){if(this._libs[e].onBind)this._libs[e].onBind.bind(this._libs[e])(this._cgl,this)}this._bindTextures();return this._isValid}unBind(){}dispose(){if(this._program&&this._cgl&&this._cgl.gl)this._cgl.gl.deleteProgram(this._program);this._program=null}setDrawBuffers(e){this._log.warn("useless drawbuffers...?!")}getUniforms(){return this._uniforms}getUniform(t){for(let e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()==t)return this._uniforms[e];return null}removeAllUniforms(){this._uniforms=[]}_addUniform(e){this._uniforms.push(e);this.setWhyCompile("add uniform "+name)}addUniformFrag(e,t,i,s,r,n){const a=new c(this,e,t,i,s,r,n);a.shaderType="frag";return a}addUniformVert(e,t,i,s,r,n){const a=new c(this,e,t,i,s,r,n);a.shaderType="vert";return a}addUniformBoth(e,t,i,s,r,n){const a=new c(this,e,t,i,s,r,n);a.shaderType="both";return a}addUniformStructFrag(t,i,s){const r={};if(!s)return r;for(let e=0;e<s.length;e+=1){const n=s[e];if(!this.hasUniform(i+"."+n.name)){const a=new c(this,n.type,i+"."+n.name,n.v1,n.v2,n.v3,n.v4,i,t,n.name);a.shaderType="frag";r[i+"."+n.name]=a}}return r}addUniformStructVert(t,i,s){const r={};if(!s)return r;for(let e=0;e<s.length;e+=1){const n=s[e];if(!this.hasUniform(i+"."+n.name)){const a=new c(this,n.type,i+"."+n.name,n.v1,n.v2,n.v3,n.v4,i,t,n.name);a.shaderType="vert";r[i+"."+n.name]=a}}return r}addUniformStructBoth(t,i,s){const r={};if(!s)return r;for(let e=0;e<s.length;e+=1){const n=s[e];if(n.type==="2i"||n.type==="i"||n.type==="3i")this._log.error("Adding an integer struct member to both shaders can potentially error. Please use different structs for each shader. Error occured in struct:",t," with member:",n.name," of type:",n.type,".");if(!this.hasUniform(i+"."+n.name)){const a=new c(this,n.type,i+"."+n.name,n.v1,n.v2,n.v3,n.v4,i,t,n.name);a.shaderType="both";r[i+"."+n.name]=a}}return r}_createProgram(e,t){this._cgl.printError("before _createprogram");const i=this._cgl.gl.createProgram();this.vshader=C.createShader(this._cgl,e,this._cgl.gl.VERTEX_SHADER,this);this.fshader=C.createShader(this._cgl,t,this._cgl.gl.FRAGMENT_SHADER,this);if(this.vshader&&this.fshader){this._cgl.gl.attachShader(i,this.vshader);this._cgl.gl.attachShader(i,this.fshader);this._linkProgram(i,e,t)}else{this._isValid=false;this._cgl.printError("shader _createProgram");this._log.error("could not link shaderprogram");return null}this._cgl.printError("shader _createProgram");return i}hasErrors(){return this._hasErrors}_linkProgram(e,t,i){this._cgl.printError("before _linkprogram");if(this._feedBackNames.length>0){this._cgl.gl.transformFeedbackVaryings(e,this._feedBackNames,this._cgl.gl.SEPARATE_ATTRIBS)}this._cgl.gl.linkProgram(e);this._cgl.printError("gl.linkprogram");this._isValid=true;this._hasErrors=false;if(this._cgl.patch.config.glValidateShader!==false){this._cgl.gl.validateProgram(e);if(!this._cgl.gl.getProgramParameter(e,this._cgl.gl.VALIDATE_STATUS)){this._log.log("shaderprogram validation failed...");this._cgl.gl.getProgramInfoLog(e)}if(!this._cgl.gl.getProgramParameter(e,this._cgl.gl.LINK_STATUS)){this._hasErrors=true;const s=this._cgl.gl.getShaderInfoLog(this.fshader);const r=this._cgl.gl.getShaderInfoLog(this.vshader);if(this.logError)this._log.error(this._name+" shader linking fail...");else this._log.warn(this._name+" shader linking fail...");if(s)this._log.warn(this._cgl.gl.getShaderInfoLog(this.fshader));if(r)this._log.warn(this._cgl.gl.getShaderInfoLog(this.vshader));this._cgl.gl.getProgramInfoLog(e);if(!CABLES.UI)this._log.log(this);this._isValid=false;this._cgl.printError("shader link err")}}}getProgram(){return this._program}setFeedbackNames(e){this.setWhyCompile("setFeedbackNames");this._feedBackNames=e}addAttribute(t){for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].name==t.name&&this._attributes[e].nameFrag==t.nameFrag)return}this._attributes.push(t);this.setWhyCompile("addAttribute")}bindTextures(){this._bindTextures()}_bindTextures(){if(this._textureStackTex.length>this._cgl.maxTextureUnits){this._log.warn("[shader._bindTextures] too many textures bound",this._textureStackTex.length+"/"+this._cgl.maxTextureUnits)}for(let i=0;i<this._textureStackTex.length;i++){if(!this._textureStackTex[i]&&!this._textureStackTexCgl[i]){this._log.warn("no texture for pushtexture",this._name)}else{let e=this._textureStackTex[i];if(this._textureStackTexCgl[i]){e=this._textureStackTexCgl[i].tex||CGL.Texture.getEmptyTexture(this._cgl).tex}let t=true;if(!this._textureStackUni[i]){this._log.warn("no uniform for pushtexture",this._name);t=this._cgl.setTexture(i,e,this._textureStackType[i])}else{this._textureStackUni[i].setValue(i);t=this._cgl.setTexture(i,e,this._textureStackType[i])}if(!t)this._log.warn("tex bind failed",this.getName(),this._textureStackUni[i])}}}setUniformTexture(t,i){i=i||h.getTempTexture(this._cgl);for(let e=0;e<this._textureStackUni.length;e++)if(this._textureStackUni[e]==t){const s=this._textureStackTex[e]||this._textureStackTexCgl[e];if(i.hasOwnProperty("tex")){this._textureStackTexCgl[e]=i;this._textureStackTex[e]=null}else{this._textureStackTexCgl[e]=null;this._textureStackTex[e]=i}return s}return null}pushTexture(e,t,i){if(!e){return}if(!t){return}if(!t.hasOwnProperty("tex")&&!(t instanceof WebGLTexture)){this._log.warn(new Error("invalid texture").stack);this._log.warn("[cgl_shader] invalid texture...",t);return}this._textureStackUni.push(e);if(t.hasOwnProperty("tex")){this._textureStackTexCgl.push(t);this._textureStackTex.push(null)}else{this._textureStackTexCgl.push(null);this._textureStackTex.push(t)}this._textureStackType.push(i)}popTexture(){this._textureStackUni.pop();this._textureStackTex.pop();this._textureStackTexCgl.pop();this._textureStackType.pop()}popTextures(){this._textureStackTex.length=this._textureStackTexCgl.length=this._textureStackType.length=this._textureStackUni.length=0}getMaterialId(){return this._materialId}getInfo(){const e={};e.name=this._name;e.defines=this.getDefines();e.hasErrors=this.hasErrors();return e}getDefaultFragmentShader(e,t,i,s){return R(e,t,i,s)}getDefaultVertexShader(){return O()}}C.getDefaultVertexShader=O;C.getDefaultFragmentShader=R;C.getErrorFragmentShader=function(){return""+A+"void main()"+A+"{"+A+"   float g=mod((gl_FragCoord.y+gl_FragCoord.x),50.0)/50.0;"+A+"   g= step(0.1,g);"+A+"   outColor = vec4( g+0.5, 0.0, 0.0, 1.0);"+A+"}"};C.createShader=function(e,t,i,s){if(e.aborted)return;const r=e.gl.createShader(i);e.gl.shaderSource(r,t);e.gl.compileShader(r);if(!e.gl.getShaderParameter(r,e.gl.COMPILE_STATUS)){s.error={str:t,infoLog:e.gl.getShaderInfoLog(r)};if(CABLES.UI)gui.emitEvent("ShaderError",s);if(!s.error.infoLog){s._log.warn("empty shader info log",this._name);return}s.setSource(C.getDefaultVertexShader(),C.getErrorFragmentShader())}return r};const k=Math.PI/180;const G=180/Math.PI;const j=null;const H=window.navigator.userAgent.includes("Windows");const P=function(t){let i;if(t.wheelDelta){i=t.wheelDelta%120-0==-0?t.wheelDelta/120:t.wheelDelta/30;i*=-1.5;if(H)i*=2}else{let e=t.deltaY;if(t.shiftKey)e=t.deltaX;const s=e||t.detail;i=-(s%3?s*10:s/3);i*=-3}if(i>20)i=20;if(i<-20)i=-20;return i};const z=P;const X=P;class N{constructor(e){this._cgl=e;this._lastTime=0;this.pause=false;this.profileUniformCount=0;this.profileShaderBinds=0;this.profileUniformCount=0;this.profileShaderCompiles=0;this.profileVideosPlaying=0;this.profileMVPMatrixCount=0;this.profileEffectBuffercreate=0;this.profileShaderGetUniform=0;this.profileFrameBuffercreate=0;this.profileMeshSetGeom=0;this.profileTextureNew=0;this.profileGenMipMap=0;this.profileOnAnimFrameOps=0;this.profileFencedPixelRead=0;this.profileMainloopMs=0;this.profileMeshDraw=0;this.profileTextureEffect=0;this.profileTexPreviews=0;this.shaderCompileTime=0;this.profileMeshNumElements=0;this.profileMeshAttributes=0;this.profileSingleMeshAttribute=[];this.heavyEvents=[];this.doProfileGlQuery=false;this.glQueryData={};this.counts={}}clear(){this.counts={};this.profileSingleMeshAttribute={};this.profileMeshAttributes=0;this.profileUniformCount=0;this.profileShaderGetUniform=0;this.profileShaderCompiles=0;this.profileShaderBinds=0;this.profileTextureResize=0;this.profileFrameBuffercreate=0;this.profileEffectBuffercreate=0;this.profileTextureDelete=0;this.profileMeshSetGeom=0;this.profileVideosPlaying=0;this.profileMVPMatrixCount=0;this.profileNonTypedAttrib=0;this.profileNonTypedAttribNames="";this.profileTextureNew=0;this.profileGenMipMap=0;this.profileFramebuffer=0;this.profileMeshDraw=0;this.profileTextureEffect=0;this.profileTexPreviews=0;this.profileMeshNumElements=0;this.profileFencedPixelRead=0}clearGlQuery(){for(let e in this.glQueryData){if(!this.glQueryData[e].lastClear||performance.now()-this.glQueryData[e].lastClear>1e3){this.glQueryData[e].time=this.glQueryData[e]._times/this.glQueryData[e]._numcount;this.glQueryData[e].num=this.glQueryData[e]._numcount;this.glQueryData[e]._times=0;this.glQueryData[e]._numcount=0;this.glQueryData[e].lastClear=performance.now()}}}count(e,t){this.counts[e]=this.counts[e]||[];this.counts[e].push(t)}addHeavyEvent(e,t,i){const s={event:e,name:t,info:i,date:performance.now()};this.heavyEvents.push(s);this._cgl.emitEvent("heavyEvent",s)}}class F{constructor(){this._arr=[w.mat4.create()];this._index=0;this.stateCounter=0}push(e){this._index++;this.stateCounter++;if(this._index==this._arr.length){const t=w.mat4.create();this._arr.push(t)}w.mat4.copy(this._arr[this._index],e||this._arr[this._index-1]);return this._arr[this._index]}pop(){this.stateCounter++;this._index--;if(this._index<0)this._index=0;return this._arr[this._index]}length(){return this._index}}class Y{hasFocus=false;forceAspect=0;pixelDensity=1;_oldWidthRp=-1;_oldHeightRp=-1;constructor(e){this._log=new u.Logger("CgCanvas");if(!e){this._log.error("CgCanvas no options")}else{this._canvasEle=e.canvasEle}if(!e.cg)this._log.error("CgCanvas options has no cg");this._cg=e.cg;if(this.canvasEle){this.canvasWidth=this.canvasEle.clientWidth;this.canvasHeight=this.canvasEle.clientHeight;this.setSize(this.canvasWidth,this.canvasHeight);this.canvasEle.addEventListener("focus",()=>{this.hasFocus=true});this.canvasEle.addEventListener("blur",()=>{this.hasFocus=false})}}get canvasEle(){return this._canvasEle}setSize(t,i,e=false){let s=0;if(this.forceAspect){let e=t/this.forceAspect;if(e<i)s=(i-e)/2;i=e}if(this._oldWidthRp!=t*this.pixelDensity||this._oldHeightRp!=i*this.pixelDensity){this._oldWidthRp=this.canvasEle.width=t*this.pixelDensity;this._oldHeightRp=this.canvasEle.height=i*this.pixelDensity;if(!e){this.canvasEle.style.width=t+"px";this.canvasEle.style.height=i+"px";this.canvasEle.style.marginTop=s+"px"}this.updateSize();this._cg.emitEvent("resize")}}updateSize(){this.canvasEle.width=this.canvasWidth=Math.ceil(this.canvasEle.clientWidth*this.pixelDensity);this.canvasEle.height=this.canvasHeight=Math.ceil(this.canvasEle.clientHeight*this.pixelDensity)}dispose(){if(this._canvasEle)this._canvasEle.remove();this._canvasEle=null}}class W extends u.Events{#timeStartFrame=0;#timeStartSecond=0;#fpsCounter=0;#msCounter=0;#frameCount=0;logFps=false;constructor(){super();this.stats={ms:0,fps:0}}get frameCount(){return this.#frameCount}startFrame(){this.#timeStartFrame=(0,T.now)()}endFrame(){this.#frameCount++;this.#fpsCounter++;const e=(0,T.now)()-this.#timeStartFrame;this.#msCounter+=e;if((0,T.now)()-this.#timeStartSecond>1e3)this.endSecond()}endSecond(){this.stats.fps=this.#fpsCounter;this.stats.ms=Math.round(this.#msCounter/this.#fpsCounter*100)/100;this.emitEvent("performance",this.stats);if(this.logFps)console.log(this.stats);this.#fpsCounter=0;this.#msCounter=0;this.#timeStartSecond=(0,T.now)()}}class L extends u.Events{static API_UNKNOWN=0;static API_WEBGL=1;static API_WEBGPU=2;static EVENT_RESIZE="resize";gApi=0;_textureslots=[];_pMatrixStack=new F;_mMatrixStack=new F;_vMatrixStack=new F;canvasScale=1;constructor(e){super();this._log=new u.Logger("cg_context",{onError:e.config.onError});this.tempData=this.frameStore=this.frameStore||{};this.fpsCounter=new W;this._identView=w.vec3.create();this._ident=w.vec3.create();w.vec3.set(this._identView,0,0,-2);w.vec3.set(this._ident,0,0,0);this._onetimeCallbacks=[];this.maxTexSize=2048;this._viewPort=[0,0,1,1];this._viewPortStack=[];this.patch=e;this.autoReSize=true;this.DEPTH_COMPARE_FUNC_NEVER=0;this.DEPTH_COMPARE_FUNC_LESS=1;this.DEPTH_COMPARE_FUNC_EQUAL=2;this.DEPTH_COMPARE_FUNC_LESSEQUAL=3;this.DEPTH_COMPARE_FUNC_GREATER=4;this.DEPTH_COMPARE_FUNC_NOTEQUAL=5;this.DEPTH_COMPARE_FUNC_GREATEREQUAL=6;this.DEPTH_COMPARE_FUNC_ALWAYS=7;this.profileData=new N(this);this.pMatrix=w.mat4.create();this.mMatrix=w.mat4.create();this.vMatrix=w.mat4.create();w.mat4.identity(this.mMatrix);w.mat4.identity(this.vMatrix);window.matchMedia("screen and (min-resolution: 2dppx)").addEventListener("change",()=>{this.emitEvent("resize")})}get canvasWidth(){return this.width}get canvasHeight(){return this.height}get width(){return this.cgCanvas.canvasWidth}get height(){return this.cgCanvas.canvasHeight}get widthCss(){return this.cgCanvas.canvasWidth/this.pixelDensity}get heightCss(){return this.cgCanvas.canvasHeight/this.pixelDensity}set pixelDensity(e){if(this.cgCanvas.pixelDensity!=e){this.cgCanvas.pixelDensity=e;this.cgCanvas.updateSize();this.emitEvent("resize")}}get pixelDensity(){return this.cgCanvas.pixelDensity}getGApiName(){return["unknown","WebGL","WebGPU"][this.gApi]}get canvas(){return this.cgCanvas.canvasEle}get viewPort(){return[0,0,this.canvasWidth,this.canvasHeight]}setCanvas(e){if(this.cgCanvas&&e==this.cgCanvas.canvasEle)return;if(typeof e==="string")e=document.getElementById(e);this.cgCanvas=new Y({canvasEle:e,cg:this});if(!e)return;e.parentElement.classList.add("cablesContainer");if(this._setCanvas)this._setCanvas(e);this.updateSize()}_setCanvas(e){}updateSize(){this.cgCanvas.updateSize()}setSize(e,t,i=false){this.cgCanvas.setSize(e,t,i)}_resizeToWindowSize(){if(this.autoReSize){this.setSize(window.innerWidth,window.innerHeight);this.updateSize()}}_resizeToParentSize(){if(this.autoReSize){const e=this.canvas.parentElement;if(!e){this._log.error("cables: can not resize to container element");return}this.setSize(e.clientWidth,e.clientHeight);this.updateSize()}}setAutoResize(e){window.removeEventListener("resize",this._resizeToWindowSize.bind(this));window.removeEventListener("resize",this._resizeToParentSize.bind(this));if(e=="window"){window.addEventListener("resize",this._resizeToWindowSize.bind(this));window.addEventListener("orientationchange",this._resizeToWindowSize.bind(this));this._resizeToWindowSize()}if(e=="parent"){window.addEventListener("resize",this._resizeToParentSize.bind(this));this._resizeToParentSize()}}pushPMatrix(){this.pMatrix=this._pMatrixStack.push(this.pMatrix)}popPMatrix(){this.pMatrix=this._pMatrixStack.pop();return this.pMatrix}getProjectionMatrixStateCount(){return this._pMatrixStack.stateCounter}pushModelMatrix(){this.mMatrix=this._mMatrixStack.push(this.mMatrix)}popModelMatrix(){this.mMatrix=this._mMatrixStack.pop();return this.mMatrix}modelMatrix(){return this.mMatrix}pushViewMatrix(){this.vMatrix=this._vMatrixStack.push(this.vMatrix)}popViewMatrix(){this.vMatrix=this._vMatrixStack.pop()}getViewMatrixStateCount(){return this._vMatrixStack.stateCounter}_startMatrixStacks(e,t){e=e||this._ident;t=t||this._identView;w.mat4.perspective(this.pMatrix,45,this.canvasWidth/this.canvasHeight,.1,1e3);w.mat4.identity(this.mMatrix);w.mat4.identity(this.vMatrix);w.mat4.translate(this.mMatrix,this.mMatrix,e);w.mat4.translate(this.vMatrix,this.vMatrix,t);this.pushPMatrix();this.pushModelMatrix();this.pushViewMatrix()}_endMatrixStacks(){this.popViewMatrix();this.popModelMatrix();this.popPMatrix()}dispose(){this.aborted=true;if(this.cgCanvas)this.cgCanvas.dispose();if(this._dispose)this._dispose()}_dispose(){}shouldDrawHelpers(e){return false}addNextFrameOnceCallback(e){if(e&&this._onetimeCallbacks.indexOf(e)==-1)this._onetimeCallbacks.push(e)}_execOneTimeCallbacks(){if(this._onetimeCallbacks.length>0){for(let e=0;e<this._onetimeCallbacks.length;e++)this._onetimeCallbacks[e]();this._onetimeCallbacks.length=0}}checkTextureSize(e){e=e||1;e=Math.floor(e);e=Math.min(e,this.maxTexSize);e=Math.max(e,1);return e}screenShot(e,t,i,s){console.log("no screenshot function implemented")}saveScreenshot(i,s,e,t,r){this.patch.renderOneFrame();let n=this.canvas.clientWidth*this.pixelDensity;let a=this.canvas.clientHeight*this.pixelDensity;if(e){this.canvas.width=e;n=e}if(t){this.canvas.height=t;a=t}function o(e,t,i){return Array(t-String(e).length+1).join(i||"0")+e}const l=new Date;const h="".concat(String(l.getFullYear())+String(l.getMonth()+1)+String(l.getDate()),"_").concat(o(l.getHours(),2)).concat(o(l.getMinutes(),2)).concat(o(l.getSeconds(),2));if(!i)i="cables_"+h+".png";else i+=".png";this.screenShot(e=>{this.canvas.width=n;this.canvas.height=a;if(e){const t=document.createElement("a");t.download=i;t.href=URL.createObjectURL(e);console.log("scrrenshot");setTimeout(function(){t.click();if(s)s(e)},100)}else{this._log.log("screenshot: no blob")}})}hasFocus(){return this.cgCanvas.hasFocus}}const q={BLEND_NONE:0,BLEND_NORMAL:1,BLEND_ADD:2,BLEND_SUB:3,BLEND_MUL:4};class K extends L{#cursor="auto";constructor(e){super(e);this.gApi=L.API_WEBGL;this.aborted=false;this.pushMvMatrix=this.pushModelMatrix;this.popMvMatrix=this.popmMatrix=this.popModelMatrix;this._log=new u.Logger("cgl_context",{onError:e.config.onError});this.glVersion=0;this.glUseHalfFloatTex=false;this.clearCanvasTransparent=true;this.clearCanvasDepth=true;this.debugOneFrame=false;this.checkGlErrors=false;this.maxTextureUnits=0;this.maxVaryingVectors=0;this.currentProgram=null;this._hadStackError=false;this.glSlowRendere=false;this._isSafariCrap=false;this.temporaryTexture=null;this.gl=null;this.#cursor="auto";this._currentCursor="";this._viewPortStack=[];this._glFrameBufferStack=[];this._frameBufferStack=[];this._shaderStack=[];this._stackDepthTest=[];this.mainloopOp=null;this._stackBlendMode=[];this._stackBlendModePremul=[];this._stackBlend=[];this._stackDepthFunc=[];this._stackCullFaceFacing=[];this._stackCullFace=[];this._stackDepthWrite=[];this._stackDepthTest=[];this._stackStencil=[];this._simpleShader=new C(this,"simpleshader");this._simpleShader.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_BEGIN_FRAG","MODULE_VERTEX_MODELVIEW"]);this._simpleShader.setSource(C.getDefaultVertexShader(),C.getDefaultFragmentShader());this._currentShader=this._simpleShader;this._oldCanvasWidth=-1;this._oldCanvasHeight=-1;this._enabledExtensions={};this.errorShader=null}get viewPort(){if(this._viewPortStack.length>3){const e=this._viewPortStack.length;return[this._viewPortStack[e-4],this._viewPortStack[e-3],this._viewPortStack[e-2],this._viewPortStack[e-1]]}else{return this._viewPort}}get mvMatrix(){return this.mMatrix}set mvMatrix(e){this.mMatrix=e}_setCanvas(e){if(!e)this._log.stack("_setCanvas undef");if(!this.patch.config.canvas)this.patch.config.canvas={};if(!this.patch.config.canvas.hasOwnProperty("preserveDrawingBuffer"))this.patch.config.canvas.preserveDrawingBuffer=true;if(!this.patch.config.canvas.hasOwnProperty("premultipliedAlpha"))this.patch.config.canvas.premultipliedAlpha=false;if(!this.patch.config.canvas.hasOwnProperty("alpha"))this.patch.config.canvas.alpha=false;this.patch.config.canvas.stencil=true;if(this.patch.config.hasOwnProperty("clearCanvasColor"))this.clearCanvasTransparent=this.patch.config.clearCanvasColor;if(this.patch.config.hasOwnProperty("clearCanvasDepth"))this.clearCanvasDepth=this.patch.config.clearCanvasDepth;if(/^((?!chrome|android).)*safari/i.test(navigator.userAgent)){this._isSafariCrap=true;this.glUseHalfFloatTex=true}if(!this.patch.config.canvas.forceWebGl1)this.gl=e.getContext("webgl2",this.patch.config.canvas);if(!this.gl||this.gl.isContextLost()){this.aborted=true;this._log.error("NO_WEBGL","sorry, could not initialize WebGL. Please check if your Browser supports WebGL or try to restart your browser.");return}if(this.gl.getParameter(this.gl.VERSION)!="WebGL 1.0"){this.glVersion=2}else{this.gl=e.getContext("webgl",this.patch.config.canvas)||e.getContext("experimental-webgl",this.patch.config.canvas);this.glVersion=1;if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){if(!this.patch.config.canvas.hasOwnProperty("powerPreference"))this.patch.config.canvas.powerPreference="high-performance"}this.enableExtension("OES_standard_derivatives");const i=this.enableExtension("ANGLE_instanced_arrays")||this.gl;if(i.vertexAttribDivisorANGLE){this.gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i);this.gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i)}}const t=this.enableExtension("WEBGL_debug_renderer_info");if(t){this.glRenderer=this.gl.getParameter(t.UNMASKED_RENDERER_WEBGL);if(this.glRenderer==="Google SwiftShader")this.glSlowRenderer=true}this.canvas.addEventListener("webglcontextlost",e=>{if(this.aborted)return this._log.warn("[cgl_state] aborted context lost... can be ignored...");this._log.error("canvas lost...",e);this.emitEvent("webglcontextlost");this.aborted=true});this.maxAnisotropic=0;if(this.enableExtension("EXT_texture_filter_anisotropic"))this.maxAnisotropic=this.gl.getParameter(this.enableExtension("EXT_texture_filter_anisotropic").MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.maxVaryingVectors=this.gl.getParameter(this.gl.MAX_VARYING_VECTORS);this.maxTextureUnits=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS);this.maxTexSize=this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE);this.maxUniformsFrag=this.gl.getParameter(this.gl.MAX_FRAGMENT_UNIFORM_VECTORS);this.maxUniformsVert=this.gl.getParameter(this.gl.MAX_VERTEX_UNIFORM_VECTORS);this.maxSamples=0;if(this.gl.MAX_SAMPLES)this.maxSamples=this.gl.getParameter(this.gl.MAX_SAMPLES);if(this.glVersion==1){this.enableExtension("OES_standard_derivatives");const i=this.enableExtension("ANGLE_instanced_arrays")||this.gl;if(i.vertexAttribDivisorANGLE){this.gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i);this.gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i)}}this.DEPTH_FUNCS=[this.gl.NEVER,this.gl.ALWAYS,this.gl.LESS,this.gl.LEQUAL,this.gl.GREATER,this.gl.GEQUAL,this.gl.EQUAL,this.gl.NOTEQUAL];this.CULL_MODES=[null,this.gl.BACK,this.gl.FRONT,this.gl.FRONT_AND_BACK]}getInfo(){return{glVersion:this.glVersion,glRenderer:this.glRenderer,glUseHalfFloatTex:this.glUseHalfFloatTex,maxVaryingVectors:this.maxVaryingVectors,maxTextureUnits:this.maxTextureUnits,maxTexSize:this.maxTexSize,maxUniformsFrag:this.maxUniformsFrag,maxUniformsVert:this.maxUniformsVert,maxSamples:this.maxSamples}}popViewPort(){this._viewPortStack.pop();this._viewPortStack.pop();this._viewPortStack.pop();this._viewPortStack.pop();if(this._viewPortStack.length==0)this.setViewPort(0,0,this.canvasWidth,this.canvasHeight);else this.setViewPort(this._viewPortStack[this._viewPort.length-4],this._viewPortStack[this._viewPort.length-3],this._viewPortStack[this._viewPort.length-2],this._viewPortStack[this._viewPort.length-1])}pushViewPort(e,t,i,s){this._viewPortStack.push(e,t,i,s);this.setViewPort(e,t,i,s)}getViewPort(){return this._viewPort}resetViewPort(){this.gl.viewport(this._viewPort[0],this._viewPort[1],this._viewPort[2],this._viewPort[3])}setViewPort(e,t,i,s){this._viewPort[0]=Math.round(e);this._viewPort[1]=Math.round(t);this._viewPort[2]=Math.round(i);this._viewPort[3]=Math.round(s);this.gl.viewport(this._viewPort[0],this._viewPort[1],this._viewPort[2],this._viewPort[3])}screenShot(t,e,i,s){if(e){this.gl.clearColor(1,1,1,1);this.gl.colorMask(false,false,false,true);this.gl.clear(this.gl.COLOR_BUFFER_BIT);this.gl.colorMask(true,true,true,true)}if(this.canvas&&this.canvas.toBlob){this.canvas.toBlob(e=>{if(t)t(e);else this._log.log("no screenshot callback...")},i,s)}}endFrame(){if(this.patch.isEditorMode())CABLES.GL_MARKER.drawMarkerLayer(this);this.setPreviousShader();if(this._vMatrixStack.length()>0)this.logStackError("view matrix stack length !=0 at end of rendering...");if(this._mMatrixStack.length()>0)this.logStackError("mvmatrix stack length !=0 at end of rendering...");if(this._pMatrixStack.length()>0)this.logStackError("pmatrix stack length !=0 at end of rendering...");if(this._glFrameBufferStack.length>0)this.logStackError("glFrameBuffer stack length !=0 at end of rendering...");if(this._stackDepthTest.length>0)this.logStackError("depthtest stack length !=0 at end of rendering...");if(this._stackDepthWrite.length>0)this.logStackError("depthwrite stack length !=0 at end of rendering...");if(this._stackDepthFunc.length>0)this.logStackError("depthfunc stack length !=0 at end of rendering...");if(this._stackBlend.length>0)this.logStackError("blend stack length !=0 at end of rendering...");if(this._stackBlendMode.length>0)this.logStackError("blendMode stack length !=0 at end of rendering...");if(this._shaderStack.length>0)this.logStackError("this._shaderStack length !=0 at end of rendering...");if(this._stackCullFace.length>0)this.logStackError("this._stackCullFace length !=0 at end of rendering...");if(this._stackCullFaceFacing.length>0)this.logStackError("this._stackCullFaceFacing length !=0 at end of rendering...");if(this._viewPortStack.length>0)this.logStackError("viewport stack length !=0 at end of rendering...");this._frameStarted=false;if(this._oldCanvasWidth!=this.canvasWidth||this._oldCanvasHeight!=this.canvasHeight){this._oldCanvasWidth=this.canvasWidth;this._oldCanvasHeight=this.canvasHeight;this.emitEvent(L.EVENT_RESIZE)}if(this.#cursor!=this._currentCursor){this._currentCursor=this.canvas.style.cursor=this.#cursor}this.emitEvent("endframe");this.fpsCounter.endFrame()}logStackError(e){if(!this._hadStackError){this._hadStackError=true;this._log.warn("["+this.canvas.id+"]: ",e)}}getShader(){if(this._currentShader)if(!this.tempData||this.tempData.renderOffscreen===true==this._currentShader.offScreenPass===true)return this._currentShader;for(let e=this._shaderStack.length-1;e>=0;e--)if(this._shaderStack[e])if(this.tempData.renderOffscreen==this._shaderStack[e].offScreenPass)return this._shaderStack[e]}getDefaultShader(){return this._simpleShader}setShader(e){this.pushShader(e)}pushShader(t){if(this.tempData.forceShaderMods){for(let e=0;e<this.tempData.forceShaderMods.length;e++){t=this.tempData.forceShaderMods[e].bind(t,false)}}this._shaderStack.push(t);this._currentShader=t}popShader(){this.setPreviousShader()}setPreviousShader(){if(this.tempData.forceShaderMods){for(let e=0;e<this.tempData.forceShaderMods.length;e++){this.tempData.forceShaderMods[e].unbind(false)}}if(this._shaderStack.length===0)throw new Error("Invalid shader stack pop!");this._shaderStack.pop();this._currentShader=this._shaderStack[this._shaderStack.length-1]}pushGlFrameBuffer(e){this._glFrameBufferStack.push(e)}popGlFrameBuffer(){if(this._glFrameBufferStack.length==0)return null;this._glFrameBufferStack.pop();return this._glFrameBufferStack[this._glFrameBufferStack.length-1]}getCurrentGlFrameBuffer(){if(this._glFrameBufferStack.length===0)return null;return this._glFrameBufferStack[this._glFrameBufferStack.length-1]}pushFrameBuffer(e){this._frameBufferStack.push(e)}popFrameBuffer(){if(this._frameBufferStack.length==0)return null;this._frameBufferStack.pop();return this._frameBufferStack[this._frameBufferStack.length-1]}getCurrentFrameBuffer(){if(this._frameBufferStack.length===0)return null;return this._frameBufferStack[this._frameBufferStack.length-1]}renderStart(e,t,i){this.fpsCounter.startFrame();this.pushDepthTest(true);this.pushDepthWrite(true);this.pushDepthFunc(e.gl.LEQUAL);this.pushCullFaceFacing(e.gl.BACK);this.pushCullFace(false);e.setViewPort(0,0,e.canvasWidth,e.canvasHeight);this._startMatrixStacks(t,i);e.pushBlendMode(p.BLEND_MODES.BLEND_NORMAL,false);for(let e=0;e<this._textureslots.length;e++)this._textureslots[e]=null;this.pushShader(this._simpleShader);this._frameStarted=true;this._execOneTimeCallbacks();for(let e=0;e<this._textureslots.length;e++){this.gl.activeTexture(this.gl.TEXTURE0+e);this.gl.bindTexture(this.gl.TEXTURE_2D,null);this._textureslots[e]=null}this.emitEvent("beginFrame")}renderEnd(e){this._endMatrixStacks();this.popDepthTest();this.popDepthWrite();this.popDepthFunc();this.popCullFaceFacing();this.popCullFace();this.popBlend();this.popBlendMode();e.endFrame();this.emitEvent("endFrame")}getTexture(e){return this._textureslots[e]}hasFrameStarted(){return this._frameStarted}checkFrameStarted(e){if(!this._frameStarted){this._log.warn("frame not started "+e);Error.stackTraceLimit=25;T.utils.logStack();this.patch.printTriggerStack()}}setTexture(e,t,i){this.checkFrameStarted("cgl setTexture");if(t===null)t=h.getEmptyTexture(this).tex;if(this._textureslots[e]!=t){this.gl.activeTexture(this.gl.TEXTURE0+e);this.gl.bindTexture(i||this.gl.TEXTURE_2D,t);this._textureslots[e]=t}return true}fullScreen(){if(this.canvas.requestFullscreen)this.canvas.requestFullscreen();else if(this.canvas.mozRequestFullScreen)this.canvas.mozRequestFullScreen();else if(this.canvas.webkitRequestFullscreen)this.canvas.webkitRequestFullscreen();else if(this.canvas.msRequestFullscreen)this.canvas.msRequestFullscreen()}printError(t){if(!this.checkGlErrors)return;let i=false;let s=this.gl.getError();if(s!=this.gl.NO_ERROR){let e="";if(s==this.gl.OUT_OF_MEMORY)e="OUT_OF_MEMORY";if(s==this.gl.INVALID_ENUM)e="INVALID_ENUM";if(s==this.gl.INVALID_OPERATION)e="INVALID_OPERATION";if(s==this.gl.INVALID_FRAMEBUFFER_OPERATION)e="INVALID_FRAMEBUFFER_OPERATION";if(s==this.gl.INVALID_VALUE)e="INVALID_VALUE";if(s==this.gl.CONTEXT_LOST_WEBGL){this.aborted=true;e="CONTEXT_LOST_WEBGL"}if(s==this.gl.NO_ERROR)e="NO_ERROR";i=true;this._log.warn("gl error ["+this.canvas.id+"]: ",t,s,e);if(this.canvas.id.includes("glGuiCanvas"))if(!this._loggedGlError){this.patch.printTriggerStack();this._log.stack("glerror");this._loggedGlError=true}}s=this.gl.getError();return i}_dispose(){this._simpleShader.dispose();this.gl=null}pushDepthTest(e){this._stackDepthTest.push(e);if(!e)this.gl.disable(this.gl.DEPTH_TEST);else this.gl.enable(this.gl.DEPTH_TEST)}stateDepthTest(){return this._stackDepthTest[this._stackDepthTest.length-1]}popDepthTest(){this._stackDepthTest.pop();if(!this._stackDepthTest[this._stackDepthTest.length-1])this.gl.disable(this.gl.DEPTH_TEST);else this.gl.enable(this.gl.DEPTH_TEST)}pushDepthWrite(e){e=e||false;this._stackDepthWrite.push(e);this.gl.depthMask(e)}stateDepthWrite(){return this._stackDepthWrite[this._stackDepthWrite.length-1]}popDepthWrite(){this._stackDepthWrite.pop();this.gl.depthMask(this._stackDepthWrite[this._stackDepthWrite.length-1]||false)}pushCullFace(e){this._stackCullFace.push(e);if(e)this.gl.enable(this.gl.CULL_FACE);else this.gl.disable(this.gl.CULL_FACE)}stateCullFace(){return this._stackCullFace[this._stackCullFace.length-1]}popCullFace(){this._stackCullFace.pop();if(this._stackCullFace[this._stackCullFace.length-1])this.gl.enable(this.gl.CULL_FACE);else this.gl.disable(this.gl.CULL_FACE)}pushCullFaceFacing(e){this._stackCullFaceFacing.push(e);this.gl.cullFace(this._stackCullFaceFacing[this._stackCullFaceFacing.length-1])}stateCullFaceFacing(){return this._stackCullFaceFacing[this._stackCullFaceFacing.length-1]}popCullFaceFacing(){this._stackCullFaceFacing.pop();if(this._stackCullFaceFacing.length>0)this.gl.cullFace(this._stackCullFaceFacing[this._stackCullFaceFacing.length-1])}pushDepthFunc(e){this._stackDepthFunc.push(e);this.gl.depthFunc(e)}stateDepthFunc(){if(this._stackDepthFunc.length>0)return this._stackDepthFunc[this._stackDepthFunc.length-1];return false}popDepthFunc(){this._stackDepthFunc.pop();if(this._stackDepthFunc.length>0)this.gl.depthFunc(this._stackDepthFunc[this._stackDepthFunc.length-1])}pushBlend(e){this._stackBlend.push(e);if(!e)this.gl.disable(this.gl.BLEND);else this.gl.enable(this.gl.BLEND)}popBlend(){this._stackBlend.pop();if(!this._stackBlend[this._stackBlend.length-1])this.gl.disable(this.gl.BLEND);else this.gl.enable(this.gl.BLEND)}stateBlend(){return this._stackBlend[this._stackBlend.length-1]}pushBlendMode(e,t){this._stackBlendMode.push(e);this._stackBlendModePremul.push(t);const i=this._stackBlendMode.length-1;this.pushBlend(this._stackBlendMode[i]!==p.BLEND_MODES.BLEND_NONE);this._setBlendMode(this._stackBlendMode[i],this._stackBlendModePremul[i])}popBlendMode(){this._stackBlendMode.pop();this._stackBlendModePremul.pop();const e=this._stackBlendMode.length-1;this.popBlend();if(e>=0)this._setBlendMode(this._stackBlendMode[e],this._stackBlendModePremul[e])}pushStencil(e){this._stackStencil.push(e);if(!e)this.gl.disable(this.gl.STENCIL_TEST);else this.gl.enable(this.gl.STENCIL_TEST)}popStencil(){this._stackStencil.pop();if(!this._stackStencil[this._stackStencil.length-1])this.gl.disable(this.gl.STENCIL_TEST);else this.gl.enable(this.gl.STENCIL_TEST)}glGetAttribLocation(e,t){const i=this.gl.getAttribLocation(e,t);return i}shouldDrawHelpers(e){if(this.tempData.shadowPass)return false;if(!e.patch.isEditorMode())return false;return gui.shouldDrawOverlay}_setBlendMode(e,t){const i=this.gl;if(e==p.BLEND_MODES.BLEND_NONE){}else if(e==p.BLEND_MODES.BLEND_ADD){if(t){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ONE,i.ONE,i.ONE,i.ONE)}else{i.blendEquation(i.FUNC_ADD);i.blendFunc(i.SRC_ALPHA,i.ONE)}}else if(e==p.BLEND_MODES.BLEND_SUB){if(t){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ZERO,i.ZERO,i.ONE_MINUS_SRC_COLOR,i.ONE_MINUS_SRC_ALPHA)}else{i.blendEquation(i.FUNC_ADD);i.blendFunc(i.ZERO,i.ONE_MINUS_SRC_COLOR)}}else if(e==p.BLEND_MODES.BLEND_MUL){if(t){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ZERO,i.SRC_COLOR,i.ZERO,i.SRC_ALPHA)}else{i.blendEquation(i.FUNC_ADD);i.blendFunc(i.ZERO,i.SRC_COLOR)}}else if(e==p.BLEND_MODES.BLEND_NORMAL){if(t){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ONE,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA)}else{i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA)}}else{this._log.log("setblendmode: unknown blendmode")}}createMesh(e,t){if(T.utils.isNumeric(t))t={glPrimitive:t};return new v(this,e,t)}setCursor(e){this.#cursor=e}enableExtension(e){if(!this.gl)return null;if(this._enabledExtensions.hasOwnProperty(e))return this._enabledExtensions[e];const t=this.gl.getExtension(e);this._enabledExtensions[e]=t;if(!t)this._log.warn("[cgl_state] extension not available "+e);return t}getErrorShader(){if(this.errorShader)return this.errorShader;this.errorShader=new C(this,"errormaterial");this.errorShader.setSource(C.getDefaultVertexShader(),C.getErrorFragmentShader());return this.errorShader}}const D={Framebuffer2:e,Geometry:b,BoundingBox:E,Marker:r,WirePoint:n,WireCube:o,MatrixStack:F,Mesh:v,MESH:S,ShaderLibMods:I,Shader:C,Uniform:c,MESHES:x,getWheelSpeed:z,getWheelDelta:X,Context:K,Texture:h,TextureEffect:M,onLoadingAssetsFinished:j,ProfileData:N,UniColorShader:y,...p.BLEND_MODES,...p.SHADER,...p.MATH,...p.BLEND_MODES};window.CABLES=window.CABLES||{};window.CABLES.CGL=window.CABLES.CGL||D;window.CGL=window.CGL||D;T.Anim.slerpQuaternion=function(e,t,i,s,r,n){if(!T.Anim.slerpQuaternion.q1){T.Anim.slerpQuaternion.q1=quat.create();T.Anim.slerpQuaternion.q2=quat.create()}const a=i.getKeyIndex(e);let o=a+1;if(o>=i.keys.length)o=i.keys.length-1;if(a==o){quat.set(t,i.keys[a].value,s.keys[a].value,r.keys[a].value,n.keys[a].value)}else{const l=i.keys[a].time;const h=i.keys[o].time;const u=(e-l)/(h-l);quat.set(T.Anim.slerpQuaternion.q1,i.keys[a].value,s.keys[a].value,r.keys[a].value,n.keys[a].value);quat.set(T.Anim.slerpQuaternion.q2,i.keys[o].value,s.keys[o].value,r.keys[o].value,n.keys[o].value);quat.slerp(t,T.Anim.slerpQuaternion.q1,T.Anim.slerpQuaternion.q2,u)}return t};class Z{constructor(e,t,i){this.cgl=e;this._options=i;this.fb=null;let s=i.shader;this._useDefaultShader=true;if(i.shader)this._useDefaultShader=false;i.numRenderBuffers=i.numRenderBuffers||1;if(!s){s="".endl()+"IN vec2 texCoord;";for(let e=0;e<i.numRenderBuffers;e++){s=s.endl()+"UNI sampler2D tex"+e+";".endl()}s=s.endl()+"void main()".endl()+"{";if(i.numRenderBuffers==1){s=s.endl()+"    outColor= texture(tex0,texCoord);".endl()}else for(let e=0;e<i.numRenderBuffers;e++){s=s.endl()+"outColor"+e+" = texture(tex"+e+",texCoord);".endl()}s=s.endl()+"}"}const r=i.vertexShader||"".endl()+"IN vec3 vPosition;".endl()+"IN vec2 attrTexCoord;".endl()+"OUT vec2 texCoord;".endl()+"void main()".endl()+"{".endl()+"   texCoord=attrTexCoord;".endl()+"   gl_Position = vec4(vPosition,  1.0);".endl()+"}";this.bgShader=new D.Shader(e,"corelib copytexture "+t);this.bgShader.setSource(r,s);if(!i.vertexShader)this.bgShader.ignoreMissingUniforms=true;new D.Uniform(this.bgShader,"t","tex",0);new D.Uniform(this.bgShader,"t","tex1",1);new D.Uniform(this.bgShader,"t","tex2",2);new D.Uniform(this.bgShader,"t","tex3",3);this.mesh=D.MESHES.getSimpleRect(this.cgl,"texEffectRect")}setSize(e,t){this._options.width=e;this._options.height=t}copy(e,t,i,s,r){const n=this.cgl;if(!e)e=D.Texture.getEmptyTexture(this.cgl);let a=this._options.width||e.width,o=this._options.height||e.height;if(this.fb){if(a<=0)a=8;if(o<=0)o=8;if(this.fb.getWidth()!=a||this.fb.getHeight()!=o)this.fb.setSize(a,o)}else{let e=D.Texture.FILTER_LINEAR;let t=D.Texture.WRAP_CLAMP_TO_EDGE;if(this._options.isFloatingPointTexture)e=D.Texture.FILTER_NEAREST;if(this._options.hasOwnProperty("filter"))e=this._options.filter;if(this._options.hasOwnProperty("wrap"))t=this._options.wrap;const l={isFloatingPointTexture:this._options.isFloatingPointTexture,pixelFormat:this._options.pixelFormat,numRenderBuffers:this._options.numRenderBuffers||1,filter:e,wrap:t};if(n.glVersion==1)this.fb=new D.Framebuffer(n,a,o,l);else this.fb=new D.Framebuffer2(n,a,o,l)}n.tempData.renderOffscreen=true;this.fb.renderStart(n);n.setTexture(0,e.tex);if(t)n.setTexture(1,t.tex);if(i)n.setTexture(2,i.tex);if(s)n.setTexture(3,s.tex);if(r)n.setTexture(4,r.tex);n.pushShader(this.bgShader);this.mesh.render(this.bgShader);n.popShader();this.fb.renderEnd();n.tempData.renderOffscreen=false;return this.fb.getTextureColor()}dispose(){if(this.fb)this.fb.dispose();if(this.bgShader)this.bgShader.dispose();if(this.mesh)this.mesh.dispose()}}})();var e=CGL=typeof CGL==="undefined"?{}:CGL;for(var t in J)e[t]=J[t];if(J.__esModule)Object.defineProperty(e,"__esModule",{value:true})})();(()=>{var s={};(()=>{s.d=(e,t)=>{for(var i in t){if(s.o(t,i)&&!s.o(e,i)){Object.defineProperty(e,i,{enumerable:true,get:t[i]})}}}})();(()=>{s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{s.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();var t={};(()=>{"use strict";s.r(t);s.d(t,{ShaderModifier:()=>e});class e{constructor(e,t,i){this._cgl=e;this._name=t;this._origShaders={};this._uniforms=[];this._structUniforms=[];this._definesToggled={};this._defines={};this._mods=[];this._textures=[];this._boundShader=null;this._changedDefines=true;this._changedUniforms=true;this._modulesChanged=false;this.needsTexturePush=false;this._lastShader=null;this._attributes=[];if(i&&i.opId)this.opId=i.opId;if(this._cgl.glVersion==1){this._cgl.enableExtension("OES_texture_float");this._cgl.enableExtension("OES_texture_float_linear");this._cgl.enableExtension("OES_texture_half_float");this._cgl.enableExtension("OES_texture_half_float_linear")}}bind(e,t){const i=e||this._cgl.getShader();if(!i)return;this._boundShader=this._origShaders[i.id];let s=false;if(this._boundShader&&this._lastShader!=this._boundShader.shader){if(!this._boundShader.shader.hasModule(this._mods[0].id))s=true}if(s||!this._boundShader||i.lastCompile!=this._boundShader.lastCompile||this._modulesChanged||i.needsRecompile()){if(this._boundShader)this._boundShader.shader.dispose();if(i.needsRecompile())i.compile();this.needsTexturePush=true;this._boundShader=this._origShaders[i.id]={lastCompile:i.lastCompile,orig:i,shader:i.copy()};this._addModulesToShader(this._boundShader.shader);this._updateDefinesShader(this._boundShader.shader);this._updateUniformsShader(this._boundShader.shader)}this._boundShader.wireframe=i.wireframe;if(this._changedDefines)this._updateDefines();if(this._changedUniforms)this._updateUniforms();if(t!==false)this._cgl.pushShader(this._boundShader.shader);this._boundShader.shader.copyUniformValues(this._boundShader.orig);if(this.needsTexturePush){for(let e=0;e<this._textures.length;e++){const r=this._textures[e][0];const n=this._textures[e][1];const a=this._textures[e][2];if(this._getUniform(r)){const o=this.getPrefixedName(r);const l=this._boundShader.shader.getUniform(o);if(l)this._boundShader.shader.pushTexture(l,n,a)}}this.needsTexturePush=false;this._textures.length=0}this._modulesChanged=false;this._boundShader.shader.fromMod=this;if(this.onBind)this.onBind(this._boundShader.shader);return this._boundShader.shader}unbind(e){if(this._boundShader){if(e!==false)this._cgl.popShader()}this._boundShader=null}_addModulesToShader(t){let i;if(this._mods.length>1)i=this._mods[0];for(let e=0;e<this._mods.length;e++)t.addModule(this._mods[e],i)}_removeModulesFromShader(e){for(const t in this._origShaders)this._origShaders[t].shader.removeModule(e)}addModule(e){this._mods.push(e);this._modulesChanged=true}removeModule(t){const i=[];let s=false;for(let e=0;e<this._mods.length;e++){if(this._mods[e].title==t){s=true;this._removeModulesFromShader(this._mods[e]);i.push(e)}}for(let e=i.length-1;e>=0;e-=1)this._mods.splice(i[e],1);this._modulesChanged=true}_updateUniformsShader(s){for(let e=0;e<this._uniforms.length;e++){const t=this._uniforms[e];const i=this.getPrefixedName(t.name);if(!s.hasUniform(i)&&!t.structName){let e=null;if(t.shaderType==="both"){e=s.addUniformBoth(t.type,i,t.v1,t.v2,t.v3,t.v4);e.comment="mod: "+this._name}else if(t.shaderType==="frag"){e=s.addUniformFrag(t.type,i,t.v1,t.v2,t.v3,t.v4);e.comment="mod: "+this._name}else if(t.shaderType==="vert"){e=s.addUniformVert(t.type,i,t.v1,t.v2,t.v3,t.v4);e.comment="mod: "+this._name}}}for(let i=0;i<this._structUniforms.length;i+=1){const r=this._structUniforms[i];let e=r.uniformName;let t=r.structName;const n=r.members;e=this.getPrefixedName(r.uniformName);t=this.getPrefixedName(r.structName);if(r.shaderType==="frag"){s.addUniformStructFrag(t,e,n)}if(r.shaderType==="vert"){s.addUniformStructVert(t,e,n)}if(r.shaderType==="both"){s.addUniformStructBoth(t,e,n)}}}_updateUniforms(){for(const e in this._origShaders)this._updateUniformsShader(this._origShaders[e].shader);this._changedUniforms=false}_setUniformValue(e,t,i){const s=e.getUniform(t);if(s)s.setValue(i)}setUniformValue(e,t){const i=this._getUniform(e);if(!i)return;const s=this.getPrefixedName(e);for(const r in this._origShaders){this._setUniformValue(this._origShaders[r].shader,s,t)}}hasUniform(e){return this._getUniform(e)}_getUniform(t){for(let e=0;e<this._uniforms.length;e++){if(this._uniforms[e].name==t)return this._uniforms[e];if(this._uniforms[e].structName){if(this._uniforms[e].propertyName==t)return this._uniforms[e]}}return false}_getStructUniform(t){for(let e=0;e<this._structUniforms.length;e+=1)if(this._structUniforms[e].uniformName===t)return this._structUniforms[e];return null}_isStructUniform(t){for(let e=0;e<this._uniforms.length;e++){if(this._uniforms[e].name==t)return false;if(this._uniforms[e].structName){if(this._uniforms[e].propertyName==t)return true}}return false}addUniform(t,i,s,r,n,a,o,l,h,u){if(!this._getUniform(i)){let e="both";if(u)e=u;this._uniforms.push({type:t,name:i,v1:s,v2:r,v3:n,v4:a,structUniformName:o,structName:l,propertyName:h,shaderType:e});this._changedUniforms=true}}addUniformFrag(e,t,i,s,r,n){this.addUniform(e,t,i,s,r,n,null,null,null,"frag");this._changedUniforms=true}addUniformVert(e,t,i,s,r,n){this.addUniform(e,t,i,s,r,n,null,null,null,"vert");this._changedUniforms=true}addUniformBoth(e,t,i,s,r,n){this.addUniform(e,t,i,s,r,n,null,null,null,"both");this._changedUniforms=true}addUniformStruct(t,i,s,r){for(let e=0;e<s.length;e+=1){const n=s[e];if((n.type==="2i"||n.type==="i"||n.type==="3i")&&r==="both")console.error("Adding an integer struct member to both shaders can potentially error. Please use different structs for each shader. Error occured in struct:",t," with member:",n.name," of type:",n.type,".");if(!this._getUniform(i+"."+n.name)){this.addUniform(n.type,i+"."+n.name,n.v1,n.v2,n.v3,n.v4,i,t,n.name,r)}}if(!this._getStructUniform(i)){this._structUniforms.push({structName:t,uniformName:i,members:s,shaderType:r})}}addUniformStructVert(e,t,i){this.addUniformStruct(e,t,i,"vert")}addUniformStructFrag(e,t,i){this.addUniformStruct(e,t,i,"frag")}addUniformStructBoth(e,t,i){this.addUniformStruct(e,t,i,"both")}addAttribute(t){for(let e=0;e<this._attributes.length;e++){if(this._attributes[e].name==t.name&&this._attributes[e].nameFrag==t.nameFrag)return}this._attributes.push(t)}pushTexture(e,t,i){if(!t)throw new Error("no texture given to texturestack");this._textures.push([e,t,i]);this.needsTexturePush=true}_removeUniformFromShader(e,t){if(t.hasUniform(e))t.removeUniform(e)}removeUniform(t){if(this._getUniform(t)){for(let e=this._uniforms.length-1;e>=0;e-=1){const i=t;if(this._uniforms[e].name==t&&!this._uniforms[e].structName){for(const s in this._origShaders){this._removeUniformFromShader(this.getPrefixedName(i),this._origShaders[s].shader)}this._uniforms.splice(e,1)}}this._changedUniforms=true}}removeUniformStruct(t){if(this._getStructUniform(t)){for(let e=this._structUniforms.length-1;e>=0;e-=1){const i=this._structUniforms[e];if(i.uniformName===t){for(const s in this._origShaders){for(let e=0;e<i.members.length;e+=1){const r=i.members[e];this._removeUniformFromShader(this.getPrefixedName(r.name),this._origShaders[s].shader)}}this._structUniforms.splice(e,1)}}this._changedUniforms=true}}getPrefixedName(e){const t=this._mods[0].group;if(t===undefined){return}if(e.startsWith("MOD_")){e=e.substr("MOD_".length);e="mod"+t+"_"+e}return e}_updateDefinesShader(t){for(const e in this._defines){const i=this.getPrefixedName(e);if(this._defines[e]!==null&&this._defines[e]!==undefined)t.define(i,this._defines[e]);else t.removeDefine(i)}for(const e in this._definesToggled){const i=this.getPrefixedName(e);t.toggleDefine(i,this._definesToggled[e])}}_updateDefines(){for(const e in this._origShaders)this._updateDefinesShader(this._origShaders[e].shader);this._changedDefines=false}define(e,t){if(t===undefined)t=true;this._defines[e]=t;this._changedDefines=true}removeDefine(e){this._defines[e]=null;this._changedDefines=true}hasDefine(e){if(this._defines[e]!==null&&this._defines[e]!==undefined)return true;return false}toggleDefine(e,t){this._changedDefines=true;this._definesToggled[e]=t}currentShader(){if(!this._boundShader)return null;return this._boundShader.shader}dispose(){}}})();var e=CGL=typeof CGL==="undefined"?{}:CGL;for(var i in t)e[i]=t[i];if(t.__esModule)Object.defineProperty(e,"__esModule",{value:true})})();(()=>{var s={};(()=>{s.d=(e,t)=>{for(var i in t){if(s.o(t,i)&&!s.o(e,i)){Object.defineProperty(e,i,{enumerable:true,get:t[i]})}}}})();(()=>{s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{s.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();var i={};(()=>{"use strict";s.r(i);s.d(i,{PixelReader:()=>t});const e=CABLES.SHARED;class t{constructor(){this._log=new e.Logger("LoadingStatus");this.pixelData=null;this._finishedFence=true;this._size=0;this._pbo=null}_fence(n){const a=n.gl;this._finishedFence=false;return new Promise(function(t,i){if(n.aborted)return;let s=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0);if(!s)return;a.flush();function r(){if(n.aborted)return;const e=a.clientWaitSync(s,0,0);if(e==a.WAIT_FAILED){console.error("fence wait failed");if(i)i()}else if(e==a.TIMEOUT_EXPIRED){return setTimeout(r,0)}else if(e==a.CONDITION_SATISFIED){t();a.deleteSync(s)}else if(e==a.ALREADY_SIGNALED){t();a.deleteSync(s)}else{this._log.log("unknown fence status",e)}}r()})}read(i,s,e,r,n,a,o,t){if(CABLES.UI)if(!CABLES.UI.loaded||performance.now()-CABLES.UI.loadedTime<1e3)return;if(!this._finishedFence)return;const l=i.gl;let h=1;if(i.aborted)return;if(!s)return;if(e===CGL.Texture.TYPE_FLOAT)e=CGL.Texture.PFORMATSTR_RGBA32F;let u=CGL.Texture.isPixelFormatFloat(e);if(u)h=4;if(CGL.Texture.isPixelFormatHalfFloat(e))h=2;const c=CGL.Texture.setUpGlPixelFormat(i,e);const f=c.numColorChannels*a*o;if(a==0||o==0||f==0)return;if(!this._pixelData||this._size!=f*h){if(h>1)this._pixelData=new Float32Array(f);else this._pixelData=new Uint8Array(f);this._size=f*h}let g=l.UNSIGNED_BYTE;if(h>1)g=l.FLOAT;if(this._size==0||!this._pixelData){this._log.error("readpixel size 0",this._size,a,o);return}if(this._finishedFence){this._pbo=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,this._pbo);l.bufferData(l.PIXEL_PACK_BUFFER,this._pixelData.byteLength,l.DYNAMIC_READ);l.bindFramebuffer(l.FRAMEBUFFER,s);l.bindBuffer(l.PIXEL_PACK_BUFFER,this._pbo);i.profileData.profileFencedPixelRead++;if(this._size!=f*h)this._log.error("buffer size invalid",f,a,o,h);let e=c.glDataType;if(h>1)e=i.gl.FLOAT;let t=c.glDataFormat;l.readPixels(r,n,a,o,t,e,0);l.bindBuffer(l.PIXEL_PACK_BUFFER,null);l.bindFramebuffer(l.FRAMEBUFFER,null)}let d=this._pixelData.byteLength;if(this._finishedFence&&this._pbo)this._fence(i).then(e=>{this._wasTriggered=false;this._finishedFence=true;if(!e&&this._pixelData&&this._pixelData.byteLength==d){l.bindBuffer(l.PIXEL_PACK_BUFFER,this._pbo);l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,this._pixelData);l.bindBuffer(l.PIXEL_PACK_BUFFER,null);if(t)t(this._pixelData)}l.deleteBuffer(this._pbo);this._pbo=null});return true}}})();var e=CGL=typeof CGL==="undefined"?{}:CGL;for(var t in i)e[t]=i[t];if(i.__esModule)Object.defineProperty(e,"__esModule",{value:true})})();(()=>{var s={};(()=>{s.d=(e,t)=>{for(var i in t){if(s.o(t,i)&&!s.o(e,i)){Object.defineProperty(e,i,{enumerable:true,get:t[i]})}}}})();(()=>{s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{s.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();var i={};(()=>{"use strict";s.r(i);s.d(i,{VarGetOpWrapper:()=>t,VarSetOpWrapper:()=>e});const a=CABLES;class e{constructor(t,e,i,s,r,n){this._valuePort=i;this._varNamePort=s;this._op=t;this._type=e;this._typeId=-1;this._triggerPort=r;this._nextPort=n;this._var=null;this._btnCreate=t.inTriggerButton("Create new variable");this._btnCreate.setUiAttribs({hidePort:true});this._btnCreate.onTriggered=this._createVar.bind(this);this._helper=t.inUiTriggerButtons("",["Rename"]);this._helper.setUiAttribs({hidePort:true});this._helper.onTriggered=e=>{if(e=="Rename")CABLES.CMD.PATCH.renameVariable(t.varName.get())};this._op.setPortGroup("Variable",[this._helper,this._varNamePort,this._btnCreate]);s.setUiAttribs({_variableSelect:true});this._op.on("uiParamPanel",this._updateVarNamesDropdown.bind(this));this._op.patch.addEventListener("variablesChanged",this._updateName.bind(this));this._op.patch.addEventListener("variableRename",this._renameVar.bind(this));this._varNamePort.onChange=this._updateName.bind(this);this._isTexture=this._valuePort.uiAttribs.objType==="texture";this._valuePort.changeAlways=true;if(this._triggerPort){this._triggerPort.onTriggered=()=>{this._setVarValue(true)}}else{this._valuePort.onChange=this._setVarValue.bind(this)}this._op.init=()=>{this._updateName();if(!this._triggerPort)this._setVarValue();this._updateErrorUi()};if(e=="array")this._typeId=a.Port.TYPE_ARRAY;else if(e=="object")this._typeId=a.Port.TYPE_OBJECT;else if(e=="string")this._typeId=a.Port.TYPE_STRING;else if(e=="texture")this._typeId=a.Port.TYPE_TEXTURE;else this._typeId=a.Port.TYPE_VALUE}_updateErrorUi(){if(CABLES.UI){if(!this._varNamePort.get())this._op.setUiError("novarname","no variable selected");else{if(this._op.hasUiErrors)this._op.setUiError("novarname",null)}}}_updateName(){this._var=null;const e=this._varNamePort.get();this._op.setTitle("var set");this._op.setUiAttrib({extendTitle:"#"+e});this._updateErrorUi();const t=this._op.patch.getVar(e);if(t&&!t.type)t.type=this._type;if(!this._op.patch.hasVar(e)&&e!=0&&!this._triggerPort){this._setVarValue()}if(!this._op.patch.hasVar(e)&&e!=0&&this._triggerPort){if(this._type=="string")this._op.patch.setVarValue(e,"");else if(this._type=="number")this._op.patch.setVarValue(e,"");else this._op.patch.setVarValue(e,null)}if(this._op.isCurrentUiOp()){this._updateVarNamesDropdown();this._op.refreshParams()}this._updateDisplay();this._op.patch.emitEvent("opVariableNameChanged",this._op,this._varNamePort.get())}_createVar(){CABLES.CMD.PATCH.createVariable(this._op,this._type,()=>{this._updateName()})}_updateDisplay(){this._valuePort.setUiAttribs({greyout:!this._varNamePort.get()})}_updateVarNamesDropdown(){if(CABLES.UI&&CABLES.UI.loaded&&CABLES.UI.loaded){const e=gui.uiProfiler.start("[vars] _updateVarNamesDropdown");const t=[];const i=this._op.patch.getVars();for(const e in i)if(i[e].type==this._type&&e!="0")t.push(e);this._varNamePort.uiAttribs.values=t;e.finish()}}_renameVar(e,t){if(e!=this._varNamePort.get())return;this._varNamePort.set(t);this._updateName()}_setVarValue(e){let t=this._valuePort.get();if(!this._var){const i=this._varNamePort.get();if(!i)return;if(this._typeId==a.Port.TYPE_VALUE&&typeof t=="string")t=parseFloat(t);this._op.patch.setVarValue(i,t,this._type);this._var=this._op.patch.getVar(i)}if(this._typeId==a.Port.TYPE_VALUE||this._typeId==a.Port.TYPE_STRING){this._var.setValue(t)}else if(this._typeId==a.Port.TYPE_ARRAY){this._arr=[];a.utils.copyArray(t,this._arr);this._var.setValue(this._arr)}else{if(this._typeId==a.Port.TYPE_OBJECT){if(this._isTexture)this._var.setValue(CGL.Texture.getEmptyTexture(this._op.patch.cgl));else this._var.setValue(null);if(t&&t.tex&&t._cgl&&!this._isTexture)this._op.setUiError("texobj","Dont use object variables for textures, use varSetTexture");else this._op.setUiError("texobj",null)}this._var.setValue(t)}if(e&&this._nextPort)this._nextPort.trigger()}}class t{constructor(e,t,i,s){this._op=e;this._type=t;this._varnamePort=i;this._variable=null;this._valueOutPort=s;this._listenerId=null;this._typeId=0;if(t=="array")this._typeId=a.Port.TYPE_ARRAY;else if(t=="object")this._typeId=a.Port.TYPE_OBJECT;else if(t=="texture")this._typeId=a.Port.TYPE_TEXTURE;else if(t=="string")this._typeId=a.Port.TYPE_STRING;else this._typeId=a.Port.TYPE_VALUE;if(s)this._isTexture=s.uiAttribs.objType==="texture";this._op.on("uiParamPanel",this._updateVarNamesDropdown.bind(this));this._op.on("uiErrorChange",this._updateTitle.bind(this));this._op.patch.on("variableRename",this._renameVar.bind(this));this._op.patch.on("variableDeleted",e=>{if(this._op.isCurrentUiOp())this._op.refreshParams()});i.setUiAttribs({_variableSelect:true});i.setUiAttribs({_variableSelectGet:true});this._varnamePort.onChange=this._changeVar.bind(this);this._op.patch.addEventListener("variablesChanged",this._init.bind(this));this._op.onDelete=()=>{if(this._variable&&this._listenerId)this._variable.off(this._listenerId)};this._op.init=()=>{this._init()}}get variable(){return this._variable}_changeVar(){if(this._variable&&this._listenerId){this._variable.off(this._listenerId)}this._init()}_renameVar(e,t){if(e!=this._varnamePort.get())return;this._varnamePort.set(t);this._updateVarNamesDropdown();this._updateTitle();this._listenerId=this._variable.on("change",this._setValueOut.bind(this))}_updateVarNamesDropdown(){if(CABLES.UI&&CABLES.UI.loaded){const t=[];const i=this._op.patch.getVars();for(const e in i)if(i[e].type==this._type&&e!="0")t.push(e);this._op.varName.uiAttribs.values=t}}_setValueOut(e){if(this._valueOutPort)if(this._typeId==a.Port.TYPE_NUMBER||this._typeId==a.Port.TYPE_STRING)this._valueOutPort.set(e);else if(this._typeId==a.Port.TYPE_ARRAY||this._typeId==a.Port.TYPE_OBJECT||this._isTexture)this._valueOutPort.setRef(e);else console.log("unkown type?")}_updateTitle(){if(this._variable){this._op.setUiError("unknownvar",null);this._op.setTitle("var get");this._op.setUiAttrib({extendTitle:"#"+this._varnamePort.get()});if(this._valueOutPort)this._setValueOut(this._variable.getValue())}else{this._op.setUiError("unknownvar","unknown variable! - there is no setVariable with this name ("+this._varnamePort.get()+")");this._op.setUiAttrib({extendTitle:"#invalid"});if(this._valueOutPort)this._setValueOut(0)}}_init(){this._updateVarNamesDropdown();if(this._variable&&this._listenerId)this._variable.off(this._listenerId);this._variable=this._op.patch.getVar(this._op.varName.get());if(this._variable)this._listenerId=this._variable.on("change",this._setValueOut.bind(this));this._updateTitle();this._op.patch.emitEvent("opVariableNameChanged",this._op,this._varnamePort.get())}}})();var e=CABLES=typeof CABLES==="undefined"?{}:CABLES;for(var t in i)e[t]=i[t];if(i.__esModule)Object.defineProperty(e,"__esModule",{value:true})})();(()=>{var n={};(()=>{n.d=(e,t)=>{for(var i in t){if(n.o(t,i)&&!n.o(e,i)){Object.defineProperty(e,i,{enumerable:true,get:t[i]})}}}})();(()=>{n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{n.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();var a={};(()=>{"use strict";n.r(a);n.d(a,{Light:()=>r});function e(){return`
IN vec3 vPosition;
IN vec2 attrTexCoord;
IN vec3 attrVertNormal;
IN float attrVertIndex;
IN vec3 attrTangent;
IN vec3 attrBiTangent;

UNI mat4 projMatrix;
UNI mat4 modelMatrix;
UNI mat4 viewMatrix;


OUT vec2 texCoord;
OUT vec3 norm;

{{MODULES_HEAD}}

${this.type==="point"?"OUT vec3 modelPos;":""}
void main() {
    texCoord=attrTexCoord;
    texCoord.y = 1. - texCoord.y;
    norm=attrVertNormal;
    vec4 pos = vec4(vPosition, 1.0);
    mat4 mMatrix=modelMatrix;
    vec3 tangent = attrTangent;
    vec3 bitangent = attrBiTangent;

    {{MODULE_VERTEX_POSITION}}

    mat4 mvMatrix=viewMatrix * mMatrix;
    vec4 vPos = projMatrix * mvMatrix * pos;
    ${this.type==="point"?"modelPos = (mMatrix * pos).xyz;":""}
    gl_Position = vPos;
}
`}function t(){return`
   {{MODULES_HEAD}}
   ${this.type==="point"?"IN vec3 modelPos;":""}
   ${this.type==="point"?"UNI vec3 inLightPosition;":""}
   ${this.type==="point"?"UNI vec2 inNearFar;":""}

    IN vec2 texCoord;

    void main() {
        {{MODULE_BEGIN_FRAG}}
        vec4 col = vec4(1.);


        outColor = vec4(1.);

        {{MODULE_COLOR}}

        ${this.type==="point"?"vec3 fromLightToFrag = (modelPos - inLightPosition);":""}


        ${this.type==="point"?"float depth = (length(fromLightToFrag) - inNearFar.x) / (inNearFar.y - inNearFar.x);":"float depth = gl_FragCoord.z;"}

        float dx = dFdx(depth); // for biasing depth-per-pixel
        float dy = dFdy(depth); // for biasing depth-per-pixel

        float clampedDerivative = clamp(dot(dx, dx) + dot(dy, dy), 0., 1.);
        float moment2 = dot(depth, depth) + 0.25 * clampedDerivative;

        outColor.x = depth;
        outColor.y = moment2;
        outColor.z = depth;
    }
`}function i(){if(this.type==="point")return"";return`

IN vec3 vPosition;
IN vec2 attrTexCoord;

OUT vec2 texCoord;
OUT vec2 coord0;
OUT vec2 coord1;
OUT vec2 coord2;
OUT vec2 coord3;
OUT vec2 coord4;
OUT vec2 coord5;
OUT vec2 coord6;

UNI mat4 projMatrix;
UNI mat4 mvMatrix;
UNI mat4 modelMatrix;

UNI vec2 inXY;

void main() {
    texCoord=attrTexCoord;

    vec4 pos = vec4(vPosition,  1.0);

    {{MODULE_VERTEX_POSITION}}

    coord3 = attrTexCoord;


    coord0 = attrTexCoord + (-3.0368997744118595 * inXY);
    coord0 = clamp(coord0, 0., 1.);
    coord1 = attrTexCoord + (-2.089778445362373 * inXY);
    coord1 = clamp(coord1, 0., 1.);
    coord2 = attrTexCoord + (-1.2004366090034069 * inXY);
    coord2 = clamp(coord2, 0., 1.);
    coord4 = attrTexCoord + (1.2004366090034069 * inXY);
    coord4 = clamp(coord4, 0., 1.);
    coord5 = attrTexCoord + (2.089778445362373* inXY);
    coord5 = clamp(coord5, 0., 1.);
    coord6 = attrTexCoord + (3.0368997744118595 * inXY);
    coord6 = clamp(coord6, 0., 1.);

    gl_Position = projMatrix * mvMatrix * pos;
}
    `}function s(){if(this.type==="point")return"";return`
UNI sampler2D tex;

IN vec2 coord0;
IN vec2 coord1;
IN vec2 coord2;
IN vec2 coord3;
IN vec2 coord4;
IN vec2 coord5;
IN vec2 coord6;

void main() {

    vec4 color = vec4(0.0);


    color.xyz += texture(tex, coord0).xyz * 0.06927096443792478;  // 1/64
    color.xyz += texture(tex, coord1).xyz * 0.1383328848652136;   // 6/64
    color.xyz += texture(tex, coord2).xyz * 0.21920904690397863;  // 15/64
    color.xyz += texture(tex, coord3).xyz * 0.14637421;           // 20/64
    color.xyz += texture(tex, coord4).xyz * 0.21920904690397863;  // 15/64
    color.xyz += texture(tex, coord5).xyz * 0.1383328848652136;   // 6/64
    color.xyz += texture(tex, coord6).xyz * 0.06927096443795711;  // 1/64

    color.a = 1.;

    outColor = color;
}
    `}class r{constructor(e,t){this.type=t.type||"point";this.color=t.color||[1,1,1];this.specular=t.specular||[0,0,0];this.position=t.position||null;this.intensity=t.intensity||1;this.radius=t.radius||1;this.falloff=t.falloff||1;this.spotExponent=t.spotExponent||1;this.cosConeAngleInner=t.cosConeAngleInner||0;this.cosConeAngle=t.cosConeAngle||0;this.conePointAt=t.conePointAt||[0,0,0];this.castShadow=t.castShadow||false;this.nearFar=t.nearFar||[0,0];this.normalOffset=t.normalOffset||0;this.shadowBias=t.shadowBias||0;this.shadowStrength=t.shadowStrength||0;this.lightMatrix=null;this.shadowMap=null;this.shadowMapDepth=null;this.shadowCubeMap=null;this._cgl=e;this.state={isUpdating:false};this._framebuffer=null;this._shaderShadowMap={shader:null,uniforms:{lightPosition:null,nearFar:null},matrices:{modelMatrix:mat4.create(),viewMatrix:mat4.create(),projMatrix:mat4.create(),biasMatrix:mat4.fromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1)},vectors:{lookAt:vec3.create(),camPos:vec3.create(),up:vec3.fromValues(0,1,0)}};this._effectBlur=null;this._shaderBlur={shader:null,uniforms:{XY:null}};this._cubemap=null}getModifiableParameters(){return["color","specular","position","intensity","radius","falloff","spotExponent","cosConeAngleInner","cosConeAngle","conePointAt"]}createProjectionMatrix(e,t,i,s){this.updateProjectionMatrix(e,t,i,s)}updateProjectionMatrix(e,t,i,s){if(this.type==="spot"){mat4.perspective(this._shaderShadowMap.matrices.projMatrix,-2*CGL.DEG2RAD*s,1,t,i)}else if(this.type==="directional"){mat4.ortho(this._shaderShadowMap.matrices.projMatrix,-1*e,e,-1*e,e,t,i)}else if(this.type==="point"){mat4.perspective(this._shaderShadowMap.matrices.projMatrix,CGL.DEG2RAD*90,1,t,i);this.nearFar=[t,i]}}hasFramebuffer(){return!!this._framebuffer}hasShadowMapShader(){return!!this._shaderShadowMap.shader}hasBlurShader(){return!!this._shaderBlur.shader}hasBlurEffect(){return!!this._effectBlur}getShadowMap(){if(this.type==="point")return null;return this._framebuffer.getTextureColor()}getShadowMapDepth(){if(this.type==="point")return null;return this._framebuffer.getTextureDepth()}createFramebuffer(e,t,i){this.state.isUpdating=true;const s=e||512;const r=t||512;if(this.type==="point"){if(!this.hasCubemap()){this._cubemap=new CGL.CubemapFramebuffer(this._cgl,s,r,{name:"point light shadowmap"})}else{this._cubemap.setSize(s,r)}this._cubemap.setCamPos(this.position);this._cubemap.setMatrices(this._shaderShadowMap.matrices.modelMatrix,this._shaderShadowMap.matrices.viewMatrix,this._shaderShadowMap.matrices.projMatrix);this.state.isUpdating=false;return}if(this.hasFramebuffer())this._framebuffer.delete();if(i){if(i.filter){i.isFloatingPointTexture=i.filter!==CGL.Texture.FILTER_MIPMAP}}if(this._cgl.glVersion==1){this._framebuffer=new CGL.Framebuffer(this._cgl,s,r,{isFloatingPointTexture:true,filter:CGL.Texture.FILTER_LINEAR,wrap:CGL.Texture.WRAP_CLAMP_TO_EDGE,...i})}else{this._framebuffer=new CGL.Framebuffer2(this._cgl,s,r,{isFloatingPointTexture:true,filter:CGL.Texture.FILTER_LINEAR,wrap:CGL.Texture.WRAP_CLAMP_TO_EDGE,...i})}this.state.isUpdating=false}hasCubemap(){return!!this._cubemap}setFramebufferSize(e){if(this.hasFramebuffer())this._framebuffer.setSize(e,e)}createShadowMapShader(e,t){if(this.hasShadowMapShader())return;this.state.isUpdating=true;this._shaderShadowMap.shader=new CGL.Shader(this._cgl,"shadowPass"+this.type.charAt(0).toUpperCase()+this.type.slice(1));this._shaderShadowMap.shader.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_BEGIN_FRAG"]);const i=e||this.getShadowPassVertexShader();const s=t||this.getShadowPassFragmentShader();this._shaderShadowMap.shader.setSource(i,s);this._shaderShadowMap.shader.offScreenPass=true;if(this.type==="point"){this._shaderShadowMap.uniforms.lightPosition=new CGL.Uniform(this._shaderShadowMap.shader,"3f","inLightPosition",vec3.create());this._shaderShadowMap.uniforms.nearFar=new CGL.Uniform(this._shaderShadowMap.shader,"2f","inNearFar",vec2.create())}if(this._cgl.glVersion==1){this._cgl.enableExtension("OES_texture_float");this._cgl.enableExtension("OES_texture_float_linear");this._cgl.enableExtension("OES_texture_half_float");this._cgl.enableExtension("OES_texture_half_float_linear");this._shaderShadowMap.shader.enableExtension("GL_OES_standard_derivatives");this._shaderShadowMap.shader.enableExtension("GL_OES_texture_float");this._shaderShadowMap.shader.enableExtension("GL_OES_texture_float_linear");this._shaderShadowMap.shader.enableExtension("GL_OES_texture_half_float");this._shaderShadowMap.shader.enableExtension("GL_OES_texture_half_float_linear")}this.state.isUpdating=false}createBlurEffect(e){if(this.type==="point")return;this.state.isUpdating=true;if(this.hasBlurEffect())this._effectBlur.delete();this._effectBlur=new CGL.TextureEffect(this._cgl,{isFloatingPointTexture:true,filter:CGL.Texture.FILTER_LINEAR,wrap:CGL.Texture.WRAP_CLAMP_TO_EDGE,...e});this.state.isUpdating=false}createBlurShader(e,t){if(this.hasBlurShader()){return}if(this.type==="point")return;this.state.isUpdating=true;const i=e||this.getBlurPassVertexShader();const s=t||this.getBlurPassFragmentShader();this._shaderBlur.shader=new CGL.Shader(this._cgl,"blurPass"+this.type.charAt(0).toUpperCase()+this.type.slice(1));this._shaderBlur.shader.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_BEGIN_FRAG"]);this._shaderBlur.shader.setSource(i,s);this._shaderBlur.uniforms.XY=new CGL.Uniform(this._shaderBlur.shader,"2f","inXY",vec2.create());this._shaderBlur.shader.offScreenPass=true;this.state.isUpdating=false}renderPasses(e,t,i){if(this.state.isUpdating)return;if(this._cgl.tempData.shadowPass)return;this._cgl.pushCullFace(true);this._cgl.pushCullFaceFacing(this._cgl.gl.FRONT);this._cgl.gl.enable(this._cgl.gl.POLYGON_OFFSET_FILL);this._cgl.gl.polygonOffset(e,e);this._cgl.tempData.renderOffscreen=true;this._cgl.tempData.shadowPass=true;this._cgl.pushBlend(false);this._cgl.gl.colorMask(true,true,this.type==="point",this.type==="point");this.renderShadowPass(i);this._cgl.gl.cullFace(this._cgl.gl.BACK);this._cgl.gl.disable(this._cgl.gl.CULL_FACE);this._cgl.gl.disable(this._cgl.gl.POLYGON_OFFSET_FILL);if(this.type!=="point")this.renderBlurPass(t);this._cgl.gl.colorMask(true,true,true,true);this._cgl.popBlend();this._cgl.popCullFaceFacing();this._cgl.popCullFace();this._cgl.tempData.shadowPass=false;this._cgl.tempData.renderOffscreen=false;if(this.type!=="point"){this.shadowMap=this._framebuffer.getTextureColor();this.shadowMapDepth=this._framebuffer.getTextureDepth()}else{this.shadowMap=null;this.shadowMapDepth=null}}renderShadowPass(t){if(this.state.isUpdating)return;if(this.type==="point"){this._shaderShadowMap.uniforms.nearFar.setValue(this.nearFar);this._shaderShadowMap.uniforms.lightPosition.setValue(this.position);this._cubemap.setCamPos(this.position);this._cubemap.setMatrices(this._shaderShadowMap.matrices.modelMatrix,this._shaderShadowMap.matrices.viewMatrix,this._shaderShadowMap.matrices.projMatrix);this._cgl.pushShader(this._shaderShadowMap.shader);this._cubemap.renderStart();for(let e=0;e<6;e+=1){this._cubemap.renderStartCubemapFace(e);if(t)t();this._cubemap.renderEndCubemapFace()}this._cubemap.renderEnd();this._cgl.popShader();this.shadowCubeMap=this._cubemap.getTextureColor();return}this._cgl.pushShader(this._shaderShadowMap.shader);this._cgl.pushModelMatrix();this._cgl.pushViewMatrix();this._cgl.pushPMatrix();this._framebuffer.renderStart(this._cgl);mat4.copy(this._cgl.mMatrix,this._shaderShadowMap.matrices.modelMatrix);vec3.set(this._shaderShadowMap.vectors.camPos,this.position[0],this.position[1],this.position[2]);if(this.type==="spot")vec3.set(this._shaderShadowMap.vectors.lookAt,this.conePointAt[0],this.conePointAt[1],this.conePointAt[2]);mat4.lookAt(this._cgl.vMatrix,this._shaderShadowMap.vectors.camPos,this._shaderShadowMap.vectors.lookAt,this._shaderShadowMap.vectors.up);mat4.copy(this._cgl.pMatrix,this._shaderShadowMap.matrices.projMatrix);if(!this.lightMatrix)this.lightMatrix=mat4.create();mat4.mul(this.lightMatrix,this._cgl.pMatrix,this._cgl.vMatrix);mat4.mul(this.lightMatrix,this._cgl.mMatrix,this.lightMatrix);mat4.mul(this.lightMatrix,this._shaderShadowMap.matrices.biasMatrix,this.lightMatrix);this._cgl.gl.clearColor(1,1,1,1);this._cgl.gl.clear(this._cgl.gl.DEPTH_BUFFER_BIT|this._cgl.gl.COLOR_BUFFER_BIT);if(t)t();this._framebuffer.renderEnd(this._cgl);this._cgl.popPMatrix();this._cgl.popModelMatrix();this._cgl.popViewMatrix();this._cgl.popShader()}renderBlurPass(e){if(this.state.isUpdating)return;this._cgl.pushShader(this._shaderBlur.shader);this._effectBlur.setSourceTexture(this._framebuffer.getTextureColor());this._effectBlur.startEffect();this._effectBlur.bind();this._cgl.setTexture(0,this._effectBlur.getCurrentSourceTexture().tex);this._shaderBlur.uniforms.XY.setValue([e,0]);this._effectBlur.finish();this._effectBlur.bind();this._cgl.setTexture(0,this._effectBlur.getCurrentSourceTexture().tex);this._shaderBlur.uniforms.XY.setValue([0,e]);this._effectBlur.finish();this._effectBlur.endEffect();this._cgl.popShader()}}r.prototype.getShadowPassVertexShader=e;r.prototype.getShadowPassFragmentShader=t;r.prototype.getBlurPassVertexShader=i;r.prototype.getBlurPassFragmentShader=s})();var e=CGL=typeof CGL==="undefined"?{}:CGL;for(var t in a)e[t]=a[t];if(a.__esModule)Object.defineProperty(e,"__esModule",{value:true})})();(()=>{var s={};(()=>{s.d=(e,t)=>{for(var i in t){if(s.o(t,i)&&!s.o(e,i)){Object.defineProperty(e,i,{enumerable:true,get:t[i]})}}}})();(()=>{s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{s.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();var t={};(()=>{"use strict";s.r(t);s.d(t,{CubemapFramebuffer:()=>e});const i=CABLES;const r=8;class n{constructor(e,t){this.id=i.utils.uuid();this.name=t.name||"unknown cubemap texture";this._cgl=e;this.textureType=CGL.Texture.TYPE_DEFAULT;this._options=t;if(!this._cgl.gl)return;this._cubemapFaces=[this._cgl.gl.TEXTURE_CUBE_MAP_POSITIVE_X,this._cgl.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,this._cgl.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,this._cgl.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,this._cgl.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,this._cgl.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z];this.cubemap=this.tex=this._cgl.gl.createTexture();this.texTarget=this._cgl.gl.TEXTURE_CUBE_MAP;this.width=r;this.height=r;this.filter=t.filter||CGL.Texture.FILTER_NEAREST;this.wrap=t.wrap||CGL.Texture.WRAP_CLAMP_TO_EDGE;this.unpackAlpha=t.unpackAlpha||true;this.flip=t.flip||true;if(!t.hasOwnProperty("pixelFormat")||!t.pixelFormat){if(t.isFloatingPointTexture)t.pixelFormat=CGL.Texture.PFORMATSTR_RGBA32F;else t.pixelFormat=CGL.Texture.PFORMATSTR_RGBA8UB}this.pixelFormat=t.pixelFormat;this._cgl.profileData.profileTextureNew++;this.setSize(t.width,t.height)}getInfo(){return{pixelFormat:this.pixelFormat}}setSize(e,t){this.delete();this.cubemap=this.tex=this._cgl.gl.createTexture();this._cgl.checkFrameStarted("cubemap corelib setsize");if(e!=e||e<=0||!e)e=r;if(t!=t||t<=0||!t)t=r;if(e>this._cgl.maxTexSize||t>this._cgl.maxTexSize)console.error("texture size too big! "+e+"x"+t+" / max: "+this._cgl.maxTexSize);e=Math.min(e,this._cgl.maxTexSize);t=Math.min(t,this._cgl.maxTexSize);e=Math.floor(e);t=Math.floor(t);this.width=e;this.height=t;this._cgl.gl.bindTexture(this.texTarget,this.tex);this._cgl.profileData.profileTextureResize++;const i=CGL.Texture.setUpGlPixelFormat(this._cgl,this._options.pixelFormat);this.pixelFormat=i.pixelFormat;if(CGL.Texture.isPixelFormatHalfFloat(i.pixelFormat)){const s=this._cgl.enableExtension("EXT_color_buffer_half_float");if(!this._cgl.enableExtension("OES_texture_float_linear")){this.filter=CGL.Texture.FILTER_NEAREST}}else if(CGL.Texture.isPixelFormatFloat(i.pixelFormat)){if(!this._cgl.enableExtension("OES_texture_float_linear")){console.log("no linear pixelformat,using nearest");this.filter=CGL.Texture.FILTER_NEAREST}}for(let e=0;e<6;e++){this._cgl.gl.texImage2D(this._cubemapFaces[e],0,i.glInternalFormat,this.width,this.height,0,i.glDataFormat,i.glDataType,null)}this._setFilter();this.updateMipMap();this._cgl.gl.bindTexture(this.texTarget,null)}_setFilter(){this._cgl.checkFrameStarted("cubemap corelib");this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.unpackAlpha);if(CGL.Texture.isPixelFormatFloat(this.pixelFormat)&&this.filter==CGL.Texture.FILTER_MIPMAP){console.log("texture: HDR and mipmap filtering at the same time is not possible");this.filter=CGL.Texture.FILTER_LINEAR}if(this._cgl.glVersion==1&&!CGL.Texture.isPowerOfTwo()){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.CLAMP_TO_EDGE);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.CLAMP_TO_EDGE);this.filter=CGL.Texture.FILTER_NEAREST;this.wrap=CGL.Texture.WRAP_CLAMP_TO_EDGE}else{if(this.wrap==CGL.Texture.WRAP_CLAMP_TO_EDGE){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.CLAMP_TO_EDGE);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.CLAMP_TO_EDGE)}else if(this.wrap==CGL.Texture.WRAP_REPEAT){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.REPEAT);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.REPEAT)}else if(this.wrap==CGL.Texture.WRAP_MIRRORED_REPEAT){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.MIRRORED_REPEAT);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.MIRRORED_REPEAT)}else{throw new Error("[CubemapTexture] unknown texture filter!"+this.filter)}if(this.filter==CGL.Texture.FILTER_NEAREST){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.NEAREST)}else if(this.filter==CGL.Texture.FILTER_LINEAR){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.LINEAR);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.LINEAR)}else if(this.filter==CGL.Texture.FILTER_MIPMAP){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.LINEAR);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.LINEAR_MIPMAP_LINEAR)}else{throw new Error("[CubemapTexture] unknown texture filter!"+this.filter)}}}updateMipMap(){if(this.filter==CGL.Texture.FILTER_MIPMAP){this._cgl.gl.bindTexture(this.texTarget,this.tex);this._cgl.gl.generateMipmap(this.texTarget);this._cgl.profileData.profileGenMipMap++}}delete(){this._cgl.gl.deleteTexture(this.tex)}}class e{constructor(e,t,i,s){this._cgl=e;this.width=t||8;this.height=i||8;this._cubemapProperties=[{face:this._cgl.gl.TEXTURE_CUBE_MAP_POSITIVE_X,lookAt:vec3.fromValues(1,0,0),up:vec3.fromValues(0,-1,0)},{face:this._cgl.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,lookAt:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,-1,0)},{face:this._cgl.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,lookAt:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,1)},{face:this._cgl.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,lookAt:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,-1)},{face:this._cgl.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,lookAt:vec3.fromValues(0,0,1),up:vec3.fromValues(0,-1,0)},{face:this._cgl.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,lookAt:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,-1,0)}];this._lookAtTemp=vec3.fromValues(0,0,0);this.camPos=vec3.fromValues(0,0,0);this._modelMatrix=mat4.create();this._viewMatrix=mat4.create();this._projectionMatrix=mat4.perspective(mat4.create(),CGL.DEG2RAD*90,1,.1,1e3);this._depthRenderbuffer=null;this._framebuffer=null;this._depthbuffer=null;this._textureDepth=null;this._options=s||{};this.name=this._options.name||"unknown cubemapframebuffer";if(!this._options.hasOwnProperty("numRenderBuffers"))this._options.numRenderBuffers=1;if(!this._options.hasOwnProperty("depth"))this._options.depth=true;if(!this._options.hasOwnProperty("clear"))this._options.clear=true;if(!this._options.hasOwnProperty("multisampling")){this._options.multisampling=false;this._options.multisamplingSamples=0}if(this._options.multisamplingSamples){if(this._cgl.glSlowRenderer)this._options.multisamplingSamples=0;if(!this._cgl.gl.MAX_SAMPLES)this._options.multisamplingSamples=0;else this._options.multisamplingSamples=Math.min(this._cgl.gl.getParameter(this._cgl.gl.MAX_SAMPLES),this._options.multisamplingSamples)}if(!this._options.hasOwnProperty("filter"))this._options.filter=CGL.Texture.FILTER_LINEAR;if(!this._options.hasOwnProperty("wrap"))this._options.wrap=CGL.Texture.WRAP_CLAMP_TO_EDGE;this._cgl.checkFrameStarted("cubemap framebuffer");let r=s.pixeFormat;if(!r&&s.isFloatingPointTexture)r=CGL.Texture.PFORMATSTR_RGBA32F;this.texture=new n(this._cgl,{width:this.width,height:this.height,pixelFormat:s.pixelFormat,filter:this._options.filter,wrap:this._options.wrap,name:this.name+" cubemaptexture"});this.initializeRenderbuffers();this.setSize(this.width,this.height)}initializeRenderbuffers(){this._framebuffer=this._cgl.gl.createFramebuffer();this._depthbuffer=this._cgl.gl.createRenderbuffer();this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._framebuffer);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._depthbuffer);this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,this._cgl.gl.DEPTH_COMPONENT16,this.width,this.height);this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._depthbuffer);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null)}getWidth(){return this.width}getHeight(){return this.height}getGlFrameBuffer(){return this._framebuffer}getDepthRenderBuffer(){return this._depthRenderbuffer}getTextureColor(){return this.texture}getTextureDepth(){return this._textureDepth}dispose(){if(this.texture)this.texture=this.texture.delete();if(this._framebuffer)this._cgl.gl.deleteFramebuffer(this._framebuffer);if(this._depthRenderbuffer)this._cgl.gl.deleteRenderbuffer(this._depthbuffer)}delete(){this.dispose()}setSize(e,t){this._cgl.printError("before cubemap setsize");this.width=Math.floor(e);this.height=Math.floor(t);this.width=Math.min(this.width,this._cgl.maxTexSize);this.height=Math.min(this.height,this._cgl.maxTexSize);this._cgl.profileData.profileFrameBuffercreate++;this._framebuffer=this._cgl.gl.createFramebuffer();this._depthbuffer=this._cgl.gl.createRenderbuffer();this.texture.setSize(this.width,this.height);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._framebuffer);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._depthbuffer);this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,this._cgl.gl.DEPTH_COMPONENT16,this.width,this.height);this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._depthbuffer);if(!this._cgl.gl.isFramebuffer(this._framebuffer)){console.error("invalid framebuffer...")}const i=this._cgl.gl.checkFramebufferStatus(this._cgl.gl.FRAMEBUFFER);this.checkErrorsByStatus(i);this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_CUBE_MAP,null);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null);this._cgl.printError("cubemap setsize")}checkErrorsByStatus(e){switch(e){case this._cgl.gl.FRAMEBUFFER_COMPLETE:break;case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("FRAMEBUFFER_INCOMPLETE_ATTACHMENT...",this.width,this.height,this.texture.tex,this._depthBuffer);throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("FRAMEBUFFER_INCOMPLETE_DIMENSIONS");throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case this._cgl.gl.FRAMEBUFFER_UNSUPPORTED:console.error("FRAMEBUFFER_UNSUPPORTED");throw new Error("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");case 36059:console.error("Incomplete: FRAMEBUFFER_INCOMPLETE_DRAW_BUFFER from ext. Or Safari/iOS undefined behaviour.");break;default:console.error("incomplete framebuffer",e);console.log(this);throw new Error("Incomplete framebuffer: "+e)}}setFilter(e){this.texture.filter=e;this.texture.setSize(this.width,this.height)}setCamPos(e){this.camPos=e||this.camPos}setMatrices(e,t,i){this._modelMatrix=e||this._modelMatrix;this._viewMatrix=t||this._viewMatrix;this._projectionMatrix=i||this._projectionMatrix}renderStart(){this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_CUBE_MAP,this.texture.tex);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._framebuffer);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._depthbuffer);this._cgl.gl.viewport(0,0,this.width,this.height);this._cgl.pushGlFrameBuffer(this._framebuffer);this._cgl.pushFrameBuffer(this)}renderStartCubemapFace(e){this._cgl.pushModelMatrix();this._cgl.pushViewMatrix();this._cgl.pushPMatrix();this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cubemapProperties[e].face,this.texture.tex,0);this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._depthbuffer);if(this._options.clear){this._cgl.gl.clearColor(0,0,0,1);this._cgl.gl.clear(this._cgl.gl.COLOR_BUFFER_BIT|this._cgl.gl.DEPTH_BUFFER_BIT)}this.setMatricesCubemapFace(e)}setMatricesCubemapFace(e){mat4.copy(this._cgl.mMatrix,this._modelMatrix);vec3.add(this._lookAtTemp,this.camPos,this._cubemapProperties[e].lookAt);mat4.lookAt(this._cgl.vMatrix,this.camPos,this._lookAtTemp,this._cubemapProperties[e].up);mat4.copy(this._cgl.pMatrix,this._projectionMatrix)}renderEndCubemapFace(){this._cgl.popPMatrix();this._cgl.popModelMatrix();this._cgl.popViewMatrix()}renderEnd(){this._cgl.profileData.profileFramebuffer++;if(this._cgl.glVersion!==1){this._cgl.gl.bindFramebuffer(this._cgl.gl.READ_FRAMEBUFFER,this._framebuffer)}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.popGlFrameBuffer());this._cgl.popFrameBuffer();this._cgl.resetViewPort();this.updateMipMap()}updateMipMap(){if(!this.texture)return;this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_CUBE_MAP,this.texture.tex);this.texture.updateMipMap();this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_CUBE_MAP,null)}}})();var e=CGL=typeof CGL==="undefined"?{}:CGL;for(var i in t)e[i]=t[i];if(t.__esModule)Object.defineProperty(e,"__esModule",{value:true})})();